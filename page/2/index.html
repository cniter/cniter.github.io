<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="Shaun之所见所学所想所得"><meta name="keywords" content="algorithm,android,bigdata,c/cpp,clustering,container,css,cv,devtool,ffmpeg,geomesa,geometry,gfw,github,gl,golang,hexo,http,integration,java,k8s,language,latex,mapbox,markdown,matlab,network,note,numerical,opencv,opendrive,opengl,python,qt,record,search,segmentation,tensorflow,thought,unix-like,vscode"><meta property="og:type" content="article"><meta property="og:site_name" content="Shaun&#39;s Space"><title>Shaun&#39;s Space</title><link rel="icon" href="/img/favicon.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha256-eSi1q2PG6J7g7ib17yAaWMcrr5GrtohYChqibrV7PBE=" crossorigin="anonymous"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fork-awesome/1.1.5/css/fork-awesome.min.css" integrity="sha256-P64qV9gULPHiZTdrS1nM59toStkgjM0dsf5mK/UwBV4=" crossorigin="anonymous"><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><script src="//cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha256-ZvOgfh+ptkpoa2Y4HkRY28ir89u/+VRyDE7sB7hEEcI=" crossorigin="anonymous"></script><script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha256-VsEqElsCHSGmnmHXGQzvoWjWwoznFSZc6hs7ARLRacQ=" crossorigin="anonymous"></script><script src="//cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js" integrity="sha256-EPrkNjGEmCWyazb3A/Epj+W7Qm2pB9vnfXw+X6LImPM=" crossorigin="anonymous"></script><script src="//cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><link rel="stylesheet" href="/css/style.css"><style>body{cursor:url(/img/cursor/normal.cur),auto}#navbar-toggler--btn,.code-copy,.copy-path,a,button{cursor:url(/img/cursor/link.cur),auto}#site-bg{position:fixed;left:0;top:0;width:100%;height:100%;z-index:-1;background-image:url(/img/site-bg/bg-7.jpg);background-repeat:no-repeat;background-size:100% 100%;opacity:.2;transition:background-image 3s}</style><script>const bdshareURL="/plugins/baidushare/"</script><script async type="text/javascript" src="/js/live2d/autoload.js"></script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Shaun's Space" type="application/atom+xml">
</head><body><!--[if lt IE 9]>
        <link rel="stylesheet" href="/css/ie9.css">
        <div class="alert alert-danger topframe" role="alert">
            嘿，朋友！您的浏览器已<strong>过期</strong>，不建议继续食用。
            <a target="_blank" class="alert-link" href="http://browsehappy.com">这里</a> 有些新玩意儿，何不试试？
        </div>
    <![endif]--><header id="header"><nav id="navbar" class="navbar navbar-expand-md"><div class="container"><h1 id="site-title"><a href="/" class="navbar-brand"><img src="/img/favicon.png"> <span>Shaun&#39;s Space</span></a></h1><button id="navbar-toggler--btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsibleNavbar"><span><i class="fa fa-list-ul" aria-hidden="true"></i></span></button><div class="collapse navbar-collapse" id="collapsibleNavbar"><ul class="navbar-nav"><li class="nav-item"><a class="nav-link" href="/" title="首页" data-toggle="tooltip" data-placement="bottom"><i class="nav-icon fa fa-home"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives" title="所有文章" data-toggle="tooltip" data-placement="bottom"><i class="nav-icon fa fa-archive"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories" title="全部分类" data-toggle="tooltip" data-placement="bottom"><i class="nav-icon fa fa-folder"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags" title="全部标签" data-toggle="tooltip" data-placement="bottom"><i class="nav-icon fa fa-tags"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/about" title="关于本站" data-toggle="tooltip" data-placement="bottom"><i class="nav-icon fa fa-user"></i> 关于</a></li><li class="nav-item"><a class="nav-link" href="/guide" title="Treasure Guide" data-toggle="tooltip" data-placement="bottom"><i class="nav-icon fa fa-university"></i> 导航</a></li></ul></div></div></nav></header><div class="container"><div class="row"><aside id="left-col" class="col-md-1"></aside><main class="col-lg-8 col-sm-12"><div id="site-bg"></div><article id="post-OpenGL坐标系统与渲染管线" class="article div-border"><header class="article-header"><span class="article-date article-title--index"><i class="fa fa-calendar" aria-hidden="true"></i> <a href="/posts/81321445.html"><time datetime="2021-05-28T10:22:41.000Z">2021-05-28</time></a></span><section class="article-title article-title--index"><a href="/posts/81321445.html">OpenGL坐标系统与渲染管线</a></section><div class="article-label"><div class="article-category label"><i class="fa fa-book" aria-hidden="true"></i> <a class="color5 article-category-link" href="/categories/Image-Graphic/">Image&Graphic</a></div><div class="article-tag label"><i class="fa fa-bookmark" aria-hidden="true"></i> <a class="color3 article-tag-none-link" href="/tags/algorithm/" rel="tag">algorithm</a></div></div></header><section class="article-content"><div class="article-content--excerpt"><h2 id="前言">前言</h2><p>　　图形学中最基础的东西就是坐标系统，三维的东西如何在二维中显示，这中间经历了数次坐标变换，同时坐标变换也贯穿了整个计算机图形渲染管线。</p></div><div class="article-content--all"><h2 id="前言">前言</h2><p>　　图形学中最基础的东西就是坐标系统，三维的东西如何在二维中显示，这中间经历了数次坐标变换，同时坐标变换也贯穿了整个计算机图形渲染管线。</p><span id="more"></span><h2 id="坐标篇">坐标篇</h2><figure><img src="https://learnopengl-cn.github.io/img/01/08/coordinate_systems.png" alt="coordinate_systems"><figcaption aria-hidden="true">coordinate_systems</figcaption></figure><p>　　在计算机图形世界中，为更灵活的控制三维物体显示在二维中，将变换的过程大致分为 5 个空间：1、局部空间（Local Space，或者称为物体空间（Object Space））；2、世界空间（World Space）；3、观察空间（View Space，或者称为视觉空间（Eye Space））；4、裁剪空间（Clip Space）；5、屏幕空间（Screen Space）。局部空间中是物体相对于坐标原点的坐标，也是物体的固有坐标，在依次经历过缩放旋转平移，也即模型矩阵（Model Matrix）变换后，物体局部坐标变换为世界坐标，世界坐标中即定义了物体所在的位置，以及产生的旋转和缩放。在世界空间中加入相机，以相机的视角看世界中的物体，即通过观察矩阵（View Matrix，也称视图矩阵）变换后，将世界坐标转换为观察坐标，由于一张屏幕能显示的东西是有限的，而三维世界中的物体是无限，所以需要通过投影矩阵（Projection Matrix）对三维空间进行裁剪，以决定哪些物体能显示在屏幕上，为方便的计算机判断，处于裁剪空间内的坐标会被转换为 [-1, 1]，为顺利在屏幕上显示，又需要通过视窗变换（Viewport Transform）将 [-1, 1] 映射为 viewport 中的图元坐标，再通过渲染管线的其他流程输出为屏幕上的像素点。</p><h2 id="变换篇">变换篇</h2><p>　　矩阵相乘一般有左乘和右乘之分，左乘和右乘的区别在于坐标是按列还是按行排列（OpenGL 中是按列，所以是左乘，DX 中按行，所以是右乘，同一种变换，传入 DX 中的矩阵与传入 OpenGL 中的矩阵互为转置），坐标与矩阵相乘越靠近坐标的矩阵表示该坐标越先做相应矩阵变换。</p><p>　　模型矩阵，视图矩阵，投影矩阵，在简单的顶点着色器编程中，这三个矩阵一般会合并成一个 MVP 矩阵传入 GPU 中。</p><h3 id="模型矩阵">模型矩阵</h3><p>　　模型矩阵一般定义了物体的缩放旋转平移状态，缩放矩阵的构造很简单，若物体在 <span class="math inline">\((x,y,z)\)</span> 方向上缩放尺度分别为 <span class="math inline">\((S_x, S_y, S_z)\)</span>，则缩放矩阵为： <span class="math display">\[ M_{scaling} = \begin{bmatrix} S_x &amp; 0 &amp; 0 &amp; 0 \\ 0 &amp; S_y &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; S_z &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; 1 \end{bmatrix} \]</span> 　　旋转矩阵就非常麻烦了，这里暂且不讨论其如何计算，只给出矩阵，物体绕任意轴 <span class="math inline">\((R_X, R_y, R_z)\)</span> 旋转 θ 角的矩阵为： <span class="math display">\[ M_{rotation} = \begin{bmatrix} cos\theta+R_x^2(1-cos\theta) &amp; R_xR_y(1-cos\theta)-R_zsin\theta &amp; R_xR_z(1-cos\theta)+R_ysin\theta &amp; 0 \\ R_yR_x(1-cos\theta)+R_zsin\theta &amp; cos\theta+R_y^2(1-cos\theta) &amp; R_yR_z(1-cos\theta)-R_xsin\theta &amp; 0 \\ R_zR_x(1-cos\theta)-R_ysin\theta &amp; R_zR_y(1-cos\theta)+R_xsin\theta &amp; cos\theta+R_z^2(1-cos\theta) &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; 1 \end{bmatrix} \]</span> 　　当然，由于万向节锁的存在，一般不会直接使用欧拉角和旋转轴计算旋转矩阵，而是会通过四元数得到旋转矩阵，这样既高效又能避免万向节锁，详情可看「LearnOpenGL」译者的<a target="_blank" rel="noopener" href="https://krasjet.github.io/quaternion/">教程</a>。</p><p>　　至于平移矩阵也非常简单，若物体在 <span class="math inline">\((x,y,z)\)</span> 方向上平移量分别为 <span class="math inline">\((T_x, T_y, T_z)\)</span>，则平移矩阵为： <span class="math display">\[ M_{translation} = \begin{bmatrix} 1 &amp; 0 &amp; 0 &amp; T_x \\ 0 &amp; 1 &amp; 0 &amp; T_y \\ 0 &amp; 0 &amp; 1 &amp; T_z \\ 0 &amp; 0 &amp; 0 &amp; 1 \end{bmatrix} \]</span> 　　前面的缩放和旋转矩阵其实只需要用到 3×3 的矩阵，而之所以用 4×4 的表示也是因为平移矩阵，普通的 3 维坐标必须增加一维 <span class="math inline">\(w\)</span> 构成齐次坐标才能进行平移操作，<span class="math inline">\(w\)</span> 一般都是 1.0，而从齐次坐标<span class="math inline">\((x,y,z,w)\)</span> 变为普通的 3 维坐标需要每个分量除以 <span class="math inline">\(w\)</span>，即 <span class="math inline">\((x/w, y/w, z/w)\)</span> 。</p><p>则模型矩阵 <span class="math inline">\(M_{model} = M_{translation} \cdot M_{rotation} \cdot M_{scaling}\)</span>。</p><h3 id="视图矩阵">视图矩阵</h3><p>　　视图矩阵描述的是三维场景中模拟相机的状态，根据模拟相机的状态确定一套以相机为原点的相机坐标系，从而使用视图矩阵进行坐标变换，至于为啥是模拟相机，是因为 OpenGL 本身并没有相机的概念，通过模拟相机来实现在三维场景中的漫游。</p><figure><img src="https://learnopengl-cn.github.io/img/01/09/camera_axes.png" alt="camera_axes"><figcaption aria-hidden="true">camera_axes</figcaption></figure><p>　　模拟相机有三个关键点，分别为相机位置（cameraPos），相机朝向点（cameraTarget），相机上向量（top），根据相机位置和相机朝向点可确定相机坐标系的 z 轴正向向量 <span class="math inline">\(cameraDirection = (cameraPos - cameraTarget).normalize\)</span>，叉乘相机上向量和相机 z 轴正向向量可得到相机坐标系 x 轴正向向量 <span class="math inline">\(cameraRight = top.cross(cameraDirection).normalize\)</span>，最后将相机 z 轴正向向量与 x 轴正向向量叉乘得到 y 轴正向向量 <span class="math inline">\(cameraUp = cameraDirection.cross(cameraRight)\)</span>，如此即可建立完整的相机坐标系，从而得到变换矩阵，即视图矩阵： <span class="math display">\[ M_{view} = \begin{bmatrix} R_x &amp; R_y &amp; R_z &amp; 0 \\ U_x &amp; U_y &amp; U_z &amp; 0 \\ D_x &amp; D_y &amp; D_z &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; 1 \end{bmatrix} \begin{bmatrix} 1 &amp; 0 &amp; 0 &amp; -P_x \\ 0 &amp; 1 &amp; 0 &amp; -P_y \\ 0 &amp; 0 &amp; 1 &amp; -P_z \\ 0 &amp; 0 &amp; 0 &amp; 1 \end{bmatrix} \]</span> 其中 <span class="math inline">\(R\)</span> 是相机 x 轴正向向量，<span class="math inline">\(U\)</span> 是相机 y 轴正向向量，<span class="math inline">\(D\)</span> 是相机 z 轴正向向量， <span class="math inline">\(P\)</span> 是相机位置向量。</p><h3 id="投影矩阵">投影矩阵</h3><p>　　投影矩阵描述的是摄像机前的可视区域（Frustum），根据可视区域的形状可分为正射投影（Orthographic Projection）和透视投影（Perspective Projection）。</p><p><img src="https://learnopengl-cn.github.io/img/01/08/orthographic_frustum.png" alt="orthographic projection frustum"> <img src="https://learnopengl-cn.github.io/img/01/08/perspective_frustum.png" alt="perspective_frustum"></p><p>　　对于这两种投影，都有远（far）近（near）参数，不同的是，正射投影是个立方体，所以有左（left）右（right）上（top）下（bottom）四个参数，而透视投影是个类梯形台，所以还有垂直方向视野（Field of View，fov），以及一个宽高比（aspect）两个参数。远近两个参数决定摄像机能看到多近和多远的物体，太近和太远都会看不见，一般可设 near = 0.1，far = 1000；若渲染视窗（viewport）宽为 W，高为 H，则一般 <span class="math inline">\(left=-W/2, right=W/2, top=H/2, bottom=-H/2\)</span> ；透视投影的 fov 是角度，一般设为 45.0，而 <span class="math inline">\(aspect = W/H\)</span> 。这两种投影的矩阵分别为： <span class="math display">\[ M_{orth} = \begin{bmatrix} \frac{2}{right-left} &amp; 0 &amp; 0 &amp; -\frac{right+left}{right-left} \\ 0 &amp; \frac{2}{top-bottom} &amp; 0 &amp; -\frac{top+bottom}{top-bottom} \\ 0 &amp; 0 &amp; \frac{-2}{far-near} &amp; -\frac{far+near}{far-near} \\ 0 &amp; 0 &amp; 0 &amp; 1 \end{bmatrix} \\ M_{pers} = \begin{bmatrix} \frac{2near}{right-left} &amp; 0 &amp; \frac{right+left}{right-left} &amp; 0 \\ 0 &amp; \frac{2near}{top-bottom} &amp; \frac{top+bottom}{top-bottom} &amp; 0 \\ 0 &amp; 0 &amp; \frac{-(far+near)}{far-near} &amp; \frac{-2far*near}{far-near} \\ 0 &amp; 0 &amp; -1 &amp; 0 \end{bmatrix} \]</span></p><p>　　在 three.js 中，对于透视投影矩阵中 left, right, top, bottom 计算方式为：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="JAVASCRIPT"><div class="code-copy"></div><figure class="highlight hljs javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> top = near * <span class="built_in">Math</span>.tan( _Math.DEG2RAD * <span class="number">0.5</span> * <span class="built_in">this</span>.fov ) / <span class="built_in">this</span>.zoom;</span><br><span class="line"><span class="keyword">let</span> height = <span class="number">2</span> * top;</span><br><span class="line"><span class="keyword">let</span> width = <span class="built_in">this</span>.aspect * height;</span><br><span class="line"><span class="keyword">let</span> left = - <span class="number">0.5</span> * width;</span><br><span class="line"><span class="keyword">let</span> right = left + width;</span><br><span class="line"><span class="keyword">let</span> bottom = top - height;</span><br></pre></td></tr></table></figure></div><p>　　对于透视投影，由于计算出的齐次坐标 w 分量显然不为 1.0，所以必须进行透视除法（x,y,z 各分量分别除以 w），得到真正的 3 维坐标。</p><p>　　正射投影一般用来模拟 2D 空间，透视投影用来模拟 3D 空间，当透视投影 near 和 far 设置的相差太大时，很容易引发 z-fighting 现象，原因是离近平面越远时，计算出的深度精度越低，three.js 中为解决这一问题，引入了一个 logarithmicDepthBuffer 参数来决定是否开启使用对数函数优化深度计算，具体可看源码中的 logdepthbuf_vertex.glsl.js 和 logdepthbuf_fragment.glsl.js 文件，开启该参数会造成渲染性能下降。</p><h3 id="小结">小结</h3><p>　　<span class="math inline">\(M_{mvp} = M_{projection}M_{view}M_{model}\)</span>，一个局部坐标 <span class="math inline">\(V_{local}\)</span> 在经过 MVP 矩阵变换之后可得到裁剪坐标 <span class="math inline">\(V_{clip} = M_{mvp}V_{local}\)</span> ，在 OpenGL 中，<span class="math inline">\(V_{clip}\)</span> 会被赋值到顶点着色器中的 <code>gl_Position</code>，并且 OpenGL 会自动进行透视除法和裁剪。</p><p>　　3 维中的相机一般可分为两种，第一人称相机（常规 FPS 游戏）和第三人称相机（常规 ARPG 游戏），第一人称相机的特点是灵活，相机往往可以任意改变位置和朝向，所以会对某些人造成一种 “晕 3D” 的现象，而第三人称相机虽然可以改变相机朝向点和位置，但当朝向点和到朝向点的距离一旦固定，则相机只能沿着以朝向点为球心，以到朝向点的距离为半径的球面上运动，这两种相机一般看具体业务需求进行选择。</p><p>　　缩放操作是很常规的一种操作，镜头拉近代表放大，拉远代表缩小。在使用透视投影的 3 维场景中，只需要改变相机到朝向点的距离即可简单实现缩放操作，而在使用正射投影的场景中，改变距离并不能实现缩放，而是需要改变 左右上下 四个参数，所以在相机中往往会在引入一个 zoom 的参数，用 左右上下 四个参数分别除以 zoom 得到真正的 左右上下，从而改变 zoom，就可以改变相机参数，进而实现正射投影的缩放。</p><h2 id="管线篇">管线篇</h2><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="processonSvg1000" viewBox="-14.0 -19.5 759.0 557.625" width="600" height="500"><defs id="ProcessOnDefs1001"><marker id="ProcessOnMarker1009" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1010" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1017" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1018" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1025" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1026" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1038" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1039" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1047" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1048" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1055" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1056" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1063" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1064" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1071" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1072" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1083" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1084" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1089" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1090" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1105" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1106" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1116" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1117" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1122" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1123" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1138" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1139" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker></defs><g id="ProcessOnG1002"><path id="ProcessOnPath1003" d="M-14.0 -19.5H745.0V538.125H-14.0V-19.5Z" fill="none"></path><g id="ProcessOnG1004"><g id="ProcessOnG1005" transform="matrix(1.0,0.0,0.0,1.0,6.0,122.0)" opacity="1.0"><path id="ProcessOnPath1006" d="M0.0 39.5C0.0 -13.166666666666666 84.0 -13.166666666666666 84.0 39.5C84.0 92.16666666666667 0.0 92.16666666666667 0.0 39.5Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path></g><g id="ProcessOnG1007"><path id="ProcessOnPath1008" d="M90.0 161.5L137.3829796415478 161.5" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1009)"></path></g><g id="ProcessOnG1011" transform="matrix(1.0,0.0,0.0,1.0,152.6190476190476,126.5)" opacity="1.0"><path id="ProcessOnPath1012" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1013" transform="matrix(1.0,0.0,0.0,1.0,10.0,25.0)"><text id="ProcessOnText1014" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="16" x="39.0" y="16.4">顶点着色器</text></g></g><g id="ProcessOnG1015"><path id="ProcessOnPath1016" d="M252.6190476190476 161.5L263.7639320225002 161.5" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1017)"></path></g><g id="ProcessOnG1019" transform="matrix(1.0,0.0,0.0,1.0,279.0,126.5)" opacity="1.0"><path id="ProcessOnPath1020" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1021" transform="matrix(1.0,0.0,0.0,1.0,10.0,25.0)"><text id="ProcessOnText1022" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="16" x="39.0" y="16.4">图元装配</text></g></g><g id="ProcessOnG1023"><path id="ProcessOnPath1024" d="M379.0 161.5L413.7639320225002 161.5" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1025)"></path></g><g id="ProcessOnG1027" transform="matrix(1.0,0.0,0.0,1.0,429.0,126.5)" opacity="1.0"><path id="ProcessOnPath1028" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1029" transform="matrix(1.0,0.0,0.0,1.0,10.0,25.0)"><text id="ProcessOnText1030" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="16" x="39.0" y="16.4">光栅器</text></g></g><g id="ProcessOnG1031" transform="matrix(1.0,0.0,0.0,1.0,24.5,150.0)" opacity="1.0"><path id="ProcessOnPath1032" d="M0.0 0.0L47.0 0.0L47.0 23.0L0.0 23.0Z" stroke="#999" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1033" transform="matrix(1.0,0.0,0.0,1.0,0.0,-7.25)"><text id="ProcessOnText1034" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="22.5" y="15.375">顶点</text><text id="ProcessOnText1035" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="22.5" y="34.125">缓冲区</text></g></g><g id="ProcessOnG1036"><path id="ProcessOnPath1037" d="M529.0 161.5L548.5 161.5L548.5 161.5L552.7639320225002 161.5" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1038)"></path></g><g id="ProcessOnG1040" transform="matrix(1.0,0.0,0.0,1.0,568.0,126.5)" opacity="1.0"><path id="ProcessOnPath1041" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1042" transform="matrix(1.0,0.0,0.0,1.0,10.0,15.0)"><text id="ProcessOnText1043" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="微软雅黑" text-anchor="middle" font-size="16" x="39.0" y="16.4">片元着色</text><text id="ProcessOnText1044" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="微软雅黑" text-anchor="middle" font-size="16" x="39.0" y="36.4">器</text></g></g><g id="ProcessOnG1045"><path id="ProcessOnPath1046" d="M668.0 161.5L725.0 161.5L725.0 271.8354430379747L710.2360679774998 271.8354430379747" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1047)"></path></g><g id="ProcessOnG1049" transform="matrix(1.0,0.0,0.0,1.0,595.0,236.8354430379747)" opacity="1.0"><path id="ProcessOnPath1050" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1051" transform="matrix(1.0,0.0,0.0,1.0,10.0,25.0)"><text id="ProcessOnText1052" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="微软雅黑" text-anchor="middle" font-size="16" x="39.0" y="16.4">归属测试</text></g></g><g id="ProcessOnG1053"><path id="ProcessOnPath1054" d="M595.0 271.8354430379747L556.0 271.8354430379747L556.0 271.8354430379747L532.2360679774998 271.8354430379747" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1055)"></path></g><g id="ProcessOnG1057" transform="matrix(1.0,0.0,0.0,1.0,417.0,236.8354430379747)" opacity="1.0"><path id="ProcessOnPath1058" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1059" transform="matrix(1.0,0.0,0.0,1.0,10.0,25.0)"><text id="ProcessOnText1060" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="微软雅黑" text-anchor="middle" font-size="16" x="39.0" y="16.4">模板测试</text></g></g><g id="ProcessOnG1061"><path id="ProcessOnPath1062" d="M417.0 271.8354430379747L378.5 271.8354430379747L378.5 271.8354430379747L355.2360679774998 271.8354430379747" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1063)"></path></g><g id="ProcessOnG1065" transform="matrix(1.0,0.0,0.0,1.0,240.0,236.8354430379747)" opacity="1.0"><path id="ProcessOnPath1066" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1067" transform="matrix(1.0,0.0,0.0,1.0,10.0,25.0)"><text id="ProcessOnText1068" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="微软雅黑" text-anchor="middle" font-size="16" x="39.0" y="16.4">深度测试</text></g></g><g id="ProcessOnG1069"><path id="ProcessOnPath1070" d="M240.0 271.8354430379747L207.0 271.8354430379747L207.0 271.8354430379747L189.2360679774998 271.8354430379747" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1071)"></path></g><g id="ProcessOnG1073" transform="matrix(1.0,0.0,0.0,1.0,74.0,236.8354430379747)" opacity="1.0"><path id="ProcessOnPath1074" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1075" transform="matrix(1.0,0.0,0.0,1.0,10.0,25.0)"><text id="ProcessOnText1076" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="微软雅黑" text-anchor="middle" font-size="16" x="39.0" y="16.4">融合</text></g></g><g id="ProcessOnG1077" transform="matrix(1.0,0.0,0.0,1.0,74.0,444.25)" opacity="1.0"><path id="ProcessOnPath1078" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1079" transform="matrix(1.0,0.0,0.0,1.0,10.0,25.0)"><text id="ProcessOnText1080" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="微软雅黑" text-anchor="middle" font-size="16" x="39.0" y="16.4">抖动</text></g></g><g id="ProcessOnG1081"><path id="ProcessOnPath1082" d="M74.0 271.8354430379747L20.0 271.8354430379747L20.0 479.25L58.763932022500214 479.25" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1083)"></path></g><g id="ProcessOnG1085" transform="matrix(1.0,0.0,0.0,1.0,250.05952380952385,440.375)" opacity="1.0"><path id="ProcessOnPath1086" d="M0.0 38.875C0.0 -12.958333333333334 79.88095238095235 -12.958333333333334 79.88095238095235 38.875C79.88095238095235 90.70833333333333 0.0 90.70833333333333 0.0 38.875Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path></g><g id="ProcessOnG1087"><path id="ProcessOnPath1088" d="M174.0 479.25L212.02976190476193 479.25L212.02976190476193 479.25L234.82345583202405 479.25" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1089)"></path></g><g id="ProcessOnG1091" transform="matrix(1.0,0.0,0.0,1.0,268.73809523809524,467.75)" opacity="1.0"><path id="ProcessOnPath1092" d="M0.0 0.0L47.0 0.0L47.0 23.0L0.0 23.0Z" stroke="#999" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1093" transform="matrix(1.0,0.0,0.0,1.0,0.0,-7.25)"><text id="ProcessOnText1094" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="22.5" y="15.375">颜色</text><text id="ProcessOnText1095" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="22.5" y="34.125">缓冲区</text></g></g><g id="ProcessOnG1096" transform="matrix(1.0,0.0,0.0,1.0,624.0,3.500000000000014)" opacity="1.0"><path id="ProcessOnPath1097" d="M0.0 38.49999999999999C0.0 -12.83333333333333 82.0 -12.83333333333333 82.0 38.49999999999999C82.0 89.83333333333331 0.0 89.83333333333331 0.0 38.49999999999999Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path></g><g id="ProcessOnG1098" transform="matrix(1.0,0.0,0.0,1.0,639.2619047619048,30.16455696202533)" opacity="1.0"><path id="ProcessOnPath1099" d="M0.0 0.0L51.476190476190474 0.0L51.476190476190474 25.32911392405063L0.0 25.32911392405063Z" stroke="#999" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1100" transform="matrix(1.0,0.0,0.0,1.0,0.0,-6.085443037974684)"><text id="ProcessOnText1101" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="24.738095238095237" y="15.375">纹理</text><text id="ProcessOnText1102" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="24.738095238095237" y="34.125">缓冲区</text></g></g><g id="ProcessOnG1103"><path id="ProcessOnPath1104" d="M665.0 80.5L665.0 103.5L618.0 103.5L618.0 111.26393202250021" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1105)"></path></g><g id="ProcessOnG1107" transform="matrix(1.0,0.0,0.0,1.0,252.6190476190476,346.0)" opacity="1.0"><path id="ProcessOnPath1108" d="M0.0 37.0C0.0 -12.333333333333334 74.76190476190476 -12.333333333333334 74.76190476190476 37.0C74.76190476190476 86.33333333333333 0.0 86.33333333333333 0.0 37.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path></g><g id="ProcessOnG1109" transform="matrix(1.0,0.0,0.0,1.0,264.26190476190476,370.33544303797464)" opacity="1.0"><path id="ProcessOnPath1110" d="M0.0 0.0L51.476190476190474 0.0L51.476190476190474 25.32911392405063L0.0 25.32911392405063Z" stroke="#999" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1111" transform="matrix(1.0,0.0,0.0,1.0,0.0,-6.085443037974684)"><text id="ProcessOnText1112" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="24.738095238095237" y="15.375">深度</text><text id="ProcessOnText1113" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="24.738095238095237" y="34.125">缓冲区</text></g></g><g id="ProcessOnG1114"><path id="ProcessOnPath1115" d="M290.0 306.8354430379747L290.0 326.4177215189874L289.99999999999994 326.4177215189874L289.99999999999994 330.7639320225002" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1116)"></path></g><g id="ProcessOnG1118" transform="matrix(1.0,0.0,0.0,1.0,78.0,25.0)" opacity="1.0"><path id="ProcessOnPath1119" d="M0.0 39.5C0.0 -13.166666666666666 84.0 -13.166666666666666 84.0 39.5C84.0 92.16666666666667 0.0 92.16666666666667 0.0 39.5Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path></g><g id="ProcessOnG1120"><path id="ProcessOnPath1121" d="M120.0 104.0L120.0 161.5L137.3829796415478 161.5" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1122)"></path></g><g id="ProcessOnG1124" transform="matrix(1.0,0.0,0.0,1.0,78.75,48.5)" opacity="1.0"><path id="ProcessOnPath1125" d="M0.0 0.0L82.5 0.0L82.5 32.0L0.0 32.0Z" stroke="#999" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1126" transform="matrix(1.0,0.0,0.0,1.0,0.0,-2.75)"><text id="ProcessOnText1127" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="40.25" y="15.375">uniform</text><text id="ProcessOnText1128" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="40.25" y="34.125">数据</text></g></g><g id="ProcessOnG1129" transform="matrix(1.0,0.0,0.0,1.0,529.0,0.5)" opacity="1.0"><path id="ProcessOnPath1130" d="M0.0 40.0C0.0 -13.333333333333334 82.0 -13.333333333333334 82.0 40.0C82.0 93.33333333333333 0.0 93.33333333333333 0.0 40.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path></g><g id="ProcessOnG1131" transform="matrix(1.0,0.0,0.0,1.0,529.75,26.829113924050645)" opacity="1.0"><path id="ProcessOnPath1132" d="M0.0 0.0L82.5 0.0L82.5 32.0L0.0 32.0Z" stroke="#999" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1133" transform="matrix(1.0,0.0,0.0,1.0,0.0,-2.75)"><text id="ProcessOnText1134" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="40.25" y="15.375">uniform</text><text id="ProcessOnText1135" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="40.25" y="34.125">数据</text></g></g><g id="ProcessOnG1136"><path id="ProcessOnPath1137" d="M570.0 80.5L570.0 103.5L618.0 103.5L618.0 111.26393202250021" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1138)"></path></g></g></g></svg><p>　　渲染管线，图形学中最重要的概念之一，既然称之为管线，自然有像流水线一样的步骤，各个步骤具体做的事情如下：</p><ol type="1"><li>顶点着色器：负责将顶点数据进行坐标变换，该着色器中一般存在 MVP 矩阵，负责将三维坐标变换为二维坐标，该阶段也可以优化每个点的深度值，以便管线后续进行深度测试，也可以利用光照简单优化每个顶点的颜色；</li><li>图元装配：将输入的顶点数据进行组装，形成图元，常见的图元包括：点(GL_POINTS)、线(GL_LINES)、线条(GL_LINE_STRIP)、三角面(GL_TRIANGLES)，在该过程中，一般 GPU 会做一些裁剪和背面剔除等操作，以减少图元的数量，同时完成透视除法以进行屏幕映射；</li><li>光栅化：负责计算每个图元到屏幕像素点的映射。光栅化会计算每个图元所覆盖的片元，同时利用顶点属性插值计算每个片元的属性，片元可认为是候选像素，经过后续管线阶段即可变为真正的像素。</li><li>片元着色器：将光栅化得到的片元进行颜色计算。图形学中几乎所有的高级特效都会在这一步完成，光照计算，阴影处理，纹理，材质，统统在这一步进行处理；</li><li>归属测试：即测试片元所在位置是否位于当前上下文视窗内，若一个显示帧缓冲区视窗被另一个视窗所遮蔽，则剔除该部分片元。</li><li>模板测试：即测试片元是否满足一定条件（可大于或小于某个值等），若测试不满足，则剔除该该片元， OpenGL 可自行选择开启或关闭模板测试。</li><li>深度测试：用来测试片元的远近，远的片元被遮挡。在深度测试，若两片元深度值接近，则可能会引起 Z-fighting 现象，即像素闪烁，这是因为此时 GPU 无法确定该剔除哪个片元，导致这一帧可能绘制这个片元，下一帧绘制另一个片元。若开启 Alpha 测试，即启用透明度，则会在下一阶段进行 Alpha 混合，从而达到透明效果。</li><li>混合：将新生成的片元颜色和帧缓冲区中对应位置的颜色进行混合，得到像素颜色。</li><li>抖动：一种以牺牲分辨率为代价来增加颜色表示范围技术，从视觉效果上来看就是颜色过度更平滑。</li></ol><p>　　以上这些阶段中，能完全被编程控制的也就顶点着色器和片元着色器两个阶段，其余阶段要么完全无法控制，要么只能通过已有的参数进行设置，当然也可以通过顶点着色器和片元着色器影响余下阶段，顶点着色器和片元着色器也统称 Shader 编程。</p><p>　　有时候为了做更好看的特效，需要进行多次渲染，将上一次渲染的结果作为下一次渲染的输入，此时可以将颜色缓冲区作为一张纹理，并构造新的帧缓冲区，将该纹理作为输入，重新放进渲染管线中，这种操作方式也叫后期处理（Post Processing），虽然好看，但对 GPU 的负载很大，需要合理使用。</p><p>　　对于渲染管线，Shaun 的理解也就到此为止了，非常粗浅，Shader 也只是刚入门的水平，Shaun 在图形学方面做的更多是降低 Draw-Call 和 CPU 层面的 Tessellation，以及 Geometry 上的事，对纹理材质颜色光照阴影等方面涉及的较少。</p><h2 id="后记">后记</h2><p>　　虽然目前 OpenGL 已停止更新，但学习图形学编程，OpenGL 总是绕不过去（至少暂时以及未来很长一段时间都会是这样），而且图形学基础知识本质都是相同的，不管是 DirectX 还是 Vulkan，变的只是写法形式而已，数学知识总是在那里，两种 shader 也同样需要，所以了解这些东西还是有必要的。</p><h2 id="附录">附录</h2><h3 id="二维图像的图像透视投影变换">二维图像的图像透视投影变换</h3><p>　　图像的透视投影变换常用于图像的矫正，OpenCV 中就有现成的 api（getPerspectiveTransform 和 warpPerspective），用于将不规整的四边形区域变换为规整的矩形区域。其基本的数学原理为，先构造一个投影变换等式： <span class="math display">\[ \begin{bmatrix} XW \\ YW \\ W \end{bmatrix} = \begin{bmatrix} a &amp; b &amp; c \\ d &amp; e &amp; f \\ g &amp; h &amp; 1 \end{bmatrix} \begin{bmatrix} x \\ y \\ 1 \end{bmatrix} \]</span> 设四边形中四个点分别为 <span class="math inline">\((X_1, Y_1),(X_2, Y_2),(X_3, Y_3),(X_4, Y_4)\)</span> ，对应矩形中四个点为 <span class="math inline">\((x_1, y_1),(x_2, y_2),(x_3, y_3),(x_4, y_4)\)</span>。则可构造齐次线性方程组： <span class="math display">\[ \begin{bmatrix} x_1 &amp; y_1 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; -X_1x_1 &amp; -X_1y_1 \\ 0 &amp; 0 &amp; 0 &amp; x_1 &amp; y_1 &amp; 1 &amp; -Y_1x_1 &amp; -Y_1y_1 \\ x_2 &amp; y_2 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; -X_2x_2 &amp; -X_2y_2 \\ 0 &amp; 0 &amp; 0 &amp; x_2 &amp; y_2 &amp; 1 &amp; -Y_2x_2 &amp; -Y_2y_2 \\ \vdots &amp; \vdots &amp; \vdots &amp; \vdots &amp; \vdots &amp; \vdots &amp; \vdots &amp; \vdots \\ x_n &amp; y_n &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; -X_nx_n &amp; -X_ny_n \\ 0 &amp; 0 &amp; 0 &amp; x_n &amp; y_n &amp; 1 &amp; -Y_nx_n &amp; -Y_ny_n \end{bmatrix} \begin{bmatrix} a \\ b \\ c \\ d \\ e \\ f \\ g \\ h \end{bmatrix} = \begin{bmatrix} X_1 \\ Y_1 \\ X_2 \\ Y_2 \\ \vdots \\ X_n \\ Y_n \end{bmatrix} \]</span> 解这个方程组得到 abcdefg ，使用上面的投影变换等式可计算 <span class="math inline">\(X = XW / W, Y = YW / W\)</span> ，从而使用插值得到规整矩形图形的各个像素值。</p><h3 id="shader-学习资料">Shader 学习资料</h3><p>shader 入门书：https://thebookofshaders.com，在线编写 shader ：https://thebookofshaders.com/edit.php</p><p>glslsandbox 网站：http://glslsandbox.com/</p><p>shadertoy 网站：https://www.shadertoy.com/</p><h2 id="参考资料">参考资料</h2><p>[1] <a target="_blank" rel="noopener" href="https://learnopengl-cn.github.io/01%20Getting%20started/08%20Coordinate%20Systems/">坐标系统</a>（https://learnopengl-cn.github.io）</p><p>[2] <a target="_blank" rel="noopener" href="http://www.yanhuangxueyuan.com/webgl_course/hardware.html">WebGL图形系统、渲染管线_郭隆邦技术博客</a></p><p>[3] <a target="_blank" rel="noopener" href="http://www.songho.ca/opengl/gl_projectionmatrix.html">OpenGL Projection Matrix</a></p><p>[4] <a target="_blank" rel="noopener" href="https://www.cnblogs.com/dojo-lzz/p/11250327.html">WebGL着色器32位浮点数精度损失问题</a></p><p>[5] <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/3190483/transform-quadrilateral-into-a-rectangle">Transform quadrilateral into a rectangle?</a></p></div><div class="article-content-more"><button type="button" class="article-more--link"><i class="fa fa-angle-double-down fa-3x" aria-hidden="true"></i></button></div></section></article><article id="post-Scala-学习小结" class="article div-border"><header class="article-header"><span class="article-date article-title--index"><i class="fa fa-calendar" aria-hidden="true"></i> <a href="/posts/8d3d87a2.html"><time datetime="2021-02-16T16:12:28.000Z">2021-02-17</time></a></span><section class="article-title article-title--index"><a href="/posts/8d3d87a2.html">Scala 学习小结</a></section><div class="article-label"><div class="article-category label"><i class="fa fa-book" aria-hidden="true"></i> <a class="color5 article-category-link" href="/categories/Study/">Study</a></div><div class="article-tag label"><i class="fa fa-bookmark" aria-hidden="true"></i> <a class="color2 article-tag-none-link" href="/tags/language/" rel="tag">language</a></div></div></header><section class="article-content"><div class="article-content--excerpt"><h2 id="前言">前言</h2><p>　　最近要改行做大数据相关的东西了，经调研大数据开发的语言还是用 Scala 好，当然 Java 也可以，毕竟都运行在 JVM 上，不过 Java 也有很长时间没用过了，所以对于 Shaun 来说用 Scala 和 Java 的代价是一样的，都需要学习一下，所以决定用对大数据更友好的 Scala。</p></div><div class="article-content--all"><h2 id="前言">前言</h2><p>　　最近要改行做大数据相关的东西了，经调研大数据开发的语言还是用 Scala 好，当然 Java 也可以，毕竟都运行在 JVM 上，不过 Java 也有很长时间没用过了，所以对于 Shaun 来说用 Scala 和 Java 的代价是一样的，都需要学习一下，所以决定用对大数据更友好的 Scala。</p><span id="more"></span><p>　　以 Martin Odersky 14 年写的「Scala By Example」为参考，虽然是 14 年的，但 Scala 的基本语法还是没变的，就学习本身而言没问题，毕竟不兼容的只是更上层的 API，Shaun 学习用的 Scala 版本为 2.12.12。Alvin Alexander 的「Scala Cookbook, 2nd Edition」预计今年 8 月会出版，到时可能这本书用来入门更好，但 Shaun 不需要系统的学，就简单的能上手写出比较理想的 Scala 代码就行了。</p><h2 id="学习篇">学习篇</h2><h3 id="第一章入门基础">第一章：入门基础</h3><h4 id="helloworld">HelloWorld</h4><p>　　由于「Scala By Example」第一章没啥内容，也为了在正式写 Scala 之前简单熟悉一下，这里先用「A Scala Tutorial for Java Programmers」简单上手一下，首先写个 HelloWorld，具体代码如下：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">HelloWorld</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">        println(<span class="string">&quot;Hello, world!&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>　　和 C 语言类似，程序唯一入口函数都是 main 函数，但 Scala 的变量在前，声明的类型在后，相比常规的语言是有点奇怪了，但这种语法规则和 Typescript 一样，所以很容易接受，但其模板的表示就有点奇怪了，Array[String] 表示一个 String 类型的数组，即表示方法为 Array[T]，常规的模板方式为 <code>Array&lt;T&gt;</code> 或 <code>T[]</code>，def 关键字用来定义一个函数，object 用来表示一个单例类，即在定义类的同时，又创建了一个类的实例。Scala 中没有 static 关键字，需要用 static 修饰的都放在 object 中即可。</p><h4 id="调用-java">调用 Java</h4><p>Scala 中默认已导入 java.lang 中的全部类，但其它类需要显式导入，以格式化输出本地日期为例：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.&#123;<span class="type">Date</span>, <span class="type">Locale</span>&#125;</span><br><span class="line"><span class="keyword">import</span> java.text.<span class="type">DateFormat</span>._</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">LocalDate</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">        <span class="keyword">val</span> now = <span class="keyword">new</span> <span class="type">Date</span></span><br><span class="line">        <span class="keyword">val</span> df = getDateInstance(<span class="type">LONG</span>, <span class="type">Locale</span>.<span class="type">CHINA</span>)</span><br><span class="line">        println(df format now) <span class="comment">// df format(now)</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>　　Scala 中的导入和 java 中 import 基本一样，但功能更强大，可以使用 <code>&#123;&#125;</code> 导入部分，也使用 <code>_</code> 导入全部（java 导入全部为 <code>*</code>，这不一样），当一个函数只有一个参数，可以通过 <em>空格+参数</em> 的形式调用，而不需要使用 <em>括号包裹</em> 的形式。这里采用 <code>val</code> 关键字声明的是常量，而要声明变量需要用 <code>var</code>。</p><h4 id="对象">对象</h4><p>Scala 中万物皆对象，一个数字也是一个对象，一个函数也是一个对象，具体如下图：</p><figure><img src="http://coredumper.cn/wordpress/wp-content/uploads/2017/06/MacHi-2017-06-03-17-18-18.png" alt="enter image description here"><figcaption aria-hidden="true">enter image description here</figcaption></figure><p>以简单计时器函数为例：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Timer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">oncePerSecond</span></span>(callback: () =&gt; <span class="type">Unit</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            callback();</span><br><span class="line">            <span class="type">Thread</span> sleep <span class="number">1000</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">timeFiles</span></span>() &#123;</span><br><span class="line">        println(<span class="string">&quot;time files like an arrow...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">        <span class="comment">// oncePerSecond(timeFiles);</span></span><br><span class="line">        oncePerSecond(() =&gt; &#123;</span><br><span class="line">            println(<span class="string">&quot;time files like an arrow...&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>　　这个和 Typescript 函数式编程的用法基本差不多，唯一不同这里声明的函数返回的是 <code>Unit</code> ，这个 Unit 可认为是无返回的函数，大部分情况等同于 void，在 Scala 中真正的没有值指的是 Nothing。</p><h4 id="类">类</h4><p>Scala 中同样有类，具体代码示例如下：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Complex</span>(<span class="params">real: <span class="type">Double</span>, imaginary: <span class="type">Double</span></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// def re() = real;</span></span><br><span class="line">    <span class="comment">// def im() = imaginary;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">re</span> </span>= real;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">im</span> </span>= imaginary;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">toString</span></span>(): <span class="type">String</span> = <span class="string">&quot;&quot;</span> + re + (<span class="keyword">if</span> (im &lt; <span class="number">0</span>) <span class="string">&quot;&quot;</span> <span class="keyword">else</span> <span class="string">&quot;+&quot;</span>) + im + <span class="string">&quot;i&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">ComplexNumbers</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">        <span class="keyword">val</span> c = <span class="keyword">new</span> <span class="type">Complex</span>(<span class="number">1.2</span>, <span class="number">-3.4</span>);</span><br><span class="line">        <span class="comment">// println(&quot;real part: &quot; + c.re() + &quot; imaginary part: &quot; + c.im());</span></span><br><span class="line">        println(c.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>　　在 Scala 中所有类都会继承某个父类，若没有显式声明父类，则默认继承 scala.AnyRef 类，如上面的 Complex 类，若需要覆盖父类的函数，则需要在函数声明前加上 override 关键字。当函数没有参数时，可以不用加括号，在调用时也不用加括号，如上面示例的注释和非注释的代码。</p><h4 id="模式匹配与条件类">模式匹配与条件类</h4><p>　　接下来用 Scala 来写一个树结构表示表达式的示例代码，树的非叶节点表示操作符，叶子节点表示数值（这里为常量或变量），具体代码如下：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Tree</span></span></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Sum</span>(<span class="params">l: <span class="type">Tree</span>, r: <span class="type">Tree</span></span>) <span class="keyword">extends</span> <span class="title">Tree</span></span></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Var</span>(<span class="params">n: <span class="type">String</span></span>) <span class="keyword">extends</span> <span class="title">Tree</span></span></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Const</span>(<span class="params">v: <span class="type">Int</span></span>) <span class="keyword">extends</span> <span class="title">Tree</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Expression</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Environment</span> </span>= <span class="type">String</span> =&gt; <span class="type">Int</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">eval</span></span>(t: <span class="type">Tree</span>, env: <span class="type">Environment</span>): <span class="type">Int</span> = t <span class="keyword">match</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">Sum</span>(l, r) =&gt; eval(l, env) + eval(r, env)</span><br><span class="line">        <span class="keyword">case</span> <span class="type">Var</span>(n) =&gt; env(n)</span><br><span class="line">        <span class="keyword">case</span> <span class="type">Const</span>(v) =&gt; v</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">derive</span></span>(t: <span class="type">Tree</span>, v: <span class="type">String</span>): <span class="type">Tree</span> = t <span class="keyword">match</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">Sum</span>(l, r) =&gt; <span class="type">Sum</span>(derive(l, v), derive(r, v))</span><br><span class="line">        <span class="keyword">case</span> <span class="type">Var</span>(n) <span class="keyword">if</span> (v == n) =&gt; <span class="type">Const</span>(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">case</span> _ =&gt; <span class="type">Const</span>(<span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">        <span class="keyword">val</span> exp: <span class="type">Tree</span> = <span class="type">Sum</span>(<span class="type">Sum</span>(<span class="type">Var</span>(<span class="string">&quot;x&quot;</span>), <span class="type">Var</span>(<span class="string">&quot;x&quot;</span>)), <span class="type">Sum</span>(<span class="type">Const</span>(<span class="number">7</span>), <span class="type">Var</span>(<span class="string">&quot;y&quot;</span>))) </span><br><span class="line">        <span class="keyword">val</span> env: <span class="type">Environment</span> = &#123;<span class="keyword">case</span> <span class="string">&quot;x&quot;</span> =&gt; <span class="number">5</span> <span class="keyword">case</span> <span class="string">&quot;y&quot;</span> =&gt; <span class="number">7</span>&#125;</span><br><span class="line">        println(<span class="string">&quot;Expression: &quot;</span> + exp)</span><br><span class="line">        println(<span class="string">&quot;Evalution with x=5, y=7: &quot;</span> + eval(exp, env))</span><br><span class="line">        println(<span class="string">&quot;Derivative relative to x:\n&quot;</span> + derive(exp, <span class="string">&quot;x&quot;</span>))</span><br><span class="line">        println(<span class="string">&quot;Derivative relative to y:\n&quot;</span> + derive(exp, <span class="string">&quot;y&quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>　　该示例主要用来说明两种 case 关键字，分别为：case class 和 ... match case ...，前者可认为是一个结构体，实例化时可以省略 new 关键字，参数有默认的 getter 函数，整个 case class 有默认的 equals 和 hashCode 方法实现，通过这两个方式可实现根据值判断类的两个实例是否相等，而不是通过引用，条件类同样有默认的 toString 方法实现；后者可认为是一种特殊的 switch case ，只不过 case 的判定和执行是函数式的，case class 可直接参与 match case 的判定（判定是不是属于该类）。第 7 行中有个 type 关键字，可认为是定义了一种新的类型（不是数据类型），示例中是函数类型，通过这个 type ，可直接将字符串映射为整型，23 行中将这个 type 与 case 结合使用，定义多个字符串映射多个整型的变量。第 18 行中有个 <code>_</code> ，这是 scala 中的通配符，不同的语义下表示的含义不同，这里的含义是指，当上面的模式都不匹配时，将执行这个，相当于 switch case 中的 default。</p><h4 id="scala-中的-trait">Scala 中的 trait</h4><p>　　简单理解就是 Java 中的 Interface（接口），Scala 中没有 interface 关键字，但是 trait 比 Interface 的功能更多，其中可直接定义属性和方法的实现，Scala 中可通过 trait 来实现多重继承。下面的示例用 trait 简单实现了一个比较接口：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Ord</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">&lt;</span></span>(that: <span class="type">Any</span>): <span class="type">Boolean</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">&lt;=</span></span>(that: <span class="type">Any</span>): <span class="type">Boolean</span> = (<span class="keyword">this</span> &lt; that) || (<span class="keyword">this</span> == that)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">&gt;</span></span>(that: <span class="type">Any</span>): <span class="type">Boolean</span> = !(<span class="keyword">this</span> &lt;= that)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">&gt;=</span></span>(that: <span class="type">Any</span>): <span class="type">Boolean</span> = !(<span class="keyword">this</span> &lt; that)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Date</span>(<span class="params">y: <span class="type">Int</span>, m: <span class="type">Int</span>, d: <span class="type">Int</span></span>) <span class="keyword">extends</span> <span class="title">Ord</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">year</span> </span>= y</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">month</span> </span>= m</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">day</span> </span>= d</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">toString</span></span>(): <span class="type">String</span> = year + <span class="string">&quot;-&quot;</span> + month + <span class="string">&quot;-&quot;</span> + day</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">equals</span></span>(that: <span class="type">Any</span>): <span class="type">Boolean</span> = &#123;</span><br><span class="line">        that.isInstanceOf[<span class="type">Date</span>] &amp;&amp; &#123;</span><br><span class="line">            <span class="keyword">val</span> o = that.asInstanceOf[<span class="type">Date</span>]</span><br><span class="line">            o.day == day &amp;&amp; o.month == month &amp;&amp; o.year == year</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">&lt;</span></span>(that: <span class="type">Any</span>): <span class="type">Boolean</span> = &#123;</span><br><span class="line">        <span class="keyword">if</span> (!that.isInstanceOf[<span class="type">Date</span>]) &#123;</span><br><span class="line">            sys.error(<span class="string">&quot;cannot compare &quot;</span> + that + <span class="string">&quot; and a Date&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> o = that.asInstanceOf[<span class="type">Date</span>]</span><br><span class="line">        (year &lt; o.year) || (year == o.year &amp;&amp; (month &lt; o.month || (month == o.month &amp;&amp; day &lt; o.day)))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Comparable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">        <span class="keyword">val</span> d1 = <span class="keyword">new</span> <span class="type">Date</span>(<span class="number">2021</span>, <span class="number">1</span>, <span class="number">3</span>);</span><br><span class="line">        <span class="keyword">val</span> d2 = <span class="keyword">new</span> <span class="type">Date</span>(<span class="number">2021</span>, <span class="number">1</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">        println(d1 &lt; d2)</span><br><span class="line">        println(d1 &lt;= d2)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>　　比较关系一般只需要确定 小于 和 等于 关系即可，其它关系都可由这两关系推出来，由于等于方法默认存在于所有对象中，所以只需要重写小于即可， 其它的比较方法都可以在 trait 中定义好。在上面的示例中有两个函数 isInstanceOf 和 asInstanceOf，前者用来判断对象是否是指定类型，后者用来将对象转换为指定类型，一般用在将父类转为子类时，在使用 asInstanceOf 之前一般需要先使用 isInstanceOf。</p><h4 id="泛型">泛型</h4><p>　　这东西没啥好说的，基本有编程经验的或见过或用过，只是 Scala 的泛型语法确实有点奇怪就是了，可能也是为了函数式那些乱七八糟的操作符，具体示例代码如下：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Reference</span>[<span class="type">T</span>] </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> contents: <span class="type">T</span> = _</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set</span></span>(value: <span class="type">T</span>) &#123;</span><br><span class="line">        contents = value</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span></span>: <span class="type">T</span> = contents</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">IntegerReference</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">        <span class="keyword">val</span> cell = <span class="keyword">new</span> <span class="type">Reference</span>[<span class="type">Int</span>]</span><br><span class="line">        cell.set(<span class="number">13</span>)</span><br><span class="line">        println(<span class="string">&quot;Reference contains the half of &quot;</span> + (cell.get * <span class="number">2</span>))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>　　这里同样有个 <code>_</code>，这里表示的是默认值，对于数字类型来说是 0，对于 boolean 来说是 false，对于 Unit（函数签名）来说是()（无参数无返回），对于其他来说是 null。</p><p>简单的了解 Scala 就到这里了。</p><hr><h3 id="第二章快排">第二章：快排</h3><p>开场就是一个快排，示例代码如下：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">QuickSort</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">qSort</span></span>(xs: <span class="type">Array</span>[<span class="type">Int</span>]) &#123;</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">swap</span></span>(i: <span class="type">Int</span>, j: <span class="type">Int</span>) &#123;</span><br><span class="line">            <span class="keyword">val</span> t = xs(i); xs(i) = xs(j); xs(j) = t;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">sort</span></span>(l: <span class="type">Int</span>, r: <span class="type">Int</span>) &#123;</span><br><span class="line">            <span class="keyword">val</span> pivot = xs(l);</span><br><span class="line">            <span class="keyword">var</span> i = l+<span class="number">1</span>; <span class="keyword">var</span> j = r;</span><br><span class="line">            <span class="keyword">while</span> (i &lt; j) &#123;</span><br><span class="line">                <span class="keyword">while</span> (i &lt;= r &amp;&amp; xs(i) &lt; pivot) i += <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">while</span> (j &gt; l &amp;&amp; xs(j) &gt; pivot) j -= <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (i &lt; j) &#123;</span><br><span class="line">                    swap(i, j);</span><br><span class="line">                    i += <span class="number">1</span>;</span><br><span class="line">                    j -= <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (i &gt; j) &#123;</span><br><span class="line">                    i = j;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> (i &gt; l &amp;&amp; xs(i) &gt; pivot) &#123;</span><br><span class="line">                i -= <span class="number">1</span>; j -= <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            swap(i, l);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (l &lt; j<span class="number">-1</span>) sort(l, j<span class="number">-1</span>);</span><br><span class="line">            <span class="keyword">if</span> (j+<span class="number">1</span> &lt; r) sort(j+<span class="number">1</span>, r);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sort(<span class="number">0</span>, xs.length<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">        <span class="comment">// val xs = Array(4, 1, 2, 5, 6);</span></span><br><span class="line">        <span class="comment">// val xs = Array(1, 2, 4, 4, 55, 5, 6);</span></span><br><span class="line">        <span class="comment">// val xs = Array(55, 6, 6);</span></span><br><span class="line">        <span class="keyword">val</span> xs = <span class="type">Array</span>(<span class="number">4</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>, <span class="number">2</span>, <span class="number">6</span>);</span><br><span class="line">        qSort(xs);</span><br><span class="line">        println(xs.mkString(<span class="string">&quot; &quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>　　从这段快排代码可看出，Scala 支持函数嵌套和闭包，即在函数内部定义子函数，子函数可直接使用父函数的变量，同时，这里也简单说明一下 Scala 中数组的一些使用方法，用下标取数组元素时使用的是小括号 <code>()</code>，而不是其它语言常见的中括号 <code>[]</code>。当然 Scala 作为一种函数式语言，提供了非常多的函数式操作符，这篇也只会简单介绍。</p><h3 id="第三章actor">第三章：Actor</h3><p>　　Actor，Scala 中的多线程编程模型，下方的示例代码在 Scala 2.11 及之后的版本无法运行，因为 Actor 已从 Scala 库独立出来，见 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/29343770/object-actors-is-not-a-member-of-package-scala">object-actors-is-not-a-member-of-package-scala</a>。</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scala.actors.<span class="type">Actor</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AuctionMessage</span></span></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Offer</span>(<span class="params">bin: <span class="type">Int</span>, client: <span class="type">Actor</span></span>) <span class="keyword">extends</span> <span class="title">AuctionMessage</span></span></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Inquire</span>(<span class="params">client: <span class="type">Actor</span></span>) <span class="keyword">extends</span> <span class="title">AuctionMessage</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AuctionReply</span></span></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Status</span>(<span class="params">asked: <span class="type">Int</span>, expire: <span class="type">Date</span></span>) <span class="keyword">extends</span> <span class="title">AuctionReply</span></span></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">object</span> <span class="title">BestOffer</span> <span class="keyword">extends</span> <span class="title">AuctionReply</span></span></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">BeatenOffer</span>(<span class="params">maxBid: <span class="type">Int</span></span>) <span class="keyword">extends</span> <span class="title">AuctionReply</span></span></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">AuctionConCluded</span>(<span class="params">seller: <span class="type">Actor</span>, client: <span class="type">Actor</span></span>) <span class="keyword">extends</span> <span class="title">AuctionReply</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">object</span> <span class="title">AuctionFailed</span> <span class="keyword">extends</span> <span class="title">AuctionReply</span></span></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">object</span> <span class="title">AuctionOver</span> <span class="keyword">extends</span> <span class="title">AuctionReply</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Auction</span>(<span class="params">seller: <span class="type">Actor</span>, minBid: <span class="type">Int</span>, closing: <span class="type">Date</span></span>) <span class="keyword">extends</span> <span class="title">Actor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">val</span> timeToShutdown = <span class="number">36000000</span> <span class="comment">// msec</span></span><br><span class="line">    <span class="keyword">val</span> bidIncrement = <span class="number">10</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">act</span></span>() &#123;</span><br><span class="line">        <span class="keyword">var</span> maxBid = minBid - bidIncrement</span><br><span class="line">        <span class="keyword">var</span> maxBidder: <span class="type">Actor</span> = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">var</span> running = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (running) &#123;</span><br><span class="line">            receiveWithin ((closing.getTime() - <span class="keyword">new</span> <span class="type">Date</span>().getTime())) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="type">Offer</span>(bid, client) =&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> (bid &gt;= maxBid + bidIncrement) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (maxBid &gt;= minBid)   maxBidder ! <span class="type">BeatenOffer</span>(bid)</span><br><span class="line">                        maxBid = bid; maxBidder = client; client ! <span class="type">BestOffer</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        client ! <span class="type">BeatenOffer</span>(maxBid)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> <span class="type">Inquire</span>(client) =&gt; &#123;</span><br><span class="line">                    client ! <span class="type">BeatenOffer</span>(maxBid)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> <span class="type">TIMEOUT</span> =&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> (maxBid &gt;= minBid) &#123;</span><br><span class="line">                        <span class="keyword">val</span> reply = <span class="type">AuctionConCluded</span>(seller, maxBidder)</span><br><span class="line">                        maxBidder ! reply; seller ! reply</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        seller ! <span class="type">AuctionFailed</span></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    receiveWithin(timeToShutdown) &#123;</span><br><span class="line">                        <span class="keyword">case</span> <span class="type">Offer</span>(_, client) =&gt; client ! <span class="type">AuctionOver</span></span><br><span class="line">                        <span class="keyword">case</span> <span class="type">TIMEOUT</span> =&gt; running = <span class="literal">false</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloActor</span> <span class="keyword">extends</span> <span class="title">Actor</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">act</span></span>() &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            receive &#123;</span><br><span class="line">                <span class="keyword">case</span> name: <span class="type">String</span> =&gt; println(<span class="string">&quot;Hello, &quot;</span> + name)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">AuctionService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">        <span class="keyword">val</span> seller: <span class="type">Actor</span> = <span class="keyword">new</span> <span class="type">HelloActor</span></span><br><span class="line">        <span class="keyword">val</span> client: <span class="type">Actor</span> = <span class="keyword">new</span> <span class="type">HelloActor</span></span><br><span class="line">        <span class="keyword">val</span> minBid = <span class="number">10</span></span><br><span class="line">        <span class="keyword">val</span> closing = <span class="keyword">new</span> <span class="type">Date</span>()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> helloActor = <span class="keyword">new</span> <span class="type">HelloActor</span></span><br><span class="line">        helloActor.start()</span><br><span class="line">        helloActor ! <span class="string">&quot;leo&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>　　通过重写 Actor 中的 <code>act</code> 方法即可简单的实现多线程编程，Actor 中有个特殊的标识符 <code>!</code>，该符号其实是是一种缩写，即可将 <code>helloActor.!("leo")</code> 缩写为 <code>helloActor ! "leo"</code>，代表将数据传递给 Actor，由 Actor 内部的 <code>receive case</code> 接受数据并处理，当然也可通过 <code>receiveWithin</code> 控制数据传递时间，若超时，则默认触发 <code>TIMEOUT</code> 处理模式。</p><h3 id="第四章表达式与简单函数">第四章：表达式与简单函数</h3><p>该章主要有两个例子：1、牛顿法求平方根；2、尾递归，具体如下：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Sqrt</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sqrt</span></span>(x: <span class="type">Double</span>): <span class="type">Double</span> = &#123;</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">sqrtIter</span></span>(guess: <span class="type">Double</span>, x: <span class="type">Double</span>): <span class="type">Double</span> = &#123;</span><br><span class="line">            <span class="keyword">if</span> (isGoodEnough(guess, x)) guess</span><br><span class="line">            <span class="keyword">else</span> sqrtIter(improve(guess, x), x)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">improve</span></span>(guess: <span class="type">Double</span>, x: <span class="type">Double</span>) = &#123;</span><br><span class="line">            (guess + x / guess) / <span class="number">2</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">isGoodEnough</span></span>(guess: <span class="type">Double</span>, x: <span class="type">Double</span>) = (guess * guess - x).abs &lt; <span class="number">0.001</span>    <span class="comment">// guess * guess == x</span></span><br><span class="line"></span><br><span class="line">        sqrtIter(<span class="number">1.0</span>, x)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">TailRecursion</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">gcd</span></span>(a: <span class="type">Int</span>, b: <span class="type">Int</span>): <span class="type">Int</span> = <span class="keyword">if</span> (b == <span class="number">0</span>) a <span class="keyword">else</span> gcd(b, a % b)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">facorial</span></span>(n: <span class="type">Int</span>): <span class="type">Int</span> = <span class="keyword">if</span> (n == <span class="number">0</span>) <span class="number">1</span> <span class="keyword">else</span> n * facorial(n<span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">facorialTail</span></span>(n: <span class="type">Int</span>): <span class="type">Int</span> = &#123;</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">facorialIter</span></span>(n: <span class="type">Int</span>, res: <span class="type">Int</span>): <span class="type">Int</span> = &#123;</span><br><span class="line">            <span class="keyword">if</span> (n == <span class="number">0</span>) res</span><br><span class="line">            <span class="keyword">else</span> facorialIter(n<span class="number">-1</span>, res * n)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        facorialIter(n, <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">SimpleFunc</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">        <span class="keyword">val</span> sqrtValue = <span class="type">Sqrt</span>.sqrt(<span class="number">0.01</span>)</span><br><span class="line">        println(sqrtValue)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> gcdValue = <span class="type">TailRecursion</span>.gcd(<span class="number">14</span>,<span class="number">21</span>)</span><br><span class="line">        println(gcdValue)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> facorialValue = <span class="type">TailRecursion</span>.facorial(<span class="number">5</span>)</span><br><span class="line">        println(facorialValue)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> facorialTailValue = <span class="type">TailRecursion</span>.facorialTail(<span class="number">5</span>)</span><br><span class="line">        println(facorialTailValue)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>　　由于并没有引入新的语法，就简单聊聊这两个例子吧。牛顿法求平方根主要在于构造一个特殊的二分函数 <span class="math inline">\(y_{i+1} = (y_i + x / y_i)/2, i=0,1,2,3,..., y_0=1\)</span> ，如此迭代，直到 <span class="math inline">\(|y_i^2-x| &lt; \epsilon\)</span> ，得到 <span class="math inline">\(y_i\)</span> 即为 x 的平方根，更朴素一点的求多次方根就是利用二分法，分 [0, 1] 和 [1, +∞] 两个区间即可，对应从 [x, 1] 和 [1, x] 开始二分取值。至于尾递归，以前简单的写过一点，即最后递归调用原函数时，原函数不会再参与任何计算表达式。尾递归的好处在于当编译器或解释器支持尾递归时，将不会产生普通递归时的压栈操作，即不用担心递归层次太深，尾递归将类似循环迭代处理。</p><h3 id="第五章高阶函数">第五章：高阶函数</h3><p>　　高阶函数（First-Class Functions），支持以函数作为参数或返回值，也可将函数赋值给其它变量，由此也可引出闭包和柯里化，闭包是指将内嵌函数作为返回值，而柯里化是指将多个参数分解为独立参数传递给函数，如：<span class="math inline">\(f(args_1,args_2,...,args_n)=f(args_1)(args_2)(...)(args_n)\)</span>。下面以求函数的不动点为例：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">FirstClassFunctions</span> </span>&#123;</span><br><span class="line">    <span class="keyword">val</span> tolerance = <span class="number">0.0001</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">isCloseEnough</span></span>(x: <span class="type">Double</span>, y: <span class="type">Double</span>) = ((x-y) / x).abs &lt; tolerance</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fixedPoint</span></span>(f: <span class="type">Double</span> =&gt; <span class="type">Double</span>)(firstGuess: <span class="type">Double</span>) = &#123;</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">iterate</span></span>(guess: <span class="type">Double</span>): <span class="type">Double</span> = &#123;</span><br><span class="line">            <span class="keyword">val</span> next = f(guess)</span><br><span class="line">            <span class="keyword">if</span> (isCloseEnough(guess, next)) next</span><br><span class="line">            <span class="keyword">else</span> iterate(next)</span><br><span class="line">        &#125;</span><br><span class="line">        iterate(firstGuess)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">averageDamp</span></span>(f: <span class="type">Double</span> =&gt; <span class="type">Double</span>)(x: <span class="type">Double</span>) = (x + f(x)) / <span class="number">2</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sqrt</span></span>(x: <span class="type">Double</span>) = fixedPoint(averageDamp(y =&gt; x/y))(<span class="number">1.0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">        println(sqrt(<span class="number">0.01</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>　　该示例简单明了的展示了 Scala 中匿名函数，函数柯里化以及闭包。</p><h3 id="第六章类和对象">第六章：类和对象</h3><p>直接看下面的有理数示例吧，</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 主构造函数</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rational</span>(<span class="params">n: <span class="type">Int</span>, d: <span class="type">Int</span></span>) <span class="keyword">extends</span> <span class="title">AnyRef</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">gcd</span></span>(x: <span class="type">Int</span>, y: <span class="type">Int</span>): <span class="type">Int</span> = &#123;</span><br><span class="line">        <span class="keyword">if</span> (x == <span class="number">0</span>) y</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (x &lt; <span class="number">0</span>) gcd(-x, y)</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (y &lt; <span class="number">0</span>) -gcd(x, -y)</span><br><span class="line">        <span class="keyword">else</span> gcd(y % x, x)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> g = gcd(n, d)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造函数重载（辅助构造函数）</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">this</span></span>() &#123;</span><br><span class="line">        <span class="keyword">this</span>(<span class="number">0</span>, <span class="number">0</span>)  <span class="comment">// 调用主构造函数</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> number: <span class="type">Int</span> = <span class="keyword">if</span> (g != <span class="number">0</span>) n / g <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">val</span> denom: <span class="type">Int</span> = <span class="keyword">if</span> (g != <span class="number">0</span>) d / g <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">+</span></span>(that: <span class="type">Rational</span>) = <span class="keyword">new</span> <span class="type">Rational</span>(number * that.denom + that.number * denom, denom * that.denom)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">-</span></span>(that: <span class="type">Rational</span>) = <span class="keyword">new</span> <span class="type">Rational</span>(number * that.denom - that.number * denom, denom * that.denom)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">*</span></span>(that: <span class="type">Rational</span>) = <span class="keyword">new</span> <span class="type">Rational</span>(number * that.number, denom * that.denom)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">/</span></span>(that: <span class="type">Rational</span>) = <span class="keyword">new</span> <span class="type">Rational</span>(number * that.denom, denom * that.number)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">toNumber</span></span>: <span class="type">Double</span> = <span class="keyword">if</span> (denom != <span class="number">0</span>) number.toDouble / denom <span class="keyword">else</span> <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">toString</span> </span>= <span class="string">&quot;&quot;</span> + number + <span class="string">&quot;/&quot;</span> + denom</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Rational</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">        <span class="keyword">val</span> rational = <span class="keyword">new</span> <span class="type">Rational</span>(<span class="number">2</span>,<span class="number">1</span>) / <span class="keyword">new</span> <span class="type">Rational</span>()</span><br><span class="line">        println(rational.toNumber);</span><br><span class="line">        println(rational.toString);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>　　从有理数这个示例可以看出，Scala 的类支持操作符重载，也支持构造函数重载，同样支持继承，多继承也是支持的，每个父类用 <code>with</code> 关键字分隔就行。</p><h3 id="第七章条件类和模式匹配">第七章：条件类和模式匹配</h3><p>大致和第一章内容差不多，就不重复写了。</p><h3 id="第八章泛型">第八章：泛型</h3><p>　　大致也和第一章内容差不多，<em>值得一提的书中实现的泛型栈本质是一个链表，实现方法挺有意思的</em>。通过 <code>&lt;:</code> 标识符可约束泛型的类型，如 <code>[T &lt;: P[T]]</code> 表明泛型 T 必须类型 P 的子类型。而标识符 <code>&lt;%</code> 比 <code>&lt;:</code> 约束性弱一点，只要 T 能够通过隐式类型变换为 P 即可。若想约束为父类型，则需使用 <code>&gt;:</code> 标识符。</p><p>　　Scala 中有一种特殊的泛型，就是变化型注解，<code>trait List[+T]</code> 代表协变，表示当 B 类型是 A 类型子类时，<code>List[B]</code> 也可认为是 <code>List[A]</code> 的子类；<code>trait List[-T]</code> 代表逆变，当 B 类型是 A 类型子类时，<code>List[B]</code> 可认为是 <code>List[A]</code> 的父类。</p><p>　　Scala 中同样有元组，使用时也很方便，简单使用直接用括号声明即可，如 <code>def divmod(x: Int, y: Int): (Int, Int) = (x / y, x % y)</code>，该函数即返回一个元组，也可声明一个元组 <code>case class Tuple2[A, B](_1: A, _2: B)</code>，若需要取元组的元素可通过 <code>_i</code> 的方式，如 <code>val xy = divmod(3, 4); xy._1; xy._2;</code>，也可通过 match-case 语句取，如 <code>xy match &#123; case (n, d) =&gt; println("quotient: " + n + ", rest: " + d) &#125;</code>。</p><h3 id="第九章list">第九章：List</h3><p>　　Scala 中的 List 其实是数组结构，并且是不可变的，可认为是 C++ 里的静态数组，不能往其中添加或删除元素，下面用数组排序示例下 List 的用法：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Sort</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">insertSort</span></span>(xsl: <span class="type">List</span>[<span class="type">Int</span>]): <span class="type">List</span>[<span class="type">Int</span>] = &#123;</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">insert</span></span>(x: <span class="type">Int</span>, xs: <span class="type">List</span>[<span class="type">Int</span>]): <span class="type">List</span>[<span class="type">Int</span>] = &#123;</span><br><span class="line">            xs <span class="keyword">match</span> &#123;</span><br><span class="line">                <span class="comment">// case Nil =&gt; List(x)</span></span><br><span class="line">                <span class="keyword">case</span> <span class="type">List</span>() =&gt; <span class="type">List</span>(x)</span><br><span class="line">                <span class="keyword">case</span> y :: ys =&gt; <span class="keyword">if</span> (x &lt;= y) x :: xs <span class="keyword">else</span> y :: insert(x, ys)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (xsl.isEmpty) <span class="type">Nil</span></span><br><span class="line">        <span class="keyword">else</span> insert(xsl.head, insertSort(xsl.tail))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mergeSort</span></span>[<span class="type">A</span>](less: (<span class="type">A</span>, <span class="type">A</span>) =&gt; <span class="type">Boolean</span>)(xs: <span class="type">List</span>[<span class="type">A</span>]): <span class="type">List</span>[<span class="type">A</span>] = &#123;</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">merge</span></span>(xs1: <span class="type">List</span>[<span class="type">A</span>], xs2: <span class="type">List</span>[<span class="type">A</span>]): <span class="type">List</span>[<span class="type">A</span>] = &#123;</span><br><span class="line">            <span class="keyword">if</span> (xs1.isEmpty) xs2</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (xs2.isEmpty) xs1</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (less(xs1.head, xs2.head)) xs1.head :: merge(xs1.tail, xs2)</span><br><span class="line">            <span class="keyword">else</span>  xs2.head :: merge(xs1, xs2.tail)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> n = xs.length / <span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> (n == <span class="number">0</span>) xs</span><br><span class="line">        <span class="keyword">else</span> merge(mergeSort(less)(xs take n), mergeSort(less)(xs drop n))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">        <span class="keyword">val</span> xs = <span class="type">List</span>(<span class="number">4</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>, <span class="number">2</span>, <span class="number">6</span>);</span><br><span class="line">        <span class="comment">// val xs = 3::2::1::1::Nil;</span></span><br><span class="line">        println(xs(<span class="number">0</span>), xs(<span class="number">1</span>), xs(xs.length<span class="number">-1</span>)) <span class="comment">// (4,1,6)</span></span><br><span class="line">        <span class="comment">// val ys = insertSort(xs);</span></span><br><span class="line">        <span class="keyword">val</span> ys = mergeSort((x: <span class="type">Int</span>, y: <span class="type">Int</span>) =&gt; x &gt; y)(xs);</span><br><span class="line">        println(ys.mkString(<span class="string">&quot; &quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>　　List 中有两个操作符非常类似，即 <code>::</code> 和 <code>:::</code>， 前者用于 List 中的元素和 List 连接，即创建一个新 List，新 List 为原 List 头插入元素后的 List，后者用于连接两个 List，即创建一个新 List ，新 List 为将第二个 List 的元素全部放入第一个 List 尾部的 List。字符 <code>Nil</code> 代表空 List 和 <code>List()</code> 等效，<code>head</code> 方法返回 List 的第一个元素，<code>tail</code> 方法返回除第一个元素之外的其它所有元素，还是一个 List，<code>isEmpty</code> 方法当 List 为空时返回 <code>true</code>。List 的 case-match 方法中，<code>case y :: ys</code> 其中 y 代表 xs.head，ys 代表 xs.tail。<code>(xs take n)</code> 表示取 List 前 n 个元素，<code>(xs drop n)</code> 表示取 List 前 n 个元素之外的元素，即与 (xs take n) 取得元素正好互补，而 <code>(xs split n)</code> 返回一个元组，元组中第一个元素为 (xs take n)，第二个元素为 (xs drop n)。关于 List 还有些更高阶得方法：filter，map, flatMap, reduceRight, foldRight 等方法就不继续写了。至于动态 List 可用 <code>ListBuffer</code> 结构，当然 Scala 中直接用 <code>Seq</code> 作为返回值和参数一般会更好些。</p><h3 id="第十章序列理解">第十章：序列理解</h3><p>　　Scala 中用来做序列理解的表达式是 <code>For-Comprehensions</code>，具体示例如下：<code>for (p &lt;persons if p.age &gt; 20) yield p.name</code> 相当于 <code>persons filter (p =&gt; p.age &gt; 20) map (p =&gt; p.name)</code>，可以简单认为 for-yield 方法是 filter 和 map 的集合体。下面具体用个 N-皇后（特例是 8 皇后）的示例来具体说明：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">NQueen</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">queens</span></span>(n: <span class="type">Int</span>): <span class="type">List</span>[<span class="type">List</span>[<span class="type">Int</span>]] = &#123;</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">isSafe</span></span>(col: <span class="type">Int</span>, queenList: <span class="type">List</span>[<span class="type">Int</span>], delta: <span class="type">Int</span>): <span class="type">Boolean</span> = &#123;</span><br><span class="line">            <span class="keyword">val</span> curRow = queenList.length<span class="number">-1</span> + delta</span><br><span class="line">            <span class="keyword">for</span> (row &lt;- <span class="type">List</span>.range(<span class="number">0</span>, queenList.length)) &#123;</span><br><span class="line">                <span class="keyword">val</span> queenCol = queenList(row)</span><br><span class="line">                <span class="keyword">val</span> queenRow = queenList.length<span class="number">-1</span> - row</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (queenCol == col) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">                <span class="keyword">if</span> (queenRow == curRow) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">                <span class="keyword">if</span> ((queenCol - col).abs == (queenRow - curRow).abs) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">placeQueens</span></span>(k: <span class="type">Int</span>): <span class="type">List</span>[<span class="type">List</span>[<span class="type">Int</span>]] = &#123;</span><br><span class="line">            <span class="keyword">if</span> (k == <span class="number">0</span>) <span class="type">List</span>(<span class="type">List</span>())</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">for</span> &#123; </span><br><span class="line">                queens &lt;- placeQueens(k<span class="number">-1</span>);</span><br><span class="line">                column &lt;- <span class="type">List</span>.range(<span class="number">0</span>, n);</span><br><span class="line">                <span class="keyword">if</span> isSafe(column, queens, <span class="number">1</span>) </span><br><span class="line">            &#125; <span class="keyword">yield</span> column :: queens</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        placeQueens(n)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">        <span class="keyword">val</span> queenList = queens(<span class="number">8</span>);</span><br><span class="line">        println(<span class="string">&quot;queenCount: &quot;</span> + queenList.length)  <span class="comment">// 92</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>for-yield 表达式中 for 中可以写多条语句，代表多重循环，第 5 行的 for 代表 for 循环，<code>&lt;-</code> 表示取 List 中的元素。</p><hr><p>　　剩下的几章就没啥特别要写的，重点就两个特性，一个是 Stream ，一个 Lazy，Stream 和 List 有点类似，主要区别在于 Stream 是即时返回的，算一个返回一个，而 List 一般是全部计算完再返回一个 List；Lazy 一般用作常量的修饰符，主要作用是只用该常量被用到时才赋值，否则一直为空，有点类似常见的先判空再取值的封装。</p><h2 id="后记">后记</h2><p>　　曾看到过通过刷题去学习新语言的方式，一直都以为很粗暴，但这次照着「Scala By Example」敲下来，感觉还挺有效的，同时也巩固了一下基本的算法知识，后续再把 twitter 的 「Effective Scala」再看一下应该就差不多了。</p></div><div class="article-content-more"><button type="button" class="article-more--link"><i class="fa fa-angle-double-down fa-3x" aria-hidden="true"></i></button></div></section></article><article id="post-Linux服务器运维文档" class="article div-border"><header class="article-header"><span class="article-date article-title--index"><i class="fa fa-calendar" aria-hidden="true"></i> <a href="/posts/b59e3e7b.html"><time datetime="2021-02-09T12:06:27.000Z">2021-02-09</time></a></span><section class="article-title article-title--index"><a href="/posts/b59e3e7b.html">Linux服务器运维文档</a></section><div class="article-label"><div class="article-category label"><i class="fa fa-book" aria-hidden="true"></i> <a class="color1 article-category-link" href="/categories/Wiki/">Wiki</a></div><div class="article-tag label"><i class="fa fa-bookmark" aria-hidden="true"></i> <a class="color5 article-tag-none-link" href="/tags/note/" rel="tag">note</a><a class="color5 article-tag-none-link" href="/tags/unix-like/" rel="tag">unix-like</a></div></div></header><section class="article-content"><div class="article-content--excerpt"><h2 id="前言">前言</h2><p>　　记录一下服务器问题排查常用的一些命令。</p></div><div class="article-content--all"><h2 id="前言">前言</h2><p>　　记录一下服务器问题排查常用的一些命令。</p><span id="more"></span><h2 id="常用篇">常用篇</h2><h3 id="linux">Linux</h3><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 只列出含 XXX 的文件</span></span><br><span class="line">ll | grep &quot;XXX&quot;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 按列显示文件名</span></span><br><span class="line">ls -1</span><br><span class="line">ls -l | grep ^[^d] | awk &#x27;&#123;print $9&#125;&#x27;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 返回进入当前目录之前的目录</span></span><br><span class="line">cd -</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在文件中查找带 XXX 的行，并输出到 /tmp/99</span></span><br><span class="line">fgrep &quot;XXX&quot; a.txt &gt; /tmp/99</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在当前文件夹中查找带 XXX 的行，并输出到 /tmp/99</span></span><br><span class="line">fgrep &quot;XXX&quot; -r ./* &gt; /tmp/99</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示前5行</span></span><br><span class="line">head -n 5 a.txt</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示倒数第5行</span></span><br><span class="line">tail -n 5 a.txt</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示第5行至末尾</span></span><br><span class="line">tail -n +5 a.txt</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">  提取第二行 [linux系统中sed命令输出指定的行](https://www.cnblogs.com/superbaby11/p/16556602.html)</span></span><br><span class="line">sed -n &#x27;2p&#x27; a.txt</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 以;分隔每一行，并提取第一列和第三列</span></span><br><span class="line">awk -F &#x27;;&#x27; &#x27;&#123;print $1,$3&#125;&#x27; a.txt</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 以:分隔每一行，并提取第一列和第三列</span></span><br><span class="line">awk -F &#x27;[:]&#x27; &#x27;&#123;print $1,$3&#125;&#x27; a.txt</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看 8080 端口占用</span></span><br><span class="line">lsof -i:8080</span><br><span class="line">netstat -tnlp | grep :8080</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看系统运行状态</span></span><br><span class="line">top</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看一定时间内进程cpu占用情况</span></span><br><span class="line">pidstat</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看运行进程</span></span><br><span class="line">ps -ef</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看postgres数据库连接状态，并按cpu使用率排序</span></span><br><span class="line">ps -aux | grep postgres | sort -nrk 3,3</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看磁盘占用大小</span></span><br><span class="line">du -sh *</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看磁盘剩余空间</span></span><br><span class="line">df -h</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看程序被 killed 的原因</span></span><br><span class="line">dmesg | egrep -i -B100 &#x27;killed process&#x27;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看 url 请求时间</span></span><br><span class="line">curl -o /dev/null -s -w %&#123;time_namelookup&#125;:%&#123;time_connect&#125;:%&#123;time_starttransfer&#125;:%&#123;time_total&#125; [url]</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><h4 id="正则表达式">正则表达式</h4><p>常用正则：<a target="_blank" rel="noopener" href="https://ihateregex.io">i Hate Regex</a></p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// 匹配 hello 之前的字符</span><br><span class="line">(.+(?=hello))</span><br><span class="line"></span><br><span class="line">// 匹配其他数字和英文字母但不匹配结尾的 2</span><br><span class="line">([a-zA-Z_0-9]+[^2])</span><br><span class="line"></span><br><span class="line">// 提取包含test以及time后的数字</span><br><span class="line">test[a-zA-Z0-9\-\_\=\|\ ]*time=([\d+])</span><br><span class="line"></span><br><span class="line">// 提取中括号里的内容</span><br><span class="line">[\[](.*?)[\]]</span><br></pre></td></tr></table></figure></div><h4 id="工具">工具</h4><ul><li><strong>crontab</strong>：设置定时任务工具；</li><li><strong>Socat</strong>：网络工具（透明代理，端口转发，文件传输等），<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/347722248">新版瑞士军刀：socat</a></li></ul><h4 id="服务器之间文件传输">服务器之间文件传输</h4><p>参考资料：<a target="_blank" rel="noopener" href="https://blog.csdn.net/AnChenliang_1002/article/details/131466784">Linux下的SCP指令详解</a></p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 本地主机传输文件到远程主机</span></span><br><span class="line">scp [本地文件路径] [用户名]@[远程主机IP地址]:[目标路径]</span><br><span class="line"><span class="meta">#</span><span class="bash"> eg:</span></span><br><span class="line">scp file.txt user@example.com:/home/user/</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 远程主机传输文件到本地主机</span></span><br><span class="line">scp [用户名]@[远程主机IP地址]:[远程文件路径] [本地目标路径]</span><br><span class="line"><span class="meta">#</span><span class="bash"> eg:</span></span><br><span class="line">scp user@example.com:/home/user/file.txt /path/to/local/</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 传输本地主机整个目录到远程主机</span></span><br><span class="line">scp -r [本地目录路径] [用户名]@[远程主机IP地址]:[目标路径]</span><br><span class="line"><span class="meta">#</span><span class="bash"> eg:</span></span><br><span class="line">scp -r directory/ user@example.com:/home/user/</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 若远程主机的SSH服务器端口不是默认的22端口，则需要指定端口号</span></span><br><span class="line">scp -P [端口号] [本地文件路径] [用户名]@[远程主机IP地址]:[目标路径]</span><br></pre></td></tr></table></figure></div><h3 id="postgresql">PostgreSQL</h3><h4 id="编译安装">编译安装</h4><p><em>参考自：<a target="_blank" rel="noopener" href="https://blog.csdn.net/GJ454221763/article/details/113700717">【CentOS7】PostgreSQL-10.3的安装</a></em></p><ol type="1"><li><p>安装编译工具：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y vim lrzsz tree wget gcc gcc-c++ readline-devel zlib-devel</span><br></pre></td></tr></table></figure></div></li><li><p>进入/usr/local/目录下：<code>cd /usr/local</code></p></li><li><p>下载 tar 包：<code>curl -O https://ftp.postgresql.org/pub/source/v16.2/postgresql-16.2.tar.gz</code></p></li><li><p>解压：<code>tar -xzvf postgresql-16.2.tar.gz</code></p></li><li><p>编译安装：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/postgresql-16.2</span><br><span class="line">./configure --prefix=/usr/local/pgsql-16.2 # /usr/local/pgsql-16.2 为安装目录</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Two thousand years later，出现「PostgreSQL installation complete.」代表安装成功</span></span><br></pre></td></tr></table></figure></div></li><li><p>配置系统环境变量：<code>vi /etc/profile</code></p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment"># /etc/profile 文件末尾添加</span></span><br><span class="line"><span class="built_in">export</span> PGHOME=/usr/<span class="built_in">local</span>/pgsql-16.2</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PGHOME</span>/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure></div></li><li><p>使配置文件立即生效：<code>source /etc/profile</code></p></li><li><p>创建数据库用户：<code>useradd -m -d /home/postgres postgres</code></p></li><li><p>切换到数据库用户：<code>su postgres</code></p></li><li><p>初始化数据库：<code>pg_ctl init -D /home/postgres/db_data</code></p></li><li><p>启动数据库：<code>pg_ctl start -D /home/postgres/db_data</code></p></li></ol><h4 id="自启动设置">自启动设置</h4><p>复制 PostgreSQL 自启动文件：<code>cp /usr/local/postgresql-16.2/contrib/start-scripts/linux /etc/init.d/postgresql</code></p><p>修改自启动文件：<code>vi /etc/init.d/postgresql</code>，</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#! /bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># chkconfig: 2345 98 02</span></span><br><span class="line"><span class="comment"># description: PostgreSQL RDBMS</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This is an example of a start/stop script for SysV-style init, such</span></span><br><span class="line"><span class="comment"># as is used on Linux systems.  You should edit some of the variables</span></span><br><span class="line"><span class="comment"># and maybe the &#x27;echo&#x27; commands.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Place this file at /etc/init.d/postgresql (or</span></span><br><span class="line"><span class="comment"># /etc/rc.d/init.d/postgresql) and make symlinks to</span></span><br><span class="line"><span class="comment">#   /etc/rc.d/rc0.d/K02postgresql</span></span><br><span class="line"><span class="comment">#   /etc/rc.d/rc1.d/K02postgresql</span></span><br><span class="line"><span class="comment">#   /etc/rc.d/rc2.d/K02postgresql</span></span><br><span class="line"><span class="comment">#   /etc/rc.d/rc3.d/S98postgresql</span></span><br><span class="line"><span class="comment">#   /etc/rc.d/rc4.d/S98postgresql</span></span><br><span class="line"><span class="comment">#   /etc/rc.d/rc5.d/S98postgresql</span></span><br><span class="line"><span class="comment"># Or, if you have chkconfig, simply:</span></span><br><span class="line"><span class="comment"># chkconfig --add postgresql</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Proper init scripts on Linux systems normally require setting lock</span></span><br><span class="line"><span class="comment"># and pid files under /var/run as well as reacting to network</span></span><br><span class="line"><span class="comment"># settings, so you should treat this with care.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Original author:  Ryan Kirkpatrick &lt;pgsql@rkirkpat.net&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># contrib/start-scripts/linux</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## EDIT FROM HERE</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###### 上面不改 #####################</span></span><br><span class="line"><span class="comment"># Installation prefix</span></span><br><span class="line">prefix=/usr/<span class="built_in">local</span>/pgsql-16.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># Data directory</span></span><br><span class="line">PGDATA=<span class="string">&quot;/home/postgres/db_data&quot;</span></span><br><span class="line"><span class="comment">###### 下面不改 #####################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Who to run postgres as, usually &quot;postgres&quot;.  (NOT &quot;root&quot;)</span></span><br><span class="line">PGUSER=postgres</span><br><span class="line"></span><br><span class="line"><span class="comment"># Where to keep a log file</span></span><br><span class="line">PGLOG=<span class="string">&quot;<span class="variable">$PGDATA</span>/serverlog&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># It&#x27;s often a good idea to protect the postmaster from being killed by the</span></span><br><span class="line"><span class="comment"># OOM killer (which will tend to preferentially kill the postmaster because</span></span><br><span class="line"><span class="comment"># of the way it accounts for shared memory).  To do that, uncomment these</span></span><br><span class="line"><span class="comment"># three lines:</span></span><br><span class="line"><span class="comment">#PG_OOM_ADJUST_FILE=/proc/self/oom_score_adj</span></span><br><span class="line"><span class="comment">#PG_MASTER_OOM_SCORE_ADJ=-1000</span></span><br><span class="line"><span class="comment">#PG_CHILD_OOM_SCORE_ADJ=0</span></span><br><span class="line"><span class="comment"># Older Linux kernels may not have /proc/self/oom_score_adj, but instead</span></span><br><span class="line"><span class="comment"># /proc/self/oom_adj, which works similarly except for having a different</span></span><br><span class="line"><span class="comment"># range of scores.  For such a system, uncomment these three lines instead:</span></span><br><span class="line"><span class="comment">#PG_OOM_ADJUST_FILE=/proc/self/oom_adj</span></span><br><span class="line"><span class="comment">#PG_MASTER_OOM_SCORE_ADJ=-17</span></span><br><span class="line"><span class="comment">#PG_CHILD_OOM_SCORE_ADJ=0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## STOP EDITING HERE</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The path that is to be used for the script</span></span><br><span class="line">PATH=/usr/<span class="built_in">local</span>/sbin:/usr/<span class="built_in">local</span>/bin:/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># What to use to start up postgres.  (If you want the script to wait</span></span><br><span class="line"><span class="comment"># until the server has started, you could use &quot;pg_ctl start&quot; here.)</span></span><br><span class="line">DAEMON=<span class="string">&quot;<span class="variable">$prefix</span>/bin/postgres&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># What to use to shut down postgres</span></span><br><span class="line">PGCTL=<span class="string">&quot;<span class="variable">$prefix</span>/bin/pg_ctl&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line"><span class="comment"># Only start if we can find postgres.</span></span><br><span class="line"><span class="built_in">test</span> -x <span class="variable">$DAEMON</span> ||</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$DAEMON</span> not found&quot;</span></span><br><span class="line">	<span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> = <span class="string">&quot;stop&quot;</span> ]</span><br><span class="line">	<span class="keyword">then</span> <span class="built_in">exit</span> 0</span><br><span class="line">	<span class="keyword">else</span> <span class="built_in">exit</span> 5</span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># If we want to tell child processes to adjust their OOM scores, set up the</span></span><br><span class="line"><span class="comment"># necessary environment variables.  Can&#x27;t just export them through the &quot;su&quot;.</span></span><br><span class="line"><span class="keyword">if</span> [ -e <span class="string">&quot;<span class="variable">$PG_OOM_ADJUST_FILE</span>&quot;</span> -a -n <span class="string">&quot;<span class="variable">$PG_CHILD_OOM_SCORE_ADJ</span>&quot;</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">	DAEMON_ENV=<span class="string">&quot;PG_OOM_ADJUST_FILE=<span class="variable">$PG_OOM_ADJUST_FILE</span> PG_OOM_ADJUST_VALUE=<span class="variable">$PG_CHILD_OOM_SCORE_ADJ</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Parse command line parameters.</span></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">  start)</span><br><span class="line">	<span class="built_in">echo</span> -n <span class="string">&quot;Starting PostgreSQL: &quot;</span></span><br><span class="line">	<span class="built_in">test</span> -e <span class="string">&quot;<span class="variable">$PG_OOM_ADJUST_FILE</span>&quot;</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$PG_MASTER_OOM_SCORE_ADJ</span>&quot;</span> &gt; <span class="string">&quot;<span class="variable">$PG_OOM_ADJUST_FILE</span>&quot;</span></span><br><span class="line">	su - <span class="variable">$PGUSER</span> -c <span class="string">&quot;<span class="variable">$DAEMON_ENV</span> <span class="variable">$DAEMON</span> -D &#x27;<span class="variable">$PGDATA</span>&#x27; &gt;&gt;<span class="variable">$PGLOG</span> 2&gt;&amp;1 &amp;&quot;</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;ok&quot;</span></span><br><span class="line">	;;</span><br><span class="line">  stop)</span><br><span class="line">	<span class="built_in">echo</span> -n <span class="string">&quot;Stopping PostgreSQL: &quot;</span></span><br><span class="line">	su - <span class="variable">$PGUSER</span> -c <span class="string">&quot;<span class="variable">$PGCTL</span> stop -D &#x27;<span class="variable">$PGDATA</span>&#x27; -s&quot;</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;ok&quot;</span></span><br><span class="line">	;;</span><br><span class="line">  restart)</span><br><span class="line">	<span class="built_in">echo</span> -n <span class="string">&quot;Restarting PostgreSQL: &quot;</span></span><br><span class="line">	su - <span class="variable">$PGUSER</span> -c <span class="string">&quot;<span class="variable">$PGCTL</span> stop -D &#x27;<span class="variable">$PGDATA</span>&#x27; -s&quot;</span></span><br><span class="line">	<span class="built_in">test</span> -e <span class="string">&quot;<span class="variable">$PG_OOM_ADJUST_FILE</span>&quot;</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$PG_MASTER_OOM_SCORE_ADJ</span>&quot;</span> &gt; <span class="string">&quot;<span class="variable">$PG_OOM_ADJUST_FILE</span>&quot;</span></span><br><span class="line">	su - <span class="variable">$PGUSER</span> -c <span class="string">&quot;<span class="variable">$DAEMON_ENV</span> <span class="variable">$DAEMON</span> -D &#x27;<span class="variable">$PGDATA</span>&#x27; &gt;&gt;<span class="variable">$PGLOG</span> 2&gt;&amp;1 &amp;&quot;</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;ok&quot;</span></span><br><span class="line">	;;</span><br><span class="line">  reload)</span><br><span class="line">	<span class="built_in">echo</span> -n <span class="string">&quot;Reload PostgreSQL: &quot;</span></span><br><span class="line">	su - <span class="variable">$PGUSER</span> -c <span class="string">&quot;<span class="variable">$PGCTL</span> reload -D &#x27;<span class="variable">$PGDATA</span>&#x27; -s&quot;</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;ok&quot;</span></span><br><span class="line">	;;</span><br><span class="line">  status)</span><br><span class="line">	su - <span class="variable">$PGUSER</span> -c <span class="string">&quot;<span class="variable">$PGCTL</span> status -D &#x27;<span class="variable">$PGDATA</span>&#x27;&quot;</span></span><br><span class="line">	;;</span><br><span class="line">  *)</span><br><span class="line">	<span class="comment"># Print help</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="variable">$0</span> &#123;start|stop|restart|reload|status&#125;&quot;</span> 1&gt;&amp;2</span><br><span class="line">	<span class="built_in">exit</span> 1</span><br><span class="line">	;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure></div><hr><p>接下来有两种方式：</p><p>一种是直接执行：<code>cd /etc/rc.d/init.d/ &amp;&amp; chkconfig --add postgresql</code>；</p><p>一种是修改 <code>/etc/rc.d/rc.local</code> 文件：<code>vi /etc/rc.d/rc.local</code>，</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># THIS FILE IS ADDED FOR COMPATIBILITY PURPOSES</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># It is highly advisable to create own systemd services or udev rules</span></span><br><span class="line"><span class="comment"># to run scripts during boot instead of using this file.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># In contrast to previous versions due to parallel execution during boot</span></span><br><span class="line"><span class="comment"># this script will NOT be run after all other services.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Please note that you must run &#x27;chmod +x /etc/rc.d/rc.local&#x27; to ensure</span></span><br><span class="line"><span class="comment"># that this script will be executed during boot.</span></span><br><span class="line"> </span><br><span class="line"><span class="built_in">exec</span> 2&gt; /tmp/rc.local.log      <span class="comment"># send stderr from rc.local to a log file</span></span><br><span class="line"><span class="built_in">exec</span> 1&gt;&amp;2                      <span class="comment"># send stdout to the same log file</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;rc.local starting...&quot;</span>        <span class="comment"># show start of execution</span></span><br><span class="line"><span class="built_in">set</span> -x</span><br><span class="line"></span><br><span class="line">touch /var/lock/subsys/<span class="built_in">local</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /etc/rc.d/init.d/</span><br><span class="line">sudo sh postgresql start &amp;      <span class="comment"># 以root执行，不然可能会出现权限错误，&amp;表示后台执行</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 脚本执行完后也给个日志</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;rc.local completed&quot;</span></span><br></pre></td></tr></table></figure></div><p>添加可执行权限：<code>chmod a+x /etc/rc.d/rc.local</code>，最后查看一下 rc.local 服务是否启动：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">systemctl status rc-local.serives</span><br><span class="line"><span class="meta"> </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动命令</span></span><br><span class="line">systemctl enable rc-local.service</span><br><span class="line">systemctl start rc-local.service</span><br><span class="line"><span class="meta"> </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看数据库服务</span></span><br><span class="line">ps -ef | grep postgres</span><br></pre></td></tr></table></figure></div><hr><p>若要在容器中设置自启动，在没给容器提权的情况下，则需要第三种方式：将 <code>/etc/rc.d/init.d/postgresql</code> 放进 <code>/root/.bashrc</code> 中启动，<code>vi /root/.bashrc</code>，</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment"># /root/.bashrc 文件末尾添加</span></span><br><span class="line"><span class="keyword">if</span> [ -f /etc/rc.d/init.d/postgresql ]; <span class="keyword">then</span></span><br><span class="line">    sh /etc/rc.d/init.d/postgresql start &gt; /tmp/postgresql.start.log 2&gt;&amp;1</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></div><p>原理是：docker 容器在启动时，会自动执行 <code>~/.bashrc</code> 文件，加载环境变量，当有其他命令在该文件时，也会一起执行。</p><p>当然，容器中自启动更普遍的方式应该是在镜像/容器中通过 CMD 或者 ENTRYPOINT 直接指定 shell 脚本启动执行。</p><h4 id="配置文件设置">配置文件设置</h4><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 设置空闲长事务超时时间</span><br><span class="line">idle_in_transaction_session_timeout</span><br><span class="line">// 如果一个会话等待某个类型的锁的时间超过deadlock_timeout的值，该参数决定是否在数据库日志中记录这个信息。</span><br><span class="line">log_lock_waits</span><br><span class="line">deadlock_timeout</span><br><span class="line"></span><br><span class="line">// 事务执行超时时间</span><br><span class="line">statement_timeout</span><br></pre></td></tr></table></figure></div><h4 id="psql">psql</h4><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">nohup psql postgresql://user:password@host:port/dbname -f update.sql &gt; update.sql 2&gt;&amp;1 &amp;  # 刷库命令，update.sql 文件以 begin; 开始，commit; 结束</span><br><span class="line">\q # 退出数据库</span><br><span class="line">\c exampledb # 切换数据库</span><br><span class="line">\l+ # 查看全部数据库</span><br><span class="line">\du+ # 查看全部用户</span><br><span class="line">\d+ # 查看全部表</span><br><span class="line">\dt+ [table_name] # 查看表大小</span><br><span class="line">\dn+ # 查看全部schema</span><br><span class="line">\dp [table_name] # 查看表的权限详情</span><br><span class="line">\x # 竖式显示记录</span><br></pre></td></tr></table></figure></div><h4 id="sql">sql</h4><h5 id="查看锁等待状态">查看锁等待状态</h5><p><a target="_blank" rel="noopener" href="https://developer.aliyun.com/ask/54578?spm=a2c6h.13159736">pg中关于AccessShareLock和ExclusiveLock的问题</a>：</p><blockquote><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SQL"><div class="code-copy"></div><figure class="highlight hljs sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1. 先用一个函数来将锁转换为数字，</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> f_lock_level(i_mode text) <span class="keyword">returns</span> <span class="type">int</span> <span class="keyword">as</span> </span><br><span class="line">$$</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">case</span> i_mode</span><br><span class="line"> <span class="keyword">when</span> <span class="string">&#x27;INVALID&#x27;</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"> <span class="keyword">when</span> <span class="string">&#x27;AccessShareLock&#x27;</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"> <span class="keyword">when</span> <span class="string">&#x27;RowShareLock&#x27;</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line"> <span class="keyword">when</span> <span class="string">&#x27;RowExclusiveLock&#x27;</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line"> <span class="keyword">when</span> <span class="string">&#x27;ShareUpdateExclusiveLock&#x27;</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line"> <span class="keyword">when</span> <span class="string">&#x27;ShareLock&#x27;</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line"> <span class="keyword">when</span> <span class="string">&#x27;ShareRowExclusiveLock&#x27;</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="number">6</span>;</span><br><span class="line"> <span class="keyword">when</span> <span class="string">&#x27;ExclusiveLock&#x27;</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="number">7</span>;</span><br><span class="line"> <span class="keyword">when</span> <span class="string">&#x27;AccessExclusiveLock&#x27;</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="number">8</span>;</span><br><span class="line"> <span class="keyword">else</span> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">end</span> <span class="keyword">case</span>;</span><br><span class="line"><span class="keyword">end</span>; </span><br><span class="line"></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">language</span> plpgsql strict;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. 修改查询语句，按锁级别排序：</span></span><br><span class="line"><span class="keyword">with</span> t_wait <span class="keyword">as</span>                     </span><br><span class="line">(<span class="keyword">select</span> a.mode,a.locktype,a.database,a.relation,a.page,a.tuple,a.classid,a.objid,a.objsubid,</span><br><span class="line">a.pid,a.virtualtransaction,a.virtualxid,a,transactionid,b.query,b.xact_start,b.query_start,</span><br><span class="line">b.usename,b.datname <span class="keyword">from</span> pg_locks a,pg_stat_activity b <span class="keyword">where</span> a.pid<span class="operator">=</span>b.pid <span class="keyword">and</span> <span class="keyword">not</span> a.granted),</span><br><span class="line">t_run <span class="keyword">as</span> </span><br><span class="line">(<span class="keyword">select</span> a.mode,a.locktype,a.database,a.relation,a.page,a.tuple,a.classid,a.objid,a.objsubid,</span><br><span class="line">a.pid,a.virtualtransaction,a.virtualxid,a,transactionid,b.query,b.xact_start,b.query_start,</span><br><span class="line">b.usename,b.datname <span class="keyword">from</span> pg_locks a,pg_stat_activity b <span class="keyword">where</span> a.pid<span class="operator">=</span>b.pid <span class="keyword">and</span> a.granted) </span><br><span class="line"><span class="keyword">select</span> r.locktype,r.mode r_mode,r.usename r_user,r.datname r_db,r.relation::regclass,r.pid r_pid,</span><br><span class="line">r.page r_page,r.tuple r_tuple,r.xact_start r_xact_start,r.query_start r_query_start,</span><br><span class="line">now()<span class="operator">-</span>r.query_start r_locktime,r.query r_query,w.mode w_mode,w.pid w_pid,w.page w_page,</span><br><span class="line">w.tuple w_tuple,w.xact_start w_xact_start,w.query_start w_query_start,</span><br><span class="line">now()<span class="operator">-</span>w.query_start w_locktime,w.query w_query  </span><br><span class="line"><span class="keyword">from</span> t_wait w,t_run r <span class="keyword">where</span></span><br><span class="line">r.locktype <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">distinct</span> <span class="keyword">from</span> w.locktype <span class="keyword">and</span></span><br><span class="line">r.database <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">distinct</span> <span class="keyword">from</span> w.database <span class="keyword">and</span></span><br><span class="line">r.relation <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">distinct</span> <span class="keyword">from</span> w.relation <span class="keyword">and</span></span><br><span class="line">r.page <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">distinct</span> <span class="keyword">from</span> w.page <span class="keyword">and</span></span><br><span class="line">r.tuple <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">distinct</span> <span class="keyword">from</span> w.tuple <span class="keyword">and</span></span><br><span class="line">r.classid <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">distinct</span> <span class="keyword">from</span> w.classid <span class="keyword">and</span></span><br><span class="line">r.objid <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">distinct</span> <span class="keyword">from</span> w.objid <span class="keyword">and</span></span><br><span class="line">r.objsubid <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">distinct</span> <span class="keyword">from</span> w.objsubid <span class="keyword">and</span></span><br><span class="line">r.transactionid <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">distinct</span> <span class="keyword">from</span> w.transactionid <span class="keyword">and</span></span><br><span class="line">r.pid <span class="operator">&lt;&gt;</span> w.pid</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> f_lock_level(w.mode)<span class="operator">+</span>f_lock_level(r.mode) <span class="keyword">desc</span>,r.xact_start;</span><br></pre></td></tr></table></figure></div><p>现在可以排在前面的就是锁级别高的等待，优先干掉这个。</p><p>-[ RECORD 1 ]-+----------------------------------------------------------</p><p>locktype | relation -- 冲突类型</p><p>r_mode | ShareUpdateExclusiveLock -- 持锁模式</p><p>r_user | postgres -- 持锁用户</p><p>r_db | postgres -- 持锁数据库</p><p>relation | tbl -- 持锁对象</p><p>r_pid | 25656 -- 持锁进程</p><p>r_xact_start | 2015-05-10 14:11:16.08318+08 -- 持锁事务开始时间</p><p>r_query_start | 2015-05-10 14:11:16.08318+08 -- 持锁SQL开始时间</p><p>r_locktime | 00:01:49.460779 -- 持锁时长</p><p>r_query | vacuum freeze tbl; -- 持锁SQL,注意不一定是这个SQL带来的锁,也有可能是这个事务在之前执行的SQL加的锁</p><p>w_mode | AccessExclusiveLock -- 等待锁模式</p><p>w_pid | 26731 -- 等待锁进程</p><p>w_xact_start | 2015-05-10 14:11:17.987362+08 -- 等待锁事务开始时间</p><p>w_query_start | 2015-05-10 14:11:17.987362+08 -- 等待锁SQL开始时间</p><p>w_locktime | 00:01:47.556597 -- 等待锁时长</p><p>w_query | truncate tbl; -- 等待锁SQL</p><p>-[ RECORD 2 ]-+----------------------------------------------------------</p><p>locktype | relation</p><p>r_mode | ShareUpdateExclusiveLock</p><p>r_user | postgres</p><p>r_db | postgres</p><p>relation | tbl</p><p>r_pid | 25656</p><p>r_xact_start | 2015-05-10 14:11:16.08318+08</p><p>r_query_start | 2015-05-10 14:11:16.08318+08</p><p>r_locktime | 00:01:49.460779</p><p>r_query | vacuum freeze tbl;</p><p>w_mode | RowExclusiveLock</p><p>w_pid | 25582</p><p>w_xact_start | 2015-05-10 14:11:22.845+08</p><p>w_query_start | 2015-05-10 14:11:22.845+08</p><p>w_locktime | 00:01:42.698959</p><p>w_query | insert into tbl(crt_time) select now() from generate_series(1,1000); -- 这个SQL其实等待的是truncate tbl的锁;</p><p>......</p></blockquote><h5 id="统计数据库表以及索引存储空间">统计数据库表以及索引存储空间</h5><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SQL"><div class="code-copy"></div><figure class="highlight hljs sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 按从大到小排序输出数据库每个索引大小</span></span><br><span class="line"><span class="keyword">select</span> indexrelname, pg_size_pretty(pg_relation_size(indexrelid)) <span class="keyword">as</span> size <span class="keyword">from</span> pg_stat_user_indexes <span class="keyword">where</span> schemaname<span class="operator">=</span><span class="string">&#x27;public&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> pg_relation_size(<span class="string">&#x27;public&#x27;</span><span class="operator">||</span><span class="string">&#x27;.&#x27;</span><span class="operator">||</span>indexrelname) <span class="keyword">desc</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- [PostgreSQL中查询 每个表的总大小、索引大小和数据大小，并按总大小降序排序](https://blog.csdn.net/sunny_day_day/article/details/131455635)</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    pg_size_pretty(pg_total_relation_size(c.oid)) <span class="keyword">AS</span> total_size,</span><br><span class="line">    pg_size_pretty(pg_indexes_size(c.oid)) <span class="keyword">AS</span> index_size,</span><br><span class="line">    pg_size_pretty(pg_total_relation_size(c.oid) <span class="operator">-</span> pg_indexes_size(c.oid)) <span class="keyword">AS</span> data_size,</span><br><span class="line">    nspname <span class="keyword">AS</span> schema_name,</span><br><span class="line">    relname <span class="keyword">AS</span> table_name</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    pg_class c</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span></span><br><span class="line">    pg_namespace n <span class="keyword">ON</span> n.oid <span class="operator">=</span> c.relnamespace</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    relkind <span class="operator">=</span> <span class="string">&#x27;r&#x27;</span></span><br><span class="line">    <span class="keyword">AND</span> nspname <span class="keyword">NOT</span> <span class="keyword">LIKE</span> <span class="string">&#x27;pg_%&#x27;</span></span><br><span class="line">    <span class="keyword">AND</span> nspname <span class="operator">!=</span> <span class="string">&#x27;information_schema&#x27;</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    pg_total_relation_size(c.oid) <span class="keyword">DESC</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><h5 id="常用sql语句">常用sql语句</h5><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SQL"><div class="code-copy"></div><figure class="highlight hljs sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查找超过1小时的长事务</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> pg_stat_activity <span class="keyword">where</span> state <span class="operator">&lt;&gt;</span> <span class="string">&#x27;idle&#x27;</span> <span class="keyword">and</span> (backend_xid <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">or</span> backend_xmin <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span>) <span class="keyword">and</span> now()<span class="operator">-</span>xact_start <span class="operator">&gt;</span> <span class="type">interval</span> <span class="string">&#x27;3600 sec&#x27;</span>::<span class="type">interval</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看处于等待锁状态</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> pg_locks <span class="keyword">where</span> <span class="keyword">not</span> granted;</span><br><span class="line"><span class="comment">-- 查看等待锁的关系（表，索引，序列等）</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> pg_class <span class="keyword">where</span> oid<span class="operator">=</span>[上面查出来的relation];</span><br><span class="line"><span class="comment">-- 查看等待锁的数据库</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> pg_database <span class="keyword">where</span> oid<span class="operator">=</span>[上面查出来的database];</span><br><span class="line"><span class="comment">-- 锁表状态</span></span><br><span class="line"><span class="keyword">select</span> oid <span class="keyword">from</span> pg_class <span class="keyword">where</span> relname<span class="operator">=</span><span class="string">&#x27;可能锁表了的表&#x27;</span>;</span><br><span class="line"><span class="comment">-- 查询出结果则被锁</span></span><br><span class="line"><span class="keyword">select</span> pid <span class="keyword">from</span> pg_locks <span class="keyword">where</span> relation<span class="operator">=</span><span class="string">&#x27;上面查出的oid&#x27;</span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">-- 关闭事务并回滚</span></span><br><span class="line"><span class="keyword">select</span> pg_cancel_backend(pid);</span><br><span class="line"><span class="comment">-- 若无法关闭，则强制杀死进程连接</span></span><br><span class="line"><span class="keyword">select</span> pg_terminate_backend(pid);</span><br><span class="line">  </span><br><span class="line"><span class="comment">-- 查看连接信息，重点关注state处于idle in transaction</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> pg_stat_activity;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 替换数据库名称</span></span><br><span class="line">update pg_database <span class="keyword">set</span> datname <span class="operator">=</span> <span class="string">&#x27;destniationDb&#x27;</span> <span class="keyword">where</span> datname <span class="operator">=</span> <span class="string">&#x27;sourceDb&#x27;</span>;</span><br><span class="line"><span class="comment">-- 清除数据库所有连接</span></span><br><span class="line"><span class="keyword">SELECT</span> pg_terminate_backend(pg_stat_activity.pid) <span class="keyword">FROM</span> pg_stat_activity <span class="keyword">WHERE</span> datname<span class="operator">=</span><span class="string">&#x27;test_db&#x27;</span> <span class="keyword">AND</span> pid<span class="operator">&lt;&gt;</span>pg_backend_pid();</span><br><span class="line"><span class="comment">-- 复制数据库，需断开sourceDb的全部连接</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE destniationDb TEMPLATE sourceDb OWNER test_user; </span><br><span class="line"></span><br><span class="line"><span class="comment">-- 清空表并重置自增序列</span></span><br><span class="line"><span class="keyword">truncate</span> <span class="keyword">table</span> table1,table2 RESTART <span class="keyword">IDENTITY</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 导出数据库中数据，HEADER 可不带</span></span><br><span class="line">\<span class="keyword">COPY</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> table1) <span class="keyword">TO</span> <span class="string">&#x27;/tmp/sql_output.csv&#x27;</span> <span class="keyword">WITH</span> CSV HEADER;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 输出删除全部表的sql</span></span><br><span class="line">\<span class="keyword">COPY</span> (<span class="keyword">SELECT</span> <span class="string">&#x27;DROP TABLE IF EXISTS &quot;&#x27;</span> <span class="operator">||</span> tablename <span class="operator">||</span> <span class="string">&#x27;&quot; CASCADE;&#x27;</span> <span class="keyword">from</span> pg_tables <span class="keyword">WHERE</span> schemaname <span class="operator">=</span> <span class="string">&#x27;public&#x27;</span>) <span class="keyword">TO</span> <span class="string">&#x27;/tmp/sql_output.sql&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 添加部分索引（满足条件才建立索引）, where 和 select 语句的一致</span></span><br><span class="line"><span class="keyword">create</span> index [XXX] <span class="keyword">where</span> [XXX]</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看当前连接事务执行超时时间</span></span><br><span class="line"><span class="keyword">show</span> statement_timeout;</span><br><span class="line"><span class="comment">-- 设置数据库事务执行超时时间为 60 秒</span></span><br><span class="line"><span class="keyword">AlTER</span> DATABASE mydatabse <span class="keyword">SET</span> statement_timeout<span class="operator">=</span><span class="string">&#x27;60s&#x27;</span>;</span><br><span class="line"><span class="comment">-- 设置用户事务执行超时时间为 5 分钟</span></span><br><span class="line"><span class="keyword">ALTER</span> ROLE guest <span class="keyword">SET</span> statement_timeout<span class="operator">=</span><span class="string">&#x27;5min&#x27;</span>;</span><br></pre></td></tr></table></figure></div><h5 id="子查询优化">子查询优化</h5><p>PG 的子查询实际有两种，分为子连接（Sublink）和子查询（SubQuery），按子句的位置不同，出现在 from 关键字后的是子查询，出现在 where/on 等约束条件中或投影中的子句是子连接。</p><p>子查询：<code>select a.* from table_a a, （select a_id from table_b where id=1) b where b.a_id = a.id;</code></p><p>子连接：<code>select * from table_a where id in（select a_id from table_b where id=1);</code></p><p>在简单的子连接查询下，PG 数据库查询优化器一般会将其转化为内连接的方式：<code>select a.* from table_a a, table_b b where a.id=b.a_id and b.id=1;</code>，正常索引没问题情况下这两种方式都能得一样的结果，最终执行的都是索引内连接结果。但在某些情况下，PG 查询优化器在子连接的 SQL 下，子连接的查询会走索引，而主查询会顺序扫描（Seq Scan），原因是当 table_a 的数据量很大时，索引值又有很多重复的，同时查询优化器也不知道子连接返回的具体数据，这时查询优化器可能会认为顺序扫描更快，从而不走索引，导致耗时增加，所以为减少查询优化器的不确定性，最好是直接使用内连接的方式代替 in 语句。 <em>当然，对于特别复杂的查询业务，还是开启事务，分多次查询，在代码层做一些业务逻辑处理更合适，别让数据库把事情全做了，这也能减轻数据库的压力</em>。 PG 查询计划执行路径可以看看： <a target="_blank" rel="noopener" href="http://www.postgres.cn/news/viewone/1/156">PostgreSQL 查询语句优化</a>，<a target="_blank" rel="noopener" href="https://www.jb51.net/article/203010.htm">postgresql通过索引优化查询速度操作</a></p><h5 id="tricks">tricks</h5><ul><li>由于 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/309786/how-do-i-force-postgres-to-use-a-particular-index">pg 无法强制使用索引</a>，所以只能通过一些其他方法来引导查询优化器使用索引，比如调整查询条件；</li><li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/3800551/select-first-row-in-each-group-by-group">获取分组中最大值对应的一行数据</a>；</li></ul><hr><p>权限配置，<a target="_blank" rel="noopener" href="https://blog.csdn.net/zou8944/article/details/121528128">PostgreSQL权限管理详解</a>：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SQL"><div class="code-copy"></div><figure class="highlight hljs sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建只读组</span></span><br><span class="line"><span class="keyword">create</span> role readonly_group;</span><br><span class="line"><span class="comment">-- 创建只读用户继承只读组</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> reader <span class="keyword">with</span> password <span class="string">&#x27;reader&#x27;</span> <span class="keyword">in</span> role readonly_group;</span><br><span class="line"><span class="comment">-- 删除用户</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">user</span> reader;</span><br><span class="line"><span class="comment">-- 将只读组权限赋给只读用户</span></span><br><span class="line"><span class="keyword">grant</span> readonly_group <span class="keyword">to</span> reader;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 读权限</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span> <span class="keyword">ON</span> <span class="keyword">ALL</span> TABLES <span class="keyword">IN</span> SCHEMA public <span class="keyword">TO</span> readonly_group;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span> <span class="keyword">ON</span> <span class="keyword">ALL</span> SEQUENCES <span class="keyword">IN</span> SCHEMA public <span class="keyword">TO</span> readonly_group;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">EXECUTE</span> <span class="keyword">ON</span> <span class="keyword">ALL</span> FUNCTIONS <span class="keyword">IN</span> SCHEMA public <span class="keyword">TO</span> readonly_group;</span><br><span class="line"><span class="comment">-- 写权限</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">INSERT</span>, UPDATE, <span class="keyword">DELETE</span> <span class="keyword">ON</span> <span class="keyword">ALL</span> TABLES <span class="keyword">IN</span> SCHEMA public <span class="keyword">TO</span> write_group;</span><br><span class="line"><span class="keyword">GRANT</span> USAGE <span class="keyword">ON</span> <span class="keyword">ALL</span> SEQUENCES <span class="keyword">IN</span> SCHEMA public <span class="keyword">TO</span> write_group;</span><br></pre></td></tr></table></figure></div><hr><h4 id="主从备份">主从&amp;备份</h4><p>参考资料：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/478d07af204d">postgresql流式复制(Streaming Replication)</a>、<a target="_blank" rel="noopener" href="https://www.cnblogs.com/abclife/p/16391659.html">【PostgreSQL】PostgreSQL复制的监控</a>、<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_41093846/article/details/132429564">【PostgreSQL】导出数据库表(或序列)的结构和数据</a>、<a target="_blank" rel="noopener" href="http://www.postgres.cn/docs/13/app-pg-ctl.html">pg_ctl</a>、<a target="_blank" rel="noopener" href="http://www.postgres.cn/docs/13/app-pgbasebackup.html">pg_basebackup</a></p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SQL"><div class="code-copy"></div><figure class="highlight hljs sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建流复制备份用户（主从）</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> replicator replication login encrypted password <span class="string">&#x27;replicator&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在主库创建一个物理复制槽（PG9.4引入，一个从库一个复制槽）</span></span><br><span class="line"><span class="keyword">select</span> pg_create_physical_replication_slot(<span class="string">&#x27;phy_repl_slot_1&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看复制槽状态</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> pg_replication_slots;</span><br></pre></td></tr></table></figure></div><p>相关命令：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 冷备数据库(结合刷库命令可恢复数据库)，加 -s 参数只导出数据库表结构</span></span><br><span class="line">nohup pg_dump postgresql://user:password@host:port/dbname -f db_dump.20240107.sql &gt; dump.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建一个数据库</span></span><br><span class="line">pg_ctl init -D /home/postgres/db_data_dir</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改配置后重新加载配置</span></span><br><span class="line">pg_ctl reload -D /home/postgres/db_data_dir</span><br><span class="line"><span class="comment"># 或者重启数据库</span></span><br><span class="line">pg_ctl restart -D /home/postgres/db_data_dir</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置数据库默认连接密码</span></span><br><span class="line"><span class="built_in">export</span> PGPASSWORD=test_pswd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 完整复制数据库（作为从库）</span></span><br><span class="line">nohup pg_basebackup -h localhost -p port -U replicator -D /home/postgres/db_data1_dir -v -P -R -Xs &gt; ./backup.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从库提升为主库</span></span><br><span class="line">pg_ctl promote -D /home/postgres/db_data_dir</span><br></pre></td></tr></table></figure></div><p>设置主库：postgresql.conf</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">wal_level = hot_standby</span><br><span class="line"># 主备机不同步时，re_wind恢复结点</span><br><span class="line">wal_log_hints = on</span><br><span class="line"># 设置最大流复制数（从库数）</span><br><span class="line">max_wal_senders = 3</span><br><span class="line">wal_keep_segments = 64</span><br><span class="line"># 支持从库读，以及从库再拉从库</span><br><span class="line">hot_standby = on</span><br></pre></td></tr></table></figure></div><p>设置主库：pg_hba.conf</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># Allow replication connections from localhost, by a user with the</span><br><span class="line"># replication privilege.</span><br><span class="line">local   replication     all                                     trust</span><br><span class="line">host    replication     all             127.0.0.1/32            trust</span><br><span class="line">host    replication     all             ::1/128                 trust</span><br><span class="line">host    replication     all             0.0.0.0/0             md5</span><br></pre></td></tr></table></figure></div><p>设置从库 recovery.conf（自 Postgresql 12 起，recovery.conf 并入 postgresql.conf）：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">standby_mode          = &#x27;on&#x27;</span><br><span class="line">primary_conninfo      = &#x27;host=db_addr port=db_port user=replicator password=&lt;password&gt;&#x27;</span><br><span class="line">primary_slot_name     = &#x27;phy_repl_slot_1&#x27;</span><br></pre></td></tr></table></figure></div><h4 id="并发-dumprestore-数据库">并发 dump&amp;restore 数据库</h4><ol type="1"><li><p>导出数据库全部表结构</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pg_dump -d postgresql://user:pswd@host:port/db_name --schema-only -f db_name_schema.sql</span><br></pre></td></tr></table></figure></div></li><li><p>导出外键约束</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">psql -d postgresql://owner_user:pswd@host:port/db_name -t -A -F&quot;,&quot; -c &quot;</span><br><span class="line">SELECT DISTINCT</span><br><span class="line">    &#x27;ALTER TABLE &#x27; || quote_ident(nsp.nspname) || &#x27;.&#x27; || quote_ident(cls.relname) || </span><br><span class="line">    &#x27; ADD CONSTRAINT &#x27; || quote_ident(con.conname) || </span><br><span class="line">    &#x27; FOREIGN KEY (&#x27; || array_to_string(ARRAY(</span><br><span class="line">        SELECT quote_ident(att.attname)</span><br><span class="line">        FROM pg_attribute att</span><br><span class="line">        WHERE att.attnum = ANY(con.conkey)</span><br><span class="line">          AND att.attrelid = cls.oid), &#x27;, &#x27;) || </span><br><span class="line">    &#x27;) REFERENCES &#x27; || quote_ident(f_nsp.nspname) || &#x27;.&#x27; || quote_ident(f_cls.relname) || </span><br><span class="line">    &#x27; (&#x27; || array_to_string(ARRAY(</span><br><span class="line">        SELECT quote_ident(att.attname)</span><br><span class="line">        FROM pg_attribute att</span><br><span class="line">        WHERE att.attnum = ANY(con.confkey)</span><br><span class="line">          AND att.attrelid = f_cls.oid), &#x27;, &#x27;) || </span><br><span class="line">    &#x27;) ON DELETE &#x27; || CASE con.confdeltype</span><br><span class="line">                        WHEN &#x27;a&#x27; THEN &#x27;NO ACTION&#x27;</span><br><span class="line">                        WHEN &#x27;r&#x27; THEN &#x27;RESTRICT&#x27;</span><br><span class="line">                        WHEN &#x27;c&#x27; THEN &#x27;CASCADE&#x27;</span><br><span class="line">                        WHEN &#x27;n&#x27; THEN &#x27;SET NULL&#x27;</span><br><span class="line">                        WHEN &#x27;d&#x27; THEN &#x27;SET DEFAULT&#x27;</span><br><span class="line">                      END ||</span><br><span class="line">    &#x27; ON UPDATE &#x27; || CASE con.confupdtype</span><br><span class="line">                        WHEN &#x27;a&#x27; THEN &#x27;NO ACTION&#x27;</span><br><span class="line">                        WHEN &#x27;r&#x27; THEN &#x27;RESTRICT&#x27;</span><br><span class="line">                        WHEN &#x27;c&#x27; THEN &#x27;CASCADE&#x27;</span><br><span class="line">                        WHEN &#x27;n&#x27; THEN &#x27;SET NULL&#x27;</span><br><span class="line">                        WHEN &#x27;d&#x27; THEN &#x27;SET DEFAULT&#x27;</span><br><span class="line">                      END || &#x27;;&#x27;</span><br><span class="line">FROM pg_constraint con</span><br><span class="line">JOIN pg_class cls ON con.conrelid = cls.oid</span><br><span class="line">JOIN pg_namespace nsp ON cls.relnamespace = nsp.oid</span><br><span class="line">JOIN pg_class f_cls ON con.confrelid = f_cls.oid</span><br><span class="line">JOIN pg_namespace f_nsp ON f_cls.relnamespace = f_nsp.oid</span><br><span class="line">WHERE con.contype = &#x27;f&#x27;;&quot; &gt; db_name_fkeys.sql</span><br></pre></td></tr></table></figure></div></li><li><p>导出数据库全局用户/权限</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pg_dumpall -d postgresql://superuser:pswd@host:port --globals-only -f db_name_user.sql</span><br></pre></td></tr></table></figure></div></li><li><p>4个并行任务导出全部数据</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pg_dump -d postgresql://user:pswd@host:port/db_name --data-only -F d -j 4 -f ./db_name_data_dir</span><br></pre></td></tr></table></figure></div></li><li><p>新建数据库实例</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pg_ctl init -D ~/new_db_data</span><br></pre></td></tr></table></figure></div></li><li><p>导入数据库全局用户/权限</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U superuser -p port -f db_name_user.sql</span><br></pre></td></tr></table></figure></div></li><li><p>新建数据库</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SQL"><div class="code-copy"></div><figure class="highlight hljs sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> database new_db_name owner owner_user</span><br></pre></td></tr></table></figure></div></li><li><p>导入数据库全部表结构</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U superuser -p port -f db_name_schema.sql</span><br></pre></td></tr></table></figure></div></li><li><p>移除新库外键约束</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">psql -d postgresql://owner_user:pswd@host:port/db_name &lt;&lt;EOF</span><br><span class="line">DO \$\$ </span><br><span class="line">DECLARE</span><br><span class="line">    r RECORD;</span><br><span class="line">BEGIN</span><br><span class="line">    FOR r IN (SELECT conname, conrelid::regclass</span><br><span class="line">              FROM pg_constraint</span><br><span class="line">              WHERE contype = &#x27;f&#x27;) LOOP</span><br><span class="line">        EXECUTE &#x27;ALTER TABLE &#x27; || r.conrelid || &#x27; DROP CONSTRAINT &#x27; || r.conname;</span><br><span class="line">    END LOOP;</span><br><span class="line">END \$\$;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></div></li><li><p>4个并行任务导入数据</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pg_restore -d postgresql://owner_user:pswd@host:port/db_name -j 4 ./db_name_data_dir</span><br></pre></td></tr></table></figure></div></li><li><p>恢复新库外键约束</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -d postgresql://owner_user:pswd@host:port/db_name -f db_name_fkeys.sql</span><br></pre></td></tr></table></figure></div></li></ol><hr><h4 id="mvcc数据碎片索引膨胀freeze">MVCC/数据碎片/索引膨胀/FREEZE</h4><p>参考自：<a target="_blank" rel="noopener" href="https://www.modb.pro/db/48183">PostgreSQL | 空间又告警了，先从整理索引碎片开始</a>，<a target="_blank" rel="noopener" href="https://blog.csdn.net/wonder191/article/details/131787424">正确的评估postgres index膨胀</a>，<a target="_blank" rel="noopener" href="https://www.cnblogs.com/dbadaily/p/vacuum1.html">PostgreSQL VACUUM 之深入浅出 (一)</a>，<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_44866828/article/details/132031913">深入理解 PostgreSQL 中的 MVCC（多版本并发控制）机制</a>，<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1555360">硬核-深度剖析PostgreSQL数据库“冻结炸弹”原理机制</a></p><p>简单总结一下：</p><ul><li>mvcc 主要通过锁或乐观并发控制机制来解决冲突，通过事务号实现多版本及查询可见性（当前事务只能看到当前事务启动前已提交的数据，即只可能大事务号看到小事务号的数据），当事务号达到设定值时，事务号会发生回卷，此时需要以单用户模式执行 vacuum freeze 操作，将所有事务号置为2，代表冻结事务，对所有事务可见，当然可通过设置参数实现自动 freeze，减少人工介入维护时间；</li><li>由于 postgres 的 mvcc 机制，更新和删除以及新增的回滚都会造成数据碎片，虽然有 vacuum，但索引的膨胀不可避免，所以当发现索引碎片率超过 30% 时，需要进行重建索引 REINDEX，但常规的 REINDEX 会锁表，在 pg12 之后才有 REINDEX CONCURRENTLY，可在线重建，不会锁表，重建完之后需要执行 ANALYZE 更新一下统计信息使索引立即生效。</li></ul><h4 id="空间清理">空间清理</h4><p>　　<a target="_blank" rel="noopener" href="http://www.postgres.cn/docs/14/routine-vacuuming.html">由于标准的 vacuum 无法释放空间归还给操作系统</a>，只是在数据库内部清理/释放/使用（<em>所以 vacuum 只对于未造成空间膨胀的数据库有效，而且当存在大量更新/删除操作时，vacuum 也不一定能及时控制数据库大小，导致数据库空间一步步变大</em>）。而 VACUUM FULL 或者 CLUSTER 在清理磁盘时会进行锁表（SELECT、INSERT、UPDATE 和 DELETE 等操作都无法正常进行，基本可认为是需要停机维护），对于已经占用大量存储空间的数据库，可以使用 <a target="_blank" rel="noopener" href="https://github.com/reorg/pg_repack">pg_repack</a> 进行在线清理/释放表空间，相比 CLUSTER 或 VACUUM FULL，<a target="_blank" rel="noopener" href="https://help.aliyun.com/zh/rds/apsaradb-rds-for-postgresql/use-the-pg-repack-extension-to-clear-tablespaces">pg_repack 无需获取排它锁</a>，更轻量。</p><p>　　对于既成事实占用存储空间超大的数据库，缩减空间一个可能的方案是先 dump 数据，同时开始记录原数据库增量的 dml sql（log_statement=mod），新建一个数据库，用 dump sql 文件写入，记录 dump 最新的节点（时间或者啥 id，再将原数据库节点之外的数据迁移到新数据库中（用之前记录的增量 dml sql，需过滤回滚的事务），再用新数据库替换原数据库，如此达到释放空间的目的（该方案同样适用于数据库版本升级）。</p><hr><p>常见问题：</p><ol type="1"><li><p>当自增主键报 <code>duplicate key value violates unique constraint</code> 主键冲突时，一般是因为存在手动分配 id 的数据（复制表或着手动插入分配了 id），自增主键 seqence TABLE_COLUMN_seq 没有更新，新插入一个值自增 id 和数据库已插入的分配 id 冲突，此时需要执行 <code>SELECT setval('TABLE_COLUMN_seq', (SELECT max(COLUMN) FROM "TABLE"))</code> 更新自增主键;</p></li><li><p>分析 sql 性能时，可在 sql 语句前增加 <code>EXPLAIN</code> 关键字，查看执行计划，EXPLAIN 一般不会实际执行 sql，但 sql 中带有子语句时，子语句可能会执行，所以为保险起见，最好是在事务中使用 EXPLAIN；eg:</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SQL"><div class="code-copy"></div><figure class="highlight hljs sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span>;</span><br><span class="line">EXPLAIN <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> table1 <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="keyword">rollback</span>;</span><br></pre></td></tr></table></figure></div><p>若要分析实际执行时间，可以使用 EXPLAIN ANALYZE，<em>该选项会实际执行 SQL</em>，也可以组合参数一起分析执行命令 <code>explain (analyze,verbose,costs,buffers,timing) select * from table1 where id=1;</code>。</p></li><li><p>如果业务数据无法直接使用批量写入数据库，就最好在一个事务中写入（当然也得看数据量），在同一个事务中写入，不仅能利用事务本身的 ACID 特性，而且比单独分次执行 sql 效率更高；</p></li><li><p>PG 数据库中，如果要使用 order 排序查询时，一般带主键的复合索引比单个字段索引更有效，因为 PG 数据在数据更新后，一般会乱序存储，导致单字段索引在查询时需要访问的页面会更多；</p></li><li><p>PG 刚创建/删除索引后，不一定会及时生效，需要数据库运行一段时间后才会开始生效，如需要立即生效，可执行 <code>ANALYZE VERBOSE table_name;</code>命令，离线或者低负载的时候可以执行 <code>VACUUM VERBOSE ANALYZE table_name</code>，清理表的同时更新统计信息，得到更好的 SQL 执行计划。</p></li></ol><h2 id="后记">后记</h2><p>　　后面持续更新。。。</p></div><div class="article-content-more"><button type="button" class="article-more--link"><i class="fa fa-angle-double-down fa-3x" aria-hidden="true"></i></button></div></section></article><article id="post-时空查询之ECQL" class="article div-border"><header class="article-header"><span class="article-date article-title--index"><i class="fa fa-calendar" aria-hidden="true"></i> <a href="/posts/489fa7b3.html"><time datetime="2021-01-23T12:59:21.000Z">2021-01-23</time></a></span><section class="article-title article-title--index"><a href="/posts/489fa7b3.html">时空查询之ECQL</a></section><div class="article-label"><div class="article-category label"><i class="fa fa-book" aria-hidden="true"></i> <a class="color5 article-category-link" href="/categories/Study/">Study</a></div><div class="article-tag label"><i class="fa fa-bookmark" aria-hidden="true"></i> <a class="color5 article-tag-none-link" href="/tags/language/" rel="tag">language</a></div></div></header><section class="article-content"><div class="article-content--excerpt"><h2 id="前言">前言</h2><p>　　ECQL 是 CQL 的扩展，CQL 是 OGC 标准查询语言，而 ECQL 是 GeoTools 为更好的方便查询，在编程实现时扩展了 CQL，主要扩展在于其移除了 CQL 的一些限制（属性必须在比较运算符的左边，不能创建 Id Filter 进行查询等限制），也和 SQL 更相似。所以可简单认为 CQL 是书面上的标准，而 ECQL 是事实上的标准。</p></div><div class="article-content--all"><h2 id="前言">前言</h2><p>　　ECQL 是 CQL 的扩展，CQL 是 OGC 标准查询语言，而 ECQL 是 GeoTools 为更好的方便查询，在编程实现时扩展了 CQL，主要扩展在于其移除了 CQL 的一些限制（属性必须在比较运算符的左边，不能创建 Id Filter 进行查询等限制），也和 SQL 更相似。所以可简单认为 CQL 是书面上的标准，而 ECQL 是事实上的标准。</p><span id="more"></span><h2 id="谓词篇">谓词篇</h2><p>时间查询主要有以下几个查询谓词：</p><table><colgroup><col style="width:36%"><col style="width:63%"></colgroup><thead><tr class="header"><th>谓词</th><th>作用</th></tr></thead><tbody><tr class="odd"><td>T <strong>TEQUALS</strong> Time</td><td>测试 T 和给定时间相等，相当于 T == Time。</td></tr><tr class="even"><td>T <strong>BEFORE</strong> Time</td><td>测试 T 在给定时间之前，相当于 T &lt; Time。</td></tr><tr class="odd"><td>T <strong>BEFORE OR DURING</strong> Time Period</td><td>测试 T 在给定时间段之前或其中，相当于 T &lt;= TimePeriod[1]。</td></tr><tr class="even"><td>T <strong>DURING</strong> Time Period</td><td>测试 T 在给定时间段其中，相当于 TimePeriod[0] &lt;= T &lt;= TimePeriod[1]。</td></tr><tr class="odd"><td>T <strong>DURING OR AFTER</strong> Time Period</td><td>测试 T 在给定时间段其中或之后，相当于 TimePeriod[0] &lt;= T。</td></tr><tr class="even"><td>T <strong>AFTER</strong> Time</td><td>测试 T 在给定时间之后，相当于 T &gt; Time。</td></tr></tbody></table><p>时间段以 <code>/</code> 分隔符区分前后两个时间，时间格式一般为 yyyy-MM-dd'T'HH:mm:ss.SSS'Z'。</p><p>空间查询主要有以下几个查询谓词：</p><table><colgroup><col style="width:50%"><col style="width:50%"></colgroup><thead><tr class="header"><th>谓词</th><th>作用</th></tr></thead><tbody><tr class="odd"><td><strong>INTERSECTS</strong>(A: Geometry, B: Geometry)</td><td>测试 A 与 B 相交，与 DISJOINT 相反。</td></tr><tr class="even"><td><strong>DISJOINT</strong>(A: Geometry, B: Geometry)</td><td>测试 A 与 B 不相交，与 INTERSECTS 相反。</td></tr><tr class="odd"><td><strong>CONTAINS</strong>(A: Geometry, B: Geometry)</td><td>测试 A 包含 B，与 WITHIN 相反。</td></tr><tr class="even"><td><strong>WITHIN</strong>(A: Geometry, B: Geometry)</td><td>测试 B 包含 A，即 A 在 B 中，与 CONTAINS 相反。</td></tr><tr class="odd"><td><strong>TOUCHES</strong>(A: Geometry, B: Geometry)</td><td>测试 A 的边界是否与 B 的边界接触，但内部不相交。</td></tr><tr class="even"><td><strong>CROSSES</strong>(A: Geometry, B: Geometry)</td><td>测试 A 与 B 是否相交，但不存在包含关系。</td></tr><tr class="odd"><td><strong>OVERLAPS</strong>(A: Geometry, B: Geometry)</td><td>测试 A 与 B 是否重叠，需满足 A 与 B 是同一类型（如都是 POLYGON），并且相交区域同样是 A 和 B 的类型（只能是 POLYGON，不能是 POINT）。</td></tr><tr class="even"><td><strong>EQUALS</strong>(A: Geometry, B: Geometry)</td><td>测试 A 与 B 完全相等。</td></tr><tr class="odd"><td><strong>RELATE</strong>(A: Geometry, B: Geometry, nineIntersectionModel: String)</td><td>测试 A 与 B 是否满足 <strong>DE-9IM</strong> 模型，该模型可模拟上述所有情况。</td></tr><tr class="even"><td><strong>DWITHIN</strong>(A: Geometry, B: Geometry, distance: double, units: String)</td><td>测试 A 与 B 的最短距离是否不超过多少距离，单位有（<code>feet</code>, <code>meters</code>, <code>statute miles</code>, <code>nautical miles</code>, <code>kilometers</code>）。</td></tr><tr class="odd"><td><strong>BEYOND</strong>(A: Geometry, B: Geometry, distance: Double, units: String)</td><td>测试 A 与 B 的最短距离是否超过多少距离。</td></tr><tr class="even"><td><strong>BBOX</strong>(A: Geometry, leftBottomLng: Double, leftBottomLat: Double, rightTopLng: Double, rightTopLat: Double, crs="EPSG:4326")</td><td>测试 A 是否与给定 box 相交。</td></tr></tbody></table><p>Geometry 是指 WKT 格式的数据，主要有以下几种：</p><table><colgroup><col style="width:26%"><col style="width:73%"></colgroup><thead><tr class="header"><th>类型</th><th>示例</th></tr></thead><tbody><tr class="odd"><td><strong>POINT</strong></td><td>POINT(6 10)</td></tr><tr class="even"><td><strong>LINESTRING</strong></td><td>LINESTRING(3 4,10 50,20 25)</td></tr><tr class="odd"><td><strong>POLYGON</strong></td><td>POLYGON((1 1,5 1,5 5,1 5,1 1),(2 2,2 3,3 3,3 2,2 2))</td></tr><tr class="even"><td><strong>MULTIPOINT</strong></td><td>MULTIPOINT(3.5 5.6, 4.8 10.5)</td></tr><tr class="odd"><td><strong>MULTILINESTRING</strong></td><td>MULTILINESTRING((3 4,10 50,20 25),(-5 -8,-10 -8,-15 -4))</td></tr><tr class="even"><td><strong>MULTIPOLYGON</strong></td><td>MULTIPOLYGON(((1 1,5 1,5 5,1 5,1 1),(2 2,2 3,3 3,3 2,2 2)),((6 3,9 2,9 4,6 3)))</td></tr><tr class="odd"><td><strong>GEOMETRYCOLLECTION</strong></td><td>GEOMETRYCOLLECTION(POINT(4 6),LINESTRING(4 6,7 10))</td></tr></tbody></table><p><strong><em>※注：</em></strong> POLYGON 中的边界点必须闭合，即首尾点相同，若存在多个边界，则需要遵循 逆时针,顺时针,逆时针,顺时针... 的点排列顺序，逆时针封闭，顺时针开孔，以形成具有岛和洞的复杂多边形。</p><p>　　由于 WKT 标准只支持二维的坐标，为支持三维坐标以及齐次线性计算，所以在 PostGIS 中又有 EWKT 标准实现，EWKT 扩展了 WKT，带 <code>Z</code> 结尾用来支持三维坐标，带 <code>M</code> 结尾用来支持齐次线性计算，如 <code>POINTZ(6 10 3)</code>，<code>POINTM(6 10 1)</code>，<code>POINTZM(6 10 3 1)</code>，同时还支持坐标内嵌空间参考系，如 <code>SRID=4326;LINESTRING(-134.921387 58.687767, -135.303391 59.092838)</code>。GeoTools 19.0 之后也默认以 EWKT 进行解析和编码。</p><h2 id="查询篇">查询篇</h2><h3 id="属性字段查询">属性字段查询</h3><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">// 查询属性 ATTR1 小于 7 的数据</span><br><span class="line">Filter filter = ECQL.toFilter(&quot;ATTR1 &lt; (1 + ((3 / 2) * 4))&quot; );</span><br><span class="line"></span><br><span class="line">// 查询属性 ATTR1 小于属性 ATTR2 绝对值的数据</span><br><span class="line">Filter filter = ECQL.toFilter(&quot;ATTR1 &lt; abs(ATTR2)&quot; );</span><br><span class="line"></span><br><span class="line">// 查询属性 ATTR1 为 test 字符串的数据</span><br><span class="line">Filter filter = ECQL.toFilter(&quot;ATTR1 == &#x27;test&#x27;&quot; );</span><br><span class="line"></span><br><span class="line">// 查询属性 ATTR1 在 10 和 20 之间的数据</span><br><span class="line">Filter filter = ECQL.toFilter( &quot;ATTR1 BETWEEN 10 AND 20&quot; );</span><br><span class="line">Filter filter = ECQL.toFilter( &quot;ATTR1 &gt;= 10 AND ATTR1 &lt;= 20&quot; );</span><br><span class="line"></span><br><span class="line">// 多条件查询</span><br><span class="line">Filter filter = ECQL.toFilter(&quot;ATTR1 &lt; 10 AND ATTR2 &lt; 2 OR ATTR3 &gt; 10&quot; );</span><br><span class="line"></span><br><span class="line">// 查询属性 ATTR1 为 silver 或 oil 或 gold 的数据</span><br><span class="line">Filter filter = ECQL.toFilter(&quot;ATTR1 IN (&#x27;silver&#x27;,&#x27;oil&#x27;, &#x27;gold&#x27; )&quot;);</span><br><span class="line"></span><br><span class="line">// 以 ID 主键进行查询</span><br><span class="line">Filter filter = ECQL.toFilter(&quot;IN (&#x27;river.1&#x27;, &#x27;river.2&#x27;)&quot;);</span><br><span class="line">Filter filter = ECQL.toFilter(&quot;IN (300, 301)&quot;);</span><br></pre></td></tr></table></figure></div><h3 id="模糊查询">模糊查询</h3><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// 查询属性 ATTR1 包含 abc 字符串的数据</span><br><span class="line">Filter filter = ECQL.toFilter( &quot;ATTR1 LIKE &#x27;%abc%&#x27;&quot; );</span><br><span class="line"></span><br><span class="line">// 查询属性 ATTR1 开头不为 abc 字符串的数据</span><br><span class="line">Filter filter = ECQL.toFilter( &quot;ATTR1 NOT LIKE &#x27;abc%&#x27;&quot; );</span><br><span class="line"></span><br><span class="line">// 查询属性 cityName 开头为 new 的数据，忽略 new 的大小写</span><br><span class="line">Filter filter = ECQL.toFilter(&quot;cityName ILIKE &#x27;new%&#x27;&quot;);</span><br><span class="line"></span><br><span class="line">// 测试字符串是否包含</span><br><span class="line">Filter filter = ECQL.toFilter(&quot;&#x27;aabbcc&#x27; LIKE &#x27;%bb%&#x27;&quot;);</span><br></pre></td></tr></table></figure></div><h3 id="空属性查询">空属性查询</h3><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 查询有属性 ATTR1 存在的数据</span><br><span class="line">Filter filter = ECQL.toFilter( &quot;ATTR1 EXISTS&quot; );</span><br><span class="line"></span><br><span class="line">// 查询属性 ATTR1 不存在的数据</span><br><span class="line">Filter filter = ECQL.toFilter( &quot;ATTR1 DOES-NOT-EXIST&quot; );</span><br><span class="line"></span><br><span class="line">// 查询 Name 为 NULL 的数据</span><br><span class="line">Filter filter = ECQL.toFilter(&quot;Name IS NULL&quot;);</span><br></pre></td></tr></table></figure></div><h3 id="时间查询">时间查询</h3><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// 查询时间属性 dtg 等于的数据</span><br><span class="line">Filter filter = ECQL.toFilter( &quot;dtg TEQUALS 2006-11-30T01:30:00Z&quot; );</span><br><span class="line"></span><br><span class="line">// 查询时间属性 dtg 在之后的数据</span><br><span class="line">Filter filter = ECQL.toFilter(&quot;dtg AFTER 2006-11-30T01:30:00Z&quot;);</span><br><span class="line"></span><br><span class="line">// 查询时间属性 dtg 在之前的数据</span><br><span class="line">Filter filter = ECQL.toFilter(&quot;dtg BEFORE 2006-11-30T01:30:00Z&quot;);</span><br><span class="line"></span><br><span class="line">// 查询时间属性 dtg 在之间的数据，+3:00 代表 GMT 时间 +3 小时，以 Z 结尾的时间就是 GMT 时间</span><br><span class="line">Filter filter = ECQL.toFilter( &quot;dtg DURING 2006-11-30T00:30:00+03:00/2006-11-30T01:30:00+03:00 &quot;);</span><br><span class="line"></span><br><span class="line">// 查询时间属性 dtg 等于的数据</span><br><span class="line">Filter filter = ECQL.toFilter(&quot;dtg = 1981-06-20&quot;);</span><br><span class="line"></span><br><span class="line">// 查询时间属性 dtg 小于等于的数据</span><br><span class="line">Filter filter = ECQL.toFilter(&quot;dtg &lt;= 1981-06-20T12:30:01Z&quot;);</span><br></pre></td></tr></table></figure></div><h3 id="空间查询">空间查询</h3><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// 查询空间属性 geom 包含点的数据</span><br><span class="line">Filter filter = ECQL.toFilter( &quot;CONTAINS(geom, POINT(1 2))&quot; );</span><br><span class="line"></span><br><span class="line">// 查询空间属性 geom 与 box 相交的数据</span><br><span class="line">Filter filter = ECQL.toFilter( &quot;BBOX(geom, 10,20,30,40)&quot; );</span><br><span class="line"></span><br><span class="line">// 查询空间属性 geom 与点最短距离不超过 10 千米的数据</span><br><span class="line">Filter filter = ECQL.toFilter( &quot;DWITHIN(geom, POINT(1 2), 10, kilometers)&quot; );</span><br><span class="line"></span><br><span class="line">// 查询空间属性 geom 与线相交的数据（geom 也必须是线）</span><br><span class="line">Filter filter = ECQL.toFilter( &quot;CROSS(geom, LINESTRING(1 2, 10 15))&quot; );</span><br><span class="line"></span><br><span class="line">// 查询空间属性 geom 与 GEOMETRYCOLLECTION 相交的数据（geom 也必须是 GEOMETRYCOLLECTION）</span><br><span class="line">Filter filter = ECQL.toFilter( &quot;INTERSECT(geom, GEOMETRYCOLLECTION (POINT (10 10),POINT (30 30),LINESTRING (15 15, 20 20)) )&quot; );</span><br><span class="line"></span><br><span class="line">// 查询空间属性 geom 与线相交的数据</span><br><span class="line">Filter filter = ECQL.toFilter( &quot;CROSSES(geom, LINESTRING(1 2, 10 15))&quot; );</span><br><span class="line"></span><br><span class="line">// 查询空间属性 geom 与 GEOMETRYCOLLECTION 相交的数据</span><br><span class="line">Filter filter = ECQL.toFilter( &quot;INTERSECTS(geom, GEOMETRYCOLLECTION (POINT (10 10),POINT (30 30),LINESTRING (15 15, 20 20)) )&quot; );</span><br><span class="line"></span><br><span class="line">// 查询空间属性 geom 与包含线的数据</span><br><span class="line">Filter filter = ECQL.toFilter(&quot;RELATE(geom, LINESTRING (-134.921387 58.687767, -135.303391 59.092838), T*****FF*)&quot;);</span><br></pre></td></tr></table></figure></div><hr><p>　　在 GeoTools 中，可通过 FilterFactory 来构造 Filter，而不是直接写字符串，具体示例如下：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="JAVA"><div class="code-copy"></div><figure class="highlight hljs java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">FilterFactory2 ff = CommonFactoryFinder.getFilterFactory2();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 相当于 Filter filter1 = ECQL.toFilter(&quot;ATTR1 = 1 AND ATTR2 &lt; 4&quot; );</span></span><br><span class="line">List&lt;Filter&gt; filterList = ECQL.toFilterList(<span class="string">&quot;ATTR1=1; ATTR2&lt;4&quot;</span>);</span><br><span class="line">Filter filter1 = ff.and(filterList);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 相当于 Filter filter2 = ECQL.toFilter( &quot;BBOX(geom, 10,20,30,40)&quot; );</span></span><br><span class="line">Filter filter2 = ff.bbox(<span class="string">&quot;geom&quot;</span>, <span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>, <span class="string">&quot;EPSG:4326&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 相当于 Filter filter3 = ECQL.toFilter( &quot;dtg DURING 2006-11-29T00:30:00Z/2006-11-30T00:30:00Z&quot;);</span></span><br><span class="line">Date startTime = ZonedDateTime.of(<span class="number">2006</span>, <span class="number">11</span>, <span class="number">29</span>, <span class="number">0</span>, <span class="number">30</span>, <span class="number">0</span>, <span class="number">0</span>, ZoneOffset.UTC);</span><br><span class="line">Date endTime = Date.from(startTime.plusDays(<span class="number">1</span>).toInstant());</span><br><span class="line">Filter filter3 = ff.between(ff.property(<span class="string">&quot;dtg&quot;</span>), ff.literal(startTime), ff.literal(endTime));</span><br></pre></td></tr></table></figure></div><h2 id="后记">后记</h2><p>　　基本可认为 CQL 和 SQL 中查询条件差不多，虽然不支持分组查询等复杂 SQL 特性，但对于一般的时空查询基本够用，CQL 中还有些空间操作函数就不继续写了，如取面积，取缓冲区，取交集，取长度等等，有需要的可自行查询 <a target="_blank" rel="noopener" href="http://udig.github.io/docs/user/concepts/Constraint%20Query%20Language.html">uDig Common Query Language</a>。</p><h2 id="参考资料">参考资料</h2><p><a target="_blank" rel="noopener" href="http://docs.geotools.org/latest/userguide/library/cql/cql.html">GeoTools CQL</a></p><p><a target="_blank" rel="noopener" href="http://docs.geotools.org/stable/userguide/library/cql/ecql.html">GeoTools ECQL</a></p><p><a target="_blank" rel="noopener" href="https://docs.geoserver.org/latest/en/user/filter/ecql_reference.html#ecql-reference">GeoServer ECQL Reference</a> / <a target="_blank" rel="noopener" href="https://blog.csdn.net/neimeng0/article/details/79914880">GeoServer 属性查询和空间查询支持 CQL / ECQL过滤器语言</a></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/ucs426/article/details/99780891">WKT解读</a></p><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/denny402/p/4968201.html">GEOS库学习之三：空间关系、DE-9IM和谓词</a></p></div><div class="article-content-more"><button type="button" class="article-more--link"><i class="fa fa-angle-double-down fa-3x" aria-hidden="true"></i></button></div></section></article><article id="post-GeoMesa踩坑指北" class="article div-border"><header class="article-header"><span class="article-date article-title--index"><i class="fa fa-calendar" aria-hidden="true"></i> <a href="/posts/9978824c.html"><time datetime="2021-01-16T09:52:09.000Z">2021-01-16</time></a></span><section class="article-title article-title--index"><a href="/posts/9978824c.html">GeoMesa踩坑指北</a></section><div class="article-label"><div class="article-category label"><i class="fa fa-book" aria-hidden="true"></i> <a class="color2 article-category-link" href="/categories/Study/">Study</a></div><div class="article-tag label"><i class="fa fa-bookmark" aria-hidden="true"></i> <a class="color1 article-tag-none-link" href="/tags/bigdata/" rel="tag">bigdata</a><a class="color1 article-tag-none-link" href="/tags/geomesa/" rel="tag">geomesa</a></div></div></header><section class="article-content"><div class="article-content--excerpt"><h2 id="前言">前言</h2><p>　　需要做个 GeoMesa 的微服务，简单熟悉一下 GeoMesa。</p></div><div class="article-content--all"><h2 id="前言">前言</h2><p>　　需要做个 GeoMesa 的微服务，简单熟悉一下 GeoMesa。</p><span id="more"></span><h2 id="基础篇">基础篇</h2><p>　　GeoMesa 可以说是大数据中的 PostGIS，主要用来在存储和处理 GIS 数据时提供相应的索引，从而加快处理速度。GeoMesa 基于 GeoTools，其中最重要的两个概念就是 SimpleFeatureType 和 SimpleFeature，SimpleFeatureType 对应的是关系型数据库中表的描述（表明，表的列字段属性信息等），而 SimpleFeature 对应的是表中每行数据。下面重点谈谈 GeoMesa 中的 SimpleFeatureType 以及其创建索引方式。</p><p>　　在 GeoMesa 中通常使用 SimpleFeatureTypes.createType 方法进行创建，该方法有两个重载，以没有 namespace 参数的方法为例：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">createType</span></span>(typeName: <span class="type">String</span>, spec: <span class="type">String</span>): <span class="type">SimpleFeatureType</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> (namespace, name) = parseTypeName(typeName)</span><br><span class="line">    createType(namespace, name, spec)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>先通过 parseTypeName 解析 typeName，以 <code>:</code> 作为分隔符，取最后一个有效（不为空）字符串作为表名（name），其余部分如有效则作为 namespace，否则 namespace 则为 null。spec 参数的通用形式有以下几种：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> spec = <span class="string">&quot;name:String,dtg:Date,*geom:Point:srid=4326&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> spec = <span class="string">&quot;name:String,dtg:Date,*geom:Point:srid=4326;geomesa.indices.enabled=&#x27;z2,id,z3&#x27;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> spec = <span class="string">&quot;name:String:index=true,tags:String:json=true,dtg:Date:default=true,*geom:Point:srid=4326;geomesa.indices.enabled=&#x27;z2,id,z3&#x27;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> spec = <span class="string">&quot;userId:String,trackId:String,altitude:Double,dtg:Date,*geom:Point:srid=4326;geomesa.index.dtg=&#x27;dtg&#x27;,geomesa.table.sharing=&#x27;true&#x27;,geomesa.indices=&#x27;z3:4:3,z2:3:3,id:2:3&#x27;,geomesa.table.sharing.prefix=&#x27;\\u0001&#x27;&quot;</span></span><br></pre></td></tr></table></figure></div><p>先使用 <code>;</code> 分隔符，再使用 <code>,</code> 分隔符，最后使用 <code>:</code> 分隔符。<code>;</code> 分隔符将 spec 分割为两个字符串：前者表示表中的全部列属性信息，列属性经过 <code>,</code> 分隔符分割为多列，列又经过 <code>:</code> 分隔符分割为 列名，列数据类型，列的一些属性（是否是索引，json 数据，默认索引等），而列名首字母 <code>*</code> 代表该字段是用于索引的 geometry 类型，一般采用 WKT 格式进行描述，当然存在数据库时会以字节码进行压缩；后者表示创建表时的 userData，同样经过 <code>,</code> 分隔符分割为多个 userData，userData 的一些默认属性可在 SimpleFeatureTypes.Configs 中看到，其它的可以用户自定义，这里重点说一下 <code>geomesa.indices.enabled</code> 属性，目前 GeoMesa 支持 8 种索引，分别为：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&quot;attr&quot;, // 属性索引</span><br><span class="line">&quot;id&quot;, // 主键索引</span><br><span class="line">&quot;s2&quot;, // Hilbert 曲线点空间索引</span><br><span class="line">&quot;s3&quot;, // Hilbert 曲线点时空索引</span><br><span class="line">&quot;z2&quot;, // Z 型曲线点空间索引</span><br><span class="line">&quot;xz2&quot;, // Z 型曲线线面空间索引</span><br><span class="line">&quot;z3&quot;,  // Z 型曲线点时空索引</span><br><span class="line">&quot;xz3&quot; // Z 型曲线线面时空索引</span><br></pre></td></tr></table></figure></div><p>　　由于 GeoMesa 中的索引一般存在多个版本，而 <code>geomesa.indices.enabled</code> 默认使用最新的版本，若需要指定版本，需要使用 <code>geomesa.indices</code>，<strong><em>该属性是 geomesa 内部属性，不对外开放</em></strong>，通用格式为：</p><p></p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">s&quot;<span class="subst">$name</span>:<span class="subst">$version</span>:<span class="subst">$&#123;mode.flag&#125;</span>:<span class="subst">$&#123;attributes.mkString(&quot;:&quot;)&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></div><p></p><p>name 代表索引类别，version 代表索引版本，mode.flag 代表索引模式（是否支持读写，一般为3，支持读也支持写），attributes 代表是哪些字段需要建立该索引。spec 参数可以只有描述列属性的字段，即不带任何 useData 信息，GeoMesa 会默认添加索引信息，若存在空间和时间字段，则会默认建立 z3（空间字段为点 Point 类型） 或 xz3（空间字段为线面 非Point 类型） 索引，若有多个空间和时间字段，建立索引的字段为第一个空间和第一个时间字段；若只存在空间字段，则会建立 z2 或 xz2 索引；若只有时间字段，则默认建立时间属性索引。当然如没有在 spec 指明索引信息，可以在后续继续添加信息，如下：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="JAVA"><div class="code-copy"></div><figure class="highlight hljs java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.locationtech.geomesa.utils.interop.SimpleFeatureTypes;</span><br><span class="line"></span><br><span class="line">String spec = <span class="string">&quot;name:String,dtg:Date,*geom:Point:srid=4326&quot;</span>;</span><br><span class="line">SimpleFeatureType sft = SimpleFeatureTypes.createType(<span class="string">&quot;mySft&quot;</span>, spec);</span><br><span class="line"><span class="comment">// enable a default z3 and a default attribute index</span></span><br><span class="line">sft.getUserData().put(<span class="string">&quot;geomesa.indices.enabled&quot;</span>, <span class="string">&quot;z3,attr:name&quot;</span>);</span><br><span class="line"><span class="comment">// or, enable a default z3 and an attribute index with a Z2 secondary index</span></span><br><span class="line">sft.getUserData().put(<span class="string">&quot;geomesa.indices.enabled&quot;</span>, <span class="string">&quot;z3,attr:name:geom&quot;</span>);</span><br><span class="line"><span class="comment">// or, enable a default z3 and an attribute index with a temporal secondary index</span></span><br><span class="line">sft.getUserData().put(<span class="string">&quot;geomesa.indices.enabled&quot;</span>, <span class="string">&quot;z3,attr:name:dtg&quot;</span>);</span><br></pre></td></tr></table></figure></div><h2 id="坑篇">坑篇</h2><h3 id="导入-osm-数据问题">导入 OSM 数据问题</h3><p>　　在<a target="_blank" rel="noopener" href="https://www.geomesa.org/documentation/stable/user/convert/premade/osm.html">导入 osm 数据</a>时，若使用 osm-ways 作为 SimpleFeatureType，则 geomesa 会使用数据库存储 node 临时使用，这时其默认使用 H2 Database，若想使用其它数据库，则需要在 lib 导入相应 jdbc 包，若使用 postgresql 数据库，则 geomesa 会触发一个 bug，因为 postgresql 没有 double 类型，只有 double precision 类型，这将导致建表出错。详情见 geomesa/geomesa-convert/geomesa-convert-osm/src/main/scala/org/locationtech/geomesa/convert/osm/OsmWaysConverter.scala 中</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">createNodesTable</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> sql = <span class="string">&quot;create table nodes(id BIGINT NOT NULL PRIMARY KEY, lon DOUBLE, lat DOUBLE);&quot;</span></span><br><span class="line">    <span class="type">WithClose</span>(connection.prepareStatement(sql))(_.execute())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>所以若需要使用 geomesa-convert-osm 导入 osm 数据时，需要进入 geomesa/geomesa-convert/geomesa-convert-osm 文件夹中输入命令</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn dependency:copy-dependencies -DoutputDirectory=./depLib</span><br></pre></td></tr></table></figure></div><p>导出 geomesa-convert-osm 依赖包，将其中的 h2，osm4j，dynsax，trove4j 等一系列库放入 $GEOMESA_HBASE_HOME/lib 中。</p><h3 id="s2-索引问题">s2 索引问题</h3><p>　　s2 索引即 Google S2 Geometry 算法基于 Hilbert 曲线生成一种索引，GeoMesa 的 s2 索引是一个国人提交的，目前 3.2 版本只支持点的时空索引，不支持线面的时空索引，当然官方也在实现自己的 Hilbert 曲线，希望后续 GeoMesa 中会有 h2 索引。Shaun 在导入 osm 数据并启用 s2 索引时，报错，被提示不支持，对比 geomesa-index-api2Index.scala 和 geomesa-index-api2Index.scala 两文件的 defaults 函数可发现 S2Index 直接返回空，而在 geomesa-index-api.scala 中 fromName 函数需要调用 defaults 函数，从而导致 s2 索引不支持，修改 S2Index 的 defaults 函数即可（别忘了在 S2Index 类中首行加上 <code>import org.locationtech.geomesa.utils.geotools.RichSimpleFeatureType.RichSimpleFeatureType</code>）。</p><h2 id="后记">后记</h2><p>　　暂时就了解了这么多，等后续熟悉的更多再继续更吧 (ง •_•)ง。</p><h2 id="附录">附录</h2><h3 id="geomesa-命令行工具部分参数">GeoMesa 命令行工具部分参数</h3><p>Geomesa 命令行参数：</p><table><colgroup><col style="width:25%"><col style="width:74%"></colgroup><thead><tr class="header"><th>参数</th><th>描述</th></tr></thead><tbody><tr class="odd"><td>-c, --catalog *</td><td>存放 schema 元数据的catalog 表（相当于数据库）</td></tr><tr class="even"><td>-f, --feature-name</td><td>schema 名（相当于数据库中的表）</td></tr><tr class="odd"><td>-s, --spec</td><td>要创建 SimpleFeatureType 的说明（即表中列的描述信息，表的 schema，如 "name:String,age:Int,dtg:Date,*geom:Point:srid=4326"）</td></tr><tr class="even"><td>-C, --converter</td><td>指定转换器，必须为一下之一：1、已经在classpath中的converter 名；2、converter 的配置（一个字符串）；3、包括converter的配置的名</td></tr><tr class="odd"><td>–converter-error-mode</td><td>自定义的转换器的error mode</td></tr><tr class="even"><td>-t, --threads</td><td>指定并行度</td></tr><tr class="odd"><td>–input-format</td><td>指定输入源格式（如csv, tsv, avro, shp, json,）</td></tr><tr class="even"><td>–no-tracking</td><td>指定提交的 ingest job何时终止（在脚本中常用）</td></tr><tr class="odd"><td>–run-mode</td><td>指定运行模式，必须为：local（本地）、distributed （分布式）、distributedcombine（分布式组合）之一</td></tr><tr class="even"><td>–split-max-size</td><td>在分布式中，指定切片最大大小（字节）</td></tr><tr class="odd"><td>–src-list</td><td>输入文件为文本文件，按行输入</td></tr><tr class="even"><td>–force</td><td>禁用任何的提示</td></tr><tr class="odd"><td>[files]…</td><td>指定输入的文件</td></tr></tbody></table><p>参考资料：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_21705851/article/details/93392202">GeoMesa命令行工具---摄取命令</a></p></div><div class="article-content-more"><button type="button" class="article-more--link"><i class="fa fa-angle-double-down fa-3x" aria-hidden="true"></i></button></div></section></article><article id="post-IDEA使用Docker环境开发调试" class="article div-border"><header class="article-header"><span class="article-date article-title--index"><i class="fa fa-calendar" aria-hidden="true"></i> <a href="/posts/3692cd6.html"><time datetime="2021-01-10T08:50:12.000Z">2021-01-10</time></a></span><section class="article-title article-title--index"><a href="/posts/3692cd6.html">IDEA使用Docker环境开发调试</a></section><div class="article-label"><div class="article-category label"><i class="fa fa-book" aria-hidden="true"></i> <a class="color3 article-category-link" href="/categories/Study/">Study</a></div><div class="article-tag label"><i class="fa fa-bookmark" aria-hidden="true"></i> <a class="color5 article-tag-none-link" href="/tags/devtool/" rel="tag">devtool</a></div></div></header><section class="article-content"><div class="article-content--excerpt"><h2 id="前言">前言</h2><p>　　IDEA 以前基本没用过，只是简单用过 Android Studio，还基本都忘记了 ( ╯□╰ )，以后应该会用 Scala 做一些大数据方面的东西，而大数据的环境都是 Linux 下的，而 Shaun 日常都是在 Windows 下开发，所以需要用日前做的容器环境来测试调试运行程序，简单记录一下 IDEA 在这方面的使用方法。</p></div><div class="article-content--all"><h2 id="前言">前言</h2><p>　　IDEA 以前基本没用过，只是简单用过 Android Studio，还基本都忘记了 ( ╯□╰ )，以后应该会用 Scala 做一些大数据方面的东西，而大数据的环境都是 Linux 下的，而 Shaun 日常都是在 Windows 下开发，所以需要用日前做的容器环境来测试调试运行程序，简单记录一下 IDEA 在这方面的使用方法。</p><span id="more"></span><h2 id="运行篇">运行篇</h2><p>　　右键项目名（HelloWorld），新建文件（New =》File），指定文件名为 <code>Dockerfile</code> 。写入内容示例如下：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="DOCKERFILE"><div class="code-copy"></div><figure class="highlight hljs dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> stc:<span class="number">2.0</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> ./target/classes/ /tmp</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /tmp</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">&quot;scala&quot;</span>,<span class="string">&quot;HelloWorld&quot;</span>]</span></span><br></pre></td></tr></table></figure></div><p>点击左上角绿色双箭头，可编辑 Dockerfile（Edit 'Dockerfile'） ，指定当前上下文目录（Context folder），Contaier name 等容器启动选项。直接运行 Dockerfile（Run 'Dockerfile'），IDEA 即可自动创建容器，并在容器中运行程序，程序运行完则容器自动停止，若需要运行存在外部依赖的程序，则只能以 jar 包的方式运行。</p><p>　　设置 IDEA 生成 jar 包如下：在最上面的菜单栏中 File =》Project Structure =》Artifacts =》+ =》JAR =》From modules with dependencies，选择 Main Class，点击右边的文件夹图标即可选择相应类，由于存在外部依赖，所以不能直接用默认的 extract to the target JAR，而是应该选择下面的 <strong>copy to the output directory and link via manifest</strong>，点击 OK 后，自动或手动选择导出的依赖 jar 包，点击 OK。在最上面的菜单栏中 Build =》Build Artifacts...，可在 out/artifacts/HelloWorld_jar 文件夹中生成所有 jar 包。之后编辑 Dockerfile， <strong>更改 Dockerfile 上下文目录</strong>为 out/artifacts/HelloWorld_jar ，指定容器名，在 Command 中输入 <code>java -jar HelloWorld.jar</code> 修改 Dockerfile 中第 2 行命令为 <code>COPY . /tmp</code>，修改第 4 行命令为 <code>CMD ["java", "-jar", "HelloWorld.jar"]</code>。之后运行 Dockerfile 即可在下面 Services 栏对应 Docker 容器 Attached Console 中看到程序运行结果。</p><h2 id="调试篇">调试篇</h2><p>　　除了使用 IDEA 生成 jar 包外，还需要使用 IDEA 的远程调试功能，设置 IDEA 远程调试功能如下：在最上面的菜单栏中 Run =》Edit Configurations... =》+ =》Remote JVM Debug，上方的 Debugger mode 中使用默认的 Attach to remote JVM， 在下面的 Before launch 添加 Launch Docker before debug。在弹窗中选择相应 Dockerfile，在下方的 Custom command 中输入 <code>java -agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=5005 -jar HelloWorld.jar</code>， 完成后即可使用该配置在 IDEA 调试容器中运行的程序。</p><h2 id="后记">后记</h2><p>　　用这种方式使用 IDEA 确实达到了 Shaun 理想的结果，Windows 下开发，Docker 中调试和运行，应付简单的代码调试和运行确实是没问题，但是在复杂的分布式环境下总会碰到一些莫名奇妙的问题，这些问题就是纯粹的经验了。</p><h2 id="参考资料">参考资料</h2><p><a target="_blank" rel="noopener" href="https://www.jetbrains.com/help/idea/supported-languages.html/running-a-java-app-in-a-container.html">Run a Java application in a Docker container</a></p><p><a target="_blank" rel="noopener" href="https://www.jetbrains.com/help/idea/supported-languages.html/debug-a-java-application-using-a-dockerfile.html#create-dockerfile-run-config">Debug a Java application using a Dockerfile</a></p></div><div class="article-content-more"><button type="button" class="article-more--link"><i class="fa fa-angle-double-down fa-3x" aria-hidden="true"></i></button></div></section></article><article id="post-大数据环境搭建笔记" class="article div-border"><header class="article-header"><span class="article-date article-title--index"><i class="fa fa-calendar" aria-hidden="true"></i> <a href="/posts/af5e9ace.html"><time datetime="2021-01-03T01:50:26.000Z">2021-01-03</time></a></span><section class="article-title article-title--index"><a href="/posts/af5e9ace.html">大数据环境搭建笔记</a></section><div class="article-label"><div class="article-category label"><i class="fa fa-book" aria-hidden="true"></i> <a class="color2 article-category-link" href="/categories/Study/">Study</a></div><div class="article-tag label"><i class="fa fa-bookmark" aria-hidden="true"></i> <a class="color5 article-tag-none-link" href="/tags/bigdata/" rel="tag">bigdata</a><a class="color5 article-tag-none-link" href="/tags/note/" rel="tag">note</a></div></div></header><section class="article-content"><div class="article-content--excerpt"><h2 id="前言">前言</h2><p>　　准备开始搞时空数据了，先简单搭一下环境。</p></div><div class="article-content--all"><h2 id="前言">前言</h2><p>　　准备开始搞时空数据了，先简单搭一下环境。</p><span id="more"></span><p>准备搭的环境为：jdk-1.8.0，hadoop-3.2.1，hbase-2.2.6，geomesa-hbase_2.11-3.1.0，spark-3.0.1-bin-hadoop3.2，geoserver-2.16.5-bin，geomesa-hbase_2.11-3.2.0-SNAPSHOT，所用的包都已下好并解压到 /home 目录下。</p><p><strong><em>※注</em></strong>： <em>hbase-2.2.6 暂不支持最新的 hadoop-3.3.0</em>，Hadoop 也最好使用 jdk-1.8.0，java-11 会有问题。</p><h2 id="hadoop-环境">Hadoop 环境</h2><p>　　首先修改 /etc/hosts 文件中本机 ip 对应的名称为 master，若在容器中安装则需要在 run 开启容器就指定 <code>--hostname master</code>，否则改了也没用，下次启动容器时 hostname 又会回到初始状态，下面开启正式的配置。</p><p>修改 /home/hadoop-3.2.1/etc/hadoop/hadoop-env.sh 文件，添加</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> JAVA_HOME=<span class="variable">$JAVA_HOME</span></span><br></pre></td></tr></table></figure></div><p>修改 /home/hadoop-3.2.1/etc/hadoop/core-site.xml 文件，添加</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="XML"><div class="code-copy"></div><figure class="highlight hljs xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- master 前面配置的主机名称 --&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- &lt;property&gt;</span></span><br><span class="line"><span class="comment">    &lt;name&gt;fs.default.name&lt;/name&gt;</span></span><br><span class="line"><span class="comment">    &lt;value&gt;hdfs://master:9000&lt;/value&gt;</span></span><br><span class="line"><span class="comment">  &lt;/property&gt; --&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>fs.defaultFS<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://master:9000<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hadoop.tmp.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>/home/hadoop/data/tmp<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></div><p>修改 /home/hadoop-3.2.1/etc/hadoop/hdfs-site.xml 文件，添加</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="XML"><div class="code-copy"></div><figure class="highlight hljs xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--指定SecondaryNameNode位置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.secondary.http-address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>master:9001<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.replication<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></div><p>修改 /home/hadoop-3.2.1/etc/hadoop/yarn-site.xml 文件，添加</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="XML"><div class="code-copy"></div><figure class="highlight hljs xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Site specific YARN configuration properties --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.aux-services<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>mapreduce_shuffle<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></div><p>修改 /home/hadoop-3.2.1/etc/hadoop/mapred-site.xml 文件，添加</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="XML"><div class="code-copy"></div><figure class="highlight hljs xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.framework.name<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>yarn<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></div><p>在 /home/hadoop-3.2.1/sbin/start-dfs.sh 和 /home/hadoop-3.2.1/sbin/stop-dfs.sh 文件头添加</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line">HDFS_DATANODE_USER=root</span><br><span class="line">HDFS_DATANODE_SECURE_USER=hdfs</span><br><span class="line">HDFS_NAMENODE_USER=root</span><br><span class="line">HDFS_SECONDARYNAMENODE_USER=root</span><br></pre></td></tr></table></figure></div><p>在 /home/hadoop-3.2.1/sbin/start-yarn.sh 和 /home/hadoop-3.2.1/sbin/stop-yarn.sh 文件头添加</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line">YARN_RESOURCEMANAGER_USER=root</span><br><span class="line">HADOOP_SECURE_DN_USER=yarn</span><br><span class="line">YARN_NODEMANAGER_USER=root</span><br></pre></td></tr></table></figure></div><p>设置环境变量，在 /etc/profile 中添加</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">Hadoop Environment Setting</span></span><br><span class="line">export HADOOP_HOME=/home/hadoop-3.2.1</span><br><span class="line">export JAVA_LIBRARY_PATH=$HADOOP_HOME/lib/native</span><br><span class="line">export LD_LIBRARY_PATH=$JAVA_LIBRARY_PATH</span><br><span class="line">export PATH=$PATH:$HADOOP_HOME/bin:$HADOOP_HOME/sbin</span><br></pre></td></tr></table></figure></div><p>由于容器中默认为 root 用户，所以在 /root/.bashrc 文件末尾添加 <code>source /etc/profile</code>，以开机启用设置的环境变量。</p><p>在启动 Hadoop 之前需要执行 <code>hdfs namenode -format</code> 进行格式化，启动命令为 <code>/home/hadoop-3.2.1/sbin/start-all.sh</code>。<em>后续若需要清空并重新设置 Hadoop 时，必须先删除 /home/hadoop/ 目录，再重新进行格式化。</em></p><h2 id="hbase-环境">HBase 环境</h2><p>修改 /home/hbase-2.2.6/conf/hbase-env.sh 文件，添加</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> JAVA_HOME=<span class="variable">$JAVA_HOME</span></span><br><span class="line"><span class="comment"># 使用自带的ZooKeeper管理</span></span><br><span class="line"><span class="built_in">export</span> HBASE_MANAGES_ZK=<span class="literal">true</span></span><br></pre></td></tr></table></figure></div><p>修改 /home/hbase-2.2.6/conf/hbase-site.xml 文件，添加</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="XML"><div class="code-copy"></div><figure class="highlight hljs xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.rootdir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://master:9000/hbase<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.dynamic.jars.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://master:9000/hbase/lib<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.cluster.distributed<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.replication<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.master.maxclockskew<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>180000<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>Time difference of regionserver from master<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.zookeeper.quorum<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>localhost<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 修改默认8080 端口--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.rest.port<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>8088<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 2181 默认端口，尽量不要修改，geomesa-hbase 导入数据时默认连接端口为 2181--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.zookeeper.property.clientPort<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>2181<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.zookeeper.property.dataDir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>/home/hbase/data<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.unsafe.stream.capability.enforce<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- geomesa-hbase --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.coprocessor.user.region.classes<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>org.locationtech.geomesa.hbase.server.coprocessor.GeoMesaCoprocessor<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></div><p>修改 /home/hbase-2.2.6/conf/regionservers 文件，修改为（原来为 localhost）</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">master</span><br></pre></td></tr></table></figure></div><p>设置环境变量，在 /etc/profile 中添加</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">HBase Environment Setting</span></span><br><span class="line">export HBASE_HOME=/home/hbase-2.2.6</span><br><span class="line">export PATH=$PATH:$HBASE_HOME/bin</span><br></pre></td></tr></table></figure></div><p>配置好之后，执行 <code>start-hbase.sh</code> 启动 HBase。</p><h2 id="spark-环境">Spark 环境</h2><p>修改 /home/spark-3.0.1-bin-hadoop3.2/conf/spark-env.sh 文件，在文件末尾添加</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置JAVA_HOME，一般来说，不配置也可以，但是可能会出现问题，还是配上吧</span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=<span class="variable">$JAVA_HOME</span></span><br><span class="line"><span class="comment"># 一般来说，spark任务有很大可能性需要去HDFS上读取文件，所以配置上</span></span><br><span class="line"><span class="comment"># 如果说你的spark就读取本地文件，也不需要yarn管理，不用配</span></span><br><span class="line"><span class="built_in">export</span> HADOOP_CONF_DIR=<span class="variable">$HADOOP_HOME</span>/etc/hadoop</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置Master的主机名</span></span><br><span class="line"><span class="built_in">export</span> SPARK_MASTER_HOST=master</span><br><span class="line"><span class="comment"># 提交Application的端口，默认就是这个，万一要改呢，改这里</span></span><br><span class="line"><span class="built_in">export</span> SPARK_MASTER_PORT=7077</span><br><span class="line"><span class="comment"># 每一个Worker最多可以使用的cpu core的个数，我虚拟机就一个...</span></span><br><span class="line"><span class="comment"># 真实服务器如果有32个，你可以设置为32个</span></span><br><span class="line"><span class="built_in">export</span> SPARK_WORKER_CORES=1</span><br><span class="line"><span class="comment"># 每一个Worker最多可以使用的内存，我的虚拟机就2g</span></span><br><span class="line"><span class="comment"># 真实服务器如果有128G，你可以设置为100G</span></span><br><span class="line"><span class="built_in">export</span> SPARK_WORKER_MEMORY=2g</span><br><span class="line"><span class="comment"># master web UI端口默认8080</span></span><br><span class="line"><span class="built_in">export</span> SPARK_MASTER_WEBUI_PORT=8090</span><br><span class="line"><span class="comment"># worker web UI端口默认8081</span></span><br><span class="line"><span class="built_in">export</span> SPARK_WORKER_WEBUI_PORT=8089</span><br></pre></td></tr></table></figure></div><p>复制 /home/spark-3.0.1-bin-hadoop3.2/conf/slaves.template 文件，并重命名为 slaves，将该文件尾修改为</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 里面的内容原来为localhost，改为master </span></span><br><span class="line">master</span><br></pre></td></tr></table></figure></div><p>设置环境变量，在 /etc/profile 中添加</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export SPARK_HOME=/home/spark-3.0.1-bin-hadoop3.2</span><br><span class="line">export PATH=$PATH:$SPARK_HOME/bin:$SPARK_HOME/sbin</span><br></pre></td></tr></table></figure></div><p>将 /home/spark-3.0.1-bin-hadoop3.2/sbin/start-all.sh 重命名为 start-spark-all.sh，将 /home/spark-3.0.1-bin-hadoop3.2/sbin/stop-all.sh 重命名为 stop-spark-all.sh，执行 <code>start-spark-all.sh</code> 启动 Spark。</p><h2 id="geomesa-hbase-环境">geomesa-hbase 环境</h2><h3 id="编译-geomesa">编译 geomesa</h3><p>克隆 <a target="_blank" rel="noopener" href="https://gitee.com/mirrors/geomesa">LocationTech GeoMesa</a> ，<strong>修改 pom.xml</strong>，即修改对应依赖的 hadoop 和 hbase 以及 spark 版本（spark 最新的3.0.1版本由 Scala-2.12 编译，而 Geomesa 编译目前采用 Scala-2.11， 所以 Spark 不能使用最新的版本，只能用 2.4.7）。进入 geomesa 根目录，使用命令</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mvn clean install -DskipTests</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或仅编译 geomesa-hbase</span></span><br><span class="line">mvn clean install -pl geomesa-hbase -am -DskipTests</span><br></pre></td></tr></table></figure></div><p>编译 geomesa，中间可能会失败很多次，包下不来，可能需要挂代理或换源，重复使用命令多次即可。</p><h3 id="配置-geomesa-hbase">配置 geomesa-hbase</h3><p>将 /home/geomesa/geomesa-hbase/geomesa-hbase-dist/target/geomesa-hbase_2.11-3.2.0-SNAPSHOT-bin.tar.gz 解压为 /home/geomesa-hbase_2.11-3.2.0-SNAPSHOT，<strong>将 /home/geomesa-hbase_2.11-3.2.0-SNAPSHOT/dist/hbase/geomesa-hbase-distributed-runtime-hbase2_2.11-3.2.0-SNAPSHOT.jar 复制到 /home/hbase-2.2.6/lib/ 文件夹中</strong>，修改 /home/geomesa-hbase_2.11-3.2.0-SNAPSHOT/conf/dependencies.sh 文件，设置正确的Hadoop 和 hbase 版本，依次执行 /home/geomesa-hbase_2.11-3.2.0-SNAPSHOT/bin/install-dependencies.sh 和 /home/geomesa-hbase_2.11-3.2.0-SNAPSHOT/bin/install-shapefile-support.sh。设置环境变量，在 /etc/profile 中添加</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> GEOMESA_HBASE_HOME=/home/geomesa-hbase_2.11-3.2.0-SNAPSHOT</span><br><span class="line"><span class="built_in">export</span> GEOMESA_LIB=<span class="variable">$GEOMESA_HBASE_HOME</span>/lib</span><br><span class="line"><span class="built_in">export</span> GEOMESA_CONF_DIR=<span class="variable">$&#123;GEOMESA_HBASE_HOME&#125;</span>/conf</span><br><span class="line"><span class="built_in">export</span> CLASSPATH=<span class="variable">$CLASSPATH</span>:<span class="variable">$GEOMESA_LIB</span>:<span class="variable">$GEOMESA_CONF_DIR</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$GEOMESA_HBASE_HOME</span>/bin</span><br></pre></td></tr></table></figure></div><h3 id="测试-geomesa-hbase">测试 geomesa-hbase</h3><p>启动 Hadoop 和 HBase 之后，可直接使用命令</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">geomesa-hbase ingest --catalog TestGeomesa --feature-name road --input-format shp <span class="string">&quot;/home/shpdata/road.shp&quot;</span></span><br></pre></td></tr></table></figure></div><p>导入 shp 数据，<strong>shp 不能有 id 字段</strong>，因为 Geomesa 在创建表时会默认生成一个 id 字段。</p><p>也可克隆 <a target="_blank" rel="noopener" href="https://gitee.com/xfilove/geomesa-tutorials">geomesa-tutorials</a> ，同样修改其中的 pom.xml 文件，进入 geomesa-tutorials 根目录，使用命令</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean install -pl geomesa-tutorials-hbase/geomesa-tutorials-hbase-quickstart -am</span><br></pre></td></tr></table></figure></div><p>编译 geomesa-tutorials，编译完成后，使用命令</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp geomesa-tutorials-hbase/geomesa-tutorials-hbase-quickstart/target/geomesa-tutorials-hbase-quickstart-3.2.0-SNAPSHOT.jar org.geomesa.example.hbase.HBaseQuickStart --hbase.zookeepers localhost --hbase.catalog geomesaTest</span><br></pre></td></tr></table></figure></div><p>导入数据进 Hbase，导入成功后可通过 <code>hbase shell</code> 进入 hbase，在 hbase shell 中通过 <code>list</code> 查看 hbase 现有的表。</p><h3 id="整合-geoserver">整合 geoserver</h3><p>导入依赖插件</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">manage-geoserver-plugins.sh -l <span class="variable">$&#123;GEOSERVER_HOME&#125;</span>/webapps/geoserver/WEB-INF/lib/ -i</span><br></pre></td></tr></table></figure></div><p>修改 /home/geomesa-hbase_2.11-3.2.0-SNAPSHOT/bin/install-dependencies.sh 中第33行：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install_dir=&quot;$&#123;GEOMESA_HBASE_HOME&#125;/lib&quot;</span></span><br><span class="line">install_dir=<span class="string">&quot;<span class="variable">$&#123;GEOSERVER_HOME&#125;</span>/webapps/geoserver/WEB-INF/classes&quot;</span></span><br></pre></td></tr></table></figure></div><p>执行 install-dependencies.sh 安装插件，安装完后将 classes 中的 lib 都移到 ${GEOSERVER_HOME}/webapps/geoserver/WEB-INF/lib中。</p><h2 id="后记">后记</h2><p>　　环境搞起来真麻烦，在编译和运行 Geomesa 时总能遇到一些莫名奇妙的问题，Java 系的这一套确实很麻烦，尤其是各种依赖关系，不过最后总算是搞好了，能直接在 geoserver 中看到 geomesa 存在 hbase 里的地图。</p><h2 id="参考资料">参考资料</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Mr-lin66/p/13378248.html">Centos7系统 Hadoop+HBase+Spark环境搭建</a></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_41834634/article/details/89176473">GeoMesa-HBase操作篇——安装</a></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/hsg77/article/details/82221531">centos7安装geomesa2.0.2_hbase_geoserver2.13.2的方法</a></p><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/heidsoft/p/8558419.html">hadoop fs 命令使用</a></p><p><a target="_blank" rel="noopener" href="https://www.geomesa.org/documentation/stable/tutorials/geomesa-quickstart-hbase.html">GeoMesa HBase Quick Start</a></p><p><a target="_blank" rel="noopener" href="https://www.geomesa.org/documentation/stable/user/hbase/install.html">Installing GeoMesa HBase</a></p><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yszd/p/10039249.html">Spark完全分布式集群搭建【Spark2.4.4+Hadoop3.2.1】</a></p><h2 id="附录">附录</h2><p>最后附上一些常用的端口及说明：</p><h3 id="hbase">Hbase</h3><table><thead><tr class="header"><th>配置</th><th>端口</th><th>说明</th><th></th></tr></thead><tbody><tr class="odd"><td>hbase.master.port</td><td>16000</td><td>HMaster绑定端口</td><td></td></tr><tr class="even"><td><strong>hbase.master.info.port</strong></td><td><strong>16010</strong></td><td><strong>HBase Master的Web UI端口</strong></td><td></td></tr><tr class="odd"><td>hbase.regionserver.port</td><td>16020</td><td>HBase RegionServer绑定的端口</td><td></td></tr><tr class="even"><td><strong>hbase.regionserver.info.port</strong></td><td><strong>16030</strong></td><td><strong>HBase RegionServer的Web UI端口</strong></td><td></td></tr><tr class="odd"><td>hbase.zookeeper.property.clientPort</td><td>2181</td><td>Zookeeper客户端连接端口</td><td></td></tr><tr class="even"><td>hbase.zookeeper.peerport</td><td>2888</td><td>Zookeeper节点内部之间通信的端口</td><td></td></tr><tr class="odd"><td>hbase.zookeeper.leaderport</td><td>3888</td><td>Zookeeper用来选举主节点的端口</td><td></td></tr><tr class="even"><td>hbase.rest.port</td><td>8080</td><td>HBase REST server的端口</td><td></td></tr><tr class="odd"><td>hbase.master.port</td><td>60000</td><td>HMaster的RPC端口</td><td></td></tr><tr class="even"><td>hbase.master.info.port</td><td>60010</td><td>HMaster的http端口</td><td></td></tr><tr class="odd"><td>hbase.regionserver.port</td><td>60020</td><td>HRegionServer的RPC端口</td><td></td></tr><tr class="even"><td>hbase.regionserver.info.port</td><td>60030</td><td>HRegionServer的http端口</td><td></td></tr><tr class="odd"><td></td><td></td><td></td><td></td></tr></tbody></table><h3 id="hadoop">Hadoop</h3><table><thead><tr class="header"><th>配置</th><th>端口</th><th>说明</th><th></th></tr></thead><tbody><tr class="odd"><td>fs.defaultFS</td><td>9000</td><td>hdfs访问端口</td><td></td></tr><tr class="even"><td>dfs.namenode.rpc-address</td><td>9001</td><td>DataNode会连接这个端口</td><td></td></tr><tr class="odd"><td>dfs.datanode.address</td><td>9866</td><td>DataNode的数据传输端口</td><td></td></tr><tr class="even"><td><strong>dfs.namenode.http-address</strong></td><td><strong>9870</strong></td><td><strong>namenode的web UI 端口</strong></td><td></td></tr><tr class="odd"><td><strong>yarn.resourcemanager.webapp.address</strong></td><td><strong>8088</strong></td><td><strong>YARN的http端口</strong></td><td></td></tr></tbody></table><h3 id="spark">Spark</h3><table><thead><tr class="header"><th></th><th>端口</th><th>说明</th><th></th></tr></thead><tbody><tr class="odd"><td></td><td>8080</td><td>master的webUI，Tomcat的端口号（已修改为8090）</td><td></td></tr><tr class="even"><td></td><td>8081</td><td>worker的webUI的端口号（已修改为8089）</td><td></td></tr><tr class="odd"><td></td><td>18080</td><td>historyServer的webUI的端口号</td><td></td></tr></tbody></table><p>需开放端口 22，2181，5432，8080，8088，8089，8090，9870，16010，16030。</p><p><code>docker run -dit --privileged=true --name STC2 --hostname master -v E:/Docker/ShareFile:/mnt/sharefile -p 22:22 -p 80:80 -p 2181:2181 -p 5432:5432 -p 8080-8090:8080-8090 -p 9870:9870 -p 16010:16010 -p 16030:16030 stc:2.0 init</code></p></div><div class="article-content-more"><button type="button" class="article-more--link"><i class="fa fa-angle-double-down fa-3x" aria-hidden="true"></i></button></div></section></article><article id="post-设计模式浅谈" class="article div-border"><header class="article-header"><span class="article-date article-title--index"><i class="fa fa-calendar" aria-hidden="true"></i> <a href="/posts/ae780057.html"><time datetime="2020-12-27T10:28:56.000Z">2020-12-27</time></a></span><section class="article-title article-title--index"><a href="/posts/ae780057.html">设计模式浅谈</a></section><div class="article-label"><div class="article-category label"><i class="fa fa-book" aria-hidden="true"></i> <a class="color1 article-category-link" href="/categories/Study/">Study</a></div><div class="article-tag label"><i class="fa fa-bookmark" aria-hidden="true"></i> <a class="color4 article-tag-none-link" href="/tags/thought/" rel="tag">thought</a></div></div></header><section class="article-content"><div class="article-content--excerpt"><h2 id="前言">前言</h2><p>　　进入职场一年半以来，Shaun 完全独立从 0 到 1 开发了 1.5 个项目（当然也有参与其它项目，但不是 Shaun 独立从 0 到 1 开发的，没多少控制权，就不谈了），一个网页版的高精地图编辑器，半个地图可视化系统，这里面 Shaun 用了不少设计模式，这篇就谈谈 Shaun 用过的和没用过的一些设计模式。</p></div><div class="article-content--all"><h2 id="前言">前言</h2><p>　　进入职场一年半以来，Shaun 完全独立从 0 到 1 开发了 1.5 个项目（当然也有参与其它项目，但不是 Shaun 独立从 0 到 1 开发的，没多少控制权，就不谈了），一个网页版的高精地图编辑器，半个地图可视化系统，这里面 Shaun 用了不少设计模式，这篇就谈谈 Shaun 用过的和没用过的一些设计模式。</p><span id="more"></span><p>　　以「Head First 设计模式」为参考，Shaun 用 C++ 实现了一遍书中的例子（代理模式及其后面的模式除外），下面进入正文。</p><h2 id="模式篇">模式篇</h2><h3 id="策略模式">策略模式</h3><p>　　Shaun 个人认为最能体现面向对象编程思想（抽象封装继承多态）的一种模式，换句话说，只要真正理解和运用面向对象编程，一定会自然而然的用到策略模式。Shaun 在做高精地图编辑器时，需要设计一个渲染模块，渲染模块会包含高亮行为，高亮有两种，一种是直接改变颜色，一种是使用后期处理（OutlinePass 或 UnrealBloomPass 等）进行高亮，这时就需要在渲染类中组合高亮行为。</p><p>　　策略模式中涉及到的原则有：1、封装变化；2、多用组合，少用继承；3、针对接口编程，不针对实现编程。封装变化这点很考验程序员的经验水平，在写代码之初，往往预料不到变化，所以这一点一般是在编码过程中逐渐完善的，不断进行抽象，从而生成比较合理的基类；第二点一般也是对的，但有时在编码过程中难免会碰到到底是用继承还是组合的问题，这时候可以多想想，组合并不是万能的，有时继承更合适，这时可以请教身边更有经验的程序员，组合的优势在于当子类不想要这个对象时，可以随时丢弃，而继承的优势在于，当子类不想实现这个行为时，可以有默认的行为，而且有些时候只能用继承；针对接口编程没啥好说的，就是抽象。</p><h3 id="观察者模式">观察者模式</h3><p>　　这个模式如果在分布式系统中又叫发布订阅模式，该模式常用于消息通知。前端有个 RxJS 的库将这一模式玩出花来了，Shaun 在高精地图编辑器的事件流管理中就使用了该库。在 threejs 中所有渲染对象的都有一个统一的基类 EventDispatcher，该类中就实现了一个简单的观察者模式，用来处理事件监听触发和通知，和真正的观察者相比，区别在于观察者只是一个函数，而不是一个类，其实浏览器的事件监听机制实现方式也和这个类差不多。</p><p>　　观察者模式中涉及到原则有：松耦合。这里的松耦合是指主题和观察者之间是隔离的，观察者可自行实现自己的更新行为，而主题同样可实现自己的通知机制，两者虽有关联但互不影响。松耦合原则说起来人人会说，但真正能实现松耦合的却不多，实现松耦合的关键在于怎样分离两个系统，两个系统的连接点在哪，这有时很难理清，从而造成逻辑混乱，bug 丛生。</p><h3 id="装饰者模式">装饰者模式</h3><p>　　利用该模式可以很方便的扩展一些方法和属性，尤其是遇到主体和配件这样的关系时，可以很轻松的添加配件到主体上。Shaun 没用过这个模式，本来在扩展 threejs 一个类时想用，但确实没找到非常明确的主体和配件这样的关系，最后还是简单的使用继承了。</p><p>　　装饰者模式涉及到的原则有：开放——封闭原则。设计一个类需要考虑对扩展开放，对修改关闭。修改和扩展看似矛盾，但实则可以独立存在，装饰者的配件可以无限加，这是扩展，是开放，而在加配件时无需修改现有代码，这是封闭。当然这一原则并不独属于装饰者模式，应该说是只要用到面向对象的思想开发程序，就一定会用到该原则，否则也就失去了面向对象的意义。但有时这个原则又没必要贯彻彻底，因为对于有些需求可能很难弄清修改和扩展的界限，这时就达到能尽量重用父类的方法就好。</p><h3 id="工厂模式">工厂模式</h3><p>　　该模式在稍微大一点的系统中应该都会用到，根据不同的输入，生成不同的对象，这就是工厂模式的本质。至于工厂模式的实现方式一般会根据需求的复杂度来决定：1、只有一个工厂，一类产品，只是为了集中一层 if-else，可用简单工厂模式，甚至一个 builder 函数即可；2、有多个工厂，还是只有一类产品，用工厂模式，多个工厂继承一个工厂父类即可，相当于多个简单工厂组合；3、有多个工厂，多类产品，哪个工厂生产什么产品可能有变化，这时需要用到抽象工厂模式，除正常的继承之外，还需使用组合，组合组成产品的父类，相当于再组合一个工厂。Shaun 在高精地图编辑器中当然是大量使用的工厂模式和简单工厂模式，主要是为了集中 if-else 的处理，比如根据不同的数据类型创建不同的属性栏界面（枚举用下拉框，字符串用文本框，数字用数字栏等），根据不同的路网元素创建对应的渲染器对象以及对应的属性界面等。</p><p>　　工厂模式涉及到的原则有：依赖倒置原则。尽量依赖抽象，而不是具体类。这其实也是抽象一种作用或好处，即在使用过程中尽量使用最上层的父类，具体类只在创建实例时使用。</p><h3 id="单例模式">单例模式</h3><p>　　写程序的基本都会用到该模式，主要用来创建全局唯一对象，可用来存储和处理系统中常用的各个模块都会用到的一些数据。Shaun 在编辑器中单例模式用了好几个，比如全局唯一的 viewport，用力绘制 3d 图形；全局唯一的路网数据；当然系统中存在太多的单例模式也不好，最好是只有一个，如 Shaun 的编辑器中最好的模式就是创建一个单例的 Editor 类，需要做单例的对象都可以放在该类中，如此保证系统中只有一个单例类，以进行统一管理。</p><p>　　该模式与面向对象倒是没多大关系了，可以认为是全局变量的优化版，毕竟大的系统中全局变量基本不可避免，这时就可以使用单例模式。</p><h3 id="命令模式">命令模式</h3><p>　　该模式主要用来将函数方法封装成类，这样做的好处就是可以更灵活的执行该方法（将方法放进队列中依次执行，将方法持久化以便系统启动执行），同时也可以保存该方法的一些中间状态，以便撤销操作，回到系统执行该方法前的状态。Shaun 在编辑器中主要用命令模式做撤销重做功能，这基本也是编辑器的必备功能了，可以说没有撤销重做功能的编辑器是不完整的，要实现撤销重做功能除了基本的命令模式之外，还要提供撤销和重做两个栈以保存操作命令。</p><p>　　该模式与面向对象也没很大关系，只是提供了一个实现一些特殊功能的标准或通用方案。</p><h3 id="适配器模式">适配器模式</h3><p>　　该模式正如其名，主要用来转换接口，将一个类的方法用其它类封装一下，以达到兼容其它类接口的目的，同时对外可接口保持不变，该模式通过对象组合实现。Shaun 没使用过该模式，就 Shaun 感觉这个模式应该可以用在维护了好几年的系统上，当新作的东西需要兼容老接口时，可以用适配器模式将新街口封装一下。</p><p>　　该模式同样只是提供了一种新接口兼容老接口的一种优良方案，当然实际使用过程中可能很难这么完美，但算是一种思路。</p><h3 id="外观模式">外观模式</h3><p>　　该模式算是封装的一种体现。当一个功能需要经过多次函数调用才能完成时，这时可以用另一个方法将这些函数都封装起来，从而简化调用方式。Shaun 用该模式处理整个渲染模块的初始化和资源释放，因为初始化时需要分配好很多东西（光照，viewport，固定图层，地面，天空盒等），而释放时同样需要释放这些东西。该模式同样只能算是提供了一种好的编程实践，实际使用过程可能每个函数都有很多参数，调用顺序可能有变，这时简化调用反而没有必要，让用户自己决定怎样调用更好。</p><p>　　外观模式涉及到的原则有：最少知识原则。该原则主要用来减少对象依赖，即尽量不将类中组合的对象直接暴露出去，而应该将组合对象的方法再简单封装一下，再将封装后的方法暴露出去，以减少另外的类又依赖类中组合对象的现象。该原则可以适当遵守，因为有时直接使用更方便一点，多次封装之后反而显得逻辑混乱，增加系统的复杂度。</p><h3 id="模板方法模式">模板方法模式</h3><p>　　该模式是抽象的一种体现。首先抽象出一套固定化的流程，流程中每个步骤的具体行为并一致，有些默认，有些可以重写，父类固定流程，子类负责重写流程中每个步骤，这就时模板方法模式。Shaun 没写过完全符合该模式的代码，只是写了个类似该模式的模块，该模块有三个功能（编辑道路节点，编辑车道节点，编辑车道线），做完前两个功能后，发现这里有一套逻辑是通用的，那就是滑过节点高亮，选择节点，出现 gizmo，拖动 gizmo，完成编辑（当然还有选择节点后不拖动 gizmo 等一套 if-else 中间处理状态），于是 Shaun 把这一套流程抽象出来，固化方法，这三个功能都继承该类，方法该重写的重写，不仅减少了代码量，同时整个流程也更清晰了，很快完成了第三个功能。</p><p>　　模板方法涉及到的原则有：好莱坞原则。即由父类负责函数调用，而子类负责重写被调用的函数，不用管父类的调用逻辑，也最好不要调用父类的函数。该原则用来理清流程很方便，只需要看父类即可，但实际编程过程中可能也会遇到子类不可避免的会调用父类的一些公共函数的情况，Shaun 觉得只要流程没问题的话，调用父类函数也能接受，并不需要严格遵守模式。</p><h3 id="迭代器模式">迭代器模式</h3><p>　　迭代器，即对遍历进行封装，一般只能顺序执行，提供 next() 方法获取下一个元素，集合容器的遍历方式一般都会用迭代器进行封装。Shaun 在这一个半项目里没写过迭代器，毕竟这是非常底层的一个模式，语言库本身有的数据结构大多自己实现了迭代器，除非需要设计一个新的集合或容器数据结构，才需要提供相应的迭代器。因为 js 没有 SortedMap 数据结构，为了高效分配路网元素 id，Shaun 利用 object 简单实现了一个，提供了相应的 forEach 方法。</p><p>　　迭代器模式涉及到的原则有：单一责任原则。即一类只做一件事，这个原则对于涉及最最底层的接口很实用，而大多具体类很难只做一件事。迭代器模式对于顺序访问来说还是非常有用的，毕竟使用迭代器的人不需要管底层到底用的什么数据结构，反正可以顺序遍历即可。</p><h3 id="组合模式">组合模式</h3><p>　　组合模式与其说是一种模式，更不如说就是一颗树，只是树的节点都是可供继承的类。在标准的组合模式中，父类中一定会有全部子类的全部函数，即所有子类的函数要么是继承自父类，要么是重写父类函数的，这其实是违背上面单一责任原则的，因为这必然会造成有些子类不需要这么多函数。而从组合模式会存储孩子节点这点来看，和装饰者模式有点类似，只不过装饰者只会存一个孩子，而组合模式可能会存多个，当然两者做的事是不一样，只是实现手法类似而已。Shaun 没写过标准的组合模式，如果只要符合树形模式都可认为是组合模式，那在高精地图编辑器中，所有路网元素都会继承一个父类，而道路中又包含车道簇，车道簇中包含车道，这也算组合模式。在 threejs 中有个 Object3D 的基类，所有渲染对象都会继承该类，该类中又包含若干孩子，threejs 计算 Model 矩阵时就是一层层孩子的 Model 矩阵乘下去，直到最后的孩子，结果就是最后 Shader 中的 Model 矩阵。</p><h3 id="状态模式">状态模式</h3><p>　　状态机的状态转移可以说是程序设计中最麻烦的部分之一了，这部分如果写不好的话，根本没法修改维护，同时会造成 bug 频发。在高精地图编辑器中鼠标操作有两类模式，一种是选择模式，另一种是编辑模式，选择模式又分为点选和框选，而编辑模式就非常多了，针对路网的不同元素，编辑模式的具体实现都不会一样，Shaun 首先使用 RxJS 封装了一个鼠标操作类（左键右键中键移动等），后续的鼠标操作都继承自该类，可以算是状态模式的父类，后续的鼠标操作就针对相应的需求实现相应的方法即可，当然其中鼠标操作自身也存在状态转移（左键到右键，左键到鼠标移动等），这些一般都是针对特定需求来的，所以这些小的状态转移一般在鼠标操作内部实现，但需要支持随时从编辑模式到选择模式，这意味着编辑模式编辑到一半的东西都需要支持随时释放，恢复编辑前的样子，这算是一个麻烦的地方，有时忘了释放就会出现问题。</p><p>　　状态模式算是为解决状态转移问题提供一种理想的方案，但其具体实现并不一定要和书上一样，Shaun 在用 C++ 实现时就采用另一套方案，状态类是独立的，控制状态转移的代码都在状态机内，而不是书中这种直接在状态类中控制状态机。好处坏处都有，看具体需求，Shaun 的方式就是状态类和状态机是分离的，状态类不需要管状态机怎么实现的，只需要管当前状态的情况，但需要在状态机中管理状态转移，而书中实现方式状态机的状态转移放到状态类中了，也因此状态类需要依赖状态机。</p><hr><p><em>剩下的模式，Shaun 就没直接写代码实践了，因为大多都需要跨模块实现，有的甚至就是个小项目了，所以就简要谈谈 Shaun 的个人理解</em>。</p><h3 id="代理模式">代理模式</h3><p>　　主要可以用来做权限控制，在模块与模块之间的调用过程中，有时不想要一个模块可以访问另一个模块的全部内容，这时可以使用代理模式，创建一个中间模块，避免两个模块直接调用，同时进行访问控制。代理模式在如今的互联网时代不可避免的会用到，或直接或间接，往最小的说，对象组合也可用来实现代理模式。</p><h3 id="复合模式">复合模式</h3><p>　　将多种模式组合在一起使用，比如 MVC 模式，这种模式与其说是模式，更不如说就是一种架构，一种开发包含客户端系统的通用架构，当然每一层都会有很多模式进行组合，从而造成具体实现差异非常大。</p><h3 id="反模式">反模式</h3><p>　　反模式指的是用“不好的解决方案”去解决一个问题，Shaun 主要想谈谈开发反模式，因为这非常常见。有时候一个解决方案好不好要从多个角度进行衡量，比如现有技术，长期短期，上手难度，开发效率，维护难度等角度，当出现一个新问题时，往往意味着就有解决方案有缺陷，这种缺陷可能很容易弥补，更可能很难，当很难解决时，往往要采用全新的解决方案，这时团队对新解决方案可能都不熟，也没有魄力去采用新解决方案，只能去老解决方案继续强行打补丁，直到最后没法维护，白白浪费了大量的人力和时间，这是非常典型的一种反模式。</p><h3 id="桥接模式">桥接模式</h3><p>　　将抽象接口和实现分开，并独立派生，以支持抽象和实现的同时改变，并相互独立，可适用在需要跨平台跨不同设备的系统上。</p><h3 id="生成器模式">生成器模式</h3><p>　　有点像是模板方法模式和工厂模式的结合版，使用多个步骤创建一个对象，但步骤没有固定顺序，可适用于流程复杂的规划系统中。</p><h3 id="责任链模式">责任链模式</h3><p>　　可以认为是模板方法模式的进阶版，只是模板的步骤方法变成了一个个对象，并且支持步骤的增加和删除，以及更换顺序，一旦某个步骤成功执行，则整个链条终止，可适用于消除显式的 if-else，处理键盘或鼠标事件时，需要针对不同按键触发不同操作，这时可以采用该模式，缺点是链条很长时，要写很多类，导致执行啥很不直观。</p><h3 id="蝇量模式">蝇量模式</h3><p>　　这个模式算是一种优化内存占用的方案，通过牺牲类的独立性来减少内存，更彻底一点就是不创建类，直接用函数调用来处理就行。</p><h3 id="解释器模式">解释器模式</h3><p>　　可用来实现简单语法规则语言的解释器或编译器，每个语法规则都由一个类进行解析，然后组合。</p><h3 id="中介者模式">中介者模式</h3><p>　　可认为是状态模式和代理模式的结合版，不过各个状态可以是不同类，由中介者控制系统流转，集中控制逻辑，使被控制对象解耦，但可能会造成中介者本身非常复杂。</p><h3 id="备忘录模式">备忘录模式</h3><p>　　可用于系统（游戏）存档，存储系统中关键对象的运行状态，通常实现的方案一般是序列化/持久化，为了效率考虑，难的是有时需要增量存档。</p><h3 id="原型模式">原型模式</h3><p>　　js 的原型链应该是原型模式的典型，不仅实现了动态扩展实例，更实现了动态扩展对象，即继承。在高精地图编辑器中，由于需要做自动保存，所以在做序列化和反序列化的同时也简单实现了对象的 clone()，即从当前实例中创建一个完全一样的实例，可认为是 C++ 中的深拷贝。</p><h3 id="访问者模式">访问者模式</h3><p>　　相当于加个中间层，从而以最小的代价修改现有系统（一般是增加一个方法），达到外部可以取得系统内部信息的目的。</p><h2 id="后记">后记</h2><p>　　曾看过这样一句话：抽象能力决定编程能力，Shaun 个人认为，所谓抽象即提炼事物的共同点，这也是设计模式中反复使用接口的原因，接口即一组具体类的共同点，接口中的函数和变量即为这些具体类共有的，虽然具体行为可以不一样，但行为本身总是存在的。而又有这样一句话：程序等于数据结构加算法，Shaun 的理解是，狭义上的程序确实是这样，一段代码解决一个问题，这是程序，多段代码解决一个问题，这也是程序，多段代码解决多个问题，这亦是程序，一个软件，一个系统，一个平台，都是程序，但显然这些程序不是简单的数据结构和算法就能概括的，其内部必然有一套合理的逻辑进行组织，这套逻辑可以称之为“设计模式”，但这个“设计模式”不仅仅是上面谈的这些模式概念。Shaun 认为好的数据结构和算法确实能使程序达到当前最优，但对于一个大型系统或平台来说，这种最优只能是一种局部最优，这对整个系统的全局最优来说可能是微不足道的，而“设计模式”要解决的是怎样使一个系统达到全局最优，怎么合理组织局部最优。面对现代的超大型系统或平台，传统意义上的设计模式也只能达到局部最优，全局最优基本很少有人能驾驭，都是针对特定的业务需要，不断的试错改进优化，逐渐趋于稳定，但这种稳定可能很难抽象，放进其它的业务中，又得花费大量的人力物力去修改。</p><p>　　Shaun 个人对现代大型系统架构的理解就是分层分模块，功能太多分模块，模块太多就分层，一层不够分两层，两层不够分三层，三层不够继续分，根据数据流的处理分层，根据功能的不同分模块，模块内部依靠设计模式进行组织，设计模式调度的就是数据结构与算法。Shaun 目前的设计原则就是：每层一个独立的服务控制模块，每个模块一个对外服务功能（或事件或 socket ），同层的各模块之间尽量保持独立，不相互依赖，若各模块存在共同点，则将共同点抽出来，将其作为公共模块或独立为小层，层与层之间通过服务控制模块进行数据流的传输，除服务控制模块之外，模块之间尽量避免相互通信，即每个模块的对外服务功能一般只对本层服务控制模块提供服务，最好是只负责接收数据。如果系统实在太大，就只能保持纵向分层，横向保证各模块间数据流依次传输，并在特定模块节点上进行上下层的数据传输。</p><p>　　数据结构与算法重不重要？当然重要，数据结构与算法不过关，面试都过不去 ( ╯□╰ )，工作都没有，还何谈什么设计模式，什么架构。设计模式重不重要？当然也重要，不会合理使用设计模式，写出一堆别人没法维护的垃圾代码（当然，这或许是好事 :p ），改个需求要半天，加个功能要半个月，效率太低，这样即使有好的数据结构与算法作用也不大。但是设计模式也不是万能的，针对不同的需求，同一种设计模式有不同的实现方式，所以书中的设计模式也仅供参考而已，与其说设计模式重要，还不如说书中那几个设计原则更重要些。同时一味的追求设计模式也不见得是件好事，设计模式可以参考，但不能生搬硬套，毕竟人是活的，需求也是活的，固定的模式也需要有所改变，总而言之，能以最小的代价解决问题完成需求的模式就是好模式。</p></div><div class="article-content-more"><button type="button" class="article-more--link"><i class="fa fa-angle-double-down fa-3x" aria-hidden="true"></i></button></div></section></article><article id="post-积分计算" class="article div-border"><header class="article-header"><span class="article-date article-title--index"><i class="fa fa-calendar" aria-hidden="true"></i> <a href="/posts/eee1c041.html"><time datetime="2020-11-29T10:28:56.000Z">2020-11-29</time></a></span><section class="article-title article-title--index"><a href="/posts/eee1c041.html">积分计算</a></section><div class="article-label"><div class="article-category label"><i class="fa fa-book" aria-hidden="true"></i> <a class="color2 article-category-link" href="/categories/Mathematics/">Mathematics</a></div><div class="article-tag label"><i class="fa fa-bookmark" aria-hidden="true"></i> <a class="color3 article-tag-none-link" href="/tags/integration/" rel="tag">integration</a><a class="color3 article-tag-none-link" href="/tags/numerical/" rel="tag">numerical</a></div></div></header><section class="article-content"><div class="article-content--excerpt"><h2 id="前言">前言</h2><p>　　最近需要计算一下曲线长度，无法直接得到被积函数的原函数，常规的积分解法牛顿莱布尼茨公式没法使用，所以只能使用数值积分计算积分。</p></div><div class="article-content--all"><h2 id="前言">前言</h2><p>　　最近需要计算一下曲线长度，无法直接得到被积函数的原函数，常规的积分解法牛顿莱布尼茨公式没法使用，所以只能使用数值积分计算积分。</p><span id="more"></span><p>　　下面主要介绍两种数值积分方法：龙贝格积分（Romberg Quadrature） 和 高斯-克朗罗德积分（Gauss-kronrod Quadrature）。 <em>下面附带的代码只做简单测试，不保证正确性，语言使用 Typescript。</em></p><h2 id="romberg-篇">Romberg 篇</h2><p>　　计算积分最简单的当然是使用复化梯形公式，即 <span class="math inline">\(I=\int_a^b{f(x)dx}=\frac{b-a}{2n}[f(a)+f(b)+2\sum\limits_{i=1}^{n-1}f(x_i)]= T_n,　x_i=a+i*h, h=(b-a)/n\)</span> ，若将 n 段每段一分为 2，可得到 <span class="math inline">\(T_{2n}=T_n/2+\frac{b-a}{2n}\sum\limits_{i=0}^{n-1}f(x_{i+1/2})\)</span> 。考虑数列 <span class="math inline">\(T=\{T_1,T_2,T_{2^2},...,T_{2^k}\}\)</span>，显然该数列必收敛，最后收敛为对应积分，当 <span class="math inline">\(|T_{2^k}-T_{2^{k-1}}| &lt; ε\)</span> （<span class="math inline">\(ε\)</span> 为精度）时，可取 <span class="math inline">\(T_{2^k}\)</span> 作为最后的积分结果。但是，直接利用梯形公司求解，收敛很慢，导致计算效率很差，所以需要使用理查德森（Richardson）外推法加速收敛，设 <span class="math inline">\(T_{2^k}^{(m)}\)</span> 为 m 次加速值，当 m 为 0 时，表示没加速，为原梯形公司，则 <span class="math inline">\(T_{2^k}^{(m)} = \frac{4^m}{4^m-1}T_{2^{k+1}}^{(m-1)}-\frac{1}{4^m-1}T_{2^k}^{(m-1)}\)</span>，当 <span class="math inline">\(|T_{2^{k+1}}^{(m)}-T_{2^k}^{(m)}| &lt; ε\)</span> 时，则收敛，并取其中一值作为最终的积分值。未经修饰的代码如下：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="TYPESCRIPT"><div class="code-copy"></div><figure class="highlight hljs typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rombergIntegrator</span>(<span class="params">f: (x: <span class="built_in">number</span>) =&gt; <span class="built_in">number</span>, a: <span class="built_in">number</span>, b: <span class="built_in">number</span>, tolerance = <span class="number">1e-8</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> h = b - a;</span><br><span class="line">    <span class="keyword">let</span> n = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">let</span> preTK = ((f(a) + f(b)) * h) / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> tkmArray = [];</span><br><span class="line">    <span class="keyword">let</span> m = <span class="number">0</span>;</span><br><span class="line">    tkmArray[m] = preTK;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        m += <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">console</span>.log(m, tkmArray[m - <span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> tk = getTK(f, preTK, n, a, h);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">Math</span>.abs(tk - preTK) &lt; tolerance) <span class="keyword">return</span> tk;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> preTKM = tkmArray[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">let</span> preTK1M = tk;</span><br><span class="line">        tkmArray[<span class="number">0</span>] = tk;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt;= m; i++) &#123;</span><br><span class="line">            <span class="keyword">let</span> newTKM = getTKM(preTK1M, preTKM, i);</span><br><span class="line">            preTKM = tkmArray[i];</span><br><span class="line">            preTK1M = newTKM;</span><br><span class="line">            tkmArray[i] = newTKM;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (preTKM !== <span class="literal">undefined</span> &amp;&amp; <span class="built_in">Math</span>.abs(preTK1M - preTKM) &lt; tolerance) <span class="keyword">return</span> preTK1M;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        preTK = tk;</span><br><span class="line">        n *= <span class="number">2</span>;</span><br><span class="line">        h /= <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getTK</span>(<span class="params">f: (x: <span class="built_in">number</span>) =&gt; <span class="built_in">number</span>, preTK: <span class="built_in">number</span>, n: <span class="built_in">number</span>, a: <span class="built_in">number</span>, h: <span class="built_in">number</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> sum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">let</span> x = a + (i + <span class="number">0.5</span>) * h;</span><br><span class="line">            sum += f(x);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (preTK + h * sum) / <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getTKM</span>(<span class="params">preTK1M: <span class="built_in">number</span>, preTKM: <span class="built_in">number</span>, m = <span class="number">0</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> m4 = <span class="number">1</span> &lt;&lt; (<span class="number">2</span> * m); <span class="comment">// 4 ** m;</span></span><br><span class="line">        <span class="keyword">return</span> (m4 * preTK1M - preTKM) / (m4 - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>　　由于采用闭型积分规则（积分上下限值参与积分计算），所以以上代码不适合计算两端点值被积函数值无限大的情况（如 1/4 圆弧积分等）。而且该方法不合适求取被积函数在积分区间内导数值变化较大（如被积函数在积分下限附近剧烈波动，在积分上限附近不变化等）的积分，因为该方法是均匀分段，这种情况将导致计算量剧增，这时就需要用到下面的自适应积分。</p><h2 id="自适应篇">自适应篇</h2><p>　　自适应积分主要包括两类：全局自适应积分和局部自适应积分，通常情况下全局自适应积分的会比局部自适应积分的表现要好，全局自适应积分一般通过二分递归实现，当满足一定条件时，递归终止，即通过二分分别计算两边的积分，若一边满足一定条件，则不继续划分，从而减少计算量。全局自适应积分中比较经典的有基于辛普森（Simpson）公式的自适应算法，普通辛普森积分公式为：<span class="math inline">\(I=\int_a^b{f(x)dx}=\frac{b-a}{6}[f(a)+4f(m)+f(b)]= S(a,b),　m=(a+b)/2\)</span>，复化辛普森公式为 <span class="math inline">\(I=\int_a^b{f(x)dx}=\frac{h}{3}[f(a)+4\sum\limits_{i=1}^{n}f(x_{2i-1})+2\sum\limits_{i=1}^{n-1}f(x_{2i})+f(b)]= S(a,b)\)</span>，其中 <span class="math inline">\(x_i=a+i*h　(i=1,2,3,...,2n),h=\frac{b-a}{2n}\)</span>，基于辛普森公式的自适应基本原理如下：令 <span class="math inline">\(S_2(a,b) = S(a,m)+S(m,b)\)</span>，m 为 a,b 中值，若 <span class="math inline">\(|S(a,b) - S_2(a,b)| &lt; 15ε\)</span>，则取 <span class="math inline">\(S_2(a,b)\)</span> 或 <span class="math inline">\(S_2(a,b)+(S(a,b)-S_2(a,b))/15\)</span> 作为该区间的积分值，否则，将区间二分递归，同时因为误差会累积，所以每次递归都需要将精度提高两倍，即 <span class="math inline">\(ε = ε/2\)</span>，如此最后的精度才能达到最初的精度。具体 ts 代码如下：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="TYPESCRIPT"><div class="code-copy"></div><figure class="highlight hljs typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">adaptiveSimpsonIntegrator</span>(<span class="params">f: (x: <span class="built_in">number</span>) =&gt; <span class="built_in">number</span>, a: <span class="built_in">number</span>, b: <span class="built_in">number</span>, epsilon = <span class="number">1e-8</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> S = complexSimpson(f, a, b);</span><br><span class="line">    <span class="keyword">return</span> adsimp(f, a, b, epsilon, S);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">adsimp</span>(<span class="params">f: (x: <span class="built_in">number</span>) =&gt; <span class="built_in">number</span>, a: <span class="built_in">number</span>, b: <span class="built_in">number</span>, epsilon = <span class="number">1e-8</span>, S = <span class="number">0</span></span>): <span class="title">number</span> </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> m = a + (b - a) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">let</span> LS = complexSimpson(f, a, m);</span><br><span class="line">        <span class="keyword">let</span> RS = complexSimpson(f, m, b);</span><br><span class="line">        <span class="keyword">const</span> S2 = LS + RS;</span><br><span class="line">        <span class="keyword">const</span> tolerance = <span class="number">15</span> * epsilon;</span><br><span class="line">        <span class="keyword">let</span> delta = S - S2;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">Math</span>.abs(delta) &lt; tolerance) <span class="keyword">return</span> S2 + delta / <span class="number">15</span>;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> doubleEPS = epsilon / <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">return</span> adsimp(f, a, m, doubleEPS, LS) + adsimp(f, m, b, doubleEPS, RS);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">complexSimpson</span>(<span class="params">f: (x: <span class="built_in">number</span>) =&gt; <span class="built_in">number</span>, a: <span class="built_in">number</span>, b: <span class="built_in">number</span>, n = <span class="number">1</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> n2 = n * <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">const</span> h = (b - a) / n2;</span><br><span class="line">        <span class="keyword">let</span> sum = f(a) + f(b);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt; n2; i += <span class="number">2</span>) &#123;</span><br><span class="line">            sum += <span class="number">4</span> * f(a + i * h);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">2</span>; i &lt; n2 - <span class="number">1</span>; i += <span class="number">2</span>) &#123;</span><br><span class="line">            sum += <span class="number">2</span> * f(a + i * h);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (sum * h) / <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>　　在 D.V. Fedorov 写的「Introduction to Numerical Methods with examples in Javascript」一书中介绍了一种全局自适应方法，即分别使用高阶和低阶的权值分别计算积分，两者之间的差值 <span class="math inline">\(E\)</span> 作为误差估计，设绝对精度为 <span class="math inline">\(\delta\)</span> ，相对精度为 <span class="math inline">\(\epsilon\)</span> ，若 <span class="math inline">\(|E|&lt;\delta+\epsilon*Q\)</span>，Q 为高阶权值计算的积分，则取 Q 作为积分值，否则将积分区间二分，同时使 <span class="math inline">\(\delta/\sqrt{2}\)</span>，<span class="math inline">\(\epsilon\)</span> 保持不变。具体 ts 代码如下：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="TYPESCRIPT"><div class="code-copy"></div><figure class="highlight hljs typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">recursiveAdaptiveIntegrator</span>(<span class="params">f: (x: <span class="built_in">number</span>) =&gt; <span class="built_in">number</span>, a: <span class="built_in">number</span>, b: <span class="built_in">number</span>, accuracy = <span class="number">1e-15</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> recursiveAdaptiveIntegrate(f, a, b, accuracy);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">recursiveAdaptiveIntegrate</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        f: (x: <span class="built_in">number</span>) =&gt; <span class="built_in">number</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        a: <span class="built_in">number</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        b: <span class="built_in">number</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        accuracy = <span class="number">1e-15</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        epsilon = <span class="built_in">Number</span>.EPSILON,</span></span></span><br><span class="line"><span class="params"><span class="function">        preFValue?: <span class="built_in">number</span>[],</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>): <span class="title">number</span> </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> abscissae = [<span class="number">1</span> / <span class="number">6</span>, <span class="number">2</span> / <span class="number">6</span>, <span class="number">4</span> / <span class="number">6</span>, <span class="number">5</span> / <span class="number">6</span>];</span><br><span class="line">        <span class="keyword">const</span> highOrderWeights = [<span class="number">2</span> / <span class="number">6</span>, <span class="number">1</span> / <span class="number">6</span>, <span class="number">1</span> / <span class="number">6</span>, <span class="number">2</span> / <span class="number">6</span>];</span><br><span class="line">        <span class="keyword">const</span> lowOrderWeights = [<span class="number">1</span> / <span class="number">4</span>, <span class="number">1</span> / <span class="number">4</span>, <span class="number">1</span> / <span class="number">4</span>, <span class="number">1</span> / <span class="number">4</span>];</span><br><span class="line">        <span class="keyword">const</span> isRecompute = [<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">const</span> h = b - a;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> fValue: <span class="built_in">number</span>[] = [];</span><br><span class="line">        <span class="keyword">if</span> (preFValue === <span class="literal">undefined</span>) &#123;</span><br><span class="line">            abscissae.forEach(<span class="function">(<span class="params">abscissa</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> x = a + abscissa * h;</span><br><span class="line">                fValue.push(f(x));</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> k = <span class="number">0</span>, i = <span class="number">0</span>; i &lt; abscissae.length; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isRecompute[i]) fValue.push(f(a + abscissae[i] * h));</span><br><span class="line">                <span class="keyword">else</span> fValue.push(preFValue[k++]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> highResult = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">let</span> lowResult = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; highOrderWeights.length; i++) &#123;</span><br><span class="line">            highResult += highOrderWeights[i] * fValue[i];</span><br><span class="line">            lowResult += lowOrderWeights[i] * fValue[i];</span><br><span class="line">        &#125;</span><br><span class="line">        highResult *= h;</span><br><span class="line">        lowResult *= h;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> tolerance = accuracy + epsilon * <span class="built_in">Math</span>.abs(highResult);</span><br><span class="line">        <span class="keyword">let</span> errorEstimate = <span class="built_in">Math</span>.abs(highResult - lowResult) / <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">if</span> (errorEstimate &lt; tolerance) &#123;</span><br><span class="line">            <span class="keyword">return</span> highResult;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            accuracy /= <span class="built_in">Math</span>.sqrt(<span class="number">2</span>);</span><br><span class="line">            <span class="keyword">let</span> m = a + h / <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">let</span> midIndex = <span class="built_in">Math</span>.trunc(abscissae.length / <span class="number">2</span>);</span><br><span class="line">            <span class="keyword">let</span> leftFValue = fValue.slice(<span class="number">0</span>, midIndex);</span><br><span class="line">            <span class="keyword">let</span> rightFValue = fValue.slice(midIndex);</span><br><span class="line">            <span class="keyword">return</span> (</span><br><span class="line">                recursiveAdaptiveIntegrate(f, a, m, accuracy, epsilon, leftFValue) +</span><br><span class="line">                recursiveAdaptiveIntegrate(f, m, b, accuracy, epsilon, rightFValue)</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>　　该方法很巧妙的设计了一组插值点，使得当前计算的函数值正好可以被下次迭代所使用，从而提高性能，同时该方法可以得到 1/4 圆弧长，虽然精度只能到小数点后 8 位，至于 Shaun 写的其它测试函数，都能得到理想精度。</p><h2 id="gauss-篇">Gauss 篇</h2><p>　　高斯求积法是一种多项式插值积分法，同时由于不计算被积函数在区间两个端点处的值，所以高斯积分法采用的开型积分规则，高斯积分法的衍生方法有很多种，下面主要介绍高斯-勒让德（Gauss-Legendre Quadrature）以及其迭代改良的高斯-克朗罗德法。高斯-勒让德积分法的公式为积分的原始形态，即 <span class="math inline">\(\int_a^bf(x)dx=\sum\limits_{i=1}^{∞}w_if(x_{i})\approx\sum\limits_{i=1}^{n}w_if(x_{i})\)</span> ，只不过 <span class="math inline">\(x_i \in [-1,1]\)</span>，并且 <span class="math inline">\(x_i\)</span> 和 <span class="math inline">\(w_i\)</span> 都通过勒让德多项式求出，所以其原则上只能用在积分区间为 [-1, 1] 上的积分，但是可以将积分从任意区间通过简单的变形变换到 [-1, 1] 上，即 <span class="math inline">\(\int_a^b{f(x)dx} = \frac{b-a}{2}\int_{-1}^1{f(\frac{b-a}{2}t+\frac{b+a}{2})dt}\)</span> ，从而可以将高斯-勒让德方法扩展到任意积分上。由于每个 n 对应的 <span class="math inline">\(x_i\)</span> 和 <span class="math inline">\(w_i\)</span> 都可以查表可得，所以具体代码方面就很简单了，以 n = 4，即插值点个数为 4 为例，ts 代码如下：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="TYPESCRIPT"><div class="code-copy"></div><figure class="highlight hljs typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gaussLegendreIntegrate</span>(<span class="params">f: (x: <span class="built_in">number</span>) =&gt; <span class="built_in">number</span>, a: <span class="built_in">number</span>, b: <span class="built_in">number</span>, n: <span class="number">4</span> | <span class="number">8</span> = <span class="number">4</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> weightsAndAbscissae = getWeightsAndAbscissae(n);</span><br><span class="line">    <span class="keyword">const</span> weights = weightsAndAbscissae.weights;</span><br><span class="line">    <span class="keyword">const</span> abscissae = weightsAndAbscissae.abscissae;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> halfH = (b - a) / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; abscissae.length; i++) &#123;</span><br><span class="line">        <span class="keyword">let</span> xi = halfH * abscissae[i] + a + halfH;</span><br><span class="line">        sum += weights[i] * f(xi);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sum * halfH;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getWeightsAndAbscissae</span>(<span class="params">n: <span class="number">4</span> | <span class="number">8</span> = <span class="number">4</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (n) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    <span class="attr">weights</span>: [</span><br><span class="line">                        <span class="number">0.362683783378362</span>,</span><br><span class="line">                        <span class="number">0.362683783378362</span>,</span><br><span class="line">                        <span class="number">0.3137066458778873</span>,</span><br><span class="line">                        <span class="number">0.3137066458778873</span>,</span><br><span class="line">                        <span class="number">0.2223810344533745</span>,</span><br><span class="line">                        <span class="number">0.2223810344533745</span>,</span><br><span class="line">                        <span class="number">0.1012285362903763</span>,</span><br><span class="line">                        <span class="number">0.1012285362903763</span>,</span><br><span class="line">                    ],</span><br><span class="line">                    <span class="attr">abscissae</span>: [</span><br><span class="line">                        -<span class="number">0.1834346424956498</span>,</span><br><span class="line">                        <span class="number">0.1834346424956498</span>,</span><br><span class="line">                        -<span class="number">0.525532409916329</span>,</span><br><span class="line">                        <span class="number">0.525532409916329</span>,</span><br><span class="line">                        -<span class="number">0.7966664774136267</span>,</span><br><span class="line">                        <span class="number">0.7966664774136267</span>,</span><br><span class="line">                        -<span class="number">0.9602898564975363</span>,</span><br><span class="line">                        <span class="number">0.9602898564975363</span>,</span><br><span class="line">                    ],</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    <span class="attr">weights</span>: [<span class="number">0.6521451548625461</span>, <span class="number">0.6521451548625461</span>, <span class="number">0.3478548451374538</span>, <span class="number">0.3478548451374538</span>],</span><br><span class="line">                    <span class="attr">abscissae</span>: [-<span class="number">0.3399810435848563</span>, <span class="number">0.3399810435848563</span>, -<span class="number">0.8611363115940526</span>, <span class="number">0.8611363115940526</span>],</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>　　若要提高高斯-勒让德积分法的精度，可通过增加插值点或分多个区间进行积分来实现，但是由于没有误差估计，所以还是没法精确控制精度，对与某些被积函数积分精度高，但对于其它被积函数，积分精度却有限，当然可以简单的引入一些常用的误差估计法，但一般需要重新计算积分，导致效率很低，而高斯-克朗罗德法为其引入了一种基于 Kronrod 点的误差估计法，可充分利用现有计算值，从而达到有效控制精度的同时，性能没有太大的损失。设 <span class="math inline">\(G(f,n)=\sum\limits_{i=1}^{n}w_if(x_{i})\)</span> 为具有 n 个插值点的高斯-勒让德法计算结果，<span class="math inline">\(GK(f,n) = \sum\limits_{i=1}^{n}w&#39;_if(x_{i})+\sum\limits_{k=n+1}^{2n+1}w&#39;_kf(x_{k})\)</span> 为高斯-克朗罗德法的计算结果，则 <span class="math inline">\(|GK(f,n)-G(f,n)|\)</span> 可作为误差估计，有了误差估计，最后再使用全局自适应策略，即可得到精度可控的高斯积分结果。具体 ts 代码如下，以 n = 7 为例：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="TYPESCRIPT"><div class="code-copy"></div><figure class="highlight hljs typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gaussKronrodIntegrator</span>(<span class="params">f: (x: <span class="built_in">number</span>) =&gt; <span class="built_in">number</span>, a: <span class="built_in">number</span>, b: <span class="built_in">number</span>, accuracy = <span class="number">1e-15</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> recursiveAdaptiveIntegrate(f, a, b, accuracy);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">recursiveAdaptiveIntegrate</span>(<span class="params">f: (x: <span class="built_in">number</span>) =&gt; <span class="built_in">number</span>, a: <span class="built_in">number</span>, b: <span class="built_in">number</span>, accuracy = <span class="number">1e-12</span></span>): <span class="title">number</span> </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> gaussAbscissae = [</span><br><span class="line">            <span class="number">0.0</span>,</span><br><span class="line">            -<span class="number">4.058451513773971669066064120769615e-1</span>,</span><br><span class="line">            <span class="number">4.058451513773971669066064120769615e-1</span>,</span><br><span class="line">            -<span class="number">7.415311855993944398638647732807884e-1</span>,</span><br><span class="line">            <span class="number">7.415311855993944398638647732807884e-1</span>,</span><br><span class="line">            -<span class="number">9.491079123427585245261896840478513e-1</span>,</span><br><span class="line">            <span class="number">9.491079123427585245261896840478513e-1</span>,</span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">const</span> gaussWeights = [</span><br><span class="line">            <span class="number">4.179591836734693877551020408163265e-1</span>,</span><br><span class="line">            <span class="number">3.818300505051189449503697754889751e-1</span>,</span><br><span class="line">            <span class="number">3.818300505051189449503697754889751e-1</span>,</span><br><span class="line">            <span class="number">2.797053914892766679014677714237796e-1</span>,</span><br><span class="line">            <span class="number">2.797053914892766679014677714237796e-1</span>,</span><br><span class="line">            <span class="number">1.29484966168869693270611432679082e-1</span>,</span><br><span class="line">            <span class="number">1.29484966168869693270611432679082e-1</span>,</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> kronrodAbscissae = gaussAbscissae.concat([</span><br><span class="line">            -<span class="number">2.077849550078984676006894037732449e-1</span>,</span><br><span class="line">            <span class="number">2.077849550078984676006894037732449e-1</span>,</span><br><span class="line">            -<span class="number">5.860872354676911302941448382587296e-1</span>,</span><br><span class="line">            <span class="number">5.860872354676911302941448382587296e-1</span>,</span><br><span class="line">            -<span class="number">8.648644233597690727897127886409262e-1</span>,</span><br><span class="line">            <span class="number">8.648644233597690727897127886409262e-1</span>,</span><br><span class="line">            -<span class="number">9.914553711208126392068546975263285e-1</span>,</span><br><span class="line">            <span class="number">9.914553711208126392068546975263285e-1</span>,</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> kronrodWeights = [</span><br><span class="line">            <span class="number">2.094821410847278280129991748917143e-1</span>,</span><br><span class="line">            <span class="number">1.903505780647854099132564024210137e-1</span>,</span><br><span class="line">            <span class="number">1.903505780647854099132564024210137e-1</span>,</span><br><span class="line">            <span class="number">1.406532597155259187451895905102379e-1</span>,</span><br><span class="line">            <span class="number">1.406532597155259187451895905102379e-1</span>,</span><br><span class="line">            <span class="number">6.309209262997855329070066318920429e-2</span>,</span><br><span class="line">            <span class="number">6.309209262997855329070066318920429e-2</span>,</span><br><span class="line">            <span class="number">2.044329400752988924141619992346491e-1</span>,</span><br><span class="line">            <span class="number">2.044329400752988924141619992346491e-1</span>,</span><br><span class="line">            <span class="number">1.690047266392679028265834265985503e-1</span>,</span><br><span class="line">            <span class="number">1.690047266392679028265834265985503e-1</span>,</span><br><span class="line">            <span class="number">1.04790010322250183839876322541518e-1</span>,</span><br><span class="line">            <span class="number">1.04790010322250183839876322541518e-1</span>,</span><br><span class="line">            <span class="number">2.293532201052922496373200805896959e-2</span>,</span><br><span class="line">            <span class="number">2.293532201052922496373200805896959e-2</span>,</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> halfH = (b - a) / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> guassResult = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">let</span> kronrodResult = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; gaussAbscissae.length; i++) &#123;</span><br><span class="line">            <span class="keyword">let</span> xi = halfH * gaussAbscissae[i] + a + halfH;</span><br><span class="line">            <span class="keyword">let</span> yi = f(xi);</span><br><span class="line">            guassResult += gaussWeights[i] * yi;</span><br><span class="line">            kronrodResult += kronrodWeights[i] * yi;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = gaussAbscissae.length; i &lt; kronrodAbscissae.length; i++) &#123;</span><br><span class="line">            <span class="keyword">let</span> xi = halfH * kronrodAbscissae[i] + a + halfH;</span><br><span class="line">            <span class="keyword">let</span> yi = f(xi);</span><br><span class="line">            kronrodResult += kronrodWeights[i] * yi;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">Math</span>.abs(kronrodResult - guassResult) &lt; accuracy / halfH) <span class="keyword">return</span> kronrodResult * halfH;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> m = a + (b - a) / <span class="number">2</span>;</span><br><span class="line">            accuracy /= <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">return</span> recursiveAdaptiveIntegrate(f, a, m, accuracy) + recursiveAdaptiveIntegrate(f, m, b, accuracy);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>　　简单测试了一下，Shaun 这里写的 gaussKronrodIntegrator 方法最大精度只能到 1e-15，到 16 位就报错递归深度太大了，圆的 1/4 弧长也没法算出来，当然这些问题可通过设置最大递归深度以及处理异常值来解决，Shaun 这里就不继续写了。</p><h2 id="后记">后记</h2><p>　　数值积分策略非常多，尤其是针对一些特殊的函数，可能只能使用一些特殊的策略才能计算，Shaun 这里只是介绍了一些比较基础常用的积分方法，能解决大部分积分问题，唯一需要注意一点的就是如何追求性能与精度之间的平衡，因为积分常常涉及到迭代求值，通常而言精度越高，迭代越多，求积时，同时也需要注意被积函数的异常值（如无穷大等），这时可能需要拆分或变换积分区间，并且使用开型积分规则的积分方法进行重新计算。</p><h2 id="附录">附录</h2><h3 id="一些常见的积分变换">一些常见的积分变换</h3><p><span class="math display">\[ \int_a^bf(x) = \int_0^{b-a}f(a+t)dt \\ \int_a^b{f(x)dx} = \frac{b-a}{2}\int_{-1}^1{f(\frac{b-a}{2}t+\frac{b+a}{2})dt} \\ \int_{-∞}^{+∞}{f(x)dx} = \int_{-1}^1{f(\frac{t}{1-t^2})\frac{1+t^2}{(1-t^2)^2}dt} \\ \int_{a}^{+∞}{f(x)dx} = \int_{0}^1{f(a + \frac{t}{1-t})\frac{1}{(1-t)^2}dt} \\ \int_{-∞}^{a}{f(x)dx} = \int_{-1}^0{f(a + \frac{t}{1+t})\frac{-1}{(1+t)^2}dt} \]</span></p><h2 id="参考资料">参考资料</h2><p>[1] <a target="_blank" rel="noopener" href="https://reference.wolfram.com/language/tutorial/NIntegrateIntegrationStrategies.html#155948475">积分策略</a></p><p>[2] <a target="_blank" rel="noopener" href="https://pomax.github.io/bezierinfo/legendre-gauss.html">Gaussian Quadrature Weights and Abscissae</a></p><p>[3] <a target="_blank" rel="noopener" href="https://www.boost.org/doc/libs/release/libs/math/doc/html/math_toolkit/gauss_kronrod.html">Gauss-Kronrod Quadrature</a></p><p>[4] <a target="_blank" rel="noopener" href="https://www.advanpix.com/2011/11/07/gauss-kronrod-quadrature-nodes-weights/">Gauss-Kronrod Quadrature Nodes and Weights</a></p></div><div class="article-content-more"><button type="button" class="article-more--link"><i class="fa fa-angle-double-down fa-3x" aria-hidden="true"></i></button></div></section></article><nav id="pagination--nav" class="text-center"><a class="extend prev" rel="prev" href="/">&lt;&lt; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/3/">Next &gt;&gt;</a></nav></main><div id="site-tool"><div class="scroll"><a href="#header"><i class="fa fa-arrow-up"></i></a> <a href="#footer"><i class="fa fa-arrow-down"></i></a></div><div></div></div><aside id="right-col" class="col-lg-3 col-sm-12"><div id="sidebar-sticky--bottom"></div><div id="sidebar"><header class="author-info div-border"><a href="/"><img class="header-avatar" src="/img/avatar.jpg"></a><h1 class="header-author"><a href="/" title="Hi Mate" data-toggle="tooltip">Shaun</a></h1><p class="header-slogan">求知！ 视界！ 未来！ ↖(^ω^)↗</p><div class="social-info"><a class="social-icon" target="_blank" href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=qNvAyd3G0d3JxujOx9DFycHEhsvHxQ" title="envelope" data-toggle="tooltip"><i class="fa fa-envelope" aria-hidden="true"></i> </a><a class="social-icon" target="_blank" href="https://github.com/cniter" title="github" data-toggle="tooltip"><i class="fa fa-github" aria-hidden="true"></i> </a><a class="social-icon" target="_blank" href="/atom.xml" title="rss" data-toggle="tooltip"><i class="fa fa-rss" aria-hidden="true"></i> </a><a class="social-icon" target="_blank" href="http://sighttp.qq.com/authd?IDKEY=4faf682653b3b7f5f47b9cb6d2bb8b81de8fa7a8fb8cee12" title="qq" data-toggle="tooltip"><i class="fa fa-qq" aria-hidden="true"></i></a></div></header><div class="search div-border" title="搜索" data-toggle="tooltip"><form id="search-form"><input type="text" id="local-search--input" name="q" results="0" placeholder=" Search..." autocomplete="off" autocorrect="off"> <i class="fa fa-times" onclick="resetSearch()"></i></form><div id="local-search--result"></div><p class="no-result">No results found</p></div><div id="tagcloud" class="tagcanvas div-border" title="标签" data-toggle="tooltip"><canvas width="200" height="200" id="tagcloud-canvas"><p>Anything in here will be replaced on browsers that support the canvas element</p><ul><li><a href="/tags/algorithm/" data-weight="8">algorithm</a></li><li><a href="/tags/android/" data-weight="2">android</a></li><li><a href="/tags/bigdata/" data-weight="2">bigdata</a></li><li><a href="/tags/c-cpp/" data-weight="6">c/cpp</a></li><li><a href="/tags/clustering/" data-weight="1">clustering</a></li><li><a href="/tags/container/" data-weight="1">container</a></li><li><a href="/tags/css/" data-weight="1">css</a></li><li><a href="/tags/cv/" data-weight="5">cv</a></li><li><a href="/tags/devtool/" data-weight="1">devtool</a></li><li><a href="/tags/ffmpeg/" data-weight="1">ffmpeg</a></li><li><a href="/tags/geomesa/" data-weight="1">geomesa</a></li><li><a href="/tags/geometry/" data-weight="4">geometry</a></li><li><a href="/tags/gfw/" data-weight="1">gfw</a></li><li><a href="/tags/github/" data-weight="1">github</a></li><li><a href="/tags/gl/" data-weight="1">gl</a></li><li><a href="/tags/golang/" data-weight="2">golang</a></li><li><a href="/tags/hexo/" data-weight="8">hexo</a></li><li><a href="/tags/http/" data-weight="1">http</a></li><li><a href="/tags/integration/" data-weight="1">integration</a></li><li><a href="/tags/java/" data-weight="2">java</a></li><li><a href="/tags/k8s/" data-weight="1">k8s</a></li><li><a href="/tags/language/" data-weight="3">language</a></li><li><a href="/tags/latex/" data-weight="1">latex</a></li><li><a href="/tags/mapbox/" data-weight="1">mapbox</a></li><li><a href="/tags/markdown/" data-weight="1">markdown</a></li><li><a href="/tags/matlab/" data-weight="2">matlab</a></li><li><a href="/tags/network/" data-weight="1">network</a></li><li><a href="/tags/note/" data-weight="7">note</a></li><li><a href="/tags/numerical/" data-weight="1">numerical</a></li><li><a href="/tags/opencv/" data-weight="11">opencv</a></li><li><a href="/tags/opendrive/" data-weight="1">opendrive</a></li><li><a href="/tags/opengl/" data-weight="1">opengl</a></li><li><a href="/tags/python/" data-weight="1">python</a></li><li><a href="/tags/qt/" data-weight="2">qt</a></li><li><a href="/tags/record/" data-weight="14">record</a></li><li><a href="/tags/search/" data-weight="1">search</a></li><li><a href="/tags/segmentation/" data-weight="2">segmentation</a></li><li><a href="/tags/tensorflow/" data-weight="1">tensorflow</a></li><li><a href="/tags/thought/" data-weight="3">thought</a></li><li><a href="/tags/unix-like/" data-weight="3">unix-like</a></li><li><a href="/tags/vscode/" data-weight="1">vscode</a></li></ul></canvas><script src="/plugins/TagCanvas/jquery.tagcanvas.min.js" type="text/javascript"></script><script type="text/javascript">$(document).ready((function(){$("#tagcloud-canvas").tagcanvas({initial:[.1,-.1],activeCursor:'url("/img/cursor/link.cur"), auto',reverse:!0,depth:.75,weight:!0,weightFrom:"data-weight",weightMode:"both",weightSizeMin:15,weightSizeMax:50})||$("#tagcloud").hide()}))</script></div><div class="friends div-border" title="友链" data-toggle="tooltip"><a target="_blank" class="friends-link" href="https://cniter.github.io">Shaun&#39;s Space</a></div><div class="revolvermaps div-border" title="访客" data-toggle="tooltip"><a target="_blank" rel="noopener" href="http://livetrafficfeed.com/3d-visitor-maps" id="LTF_3d_maps">Live 3D Globes Visitor</a><script type="text/javascript" src="//cdn.livetrafficfeed.com/static/3d-maps/live.js?o=000080&amp;l=339966&amp;b=339966&amp;c=ff0000&amp;root=1&amp;timezone=Asia%2FShanghai&amp;s=" async></script></div></div><div class="toc-card"><div class="toc-card--head"><i class="fa fa-angle-up" aria-hidden="true"></i></div><div id="toc" class="toc-card--content"><strong class="toc-title">文章列表</strong><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/posts/36b343ff.html">HTTP 超时浅见</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/6be57d7f.html">关于中学的学习方法</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/619020f7.html">VNSWRR 算法浅解</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/2eb69b33.html">记一次资源不释放的问题</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/dbbe01e5.html">社畜三年，风雨兼程</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/8e1d1e1d.html">2021 年小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/4b1f50ff.html">M1 个人配置</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/9c9b4035.html">Scala 多线程编程小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/720275bd.html">Google S2 Geometry 浅解</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/55e674ff.html">K8S 应用开发指北</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/81321445.html">OpenGL坐标系统与渲染管线</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/8d3d87a2.html">Scala 学习小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/28416d7c.html">2020年小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/b59e3e7b.html">Linux服务器运维文档</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/489fa7b3.html">时空查询之ECQL</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/9978824c.html">GeoMesa踩坑指北</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/3692cd6.html">IDEA使用Docker环境开发调试</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/af5e9ace.html">大数据环境搭建笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/ae780057.html">设计模式浅谈</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/eee1c041.html">积分计算</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/a5661762.html">Geometry增量更新</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/e225d8fd.html">Mapbox显示GeoServer地图</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/3d8ab974.html">Docker使用小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/6694a214.html">空间中三角形与三角形相交</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/5315fcfd.html">计算几何基础</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/b7d79231.html">OpenDrive解析小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/39a3c99e.html">一张纹理做天空盒</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/a250bb21.html">Windows Terminal 尝鲜小记</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/ae5f9dce.html">读大学</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/cf97ba7c.html">2019，既是结束又是开始</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/ff29de94.html">快速判断三角形与长方体相交</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/70a807da.html">网页菜单纯 css 实现</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/abe58f8c.html">个人游记</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/26d437be.html">hexo-theme-chi主题更新小记</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/3578e309.html">［译］为什么深度学习没有取代传统的计算机视觉</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/37b89a23.html">再也不见，18年</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/ac4679b5.html">hexo-theme-chi主题开发小记</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/64889158.html">Matlab和OpenCV混合编程小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/be7949e4.html">Android实践小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/fc1165b7.html">C++数组中的坑</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/cafdd60d.html">Android开发环境配置</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/27a4c8b6.html">Windows实用技巧</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/6315717b.html">FFmpeg提取与合并命令使用小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/fd823bf9.html">解决VSCode使用Cmder作为默认终端问题</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/fddd1e17.html">图割算法之NCuts浅见</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/c42ff8d4.html">图割算法之Graph Cuts浅见</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/b93d943b.html">C++中static用法小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/8fb9f004.html">斐波那契数列的三种写法</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/bcdf334e.html">LaTex语法指北</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/982ff584.html">搜索技巧</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/7cebf0ee.html">17年走了，18年来了</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/e124baa1.html">矩阵的应用之图像仿射变换</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/aef52be2.html">本人常用小工具安利</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/376168c6.html">解决无法打开某个网页问题</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/5f54aa2c.html">PyQt5使用小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/82d3b275.html">TensorFlow Object Detection API使用小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/2a3d46b0.html">C语言中整型提升问题</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/dece8eba.html">TXT数据转OpenCV中的Mat数据</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/e8b35736.html">OpenCV中滑动条和鼠标事件响应操作的使用小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/b6fb6109.html">利用回调函数计算函数运行时间</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/df943c4f.html">论如何科学的上网</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/b1e9411b.html">Hexo的SPFK主题修改小记</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/22c3daf1.html">解决Qt中Qlabel显示OpenCV的Mat数据图像产生扭曲现象问题</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/509ee93b.html">解决OpenCV-2.4.11调用摄像头显示拍摄视频出错问题</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/3bc0decc.html">Hexo添加各种小部件</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/fd0f8195.html">OpenCV中显著性检测算法的使用</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/35132cb7.html">OpenCV中Selective Search算法的使用</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/170c76cc.html">别了，漆黑的象牙塔</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/c3f26b1.html">Win10以树形结构显示文件目录结构</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/68065b99.html">ACGN作品个人印象简评</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/4f6225b7.html">Hexo添加站内本地搜索</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/302a6244.html">用OpenCV显示OpenGL图形</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/7df528b4.html">Win10＋VS2013＋CMake-gui编译和配置OpenCV-3.2.0</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/17017530.html">MyThoughts</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/7d5bc07b.html">解决写上篇文档“Hexo+GitHub搭建个人博客”遇到的问题</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/d7965b48.html">Hexo+GitHub搭建个人博客</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/4a17b156.html">Hello World</a></li></ul></div></div></aside></div></div><span id="cursor-trail"></span> <span class="click-halo"></span><footer id="footer" class="text-center"><div class="copyright-info">&copy; 2017 - 2024 <a href="/">Shaun</a></div><span class="site-visitor"><i class="fa fa-user-o" aria-hidden="true"></i> <span id="busuanzi_value_site_uv"><i class="fa fa-spinner fa-spin"></i></span> &nbsp;|&nbsp; <i class="fa fa-eye" aria-hidden="true"></i> <span id="busuanzi_value_site_pv"><i class="fa fa-spinner fa-spin"></i></span> &nbsp;|&nbsp; <i class="fa fa-hand-o-up" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span></span><div class="site-info"><a href="http://hexo.io/" target="_blank">Hexo </a>theme <a href="https://github.com/cniter/hexo-theme-chi" target="_blank">Chi </a>by <a href="https://github.com/cniter" target="_blank">Shaun</a></div></footer><script type="text/javascript" async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML" integrity="sha256-WUED7NFzpsmHtLO7bswSz4JSfkhE+cD4ncKeOznwFSY=" crossorigin="anonymous"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }

        , TeX: {
            extensions: ["extpfeil.js"]
        }
    });
    
    MathJax.Hub.Queue(function() {
        let all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';                 
        }       
    });</script><script type="text/javascript">const MutationObserver=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver,config={attributes:!0,childList:!0,characterData:!0};let target=document.querySelector("#local-search--result"),$local_search_result=$("#local-search--result"),$no_result=$(".no-result"),observer=new MutationObserver((function(e){e.forEach((function(e){$local_search_result.text()||""==$local_search_result.html()?$no_result.hide():$no_result.show(200)}))})),inputArea=document.querySelector("#local-search--input"),getSearchFile=function(){let e="search.xml";0==e.length&&(e="search.xml"),searchFunc("/"+e,"local-search--input","local-search--result"),observer.observe(target,config)};inputArea.onfocus=function(){getSearchFile()};let $resetButton=$("#search-form .fa-times"),$resultArea=$("#local-search--result");inputArea.oninput=function(){$resetButton.show()};let resetSearch=function(){$resultArea.html(""),document.querySelector("#search-form").reset(),$resetButton.hide(),$no_result.hide(),observer.disconnect()};inputArea.onkeydown=function(e){if(13==e.keyCode)return!1};let searchFunc=function(e,t,r){"use strict";$.ajax({url:e,dataType:"xml",success:function(e){let n=$("entry",e).map((function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}})).get(),l=document.getElementById(t),s=document.getElementById(r);l.addEventListener("input",(function(){let e='<ul class="search-result--list">',t=this.value.trim().toLowerCase().split(/[\s\-]+/);s.innerHTML="",this.value.trim().length<=0||(n.forEach((function(r){let n=!0,l=r.title.trim().toLowerCase(),s=r.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),c=r.url,o=-1,a=-1,u=-1;if(""!=l&&""!=s&&t.forEach((function(e,t){o=l.indexOf(e),a=s.indexOf(e),o<0&&a<0?n=!1:(a<0&&(a=0),0==t&&(u=a))})),n){e+="<li><a href='"+c+"' class='search-result--title' target='_blank'>> "+l+"</a>";let n=r.content.trim().replace(/<[^>]+>/g,"");if(u>=0){let r=u-6,l=u+6;r<0&&(r=0),0==r&&(l=10),l>n.length&&(l=n.length);let s=n.substr(r,l);t.forEach((function(e){let t=new RegExp(e,"gi");s=s.replace(t,'<em class="search-keyword">'+e+"</em>")})),e+='<p class="search-result">'+s+"...</p>"}}})),s.innerHTML=e)}))}})}</script><script>function loadScript(e,t){let a=document.createElement("script");a.type="text/javascript",a.async=!0,a.readyState?a.onreadystatechange=function(){"loaded"!=a.readyState&&"complete"!=a.readyState||(a.onreadystatechange=null,t())}:a.onload=function(){t()},a.src=e,document.getElementsByTagName("body")[0].appendChild(a)}</script><script type="module" src="/js/main.js"></script><script>$(document).ready((function(){$("del").attr("title","你知道的太多了ヾ(▼ﾍ▼；) (#｀皿´メ)"),$(".toc-card").width($("#right-col").width()),$("a.footnote-ref").each((function(t,e){let i=$(this).parents("article").attr("id"),o=$(this).attr("href");e.setAttribute("data-toggle","tooltip"),e.setAttribute("data-html","true"),e.setAttribute("title",$("#"+i+" "+o).html())})),setInterval(()=>{$("#site-bg").fadeTo(1e3,.1,()=>{$("#site-bg").css("background-image",'url("/img/site-bg/bg-'+Math.floor(8*Math.random())+'.jpg")')}),$("#site-bg").fadeTo(2e3,.2)},3e4),siteBgElem=document.getElementById("site-bg"),siteBgElem&&siteBgElem.clientWidth>0&&siteBgElem.clientHeight>0&&loadScript("/js/widget/canvas-nest.js",()=>{new CanvasNest(siteBgElem,{opacity:1,pointColor:"255,255,0",color:"255,255,0",count:30})})})),$(window).on("load",(function(){$("#sidebar-sticky--bottom").height($("#right-col").height()-$("#sidebar").height()-$("#footer").height())})),$((function(){$("[data-toggle='tooltip']").tooltip()}))</script></body></html>