<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>17年走了，18年来了</title>
    <url>/posts/7cebf0ee.html</url>
    <content><![CDATA[<p>　　17 年走了，18 年也过了一个月，从这一个月看，18 年好像并没有对那个傻逼好一点。</p>
<span id="more"></span>
<p>　　17 年，也算是 Shaun 人生的一个转折点吧，既然是转折点，况且人也这么大了，不能像以前那样浑浑噩噩的过了，所以总要留下点什么东西吧。</p>
<p>　　17 年，从本科升入研究生，学校变了，所在城市却没变，所接触到的人好像变了，也好像没变，人还是那样的人。虽然早知读研是个坑，但还是转身继续扎入象牙塔中，但此时的象牙塔已不再是四年前的象牙塔，如果说四年前的象牙塔是白色的，那现在的就是黑色的，虽然是黑色的，但总比外面无尽的黑暗要好一点吧（或许有一点光明），至少是个塔，至少还稍微有点保护作用（心里安慰罢了）。黑色象牙塔和白色象牙塔最大的区别在于黑色象牙塔里有 boss，更NB的是 boss 拥有生杀予夺的权利，而且这种权利没人监管，也无法申述（或许是 Shaun 不知道？），除非有玉石俱焚的决心，否则很难反抗 。进入这黑色的象牙塔是为了逃避黑暗还是大势所趋， Shaun 认为自己或许两者皆有，在这黑色的象牙塔待两年，一来能在将来真正进入黑暗之前稍微接触一点黑暗，做好心理准备，起到一个缓冲的作用；二来能趁这两年提升一下自己，为自己在将来在黑暗中寻找那 些微光明 提供一点帮助，而且外界的黑暗也对黑色象牙塔中走出来的人好像更重视，这样不管是硬实力，还是软实力都能得到提升，这在黑暗中行走就更有的底气了，而且也更会有后劲，这样的话走进光明是不是更容易些？</p>
<p>　　17 年，不管是求知方面还是视界方面都得到了一定程度的提升和扩大，或许在外面那无尽的黑暗中能提升的更快，扩大的更多也说不好。要说 Shaun 真正进入计算机的世界，应该是在大三上的时候吧，那时候才算是真正入门了，以前只能说是上过计算机的基础课，有什么问题还是没办法解决，还处在混沌阶段，没有方向，只能瞎摸。入门了之后感觉学计算机相关的东西就轻松多了，大多数问题都能找准方向，并一步一步的解决，当然最快的解决方案还是在 Google 上。大四做毕设的时候，从没接触过 OpenCV 的 Shaun ，借助网上的资料和书本，花了两个月的时间，还是勉强做了简单的手势识别系统，等以后时间把这个系统还是记录一下吧，好歹这其中基本上把经典计算机视觉中数字图像处理和传统机器学习结合的流程走了一遍，做完这个系统，Shaun 的计算机视觉也算是正式入门了。至于目前火热的深度学习，因为设备的原因，暂时还无法实践，不得不说这是一大憾事。</p>
<p>　　17年，人或许没接触到更多，但事倒是见得更多了。主要是因为接触到了一些更有趣的世界，或者说圈子，这其中强推 <strong>「Solidot」</strong> ，该站点的资讯确实更新的很及时，科技界的一些大事都能及时公布出来，还有一个就是 <strong>「虫部落」</strong>，其快搜资源的聚合简直无敌了。网络如此之大，不知道还有多少有趣的事物等着 Shaun 去发现，每发现这些有趣的东西，就像是找到一个宝藏一样，想想就觉得很开心呢 🙃。</p>
<p>　　17 年，以一种看客的心态看了很多场戏。番茄界的用户资源之争，人肉的厉害之处，本是同根生，相煎何太急，最后有一人只能黯然退出，不知道是好是坏，毕竟 Shaun 也没用过那个工具及其提供的相关服务（或许以后会用到吧），但一家独大总归不是什么好事。在网上看到这样一句话：「鲁迅已逝，阿Q 重生」，『暴走大事件』对时事的调侃虽然很尖锐，但三观基本很正，坚持这样不容易啊，望其能唤醒一些 阿Q 吧。『新浪微博』，可以说是当前中国最大的信息聚合平台了，什么样的东西总能在微博上找到，国内大部分的戏也能在微博上看到，尤其是评论区更是有趣，但其信息和用户太杂了，良莠不齐，信息的价值密度比较低，总而言之，微博这种东西是需要带着脑子去逛的，微博上有些东西，Shaun 无法辨别，但借用鲁迅先生的一句话，「我向来是不惮以最坏的恶意来揣测中国人」。至于『知乎』，『V2EX』等，仁者见仁智者见智吧。</p>
<p>　　17 年，在网上看到这样一句话：“你可以不关心政治，但政治会来关心你”。政治上的事，无非是民主自由，但出于某些不可描述的原因就不谈了，无知是福 （๑乛◡乛๑）。但知道一些人和政策总是有好处的，虽然暗地里可能会违背，但估计没人敢明目张胆的违背吧，通过知道这些事，总能做点趋利避害的事吧。</p>
<p>　　17 年，已在实验室待了半年，还好有音乐这种东西可以麻痹一下，不然这两年就难熬喽。17 年，总归还是或知道或学会了很多有趣的东西。世界总的来说还是美好的，但这些美好的东西又有多少人能亲身经历，亲身享受。Shaun 能做的只有向这些美好的东西前进，接近，享受，顺便看看路上的风景，不管是好的还是坏的。</p>
<div style="text-align:center; font-family: Allura, Consolas, Helvetica, Tahoma, Arial, Microsoft YaHei, 微软雅黑, SimSun, 宋体, Heiti, 黑体, sans-serif; font-size:1.3em; color:#4094c3; font-weight:700; margin:.5em auto;">
17 年获得技能：<strong><em>视界开拓</em></strong><br />17 年获得成就：<strong><em>打开新世界的大门</em></strong>
</div>
]]></content>
      <categories>
        <category>Life</category>
      </categories>
      <tags>
        <tag>record</tag>
      </tags>
  </entry>
  <entry>
    <title>2021 年小结</title>
    <url>/posts/8e1d1e1d.html</url>
    <content><![CDATA[<p>　　纵观宇宙史，生物史，人之一生，不过沧海一粟，弹指灰飞，若有重来，何必重来。人生一字，莫过于拼，为私欲者有之，为利他者有之，为后代者有之，为权利者有之，为名声者有之，为理想者有之，。。。不拼之人，难存于世，众生皆苦，苦中作乐。　　——鲁迅没说过文集</p>
<span id="more"></span>
<h2 id="前言">前言</h2>
<p>　　21 年，工作上第一阶段的目标算是提前半年完成了，非常感谢前领导的赏识，至于生活上第一阶段的目标感觉还是遥遥无期。</p>
<h2 id="工作篇">工作篇</h2>
<p>　　21 年，同样一直在学习，感觉全年都在用新事物完成工作，从学习 Scala，Go 到 OSS，K8S，再到熟悉 macOS，Vim。用这些新学的东西从 0 到 1 完成了一个半项目，一个项目是地图切片系统，将 GIS 数据以 S2 网格的形式进行重新分组管理，这个系统算是优化到了 Shaun 能优化的极致，内存和性能之间达成的 trade-off，单机版可以最大程度的利用多核 CPU，集群版同样可以充分发挥多台机器的作用，这个项目算是 Shaun 花大力气做的第二个项目了，同样的满意与自豪，希望能继续发光发热。至于那半个项目，只能说是开了个头，算是 shp 数据的版本管理系统，支持正常的 CRUD，空间查询以及分析能力，初步的属性和几何信息版本管理，这个项目没有做完，算是留下了一点小遗憾。不过 22 年再回过头去看，继续做下去的话，会碰到很多难点，有些问题，对 21 年的 Shaun 来说可能是无解的，甚至可能是导致项目做不下去的关键问题。</p>
<p>　　21 年，人生中第一次跳槽，要说原因，可能也就是想换个环境，接触不同的人，当然也有一部分钱的原因，更重要的还是想出来看看，看看其他的一些流程方案，加快自己的成长速度，正如 Shaun 在学生时代说的，换个环境能使人成长的更快。确实，跳槽了之后能明显感觉到自己做事的一些变化，每个环境对人的要求是不一样的，不谈孰高孰低，只是不同的方面而已，综合这些方面，才能更好的应对后续碰到的一些困难以及有更好的发展前途。</p>
<p>　　21 年，工作上最大的收获不是做了多少项目，学了多少新技术，更不是跳槽涨了多少薪，而是跳槽后心态和做事方面的一些转变。以前虽然嘴上说着社畜社畜，但总还是一种学生心态，年轻气盛（年轻人不气盛还叫年轻人吗 ๑乛◡乛๑ ），做事钻牛角尖，只想尽最大的努力做好一件事，一心多用就比较烦躁，有时也大手大脚的，还好是 toB 的行业，有足够的时间来打磨和优化，也是真的感谢前领导的赏识和放任。跳槽之后，感觉自己做事的心态一下就放开了。在新公司，学到了一个新词语——确定性。</p>
<p>　　向上管理又同时不唯上，却是不简单，保障确定性就是一种比较好的做法，所谓的确定性就是能够完全把控一件自己负责的事。确定性，说到底也就是数据，有些什么事，分别是什么，分别有多少，工作量多少，计划排期，现在的进度，成果如何，剩余情况，预期情况，风险情况，牵扯的上下游安排，碰到的问题与困难，可能的解决方案。并不是说一定要有阶段性的成果才算确定性，每次汇报，都能把上面这些问题说清楚，也是一种确定性，能够确定这些东西也是自己能力的一种体现。领导关心的也是这些数据，向上负责，同时也是对工作负责，对自己负责。</p>
<h2 id="生活篇">生活篇</h2>
<p>　　对目前的 Shaun 来说，生活和工作基本没啥区别，工作在 Coding，生活有时也会 Coding，唯一的区别在于，工作是为了生存，生活是为了兴趣。生活算是工作之余的放松，所以关于生活能写的确实不多。</p>
<p>　　21 年，虽然疫情还在持续，但常年待在租房里还是有一些出去玩的冲动，遂去了一趟西湖，人确实很多，风景也没有让人耳目一新的感觉，有点名不副实了，还没有旁边的龙井村好玩，杭州的交通也是一场不太美好的出行体验。出去玩，主要是为了散心，这个目的算是达到了。</p>
<p>　　21 年，本来想去一趟黄山的，但由于自己懒得动，还是没去成，这不得不说是一种遗憾了，换了个城市，再想提起勇气去，就不知道是猴年马月了。换城市这件事，Shaun 也认真思考过，代价确实比较大，或许将来有一天，Shaun 会因为这个决定后悔，当然也或许不会，Shaun 一贯的认知就是有钱在哪都舒服，没钱在哪都难受，最终还是 follow my heart，决定趁着年轻，多出去看看，毅然决然的走出过去两年多舒适的工作和生活环境，来到这个陌生的环境重新开始，这件事，算是为平淡的生活增加了些许起伏。</p>
<p>　　刚来到新城市，虽然觉得一切都比较新鲜，但还是被新城市恶劣的天气环境给搞的很不爽，不过还算运气不错，只看了一家就找到了 Shaun 还算满意的房子，新城市的房租确实要高一些，而且中介费居然要一个月的房租，这着实是有些高。新城市的防疫政策对底层打工人没有丁点儿人文关怀，部分小区的看门大爷是真大爷，就像菜鸟程序员写的低级 robot，逻辑写的死死的。防疫软件也是垃圾中的战斗机，纳税人的血汗钱也不知道有多少进了个人口袋。</p>
<p>　　理财方面也开始接触一些更专业的知识，国内金融从业资格考试主要有四个：证券从业资格考试，基金从业资格考试，银行从业资格考试，期货从业资格考试，都有对应的统编教材，并不是说要一定通过这几个考试，而是可以从这几门考试中，对国内金融市场有一定的认识，不是完全的小白（<em>真要参加考试的话可以看看这个 <a href="https://www.zhihu.com/question/27618901/answer/269242670">证券资格证考试要准备多久？</a> ，刷题的话就找个 app 就行，<strong>刷题学习法</strong> 😅</em>），一般看完前两个从业资格的备考资料就差不多了，有个基础的认识，后期的交易策略或计划就只能根据个人的情况慢慢摸索了。至于 21 年的理财成果就不是很好了，把 20 年赚的又亏回去了，主要是出于 20 年的乐观心态，觉得互联网还能再涨点，就一直没卖，没想到 21 年的国家政策对互联网这么不友好，想要挣钱，还是得跟着政策走 ¯\_(ツ)_/¯。</p>
<h2 id="总结">总结</h2>
<p>　　前路漫漫，不问对错，不求利弊。每个公司做事的风格是不一样的，这种差异性才是需要学习的地方，也是能让人快速成长的基础。年纪越大，越觉得人生若只如初见是一种奢侈。独行备艰难，莫忘守初心。</p>
<div style="text-align:center; font-family: Allura, Consolas, Helvetica, Tahoma, Arial, Microsoft YaHei, 微软雅黑, SimSun, 宋体, Heiti, 黑体, sans-serif; font-size:1.3em; color:#4094c3; font-weight:700; margin:.5em auto;">
21 年获得技能：<strong><em>学无止境</em></strong><br />21 年获得成就：<strong><em>重新开始</em></strong>
</div>
]]></content>
      <categories>
        <category>Life</category>
      </categories>
      <tags>
        <tag>record</tag>
      </tags>
  </entry>
  <entry>
    <title>2019，既是结束又是开始</title>
    <url>/posts/cf97ba7c.html</url>
    <content><![CDATA[<p>　　人生总算是告一段落了，虽然没取得好成绩，但总归要奔向新的起点，迎接新的挑战。</p>
<span id="more"></span>
<h2 id="前言">前言</h2>
<p>　　回首 2019，告别了学生身份，迎来的新的称号——社畜。普通人进入社会也只能是社畜，一批又一批的供养着食物链上层的生活，虽然有社畜能升级，但任务完成何其艰难，材料获取何其艰难。好了闲话也不多说了，开始进入正题吧。</p>
<h2 id="结束篇">结束篇</h2>
<p>　　19 年，终于迎来了学生生涯的最后阶段，依稀记得，从开学到毕业一直过的十分焦虑，虽说论文的思路早已想通，实验结果也有了，只剩对比试验还没做，但每周一次的例会着实让人头皮发麻。依旧每周一次的批斗大会，自己的想法，写的东西，说的东西，在导师面前都是屁，纯粹就是想把学生批的体无完肤，以体现自己导师的身份和那一份仅有的优越感。日子就这样一周周过去，从论文写完到查重，从答辩完到走完所有毕业流程，虽然心理上的压力不小，但总算还是顺利毕业了。不管怎么说，能够顺利毕业总比跳楼的要好太多了，如果说这小硕读的值不值，对于 Shaun 来说，还是值的，虽然承受了莫大的心理压力，但总归还算是承受住了，真鸡儿痛苦，完全不想承受第二次，估计也不会有第二次了，如果真有，Shaun 估计会选择尽快逃脱远离。</p>
<p>　　再回首 2019 年上半年，却发现从年初到脱离学生身份这一段时间发生的事已经渐渐模糊了，痛苦的事有时会被人选择性的忘记，最终回归平淡，或许这就是历史总会重演的原因。</p>
<p>　　好了，结束篇就这样结束吧，多的也不写了，该写的东西也早已写完。</p>
<h2 id="开始篇">开始篇</h2>
<p>　　刚步入社会就被上了一课，在培训时闹钟设错了，错设为工作日闹钟，而培训在周末仍在进行，而且当天开始的非常早，所以当然迟到了。事后反思这事最好自己闷在肚子里了，不要提任何理由，因为没人会同情你，甚至会嘲笑你，迟到就是迟到，过程就是个屁，结果才是王道，只能从中吸取经验，下次再有类似的事还是设一次性的临时闹钟比较好。本以为迟到这件事就会这样慢慢过去，但在新人见面会上（老板会和每一批新人见一下面），有人为了表现自己特意和老板强调了一下，也是有意思，非蠢即坏，不知是老板贵人多忘事还是情商高，这件事就这么过去了。这事算是 Shaun 真正步入社会后上的第一课，所以还是写下来了，以后估计还是会被上一些课，只是有些是大课有些是小课罢了，从课中吸取经验，或许就是成长吧。</p>
<p>　　初当社畜，干的当然都是一些打杂的活，还记得，正式干活的第一个任务就差点没完成，由于学生时代一直在搞图像，而第一个任务却是图形中的问题，那个问题是 “3维场景中选择物体不准确”。从来没接触过的 3维 的 Shaun 当时连相机模型都不了解，更何况是实际项目中的问题，就牵扯的更多了，于是花了几天时间熟悉项目中整个选择流程及 3维图形的一些基础知识，终于在一周后成功修复了这个 bug，刚开始还以为是相机模型的问题，重写了一下相机模型，中间确实发现了一个矩阵乘法的问题，修复了之后，这个 bug 还是存在，相机模型没有任何问题，最后选择输出全部点的坐标，发现有些点的 ndc 坐标有异常，排除这些点之后，选择终于正确了，社畜生涯中的第一个正式任务也算是圆满完成。</p>
<p>　　再之后就是一些大大小小的新功能添加以及 bug 修复。两个月后，来了一个项目，需要为这个项目单独开发一些功能在已有的产品上，鉴于组里其他人都有各自的任务，这个项目就落到 Shaun 头上了，还好经过两个月的熟悉，对已有产品基本熟悉了，开发相关的新功能难度也不大，唯独有一个要求导致已有的产品需要进行架构升级，不然就没法满足该需求，不知为啥，这架构升级的工作也落到了 Shaun 头上，没办法，只能硬着头皮上了，强行分离了一些文件出去，搞了一周多，虽然出现了一些 regression，但好歹也算是升级成功，满足了甲方的需求，以 Shaun 当前的眼光看，当时架构升级还是存在一些问题，有些文件不该抽离的，但碍于当时自身的能力以及对整个产品的理解程度，能升级成功也还可以了，这种经验算是比较难得的。</p>
<p>　　之后继续添加功能和修复 bug，就这样顺利过完了 19年，社畜的半年时间，虽然还不够真正入门，但好歹也摸到了门槛，开始接触了一些社畜的规则。</p>
<h2 id="总结">总结</h2>
<p>　　学生身份终于彻底结束，最后的学生阶段是 Shaun 整个学生生涯最难受的一段时间，说不好也可能是整个人生最难受的时光，不过总算是过去了。踏足当下，回首过去，展望未来，从这半年的社畜生活看，真的很不错，比读书爽太多了，也可能是最后的学生阶段压抑的太厉害了，总之感觉很爽，同事和上司都还可以，最重要的是没有了任人宰割的感觉，真的很舒服 😊。</p>
<div style="text-align:center; font-family: Allura, Consolas, Helvetica, Tahoma, Arial, Microsoft YaHei, 微软雅黑, SimSun, 宋体, Heiti, 黑体, sans-serif; font-size:1.3em; color:#4094c3; font-weight:700; margin:.5em auto;">
19 年获得技能：<strong><em>社畜新手</em></strong><br />19 年获得成就：<strong><em>顺利毕业</em></strong>
</div>
]]></content>
      <categories>
        <category>Life</category>
      </categories>
      <tags>
        <tag>record</tag>
      </tags>
  </entry>
  <entry>
    <title>Android实践小结</title>
    <url>/posts/be7949e4.html</url>
    <content><![CDATA[<p><font color=#FA8072>实践环境为：android-studio-bundle-162.4069837-windows（Android Studio 2.3.3 带 Android SDK 版）、该 Android Studio 自带的 JRE，系统环境为 Win10-1607。</font></p>
<h2 id="前言">前言</h2>
<p>　　由于上一届没有更新任何项目文档和学习文档，Shaun 只能自己去网上查找相关的资料，从零开始学习，顺便留下一些文档，正所谓：「代码未动，文档先行」，也算是实践出真知吧。</p>
<p><strong>PS：</strong> 本次实践的项目主要来自 <a href="http://www.runoob.com/w3cnote/android-tutorial-exercise-1.html">12.1Android 实战 ：DrySister看妹子应用(第一版) — 项目搭建与简单实现</a>（<a href="http://www.runoob.com/w3cnote_genre/android" class="uri">http://www.runoob.com/w3cnote_genre/android</a>） 以及目前手头上正在维护的项目。</p>
<span id="more"></span>
<h2 id="布局篇">布局篇</h2>
<p>　　首先打开 Android Studio ，新建项目，一路默认下去即可，等待片刻，“MainActivity.java” 文件的错误提示就会自然消失，<em>将左侧栏上方的 “Android” 切换为 “Project”</em>，打开 <strong>app</strong> -&gt; <strong>src</strong> -&gt; <strong>main</strong> -&gt; <strong>res</strong> -&gt; <strong>layout</strong> -&gt; <strong>activity_main.xml</strong>，由于其默认是以 “Text” 的模式打开（Android Studio 右侧有个 “Preview” 标签可以进行当前布局预览），这对于小白来说不大好控制布局，所以需要在该文件底部将 “Text” 切换为 “Design”，如此可以进行拖拽式布局，以下正式开始进入 Android UI 的布局。至于具体如何进行布局设置，可以参考 <a href="https://www.diycode.cc/topics/744">Android ConstraintLayout 使用指南</a> 和 <a href="https://blog.csdn.net/nicolelili1/article/details/52611162">Android实现拖拽式布局开发----约束性布局</a> 以下两篇资料。</p>
<p>　　而若要使控件大小根据屏幕大小自适应，一般可使用相对布局，但如今的 Android Studio 默认新建的页面就是一种类似于相对布局的页面，所以直接在控件中设置 <code>android:layout_width="match_parent"</code> 以及 <code>android:layout_height="match_parent"</code> 属性即可，再设置 layout_margin 属性进行调整即可，而若要让控件大小随控件内的内容自适应，则只需要将 match_parent 更改为 wrap_content 即可。</p>
<h2 id="编码篇">编码篇</h2>
<p>　　首先新建自己的业务逻辑 java 代码，具体新建方法可参考 <a href="https://jingyan.baidu.com/article/f79b7cb36fc6369145023e7f.html">Android studio怎么创建一个Java类文件</a> ，在 <strong>MainActivity.java</strong> 文件所在目录上鼠标右键 <strong>New</strong> -&gt; <strong>Java Class</strong>，新建完成之后即可编写自己的业务逻辑。若要新建文件夹，则在目录上鼠标右键 <strong>New</strong> -&gt; <strong>Package</strong> 。若要使级联目录展开，例如 <code>com.example.admin.myapplicationtest</code>，则需要在该目录的父级目录新建一个 <code>com.example.admin.test</code> Package 即可将<code>com.example.admin</code> 目录展开。</p>
<h3 id="页面跳转">页面跳转</h3>
<p>　　首先新建一个页面 jump_test_activity，在 <code>\MyApplicationTest\app\src\main\res\layout</code>，即 layout 文件夹上鼠标右键，“<strong>New</strong>” ==》“<strong>Activity</strong>” ==》“<strong>Empty Activity</strong>” （有多种 Activity 样式可供选择，Shaun 这里就以 Empty Activity为例了），随后弹出窗口，在 <strong>Activity Name</strong> 栏填写页面逻辑控制代码文件名 JumpTestActivity，在 <strong>Layout Name</strong> 栏填写页面 UI 设计代码文件名 jump_test_activity，在 <strong>Package name</strong> 以及页面逻辑控制代码文件所在在包名 com.example.admin.myapplicationtest.ui.activity，其它设置为默认即可，这样新建的页面的有个问题就是会有一个丑陋的标题栏，所以还需要去掉该标题栏，具体方法为：</p>
<ol type="1">
<li><p>在 <code>MyApplicationTest\app\src\main\res\values\styles.xml</code> 文件中添加：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="XML"><div class="code-copy"></div><figure class="highlight hljs xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">&quot;AppTheme.NoActionBar&quot;</span>&gt;</span><span class="xml"></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;windowActionBar&quot;</span>&gt;</span>false<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;windowNoTitle&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure></div></li>
<li><p>将 <code>MyApplicationTest\app\src\main\AndroidManifest.xml</code> 中的 <code>&lt;activity android:name=".ui.activity.JumpTestActivity"&gt;&lt;/activity&gt;</code> 更改为 <code>&lt;activity android:name=".ui.activity.JumpTestActivity" android:theme="@style/AppTheme.NoActionBar"&gt;&lt;/activity&gt;</code> ，再次编译运行即可看到标题栏已消失。</p></li>
</ol>
<p>好了，准备阶段已经搞完，接下来就是正式的页面跳转了，一般页面跳转是用户点击事件发生的，所以需要添加一个具有点击事件的控件，一般而言就是 Button 了，这里设该 button 的 id 为 page_jump_btn；该 button 所在页面为 <code>MyApplicationTest\app\src\main\res\layout\activity_main.xml</code>，则在对应的逻辑控制文件<code>MyApplicationTest\app\src\main\java\com\example\admin\myapplicationtest\ui\activity\MainActivity.java</code> 中的页面跳转代码为：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="JAVA"><div class="code-copy"></div><figure class="highlight hljs java"><table><tr><td class="code"><pre><span class="line">page_jump_btn = (Button) findViewById(R.id.page_jump_btn);</span><br><span class="line">page_jump_btn.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">		Intent intent = <span class="keyword">new</span> Intent(MainActivity.<span class="keyword">this</span>, JumpTestActivity.class);</span><br><span class="line">		MainActivity.<span class="keyword">this</span>.startActivity(intent);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></div>
<p>如此，在主界面中点击跳转按钮，即可跳转到新建页面。</p>
<h3 id="url-中的坑">URL 中的坑</h3>
<p>　　在学 12.2 的时候，由于请求的URL地址中有中文“福利”，所以其返回的字符串为：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="JSON"><div class="code-copy"></div><figure class="highlight hljs json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="attr">&quot;results&quot;</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>可以看到 “results” 的值为空，这显然是错的，后面调试发现需要对 URL 地址转义（这都 8102 年了，为什么 URL 地址中还要有中文，或者说为什么 URL 地址还不支持解析中文 ╮(╯▽╰)╭），具体转义代码如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="JAVA"><div class="code-copy"></div><figure class="highlight hljs java"><table><tr><td class="code"><pre><span class="line">fetch_url = Uri.encode(fetch_url);  <span class="comment">// 将URL地址转义</span></span><br><span class="line">fetch_url = fetch_url.replace(<span class="string">&quot;%3A&quot;</span>, <span class="string">&quot;:&quot;</span>);  <span class="comment">// 将%3A替换为:</span></span><br><span class="line">fetch_url = fetch_url.replace(<span class="string">&quot;%2F&quot;</span>, <span class="string">&quot;/&quot;</span>);  <span class="comment">// 将%2F替换为/</span></span><br></pre></td></tr></table></figure></div>
<p>主要参考资料为：<a href="https://blog.csdn.net/joshuaxx316/article/details/47749181">Android url中文乱码问题及解决办法</a> 和 <a href="https://blog.csdn.net/top_code/article/details/26288057">Android URL encode 空格处理</a> 。</p>
<h3 id="sql-语句中的坑">SQL 语句中的坑</h3>
<p>　　在使用字符串拼写 SQL 语句时，<strong><em>一定要注意 SQL 语句中的空格</em></strong>，要不然拼起来的 SQL 语句可能语法不通而导致 APP 崩溃。如在使用创建表的 SQL 语句时，可能的错误写法（不注意空格）如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SQL"><div class="code-copy"></div><figure class="highlight hljs sql"><table><tr><td class="code"><pre><span class="line">String create_table_sql <span class="operator">=</span> &quot;CREATE TABLE IF NOT EXISTS&quot; <span class="operator">+</span> TableDefine.TABLE_FULI <span class="operator">+</span> &quot;(&quot;</span><br><span class="line">                <span class="operator">+</span> TableDefine.COLUMN_ID <span class="operator">+</span> &quot;INTEGER PRIMARY KEY AUTOINCREMENT,&quot;</span><br><span class="line">                <span class="operator">+</span> TableDefine.COLUMN_FULI_ID <span class="operator">+</span> &quot;TEXT,&quot;</span><br><span class="line">                <span class="operator">+</span> TableDefine.COLUMN_FULI_CREATEAT <span class="operator">+</span> &quot;TEXT,&quot;</span><br><span class="line">                <span class="operator">+</span> TableDefine.COLUMN_FULI_DESC <span class="operator">+</span> &quot;TEXT,&quot;</span><br><span class="line">                <span class="operator">+</span> TableDefine.COLUMN_FULI_PUBLISHEDAT <span class="operator">+</span> &quot;TEXT,&quot;</span><br><span class="line">                <span class="operator">+</span> TableDefine.COLUMN_FULI_SOURCE <span class="operator">+</span> &quot;TEXT,&quot;</span><br><span class="line">                <span class="operator">+</span> TableDefine.COLUMN_FULI_TYPE <span class="operator">+</span> &quot;TEXT,&quot;</span><br><span class="line">                <span class="operator">+</span> TableDefine.COLUMN_FULI_URL <span class="operator">+</span> &quot;TEXT,&quot;</span><br><span class="line">                <span class="operator">+</span> TableDefine.COLUMN_FULI_USED <span class="operator">+</span> &quot;BOOLEAN,&quot;</span><br><span class="line">                <span class="operator">+</span> TableDefine.COLUMN_FULI_WHO <span class="operator">+</span> &quot;TEXT&quot;</span><br><span class="line">                <span class="operator">+</span> &quot;)&quot;;</span><br></pre></td></tr></table></figure></div>
<p>以上写法无法正确建表，甚至会因为错误 SQL 语句而导致 APP 闪退，正确的写法如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SQL"><div class="code-copy"></div><figure class="highlight hljs sql"><table><tr><td class="code"><pre><span class="line">String create_table_sql <span class="operator">=</span> &quot;CREATE TABLE IF NOT EXISTS &quot; <span class="operator">+</span> TableDefine.TABLE_FULI <span class="operator">+</span> &quot; (&quot;</span><br><span class="line">                <span class="operator">+</span> TableDefine.COLUMN_ID <span class="operator">+</span> &quot; INTEGER PRIMARY KEY AUTOINCREMENT, &quot;</span><br><span class="line">                <span class="operator">+</span> TableDefine.COLUMN_FULI_ID <span class="operator">+</span> &quot; TEXT, &quot;</span><br><span class="line">                <span class="operator">+</span> TableDefine.COLUMN_FULI_CREATEAT <span class="operator">+</span> &quot; TEXT, &quot;</span><br><span class="line">                <span class="operator">+</span> TableDefine.COLUMN_FULI_DESC <span class="operator">+</span> &quot; TEXT, &quot;</span><br><span class="line">                <span class="operator">+</span> TableDefine.COLUMN_FULI_PUBLISHEDAT <span class="operator">+</span> &quot; TEXT, &quot;</span><br><span class="line">                <span class="operator">+</span> TableDefine.COLUMN_FULI_SOURCE <span class="operator">+</span> &quot; TEXT, &quot;</span><br><span class="line">                <span class="operator">+</span> TableDefine.COLUMN_FULI_TYPE <span class="operator">+</span> &quot; TEXT, &quot;</span><br><span class="line">                <span class="operator">+</span> TableDefine.COLUMN_FULI_URL <span class="operator">+</span> &quot; TEXT, &quot;</span><br><span class="line">                <span class="operator">+</span> TableDefine.COLUMN_FULI_USED <span class="operator">+</span> &quot; BOOLEAN, &quot;</span><br><span class="line">                <span class="operator">+</span> TableDefine.COLUMN_FULI_WHO <span class="operator">+</span> &quot; TEXT&quot;</span><br><span class="line">                <span class="operator">+</span> &quot;)&quot;;</span><br></pre></td></tr></table></figure></div>
<h2 id="调试篇">调试篇</h2>
<p>　　编码完成之后，一般而言需要进行调试，Android Studio 的调试可参考 <a href="https://blog.csdn.net/testcs_dn/article/details/53714678">【Android 开发入门】android studio 控制台打印输出日志</a> ，进入调试模式具体方法为：点击上方工具栏中的 <strong>Debug 'app'</strong> 图标，而不是直接 <strong>Run 'app'</strong>，进入调试模式之后，点击下方的 “Android Monitor”，切换到 “logcat” 标签，即可查看调试信息。</p>
<p>　　华为手机打印调试信息可参考 <a href="https://blog.csdn.net/scwhy/article/details/7432414">华为手机logcat不出日志解决方案</a>。这里由于 Shaun 还没有对 <strong>AndroidManifest.xml</strong> 进行修改，所以该 APP 在点击 Button 的时候会直接闪退，调试窗口出现 <font color=#FA8072><em>java.lang.SecurityException: Permission denied (missing INTERNET permission?)</em></font> 错误信息，参考 <a href="https://blog.csdn.net/hack8/article/details/28038541">android菜瓜笔记之missing INTERNET permission</a> 和 <a href="https://stackoverflow.com/questions/17360924/securityexception-permission-denied-missing-internet-permission">SecurityException: Permission denied (missing INTERNET permission?)</a> 可知，该 APP 没有网络权限，所以需要在 AndroidManifest.xml 中添加网络权限，具体在 <em>manifest</em> 标签中添加语句 <code>&lt;uses-permission android:name="android.permission.INTERNET" /&gt;</code>，如此该 APP 就能正常执行了。</p>
<p><strong>PS：</strong> <em>如果是对应用发生闪退或崩溃的原因进行调试，建议直接在 <strong>logcat</strong> 中搜索 <strong>fatal</strong> 关键字</em>。</p>
<h2 id="附录">附录</h2>
<h3 id="更换马甲重新发布为另一个-app">更换马甲重新发布为另一个 app</h3>
<p>　　即一样的代码却编译出另一个相同的 app，在某些特殊的需求（使两个功能大致一样的 app 共存在一台手机上）上可能需要这个技巧，具体步骤如下（以 MyApplicationTest 更名为 MyApplication 为例）：</p>
<ol type="1">
<li>首先将 MyApplicationTest 文件夹（即 APP 根目录）更名为 MyApplication；（这一步不是刚需）</li>
<li>将 <code>MyApplicationTest\app\src\main\res\values\strings.xml</code> 文件中 <code>&lt;string name="app_name"&gt;MyApplicationTest&lt;/string&gt;</code> 更改为 <code>&lt;string name="app_name"&gt;MyApplication&lt;/string&gt;</code>；</li>
<li>将 <code>MyApplicationTest\app\build.gradle</code> 文件中 <code>applicationId "com.example.admin.myapplicationtest"</code> 更改为 <code>applicationId "com.example.admin.myapplication"</code> 。（这一步是刚需）</li>
</ol>
<p>如此，即可另外安装一个全新 APP，同时保留原有 APP，至于 applicationId 的更多作用和用法可参考 <a href="https://developer.android.com/studio/build/application-id?hl=zh-cn">设置应用 ID</a> 。更换 APP 图标只需在 app 文件上鼠标右键， “<strong>New</strong>” ==》“<strong>Image Asset</strong>” ，即可弹出设置 app 图标窗口，或者直接更改 AndroidMainfest.xml 文件中的 <code>android:icon</code> 也可。</p>
<h2 id="后记">后记</h2>
<p>　　排版可能有点乱，毕竟是随便写的，碰到问题就简单的记录一下，Shaun 这次的实践过程可在 <a href="https://github.com/cniter/AndroidLearning"><strong>AndroidLearning</strong></a> 中查看，页面跳转的方法来自手头上正在开发维护的一个项目，附录中第一个问题的来源是对方提出的一个特殊需求。</p>
]]></content>
      <categories>
        <category>Study</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>android</tag>
      </tags>
  </entry>
  <entry>
    <title>2020年小结</title>
    <url>/posts/28416d7c.html</url>
    <content><![CDATA[<p>　　社畜不易，行者多难，披荆斩棘，前路莫测，步履不停。</p>
<span id="more"></span>
<h2 id="前言">前言</h2>
<p>　　20 年，也算是正式步入社畜生活的第一年，新鲜感自然少不了，但也没持续很长时间。这一年中基本都在学习，工作中生活中都在熟悉新事物新模式。</p>
<h2 id="技术篇">技术篇</h2>
<p>　　开始独立负责项目，从无到有写完了一个产品，做了半个地图可视化项目，图形学相关知识从完全不会到熟练使用 Shader 做简单特效，学习新语言使用新工具，这就是 Shaun 过去一年在工作中的写照。</p>
<p>　　在产品中，Shaun 基本独立完成了调研设计编码的全过程，这款网页版的 OpenDrive 路网编辑器，让 Shaun 基本熟悉的前端开发的主流框架和打包流程，甚至基于这款编辑器继续引申出两个 SDK，虽然开发模式和真正的前端有所区别（Shaun 是把 Typescript 当 C# 用的，将网页程序当客户端程序开发），但感觉现在的浏览器完全能撑的住，完全可以将更多的计算和存储任务直接在前端全部做完，但同时也感到了纯前端的无力，没有后端，前端网页能呈现的数据和效果确实有限，网页的内存有限制，webgl 渲染的三角形也有限制，只能做些小东西，大场景就很难施展。路网编辑器中涉及的前端技术栈也有很多，主要是现在无论开发一个什么应用，都不可能从语言最底层的 api 写起，总会用到别人写好的库，熟悉，吸收，再修改，用着用着就需要自己写了，从用轮子到造轮子，从而产生更多的轮子，也算是一种良性循环。</p>
<p>　　半个地图可视化项目，主要用的 mapbox-gl + geoserver 显示地图，做完这个项目，同时也基本了解了国内的百度和高德两家的地图突然变好看了的原因，其背后的技术也同样源自于 mapbox，一家真正小而美的公司，定义了一套前端渲染地图的数据标准（Vector Tile），在非 3D 地图上，这套标准就是业内通用的标准了，如今的导航地图用的都是这套前端渲染技术，美观又高效。</p>
<h2 id="生活篇">生活篇</h2>
<p>　　整个 20 年出去玩的时间也不多，工作地所在能玩的地方基本也玩的差不多了，大部分时间都是宅在屋里看电影，学技术，感觉就非常平淡，也没啥特别好说的。20年，开始学习理财，锻炼买入卖出的感觉，由于整个 20 年股市一片良好，以至于 Shaun 这个新手也赚了些钱，但由于本钱不多，赚的也非常有限，赚大钱的机会，要么拿不住，要么下不去手，最终都失之交臂，这样一来，赚的就更少了，不过，股市中赚到的钱终究只是个数字，到手的才是赚到的，没到手是赚是亏还不好说，作为新手而言，Shaun 也就当玩玩而已，亏也不多，主要是锻炼自己的感觉或承受能力，反正理财是一辈子的事，不急于这一时。</p>
<h2 id="总结">总结</h2>
<p>　　生活一年如一日的平淡如水，依旧独自前行，由于疫情的原因，出去看看都嫌太麻烦，只能周边走走，着实无聊，好在工作上的东西对 Shaun 来说是新的知识，稍微有点挑战，每解决一个问题，总会带来一些成就感，冲淡些许无聊，可这成就感越来越少了，或许哪天成就感完全消失，就是 Shaun 换个新环境的时候。</p>
<div style="text-align:center; font-family: Allura, Consolas, Helvetica, Tahoma, Arial, Microsoft YaHei, 微软雅黑, SimSun, 宋体, Heiti, 黑体, sans-serif; font-size:1.3em; color:#4094c3; font-weight:700; margin:.5em auto;">
20 年获得技能：<strong><em>触类旁通</em></strong><br />20 年获得成就：<strong><em>独挡一面</em></strong>
</div>
]]></content>
      <categories>
        <category>Life</category>
      </categories>
      <tags>
        <tag>record</tag>
      </tags>
  </entry>
  <entry>
    <title>Android开发环境配置</title>
    <url>/posts/cafdd60d.html</url>
    <content><![CDATA[<p><font color=#FA8072>由于一些历史原因，本篇配置的 Android 开发环境所需的软件对应版本号为：jdk-7u80-windows-x64、android-studio-bundle-162.4069837-windows（Android Studio 2.3.3 带 Android SDK 版），系统环境为 Win10-1607。</font></p>
<h2 id="前言">前言</h2>
<p>　　没想到，时隔两年之后又要重新捡起 Java，还要学基本没怎么做过的 Android，而且还是在这节骨眼上，真是造化弄人 _(´ཀ`」 ∠)_。</p>
<span id="more"></span>
<h2 id="java-环境篇">Java 环境篇</h2>
<p>　　先在 <a href="http://www.oracle.com/technetwork/java/archive-139210.html">Oracle Java Archive</a> 下载对应的 Java 版本，下载完成后去 <a href="https://www.oracle.com/webfolder/s/digest/7u80checksum.html">这里</a> 校验对应的 Hash 值（若是其它 JDK 版本，则只需将 url 末尾的 <code>7u80</code> 改成相应的版本号即可），并安装，安装时需要注意，<em>在安装完 JDK 之后，该安装器还会继续弹出让安装 JRE 的窗口，此时直接点取消即可，因为 JDK 中已包含 JRE ，所以没必要也不需要再继续安装，安装了之后，就相当于有两个 JRE ，还可能会为以后的工作造成一些麻烦</em>。具体系统环境变量配置如下（若没有相应的变量名则新建）：</p>
<table>
<colgroup>
<col style="width: 13%" />
<col style="width: 86%" />
</colgroup>
<thead>
<tr class="header">
<th>变量名</th>
<th>变量值</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>JAVA_HOME</td>
<td>C:\Program Files\Java\jdk1.7.0_80 （PS：此为JDK安装目录，后面不能加分隔符分号）</td>
</tr>
<tr class="even">
<td>CLASSPATH</td>
<td>.;%JAVA_HOME%\lib;%JAVA_HOME%\lib\dt.jar;%JAVA_HOME%\lib\tools.jar; （PS：最前面的 <code>.;</code> 必须要有）</td>
</tr>
<tr class="odd">
<td>Path</td>
<td>%JAVA_HOME%\bin;%JAVA_HOME%\jre;</td>
</tr>
</tbody>
</table>
<p>配置完之后，键入 Win+R ==》cmd ==》 Enter，在终端输入 “java -version”，“java”，“javac” ，这几个命令，若有正确的响应，则表示配置成功。</p>
<h2 id="android-篇">Android 篇</h2>
<p><strong>※注：</strong> <em>在安装和配置 Android Studio 时最好先自行找好梯子，这其中有一些步骤可能需要连接外网</em>。</p>
<p>　　自然还是先在<a href="http://www.android-studio.org/index.php/download/hisversion">这里</a>（<a href="http://www.android-studio.org/" class="uri">http://www.android-studio.org/</a>）下载安装 Android Studio ，为避免再下载安装配置 SDK 的麻烦，推荐直接下载带 SDK 版本的 Android Studio 。直接默认安装，其中安装 SDK 的时间略长。<em>安装完成之后，推荐把 SDK 目录下的 tools 和 platform-tools 子目录也添加到系统的 PATH 环境变量中</em>。</p>
<p>　　在第一次打开 Android Studio 的时候，可能需要连接外网以更新 SDK ，所以需要自行设置好代理，更新又要花一段时间 ╮(╯▽╰)╭，当然也可以选择不更新，不更新的办法为：</p>
<blockquote>
<p>在AS启动前，打开安装目录，请先将bin目录的idea.properties文件中增加一行：disable.android.first.run=true就行了，避免第一次打开AS时自动重新下载SDK。</p>
</blockquote>
<p>　　第一次运行时，首先需要配置 SDK 路径和 JDK 路径，配置 SDK 路径方法为：“Configure” —&gt; “SDK Manager”，编辑 “Android SDK location” ，其会自动找到安装的 SDK 路径；配置 JDK 路径方法为：“Configure” —&gt; “Project Defaults” —&gt; “Project Structure”，编辑 “JDK location”（这里它有个默认内置的 jre，但推荐还是使用自己的 JDK）。</p>
<p>　　Android Studio 默认的编辑器方案无法更改字体（若真想在默认的方案上更改字体，可以先将其另存为一个新方案），而且个人认为其默认的主题（配色，字体等）不好看，所以推荐自行去 <a href="http://color-themes.com/?view=index">Color Themes</a> 选择合适的主题。最终 Shaun 选择 <a href="http://color-themes.com/?view=theme&amp;id=563a1a6480b4acf11273ae48">Wombat</a> 主题。至于导入主题的方法为：“Configure” —&gt; “Import Settings”，将下载好的 jar 包导入即可。</p>
<p>　　为了测试方便，就直接装了个 <a href="http://mumu.163.com/">网易MuMu模拟器</a> ，用起来感觉还可以，至于 Android Studio 连接 MuMu 模拟器的方法为：先打开 MuMu 模拟器，在 Android Studio 底下的 <strong>Terminal（终端）</strong> 中输入命令：<code>adb connect 127.0.0.1:7555</code> ，响应 <code>connected to 127.0.0.1:7555</code> 则说明连接成功，这时就能愉快的使用 MuMu 模拟器调试 Android app 了。</p>
<h2 id="后记">后记</h2>
<p>　　以后有碰到什么坑再继续记录吧 ╮(╯▽╰)╭。</p>
<h2 id="参考资料">参考资料</h2>
<p>[1] <a href="https://www.cnblogs.com/yanglh6-jyx/p/Android_AS_Configuration.html">Android Studio安装配置、环境搭建详细步骤及基本使用</a></p>
<p>[2] <a href="https://www.cnblogs.com/smyhvae/p/4390905.html">第一次使用Android Studio时你应该知道的一切配置</a>（<a href="http://www.cnblogs.com/smyhvae/category/587732.html" class="uri">http://www.cnblogs.com/smyhvae/category/587732.html</a>）</p>
<p>[3] <a href="https://blog.csdn.net/qq_35605213/article/details/80241641">Android Studio连接不到MuMu模拟器</a></p>
]]></content>
      <categories>
        <category>Study</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>android</tag>
      </tags>
  </entry>
  <entry>
    <title>ACGN作品个人印象简评</title>
    <url>/posts/68065b99.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　Shaun 无意向任何人推荐任何东西，毕竟那个年纪已经过去了，有些东西还是独自品味比较好，写这些东西只是单纯的想留个纪念。本文主要是分享一下 Shaun 看过的一些 ACGN 作品及相应的感觉感受，也算是记录一下，以免雁过不留痕，看过的就这样看过了。以下作品只是简单排列，没有的所谓的排名之分，只凭个人当时主观印象深浅，简单来说就是想到哪就写到哪。</p>
<p><strong>※注：</strong>本文所指的 ACGN 只是单纯的指 Animation（动画）、Comic（漫画）、Game（游戏）、Novel（小说）四个独立并列的部分，不是通俗意义上霓虹国的那种紧密联系的一个整体。</p>
<span id="more"></span>
<h2 id="animation-篇">Animation 篇</h2>
<p>　　动画，真正接触霓虹国的动画还是在中学时代吧，那时也是在同学的推荐下入坑了「火影」（直到现在都还没去看结局，虽然前年就完结了），当时完全接受不了「海贼王」的画风，还是后来画了一个暑假追上来的。</p>
<ul>
<li>『海贼王』。Shaun 偏向于「海贼王」这个译名，个人感觉顶上战争之前和顶上战争之后完全是两部作品，还是觉得顶上战争之前比较好看，之前就像是游戏里打怪升级，能过些热血的瘾，但之后变成了只打怪不升级，而且感觉怪是强行被画败的 ╮(╯▽╰)╭，海贼王里还有个奇怪的现象，好像几乎不死人，不过也可能是侧重点不同，死人的场景没必要画出来了。</li>
<li>『CLANNAD』。CL 或许能称作为人生，但人生却不是一部 CL，毕竟人生不可能有光玉存在，看完『AIR』之后，Shaun 并没有什么很强烈的感触，所以直接又接着看了 CL，没想到着实让 Shaun 这堂堂七尺男儿好生体验了把热泪盈眶的感觉。另，CL 和 Air 的音乐也很赞，麻枝准真提莫的不负其大魔王的称号 （°Д°）Ъ。</li>
<li>『天降之物』。算是 Shaun 的入宅作了吧，没想到当时霓虹国的肉番也能做的这么精良，这里不得不赞一下「天降之物」的制作组，实在是太良心了，都破产了，还硬是把结局用 屁屁踢 形式放出来了，对比隔壁的『约会（pao）大作战』，可以说是有生之年了 ╮(╯▽╰)╭，不过还是比现在的肉番要好，现在的肉番只剩下肉了，还不如直接出里番 ๑乛◡乛๑ 。</li>
<li>『进击的巨人』。Shaun 只能说制作组的经费别烧的那么快啊，不然可能又是一个有生之年，感觉每一帧都在烧钱。<del>坐等同样制作精良的今年4月番『东京喰种』第三季 (๑´ڡ`๑)</del> ，坐等个屁啊，『东京喰种』第三季这屎一样的剧情和画风 （╯‵□′）╯︵┴─┴，做成这样宁愿是个有生之年，还是滚去看看漫画是什么样子吧，希望 7 月番的「巨人」不要这样。</li>
<li>『龙珠』系列。童年回忆啊，虽然目前还在更「龙珠超」，但是已经找不到童年时的感觉了。</li>
<li>『犬夜叉』。虽说中学时代就听童靴讨论过，但 Shaun 真正接触还是在本科时代，剧情设计的很好，音乐也很赞。</li>
<li>『死神』。感觉打完蓝染之后直接结束还是一部很好的作品。</li>
<li>『新世纪福（quan）音（qian）战士』。以当时的社会环境看应该是很黄很暴力了，如果没看过TV版的EVA，直接看剧场版就行，剧场版差不多就是TV版的高清重制，虽然重制的画面很良心，但这也改变不了其圈钱的本质，你要出个正儿八经的完结篇或者对剧情进行完善补充该多好。</li>
<li>『浪客剑心』。个人觉得TV版打败志志雄就可以结束了，「追忆篇」也十分不错，「巴」和「熏」都可以说是剑心的救赎者。</li>
<li>『钢之炼金术师FA』。Shaun 没看过 03 版的钢炼，只能说 FA 不管是音乐还是剧情都堪称完美（Shaun 不知道真正的完美应该是什么样子），塑造的人物都有血有肉。</li>
<li>『噬魂师』。这部动画的结局骨头社也做的太水了 o(︶︿︶)o，不然也是一部上佳之作。</li>
<li>『瑞克和莫蒂』。很有意思的美漫，各种天马行空的想象，对一些事物的毒舌吐槽也无敌了 (≧ω≦)。</li>
<li>『魔法少女小圆』。其实一开始要 Shaun 看魔圆， Shaun 是拒绝的，因为一听名字就以为是什么少女漫 (#-_-)，后面看了一下又没法接受那奇诡的画风，尤其是魔女出来的时候，卧槽，这 TM 是啥么鬼 (⊙_⊙)？后面无聊的时候看了几集勉强就能接受了，不过说好的要做「爱的战士」呢？结局就这样？(╯°□°）╯︵ ┻━┻，还好剧场版稍微补充了一下，音乐也很好听。美好的事物表面可能隐藏着最深的邪恶，丑陋的事物表面也可能隐藏着无尽的美好，当然，对于宇宙维稳来说，QB 的做法没错，但对于马猴烧酒来说，这就很残忍了，但人类也不会在意蝼蚁的想法吧，所以与其说是悲剧，不如说是真实，正如结局魔女是不存在了，但其它的魔物出现了。</li>
<li>『零之使魔』。其实 Shaun 是看完「夏娜」第一季之后看的，虽说夏娜和露易丝的都是钉宫配的，但个人感觉还是露易丝萌一点呢 ～(￣▽￣～)，才人万人斩那里的 BGM 实在是斯巴拉西，最后居然不是后宫，啊啊啊 🔥，可惜了蒂法那么大的欧派了，说好的 naizi 即正义呢 _(:з」∠)_。</li>
<li>『Angle Beats!』。AB 是曾经的一个室友推荐看的，说实话不知道是 Shaun 没看懂还是咋的，没看出什么名堂啊，只能说 OP 很赞。</li>
<li>『潜行吧！奈亚子』。吐槽能力很有意思啊，还有全宇宙最长的呆毛，可以说很萌了，搞不懂为啥会被禁，难道是奈亚子表达爱意的方式太露骨了 (ಡωಡ)。</li>
<li>『夏洛特』。网易云音乐推荐的，ED 很好听啊，看了动画只记得主角好像把全世界的超能力都吸收了，其它的剧情也不记得了，初次看到奈绪的图片还以为是奈亚子（雾）。</li>
<li>『紫罗兰永恒花园』。个人还是有点无法体会剧中的感情，只能说画面做的很精致。一开始还以为是神马科幻战争片，毕竟女主的手摆在哪里 （雾）。</li>
<li>『少女终末旅行』。也是网易云推荐的，主要是第五集的插曲很好听呢，以一种轻松的心态看这种沉重的番另有一番滋味。emmm……，知道漫画的结局之后还是感觉很沉重，（哇的一声就哭了 😭），这或许就是最深的绝望了吧，堪比「迷雾」，想必漫画作者的刀片应该收了不少呢，（突然黑化 ヾ(▼ﾍ▼；)ｵｲｺﾗ）。其实第 9 集的ED也很好听，可惜 OST 没有收录，MMP，只能截取音频听听了。</li>
<li>『来自深渊』。不行，刚看完「末旅」，心情太沉重了，要看点稍微轻松的冷静一下，抚慰一下 Shaun 受伤的心灵，「深渊」虽然相比日常番还是沉重一些，但至少不绝望，感觉还是有 “希望” 的，期待下一季。</li>
<li>『宝石之国』。骨肉魂的设定很有意思，只记得第九集台词老师说：“强大的力量总伴随着孤独”，也正如「B站」下的某个评论所说：“或许这就是成长所需要的代价”。个人感觉人的成长也是如此，成长意味着不再天真，不再给别人添麻烦，但这中间会失去许多，人与人之间的隔阂也越来越大，至于是好事还是坏事就只有自己知道了，有些东西只有直接接触之后才知道是好是坏。成长之后就会自然而然的开始求真，当然有很大一部分人会在求真之路上迷失自我，继续浑浑噩噩，却又不似初始的天真，而是成为一种活死人状态，成为社会这个大机器上的一个微小零件，少一个不少，多一个也不多。如果说第一季是成长之路，那下一季应该就是求真之路了。</li>
<li>『滑头鬼之孙』。百鬼夜行时的 BGM 很赞呀！只怕是天国的第三季了。</li>
<li>『Kill La Kill』（又名双斩少女、斩服少女）。emmm，这中文名怎么说呢，其实还挺符合剧情的，但总感觉哪里不对。作为一部热血番，剧情 bug 一点也可以理解，想必「真子」为这番拉了不少人气（官方鬼畜代表，好萌 ╭(╯3╰)╮）。</li>
<li>『恶魔人 Crybaby』。地狱空荡荡，恶魔在人间，达成成就在恶魔人里看恶魔人，音乐很带感，rap 也很棒，愚昧的人做出的恶行更让人感到可悲。</li>
<li>『NEW GAME!』。一部标准的日常番，作为一名即将成为社畜的秃头人，希望能碰到不错的上司和同事吧。</li>
<li>『怪诞小镇』。和「瑞克和莫蒂」有点类似，也是一集一个小故事，不过更侧重家人之间的相处。</li>
<li>『爱，死亡和机器人』。少儿不宜，成人动画看起来真爽，暴力血腥涩清一个都不少，连 jier 都做出来了，CG 也很不错，有几集的脑洞还是可以的。</li>
<li>『虫师』。设定非常好，音乐也好听，一集一个小故事，至于主线剧情就算了，两季都很模糊。</li>
<li>『游戏人生』。王女是本番的福利担当了，空白就是少年漫画的主人公，op和ed都挺好听的，可惜应该是天国的第二季了。</li>
<li>『剑豪生死斗』。里面没有一个世俗意义上的好人，剑之极致或许确实只需要一招。</li>
<li>『精灵守护者』。为救人而杀人，根本毫无意义，整个世界的设定和虫师有点类似，都是两个世界并存，叫精灵旅人感觉更好。</li>
<li>『关于我转生变成史莱姆这档事 』。和“骨王”的设定有点类似，一出山就基本无敌了，而且还不知道自己有多强，萌就完事了，不会期待下一季了。</li>
<li>『哥布林杀手』。就算是简单的小事做到极致也很不简单，总感觉这番还有个里版。</li>
<li>『火之鸟』。生命的延续，「异形篇」在当时那个年代确实很惊艳，但剧情缺陷在于女主留在寺庙不就是给自己增加罪恶，最好的办法难道不就是悄无声息的离开？反正能离开寺庙也说明其罪已赎完。</li>
<li>『新石纪 Dr.STONE』。虽然漏洞很明显（一人记住一个文明的知识，6 人创造一个绵延两千多年的村落），但设定比较有意思，勉强可以算是瑕不掩瑜，第二季也就随缘了。</li>
<li>『Hell Sing OVA』。据说一定要看 OVA 版， 出于某些原因，Shaun 找了一段时间终于找到了一个能在线看的，成人动画看起来确实爽快，后期的音乐也很不错，和 「黑街」一样都是大叔风，可惜 黑街 估计没第二季了 😔。</li>
<li>『一拳超人』。打斗的作画确实很精良，和搞笑漫画的主角打架就是在找死 ๑乛◡乛๑ 。</li>
<li>『天元突破红莲螺岩』。单纯的中二热血，剧情感觉有点没意思，男主算是比较惨的，中后期的政治游戏稍微有点意思，但剧情杀剧情活就一点意思都没得了。</li>
<li>『希德尼娅的骑士』。难得的硬科幻动画了，虽然碍于动画表现内容少，部分剧情有些突兀，但能接受，作者的「BLAME!」宇宙设定真的很可以，希望全系列以后都能动画化，第一季的 OP 也好听 ♪(´▽｀) 。</li>
<li>『异兽魔都』。第一季都是谜团啊，剧情和制作都还可以，期待第二季。</li>
<li>『大剑』。这番没有男主，有的只是故事的见证者，万恶的组织，迪妮莎的设定太强了，又被剧情杀，导致后期的人物再强都有种违和感，相反 天元突破 中大哥的处理就很好。</li>
<li>『夏目友人帐』。真治愈系，算是很轻松的番，虽然每集的故事都不太一样，也知道作者想探讨一些东西，但感觉还是有点太平淡了，过于弱化主角。</li>
<li>『葬送的芙莉莲』。「所谓的英雄无论如何都会被后人擅自美化，然后在美化的过程中，连原型都会消失的无影无踪」，时间才是对每个人都公平的东西，过去了就过去了，追忆也难以补偿。</li>
</ul>
<h2 id="comic-篇">Comic 篇</h2>
<p>　　漫画，Shaun 看的比较少，了解也不多，就不做评价了。印象里比较深的就是『伊藤润二』系列中的「漩涡」了，看完这个 Shaun 只能感叹作者的奇思妙想了。还有就是当年在追三大民工漫的时候，有时为了提前了解剧情，也会去看一下其漫画。当然偶尔也会看一下那个，，，那种漫画 (⁄ ⁄•⁄ω⁄•⁄ ⁄) ，毕竟刺激性更强，画面感更强，像那个「搞笑漫畫日和」什么的（诶，在想什么呢 (￣ε(#￣)☆╰╮(￣▽￣///)）。</p>
<h2 id="game-篇">Game 篇</h2>
<p>　　游戏，Shaun 也玩的比较少，小时候在小伙伴家里偶尔会蹭一下 FC 游戏，中学时陪同学玩街机，也两下子就把游戏币给玩没了 Σ(ﾟдﾟ;)，大学时玩通两三个单机，专注的玩了一个手游，至于什么网络游戏就根本没玩过，Shaun 还是偏向于动作冒险类游戏。</p>
<ul>
<li>『奥日与黑暗森林』（Ori and the Blind Forest）。巨硬出品，必属精品，不管是画质，画风，音乐都是五星好评，但是手残党伤不起啊，有些关卡的难度简直是阶跃性的 /つ∇T)。期待续作『奥日与精灵意志』（Ori and the Will of the Wisps）。</li>
<li>『鬼泣』系列（Devil May Cry）。这个系列 Shaun 没一个通关的，只是稍微玩过一下，不得不说卡普空公司虽然经常炒冷饭，但是其制作也确实精良，可以说是动作类游戏的代表作了，打击感和连招特效都超带感，dei劲，以后有时间再给它通关。</li>
<li>『艾希ICEY』。算是国产游戏的佳作了，只是碍于其独立游戏的经费，最大的不足之处就是其体量也太小了吧，两个小时打通绰绰有余，而且通关之后就没有欲望玩第二次了，玩法比较单一。</li>
<li>『菲斯 Fez』。「纪念碑谷」就是受到这款游戏的启发，其中的一些玩法和游戏元素也借鉴了这款游戏，这款游戏简直太斯（sang）巴（xin）拉（bing）西（kuang），还有依靠 BGM 解谜的，这种操作还真没见过（也有可能是 Shaun 游戏玩的太少了 o(╯□╰)o），这是 Shaun 玩的第一个多周目游戏，每周目都会有新的体验，而且这游戏的世界观真是惊人，数学中的维度在这游戏里面会有一种非常直观的体验，尤其是每周目结束时的剧情动画。</li>
</ul>
<h2 id="novel-篇">Novel 篇</h2>
<p>　　小说，也算是中学时代入的坑吧，在本科前两年达到顶峰，目前处于逐渐退坑的状态，一来确实是没有什么小说吸引 Shaun 了；二来是没那么多时间看小说了。</p>
<ul>
<li>『驭兽斋』，作者：雨魔。可以算是 Shaun 这么多年的网络小说生涯的入坑之作了，现在虽然剧情忘记了，但当年看的如痴如醉的感觉却没忘。</li>
<li>『仙逆』，作者：耳根。还是当年在小白时代看的，可以说印象非常深了，个人感觉「凡人修仙传」和它没法比。</li>
<li>『幽冥仙途』，作者：减肥专家。这个是 Shaun 渡过小白时代书荒的时候在书荒吧看到别人推荐的，这简直是暗黑系的典范，或许李珣的人生才是人生该有的样子。</li>
<li>『贩罪』，作者：三天两觉。很有意思的写法，各种插叙蒙太奇手法，画面感极强，作者的吐槽能力MAX啊。</li>
<li>『死人经』，作者：冰临神下。Shaun 武侠小说看得极少，像什么金庸、古龙等人的小说 Shaun 一部也没看看过，只是看过相关的影视作品，但这部小说确实 Shaun 痴迷的看完了，虽然以当前的眼光看其好像还是有点金庸那种 “掉进悬崖就能得到绝世武功” 的味道，但是主角却还是慢慢成长变化的，并不是一触而就的状态。</li>
<li>『亵渎』，作者：烟雨江南。这本书还是 Shaun 入坑时期看的，所以一些剧情完全忘记了，只记得有一只很有意思的骷髅。回想当年看书真是不挑剔啊，无论什么书，只要知道个名字就会去看完，也是在那段时间，把番茄、唐三、辰东等的作品都看完了，也逐渐脱离小白时代，不得不说，当年这些作品对 Shaun 三观的形成还是有很大影响的。另外以现在的眼光来看就是感觉这些作者的作品只需要选择一本代表作看看就行（eg：唐三（斗罗大陆）、土豆（斗破苍穹）、番茄（盘龙）、辰东（神墓）），毕竟一个作者的风格确实很难改变，其它的也是差不多的套路，一般来说一个作者因一部作品封神之后，很难再写出超越之作，从某种意义上来说这并不是江郎才尽，而只是人只有在特定的时候才能有特定的想法，发挥比较好而已。</li>
<li>『 无极魔道』，作者：逆苍天。后期书荒时偶然看到的，没想到还是一部很不错的作品，快意恩仇，最后居然把所有人都坑杀了。</li>
<li>『庆余年』，作者：猫腻。也是后期书荒看，本来 Shaun 是不大想看这种架空历史小说的，但是看了之后感觉里面的权谋很有意思。</li>
<li>『紫川』，作者：老猪。这本书 Shaun 没读完，主要是当时的状态不适合看这本书，里面有些情节以当时的状态实在是没法看下去。</li>
<li>『佣兵天下』，作者：说不得大师。这本书也是 Shaun 小白时代看的，记得这本书当年好像是在看完「静官」的『兽血沸腾』之后看的，当时只感叹其友情。</li>
<li>『诛仙』，作者：萧鼎。以 Shaun 现在的眼光来看感觉有点名过其实。</li>
<li>『鬼吹灯』，作者：天下霸唱。这本书 Shaun 也没看完，其实 Shaun 是先看的『盗墓笔记』，后面才去看鬼吹灯，所以也稍微了解了一下这两部作品的渊源，个人感觉，盗墓笔记还是很大一部分借鉴了鬼吹灯，而且盗墓笔记感觉后面有点胡乱写的味道。</li>
<li>『恶魔法则』，作者：跳舞。Shaun 小白时代看的作品，剧情也全都忘记了，不做评价，依稀记得好像有点搞笑。</li>
<li>『七界传说』，作者：心梦无痕。算是 Shaun 看的第一本这种风格的小说——主人公刚出山就差不多是无敌之姿了，后期的对手也不是庸人，感觉十分有意思。</li>
<li>『升邪』，作者：豆子惹的祸。读起来感觉很轻松的一本小说。</li>
<li>『宠魅』，作者：鱼的天空。记得当时看这本小数是为了找一本类似于 驭兽斋 描写宠物的小说，于是就找到了这本，感觉结局还是有点虐心，现在想起来还是有点不好受。</li>
<li>『长生不死』，作者：观棋。里面的计谋还是很有意思，居然用传销之法颠覆一个国家的经济，好像是的吧。</li>
<li>『风姿物语』，作者：罗森。不愧是誉为“现代玄幻小说鼻祖”的网文，后面玄幻小说的模式或多或少都能在这里看到影子。作者也真是个人才，不仅正经的网文写的不错，而且小 h 书也写的很溜，像小黄书中的典范，「阿里布达年代祭」和「六朝」系列等。</li>
<li>『星空倒影』，作者：弦歌雅意。很有意思的写作角度，从旁观者的角度见证英雄的大起大落，虽说整个故事和其它的西幻套路差不多，但胜在短小精悍，角度新颖。</li>
<li>『仙路烟尘』，作者：管平潮。很有古典仙侠意味的一部的小说，作者的文采也是一流的，但对主角性格把控的不是很到位，导致有些章节读起来有点突兀，不是那么连贯。</li>
<li>『巫师之旅』，作者：一行白鹭上青天。作者的设定很厉害，很久没看过这么新奇的小说了。</li>
<li>『全球进化』，作者：咬狗。关于生命体进化层次的设定很有意思。</li>
<li>『雪中悍刀行』，作者：烽火戏诸侯。中间有些部分的设定很迷，应该是作者断更时间太长了，自己也记不清楚了，不过整体来说文笔还行，铺垫很长，至于收尾就不说了。</li>
<li>『仙葫』，作者：流浪的蛤蟆。反派都是运气极差，能力无法发挥，而且都是睿智。</li>
<li>『神秘之旅』，作者：滚开。算是无限流，各个世界穿越，为剧情需要，部分章节前后设定矛盾。</li>
<li>『飞升之后』，作者：皇甫奇。设定很有意思，算是打怪升级的改进版。</li>
<li>『恶魔狂想曲之明日骄阳』，作者：胡鳕。短小精悍，快的话一天就能看完，但内容确实可以，不过也许是太短的缘故，Shaun 竟然完全没有印象，在看第二遍的时候才发现好像看过。</li>
<li>『人道纪元』，作者：亲吻指尖。写的很混乱，尤其是到后期，有些剧情完全圆不过来。</li>
<li>『走进修仙』，作者：吾道长不孤。作者很强，应该看过很多东西，看得出里面也有很多设定是直接借鉴别人的，里面的梗也很多，总的来说还是很值得一看的。</li>
<li>『随身带着异形王后』，作者：龙青衫。当时看的时候还觉得挺有意思的，就是 YY 异形在异界如何横行，没记错的话，异种还被娘化了。</li>
<li>『圣者』，作者：九鱼。很久没看西幻了，这部的设定很不错，剧情可以说旧瓶装新酒吧，同样的打怪升级流，看起来却有着不同的意味。</li>
<li>『明日之劫』，作者：熊狼狗。虽然套路很小白，但里面有些桥段设计的却很可以，融合了很多梗，再里面能看到很多书和电影动漫的影子。</li>
<li>『尘缘』，作者：烟雨江南。后期还是有点烂尾了，基本一天就能看完，江南的文采还是可以的。</li>
<li>『修真四万年』，作者：卧牛真人。 虽然很长，但是还是很值得的一看的，作者算是网文写手里难的有思想的一批了，可惜后期收不住了，有点烂尾的感觉。</li>
<li>『民调局异闻录』，作者：耳东水寿。总体还是感觉有点幽默的，就是看的主角很憋屈，尤其是第一人称，后期战斗力和反派有点太崩了。</li>
<li>『知北游』，作者：洛水。时间数值设定太崩了，文采还行，普通玄幻小说套路。</li>
<li>『灵舟』，作者：九当家。后宫文，擦边球打的挺好的 ๑乛◡乛๑ ，设定还可以，不过有些剧情还是很多余，和大部分小说一样，后期的进度都崩了。</li>
<li>『蛊真人』，作者：蛊真人。大男主文，不需要任何感情戏，唯一写的就是方源不折手段的追逐理想，比较黑暗，但又现实，杀人放火金腰带，修桥补路无尸骸。</li>
<li>『末世召唤狂潮』，作者：黑心的大白。作者想黑又没有一黑到底，主角也时而强化时而弱化时而聪明时而愚蠢，看起来有点别扭。</li>
<li>『大奉打更人』，作者：卖报小郎君。很不错的文抄文，爽点到位。</li>
<li>『奥术神座』，作者：爱潜水的乌贼。知识就是力量，法国就是培根，要是真有人以小说的形式写一下数理史，想必对数理的科普会有重大意义。</li>
<li>『异界兽医』，作者：油炸包子。还算不错的西幻文，比较轻松，结尾还是当年挺喜欢整的时间轮回。</li>
<li>『剑道邪尊』，作者：残剑。看的比较憋屈，太刻意了，剧情很混乱，修炼和战斗写的不错，主角的战力也有些莫名其妙，坑太大且啰嗦。</li>
<li>『烂柯棋缘』，作者：真费事。很轻松的小说，很有古典仙侠的意味，侠之大者，兼济天下。</li>
<li>『紫阳』，作者：风御九秋。看小说十余载后难得的仙草了，作者还是很有思想的，虽有遗憾，亦得圆满。</li>
<li>『我不可能是剑神』，作者：裴不了。年纪大了，还是看些轻松诙谐点的好，作者取名也有一股子恶趣味，有点 overload 骨王的味道。</li>
<li>『地球纪元』，作者：彩虹之门。短小精悍的硬科幻，不需要和『三体』比较，各有各的优秀。</li>
<li>『我的细胞监狱』，作者：穿黄衣的阿肥。作者能把自己看过的东西揉在一起写出来，且能自圆其说，剧情连贯，也是很有能力了。</li>
<li>『垂钓之神』，作者：会狼叫的猪。很明显能看出诸多前辈的影子，不过能把这么多东西杂在一起，也算是自成一家了，剧情进展把控还行，不过这种超长篇后面还是少看比较好 😓。</li>
<li>『三途志』，作者：崔走召。又一本短小精悍的小说，虽然有些场景剧情需要，但不妨碍作者对人生的思考。</li>
<li>『重活了』，作者：尝谕。不愧是 0 字白金，人物的性格塑造很拿手。</li>
<li>『大乘期才有逆袭系统』，作者：最白的乌鸦。很轻松搞笑的无敌文，虽然有部分场景比较水，但不妨碍看起来很舒服流畅。</li>
<li>『蛆蝇尸海剑』，作者：失落之节操君。文笔和设定一流，剧情一言难尽，各种神兵天降，大部分的冲突都是由糟糕的感情引起，因爱生恨的把戏玩的比较牵强，刻意，不过或许人也确实善变，稍有不如意就 180 度转变。</li>
<li>『长生志异，开局菜市口被斩首』，作者：真愚老人。正如作者自己对本书的评价的一样，大眼珠子对小说有个很深刻的见解——好的小说不在于设定多么新奇宏大，而在于一个好的故事，设定是为故事情节服务的。</li>
<li>『仙路争锋』，作者：缘分0。前期的智斗还挺有意思，反派也智商在线，中期也慢慢落入俗套，打怪升级，越阶杀敌，不过这也是爽点，大后期就有点崩了，算是长篇的通病了。</li>
<li>『重生之超级战舰』，作者：彩虹之门。以打怪升级的套路写科幻设定下的故事，科幻设定还能自圆其说，确实是被书名耽误的仙草，想象力惊人，对剧情的把控也很有节奏，给读者一种身临其境的感觉。</li>
<li>『我只想安静的做个苟道中人』，作者：爆炸小拿铁。有点反套路的系统文，作者文笔不错，逻辑通顺，挖坑必填，至于后宫算是见仁见智了，唯一不好的是题文不符 :P。</li>
<li>『仙路春秋』，作者：高慕遥。兄弟情义，人性本贪，手段卑劣，集体无智，很多剧情非常刻意，不自然，很别扭，不爽，尤其是最后的剧情，就是强行喂读者吃屎。</li>
<li>『帝霸』，作者：厌笔萧生。水生是真能水，里面一些有意思的思考都淹没在了水下，感觉水生应该是看过「血酬定律」的。往往是那些美好的愿望，把人们带入了人间地狱；世间没有救世主，救世主或许有一天会变成更大的灾难；总是打着为你好的幌子为自己好；不是鱼和羊需要养鱼人和牧羊人，而是养鱼人和牧羊人需要鱼和羊，鱼和羊总有天是要被吃的；心无期待，便是没有失望，一旦失望，便是灾难之始。</li>
<li>『神秘复苏』，作者：佛前献花。「当世人呼喊你名字的那一刻，代表着灵异时代即将终结。」，前面灵异设定和故事性都很不错，后面虽然稍显混乱但也还算连贯，在那个时代还能完本已经很不错了，网友的评价也很有意思——写鬼超人，写人超鬼。</li>
</ul>
<h2 id="后记">后记</h2>
<p>　　以后有看过或回想起看过的作品再继续更新吧 （↖(^ ω ^)↗）。</p>
]]></content>
      <categories>
        <category>Life</category>
      </categories>
      <tags>
        <tag>thought</tag>
      </tags>
  </entry>
  <entry>
    <title>C++中static用法小结</title>
    <url>/posts/b93d943b.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　static 是 C++ 中很常用的一个关键字，它的用法也很多，时常会将其弄混，索性做个小结，以免以后忘记了或者继续弄混 (｡･ω･｡)。</p>
<span id="more"></span>
<h2 id="预备篇">预备篇</h2>
<p>　　首先要了解程序中数据的存储形式，一般而言数据的存储形式有三种：</p>
<ul>
<li>栈区（stack）—— 由编译器自动分配释放，一般用来存放函数的参数值，局部变量的值等；</li>
<li>堆区（heap）—— 由程序员分配释放，对应于对象的 new 或 malloc 和 delete 或 free，若程序员忘记释放，则在程序完全退出之后由操作系统回收；</li>
<li>静态存储区（static）—— 在编译时由编译器分配，在程序完全退出时由操作系统回收，一般用来存放全局变量和 static 变量。</li>
</ul>
<p>　　一般<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>声明的变量默认（如果变量类型，eg: int, double, ... 等，前不加 static 或其它关键字）都是 auto <a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>的，其一般存放在栈区，生存周期就只在包围其的 <code>&#123; &#125;</code> 内，在包围其的 <code>&#123; &#125;</code> 外就无法使用该变量。而 static 存放在静态存储区，其生存周期是全局的，它要等整个程序完全退出时才会销毁，<strong><em>在程序运行过程中，每次调用 static 变量都保持上一次调用结束后的值</em></strong>。</p>
<h2 id="类中篇">类中篇</h2>
<h3 id="静态成员变量">静态成员变量</h3>
<p>　　类中的静态成员变量被该类的所有实例共享，也可以不通过类的实例使用，在使用时首先需要对其初始化，也必须对其进行初始化，因为类中的静态成员变量只是声明，而且，类中的静态成员变量和普通静态变量一样是在程序初始化的时候分配的，在程序完全退出时由操作系统回收。具体用法如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> s_value;	<span class="comment">// 注意，这里不能初始化！因为其不属于类对象，只属于类作用域，独立于该类的任何实例</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在cpp中或类定义体外必须对它进行定义和初始化，因为在程序编译时首先执行的就是对其初始化并分配内存：</span></span><br><span class="line"><span class="keyword">int</span> Test::s_value = <span class="number">0</span>;	<span class="comment">// 注意，这里没有static的修饰！</span></span><br></pre></td></tr></table></figure></div>
<p>总而言之就是：<strong>类中的静态成员变量可以简单理解为一个名为 <code>Test::s_value</code> 的全局变量，被所有该类的实例共用，但独立于该类的任何实例，只属于该类作用域，在类的定义中能且只能被声明，不能在类定义体中进行初始化，必须要在类定义体外被定义和初始化</strong>。</p>
<h3 id="静态成员函数">静态成员函数</h3>
<p>　　类中的静态成员函数和类中的静态成员变量有点类似，其在实现时不需要再加 static 修饰，同样能被该类的所有实例复用，同样只属于类作用域中的全局函数，同样不需要类的实例即可调用。类中的静态成员函数不能访问类的普通成员变量，只能访问类的静态成员变量（可以参考 <a href="http://www.cnblogs.com/rickyk/p/4238380.html">C++静态成员函数访问非静态成员的几种方法</a> 中的小 trick 访问普通成员变量，但非特殊情况不建议这么做）。具体用法如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span></span><br><span class="line"><span class="class">&#123;</span>  </span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span> i)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 静态成员函数调用非静态成员变量方法</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">staticTest</span><span class="params">(Test *t)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        t-&gt;value += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="keyword">int</span> value;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在cpp中可以不通过类的实例进行调用：</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Test::func</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br></pre></td></tr></table></figure></div>
<p>总而言之就是：<strong>类中的静态成员函数可以简单理解为一个名为 <code>Test::func(int)</code> 的全局函数，能被该类的所有实例复用，但独立于该类的任何实例，只属于该类作用域，可以不通过类的实例进行调用，也可以像普通成员函数一样通过类的实例进行调用</strong>。</p>
<h2 id="特定范围篇">特定范围篇</h2>
<p>　　为了使全局变量或函数只在特定 cpp 文件中起作用，需要在 cpp 文件中相应变量或函数前添加static 修饰，如下表：</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">类型</th>
<th style="text-align: center;">.h 文件中</th>
<th style="text-align: center;">.cpp 文件中</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">全局变量</td>
<td style="text-align: center;">不使用 static 修饰，使用 extern 修饰</td>
<td style="text-align: center;">使用 static 修饰</td>
</tr>
<tr class="even">
<td style="text-align: center;">全局函数</td>
<td style="text-align: center;">不使用 static 修饰</td>
<td style="text-align: center;">使用 static 修饰</td>
</tr>
</tbody>
</table>
<ul>
<li>如果在头文件中声明 static 全局变量，则在包含该头文件的每个 .cpp 文件中都会生成一个独立的同名变量，而这种写法没有任何意义；如果在 .cpp 文件中不使用 static 声明全局变量，则该全局变量可能会被其它 .cpp 文件共享，也可能不会，造成该变量的不确定性；所以如果该全局变量要被所有 .cpp 文件共享，则需要在头文件中声明 extern 全局变量（eg：<code>extern int g_value;  // 注意，不要初始化值！</code>），再在某个 .cpp 文件中单独进行定义和初始化（仅一次）（eg：<code>int g_value = 0;   // 不要extern修饰！</code>），如此即可在每个 .cpp 文件中共享该全局变量；而若只想在单个 .cpp 文件中使用全局变量，则需要在该 .cpp 文件中全局范围类声明和定义 <code>static int g_value = 0;</code>，如此可保证该变量能且只能被该 .cpp 文件使用。</li>
<li>如果在 .cpp 文件中不使用 static 声明全局函数，则该全局函数可能会被其它 .cpp 文件共享，也可能不会，这样在别的 .cpp 文件调用同名函数时可能会出现问题；而在头文件中使用 static 声明全局函数同样没有任何意义；所以如果要被多个 .cpp 文件复用，就将其声明移到头文件中，且不需要 static 修饰，而若只想在特定 .cpp 文件中使用该全局函数，则需要在声明时添加 static 修饰。</li>
</ul>
<p>最后，若是在 .hpp 文件中，则需要去除全局对象，将全局函数封装为类的静态方法。</p>
<p>　　<strong><em>PS：</em></strong>若在函数中使用 static 修饰变量，则该函数无法做到线程安全，在程序运行过程中，每次调用该函数，函数内的 static 变量都将保持上一次调用结束后的值，<strong><em>所以在函数中慎用 static 变量，除非需要这个特性</em></strong>。</p>
<h2 id="后记">后记</h2>
<p>　　写这篇文章的初衷在于时常需要 static 时老是忘记或弄混它的用法，不得不去网上查找，虽说网上的相关资料也有很多，但在找的时候还是有点麻烦，毕竟有很多不是自己需要的，而且自己总结一下对其理解又更深一些，下次要用时也能马上找到自己所需。</p>
<h2 id="参考资料">参考资料</h2>
<p>[1] <a href="https://blog.csdn.net/mznewfacer/article/details/6898005">c/c++ static 用法总结（三版本合一）</a></p>
<p>[2] <a href="http://developer.51cto.com/art/201104/254141.htm">C++中static的用法总结</a></p>
<p>[3] <a href="https://blog.csdn.net/men_wen/article/details/64443040">C++ 类中的static成员的初始化和特点</a></p>
<p>[4] <a href="http://www.cnblogs.com/rickyk/p/4238380.html">C++静态成员函数访问非静态成员的几种方法</a></p>
<section class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>这里的一般是指局部变量，若为全局变量则默认为 extern ，局部变量没有默认初值，其初值不确定，一般需要人为明确的赋初值，而全局变量默认初值为 0 ，一个比较好的编程习惯是声明一个变量就对其进行初始化（赋初值），尽量少用全局变量，全局变量显示声明 extern。<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p><strong><em>※注：</em></strong>这里的 auto 与 C++11 中的意义不同，这里的 auto 指的是变量的存储形式，而不是 C++11 那种可以当做任意的变量类型，eg: int, double, std::vector&lt;std::vector&lt;double&gt;&gt;, ...... ，与其对应的还有 extern 和 register 关键字，其中 register 关键字基本不用 。<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
]]></content>
      <categories>
        <category>Study</category>
      </categories>
      <tags>
        <tag>c/cpp</tag>
      </tags>
  </entry>
  <entry>
    <title>C++数组中的坑</title>
    <url>/posts/fc1165b7.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　在写快排的时候偶然发现了 C++ 数组中的一个坑，具体表现为：对数组元素进行无临时变量的自交换时竟然会将数组该元素置为 0，这应该是 <del>C++ 的一个 BUG</del> Shaun 脑子抽了。</p>
<span id="more"></span>
<h2 id="交换函数篇">交换函数篇</h2>
<p>　　据参考资料 [1] 中， C++ 的交换函数可以有如下三种写法：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 第一种：使用模板，创建临时变量</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span> <span class="function"><span class="keyword">void</span> <span class="title">swap</span><span class="params">(T &amp;a, T &amp;b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">T <span class="title">temp</span><span class="params">(a)</span></span>; a = b; b = temp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第二种：无临时变量，针对int,double等内建数值类型的基本运算（以double为例）</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">double</span> &amp;a, <span class="keyword">double</span> &amp;b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	a = a + b;</span><br><span class="line">	b = a - b;</span><br><span class="line">	a = a - b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第三种：无临时变量，针对int的异或运算</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">int</span> &amp;a, <span class="keyword">int</span> &amp;b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// a ^= b ^= a ^= b;</span></span><br><span class="line">	a = a ^ b;</span><br><span class="line">	b = b ^ a;</span><br><span class="line">	a = a ^ b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>　　其中，第一种是通用的交换方法，无论做什么交换都能用第一种，但需要创建一个临时对象；而第二种不需要创建一个临时对象，只能用在 int，double 等内建数值类型上，且存在溢出的风险；第三种同样不需要创建临时对象，只能用在 int 类型上，由于采用位运算，所以不存在溢出的风险，且效率最高。</p>
<h2 id="bug-复现篇">BUG 复现篇</h2>
<p>　　bug 复现代码如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span> <span class="function"><span class="keyword">void</span> <span class="title">swap_1</span><span class="params">(T &amp;a, T &amp;b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">T <span class="title">temp</span><span class="params">(a)</span></span>; a = b; b = temp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">swap_2</span><span class="params">(<span class="keyword">int</span> &amp;a, <span class="keyword">int</span> &amp;b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	a = a + b;</span><br><span class="line">	b = a - b;</span><br><span class="line">	a = a - b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">swap_3</span><span class="params">(<span class="keyword">int</span> &amp;a, <span class="keyword">int</span> &amp;b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	a ^= b ^= a ^= b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> data[] = &#123; <span class="number">0</span>, <span class="number">3</span>, <span class="number">8</span>, <span class="number">2</span>, <span class="number">9</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">5</span> &#125;;</span><br><span class="line">	<span class="keyword">int</span> a = <span class="number">1</span>, b = <span class="number">2</span>, c = <span class="number">3</span>;</span><br><span class="line">	swap_1&lt;<span class="keyword">int</span>&gt;(data[a], data[b]);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d\t%d\n&quot;</span>, data[a], data[b]);	<span class="comment">// 输出 8	3</span></span><br><span class="line">	swap_1&lt;<span class="keyword">int</span>&gt;(data[a], data[a]);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d\t%d\n&quot;</span>, data[a], data[a]);	<span class="comment">// 输出 8	8</span></span><br><span class="line">	<span class="built_in">swap_2</span>(data[a], data[b]);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d\t%d\n&quot;</span>, data[a], data[b]);	<span class="comment">// 输出 3	8</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">swap_2</span>(data[a], data[a]);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d\t%d\n&quot;</span>, data[a], data[a]);	<span class="comment">// ***输出 0	0***</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">swap_3</span>(data[b], data[c]);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d\t%d\n&quot;</span>, data[b], data[c]);	<span class="comment">// 输出 2	8</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">swap_3</span>(data[b], data[b]);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d\t%d\n&quot;</span>, data[b], data[b]);	<span class="comment">// ***输出 0	0***</span></span><br><span class="line">	</span><br><span class="line">	std::<span class="built_in">swap</span>(data[<span class="number">4</span>], data[<span class="number">5</span>]);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d\t%d\n&quot;</span>, data[<span class="number">4</span>], data[<span class="number">5</span>]);	<span class="comment">// 输出 4	9</span></span><br><span class="line">	std::<span class="built_in">swap</span>(data[<span class="number">4</span>], data[<span class="number">4</span>]);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d\t%d\n&quot;</span>, data[<span class="number">4</span>], data[<span class="number">4</span>]);	<span class="comment">// 输出 4	4</span></span><br><span class="line">	</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>　　目前没有找到什么好的解决方案，<strong>只能老老实实的用第一种创建一个临时变量的交换方法</strong>，或者<strong>在交换之前先判断一下是不是同一个元素，若不为同一个元素，才进行交换，否则不交换，即避免自交换</strong>。</p>
<h2 id="后记">后记</h2>
<p>　　刚开始出现这个问题的时候，Shaun 还纳闷了，怎么写个快排把数组元素都改变了，刚开始根本没想到这茬，还以为是 Shaun 代码的问题，倒着检查了好几遍，换第一种交换方式以及换个冒泡排序用一样的交换方式进行排序输出结果都没问题，后面使出终极调试法，一个个的输出看看才知道原来是自交换的锅。</p>
<p>　　如果有大佬知道为什么会出现这个问题还望不吝赐教 ◔ ‸◔?。经 @ <strong>Magnesium12</strong> 大佬提醒，这个问题由于引用引起的，采用第二种方法进行交换时如果两个数是完全一样的（地址也一样），则在进行两数相减时，由于是引用，所以这两个数完全一样，则最后会导致这两个完全一样的数，即自交换的该数置为 0 。</p>
<h2 id="参考资料">参考资料</h2>
<p>[1] <a href="https://blog.csdn.net/ryfdizuo/article/details/6435847">谈谈C++中的swap函数</a></p>
]]></content>
      <categories>
        <category>Problems</category>
      </categories>
      <tags>
        <tag>c/cpp</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker使用小结</title>
    <url>/posts/3d8ab974.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　最近由于项目部署需要，简单学习了 docker 的使用和回顾下 CentOS 中的常用操作。</p>
<span id="more"></span>
<h2 id="docker-篇">Docker 篇</h2>
<p>　　由于 Shaun 此次需要安装的环境有点偏门，没找到有完全符合要求的镜像，同时也趁着这次机会学一下 docker，所以就还是直接从最开始的装起了。</p>
<p>　　首先使用 <code>docker pull centos:7</code> 拉取 CentOS7 的系统镜像，使用 <code>docker images</code> 查看已有的本地镜像信息，使用 <code>docker ps -a</code> 查看当前已有的容器信息，去掉参数 a ，即显示正运行的容器，<code>docker stop [container id | name]</code> 可关闭指定容器，<code>docker start [container id | name]</code> 可打开指定容器，<code>docker rm [container id | name]</code> 可删除指定容器，<code>docker rmi [image id | name]</code> 可删除指定镜像，再删除镜像之前需要先删除依赖该镜像的所有容器。</p>
<p>　　使用 <code>docker run -dit -p 80:80 -p 8080:8080 --name CentOS7 centos:7 bash</code> 开启一个新的容器，其中参数的意义为： <strong>-i</strong>: 交互式操作；<strong>-t</strong>: 终端；<strong>-d</strong>: 后台启动；<strong>-p</strong>: 设置主机的端口映射到容器内的端口；<strong>-name</strong>: 指定容器名称；最后的 bash 代表使用 bash 终端。<em>在 windows 中直接使用 docker run 运行镜像时会出现 the input device is not a TTY. If you are using mintty, try prefixing the command with 'winpty' 的错误，前面加上 winpty 即可，即 <code>winpty docker run ...</code></em>。当没有参数 d 时，则直接进入容器，而当存在参数 d 时，由于容器实在后台启动，进入容器时需要执行 <code>docker exec -it [container id | name]  bash</code> 才能进入容器，而退出容器可以输入 <code>exit</code> 命令。</p>
<p>　　而为了在容器中可以开启后台服务，需要在开启容器时就进行提权，在 Windows 中提权命令为 <code>docker run -dit --privileged=true --name CentOS7 centos:7 init</code>；而在 Linux 中提权命令为 <code>docker run -dit --privileged=true --name CentOS7 centos:7 /usr/sbin/init</code>。</p>
<p>　　在新开启的容器中添加数据和相应的环境之后，即可使用 <code>docker commit CentOS7 new_image:tag</code> 生成一个新的镜像（生成镜像之前最好关闭容器），该镜像包含已经安装的环境和数据，再使用 <code>docker save -o centos7.tar new_image:tag</code>，可将生成的镜像导出成 tar 包，在其他机器中使用 <code>docker load -i centos7.tar</code> 即可导入该 tar 包，并生成相应的镜像， 从而简单便捷的完成环境和数据迁移部署任务。</p>
<p>　　容器有时需要和主机之间传输文件，有两种方案，一种是直接采用共享文件夹的方式，设置某个目录为两系统的共享目录，从而实现文件传输；另一种是使用 docker cp 命令，使用 <code>docker cp src_path container:dst_path</code> 将主机的文件拷贝到容器中；使用 <code>docker cp container:src_path dst_path</code> 将容器的文件拷贝到主机中。</p>
<h2 id="centos-篇">CentOS 篇</h2>
<h3 id="安装postgresql12">安装PostgreSQL12</h3>
<p><a href="https://www.cnblogs.com/zhi-leaf/p/11432054.html">CentOS安装PostgreSQL</a></p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Install the repository RPM:</span></span><br><span class="line">yum install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Install PostgreSQL:</span></span><br><span class="line">yum install -y postgresql12-server</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Optionally initialize the database and <span class="built_in">enable</span> automatic start:</span></span><br><span class="line">/usr/pgsql-12/bin/postgresql-12-setup initdb</span><br><span class="line">systemctl enable postgresql-12</span><br><span class="line">systemctl start postgresql-12</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">开启远程访问</span></span><br><span class="line">修改/var/lib/pgsql/10/data/postgresql.conf文件，</span><br><span class="line">取消 listen_addresses 的注释，将参数值改为“*”</span><br><span class="line"></span><br><span class="line">修改/var/lib/pgsql/10/data/pg_hba.conf文件，增加下</span><br><span class="line"><span class="meta">#</span><span class="bash"> IPv4 <span class="built_in">local</span> connections:</span></span><br><span class="line">host all all 127.0.0.1/32 md5</span><br><span class="line">host all all 0.0.0.0/0 md5</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 给数据库postgres用户分配密码 1</span></span><br><span class="line">psql -U postgres</span><br><span class="line">alter user postgres with encrypted password &#x27;1&#x27;;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启服务</span></span><br><span class="line">systemctl restart postgresql-12</span><br></pre></td></tr></table></figure></div>
<p>由于需要切换账户，所以最好在第一步安装完之后就使用 <code>passwd [username] XXXXXX</code> 设置 root 和 postgres 两个账户的密码。</p>
<h3 id="安装postgis">安装postgis</h3>
<p>（https://yum.postgresql.org/12/redhat/rhel-7-x86_64/repoview/）</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 解决依赖</span></span><br><span class="line">yum install epel-release </span><br><span class="line"></span><br><span class="line">yum install -y https://yum.postgresql.org/12/redhat/rhel-7-x86_64/postgis30_12-3.0.2-2.rhel7.x86_64.rpm</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装pgrouting</span> </span><br><span class="line">yum install -y https://yum.postgresql.org/12/redhat/rhel-7-x86_64/pgrouting_12-3.0.2-1.rhel7.x86_64.rpm</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装ogr_fdw</span> </span><br><span class="line">yum search ogr_fdw # 查询</span><br><span class="line">yum install ogr_fdw # 安装</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
<p>postgres 移除扩展 <code>drop extension postgis cascade;</code>。</p>
<h3 id="安装java">安装Java</h3>
<p>（https://www.cnblogs.com/bcomll/p/12142747.html）</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 搜素java</span></span><br><span class="line">yum search java | grep -i --color JDK</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">安装</span></span><br><span class="line">yum install java-11-openjdk</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置环境变量</span></span><br><span class="line">vi /etc/profile</span><br><span class="line"><span class="meta">#</span><span class="bash"> 加入内容</span></span><br><span class="line">export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-11.0.8.10-0.el7_8.x86_64</span><br><span class="line">export CLASSPATH=.:$JAVA_HOME/jre/lib/rt.jar:$JAVA_HOME/jre/lib/dt.jar:$JAVA_HOME/lib/tool.jar</span><br><span class="line">export PATH=$PATH:$JAVA_HOME/bin</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启环境</span></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure></div>
<h3 id="安装geoserver">安装GeoServer</h3>
<p>（https://blog.csdn.net/weixin_34205076/article/details/88734828）</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="code"><pre><span class="line">mv /tmp/geoserver-2.13.2 /usr/share/geoserver</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## 添加环境变量</span></span></span><br><span class="line">vi /etc/profile</span><br><span class="line"><span class="meta">#</span><span class="bash"> 追加</span></span><br><span class="line">export GEOSERVER_HOME=/usr/share/geoserver</span><br><span class="line"><span class="meta">#</span><span class="bash"> 重新加载/etc/profile文件</span></span><br><span class="line">source /etc/profile</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 授权</span></span><br><span class="line">chown -R root:root /usr/share/geoserver</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">### 改造启动脚本</span></span></span><br><span class="line">vim /usr/share/geoserver/bin/startup.sh</span><br><span class="line">     </span><br><span class="line"><span class="meta">#</span><span class="bash"> 在最上面引入环境变量</span></span><br><span class="line">source /etc/profile</span><br><span class="line">     </span><br><span class="line"><span class="meta">#</span><span class="bash"> 最后执行改为nohup，并将日志输入到 var/<span class="built_in">log</span>/geoserver.log</span></span><br><span class="line">nohup &quot;$_RUNJAVA&quot; $JAVA_OPTS $MARLIN_ENABLER -DGEOSERVER_DATA_DIR=&quot;$GEOSERVER_DATA_DIR&quot; -Djava.awt.headless=true -DSTOP.PORT=8079 -DSTOP.KEY=geoserver -jar start.jar 1&gt;/dev/null 2&gt;/var/log/geoserver.log &amp;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">### 修改停止脚本</span></span></span><br><span class="line">vim /usr/share/geoserver/bin/shutdown.sh</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在最上面引入环境变量</span></span><br><span class="line">source /etc/profile</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">### 创建服务</span></span></span><br><span class="line">vim /lib/systemd/system/geoserver.service  </span><br><span class="line">     </span><br><span class="line">[Unit]</span><br><span class="line">Description=geoserver service</span><br><span class="line">After=network.target</span><br><span class="line">     </span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line">ExecStart=/usr/share/geoserver/bin/startup.sh</span><br><span class="line">ExecReload=</span><br><span class="line">ExecStop=/usr/share/geoserver/bin/shutdown.sh</span><br><span class="line">Restart=on-abort</span><br><span class="line">     </span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 开机自启</span></span></span><br><span class="line">systemctl enable geoserver</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 开启服务</span></span></span><br><span class="line">systemctl start geoserver</span><br></pre></td></tr></table></figure></div>
<h3 id="安装-nginx">安装 nginx</h3>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="code"><pre><span class="line">yum install nginx # 下载并安装nginx</span><br><span class="line"></span><br><span class="line">systemctl start nginx # 启动nginx服务</span><br></pre></td></tr></table></figure></div>
<p>　　在 /etc/nginx 下可修改 nginx.config 文件，监听端口默认是 80，直接输入本地地址可能并打不开网页，因为直接这样安装的 nginx 的可能“有毒”，在 /usr/share/nginx/html 目录中 index.html 可能并不是一个 html 文件，而只是快捷方式，需要从别的地方拷贝一个真正的 index.html 文件替换该文件才可正常打开网页。</p>
<h3 id="安装-nodejs">安装 nodejs</h3>
<p>（https://github.com/nodesource/distributions）</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="code"><pre><span class="line">curl -sL https://rpm.nodesource.com/setup_10.x | bash -</span><br><span class="line"></span><br><span class="line">yum install -y nodejs</span><br></pre></td></tr></table></figure></div>
<h2 id="vscode-远程篇">VSCode 远程篇</h2>
<p>　　需要安装 VSCode 远程开发插件 https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.vscode-remote-extensionpack，包括（Remote - WSL，Remote - Containers，Remote - SSH）。</p>
<p>在远程资源资源管理器中 切换到 SSH Targes 标签，点击设置设置，在 C:/Users/用户名/.ssh/config 中输入</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="code"><pre><span class="line">Host [随便写]</span><br><span class="line">  HostName remote-ip 或 域名</span><br><span class="line">  User 远程服务器用户名</span><br></pre></td></tr></table></figure></div>
<p>　　配置SSH，通过命令 <code>ssh-keygen -t rsa -b 4096</code> 生成密钥对（在 C:/Users/用户名/.ssh/ 目录中），将公钥内容拷贝到远程服务器<code>/root/.ssh/authorized_keys</code> 中，修改配置文件 <code>/etc/ssh/sshd_config</code>，取消 <code>#PubkeyAuthentication yes</code> 注释，允许使用基于密钥认证的方式登录。重启 sshd 服务 <code>systemctl restart sshd</code>。<em>通过 VSCode ssh 远程连接在结束之后最好将终端全部删除，尤其是最开始的那个 install server 终端。</em></p>
<p>　　设置好SSH之后，通过在 VSCode 中设置 <code>"docker.host":"ssh://your-remote-user@your-remote-machine-fqdn-or-ip-here"</code>，可以直接连接在远程服务器上的 docker。<strong>该设置最好用于 工作区设置，而不是 用户设置。</strong></p>
<p>　　VSCode 远程连接 SSH 有时可能会出现无法连接，一直尝试连接的现象，这时需要粗暴的删除 ~/.vscode-server 目录，重新进行连接，不行的话就只能参考: https://stackoverflow.com/questions/56718453/using-remote-ssh-in-vscode-on-a-target-machine-that-only-allows-inbound-ssh-co，先关闭远程服务器上已存在的所有 vscode-server 进程，通过 <code>https://update.code.visualstudio.com/commit:$COMMIT_ID/server-linux-x64/stable</code> 下载 tar 包，使用 <code>tar -xvzf vscode-server-linux-x64.tar.gz --strip-components 1</code> 后再重新连接。</p>
<h2 id="后记">后记</h2>
<p>　　据查 docker 依然存在很多缺点，尤其是守护进程，Shaun 这两天在 Windows 中使用 Docker 也时不时的出现 docker 卡死的问题，需要重启 docker 服务， 以后有机会还是使用 Podman 吧。RedHat 系的 yum 也快退休了，以后再需要安装软件可能就直接上毒奶粉（bushi）dnf 了。VSCode 远程开发是真的舒服，文件无缝传输，任意修改，可以尽情享受现代编辑器的方便。</p>
]]></content>
      <categories>
        <category>Study</category>
      </categories>
      <tags>
        <tag>note</tag>
        <tag>container</tag>
        <tag>unix-like</tag>
      </tags>
  </entry>
  <entry>
    <title>FFmpeg提取与合并命令使用小结</title>
    <url>/posts/6315717b.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　前面有一段时间需要对视频做一些简单的处理，所以就去查了一下一些常用的视频处理工具，因为不想再另外装个什么软件，所以就决定直接采用 <a href="https://www.ffmpeg.org/">FFmpeg</a> 了，毕竟其它的一些视频处理软件也极有可能只是对 FFmpeg 进行一些图形化界面的封装而已。</p>
<span id="more"></span>
<p>　　而在查找 FFmpeg 相关资料的时候，也同时发现了 <a href="https://www.libav.org/">Libav</a> ， 对于 FFmpeg 和 Libav Shaun 只想说，开源界的战争总是这么莫名其妙，有各种各种一些奇怪的原因（或许大佬们都是各有各的脾性吧 ╮(╯▽╰)╭），像两个小飞机的战争也是如此，不过神仙打架，凡人享福也好 ~\(≧▽≦)/~。神仙们的想法我等凡人是无法揣测了，不过这种事还是少出点为好，不然下次变为小鬼遭殃就不好了。</p>
<p>　　使用 FFmpeg 而不是 Libav 是因为 FFmpeg 的相关资料相对来说要多很多；而且Libav 更新的特性，FFmpeg 全都支持；更重要的是 FFmpeg 是更新特别频繁，差不多是日更了，几乎每天都会发布一个稳定版；而且从两者的下载页面来看， FFmpeg 好像更会照顾跨平台用户一点。下文主要是对 FFmpeg 的部分命令进行记录总结。</p>
<p><em>Shaun 的系统环境为 Win10 1607，测试的 FFmpeg 版本为 ffmpeg-20180429-19c3df0-win64-static</em>。</p>
<p>　　在 Win10 下使用 FFmpeg 前首先需要配置系统环境变量，Windows 下 FFmpeg 的安装是下载完 Windows 版编译好的 FFmpeg 压缩包后直接解压即可，<strong>将解压后的 FFmpeg 文件夹中的 bin 目录添加到系统环境变量 Path 中</strong>，不然系统会无法找到 ffmpeg 命令。</p>
<h2 id="提取命令">提取命令</h2>
<p>　　FFmpeg 的提取命令的参数很多，因此可以使用不同参数排列组合达到不同的提取效果，具体如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># （1）快速提取video.mp4从第一分钟开始持续两分钟的视频，即到第三分钟，并将提取结果输出为cut.mp4</span></span><br><span class="line">ffmpeg -ss 00:01:00 -i video.mp4 -to 00:02:00 -c copy cut.mp4</span><br><span class="line"></span><br><span class="line"><span class="comment"># （2）快速提取video.mp4从第一分钟开始持续两分钟的视频，即到第三分钟，并将提取结果输出为cut.mp4</span></span><br><span class="line">ffmpeg -ss 00:01:00 -i video.mp4 -t 00:02:00 -c copy cut.mp4</span><br><span class="line"></span><br><span class="line"><span class="comment"># （3）快速提取video.mp4从第一分钟开始到第二分钟的视频，并将提取结果输出为cut.mp4</span></span><br><span class="line">ffmpeg -ss 00:01:00 -i video.mp4 -to 00:02:00 -c copy -copyts cut.mp4</span><br><span class="line"></span><br><span class="line"><span class="comment"># （4）精确提取video.mp4从第一分钟开始到第二分钟的视频，并将提取结果输出为cut.mp4</span></span><br><span class="line">ffmpeg -i video.mp4 -ss 00:01:00 -to 00:02:00 -c copy cut.mp4</span><br><span class="line"></span><br><span class="line"><span class="comment"># （5）精确提取video.mp4从第一分钟开始持续两分钟的视频，即到第三分钟，并将提取结果输出为cut.mp4</span></span><br><span class="line">ffmpeg -i video.mp4 -ss 00:01:00 -t 00:02:00 -acodec copy -vcodec copy cut.mp4</span><br><span class="line"></span><br><span class="line"><span class="comment"># （6）快速提取video.mp4从第三分钟开始持续60秒的视频，即到第四分钟，并将提取结果输出为cut.mp4</span></span><br><span class="line">ffmpeg -ss 00:03:00 -i video.mp4 -t 60 -c copy -avoid_negative_ts 1 cut.mp4</span><br></pre></td></tr></table></figure></div>
<p>以下为各参数的含义：</p>
<ul>
<li><code>-i</code>：用法为 <code>-i INPUT_VIDEO</code>，代表输入的视频，该视频应为 MPEG 编码（h.264, MPEG4/divx/xvid, MPEG2; MP2, MP3, AAC） ；</li>
<li><code>-ss</code>：用法为 <code>-ss START_TIME</code>，代表提取的开始时间，时间格式有两种写法：1、纯数字格式，以秒为单位（eg: <code>-ss 90</code>，代表从第90秒开始提取）；2、时:分:秒 格式（eg: <code>-ss 00:01:30</code>，代表从 0 时 1 分 30 秒开始提取）；</li>
<li><code>-to</code>：用法为 <code>-to STOP_TIME</code>，代表提取的结束时间，时间格式同样有两种写法：1、纯数字格式，以秒为单位（eg: <code>-to 180</code>，代表第180秒结束提取）；2、时:分:秒 格式（eg: <code>-to 00:03:00</code>，代表 0 时 3 分 00 秒结束提取）；</li>
<li><code>-t</code>：用法为 <code>-t DURATION_TIME</code>，代表提取的持续时间，时间格式同样有两种写法：1、纯数字格式，以秒为单位（eg: <code>-to 180</code>，代表提取持续180秒）；2、时:分:秒 格式（eg: <code>-to 00:03:00</code>，代表提取持续 0 时 3 分 00 秒）；</li>
<li><code>-c</code>：用法为 <code>-c CODEC</code>，代表音视频编码格式（若 CODEC 为 <code>copy</code> 则代表输出视频的音视频编码格式与原视频一样），其实 <code>-c</code> 是 <code>-codec</code> 的缩写，其中包含音频编码参数 <code>-acodec</code> 和 视频编码参数 <code>-vcodec</code> ；</li>
<li><code>-copyts</code>：保持原有时间戳，即使当 <code>-ss</code> 在 <code>-i</code> 之前时，仍使 <code>-t</code> 和 <code>-to</code> 保持原有效果，不会被同化；</li>
<li><code>-avoid_negative_ts</code>：当开启该参数时，提取视频会找到首尾的相邻关键帧（这样会造成提取时间不精确），补全视频，当 <code>-ss</code> 在 <code>-i</code> 之前时该参数默认开启；</li>
<li><code>-accurate_seek</code>：使提取时间更精确，在转码时该参数默认启用。</li>
<li>更多参数可参考：<a href="https://ffmpeg.org/ffmpeg-all.html#Format-Options">Format-Options</a> 。</li>
</ul>
<p><strong>※注：</strong> 1、<code>-t</code> 和 <code>-to</code> 不能同时使用，若同时使用，将以 <code>-t</code> 为准；　　2、当 <code>-ss</code> 在 <code>-i</code> 之前时，可以实现快速提取，但提取的时间点不精确，此时<code>-to</code> 和 <code>-t</code> 的效果一样，都表现为 <code>-t</code> ，此时可以加上 <code>-copyts</code> 参数使两者效果不一样；　　3、当 <code>-ss</code> 在 <code>-i</code> 之后时，提取的时间点比较精确，但提取速度比较慢。</p>
<p>　　以上命令（1）、（2）是一样的提取结果，命令（3）的 <code>-t</code> 和 <code>-to</code> 会产生不一样的结果，（6）的 <code>-t</code> 和 <code>-to</code> 会产生一样的结果。<strong>因此若只考虑速度，可以使用命令（3），若需使提取时间精确，则需使用命令（4）和（5）</strong>。</p>
<p><strong>PS：</strong>当然还有一种更精确的方式，通过命令 <code>ffmpeg -i input.mp4 -strict -2 -qscale 0 -intra output.mp4</code> 将输入视频由原来的帧间编码转换为帧内编码，使每一帧都成为关键帧，如此转换之后再进行提取，可使提取时间十分精确，但该转换方式会造成视频文件空间成倍增大。</p>
<h2 id="合并命令">合并命令</h2>
<p>　　FFmpeg 的合并命令大概有 4 种，可参考： <a href="https://blog.csdn.net/doublefi123/article/details/47276739">FFMpeg无损合并视频的多种方法</a> 。这里主要介绍两种：</p>
<h3 id="方法一使用-ffmpeg-concat-分离器推荐">方法一：使用 FFmpeg concat 分离器（推荐）</h3>
<p>　　该方法使用命令为：<code>ffmpeg -f concat -i filelist.txt -c copy output.mp4</code>，其中 filelist.txt 文件最好和待合并的视频在同一个文件夹中，文件中内容就是待合并的视频的描述，具体内容如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="code"><pre><span class="line">file &#x27;input1.mp4&#x27;</span><br><span class="line">file &#x27;input2.mp4&#x27;</span><br></pre></td></tr></table></figure></div>
<p>或</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="code"><pre><span class="line">file ./input1.mp4</span><br><span class="line">file ./input2.mp4</span><br></pre></td></tr></table></figure></div>
<p><strong>※注：</strong> <em>待合并的视频文件名最好由英文、数字、连接符（<code>-</code>）或下划线（<code>_</code>）组成，且中间最好不要有空格，不然可能会因为文件名而在合并时出现一些奇怪的错误</em>。</p>
<h3 id="方法二利用中间格式合并">方法二：利用中间格式合并</h3>
<p>　　所谓利用中间格式进行合并是因为可能有些待合并的视频编码不一致，这时采用方法一可能无法进行合并，这时需要对待合并的视频的进行统一转码，都转成同一个编码格式。若要采用这种方法，建议都转成 mpg 格式，因为 mpg 格式可以直接 cat 命令进行合并，具体如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 将input1.avi转成intermediate1.mpg,输出视频质量为1</span></span><br><span class="line">ffmpeg -i input1.avi -qscale:v 1 intermediate1.mpg</span><br><span class="line"><span class="comment"># 将input2.mp4转成intermediate2.mpg,输出视频质量为1</span></span><br><span class="line">ffmpeg -i input2.mp4 -qscale:v 1 intermediate2.mpg</span><br><span class="line"><span class="comment"># 合并intermediate1.mpg和intermediate2.mpg，输出合并结果intermediate_all.mpg</span></span><br><span class="line">cat intermediate1.mpg intermediate2.mpg &gt; intermediate_all.mpg</span><br><span class="line"><span class="comment"># 将intermediate_all.mpg转成output.avi,输出视频质量为2</span></span><br><span class="line">ffmpeg -i intermediate_all.mpg -qscale:v 2 output.avi</span><br></pre></td></tr></table></figure></div>
<p>　　其中参数 <code>-qscale</code> 是指使用固定的视频量化标度 ，取值范围为 0.01 ~ 255 ，越小代表质量越好，一般推荐取值为 2 ~ 5，实际使用不能超过 50， <code>-qscale:v</code> 代表设置视频输出质量。</p>
<p><strong>PS：</strong> <em>方法一为无损合并，方法二为有损合并</em>。</p>
<h2 id="后记">后记</h2>
<p>　　以后有用到新的命令再继续记录吧 ↖(^ω^)↗ 。纯命令行不太方便的话，可以试试 <a href="http://avidemux.sourceforge.net/download.html">Avidemux</a>，全平台通用。</p>
<h2 id="参考资料">参考资料</h2>
<p>[1] <a href="https://ffmpeg.org/ffmpeg.html">ffmpeg Documentation</a>（<a href="https://ffmpeg.org/documentation.html" class="uri">https://ffmpeg.org/documentation.html</a>）</p>
<p>[2] <a href="http://trac.ffmpeg.org/wiki/Seeking">FFmpeg wiki: Seeking</a>（<a href="http://trac.ffmpeg.org/wiki" class="uri">http://trac.ffmpeg.org/wiki</a>）</p>
<p>[3] <a href="http://fzheng.me/2016/01/08/ffmpeg/">FFmpeg：视频转码、剪切、合并、播放速调整</a></p>
<p>[4] <a href="https://segmentfault.com/a/1190000000414341">通过 ffmpeg 无损剪切/拼接视频</a></p>
<p>[5] <a href="https://blog.csdn.net/u012587637/article/details/51670975">使用ffmpeg合并视频文件的三种方法</a></p>
]]></content>
      <categories>
        <category>Study</category>
      </categories>
      <tags>
        <tag>ffmpeg</tag>
      </tags>
  </entry>
  <entry>
    <title>Geometry增量更新</title>
    <url>/posts/a5661762.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　优化 DrawCall 是图形学性能优化中老生常谈的问题，而针对 DrawCall 优化有很多方案，大致可分为两种：简化（Simplification）和合并（Consolidation），简化是指减少三角形个数，即将精细的模型变为粗糙的模型以及各种三角形剔除方案（视锥体剔除（Frustum Culling），遮挡剔除（Occlusion Culling）等），而合并自然则是将同一中材质下的多个 geometry 合并成一个 geometry。</p>
<span id="more"></span>
<h2 id="需求篇">需求篇</h2>
<p>　　最近一段时间一直在做高精地图道路的编辑，道路的编辑涉及到很多东西，这篇仅简单谈谈编辑性能的问题。为了能更直白的显示高精地图，不能简单的只使用点和线，还需要使用面将路面和路面上的一些路面标识精确的还原出来。在可视化道路时，主要有两种方案：1、将每条道路作为一个单独的 Mesh，即单独控制每条道路的渲染，一条道路至少产生一次 DrawCall，这样可以更方便的对每条道路进行编辑，但在渲染时要求更高的性能，而且道路一多，将不可避免的引起卡顿；2、将所有道路作为一个 Mesh，即直接渲染出一整个路网，这样显著降低了 DrawCall 次数，使渲染更流畅，但问题在于每编辑一次道路时，都需要重新三角化（Tessellation）整个路网，而且在选中一条道路时，为可视化选中效果，同样需要重新三角化该道路，并生成相应的 Mesh，导致编辑卡顿，每编辑完一次都可能需要等待一会儿。所以为了平衡渲染性能和编辑效率，需要有一种折中的方案，即对整个路网的 Geometry 能做到快速的分离与合并，在编辑时将受影响的道路分离出来，而在编辑之后，又将全部道路合并一下，提高显示性能。下面就谈谈 Shaun 对这种方案的一些思考。</p>
<h2 id="编辑篇">编辑篇</h2>
<p>　　Shaun 为平衡渲染性能和编辑效率，想出的一种方案是增量更新 Geometry，即只删除或增加局部的 Geometry，而其它不受影响的 Geometry 保持原样，如此即可达到快速的分离和合并 Geometry。具体做法如下：</p>
<ol type="1">
<li><p>首先将所有道路的三角化结果合并成一个 Geometry，在合并的同时建立好每条道路的顶点索引以及面的索引（js 中可直接使用 object 进行存储）；</p></li>
<li><p>在选择时，根据顶点索引和面索引重建一个 Geometry，再基于该 Geometry 构建一个新的 Mesh 以指示选择效果；</p></li>
<li><p>当删除道路时，需要删除面索引对应的所有面，而顶点索引对应的顶点不需要删除，将顶点索引移到一个用来标识该部分顶点已废弃的容器 F 中；</p></li>
<li><p>当新增道路时，需要先从容器 F 中查找是否有合适的地方放置该道路的顶点，若有，则放置在对应地方，并更新容器 F 中对应元素，若没有，则将该道路的顶点放置在 Geometry 顶点数组的最末尾，放置完顶点之后，同样需要建立该道路的顶点索引和面索引。</p></li>
</ol>
<p><strong><em>※注：</em></strong>至于容器 F 使用怎样的数据结构以及其中的元素该怎样排列，针对不同的顶点索引可以有不同的选择；在新增道路时，同样可以不同的策略来决定放置顶点的位置（可参考操作系统内存分配的模式）。</p>
<p>　　由于新增道路时，可能会在容器 F 中产生一些永远无法删除的元素，导致顶点数组空闲碎片。 为抵抗顶点碎片以及减少顶点数目，需要对顶点数据进行压缩（Compaction），即移除没有使用的顶点，将后面的顶点前移，在前移顶点的同时，别忘了需要同时修改面中相应顶点的索引以及更新构建好的每条道路的顶点索引。</p>
<h2 id="后记">后记</h2>
<p>　　Shaun 这里只是提出了一种想法，最终实现起来发现效果也确实能达到基本需求（针对有很多条道路的大地图，显示性能从原来的十几二十帧到现在的 60 帧，同时选择和编辑也没受到影响），虽然在内存上比原来多增加了近 20%（还有优化的余地），但是为了渲染流畅以及编辑舒服，在如今这个内存越来越不值钱的年代，这种牺牲 Shaun 觉得是能接受的。当然或许有更好的方案，但限于 Shaun 目前的认知，只能暂时想到这一方案了，若有大佬有更好的方案，还望不吝赐教 🙏。</p>
]]></content>
      <categories>
        <category>Image&amp;Graphic</category>
      </categories>
      <tags>
        <tag>algorithm</tag>
      </tags>
  </entry>
  <entry>
    <title>GeoMesa踩坑指北</title>
    <url>/posts/9978824c.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　需要做个 GeoMesa 的微服务，简单熟悉一下 GeoMesa。</p>
<span id="more"></span>
<h2 id="基础篇">基础篇</h2>
<p>　　GeoMesa 可以说是大数据中的 PostGIS，主要用来在存储和处理 GIS 数据时提供相应的索引，从而加快处理速度。GeoMesa 基于 GeoTools，其中最重要的两个概念就是 SimpleFeatureType 和 SimpleFeature，SimpleFeatureType 对应的是关系型数据库中表的描述（表明，表的列字段属性信息等），而 SimpleFeature 对应的是表中每行数据。下面重点谈谈 GeoMesa 中的 SimpleFeatureType 以及其创建索引方式。</p>
<p>　　在 GeoMesa 中通常使用 SimpleFeatureTypes.createType 方法进行创建，该方法有两个重载，以没有 namespace 参数的方法为例：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">createType</span></span>(typeName: <span class="type">String</span>, spec: <span class="type">String</span>): <span class="type">SimpleFeatureType</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> (namespace, name) = parseTypeName(typeName)</span><br><span class="line">    createType(namespace, name, spec)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>先通过 parseTypeName 解析 typeName，以 <code>:</code> 作为分隔符，取最后一个有效（不为空）字符串作为表名（name），其余部分如有效则作为 namespace，否则 namespace 则为 null。spec 参数的通用形式有以下几种：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> spec = <span class="string">&quot;name:String,dtg:Date,*geom:Point:srid=4326&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> spec = <span class="string">&quot;name:String,dtg:Date,*geom:Point:srid=4326;geomesa.indices.enabled=&#x27;z2,id,z3&#x27;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> spec = <span class="string">&quot;name:String:index=true,tags:String:json=true,dtg:Date:default=true,*geom:Point:srid=4326;geomesa.indices.enabled=&#x27;z2,id,z3&#x27;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> spec = <span class="string">&quot;userId:String,trackId:String,altitude:Double,dtg:Date,*geom:Point:srid=4326;geomesa.index.dtg=&#x27;dtg&#x27;,geomesa.table.sharing=&#x27;true&#x27;,geomesa.indices=&#x27;z3:4:3,z2:3:3,id:2:3&#x27;,geomesa.table.sharing.prefix=&#x27;\\u0001&#x27;&quot;</span></span><br></pre></td></tr></table></figure></div>
<p>先使用 <code>;</code> 分隔符，再使用 <code>,</code> 分隔符，最后使用 <code>:</code> 分隔符。<code>;</code> 分隔符将 spec 分割为两个字符串：前者表示表中的全部列属性信息，列属性经过 <code>,</code> 分隔符分割为多列，列又经过 <code>:</code> 分隔符分割为 列名，列数据类型，列的一些属性（是否是索引，json 数据，默认索引等），而列名首字母 <code>*</code> 代表该字段是用于索引的 geometry 类型，一般采用 WKT 格式进行描述，当然存在数据库时会以字节码进行压缩；后者表示创建表时的 userData，同样经过 <code>,</code> 分隔符分割为多个 userData，userData 的一些默认属性可在 SimpleFeatureTypes.Configs 中看到，其它的可以用户自定义，这里重点说一下 <code>geomesa.indices.enabled</code> 属性，目前 GeoMesa 支持 8 种索引，分别为：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="code"><pre><span class="line">&quot;attr&quot;, // 属性索引</span><br><span class="line">&quot;id&quot;, // 主键索引</span><br><span class="line">&quot;s2&quot;, // Hilbert 曲线点空间索引</span><br><span class="line">&quot;s3&quot;, // Hilbert 曲线点时空索引</span><br><span class="line">&quot;z2&quot;, // Z 型曲线点空间索引</span><br><span class="line">&quot;xz2&quot;, // Z 型曲线线面空间索引</span><br><span class="line">&quot;z3&quot;,  // Z 型曲线点时空索引</span><br><span class="line">&quot;xz3&quot; // Z 型曲线线面时空索引</span><br></pre></td></tr></table></figure></div>
<p>　　由于 GeoMesa 中的索引一般存在多个版本，而 <code>geomesa.indices.enabled</code> 默认使用最新的版本，若需要指定版本，需要使用 <code>geomesa.indices</code>，<strong><em>该属性是 geomesa 内部属性，不对外开放</em></strong>，通用格式为：</p>
<p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="code"><pre><span class="line"><span class="string">s&quot;<span class="subst">$name</span>:<span class="subst">$version</span>:<span class="subst">$&#123;mode.flag&#125;</span>:<span class="subst">$&#123;attributes.mkString(&quot;:&quot;)&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></div></p>
<p>name 代表索引类别，version 代表索引版本，mode.flag 代表索引模式（是否支持读写，一般为3，支持读也支持写），attributes 代表是哪些字段需要建立该索引。spec 参数可以只有描述列属性的字段，即不带任何 useData 信息，GeoMesa 会默认添加索引信息，若存在空间和时间字段，则会默认建立 z3（空间字段为点 Point 类型） 或 xz3（空间字段为线面 非Point 类型） 索引，若有多个空间和时间字段，建立索引的字段为第一个空间和第一个时间字段；若只存在空间字段，则会建立 z2 或 xz2 索引；若只有时间字段，则默认建立时间属性索引。当然如没有在 spec 指明索引信息，可以在后续继续添加信息，如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="JAVA"><div class="code-copy"></div><figure class="highlight hljs java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.locationtech.geomesa.utils.interop.SimpleFeatureTypes;</span><br><span class="line"></span><br><span class="line">String spec = <span class="string">&quot;name:String,dtg:Date,*geom:Point:srid=4326&quot;</span>;</span><br><span class="line">SimpleFeatureType sft = SimpleFeatureTypes.createType(<span class="string">&quot;mySft&quot;</span>, spec);</span><br><span class="line"><span class="comment">// enable a default z3 and a default attribute index</span></span><br><span class="line">sft.getUserData().put(<span class="string">&quot;geomesa.indices.enabled&quot;</span>, <span class="string">&quot;z3,attr:name&quot;</span>);</span><br><span class="line"><span class="comment">// or, enable a default z3 and an attribute index with a Z2 secondary index</span></span><br><span class="line">sft.getUserData().put(<span class="string">&quot;geomesa.indices.enabled&quot;</span>, <span class="string">&quot;z3,attr:name:geom&quot;</span>);</span><br><span class="line"><span class="comment">// or, enable a default z3 and an attribute index with a temporal secondary index</span></span><br><span class="line">sft.getUserData().put(<span class="string">&quot;geomesa.indices.enabled&quot;</span>, <span class="string">&quot;z3,attr:name:dtg&quot;</span>);</span><br></pre></td></tr></table></figure></div>
<h2 id="坑篇">坑篇</h2>
<h3 id="导入-osm-数据问题">导入 OSM 数据问题</h3>
<p>　　在<a href="https://www.geomesa.org/documentation/stable/user/convert/premade/osm.html">导入 osm 数据</a>时，若使用 osm-ways 作为 SimpleFeatureType，则 geomesa 会使用数据库存储 node 临时使用，这时其默认使用 H2 Database，若想使用其它数据库，则需要在 lib 导入相应 jdbc 包，若使用 postgresql 数据库，则 geomesa 会触发一个 bug，因为 postgresql 没有 double 类型，只有 double precision 类型，这将导致建表出错。详情见 geomesa/geomesa-convert/geomesa-convert-osm/src/main/scala/org/locationtech/geomesa/convert/osm/OsmWaysConverter.scala 中</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">createNodesTable</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> sql = <span class="string">&quot;create table nodes(id BIGINT NOT NULL PRIMARY KEY, lon DOUBLE, lat DOUBLE);&quot;</span></span><br><span class="line">    <span class="type">WithClose</span>(connection.prepareStatement(sql))(_.execute())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>所以若需要使用 geomesa-convert-osm 导入 osm 数据时，需要进入 geomesa/geomesa-convert/geomesa-convert-osm 文件夹中输入命令</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="code"><pre><span class="line">mvn dependency:copy-dependencies -DoutputDirectory=./depLib</span><br></pre></td></tr></table></figure></div>
<p>导出 geomesa-convert-osm 依赖包，将其中的 h2，osm4j，dynsax，trove4j 等一系列库放入 $GEOMESA_HBASE_HOME/lib 中。</p>
<h3 id="s2-索引问题">s2 索引问题</h3>
<p>　　s2 索引即 Google S2 Geometry 算法基于 Hilbert 曲线生成一种索引，GeoMesa 的 s2 索引是一个国人提交的，目前 3.2 版本只支持点的时空索引，不支持线面的时空索引，当然官方也在实现自己的 Hilbert 曲线，希望后续 GeoMesa 中会有 h2 索引。Shaun 在导入 osm 数据并启用 s2 索引时，报错，被提示不支持，对比 geomesa-index-api2Index.scala 和 geomesa-index-api2Index.scala 两文件的 defaults 函数可发现 S2Index 直接返回空，而在 geomesa-index-api.scala 中 fromName 函数需要调用 defaults 函数，从而导致 s2 索引不支持，修改 S2Index 的 defaults 函数即可（别忘了在 S2Index 类中首行加上 <code>import org.locationtech.geomesa.utils.geotools.RichSimpleFeatureType.RichSimpleFeatureType</code>）。</p>
<h2 id="后记">后记</h2>
<p>　　暂时就了解了这么多，等后续熟悉的更多再继续更吧 (ง •_•)ง。</p>
<h2 id="附录">附录</h2>
<h3 id="geomesa-命令行工具部分参数">GeoMesa 命令行工具部分参数</h3>
<p>Geomesa 命令行参数：</p>
<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 74%" />
</colgroup>
<thead>
<tr class="header">
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>-c, --catalog *</td>
<td>存放 schema 元数据的catalog 表（相当于数据库）</td>
</tr>
<tr class="even">
<td>-f, --feature-name</td>
<td>schema 名（相当于数据库中的表）</td>
</tr>
<tr class="odd">
<td>-s, --spec</td>
<td>要创建 SimpleFeatureType 的说明（即表中列的描述信息，表的 schema，如 "name:String,age:Int,dtg:Date,*geom:Point:srid=4326"）</td>
</tr>
<tr class="even">
<td>-C, --converter</td>
<td>指定转换器，必须为一下之一：1、已经在classpath中的converter 名；2、converter 的配置（一个字符串）；3、包括converter的配置的名</td>
</tr>
<tr class="odd">
<td>–converter-error-mode</td>
<td>自定义的转换器的error mode</td>
</tr>
<tr class="even">
<td>-t, --threads</td>
<td>指定并行度</td>
</tr>
<tr class="odd">
<td>–input-format</td>
<td>指定输入源格式（如csv, tsv, avro, shp, json,）</td>
</tr>
<tr class="even">
<td>–no-tracking</td>
<td>指定提交的 ingest job何时终止（在脚本中常用）</td>
</tr>
<tr class="odd">
<td>–run-mode</td>
<td>指定运行模式，必须为：local（本地）、distributed （分布式）、distributedcombine（分布式组合）之一</td>
</tr>
<tr class="even">
<td>–split-max-size</td>
<td>在分布式中，指定切片最大大小（字节）</td>
</tr>
<tr class="odd">
<td>–src-list</td>
<td>输入文件为文本文件，按行输入</td>
</tr>
<tr class="even">
<td>–force</td>
<td>禁用任何的提示</td>
</tr>
<tr class="odd">
<td>[files]…</td>
<td>指定输入的文件</td>
</tr>
</tbody>
</table>
<p>参考资料：<a href="https://blog.csdn.net/qq_21705851/article/details/93392202">GeoMesa命令行工具---摄取命令</a></p>
]]></content>
      <categories>
        <category>Study</category>
      </categories>
      <tags>
        <tag>bigdata</tag>
        <tag>geomesa</tag>
      </tags>
  </entry>
  <entry>
    <title>C语言中整型提升问题</title>
    <url>/posts/2a3d46b0.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　今天有人问了 Shaun 一个移位的问题，就是下面这段 C 语言代码：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C"><div class="code-copy"></div><figure class="highlight hljs c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> a = <span class="number">0xffff</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%#hx\n&quot;</span>, a &lt;&lt; <span class="number">4</span> &gt;&gt; <span class="number">8</span> &lt;&lt; <span class="number">4</span>);</span><br></pre></td></tr></table></figure></div>
<p>你认为会输出什么结果？ ੧ಡ ⌣ ಡ੭</p>
<span id="more"></span>
<h2 id="解答篇">解答篇</h2>
<p>　　正确答案是：<code>0xfff0</code>。恐怕有一部分会像 Shaun 一样觉得答案就是 <code>0xff0</code> 才对，还像模像样的给出对应的说法：看 <code>a</code> 首先向左移四位，即去掉最左边的 <code>f</code>，右边补 4 个 0 变成这样 <code>0xfff0</code>；然后再向右移 8 位，a 将会变成这样 <code>0x00ff</code>；最后向左移四位，得到 <code>0x0ff0</code>，所以应该输出 <code>0xff0</code>。<strong>但是，正确答案终究是正确答案。</strong>之所以会输出正确答案，是因为这里面还有一个<strong>整型提升</strong>。所谓的整型提升就是：</p>
<blockquote>
<p>在一个表达式中，如果int能够表示原始类型中的所有数值，那么这个数值就被转成int型，否则，它被转成unsigned int型。这种规则被称为整型提升。所有其它类型都不会被整型提升改变。</p>
</blockquote>
<p>　　所以在 <code>a &lt;&lt; 4 &gt;&gt; 8 &lt;&lt; 4</code> 中，会先将 a 提升为 int 型，即 a 会变成 <code>0x0000ffff</code>，接着向左移四位，a 变成 <code>0x000ffff0</code>，再向右移 8 位，变成 <code>0x00000fff</code>，最后向左移 4 位，变成 <code>0x0000fff0</code>，最后为了输出，再做一个隐式的类型转换（由 int 转 unsigned short），得到 <code>0xfff0</code>，所以最后输出 <code>0xfff0</code>。</p>
<h2 id="后记">后记</h2>
<p>　　这个问题是一个刚入大学的童靴问 Shaun 的，刚问 Shaun 时 Shaun 还没反应过来，后来才想起有整型提升这么回事 o(╯□╰)o。btw，这位童靴主要是想去掉高 4 位和低 4 位只取中间 8 位的值，其实最简单的办法就是直接 <code>a &amp; 0x0ff0</code>，这样管它有没有整型提升，肯定能得到中间 8 位的值 (╯▽╰)。</p>
<h2 id="参考资料">参考资料</h2>
<p>[1] <a href="http://blog.csdn.net/mishifangxiangdefeng/article/details/47981889">C语言进阶：整型提升</a>（<a href="http://blog.csdn.net/mishifangxiangdefeng/article/category/1058873" class="uri">http://blog.csdn.net/mishifangxiangdefeng/article/category/1058873</a>）</p>
<p>[2] <a href="http://bbs.csdn.net/topics/390856773">对 unsigned char 先左移 后右移 可以出现两种结果</a></p>
]]></content>
      <categories>
        <category>Problems</category>
      </categories>
      <tags>
        <tag>c/cpp</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo+GitHub搭建个人博客</title>
    <url>/posts/d7965b48.html</url>
    <content><![CDATA[<p>Shaun 的系统环境：Win10_x64。</p>
<h2 id="前言">前言</h2>
<p>　　本来是想在国内某网站上继续写的，毕竟完全不需要自己管理，只需要负责写好文档就可以了，但某一天，该网站由于响应国家的号召，要实名验证，本来实名验证也没什么，就输入手机号，并填写验证码即可，但该网站实名验证的方式给人的感觉特别不爽，于是就决定自己搭建博客，这样虽然有点麻烦，但由于完全是自己管理，自己完全拥有该文档的所有权，也不用担心哪天别的网站突然出现的各种破问题，相比这种完全自由支配、无比爽快的感觉，管理这种麻烦就是小事了。</p>
<span id="more"></span>
<h2 id="github-hexo-个人博客搭建">GitHub + Hexo 个人博客搭建</h2>
<h3 id="准备篇">准备篇</h3>
<p><strong>在 GitHub 上搭建博客的要求：</strong></p>
<p>　　1、要有 GitHub 账号。（没有怎么办，没有就去<a href="https://github.com/join?source=header-home">注册</a>啊）</p>
<p><strong>使用 Hexo 框架的要求：</strong></p>
<p>　　1、需要安装 node.js。（电脑上没有安装怎么办，没有安装就去<a href="http://nodejs.cn/download/">下载</a>（<a href="https://nodejs.org/en/download/" class="uri">https://nodejs.org/en/download/</a>）安装啊）</p>
<p>　　2、需要安装 git。（没有安装就去<a href="https://git-scm.com/downloads">下载</a>安装，附 <a href="https://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000">git学习教程</a>）</p>
<h3 id="github-篇">GitHub 篇</h3>
<p>　　满足上文的要求之后，就可以开始搭建了，首先在 GitHub 中新建一个仓库（ <strong>New repository</strong> ），在 <strong>Repository name</strong> 下填写 <strong>&lt;yourname&gt;.github.io</strong> ，其它可默认，点击 Create repository。</p>
<p>　　新建仓库完成后，点击 <strong>Create new file</strong> 新建一个 <strong>README.md</strong> 文件，随便写点什么，比如 “It's my blog website”。</p>
<p>　　点击上方横条选项中的 <strong>Settings</strong> ，查看 <strong>GitHub Pages</strong> 里的设置，上方应该有绿色框，框中“<strong>Your site is published at https://&lt;yourname&gt;.github.io</strong>”，该网址即为博客主页，<strong>Source</strong> 应该是 <strong>master branch</strong>，自此 GitHub 上的设置可以算是完成了，但为了方便和防止误删，一般把 Hexo 文件也放入 GitHub 中，为方便管理，可以新建另一分支专门放 Hexo 文件。</p>
<p>　　在仓库 code 界面中点击 <strong>Branch：master</strong>，在出现的框中输入 hexo 新建 hexo 分支，在 <strong>branches</strong> 中 <strong>Change default branch</strong> 设置 hexo 为默认分支。</p>
<h3 id="hexo-篇">Hexo 篇</h3>
<p>　　将刚才新建的仓库克隆到本地：<code>git clone https://github.com/&lt;yourname&gt;/&lt;yourname&gt;.github.io.git</code>当前在 hexo 分支。</p>
<p>在 &lt;yourname&gt;.github.io 文件夹下执行</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line">npm install hexo-cli -g</span><br><span class="line">hexo init blog</span><br><span class="line"><span class="built_in">cd</span> blog</span><br><span class="line">npm install</span><br><span class="line">npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure></div>
<p>　　按这样一连串执行，如果没出问题的话就会在 &lt;yourname&gt;.github.io 文件夹里生成一个 blog 文件夹，该文件夹有一大堆 Hexo 有关的文件。</p>
<h4 id="配置-hexo">配置 Hexo</h4>
<p>　　Hexo 的配置文件为 blog 文件夹中的 <strong>_config.yml</strong> 文件。</p>
<p>　　修改配置文件不要使用 windows 自带的记事本，Shaun 使用的 VS Code，或者 Notepad++ 和 Sublime Text 2 等编辑器都可以，以防文件编码改变，具体修改如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="YAML"><div class="code-copy"></div><figure class="highlight hljs yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Site</span></span><br><span class="line"><span class="attr">title:</span>  <span class="string">&lt;你的blog名&gt;</span></span><br><span class="line"><span class="attr">author:</span> <span class="string">&lt;作者名称&gt;</span></span><br><span class="line"><span class="attr">language:</span> <span class="string">zh-CN&lt;网站所用语言，中国大陆选择zh-CN即可&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># URL</span></span><br><span class="line"><span class="comment">## If your site is put in a subdirectory, set url as &#x27;http://yoursite.com/child&#x27; and root as &#x27;/child/&#x27;</span></span><br><span class="line"><span class="attr">url:</span> <span class="string">http://&lt;yourname&gt;.github.io</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Deployment</span></span><br><span class="line"><span class="comment">## Docs: https://hexo.io/docs/deployment.html</span></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">https://github.com/&lt;yourname&gt;/&lt;yourname&gt;.github.io.git</span></span><br><span class="line">  <span class="attr">branch:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure></div>
<p>其它的默认即可，具体参数信息详见 <a href="https://hexo.io/zh-cn/docs/configuration.html">Hexo官方文档</a>。</p>
<h4 id="配置-git-用户信息">配置 git 用户信息</h4>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line">git config --global user.name <span class="string">&quot;&lt;yourname&gt;&quot;</span></span><br><span class="line">git config --global user.email <span class="string">&quot;&lt;yourname&gt;@xxxxxx.com&quot;</span></span><br></pre></td></tr></table></figure></div>
<p>　　如果是个人电脑的话推荐加上 --global 全局参数，因为这样更加方便，如果不加的话，还要在 \&lt;yourname&gt;.github.io\.deploy_git\.git 中 config 里加入 git 用户信息，不然可能提交会出问题，稍显麻烦。</p>
<h4 id="部署-hexo">部署 Hexo</h4>
<p>在 blog 文件夹下执行：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line">hexo g         <span class="comment">#generate 生成静态文件</span></span><br><span class="line">hexo d         <span class="comment">#deploy 部署网站.部署网站前,需要预先生成静态文件</span></span><br><span class="line">hexo s         <span class="comment">#server 启动服务器</span></span><br></pre></td></tr></table></figure></div>
<p>或者执行：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line">hexo g -d</span><br></pre></td></tr></table></figure></div>
<p>快速部署个人 blog。</p>
<p>　　在浏览器中输入<code>http://localhost:4000/</code>，将会出现 Hexo 的 Hello World 界面，更多 Hexo 命令详见 <a href="https://hexo.io/zh-cn/docs/commands.html">Hexo官方文档</a>。</p>
<p>最后将 Hexo 文件提交到 GitHub 远程仓库，具体提交命令为：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line">git add .</span><br><span class="line">git commit</span><br><span class="line">git push origin hexo</span><br></pre></td></tr></table></figure></div>
<p>　　在浏览器中输入<code>https://&lt;yourname&gt;.github.io</code>同样会出现 Hexo 的 Hello World 界面，自此整个个人 blog 的框架已经完全搭好了。</p>
<h3 id="其它篇">其它篇</h3>
<h4 id="主题选择">主题选择</h4>
<p>　　主题可以去官网上的主题界面去找，目前比较受欢迎主题有 <strong>next</strong> 和 <strong>yilia</strong>，去别人 GitHub 上的主题仓库上去下载或 clone 均可，<del>Shaun 目前用的主题为<strong><a href="https://github.com/maochunguang/black-blue">black-blue</a></strong>，这个主题 Shaun 在用的时候还有些问题，或许会换，或许会自己魔改。</del>最后由于术业有专攻，实在不知道该改哪里，所以决定换 black-blue 的原版主题 <strong><a href="https://github.com/luuman/hexo-theme-spfk">SPFK</a></strong> ，对照着 black-blue 对 spfk 进行修改。具体换主题的方法为：</p>
<p>　　先将下载好的主题整个放在 \blog\themes 文件夹中，再修改 blog 文件夹中的配置文件 <strong>_config.yml</strong>：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="YAML"><div class="code-copy"></div><figure class="highlight hljs yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># theme: landscape</span></span><br><span class="line"><span class="attr">theme:</span> <span class="string">black-blue</span></span><br></pre></td></tr></table></figure></div>
<p>　　black-blue 为打包主题文件并放入 \blog\themes 文件夹中的文件夹名，并不是原主题名，只是 Shaun 恰好将其重命名为主题名。</p>
<h4 id="文章发布">文章发布</h4>
<p>发布文章需要在 blog 文件夹中执行：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line">hexo new <span class="string">&quot;test&quot;</span></span><br></pre></td></tr></table></figure></div>
<p>　　将会在 _posts 文件夹中生成 test.md 文件，随后编辑 test.md 文件即可，Shaun 使用的 Markdown 编辑器为 <a href="https://www.typora.io/">Typora</a>。</p>
<p>至于给文章打标签和分类什么的，请参考 <a href="https://hexo.io/zh-cn/docs/front-matter.html">Hexo官方文档</a>。</p>
<p>写完文章之后推送到 GitHub 中，需要执行：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line">git add .</span><br><span class="line">git commit -m <span class="string">&quot;add test.md&quot;</span></span><br><span class="line">git push origin hexo</span><br></pre></td></tr></table></figure></div>
<p>Hexo 文件配置同样需要同步一下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line">hexo g</span><br><span class="line">hexo clean</span><br><span class="line">hexo d</span><br></pre></td></tr></table></figure></div>
<h4 id="插件添加">插件添加</h4>
<p>以 RSS 订阅插件为例。首先安装 <a href="https://github.com/hexojs/hexo-generator-feed">hexo-generator-feed</a>，在 blog 文件夹下执行：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">## rss插件</span></span><br><span class="line">npm install hexo-generator-feed --save</span><br></pre></td></tr></table></figure></div>
<p>安装成功后，修改 blog 文件夹中的配置文件 <strong>_config.yml</strong>：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="YAML"><div class="code-copy"></div><figure class="highlight hljs yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Extensions</span></span><br><span class="line"><span class="comment">## Plugins: https://hexo.io/plugins/</span></span><br><span class="line"><span class="attr">plugin:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">hexo-generator-feed</span> <span class="comment">#RSS订阅</span></span><br></pre></td></tr></table></figure></div>
<p>最后，修改<strong>当前主题文件夹</strong>中的配置文件 _config.yml，添加 RSS 订阅链接即可：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="YAML"><div class="code-copy"></div><figure class="highlight hljs yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">subnav:</span></span><br><span class="line">  <span class="attr">rss:</span> <span class="string">&quot;/atom.xml&quot;</span></span><br></pre></td></tr></table></figure></div>
<p>修改完成后，执行</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line">hexo clean</span><br><span class="line">hexo g</span><br><span class="line">hexo d</span><br></pre></td></tr></table></figure></div>
<p>将会在页面中看到 RSS 图标。</p>
<h2 id="注意事项">注意事项</h2>
<p><font color=#FA8072>1、<em><u><strong>提交至远程仓库时可能会出现错误</strong></u></em>。</font></p>
<p>　　原因可能是因为没有将 SSH Key 添加到 GitHub 中。</p>
<p>　　查看当前用户主目录下的 .ssh 文件夹中（ windows 是 C:\Users\&lt;username&gt;\.ssh）是否有<code>id_rsa</code>（私钥）和<code>id_rsa.pub</code>（公钥）这两个文件，若没有，则执行</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line">ssh-keygen -t rsa -C <span class="string">&quot;youremail@example.com&quot;</span></span><br></pre></td></tr></table></figure></div>
<p>　　在 GitHub 中添加 SSH Key 的具体方法为：点击 GitHub 用户头像下的 <strong>Settings</strong>，选中 <strong>SSH and GPG keys</strong>，点击 <strong>New SSH key</strong>，将<code>id_rsa.pub</code>中的内容复制粘贴到 <strong>Key文本框</strong>中。</p>
<p><font color=#FA8072>2、<u><strong><em>Hexo 生成和部署命令都执行失败</em></strong></u>。</font></p>
<p>　　原因可能是修改配置文件 _config.yml 出错。</p>
<p>　　将修改的配置文件 _config.yml 复原试试。</p>
<p><font color=#FA8072>3、<u><strong><em>Hexo 部署之后网页没变化</em></strong></u>。</font></p>
<p>可能需要执行</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="code"><pre><span class="line">hexo clean</span><br></pre></td></tr></table></figure></div>
<p>　　清除缓存文件 ( db.json ) 和已生成的静态文件 ( public )。在某些情况（尤其是更换主题后），如果发现对站点的更改无论如何也不生效，可能需要运行该命令。</p>
<h2 id="后记">后记</h2>
<p>　　以后就在这上面写 blog 了，顺便把以前写的一些文档也放上来。</p>
<h2 id="参考资料">参考资料</h2>
<p>[1] <a href="http://blog.csdn.net/u012150360/article/details/72793482">利用github+hexo搭建自己的博客</a>（<a href="http://blog.csdn.net/u012150360/article/category/6765461" class="uri">http://blog.csdn.net/u012150360/article/category/6765461</a>）</p>
<p>[2] <a href="https://hexo.io/zh-cn/docs/">Hexo官方文档</a>（<a href="https://hexo.io/zh-cn/" class="uri">https://hexo.io/zh-cn/</a>）</p>
<p>[3] <a href="http://www.jianshu.com/p/469e985288b3?from=jiantop.com">GITHUB+HEXO博客轻松更换主题外观</a>（<a href="http://www.jianshu.com/nb/10649566" class="uri">http://www.jianshu.com/nb/10649566</a>）</p>
<p>[4] <a href="http://hanhailong.com/2015/10/08/Hexo%E2%80%94%E6%AD%A3%E7%A1%AE%E6%B7%BB%E5%8A%A0RSS%E8%AE%A2%E9%98%85/">Hexo—正确添加RSS订阅</a>（<a href="http://hanhailong.com/tags/Hexo%E4%B8%BB%E9%A2%98/" class="uri">http://hanhailong.com/tags/Hexo%E4%B8%BB%E9%A2%98/</a>）</p>
]]></content>
      <categories>
        <category>建站小记</category>
      </categories>
      <tags>
        <tag>github</tag>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Google S2 Geometry 浅解</title>
    <url>/posts/720275bd.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　Google S2 Geometry（以下简称 S2） 是 Google 发明的基于单位球的一种地图投影和空间索引算法，该算法可快速进行覆盖以及邻域计算。更多详见 <a href="https://s2geometry.io/">S2Geometry</a>，<a href="https://blog.christianperone.com/2015/08/googles-s2-geometry-on-the-sphere-cells-and-hilbert-curve/">Google’s S2, geometry on the sphere, cells and Hilbert curve</a>，<a href="https://halfrost.com/go_s2_regioncoverer/">halfrost 的空间索引系列文章</a>。虽然使用 S2 已有一年的时间，但确实没有比较系统的看过其源码，这次借着这段空闲时间，将 Shaun 常用的功能系统的看看其具体实现，下文将结合 S2 的 C++，Java，Go 的版本一起看，由于 Java 和 Go 的都算是 C++ 的衍生版，所以以 C++ 为主，捎带写写这三种语言实现上的一些区别，Java 版本时隔 10 年更新了 2.0 版本，喜大普奔。</p>
<span id="more"></span>
<h2 id="坐标篇">坐标篇</h2>
<figure>
<img src="https://s2geometry.io/devguide/img/s2cell_global.jpg" alt="s2 projection" /><figcaption aria-hidden="true">s2 projection</figcaption>
</figure>
<p>　　S2 的投影方式可简单想象为一个单位球外接一个立方体，从球心发出一条射线得到球面上的点到立方体上 6 个面的投影，即将球面投影为立方体，当然中间为了使面积分布更为均匀，还做了些其他坐标变换。</p>
<h3 id="s2latlng-坐标">S2LatLng 坐标</h3>
<p>　　首先是经纬度坐标，默认用弧度（Radians）构造，取值范围为经度 [-π，+π]，纬度 [-π/2，+π/2]，当然也可使用 S1Angle 将角度（Degrees）转成弧度来构造。</p>
<h3 id="s2point-坐标">S2Point 坐标</h3>
<p>　　然后球面笛卡尔坐标，这是个三维坐标，由 S2LatLng 到 S2Point 相当于将单位球的极坐标表示法转换为笛卡尔坐标表示法，具体公式为 <span class="math inline">\(x=\cos(lat)cos(lng);　y=cos(lat)sin(lng);　z=sin(lat)\)</span>。</p>
<h3 id="faceuv-坐标">FaceUV 坐标</h3>
<p>　　这个坐标并没实际的类与其对应，face 指的是立方体的面，值域为 [0,5]，而 uv 坐标是指面上的点，值域为 [-1,1]。首先需要知道 S2Point 会投影到哪个面上，可以知道 S2 的笛卡尔坐标 X 轴正向指向 0 面，Y 轴正向指向 1 面，Z 轴正向指向 2 面，X 轴负向指向 3 面，Y 轴负向指向 4 面，Z 轴负向指向 5 面，所以 S2Point xyz 哪个分量的绝对值最大，就会投影到哪个轴指向的面，若该分量为正值，则取正向指的面，若该分量为负值，则取负向指的面。至于 uv 的计算方式就是直线与平面的交点了，之前的一篇「计算几何基础」中写过，但这里的平面和直线都比较特殊，所以有快速算法，就直接贴 Go 的代码吧：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="GO"><div class="code-copy"></div><figure class="highlight hljs go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// validFaceXYZToUV given a valid face for the given point r (meaning that</span></span><br><span class="line"><span class="comment">// dot product of r with the face normal is positive), returns</span></span><br><span class="line"><span class="comment">// the corresponding u and v values, which may lie outside the range [-1,1].</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">validFaceXYZToUV</span><span class="params">(face <span class="keyword">int</span>, r r3.Vector)</span> <span class="params">(<span class="keyword">float64</span>, <span class="keyword">float64</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">switch</span> face &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">		<span class="keyword">return</span> r.Y / r.X, r.Z / r.X</span><br><span class="line">	<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">		<span class="keyword">return</span> -r.X / r.Y, r.Z / r.Y</span><br><span class="line">	<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">		<span class="keyword">return</span> -r.X / r.Z, -r.Y / r.Z</span><br><span class="line">	<span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">		<span class="keyword">return</span> r.Z / r.X, r.Y / r.X</span><br><span class="line">	<span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">		<span class="keyword">return</span> r.Z / r.Y, -r.X / r.Y</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> -r.Y / r.Z, -r.X / r.Z</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>　　这里需要注意的是 S2Point xyz 三分量构成的向量与平面法向量的点积必须是正数时 uv 才算正确有效，Go 在计算时没做校验，C++ 和 Java 都有校验，使用时需要注意。</p>
<h3 id="facest-坐标">FaceST 坐标</h3>
<p>　　之所以引入 ST 坐标是因为同样的球面面积映射到 UV 坐标面积大小不一，大小差距比较大（离坐标轴越近越小，越远越大），所以再做一次 ST 变换，将面积大的变小，小的变大，使面积更均匀，利于后面在立方体面上取均匀格网（cell）时，每个 cell 对应球面面积差距不大。S2 的 ST 变换有三种：1、线性变换，基本没做任何变形，只是简单将 ST 坐标的值域变换为 [0, 1]，cell 对应面积最大与最小比大约为 5.2；2、二次变换，一种非线性变换，能起到使 ST 空间面积更均匀的作用，cell 对应面积最大与最小比大约为 2.1；3、正切变换，同样能使 ST 空间面积更均匀，且 cell 对应面积最大与最小比大约为 1.4，不过其计算速度相较于二次变换要慢 3 倍，所以 S2 权衡考虑，最终采用了二次变换作为默认的 UV 到 ST 之间的变换。二次变换公式为：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="JAVA"><div class="code-copy"></div><figure class="highlight hljs java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">stToUV</span><span class="params">(<span class="keyword">double</span> s)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (s &gt;= <span class="number">0.5</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="number">1</span> / <span class="number">3.</span>) * (<span class="number">4</span> * s * s - <span class="number">1</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="number">1</span> / <span class="number">3.</span>) * (<span class="number">1</span> - <span class="number">4</span> * (<span class="number">1</span> - s) * (<span class="number">1</span> - s));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">uvToST</span><span class="params">(<span class="keyword">double</span> u)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (u &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0.5</span> * Math.sqrt(<span class="number">1</span> + <span class="number">3</span> * u);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> - <span class="number">0.5</span> * Math.sqrt(<span class="number">1</span> - <span class="number">3</span> * u);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h3 id="faceij-坐标">FaceIJ 坐标</h3>
<p>　　IJ 坐标是离散化后的 ST 坐标，将 ST 空间的平面划分为 <span class="math inline">\(2^{30}×2^{30}\)</span> 个网格，取网格所在的横纵坐标得到 IJ 坐标，所以由 ST 到 IJ 坐标的变换就比较简单了：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="JAVA"><div class="code-copy"></div><figure class="highlight hljs java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">stToIj</span><span class="params">(<span class="keyword">double</span> s)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> Math.max(</span><br><span class="line">    <span class="number">0</span>, Math.min(<span class="number">1073741824</span> - <span class="number">1</span>, (<span class="keyword">int</span>) Math.round(<span class="number">1073741824</span> * s - <span class="number">0.5</span>))</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h3 id="s2cellid">S2CellId</h3>
<p>　　这个 id 其实是个一维坐标，而是利用希尔伯特空间填充曲线将 IJ 坐标从二维变换为一维，该 id 用一个 64 位整型表示，高 3 位用来表示 face（0~5），后面 61 位来保存不同的 level（0~30） 对应的希尔伯特曲线位置，每增加一个 level 增加两位，后面紧跟一个 1，最后的位数都补 0。<em>注：Java 版本的 id 是有符号 64 位整型，而 C++ 和 Go 的是无符号 64 位整型，所以在跨语言传递 id 的时候，在南极洲所属的最后一个面（即 face = 5）需要小心处理。</em></p>
<h4 id="hilbertcurve">HilbertCurve</h4>
<figure>
<img src="https://upload.wikimedia.org/wikipedia/commons/a/a7/Hilbert_curve_production_rules%21.svg" alt="hilbert_curve_subdivision_rules" /><figcaption aria-hidden="true">hilbert_curve_subdivision_rules</figcaption>
</figure>
<figure>
<img src="https://upload.wikimedia.org/wikipedia/commons/3/35/Hilbert_curve_3_Orient%21.svg" alt="hilbert_curve" /><figcaption aria-hidden="true">hilbert_curve</figcaption>
</figure>
<p>　　上面两张图很明了的展示了希尔伯特曲线的构造过程，该曲线的构造基本元素由 ABCD 4 种“U”形构成，而 BCD 又可由 A 依次逆时针旋转 90 度得到，所以也可以认为只有一种“U”形，每个 U 占 4 个格子，以特定方式进行 1 分 4 得到下一阶曲线形状。</p>
<p>每个 U 坐标与希尔伯特位置（用二进制表示）对应关系如下：</p>
<ul>
<li>A：<code>00 -&gt; (0,0); 01 -&gt; (0,1); 10 -&gt; (1,1); 11 -&gt; (1,0);</code></li>
<li>B：<code>00 -&gt; (1,1); 01 -&gt; (0,1); 10 -&gt; (0,0); 11 -&gt; (1,0);</code></li>
<li>C：<code>00 -&gt; (1,1); 01 -&gt; (1,0); 10 -&gt; (0,0); 11 -&gt; (0,1);</code></li>
<li>D：<code>00 -&gt; (0,0); 01 -&gt; (1,0); 10 -&gt; (1,1); 11 -&gt; (0,1);</code></li>
</ul>
<p>每个 U 一分四对应关系如下：</p>
<ul>
<li>A：<code>D -&gt; A -&gt; A -&gt; B</code></li>
<li>B：<code>C -&gt; B -&gt; B -&gt; A</code></li>
<li>C：<code>B -&gt; C -&gt; C -&gt; D</code></li>
<li>D：<code>A -&gt; D -&gt; D -&gt; C</code></li>
</ul>
<p>　　根据以上两个对应关系就能找到右手坐标系任意阶数的希尔伯特位置及坐标对应关系。以初始 1 阶曲线 A 为例，占据四个格子，然后进行一分四操作，四个格子分成 16 个格子，A 分为 DAAB 四个“U”形，连接起来即为 2 阶曲线，位置与坐标对应关系为（都用二进制表示）：</p>
<p><code>0000 -&gt; (00, 00); 0001 -&gt; (01, 00); 0010 -&gt; (01, 01); 0011 -&gt; (00, 01)</code>；</p>
<p><code>0100 -&gt; (00, 10); 0101 -&gt; (00, 11); 0110 -&gt; (01, 11); 0111 -&gt; (01, 10)</code>；</p>
<p><code>1000 -&gt; (10, 10); 1001 -&gt; (10, 11); 1010 -&gt; (11, 11); 1011 -&gt; (11, 10)</code>；</p>
<p><code>1100 -&gt; (11, 01); 1101 -&gt; (10, 01); 1110 -&gt; (10, 00); 1111 -&gt; (11, 00)</code>；</p>
<p>　　从二进制中很容易看出随着阶数的增加，位置与坐标的对应关系：每增加一阶，位置往后增加两位，坐标分量各增加一位，位置增加的两位根据一分四对应关系拼接，坐标各分量增加的一位需先找到一分四对应关系，再找对应位置与坐标对应关系，将得到的坐标分量对应拼接。以一阶的 <code>01 -&gt; (0,1)</code> 到二阶的 <code>0110 -&gt; (01, 11)</code> 为例，首先根据 01 得到当前所属一阶第二块，查找一分四对应关系知道，下一阶这块还是 A，根据 0110 后两位 10 可知这块属于 A 的第三个位置，查找坐标得到是 <code>(1,1)</code>，结合一阶的 <code>(0,1)</code>，对应分量拼接得到坐标 <code>(01,11)</code>，即 <code>(1, 3)</code>，同理可根据第二阶的坐标反查第二阶的位置。有了这些关系，就能生成希尔伯特曲线了，下面就看看 S2 是怎么生成 id 的。</p>
<h4 id="s2id">S2Id</h4>
<p>　　首先 S2 中用了两个二维数组分别保存位置到坐标以及坐标到位置的对应的关系：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// kIJtoPos[orientation][ij] -&gt; pos</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> kIJtoPos[<span class="number">4</span>][<span class="number">4</span>] = &#123;</span><br><span class="line">  <span class="comment">// (0,0) (0,1) (1,0) (1,1)</span></span><br><span class="line">  &#123;     <span class="number">0</span>,    <span class="number">1</span>,    <span class="number">3</span>,    <span class="number">2</span>  &#125;,  <span class="comment">// canonical order</span></span><br><span class="line">  &#123;     <span class="number">0</span>,    <span class="number">3</span>,    <span class="number">1</span>,    <span class="number">2</span>  &#125;,  <span class="comment">// axes swapped</span></span><br><span class="line">  &#123;     <span class="number">2</span>,    <span class="number">3</span>,    <span class="number">1</span>,    <span class="number">0</span>  &#125;,  <span class="comment">// bits inverted</span></span><br><span class="line">  &#123;     <span class="number">2</span>,    <span class="number">1</span>,    <span class="number">3</span>,    <span class="number">0</span>  &#125;,  <span class="comment">// swapped &amp; inverted</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// kPosToIJ[orientation][pos] -&gt; ij</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> kPosToIJ[<span class="number">4</span>][<span class="number">4</span>] = &#123;</span><br><span class="line">  <span class="comment">// 0  1  2  3</span></span><br><span class="line">  &#123;  <span class="number">0</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">2</span> &#125;,    <span class="comment">// canonical order:    (0,0), (0,1), (1,1), (1,0)</span></span><br><span class="line">  &#123;  <span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span> &#125;,    <span class="comment">// axes swapped:       (0,0), (1,0), (1,1), (0,1)</span></span><br><span class="line">  &#123;  <span class="number">3</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span> &#125;,    <span class="comment">// bits inverted:      (1,1), (1,0), (0,0), (0,1)</span></span><br><span class="line">  &#123;  <span class="number">3</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span> &#125;,    <span class="comment">// swapped &amp; inverted: (1,1), (0,1), (0,0), (1,0)</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// kPosToOrientation[pos] -&gt; orientation_modifier</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> kPosToOrientation[<span class="number">4</span>] = &#123;<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">3</span>&#125;;</span><br></pre></td></tr></table></figure></div>
<p>　　方向 0（canonical order）相当于上文中 A，方向 1（axes swapped）相当于上文中 D，方向 2（bits inverted）相当于上文中 C，方向 3（swapped &amp; inverted）相当于上文中 B，kPosToOrientation 代表 S2 中方向 0 一分四的对应关系，而 方向 1，2，3 的对应关系可由该值推出，计算公式为 <code>orientation ^ kPosToOrientation</code>，eg：<code>1 -&gt; 1^kPosToOrientation=[0, 1, 1, 2]; 3 -&gt; 3^kPosToOrientation=[2, 3, 3, 0]</code>，与上文中一分四对应关系一致。</p>
<p>　　随后 S2 初始化了一个 4 阶希尔伯特曲线位置与坐标的对应关系查找表，见 C++ 版的 <code>MaybeInit()</code> 方法，</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> ij = (i &lt;&lt; <span class="number">4</span>) + j;</span><br><span class="line">lookup_pos[(ij &lt;&lt; <span class="number">2</span>) + orig_orientation] = (pos &lt;&lt; <span class="number">2</span>) + orientation;</span><br><span class="line">lookup_ij[(pos &lt;&lt; <span class="number">2</span>) + orig_orientation] = (ij &lt;&lt; <span class="number">2</span>) + orientation;</span><br></pre></td></tr></table></figure></div>
<p>　　orig_orientation 代表 4 个初始方向，orientation 代表该位置或坐标下一阶一分四的方向，数组中每个元素是 16 位数，2 个字节，一个四阶希尔伯特曲线是 <span class="math inline">\(2^4×2^4=256\)</span> 个位置，一个初始方向对应一个四阶希尔伯特曲线，所以一个查找表共占内存 <span class="math inline">\(2×256×4=2048=2KB\)</span>，正好一级缓存能放下，再大的话，一级缓存可能放不下，反而会降低查找速度。这两个查找表就相当于 4 个超“U”形的位置与坐标对应关系，同时一分四对应关系保持不变，以超“U”作为基本元素做下一阶希尔伯特曲线，每增加一阶位置往后增加 8 位，IJ 坐标各往后增加 4 位，如此，以更快的速度迭代到 S2 想要的 30 阶希尔伯特曲线。C++ 的这份代码就很精妙了：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="function">S2CellId <span class="title">S2CellId::FromFaceIJ</span><span class="params">(<span class="keyword">int</span> face, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 初始化超“U”形查找表</span></span><br><span class="line">  <span class="built_in">MaybeInit</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// face 向左移 60 位</span></span><br><span class="line">  uint64 n = absl::implicit_cast&lt;uint64&gt;(face) &lt;&lt; (kPosBits - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 确定每个面的初始“U”形方向，使每个面都保持相同的右手坐标系，6 个面生成的希尔伯特曲线可以依次相连</span></span><br><span class="line">  uint64 bits = (face &amp; kSwapMask);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 基于超“U”形得到 30 阶希尔伯特曲线 IJ 坐标对应位置</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GET_BITS(k) do &#123; \</span></span><br><span class="line"><span class="meta">    const int mask = (1 &lt;&lt; kLookupBits) - 1; \</span></span><br><span class="line"><span class="meta">    bits += ((i &gt;&gt; (k * kLookupBits)) &amp; mask) &lt;&lt; (kLookupBits + 2); \</span></span><br><span class="line"><span class="meta">    bits += ((j &gt;&gt; (k * kLookupBits)) &amp; mask) &lt;&lt; 2; \</span></span><br><span class="line"><span class="meta">    bits = lookup_pos[bits]; \</span></span><br><span class="line"><span class="meta">    n |= (bits &gt;&gt; 2) &lt;&lt; (k * 2 * kLookupBits); \</span></span><br><span class="line"><span class="meta">    bits &amp;= (kSwapMask | kInvertMask); \</span></span><br><span class="line"><span class="meta">  &#125; while (0)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// IJ 只有 30 位，7 这个调用只会导致位置移 4 位，后续调用都移 8 位，得到 4 + 8 * 7 = 60 位</span></span><br><span class="line">  <span class="built_in">GET_BITS</span>(<span class="number">7</span>); </span><br><span class="line">  <span class="built_in">GET_BITS</span>(<span class="number">6</span>);</span><br><span class="line">  <span class="built_in">GET_BITS</span>(<span class="number">5</span>);</span><br><span class="line">  <span class="built_in">GET_BITS</span>(<span class="number">4</span>);</span><br><span class="line">  <span class="built_in">GET_BITS</span>(<span class="number">3</span>);</span><br><span class="line">  <span class="built_in">GET_BITS</span>(<span class="number">2</span>);</span><br><span class="line">  <span class="built_in">GET_BITS</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="built_in">GET_BITS</span>(<span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> GET_BITS</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 整个 n 向右移一位，再以 1 结尾</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">S2CellId</span>(n * <span class="number">2</span> + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>再来看看根据 id 反算 IJ 坐标：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">S2CellId::ToFaceIJOrientation</span><span class="params">(<span class="keyword">int</span>* pi, <span class="keyword">int</span>* pj, <span class="keyword">int</span>* orientation)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 与上面一样</span></span><br><span class="line">  <span class="built_in">MaybeInit</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> face = <span class="keyword">this</span>-&gt;<span class="built_in">face</span>();</span><br><span class="line">  <span class="keyword">int</span> bits = (face &amp; kSwapMask);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 反算 IJ 坐标，k == 7 时，取希尔伯特曲线位置高 4 位，IJ 各前 2 位，其余依次取位置 8 位， IJ 各 4 位</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GET_BITS(k) do &#123; \</span></span><br><span class="line"><span class="meta">    const int nbits = (k == 7) ? (kMaxLevel - 7 * kLookupBits) : kLookupBits; \</span></span><br><span class="line"><span class="meta">    bits += (static_cast<span class="meta-string">&lt;int&gt;</span>(id_ &gt;&gt; (k * 2 * kLookupBits + 1)) \</span></span><br><span class="line"><span class="meta">             &amp; ((1 &lt;&lt; (2 * nbits)) - 1)) &lt;&lt; 2; \</span></span><br><span class="line"><span class="meta">    bits = lookup_ij[bits]; \</span></span><br><span class="line"><span class="meta">    i += (bits &gt;&gt; (kLookupBits + 2)) &lt;&lt; (k * kLookupBits); \</span></span><br><span class="line"><span class="meta">    j += ((bits &gt;&gt; 2) &amp; ((1 &lt;&lt; kLookupBits) - 1)) &lt;&lt; (k * kLookupBits); \</span></span><br><span class="line"><span class="meta">    bits &amp;= (kSwapMask | kInvertMask); \</span></span><br><span class="line"><span class="meta">  &#125; while (0)</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">GET_BITS</span>(<span class="number">7</span>);</span><br><span class="line">  <span class="built_in">GET_BITS</span>(<span class="number">6</span>);</span><br><span class="line">  <span class="built_in">GET_BITS</span>(<span class="number">5</span>);</span><br><span class="line">  <span class="built_in">GET_BITS</span>(<span class="number">4</span>);</span><br><span class="line">  <span class="built_in">GET_BITS</span>(<span class="number">3</span>);</span><br><span class="line">  <span class="built_in">GET_BITS</span>(<span class="number">2</span>);</span><br><span class="line">  <span class="built_in">GET_BITS</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="built_in">GET_BITS</span>(<span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> GET_BITS</span></span><br><span class="line"></span><br><span class="line">  *pi = i;</span><br><span class="line">  *pj = j;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (orientation != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="built_in">S2_DCHECK_EQ</span>(<span class="number">0</span>, kPosToOrientation[<span class="number">2</span>]);</span><br><span class="line">    <span class="built_in">S2_DCHECK_EQ</span>(kSwapMask, kPosToOrientation[<span class="number">0</span>]);</span><br><span class="line">    <span class="comment">// 0x1111111111111111ULL may be better?</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">lsb</span>() &amp; <span class="number">0x1111111111111110</span>ULL) &#123;</span><br><span class="line">      bits ^= kSwapMask;</span><br><span class="line">    &#125;</span><br><span class="line">    *orientation = bits;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> face;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>　　这里的 orientation 实际是指当前位置的方向，即其周围必有 3 个位置与其方向相同，最后一行注释 Shaun 之所以认为应该是 0x1111111111111111ULL，是因为第 30 阶希尔伯特曲线位置（leaf cell）按理说同样需要做异或操作得到方向，不过整个 S2 库都没有需要用到 leaf cell 的方向，所以这就倒无关紧要了。之所以需要做异或操作，是因为 bits 是该位置下一阶一分四的方向，而对于同一个希尔伯特曲线位置，奇数阶与奇数阶下一阶一分四方向相同，偶数阶与偶数阶下一阶一分四方向相同，lsb() 表示二进制 id 从右往左数第一个 1 所代表的数， 所以有 0x1111111111111110ULL 这一魔术数，而异或操作正好能将下一阶一分四方向调整为当前阶方向。</p>
<p>　　如此 S2 的坐标以及 id 的生成以及反算就很明了了，下面就是 S2 如何使用 id 做计算了。</p>
<hr />
<h3 id="facesiti-坐标">FaceSiTi 坐标</h3>
<p>　　这个是 S2 内部计算使用的坐标，一般用来计算 cell 的中心坐标，以及根据当前 s 和 t 坐标的精度（小数点后几位）判断对应的级别（level）。由于 S2 本身并不显式存储 ST 坐标（有存 UV 坐标），所以 ST 坐标只能计算出来，每个 cell 的中心点同样如此。计算公式为 <span class="math inline">\(Si=s*2^{31};Ti=t*2^{31}\)</span>。至于为啥是 <span class="math inline">\(2^{31}\)</span>，是因为该坐标是用来描述从 0~ 31 阶希尔伯特曲线网格的中心坐标，0 阶中心以 <span class="math inline">\(1/2^1\)</span> 递增，1 阶中心以 <span class="math inline">\(1/2^2\)</span> 递增，2 阶中心以 <span class="math inline">\(1/2^3\)</span> 递增，……，30 阶中心以 <span class="math inline">\(1/2^{31}\)</span> 递增。S2 计算 id 对应的格子中心坐标，首先就会计算 SiTi 坐标，再将 SiTi 转成 ST 坐标。</p>
<h2 id="算法篇">算法篇</h2>
<h3 id="邻域算法">邻域算法</h3>
<p>　　S2 计算邻域，最关键的是计算不同面相邻的 leaf cell id，即：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="function">S2CellId <span class="title">S2CellId::FromFaceIJWrap</span><span class="params">(<span class="keyword">int</span> face, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 限制 IJ 最大最小取值为 -1~2^30, 刚好能超出 IJ 正常表示范围 0~2^30-1</span></span><br><span class="line">  i = <span class="built_in">max</span>(<span class="number">-1</span>, <span class="built_in">min</span>(kMaxSize, i));</span><br><span class="line">  j = <span class="built_in">max</span>(<span class="number">-1</span>, <span class="built_in">min</span>(kMaxSize, j));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">double</span> kScale = <span class="number">1.0</span> / kMaxSize;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">double</span> kLimit = <span class="number">1.0</span> + DBL_EPSILON;</span><br><span class="line">  <span class="built_in">S2_DCHECK_EQ</span>(<span class="number">0</span>, kMaxSize % <span class="number">2</span>);</span><br><span class="line">  <span class="comment">// IJ -&gt; SiTi -&gt; ST -&gt; UV</span></span><br><span class="line">  <span class="keyword">double</span> u = <span class="built_in">max</span>(-kLimit, <span class="built_in">min</span>(kLimit, kScale * (<span class="number">2</span> * (i - kMaxSize / <span class="number">2</span>) + <span class="number">1</span>)));</span><br><span class="line">  <span class="keyword">double</span> v = <span class="built_in">max</span>(-kLimit, <span class="built_in">min</span>(kLimit, kScale * (<span class="number">2</span> * (j - kMaxSize / <span class="number">2</span>) + <span class="number">1</span>)));</span><br><span class="line"></span><br><span class="line">  face = S2::<span class="built_in">XYZtoFaceUV</span>(S2::<span class="built_in">FaceUVtoXYZ</span>(face, u, v), &amp;u, &amp;v);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">FromFaceIJ</span>(face, S2::<span class="built_in">STtoIJ</span>(<span class="number">0.5</span>*(u+<span class="number">1</span>)), S2::<span class="built_in">STtoIJ</span>(<span class="number">0.5</span>*(v+<span class="number">1</span>)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>　　这个算法主要用来计算超出范围（0~2^30-1）的 IJ 对应的 id，核心思想是先将 FaceIJ 转为 XYZ，再使用 XYZ 反算得到正常的 FaceIJ，进而得到正常的 id。中间 IJ -&gt; UV 中坐标实际经过了 3 步，对于 leaf cell，IJ -&gt; SiTi 的公式为 <span class="math inline">\(Si=2×I+1\)</span>，而对于 ST -&gt; UV，这里没有采用二次变换，就是线性变换 <span class="math inline">\(u=2*s-1\)</span>，官方注释上说明用哪个变换效果都一样，所以采用最简单的就行。</p>
<h4 id="边邻域">边邻域</h4>
<p>　　边邻域代码很简单，也很好理解：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">S2CellId::GetEdgeNeighbors</span><span class="params">(S2CellId neighbors[<span class="number">4</span>])</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i, j;</span><br><span class="line">  <span class="keyword">int</span> level = <span class="keyword">this</span>-&gt;<span class="built_in">level</span>();</span><br><span class="line">  <span class="comment">// 计算当前 level 一行或一列对应多少个 30 级的 cell（leaf cell） 2^(30-level)</span></span><br><span class="line">  <span class="keyword">int</span> size = <span class="built_in">GetSizeIJ</span>(level);</span><br><span class="line">  <span class="keyword">int</span> face = <span class="built_in">ToFaceIJOrientation</span>(&amp;i, &amp;j, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Edges 0, 1, 2, 3 are in the down, right, up, left directions.</span></span><br><span class="line">  neighbors[<span class="number">0</span>] = <span class="built_in">FromFaceIJSame</span>(face, i, j - size, j - size &gt;= <span class="number">0</span>)</span><br><span class="line">                 .<span class="built_in">parent</span>(level);</span><br><span class="line">  neighbors[<span class="number">1</span>] = <span class="built_in">FromFaceIJSame</span>(face, i + size, j, i + size &lt; kMaxSize)</span><br><span class="line">                 .<span class="built_in">parent</span>(level);</span><br><span class="line">  neighbors[<span class="number">2</span>] = <span class="built_in">FromFaceIJSame</span>(face, i, j + size, j + size &lt; kMaxSize)</span><br><span class="line">                 .<span class="built_in">parent</span>(level);</span><br><span class="line">  neighbors[<span class="number">3</span>] = <span class="built_in">FromFaceIJSame</span>(face, i - size, j, i - size &gt;= <span class="number">0</span>)</span><br><span class="line">                 .<span class="built_in">parent</span>(level);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>　　分别计算当前 IJ 坐标下右上左坐标对应 id，FromFaceIJSame 表示若邻域在相同面，则走 FromFaceIJ，否则走 FromFaceIJWrap，由于这两个函数得到都是 leaf cell，要上升到指定 level，需要用到 parent 方法，即将希尔伯特曲线位置去掉右 <span class="math inline">\(2*(30-level)\)</span> 位，再组合成新的 id，位运算也很有意思：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> uint64 <span class="title">lsb_for_level</span><span class="params">(<span class="keyword">int</span> level)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> uint64&#123;<span class="number">1</span>&#125; &lt;&lt; (<span class="number">2</span> * (kMaxLevel - level));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> S2CellId <span class="title">S2CellId::parent</span><span class="params">(<span class="keyword">int</span> level)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">  uint64 new_lsb = <span class="built_in">lsb_for_level</span>(level);</span><br><span class="line">  <span class="comment">// 取反加一实际是取负数</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">S2CellId</span>((id_ &amp; (~new_lsb + <span class="number">1</span>)) | new_lsb);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="点邻域">点邻域</h4>
<p>　　S2 的点邻域并不是指常规意义上 4 个顶点相邻左上右上右下左下的 id，而是一种比较特殊的相邻关系，以直角坐标系 (0,0),(0,1),(1,1),(1,0) 为例，(0,0) 的点邻域为 (0,0),(0,-1),(-1,-1),(-1,0)，(0,1) 的点邻域为 (0,1),(0,2),(-1,2),(-1,1)，(1,1) 的点邻域为 (1,1),(1,2),(2,2),(2,1)，(1,0) 的点邻域为 (1,0),(1,-1),(2,-1),(2,0)。具体代码如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">S2CellId::AppendVertexNeighbors</span><span class="params">(<span class="keyword">int</span> level,</span></span></span><br><span class="line"><span class="params"><span class="function">                                     vector&lt;S2CellId&gt;* output)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">  <span class="comment">// level &lt; this-&gt;level()</span></span><br><span class="line">  <span class="built_in">S2_DCHECK_LT</span>(level, <span class="keyword">this</span>-&gt;<span class="built_in">level</span>());</span><br><span class="line">  <span class="keyword">int</span> i, j;</span><br><span class="line">  <span class="keyword">int</span> face = <span class="built_in">ToFaceIJOrientation</span>(&amp;i, &amp;j, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断 IJ 落在 level 对应 cell 的哪个方位？（左下左上右上右下，对应上文的(0,0),(0,1),(1,1),(1,0)坐标）</span></span><br><span class="line">  <span class="keyword">int</span> halfsize = <span class="built_in">GetSizeIJ</span>(level + <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">int</span> size = halfsize &lt;&lt; <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">bool</span> isame, jsame;</span><br><span class="line">  <span class="keyword">int</span> ioffset, joffset;</span><br><span class="line">  <span class="keyword">if</span> (i &amp; halfsize) &#123;</span><br><span class="line">    ioffset = size;</span><br><span class="line">    isame = (i + size) &lt; kMaxSize;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ioffset = -size;</span><br><span class="line">    isame = (i - size) &gt;= <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (j &amp; halfsize) &#123;</span><br><span class="line">    joffset = size;</span><br><span class="line">    jsame = (j + size) &lt; kMaxSize;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    joffset = -size;</span><br><span class="line">    jsame = (j - size) &gt;= <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  output-&gt;<span class="built_in">push_back</span>(<span class="built_in">parent</span>(level));</span><br><span class="line">  output-&gt;<span class="built_in">push_back</span>(<span class="built_in">FromFaceIJSame</span>(face, i + ioffset, j, isame).<span class="built_in">parent</span>(level));</span><br><span class="line">  output-&gt;<span class="built_in">push_back</span>(<span class="built_in">FromFaceIJSame</span>(face, i, j + joffset, jsame).<span class="built_in">parent</span>(level));</span><br><span class="line">  <span class="comment">// 则邻域的 IJ 与当前 cell 都不在同一个面，则说明只有三个点邻域</span></span><br><span class="line">  <span class="keyword">if</span> (isame || jsame) &#123;</span><br><span class="line">    output-&gt;<span class="built_in">push_back</span>(<span class="built_in">FromFaceIJSame</span>(face, i + ioffset, j + joffset,</span><br><span class="line">                                     isame &amp;&amp; jsame).<span class="built_in">parent</span>(level));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>　　上面的代码算是比较清晰了，3 个点邻域的情况一般出现在当前 id 位于立方体 6 个面的角落，<em>该方法的参数 level 必须比当前 id 的 level 要小</em>。</p>
<h4 id="全邻域">全邻域</h4>
<p>　　所谓全邻域，即为当前 id 对应 cell 周围一圈 cell 对应的 id，若周围一圈 cell 的 level 与 当前 id 的 level 一样，则所求即为正常的 9 邻域。具体代码如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">S2CellId::AppendAllNeighbors</span><span class="params">(<span class="keyword">int</span> nbr_level,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  vector&lt;S2CellId&gt;* output)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">  <span class="comment">// nbr_level &gt;= level</span></span><br><span class="line">  <span class="built_in">S2_DCHECK_GE</span>(nbr_level, <span class="built_in">level</span>());</span><br><span class="line">  <span class="keyword">int</span> i, j;</span><br><span class="line">  <span class="keyword">int</span> face = <span class="built_in">ToFaceIJOrientation</span>(&amp;i, &amp;j, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 先归一 IJ 坐标，将 IJ 坐标调整为当前 cell 左下角 leaf cell 的坐标</span></span><br><span class="line">  <span class="keyword">int</span> size = <span class="built_in">GetSizeIJ</span>();</span><br><span class="line">  i &amp;= -size;</span><br><span class="line">  j &amp;= -size;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> nbr_size = <span class="built_in">GetSizeIJ</span>(nbr_level);</span><br><span class="line">  <span class="built_in">S2_DCHECK_LE</span>(nbr_size, size);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> k = -nbr_size; ; k += nbr_size) &#123;</span><br><span class="line">    <span class="keyword">bool</span> same_face;</span><br><span class="line">    <span class="keyword">if</span> (k &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      same_face = (j + k &gt;= <span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (k &gt;= size) &#123;</span><br><span class="line">      same_face = (j + k &lt; kMaxSize);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      same_face = <span class="literal">true</span>;</span><br><span class="line">      <span class="comment">// 生成外包围圈下上两边的 id, 顺序为从左往右</span></span><br><span class="line">      output-&gt;<span class="built_in">push_back</span>(<span class="built_in">FromFaceIJSame</span>(face, i + k, j - nbr_size,</span><br><span class="line">                                       j - size &gt;= <span class="number">0</span>).<span class="built_in">parent</span>(nbr_level));</span><br><span class="line">      output-&gt;<span class="built_in">push_back</span>(<span class="built_in">FromFaceIJSame</span>(face, i + k, j + size,</span><br><span class="line">                                       j + size &lt; kMaxSize).<span class="built_in">parent</span>(nbr_level));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 生成外包围圈左右两边以及四个边角的 id, 顺序为从下往上</span></span><br><span class="line">    output-&gt;<span class="built_in">push_back</span>(<span class="built_in">FromFaceIJSame</span>(face, i - nbr_size, j + k,</span><br><span class="line">                                     same_face &amp;&amp; i - size &gt;= <span class="number">0</span>)</span><br><span class="line">                      .<span class="built_in">parent</span>(nbr_level));</span><br><span class="line">    output-&gt;<span class="built_in">push_back</span>(<span class="built_in">FromFaceIJSame</span>(face, i + size, j + k,</span><br><span class="line">                                     same_face &amp;&amp; i + size &lt; kMaxSize)</span><br><span class="line">                      .<span class="built_in">parent</span>(nbr_level));</span><br><span class="line">    <span class="keyword">if</span> (k &gt;= size) <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>　　知道这个函数的作用，再看代码就很明了了，<em>这个方法的参数 nbr_level 必须大于或等于当前 id 的 level</em>，因为一旦外包围圈的 cell 面积比当前 cell 还大，就无法得到正确的外包围圈。</p>
<h3 id="覆盖算法">覆盖算法</h3>
<p>　　S2 的覆盖，是指给定一块区域，能用多少 id 对应的 cell 完全覆盖该区域（GetCovering），当然也有尽量覆盖的算法（GetInteriorCovering），下面主要解析 GetCovering，因为 GetInteriorCovering 也差不多，就是覆盖策略略有不同。</p>
<p>GetCovering 的区域入参是 S2Region，比较典型的 S2Region 有以下几种：</p>
<ul>
<li>S2Cell：S2 id 对应的网格，会保存左下右上两个 UV 坐标，也是覆盖算法使用的基本元素；</li>
<li>S2CellUnion：多个 S2Cell 集合体，GetCovering 的返回值；</li>
<li>S2LatLngRect：经纬度矩形区域；</li>
<li>S2Cap：球帽区域，类比于二维圆的圆弧，球帽的构造比较奇怪，球帽的中心 S2Point 是需要，但另一个变量不是球帽的圆弧角，而是半个圆弧角（S2 代码库对应的 S1Angle 弧度，90 度代表半球，180 度代表全球）所对应弦长的平方，最大值为 4，之所以采用弦长的平方作为默认构造，是因为这就是 3 维中距离，在进行距离比较的场景时会更方便，比如测试是否包含一个 S2Point，计算覆盖多边形时，就不用再比较角度，毕竟角度计算代价比较大；</li>
<li>S2Loop：多边形的基本组成元素，第一个点与最后一个点隐式连接，逆时针代表封闭，顺时针代表开孔取外围区域，不允许自相交；</li>
<li>S2Polygon：非常正常的复杂多边形，由多个 S2Loop 构成，S2Loop 之间不能相交；</li>
<li>S2Polyline：一条折线，同样不能自相交；</li>
<li>还有些其它不常用的：S2R2Rect（S2Point 矩形区域），S2RegionIntersection（集合相交区域），S2RegionUnion（集合合并区域），……等。</li>
</ul>
<p>　　S2 覆盖算法的本质是一种启发式算法，先取满足当前条件最基本的元素，再依照条件进行迭代优化，所以该算法得到的只是一个近似最优解。GetCovering 需要依次满足以下条件：</p>
<ol type="1">
<li>生成的 S2Cell level 不能比指定的 minLevel 小；（必须满足）</li>
<li>生成的 S2Cell 的个数不能比指定的 maxCells 多；（可以满足，当满足 1 时，数目已经 maxCells 多，迭代停止）</li>
<li>生成的 S2Cell level 不能比指定的 maxLevel 大；（必须满足）</li>
</ol>
<p>　　以上 3 个条件对应 GetCovering 的其他三个参数，当然还有一个参数是 levelModel，表示从 minLevel 向下分到 maxLevel 时，是 1 分 4，还是 1 分 16，还是 1 分 64，对应一次升 1 阶曲线，还是一次升 2 阶，或是一次升 3 阶。下面就来具体看看 GetCovering 的算法流程（代码就不贴了，太多了）：</p>
<ol type="1">
<li>首先获取候选种子 S2Cell。先构造一个临时覆盖器，设置 maxCells 为 4，minLevel 为 0，以快速得到初始覆盖结果，做法为：先得到覆盖输入区域的 S2Cap，再用 S2CellUnion 覆盖该 S2Cap，根据 S2Cap 圆弧度计算 S2Cell 的 level，若最终 level &lt; 0，则说明 S2Cap 非常大，需要取 6 个面对应的 S2Cell，否则只需要取 S2Cap 中心点对应 S2Cell 的 level 级的点邻域 4 个 S2Cell 作为初始候选 S2Cell。</li>
<li>然后标准化候选种子。第一步，如果候选 S2Cell level 比 maxLevel 大或者候选 S2Cell 的 level 不符合 levelModel，则调整候选 S2Cell 的 level，用指定父级 S2Cell 来代替；第二步，归一化候选 S2Cell，先对 S2Cell 按 id 排序，去除被包含的 id，以及对 id 剪枝（若连续 4 个 S2Cell 共有同一个 parent，则用 parent 代替这 4 个 S2Cell）；第三步，反归一化候选 S2Cell，若候选 S2Cell level 比 minLevel 小或不满足 levelModel，则需要将 S2Cell 分裂，用指定级别的孩子来取代该 S2Cell；第四步，检查是否满足全部条件，若满足，则标准化完成，若不满足，则看候选 S2Cell 的数目是否足够多，若足够多，则需要迭代进行 GetCovering，这样会极大降低算法性能，若不是很多，则迭代合并相同祖先的两个 S2Cell（当然祖先的 level 不能比 minLevel 小），最后再次检查所有候选 S2Cell 是否达到标准化要求，并调整 S2Cell level。</li>
<li>构造优先级队列。将符合条件（与入参区域相交）的候选 S2Cell 放进一个优先级队列中，优先级会依次根据三个参数进行判断，1、S2Cell 的大小（level 越大，S2Cell 越小），越大的优先级越高；2、入参区域与候选 S2Cell 孩子相交（这里的相交是指相交但不完全包含）的个数，越少优先级越高；3、入参区域完全包含候选 S2Cell 孩子和与无法再细分的孩子的个数，同样是越少优先级越高。在构造这个优先级队列的同时，会输出一些候选 S2Cell 作为覆盖算法的正式结果，这些 S2Cell 满足任意以下条件：1、被入参区域完全覆盖；2、与入参区域相交但不可再细分；3、入参区域包含或相交全部孩子。如此留在优先级队列中的，就都是些与入参区域边界相交的 S2Cell，这些就是真正的候选 S2Cell。</li>
<li>最后，处理优先级队列中的 S2Cell。处理方式也比较简单粗暴，继续细分并入队，满足上面3个出队条件的任意一个，即可出队作为正式结果，当然，若分到后面可能正式的 S2Cell 太多，甚至超过 maxCells，这时不再细分强行出队作为正式结果。最后，再对正式结果做一次标准化处理，即进行第 2 步，得到最终的覆盖结果。</li>
</ol>
<p>　　以上就是 S2 覆盖算法的大致流程，更加细节的东西，还是得看代码，文字有些不是很好描述，代码里面计算候选 S2Cell 的优先级就很有意思。</p>
<hr />
<p>　　当然 S2 中还有很多其他算法（凸包，相交，距离），这里就不做太多介绍了，Shaun 平常用的最多的就是覆盖算法，之前一直没有细看，就简单用用 api，同时为了对一块大的 S2Cell 做多线程处理，需要了解 S2Cell 一分四的方向，经过这次对 S2 的了解，发现之前的用法存在一些问题，可见调包侠同样需要对包有一定的了解才能调好包 ╮(╯▽╰)╭。</p>
<h2 id="后记">后记</h2>
<p>　　正如许多经典的算法一样，看完之后总有种我上我也行的感觉，但实际完全不行，S2 全程看下来有些地方确实比较晦涩，而且这一连串的想法也很精妙（单位球立方体投影，ST 空间面积优化，64 位 id 生成等），Shaun 或许能有部分想法，但这么多奇思妙想组合起来，就完全不行。</p>
<h2 id="附录">附录</h2>
<h3 id="hilbertcurve-绘制">HilbertCurve 绘制</h3>
<p>　　在网上随便找了三种实现方式，并用 threejs 简单绘制了一下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="TYPESCRIPT"><div class="code-copy"></div><figure class="highlight hljs typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> THREE <span class="keyword">from</span> <span class="string">&quot;three&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">HilbertCurve</span> </span>&#123;</span><br><span class="line">    order = <span class="number">3</span>; <span class="comment">// 阶数</span></span><br><span class="line">    size = <span class="number">1</span> &lt;&lt; <span class="built_in">this</span>.order; <span class="comment">// 行列数</span></span><br><span class="line">    totalSize = <span class="built_in">this</span>.size * <span class="built_in">this</span>.size; <span class="comment">// 总网格数，希尔伯特长度</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// https://www.youtube.com/watch?v=dSK-MW-zuAc</span></span><br><span class="line">    <span class="function"><span class="title">getPath_V1</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> path = [];</span><br><span class="line">        <span class="keyword">let</span> origOrientation = [</span><br><span class="line">            [<span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">            [<span class="number">0</span>, <span class="number">1</span>],</span><br><span class="line">            [<span class="number">1</span>, <span class="number">1</span>],</span><br><span class="line">            [<span class="number">1</span>, <span class="number">0</span>],</span><br><span class="line">        ]; <span class="comment">// 倒 U 形</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="built_in">this</span>.totalSize; i++) &#123;</span><br><span class="line">            path.push(hilbertToXY(i, <span class="built_in">this</span>.order));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">hilbertToXY</span>(<span class="params">i: <span class="built_in">number</span>, order: <span class="built_in">number</span></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">let</span> index = i &amp; <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">let</span> curCoord = origOrientation[index].slice();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> ord = <span class="number">1</span>; ord &lt; order; ord++) &#123;</span><br><span class="line">                i = i &gt;&gt;&gt; <span class="number">2</span>;</span><br><span class="line">                index = i &amp; <span class="number">3</span>;</span><br><span class="line">                <span class="keyword">let</span> delta = <span class="number">1</span> &lt;&lt; ord;</span><br><span class="line">                <span class="keyword">if</span> (index === <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// 顺时针旋转 90°</span></span><br><span class="line">                    <span class="keyword">let</span> tmp = curCoord[<span class="number">0</span>];</span><br><span class="line">                    curCoord[<span class="number">0</span>] = curCoord[<span class="number">1</span>];</span><br><span class="line">                    curCoord[<span class="number">1</span>] = tmp;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (index === <span class="number">1</span>) &#123;</span><br><span class="line">                    curCoord[<span class="number">1</span>] += delta;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (index === <span class="number">2</span>) &#123;</span><br><span class="line">                    curCoord[<span class="number">0</span>] += delta;</span><br><span class="line">                    curCoord[<span class="number">1</span>] += delta;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (index === <span class="number">3</span>) &#123;</span><br><span class="line">                    <span class="comment">// 逆时针旋转 90°</span></span><br><span class="line">                    <span class="keyword">let</span> tmp = delta - <span class="number">1</span> - curCoord[<span class="number">0</span>];</span><br><span class="line">                    curCoord[<span class="number">0</span>] = delta - <span class="number">1</span> - curCoord[<span class="number">1</span>];</span><br><span class="line">                    curCoord[<span class="number">1</span>] = tmp;</span><br><span class="line">                    curCoord[<span class="number">0</span>] += delta;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> curCoord;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Hacker&#x27;s Delight</span></span><br><span class="line">    <span class="function"><span class="title">getPath_V2</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> path: <span class="built_in">number</span>[][] = [];</span><br><span class="line">        <span class="keyword">let</span> x = -<span class="number">1</span>,</span><br><span class="line">            y = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">let</span> s = <span class="number">0</span>; <span class="comment">// along the curve</span></span><br><span class="line"></span><br><span class="line">        step(<span class="number">0</span>);</span><br><span class="line">        hilbert(<span class="number">0</span>, <span class="number">1</span>, <span class="built_in">this</span>.order);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">step</span>(<span class="params">dir: <span class="built_in">number</span></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">switch</span> (dir &amp; <span class="number">3</span>) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                    x += <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                    y += <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                    x -= <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                    y -= <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            path[s] = [x, y];</span><br><span class="line"></span><br><span class="line">            s += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">hilbert</span>(<span class="params">dir: <span class="built_in">number</span>, rot: <span class="built_in">number</span>, order: <span class="built_in">number</span></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (order === <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            dir += rot;</span><br><span class="line">            hilbert(dir, -rot, order - <span class="number">1</span>);</span><br><span class="line">            step(dir);</span><br><span class="line"></span><br><span class="line">            dir -= rot;</span><br><span class="line">            hilbert(dir, rot, order - <span class="number">1</span>);</span><br><span class="line">            step(dir);</span><br><span class="line"></span><br><span class="line">            hilbert(dir, rot, order - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            dir -= rot;</span><br><span class="line">            step(dir);</span><br><span class="line">            hilbert(dir, -rot, order - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// https://en.wikipedia.org/wiki/Hilbert_curve</span></span><br><span class="line">    <span class="function"><span class="title">getPath_V3</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> path: <span class="built_in">number</span>[][] = [];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// for (let i = 0; i &lt; this.totalSize; i++) &#123;</span></span><br><span class="line">        <span class="comment">//     path.push(hilbertToXY(this.size, i));</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> y = <span class="number">0</span>; y &lt; <span class="built_in">this</span>.size; y++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> x = <span class="number">0</span>; x &lt; <span class="built_in">this</span>.size; x++) &#123;</span><br><span class="line">                path[xyToHilbert(<span class="built_in">this</span>.size, x, y)] = [x, y];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">rot</span>(<span class="params">N: <span class="built_in">number</span>, rx: <span class="built_in">number</span>, ry: <span class="built_in">number</span>, xy: <span class="built_in">number</span>[]</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (ry === <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (rx === <span class="number">1</span>) &#123;</span><br><span class="line">                    xy[<span class="number">0</span>] = N - <span class="number">1</span> - xy[<span class="number">0</span>];</span><br><span class="line">                    xy[<span class="number">1</span>] = N - <span class="number">1</span> - xy[<span class="number">1</span>];</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> t = xy[<span class="number">0</span>];</span><br><span class="line">                xy[<span class="number">0</span>] = xy[<span class="number">1</span>];</span><br><span class="line">                xy[<span class="number">1</span>] = t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">hilbertToXY</span>(<span class="params">N: <span class="built_in">number</span>, h: <span class="built_in">number</span></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">let</span> t = h;</span><br><span class="line">            <span class="keyword">let</span> xy = [<span class="number">0</span>, <span class="number">0</span>];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> s = <span class="number">1</span>; s &lt; N; s *= <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="keyword">let</span> rx = <span class="number">1</span> &amp; (t / <span class="number">2</span>);</span><br><span class="line">                <span class="keyword">let</span> ry = <span class="number">1</span> &amp; (t ^ rx);</span><br><span class="line">                rot(s, rx, ry, xy);</span><br><span class="line">                xy[<span class="number">0</span>] += s * rx;</span><br><span class="line">                xy[<span class="number">1</span>] += s * ry;</span><br><span class="line">                t /= <span class="number">4</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> xy;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">xyToHilbert</span>(<span class="params">N: <span class="built_in">number</span>, x: <span class="built_in">number</span>, y: <span class="built_in">number</span></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">let</span> h = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">let</span> xy = [x, y];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> s = N / <span class="number">2</span>; s &gt; <span class="number">0</span>; s /= <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="keyword">let</span> rx = (xy[<span class="number">0</span>] &amp; s) &gt; <span class="number">0</span> ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">let</span> ry = (xy[<span class="number">1</span>] &amp; s) &gt; <span class="number">0</span> ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">                h += s * s * ((<span class="number">3</span> * rx) ^ ry);</span><br><span class="line">                rot(N, rx, ry, xy);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> h;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">draw</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> lineGeometry = <span class="keyword">new</span> THREE.Geometry();</span><br><span class="line">        <span class="built_in">this</span>.getPath_V3().forEach(<span class="function">(<span class="params">vertice</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> vecot = <span class="keyword">new</span> THREE.Vector3().fromArray(vertice);</span><br><span class="line">            vecot.setZ(<span class="number">0</span>);</span><br><span class="line">            lineGeometry.vertices.push(vecot);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">let</span> lineMaterial = <span class="keyword">new</span> THREE.LineBasicMaterial(&#123; <span class="attr">color</span>: <span class="number">0x00ffff</span>, <span class="attr">linewidth</span>: <span class="number">1</span> &#125;);</span><br><span class="line">        <span class="keyword">let</span> line = <span class="keyword">new</span> THREE.Line(lineGeometry, lineMaterial);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> line;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
]]></content>
      <categories>
        <category>Mathematics</category>
      </categories>
      <tags>
        <tag>geometry</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo添加站内本地搜索</title>
    <url>/posts/4f6225b7.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　虽然 Shaun 博客目前数量不多，质量也不高，但抱着搞事的心态，先弄它一个站内本地搜索再说。</p>
<span id="more"></span>
<h2 id="准备篇">准备篇</h2>
<p>　　要想使用本地搜索功能，首先需要安装相应的搜索插件 <code>hexo-generator-searchdb</code>，网上可能大多数用的是 hexo-generator-search 这个插件，也有都装的，但 Shaun 就只安装这一个了，好像 <code>hexo-generator-searchdb</code> 更完善一点，由于 Shaun 前端接触的极少，所以就没有一一对比了，网上也没查到具体对比情况，有兴趣的童靴可以试试 (╯▽╰)。至于具体安装如下，在站点根目录执行：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line">npm install hexo-generator-searchdb --save</span><br></pre></td></tr></table></figure></div>
<p>　　安装完之后重新生成页面，将会发现 <strong>public文件夹</strong> 下多出一个 <code>search.xml</code> 文件。然后在配置文件 <code>_config.yml</code> 中添加：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="YAML"><div class="code-copy"></div><figure class="highlight hljs yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 站点本地搜索</span></span><br><span class="line"><span class="attr">search:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">search.xml</span></span><br><span class="line">  <span class="attr">field:</span> <span class="string">all</span></span><br></pre></td></tr></table></figure></div>
<p>其中：</p>
<ul>
<li><strong>path</strong> - 指定生成的索引数据的文件名。默认为 search.xml 。</li>
<li><strong>field</strong> - 指定索引数据的生成范围。可选值包括：
<ul>
<li><strong>post</strong> - 只生成博客文章（post）的索引（默认）；</li>
<li><strong>page</strong> - 只生成其他页面（page）的索引；</li>
<li><strong>all</strong> - 生成所有文章和页面的索引。</li>
</ul></li>
</ul>
<p>　　至于是在 <strong>主题配置文件</strong>，还是在 <strong>站点配置文件</strong> 中添加，个人觉得都没关系，附：Shaun 是在主题配置文件中添加的。</p>
<p>接下来就需要修改原主题的代码了。</p>
<h2 id="改码篇">改码篇</h2>
<p>　　由于 Shaun 博客主题是基于 <strong>SPFK</strong> 对照着 <strong>black-blue</strong> 进行修改的，而且因为 <strong>black-blue</strong> 是有搜索的（Shaun 不知道 <strong>black-blue</strong> 主题的作者是如何完成的，借助了什么技术），所以 Shaun 就看 <strong>black-blue</strong> 的搜索功能是修改了 <strong>SPFK</strong> 哪个地方，再将相应的代码添加至 <strong>SPFK</strong> 中（其中相应的代码来自<a href="http://moxfive.xyz/2016/05/31/hexo-local-search/">让 Hexo 博客支持本地站内搜索</a>），从而逐渐完成本次搜索功能。</p>
<p>首先找到 spfk 主题下的 <code>left-col.ejs</code> 文件，对其修改如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="code"><pre><span class="line">&lt;% if (theme.search_box)&#123; %&gt;</span><br><span class="line">            &lt;!-- &lt;form&gt;</span><br><span class="line">                &lt;input type=&quot;text&quot; class=&quot;st-default-search-input search&quot; id=&quot;search&quot; placeholder=&quot; Search...&quot;&gt;</span><br><span class="line">            &lt;/form&gt; --&gt;</span><br><span class="line"></span><br><span class="line">            &lt;form id=&quot;search-form&quot;&gt; &lt;!-- 搜索框相关 --&gt;</span><br><span class="line">                &lt;input type=&quot;text&quot; id=&quot;local-search-input&quot; name=&quot;q&quot; results=&quot;0&quot; placeholder=&quot;Search...&quot; class=&quot;search form-control&quot; autocomplete=&quot;off&quot; autocorrect=&quot;off&quot;/&gt;</span><br><span class="line">                &lt;i class=&quot;fa fa-times&quot; onclick=&quot;resetSearch()&quot;&gt;&lt;/i&gt; &lt;!-- 清空/重置搜索框 --&gt;</span><br><span class="line">            &lt;/form&gt;</span><br><span class="line">            &lt;div id=&quot;local-search-result&quot;&gt;&lt;/div&gt; &lt;!-- 搜索结果区 --&gt;</span><br><span class="line">            &lt;p class=&#x27;no-result&#x27;&gt;No results found &lt;/p&gt; &lt;!-- 无匹配时显示，注意请在 CSS 中设置默认隐藏 --&gt;</span><br><span class="line">        &lt;%&#125;%&gt;</span><br></pre></td></tr></table></figure></div>
<p>其次找到 spfk 主题下的 <code>after-footer.ejs</code> 文件，将其修改如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="code"><pre><span class="line">&lt;% if (theme.search_box)&#123; %&gt;</span><br><span class="line">    &lt;!-- &lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">      window.onload = function()&#123;</span><br><span class="line">        document.getElementById(&quot;search&quot;).onclick = function()&#123;</span><br><span class="line">            console.log(&quot;search&quot;)</span><br><span class="line">            search();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      function search()&#123;</span><br><span class="line">        (function(w,d,t,u,n,s,e)&#123;w[&#x27;SwiftypeObject&#x27;]=n;w[n]=w[n]||function()&#123;</span><br><span class="line">        (w[n].q=w[n].q||[]).push(arguments);&#125;;s=d.createElement(t);</span><br><span class="line">        e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);</span><br><span class="line">        &#125;)(window,document,&#x27;script&#x27;,&#x27;//s.swiftypecdn.com/install/v2/st.js&#x27;,&#x27;_st&#x27;);</span><br><span class="line"></span><br><span class="line">        _st(&#x27;install&#x27;,&#x27;A1Pz-LKMXbrzcFg2FWi6&#x27;,&#x27;2.0.0&#x27;);</span><br><span class="line">      &#125;</span><br><span class="line">    &lt;/script&gt; --&gt;</span><br><span class="line"></span><br><span class="line">    &lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">      // 激活搜索框时才搜索</span><br><span class="line">        var inputArea = document.querySelector(&quot;#local-search-input&quot;);</span><br><span class="line">        var getSearchFile = function()&#123;</span><br><span class="line">          // 调用搜索函数</span><br><span class="line">          var search_path = &quot;&lt;%- config.search.path %&gt;&quot;;</span><br><span class="line">          if (search_path.length == 0) &#123;</span><br><span class="line">             search_path = &quot;search.xml&quot;;</span><br><span class="line">          &#125;</span><br><span class="line">          var path = &quot;&lt;%- config.root %&gt;&quot; + search_path;</span><br><span class="line">          searchFunc(path, &#x27;local-search-input&#x27;, &#x27;local-search-result&#x27;);</span><br><span class="line">        &#125;</span><br><span class="line">        inputArea.onfocus = function()&#123; getSearchFile() &#125;</span><br><span class="line">  </span><br><span class="line">        // 搜索重置</span><br><span class="line">        var $resetButton = $(&quot;#search-form .fa-times&quot;);</span><br><span class="line">        var $resultArea = $(&quot;#local-search-result&quot;);</span><br><span class="line">        inputArea.oninput = function()&#123; $resetButton.show(); &#125;</span><br><span class="line">        resetSearch = function()&#123;</span><br><span class="line">          $resultArea.html(&quot;&quot;);</span><br><span class="line">          document.querySelector(&quot;#search-form&quot;).reset();</span><br><span class="line">          $resetButton.hide();</span><br><span class="line">          $(&quot;.no-result&quot;).hide();</span><br><span class="line">        &#125;</span><br><span class="line">  </span><br><span class="line">        // 屏蔽回车</span><br><span class="line">        inputArea.onkeydown = function()&#123; if(event.keyCode==13) return false&#125;</span><br><span class="line">  </span><br><span class="line">        // 无搜索结果</span><br><span class="line">        $resultArea.bind(&quot;DOMNodeRemoved DOMNodeInserted&quot;, function(e) &#123;</span><br><span class="line">          if (!$(e.target).text()) &#123;</span><br><span class="line">            $(&quot;.no-result&quot;).show(200); </span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            $(&quot;.no-result&quot;).hide();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">  </span><br><span class="line">        // 搜索函数</span><br><span class="line">        var searchFunc = function(path, search_id, content_id) &#123;</span><br><span class="line">          &#x27;use strict&#x27;;</span><br><span class="line">          $.ajax(&#123;</span><br><span class="line">            url: path,</span><br><span class="line">            dataType: &quot;xml&quot;,</span><br><span class="line">            success: function( xmlResponse ) &#123;</span><br><span class="line">                // get the contents from search data</span><br><span class="line">                var datas = $( &quot;entry&quot;, xmlResponse ).map(function() &#123;</span><br><span class="line">                    return &#123;</span><br><span class="line">                        title: $( &quot;title&quot;, this ).text(),</span><br><span class="line">                        content: $(&quot;content&quot;,this).text(),</span><br><span class="line">                        url: $( &quot;url&quot; , this).text()</span><br><span class="line">                    &#125;;</span><br><span class="line">                &#125;).get();</span><br><span class="line">                var $input = document.getElementById(search_id);</span><br><span class="line">                var $resultContent = document.getElementById(content_id);</span><br><span class="line">                $input.addEventListener(&#x27;input&#x27;, function()&#123;</span><br><span class="line">                    var str=&#x27;&lt;ul class=\&quot;search-result-list\&quot;&gt;&#x27;;                </span><br><span class="line">                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);</span><br><span class="line">                    $resultContent.innerHTML = &quot;&quot;;</span><br><span class="line">                    if (this.value.trim().length &lt;= 0) &#123;</span><br><span class="line">                        return;</span><br><span class="line">                    &#125;</span><br><span class="line">                    // perform local searching</span><br><span class="line">                    datas.forEach(function(data) &#123;</span><br><span class="line">                        var isMatch = true;</span><br><span class="line">                        var content_index = [];</span><br><span class="line">                        var data_title = data.title.trim().toLowerCase();</span><br><span class="line">                        var data_content = data.content.trim().replace(/&lt;[^&gt;]+&gt;/g,&quot;&quot;).toLowerCase();</span><br><span class="line">                        var data_url = data.url;</span><br><span class="line">                        var index_title = -1;</span><br><span class="line">                        var index_content = -1;</span><br><span class="line">                        var first_occur = -1;</span><br><span class="line">                        // only match artiles with not empty titles and contents</span><br><span class="line">                        if(data_title != &#x27;&#x27; &amp;&amp; data_content != &#x27;&#x27;) &#123;</span><br><span class="line">                            keywords.forEach(function(keyword, i) &#123;</span><br><span class="line">                                index_title = data_title.indexOf(keyword);</span><br><span class="line">                                index_content = data_content.indexOf(keyword);</span><br><span class="line">                                if( index_title &lt; 0 &amp;&amp; index_content &lt; 0 )&#123;</span><br><span class="line">                                    isMatch = false;</span><br><span class="line">                                &#125; else &#123;</span><br><span class="line">                                    if (index_content &lt; 0) &#123;</span><br><span class="line">                                        index_content = 0;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    if (i == 0) &#123;</span><br><span class="line">                                        first_occur = index_content;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;);</span><br><span class="line">                        &#125;</span><br><span class="line">                        // show search results</span><br><span class="line">                        if (isMatch) &#123;</span><br><span class="line">                            str += &quot;&lt;li&gt;&lt;a href=&#x27;/&quot;+ data_url +&quot;&#x27; class=&#x27;search-result-title&#x27; target=&#x27;_blank&#x27;&gt;&quot;+ &quot;&gt; &quot; + data_title +&quot;&lt;/a&gt;&quot;;</span><br><span class="line">                            var content = data.content.trim().replace(/&lt;[^&gt;]+&gt;/g,&quot;&quot;);</span><br><span class="line">                            if (first_occur &gt;= 0) &#123;</span><br><span class="line">                                // cut out characters</span><br><span class="line">                                var start = first_occur - 6;</span><br><span class="line">                                var end = first_occur + 6;</span><br><span class="line">                                if(start &lt; 0)&#123;</span><br><span class="line">                                    start = 0;</span><br><span class="line">                                &#125;</span><br><span class="line">                                if(start == 0)&#123;</span><br><span class="line">                                    end = 10;</span><br><span class="line">                                &#125;</span><br><span class="line">                                if(end &gt; content.length)&#123;</span><br><span class="line">                                    end = content.length;</span><br><span class="line">                                &#125;</span><br><span class="line">                                var match_content = content.substr(start, end); </span><br><span class="line">                                // highlight all keywords</span><br><span class="line">                                keywords.forEach(function(keyword)&#123;</span><br><span class="line">                                    var regS = new RegExp(keyword, &quot;gi&quot;);</span><br><span class="line">                                    match_content = match_content.replace(regS, &quot;&lt;em class=\&quot;search-keyword\&quot;&gt;&quot;+keyword+&quot;&lt;/em&gt;&quot;);</span><br><span class="line">                                &#125;)</span><br><span class="line">                                str += &quot;&lt;p class=\&quot;search-result\&quot;&gt;&quot; + match_content +&quot;...&lt;/p&gt;&quot;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;)</span><br><span class="line">                    $resultContent.innerHTML = str;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">&lt;%&#125;%&gt;</span><br></pre></td></tr></table></figure></div>
<p>最后找到 spfk 主题下的 <code>main.styl</code> 文件，在其末尾添加：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SCSS"><div class="code-copy"></div><figure class="highlight hljs scss"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*搜索框*/</span></span><br><span class="line"><span class="selector-class">.search</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">68%</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">18px</span>;</span><br><span class="line">  <span class="attribute">margin-top</span>: <span class="number">1px</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">font-family</span>: inherit;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">2px</span> solid transparent;</span><br><span class="line">  <span class="attribute">border-bottom</span>: <span class="number">2px</span> solid <span class="number">#d3d3d3</span>;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">2px</span>;</span><br><span class="line">  <span class="attribute">opacity</span>: <span class="number">0.65</span>;</span><br><span class="line">  <span class="attribute">background</span>: none;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.search</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">2px</span> solid <span class="number">#d3d3d3</span>;</span><br><span class="line">  <span class="attribute">opacity</span>: <span class="number">1</span>;</span><br><span class="line">  <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">10px</span> rgba(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0.3</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*搜索重置按钮*/</span></span><br><span class="line"><span class="selector-id">#search-form</span> <span class="selector-class">.fa-times</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: none;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">1px</span> <span class="number">0.7em</span>;</span><br><span class="line">  <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">3px</span> rgba(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0.15</span>);</span><br><span class="line">  <span class="attribute">cursor</span>: pointer;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#4094c7</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#search-form</span> <span class="selector-class">.fa-times</span><span class="selector-pseudo">:active</span> &#123;</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#d3d3d3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#search-form</span> <span class="selector-class">.fa-times</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">  zoom: <span class="number">1.1</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">1px</span> <span class="number">0.6em</span>;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#d3d3d3</span>;</span><br><span class="line">  <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">6px</span> rgba(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0.25</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*搜索结果区*/</span></span><br><span class="line"><span class="selector-id">#local-search-result</span> &#123;</span><br><span class="line">  <span class="comment">//margin: auto -12% auto -6%;</span></span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">0.9em</span>;</span><br><span class="line">  <span class="attribute">text-align</span>: left;</span><br><span class="line">  <span class="attribute">word-break</span>: break-all;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">box-shadow</span>: <span class="number">4px</span> <span class="number">4px</span> <span class="number">6px</span> rgba(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0.46</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#local-search-result</span> <span class="selector-tag">ul</span><span class="selector-class">.search-result-list</span> <span class="selector-tag">li</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">  <span class="attribute">font-weight</span>: normal;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*单条搜索结果*/</span></span><br><span class="line"><span class="selector-id">#local-search-result</span> <span class="selector-tag">li</span> &#123;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0.5em</span> auto;</span><br><span class="line">  <span class="attribute">border-bottom</span>: <span class="number">2px</span> solid <span class="number">#d3d3d3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#local-search-result</span> <span class="selector-class">.search-result-list</span> <span class="selector-tag">li</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">  <span class="attribute">background</span>: rgba(<span class="number">47</span>,<span class="number">46</span>,<span class="number">46</span>,<span class="number">0.8</span>);</span><br><span class="line">  <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">5px</span> rgba(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0.2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*匹配的标题*/</span></span><br><span class="line"><span class="selector-id">#local-search-result</span> <span class="selector-tag">a</span><span class="selector-class">.search-result-title</span> &#123;</span><br><span class="line">  <span class="attribute">line-height</span>: <span class="number">1.2</span>;</span><br><span class="line">  <span class="attribute">font-weight</span>: bold;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#4094c7</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*搜索预览段落*/</span></span><br><span class="line"><span class="selector-id">#local-search-result</span> <span class="selector-tag">p</span><span class="selector-class">.search-result</span> &#123;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0.4em</span> auto;</span><br><span class="line">  <span class="attribute">line-height</span>: <span class="number">1.2em</span>;</span><br><span class="line">  <span class="attribute">max-height</span>: <span class="number">3.6em</span>;</span><br><span class="line">  <span class="attribute">overflow</span>: hidden;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">0.8em</span>;</span><br><span class="line">  <span class="attribute">text-align</span>: justify;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#ffffff</span>b3;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*匹配的关键词*/</span></span><br><span class="line"><span class="selector-id">#local-search-result</span> <span class="selector-tag">em</span><span class="selector-class">.search-keyword</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#f58e90</span>;</span><br><span class="line">  <span class="attribute">border-bottom</span>: <span class="number">1px</span> dashed <span class="number">#f58e90</span>;</span><br><span class="line">  <span class="attribute">font-weight</span>: bold;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">1em</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*无匹配搜索结果时显示*/</span></span><br><span class="line"><span class="selector-tag">p</span><span class="selector-class">.no-result</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: none;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">2em</span> <span class="number">0</span> <span class="number">2em</span> <span class="number">6%</span>;</span><br><span class="line">  <span class="attribute">padding-bottom</span>: <span class="number">0.5em</span>;</span><br><span class="line">  <span class="attribute">text-align</span>: left;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#808080</span>;</span><br><span class="line">  <span class="attribute">font-family</span>: font-serif serif;</span><br><span class="line">  <span class="attribute">border-bottom</span>: <span class="number">2px</span> solid <span class="number">#d3d3d3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>　　这里请注意，当对 <code>main.styl</code> 文件做以上修改时，可能会发现有两个 <code>.search</code> 样式，而且相差不大，这时，不要对其原有的 <code>.search</code> 进行修改，更不要去注释掉它，只做上述修改就不用管了，不然可能会发生一些奇怪的事 o(&gt;﹏&lt;)o。Shaun 当时做以上修改时，将其原有的 <code>.search</code> 样式注释掉之后，整个页面的 css 布局全部都乱了 (╯﹏╰)，不知道为什么 (⊙_⊙?)，这两个同名样式看起来明明差不多的，最后只能维持现状了，等以后有机会再看看吧，业余前端伤不起啊! ╮(╯_╰)╭。</p>
<p>　　至此整个站内本地搜索功能基本完成，勉强可以使用站内搜索功能了。</p>
<h2 id="问题篇">问题篇</h2>
<p>　　*注：以下问题于 2018-03-02 都已经解决 ╮(╯▽╰)╭。</p>
<p><font color=#FA8072>1、搜索函数返回的 url 地址有问题。</font></p>
<p>　　问题描述：当点击搜索结果时，新弹出的标签页地址栏中 url 地址会有部分乱码情况；当鼠标移到搜索的结果列表上时，浏览器左下角显示的 url 地址虽然没有乱码情况，但其中有一个重复的<code>/</code>符号。所幸这两个问题并没有造成浏览器解析错误，浏览器还是可以正常显示页面的。</p>
<p><strong><em>================= 修改日期：2018-03-02 =================</em></strong></p>
<p>　　<strong>解决办法：</strong>将 <code>\blog\node_modules\hexo-generator-searchdb\templates\xml.ejs</code> 文件中的 <code>&lt;url&gt;&lt;%- encodeURIComponent(config.root + post.path) %&gt;&lt;/url&gt;</code> 修改为 <code>&lt;url&gt;&lt;%- encodeURI(post.path) %&gt;&lt;/url&gt;</code> ，使其中一些 url 中常见的字符（如：&amp;, ?, /, =）<strong>不被</strong>十六进制的转义序列进行替换。</p>
<p><strong>参考：</strong><a href="https://www.zhihu.com/question/21861899">escape,encodeURI,encodeURIComponent有什么区别?</a> 和 <a href="http://www.w3school.com.cn/jsref/jsref_encodeURIComponent.asp">JavaScript encodeURIComponent() 函数</a> 。</p>
<p>=====================================================</p>
<p><font color=#FA8072>2、搜索结果区布局有问题。</font></p>
<p>　　问题描述：当显示搜索结果时，搜索结果区会上下扩张，从而将其上下本来存在的一些布局挤开，造成布局混乱。这其实不算是一个 spfk 主题或者新添加的搜索功能的问题，而是新添加的一个东西又没有相应的和原本布局结合的布局文件，那就极大可能会有布局混乱的问题，至于这个要和原本布局契合的搜索结果区布局文件就只有等 Shaun 以后有机会有时间再完善去喽 ╮(╯▽╰)╭。</p>
<p><font color=#FA8072>3、搜索框激活问题。</font></p>
<p>　　问题描述：搜索框激活延迟很大，有时过很久或者需要切换站内页面它才能激活，给人的感觉就是好像没有搜索功能似的。添加搜索框激活功能据作者 <a href="http://moxfive.xyz/">MOxFIVE</a> 所说是为了不让索引文件影响页面加载速度，MOxFIVE 同时也在文末指出了一些不足之处，如果索引文件太大，可能还是会造成一些问题，但 Shaun 的博客数量又不多，所以估计还是 Shaun 的代码混合问题，而且 MOxFIVE 的博客搜索功能好像没这个问题（至少 Shaun 目前没发现）。这个问题同样只有等以后再说了 (*^__^*) 嘻嘻……。</p>
<h2 id="后记">后记</h2>
<p>　　本文添加的本地搜索还很粗糙，还有很多地方需要以后去完善。但这好歹是一个好的开始，搜索功能至少勉强能够正常使用，总比以前是个空壳要好，以后有机会再慢慢去去完善吧 ↖(^ω^)↗。</p>
<h2 id="参考资料">参考资料</h2>
<p>[1] <a href="http://www.hahack.com/codes/local-search-engine-for-hexo/">jQuery-based Local Search Engine for Hexo</a>（<a href="http://www.hahack.com/categories/codes/" class="uri">http://www.hahack.com/categories/codes/</a>）</p>
<p>[2] <a href="http://moxfive.xyz/2016/05/31/hexo-local-search/">让 Hexo 博客支持本地站内搜索</a>（<a href="http://moxfive.xyz/tags/Hexo/" class="uri">http://moxfive.xyz/tags/Hexo/</a>）</p>
<p>[3] <a href="https://www.ezlippi.com/blog/2017/02/hexo-search.html">Hexo博客添加站内搜索</a>（<a href="https://www.ezlippi.com/categories/hexo/" class="uri">https://www.ezlippi.com/categories/hexo/</a>）</p>
<p>[4] <a href="https://www.oyohyee.com/post/Note/LocalSearch.html">Hexo本地搜索及部分SEO优化</a> （<a href="https://www.oyohyee.com/categories/Note/" class="uri">https://www.oyohyee.com/categories/Note/</a>）</p>
]]></content>
      <categories>
        <category>建站小记</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo添加各种小部件</title>
    <url>/posts/3bc0decc.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　Shaun 目前还在使用对 Hexo 的主题 <strong>SPFK</strong> 自行魔改的那个主题（所谓的魔改也就是对照着 <strong>black-blue</strong> 主题修改了部分 CSS，然后又添加了一个站内搜索功能 (&gt;^ω^&lt;)），主题 SPFK 主体的东西其实都没改变。现在正逐渐将其完善中，遂有此文。</p>
<span id="more"></span>
<h2 id="添加-qq-邮箱联系">添加 QQ 邮箱联系</h2>
<p><strong><em>添加日期：2017-9-15</em></strong></p>
<p>　　进入 <a href="http://openmail.qq.com/">QQ邮箱开放平台</a>，点击“<strong>获取邮我按钮</strong>”，登录 QQ 之后继续点击该按钮，因为 Shaun 不需要其样式，只需要其链接即可，所以就默认样式，直接点击“<strong>获取代码</strong>”即可，Shaun 默认的“<strong>HTML代码</strong>”为：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="HTML"><div class="code-copy"></div><figure class="highlight hljs html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">target</span>=<span class="string">&quot;_blank&quot;</span> <span class="attr">href</span>=<span class="string">&quot;http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=qNvAyd3G0d3JxujOx9DFycHEhsvHxQ&quot;</span> <span class="attr">style</span>=<span class="string">&quot;text-decoration:none;&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;http://rescdn.qqmail.com/zh_CN/htmledition/images/function/qm_open/ico_mailme_01.png&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure></div>
<p>提取其中的 href，即<code>http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=qNvAyd3G0d3JxujOx9DFycHEhsvHxQ</code>，将该链接添加到 <strong>主题配置文件</strong> 中，具体如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="YAML"><div class="code-copy"></div><figure class="highlight hljs yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">subnav:</span></span><br><span class="line">  <span class="attr">mail:</span> <span class="string">&quot;http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=qNvAyd3G0d3JxujOx9DFycHEhsvHxQ&quot;</span></span><br></pre></td></tr></table></figure></div>
<p>重新部署站点即可发现对应的邮箱图标，点击该图标可直接给 Shaun 发邮件。</p>
<h2 id="添加-qq-交谈链接">添加 QQ 交谈链接</h2>
<p><strong><em>添加日期：2017-9-15</em></strong></p>
<p>　　进入 <a href="http://shang.qq.com/v3/widget.html">QQ推广</a>，点击上方的“<strong>推广工具</strong>”，若没登录 QQ 则先登录 QQ，组件样式同样默认即可，这里需要注意的是，需要点击左边的“<strong>设置</strong>”，下滚页面，找到“<strong>安全级别设置</strong>”，如下</p>
<blockquote>
<p><h><strong>安全级别设置</strong></h></p>
<p><input name="qq_security" type="radio"></input> 完全公开（推荐商家，客服等用户使用，代码中显示QQ号码，易于推广）</p>
<p><input name="qq_security" type="radio"></input> 安全加密（推荐博主，论坛用户等使用，代码中不显示QQ号码）</p>
</blockquote>
<p>选中“<strong>安全加密</strong>”，不然该选项默认的为完全公开，这样 QQ 号码就直接会显示在代码中，不利于隐私保护，选中之后，点击“<strong>保存</strong>”。保存之后，再次点击“<strong>推广工具</strong>”，即可发现下方的复制代码区域的 HTML 代码已看不到明码显示的 QQ 号，（若还是能看到 QQ 号，没有任何变化，可关闭该界面，重启浏览器重新进入该界面），Shaun 的“<strong>复制这段代码并将其粘贴到您的网页上</strong>”下方区域的默认的代码为：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="HTML"><div class="code-copy"></div><figure class="highlight hljs html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">target</span>=<span class="string">&quot;_blank&quot;</span> <span class="attr">href</span>=<span class="string">&quot;http://sighttp.qq.com/authd?IDKEY=b1afd83745b30922bc98e020847b86a5148d2114e62e8422&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">border</span>=<span class="string">&quot;0&quot;</span>  <span class="attr">src</span>=<span class="string">&quot;http://wpa.qq.com/imgd?IDKEY=b1afd83745b30922bc98e020847b86a5148d2114e62e8422&amp;pic=52&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;点击这里给我发消息&quot;</span> <span class="attr">title</span>=<span class="string">&quot;点击这里给我发消息&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure></div>
<p>提取其中的 href，即<code>http://sighttp.qq.com/authd?IDKEY=b1afd83745b30922bc98e020847b86a5148d2114e62e8422</code>，将该链接添加到 <strong>主题配置文件</strong> 中，具体如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="YAML"><div class="code-copy"></div><figure class="highlight hljs yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">subnav:</span></span><br><span class="line">  <span class="attr">QQ:</span> <span class="string">&quot;http://sighttp.qq.com/authd?IDKEY=4faf682653b3b7f5f47b9cb6d2bb8b81de8fa7a8fb8cee12&quot;</span>  </span><br></pre></td></tr></table></figure></div>
<p>重新部署站点即可发现对应的 QQ 图标，点击该图标可直接给 Shaun 发临时 QQ 消息。</p>
<h2 id="添加用户访问统计信息小工具-revolvermaps">添加用户访问统计信息小工具 —— RevolverMaps</h2>
<p><strong><em>添加日期：2017-10-12</em></strong></p>
<p>　　由于 Shaun 暂时不想搞 SEO，所以就没有搞站点地图，更没有将 Shaun 的站点提交到百度和 Google 的站长平台上。但 Shaun 又想查看用户访问信息（是不是很矛盾 o(╯□╰)o），而正好 Shaun 看到有个很酷炫的 3D地球 能满足 Shaun 的需求（其实很酷炫才是主要原因 O(∩_∩)O~），所以 Shaun 决定将其加入 Shaun 的站点中（当做一部分装饰品 ๑乛◡乛๑）。该插件的名称为 <a href="http://www.revolvermaps.com/?target=gallery">RevolverMaps</a>，具体样式可以去其官网看，Shaun 就不贴图了。设置完前三步之后，第四步让用户复制代码到自己的站点上，注意第四步会让你选“<strong>new map</strong>”还是“<strong>update</strong>”，由于 Shaun 是初次使用，当然是选择默认的“<strong>new map</strong>”，如果是以前使用过，就选择“<strong>update</strong>”，并将原来使用的 script 代码输入出现的文本框并提交，这样就只是更改 3D 地球样式而不会丢失用户访问信息数据。 　　具体添加方法为：将复制的 script 代码放入想显示的某个 div 中。Shaun 得到的 script 代码为：</p>
<blockquote>
<p><code>&lt;script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=50om5cdoa3h&amp;amp;m=7&amp;amp;c=ff0000&amp;amp;cr1=ffffff&amp;amp;f=arial&amp;amp;l=49" async="async"&gt;&lt;/script&gt;</code></p>
</blockquote>
<p>　　由于 Shaun 的博客是双栏的，Shaun 当然是把 RevolverMaps 放入左栏中，Shaun 刚开始是把得到的 script 代码放入主题文件夹下 <code>\layout\_partial\left-col.ejs</code> 文件末尾的</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="HTML"><div class="code-copy"></div><figure class="highlight hljs html"><table><tr><td class="code"><pre><span class="line"> <span class="tag">&lt;/<span class="name">header</span>&gt;</span>                </span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure></div>
<p><code>&lt;/header&gt;</code> 标签之前（即在 header 的最下端显示 RevolverMaps ），但实际用起来有点不好看；Shaun 又想干脆另外创造一个 div 放置地球，具体思路为：在 birdhouse 图标旁创建一个新的地球图标，再做一个像 birdhouse 图标一样的动画，鼠标移到地球图标时，出现一个 div，该 div 用来放置 RevolverMaps，这一步做到一半（即将一个新的地球图标并排放在 birdhouse 图标旁）发现这个效果感觉更不好看了，如果要改就需要大改了，有点麻烦 o(︶︿︶)o唉；于是 Shaun 看到鼠标放在 birdhouse 图标出现的菜单栏上，想到何不如将该菜单栏在添加一栏，创建一个 div 用来显示 RevolverMaps？事不宜迟，马上就动手添加该 div，具体添加步骤如下：</p>
<ol type="1">
<li><p>首先当然是添加一个“<strong>访问情况</strong>”的列表名称，在主题文件夹下 <code>\layout\_partial\left-col.ejs</code> 文件中 <code>&lt;ul class="tips-inner"&gt;</code> 下最后一个 <code>&lt;li&gt;</code> 后即 <code>&lt;/ul&gt;</code> 前添加 <code>&lt;li&gt;访问情况&lt;/li&gt;</code>；</p></li>
<li><p>接着像其它的列表一样（点击该列表 birdhouse 图标就会改变成相应的图标），点击“<strong>访问情况</strong>”会将 birdhouse 图标改变成一个地球小图标，经查阅相应的 css 文件，其它的列表对应的图标好像是利用 div 的边框属性画出来的（某业余前端的猜测+_+），Shaun 目前还没有这样的才能，就只有投机的采用 Font Awesome 中的 <a href="http://fontawesome.io/icon/globe/">globe</a> 图标了。在主题文件夹下 <code>\layout\_partial\left-col.ejs</code> 文件中 <code>&lt;div class="icon-ctn"&gt;</code> 下最末尾即其对应的 <code>&lt;/div&gt;</code> 前添加：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="HTML"><div class="code-copy"></div><figure class="highlight hljs html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;icon-wrap icon-globe hide&quot;</span> <span class="attr">data-idx</span>=<span class="string">&quot;4&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa fa-globe fa-spin fa-2x&quot;</span> <span class="attr">aria-hidden</span>=<span class="string">&quot;true&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure></div>
<p>这样点击“<strong>访问情况</strong>”会将 birdhouse 图标变成一个旋转的地球小图标了；</p></li>
<li><p>接下来就需要创建“<strong>访问情况</strong>”对应的 div 了，在主题文件夹下 <code>\layout\_partial\left-col.ejs</code> 文件中 <code>&lt;div class="switch-wrap"&gt;</code> 下最末尾即其对应的 <code>&lt;/div&gt;</code> 前添加：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="HTML"><div class="code-copy"></div><figure class="highlight hljs html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;switch-part switch-part5&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;//rf.revolvermaps.com/0/0/8.js?i=50om5cdoa3h<span class="symbol">&amp;amp;</span>m=7<span class="symbol">&amp;amp;</span>c=ff0000<span class="symbol">&amp;amp;</span>cr1=ffffff<span class="symbol">&amp;amp;</span>f=arial<span class="symbol">&amp;amp;</span>l=49&quot;</span> <span class="attr">async</span>=<span class="string">&quot;async&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br></pre></td></tr></table></figure></div>
<p>这样点击“<strong>访问情况</strong>”就能出现酷炫的 3D 地球了，才怪 :p。这样只能让 3D 地球出现在菜单界面，还需要添加修改相应的 css；</p></li>
<li><p>最后就是改 css 样式了，本以为这一步很简单，没想到这一步花费 Shaun 最多时间 ╮(╯_╰)╭，修改的样式位于主题文件夹下 <code>\source\css_partial\main.styl</code> 文件中，首先为 switch-part5 添加对应的样式，在 .switch-part4 样式后添加：</p>
<p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="HTML"><div class="code-copy"></div><figure class="highlight hljs html"><table><tr><td class="code"><pre><span class="line">.switch-part5&#123;</span><br><span class="line">        left: 400%;</span><br><span class="line">        width: 100%;</span><br><span class="line">    	//height: 200px;</span><br><span class="line">        //margin-left: 47px;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div></p>
<p>做完这一步会发现 3D 地球显示不完全，下面会缺一点，所以还需要继续修改，修改过程如下：Shaun 曾将该 width 减小（如上面代码中的注释），这样确实能让 3D 地球显示完全，但有点小，不是很好看；后面想到没显示完全可能是上层 div（.switch-area）太小且设置了 <code>overflow: hidden;</code>，于是这里 Shaun 首先增加了 .switch-area 的高度，这样确实能解决问题，但会使左栏的滚动条显示出来；所以 Shaun 接着尝试将 .switch-area 的 <code>overflow: hidden;</code> 注释掉，谁想注释掉之后出现了横向滚动条，这样更不好了，于是 Shaun 又更改为 <code>overflow-x: hidden;</code> ，谁想 .switch-area 又出现了竖直滚动条（感觉像拆东墙补西墙 -_-|||），查阅相关资料（<a href="http://blog.csdn.net/qiqingjin/article/details/50413691">CSS-overflow特性及总结</a>）得知若 overflow-x 为 hidden，overflow-y 不为 hidden，则 overflow-y 将会自动重置为 auto，所以这里不能这样改，但 <code>overflow: hidden;</code> 还是得注释掉，不然上层 div 撑不开，而且不增加高度的话，还是不能完全显示 3D 地球，因为超出就隐藏了嘛；因为注释掉之后会出现横向滚动条，而又不能修改 .switch-area 的 overflow-x，所以就只能改更上层的 div，这里 Shaun 突然想起上次给左栏添加滚动条时，在 .left-col 下添加了 <code>overflow: auto;</code>，这次不如还修改这里，毕竟 Shaun 只想要竖直滚动条（其实不要滚动条却能滚动最好，但 Shaun 目前还没找到好的解决方案 (╯﹏╰)b），不要横向滚动条，于是将其修改为：</p>
<p><div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="CSS"><div class="code-copy"></div><figure class="highlight hljs css"><table><tr><td class="code"><pre><span class="line"><span class="attribute">overflow-y</span>: auto;</span><br><span class="line"><span class="attribute">overflow-x</span>: hidden;</span><br></pre></td></tr></table></figure></div></p>
<p>没想到这样也能解决问题，虽然还是会在左栏出现滚动条，但这样感觉比增加 .switch-area 的高度要好（嗯，应该要好吧 (～ o ～)Y）。看以后能不能改成点击“<strong>访问情况</strong>”时才出现滚动条，点击其它列表则不出现滚动条（其实把滚动条隐藏最好，但网上那个两个 div 嵌套的方法 Shaun 尝试过会出现一些奇怪的问题，等以后再试试吧 ↖((^ω^)↗）。</p></li>
</ol>
<hr />
<p>待续。。。</p>
<h2 id="后记">后记</h2>
<p>　　目前就添加这些小组件，以后应该会陆续添加一些其它的小东西 ↖(^ω^)↗。</p>
<h2 id="参考资料">参考资料</h2>
<p>[1] <a href="http://jingyan.baidu.com/article/dca1fa6fb5b637f1a44052b4.html">如何在自己网站上或者博客上放置QQ邮箱联系反馈</a>（<a href="http://jingyan.baidu.com/tag?tagName=%E9%82%AE%E7%AE%B1" class="uri">http://jingyan.baidu.com/tag?tagName=%E9%82%AE%E7%AE%B1</a>）</p>
<p>[2] <a href="http://www.29mo.com/wltg/363.html">如何在自己的博客添加QQ组件</a>（<a href="http://www.29mo.com/category/wltg" class="uri">http://www.29mo.com/category/wltg</a>）</p>
<p>[3] <a href="http://www.feizl.com/html/29610.htm">一步一步教你给自己博客添加QQ在线</a>（<a href="http://www.feizl.com/feizhuliu/QQbaodian/" class="uri">http://www.feizl.com/feizhuliu/QQbaodian/</a>）</p>
]]></content>
      <categories>
        <category>建站小记</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>HTTP 超时浅见</title>
    <url>/posts/36b343ff.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　最近业务调用方反馈接收到服务连接中断的错误（python requests 请求抛出异常 <code>raise ConnectionError(err, request=request) \n ConnectionError: ('Connection aborted.', BadStatusLine("''",))</code>），但从 golang 服务日志中看，服务应该是正常处理完成并返回了，且抛出异常的时间也基本和服务返回数据的时间一致，即表明在服务响应返回数据的那一刻，请求方同时抛出异常。</p>
<p>　　这个问题很奇怪，起初拿到一个 case 还无法稳定复现，最初怀疑是网络抖动问题，但后续一直会偶发性出现，直到拿到了一个能稳定复现的 case，深入跟踪排查后才发现与网络问题无关，是服务端框架应用设置不合理的问题。</p>
<span id="more"></span>
<h2 id="问题篇">问题篇</h2>
<p>　　从网上搜索 <code>python ConnectionError: ('Connection aborted.')</code>，错误种类非常多，有网络问题，服务端问题（关闭连接，拒绝服务，响应错误等），客户端关闭连接，超时设置不合理，请求参数/协议错误等等，但若带上 <code>BadStatusLine("''",)</code> ，错误就相对比较明确了（<a href="https://stackoverflow.com/questions/47196100/badstatusline-error-in-using-python-requests">BadStatusLine Error in using Python, Requests</a>，<a href="https://stackoverflow.com/questions/33174804/python-requests-getting-connection-aborted-badstatusline-error">Python Requests getting ('Connection aborted.', BadStatusLine("''",)) error</a>），主要是由于收到了一个空响应（header/body），空响应可以明确是服务端返回的问题，一般可能有以下几个原因：1. 服务端反爬；2. 服务端超时（比如 nginx 默认 60s 超时）；3. 网络错误。</p>
<p>　　由于是内部服务，所以反爬策略是没有的，而反馈的 case 都带有明显的特征（请求数据量大，处理耗时长），没有网络抖动那种随机性，所以应该也不是网络问题，剩下的只能是超时问题，由于业务方在前置策略上已经识别该 case 数据量大，所以不经过 nginx 网关，直连服务请求，所以也不会有 nginx 超时问题，只能是服务端自己超时。于是直接在代码中查找 timeout 关键字，发现在服务启动时设置了 ReadTimeout 和 WriteTimeout，进一步深挖之后，才对 go 服务的超时有了浅显的认识。</p>
<h2 id="超时篇">超时篇</h2>
<p>参考资料：1. <a href="https://cloud.tencent.com/developer/article/1836274">你真的了解 timeout 吗？</a>，2. <a href="https://mp.weixin.qq.com/s?__biz=MzkxNTU5MjE0MQ==&amp;mid=2247492773&amp;idx=1&amp;sn=972e67c2536225e6f01b70c52a08aee6&amp;source=41#wechat_redirect">i/o timeout ， 希望你不要踩到这个net/http包的坑</a>，3. <a href="https://zhuanlan.zhihu.com/p/551557249">net/http完全超时手册</a>。</p>
<p>　　由于 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP">HTTP</a> 协议规范并未提及超时标准，而为保证服务稳定性，一般的 HTTP 服务请求都会设置超时时间，各 HTTP 服务端/客户端对于超时的理解大同小异，而这次的问题又起源与 go 服务，所以以 go 为例，分析一下超时。</p>
<h3 id="客户端超时">客户端超时</h3>
<figure>
<img src="https://pic4.zhimg.com/80/v2-a66e1905b916028ef5aa2ee41cc9a673_1440w.webp" alt="http.Client.Timeout" /><figcaption aria-hidden="true">http.Client.Timeout</figcaption>
</figure>
<p>　　客户端超时，即 GET/POST 请求超时，这个很好理解，就是客户端发送请求到客户端接收到服务器返回数据的时间，算是开发的一般性常识，控制参数一般也特别简单，就是一个 timeout，当然 go 服务客户端支持设置更精细化的超时时间，一般也没啥必要。当客户端感知到超时时，会正常发起 TCP 断开连接的“四次挥手”过程。</p>
<h3 id="服务端超时">服务端超时</h3>
<figure>
<img src="https://pic2.zhimg.com/80/v2-8e520795ca5a552fba7ebffd301f6b95_1440w.png" alt="http.Server Timeouts" /><figcaption aria-hidden="true">http.Server Timeouts</figcaption>
</figure>
<p>　　服务端超时，这才是引发问题的根本原因，go 服务端的超时，主要有两个参数，ReadTimeout 和 WriteTimeout，从上图可以看出，ReadTimeout 主要是设置服务端接收请求到读取客户端请求数据的时间（读请求的时间），WriteTimeout 是服务端处理请求数据以及返回数据的时间（写响应的时间）。GoFrame 框架的 ReadTimeout 默认值是 60s，在请求数据正常的情况下 ReadTimeout 也不可能超时，这次的问题主要出在 WriteTimeout，GoFrame 的默认值是 0s，代表不控制超时，但之前的开发者也同样设置为了 60s，导致服务端在处理大量数据时，发生了超时现象。</p>
<p>　　更深挖之后，才发现 WriteTimeout 的诡异之处，当 WriteTimeout 发生之后，服务端不会即时返回超时消息，而是需要等服务端真正处理完之后，返回数据时，才会返回一个空数据，即使服务端正常写入返回数据，但都会强制为空数据返回，导致请求客户端报错。这种表现，看起来就像是 WriteTimeout 不仅没有起到应有的作用，在错误设置的情况下，还会起到反作用，使服务响应错误。WriteTimeout 无法即时生效的问题，也同样有其他人反馈了：1. <a href="https://adam-p.ca/blog/2022/01/golang-http-server-timeouts/">Diving into Go's HTTP server timeouts</a>；2. <a href="https://github.com/golang/go/issues/59602">net/http: Request context is not canceled when <code>Server.WriteTimeout</code> is reached</a>。可能是网上反馈的人多了，go 官方推出了一个 <a href="https://github.com/golang/go/blob/master/src/net/http/server.go#L3571">TimeoutHandler</a>，通过这个设置服务端超时，即可即时返回超时消息。仿照官方的 TimeoutHandler ，即可在 GoFrame 框架中也实现自己的超时中间件。</p>
<p>　　至于 WriteTimeout 为啥不起作用，个人猜测主要原因在于 go 服务每接收到一个请求，都是另开一个协程进行处理，而 <a href="https://geektutu.com/post/hpg-timeout-goroutine.html#3-%E5%BC%BA%E5%88%B6-kill-goroutine-%E5%8F%AF%E8%83%BD%E5%90%97%EF%BC%9F">goroutine 无法被强制 kill，只能自己退出</a>，通常是要等到 goroutine 正常处理完之后才能返回数据，WriteTimeout 只是先强制写一个空数据占位，返回还是得等 goroutine 正常处理完。</p>
<p>　　所以正常的 go 服务，在使用类似于 TimeoutHandler 中间件的时候，也最好让 goroutine 尽可能快的退出，一种简单的方法是：1. 设置请求的 context 为 context.WithTimeout；2. 分步处理数据，每一步开始前都先检查请求传入的 context 是否已经超时；3. 若已经超时，则直接 return，不进行下一步处理，快速退出 goroutine。</p>
<h2 id="后记">后记</h2>
<p>　　这次问题排查，碰到的最大障碍在于，前几次反馈的 case 难以复现，客户端请求报错和服务器返回的时间一致也不会让人往超时的角度去想，在拿到一个能稳定复现的 case 之后，才死马当活马医，先调一下超时参数试试。</p>
<p>　　关于 go 服务超时的文章，其实之前也看过，但没碰到具体问题，名词也就仅仅只是名词，很难理解背后的含义和其中的坑点，实践才能出真知 ╮(~▽~)╭。</p>
<h2 id="附录">附录</h2>
<h3 id="长连接超时">长连接超时</h3>
<p>　　关于超时问题，也曾看到过有人碰到一个长链接服务的问题，现象是这样的：后端服务宕机之后，客户端可能需要很久才会感知到，原因在于 tcp 的超时重传机制，在 linux 中，默认会重传 tcp_retries2=15 次（即 16 次才会断开连接），而 TCP 最大超时时间为 TCP_RTO_MAX=2min，最小超时时间为 TCP_RTO_MIN=200ms。即在 linux 中，一个典型的 TCP 超时重传表现为：</p>
<table>
<thead>
<tr class="header">
<th>重传次数</th>
<th>发送时间</th>
<th>超时时间</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>-1（原始数据发送）</td>
<td>0s</td>
<td>0.2s</td>
</tr>
<tr class="even">
<td>0 （第 0 次重传）</td>
<td>0.2s</td>
<td>0.2s</td>
</tr>
<tr class="odd">
<td>1</td>
<td>0.4s</td>
<td>0.4s</td>
</tr>
<tr class="even">
<td>2</td>
<td>0.8s</td>
<td>0.8s</td>
</tr>
<tr class="odd">
<td>3</td>
<td>1.6s</td>
<td>1.6s</td>
</tr>
<tr class="even">
<td>4</td>
<td>3.2s</td>
<td>3.2s</td>
</tr>
<tr class="odd">
<td>5</td>
<td>6.4s</td>
<td>6.4s</td>
</tr>
<tr class="even">
<td>6</td>
<td>12.8s</td>
<td>12.8s</td>
</tr>
<tr class="odd">
<td>7</td>
<td>25.6s</td>
<td>25.6s</td>
</tr>
<tr class="even">
<td>8</td>
<td>51.2s</td>
<td>51.2s</td>
</tr>
<tr class="odd">
<td>9</td>
<td>102.4s</td>
<td>102.4s</td>
</tr>
<tr class="even">
<td>10</td>
<td>204.8s</td>
<td>120s</td>
</tr>
<tr class="odd">
<td>11</td>
<td>324.8s</td>
<td>120s</td>
</tr>
<tr class="even">
<td>12</td>
<td>444.8s</td>
<td>120s</td>
</tr>
<tr class="odd">
<td>13</td>
<td>564.8s</td>
<td>120s</td>
</tr>
<tr class="even">
<td>14</td>
<td>684.8s</td>
<td>120s</td>
</tr>
<tr class="odd">
<td>15</td>
<td>804.8s</td>
<td>120s</td>
</tr>
<tr class="even">
<td>断开连接</td>
<td>924.8s（≈15min）</td>
<td></td>
</tr>
</tbody>
</table>
<p>所以客户端需要在 15 分钟之后才能感知到服务端不可用，如此，仅靠 TCP 自身的超时机制，很难发现服务端是否宕机/不可用，长链接不释放，进而可能导致客户端不可用且无感知，所以在长链接服务中，需要有其他的手段来保障服务稳定/可用性（eg：心跳探活）。</p>
<h3 id="服务端-context-canceled">服务端 context canceled</h3>
<p><em>Refer to: <a href="https://learnku.com/articles/63884">context canceled，谁是罪魁祸首</a></em></p>
<p>　　从官方的 net/http 包中可以知道，go 服务在接收请求时，会同时生成一个协程监控连接状态，当发现连接有问题（eg：客户端设置请求超时主动断开）时，会将该请求对应的 context cancel 掉，这时服务端如果再继续使用该 context 时，就会报错「context canceled」。当然，如果服务端发生错误，也同样会导致请求对应的 context cancel 掉。</p>
<p>　　服务端主动 cancel context 的好处在于可以快速释放资源，避免无效的请求继续执行（当然也得业务代码上主动去感知 context 是否 cancel，从而及时退出）；坏处在于，<strong>如果服务端需要上报这个请求发生的错误（一般在后置中间件中进行错误上报），这个时候上报错误的请求需要另外生成一个新的 context</strong>，绝不能直接使用现有的 context，因为已有的这个 context 已经 cancel 掉了，继续使用会导致上报错误的请求发送失败，达不到上报的目的。</p>
]]></content>
      <categories>
        <category>Problems</category>
      </categories>
      <tags>
        <tag>golang</tag>
        <tag>http</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo的SPFK主题修改小记</title>
    <url>/posts/b1e9411b.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　Shaun 一直在对 Hexo 的 SPFK 主题进行持续修改以符合 Shaun 自己的需求，在修改当中也会遇到一些小问题，以防遇到重复问题，特此记录所遇小问题，至于大问题可能会另外开篇。</p>
<span id="more"></span>
<h2 id="修改篇">修改篇</h2>
<h3 id="修改-aboutme-排版问题"><font color=#FA8072>1、修改 <strong>aboutme</strong> 排版问题</font></h3>
<p><strong><em>修改日期：2017-09-16</em></strong></p>
<p><strong>需求描述：</strong>Shaun 为了使 <strong>aboutme</strong> 排版好看一点，使“<strong>关于我</strong>”的内容更有段落感，Shaun 尝试在主题配置文件中 aboutme 对象的内容添加各种换行转义符号均于事无补，如 <code>\n</code>、<code>\r\n</code>、<code>&amp;#13;</code>、<code>&amp;#10;</code>、<code>&lt;br /&gt;</code> 等，站点不仅不会换行，还会直接将转义符号都显示出来 (╯﹏╰）。</p>
<p><strong>解决办法：</strong>既然 Shaun 基本把所有的换行方法都试过了，还没有任何作用，那就只能是问题出在其它地方了。Shaun 首先找到显示 aboutme 内容的地方，其位于主题文件夹下 <code>\layout\_partial\left-col.ejs</code>，显示 aboutme 内容的代码为 <code>&lt;div id="js-aboutme"&gt;&lt;%=theme.aboutme%&gt;&lt;/div&gt;</code>，查阅相关资料，具体为 <a href="https://cnodejs.org/topic/5711aec2238ae0ac1e3a6a26">与大家分享ejs源码阅读心得</a>，其中有这样一段话：</p>
<blockquote>
<p><h><strong>关于ejs模板的五种模式对应几种指令</strong></h></p>
<p><code>ejs</code>主要提供了如下几种指令:</p>
<ul>
<li><code>&lt;%</code>, 该指令主要通过js中的<code>eval</code>来执行js代码, 如上模板代码<code>&lt;% [1,2].forEach(function(v)&#123; %&gt;</code>将通过<code>eval</code>编译成<code>; [1,2].forEach(function(v)&#123;</code>即直接可执行的js代码, 并且不会存放到<code>__output</code>函数中输出.</li>
<li><strong><code>&lt;%=</code>, 该指令主要用于输出变量内容, 如上模板代码<code>&lt;%= v %&gt;</code>将通过<code>escape</code>函数编译成<code>__append(escape(v))</code>, 可以看到该指令用于输出变量内容, 最后将通过<code>__output</code>输出内容.</strong></li>
<li><strong><code>&lt;%-</code>, 该指令与<code>&lt;%=</code>区别是, <code>&lt;%=</code>指令使用<code>escape</code>函数来对特殊字符进行编码, 如将<code>&gt;</code>转为<code>%3E</code>, <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/escape">查看关于escape函数</a>.</strong></li>
<li><code>&lt;%#</code>, 该指令主要用于模板内注释, 既不会执行也不会输出.</li>
<li><code>&lt;%%</code>, 主要用于输出字面值<code>%</code>.</li>
</ul>
<p>关于以上各个指令对应的解析, 可参考<code>ejs</code>源码根目录<code>lib/ejs.js</code>文件中的<code>scanLine</code>函数.</p>
</blockquote>
<p>从中可得知 <code>&lt;%=</code> 指令会将变量内容中一些特殊字符先转义，再原封不动的输出，所以 Shaun 无论怎么修改主题配置文件中 aboutme 对象的值，其输出内容都会是原封不动的 aboutme 对象的值。为了让其输出内容可以有相应的特殊格式，就不能让其转义，只能用 <code>&lt;%-</code> 指令，将其修改为 <code>&lt;div id="js-aboutme"&gt;&lt;%-theme.aboutme%&gt;&lt;/div&gt;</code>，这样就能使输出内容可以自定义特殊格式，Shaun 最后在 aboutme 对象的内容中需要换行的地方添加了 <code>&lt;br /&gt;</code>，实测如此修改后可以换行。</p>
<h3 id="给左栏添加滚动条"><font color=#FA8072>2、给左栏添加滚动条</font></h3>
<p><strong><em>修改日期：2017-09-18</em></strong></p>
<p><strong>需求描述：</strong>SPFK 主题是双栏的主题。因为左栏主要是用来显示一些菜单和头像等内容，这些内容也不多，所以原作者就没有添加滚动条。但是由于 Shaun 添加了个本地搜索功能，在刚开始文章少的时候还不受影响，但是随着文章的增多，搜索功能就会影响左栏的布局，这是就必须添加一个滚动条了。本以为添加滚动条很简单，就是添加一个 <code>overflow: auto;</code>，谁知道还没这么简单 ╮(╯﹏╰）╭。</p>
<p><strong>解决办法：</strong>Shaun 对问题的定位没问题，就是修改主题文件夹下的 <code>\source\css\_partial\main.styl</code> 文件中 <em>.left-col</em> 样式，问题在于怎么修改，本想直接在其中加入 <code>overflow: auto;</code>，按道理说问题就能解决的，但是 Shaun 去搜索试试，发现搜索框上方的头像，文字等全部消失了，滚动条没起到作用，而下方的菜单可以通过滚动条看到。于是 Shaun 觉得可能是 div 上界没撑开，而超出的地方却隐藏了，但下界为什么能撑开，Shaun 这里还是很不明白 ?_?。既然是这里隐藏了，Shaun 就去看相关标签有没有 <code>overflow: hidden;</code> 属性，谁知道要么是没有，要么是即是关闭了也没有作用，那问题应该不是出在这里。就只能是这些元素所在的子 div 里了，Shaun 找到其子 div 属性 <em>.intrude-less</em>，其中虽有 overflow: auto; 但没设置 height 属性，所以就不能发挥其作用，Shaun 于是给它加上 height 属性，搜索后发现有两个滚动条，这显然不简约，于是 Shaun 把 <em>.intrude-less</em> 的 overflow: auto; 属性注释掉，没想到居然能完美解决问题，可能是因为加上高度属性之后就能撑大父元素 div 了吧（来自某业余前端的猜测 (⊙_⊙)）。后面为了更美观，Shaun 把下方菜单区域的 div 样式 <em>.switch-area</em> 高度 min-height 改小了一点，顺便也把主题文件夹下的 <code>\layout\_partial\left-col.ejs</code> 文件中首行注释掉 <code>&lt;!-- &lt;div class="overlay"&gt;&lt;/div&gt; --&gt;</code> 。Shaun 也曾想把 height 改为 min-height，谁知道又出现相同的问题，不得不又改回去。虽然这次已经解决了问题，但有些细节问题还是不太明白，只有等以后前端水平上去了再去想了，如有大佬知道还望不吝赐教 (^人^)。</p>
<h3 id="更换鼠标指针"><font color=#FA8072>3、更换鼠标指针</font></h3>
<p><strong><em>修改日期：2017-9-26 ~ 2017-9-27</em></strong></p>
<p><strong>需求描述：</strong>Shaun 在玩《<strong>Ori and the Blind Forest</strong>》这款游戏的时候觉得其鼠标指针很酷炫，于是想把其鼠标指针放在 Shaun 的博客站点中 (๑´ڡ`๑) 。</p>
<p><strong>解决办法：</strong>要想更改指针，首先需要找到对应的指针文件，最终在万能的贴吧得到指引，在 <a href="http://www.rw-designer.com/">RealWorld Graphics</a> 上找到两个 ori指针 文件，一个是 <a href="http://www.rw-designer.com/cursor-detail/100439">动态的</a> ani指针文件，还有一个是 <a href="http://www.rw-designer.com/cursor-detail/82454">静态的</a> cur指针文件（好像该游戏的作者也在 steam 上的评论中提供了游戏中的指针文件，详见：<a href="http://steamcommunity.com/app/261570/discussions/0/617330406652104214/">I wanna use this games cursor.</a> ）。既然已经找到了指针文件，就可以开始更换炫酷的鼠标指针 (•̀ᴗ•́)。具体更改方法如下：将下好的指针文件放在主题文件下的 <code>\source\img</code> 文件夹中，在主题配置文件中添加 cursor 属性：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="YAML"><div class="code-copy"></div><figure class="highlight hljs yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># set cursor | 设置鼠标指针图标</span></span><br><span class="line"><span class="attr">cursor:</span> </span><br><span class="line">  <span class="attr">on:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">cursor_0:</span> <span class="string">img/cursor.ani</span>  <span class="comment"># 首选指针 </span></span><br><span class="line">  <span class="attr">cursor_1:</span> <span class="string">img/cursor.cur</span>  <span class="comment"># 备选指针</span></span><br></pre></td></tr></table></figure></div>
<p>其中 cursor_0 和 cursor_1 代表使用哪个指针，因为 firefox 和 chrome 不支持 ani文件 的指针（好像是 ani 文件有很大的漏洞），所以 ani 动态指针是用不了的，只能用 cur 格式的静态指针，而 IE 是可以加载 ani 格式的动态指针，所以 Shaun 这里就将两个指针文件全放上去了，首选加载动态指针；最后增加相应的代码调用 cursor 属性，加载指针文件，在主题文件夹下 /layout/_partial/background.ejs 文件末尾添加：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="code"><pre><span class="line">&lt;% if (theme.cursor.on)&#123; %&gt;</span><br><span class="line">    &lt;style&gt;</span><br><span class="line">        body&#123;</span><br><span class="line">            background: #3f3f3f;</span><br><span class="line">            cursor: url(&lt;%- config.root %&gt;&lt;%- theme.cursor.cursor_0 %&gt;), url(&quot;&lt;%- config.root %&gt;&lt;%- theme.cursor.cursor_1 %&gt;&quot;), auto;</span><br><span class="line">        &#125;</span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">&lt;% &#125; %&gt;</span><br></pre></td></tr></table></figure></div>
<p>如此更新站点之后即可使用新鼠标指针样式，可能需要先进行 <code>hexo clean</code> 再发布。</p>
<p><strong>BTW：</strong>这次修改是一个月之前的了，当时不知怎么的忘记记录了，还好 Shaun 的 git 提交记录比较详细，对应的提交记录为：<a href="https://github.com/cniter/cniter.github.io/commit/6c4fb2ddb930f739e2040a2b440106d21aebff04">add a function -- change cursor</a>和<a href="https://github.com/cniter/cniter.github.io/commit/d24d6d4f3292d7719f292599e6eebd54761c15e5">update set cursor function</a> 。</p>
<h3 id="修改打赏问题"><font color=#FA8072>4、修改打赏问题</font></h3>
<p><strong><em>修改日期：2017-10-13</em></strong></p>
<p><strong>问题描述：</strong>Shaun 突然想玩一下那个打赏小东西，但照配置文件中指示的那样在文章开头 ymal 格式中加入 <code>reward: true</code> 属性，没有任何作用，于是去主题文件夹搜索 reward 属性相应的代码，结果是“找不到结果”（坑爹了这是，摔！（╯‵□′）╯︵┴─┴ ）。</p>
<p><strong>解决办法：</strong>既然 reward 属性找不到就只有搜索 reward_type 属性，最终在主题文件夹下 <code>\spfk_c\layout\_partial\article.ejs</code> 文件中找到这样一条语句 <code>&lt;% if ((theme.reward_type === 2 || (theme.reward_type === 1 &amp;&amp; post.toc)) &amp;&amp; !index)&#123; %&gt;</code>，其下面就是打赏相关的代码，查看 SPFK 主题原作者介绍信息（<a href="https://luuman.github.io/2015/12/27/Hexo/HexoTheme/">Hexo 主题：SPFK</a>）发现 toc 属性是用来显示目录的（一个用来打赏的代码怎么与文章目录相关了 -_-#），所以上面的 toc 应该改成 reward，修改后的代码为 <code>&lt;% if ((theme.reward_type === 2 || (theme.reward_type === 1 &amp;&amp; post.reward)) &amp;&amp; !index)&#123; %&gt;</code>，这时照配置文件中指示的那样在文章开头 ymal 格式中加入 <code>reward: true</code> 属性就能在相应的文章后面看到一个大大的“<strong>赏</strong>”字。</p>
<p>本来写到这里应该打赏这玩意应该完结了，但 Shaun 无意中在该文件的下面发现这样一段代码：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="code"><pre><span class="line">&lt;% if (!index &amp;&amp; post.toc != false &amp;&amp; !is_page())&#123; %&gt;</span><br><span class="line">    &lt;%- partial(&#x27;_partial/toc&#x27;) %&gt;</span><br><span class="line">&lt;% &#125; %&gt;</span><br></pre></td></tr></table></figure></div>
<p>这是和 toc（即文章目录）真正相关的代码，功能大概就是判断是否加载文章目录相关的代码，如果在文章开头设置 <code>toc: false</code>，则该文章不会显示目录，但是如果在文章中不加 toc 属性，也会显示文章目录，但上面的打赏却不会显示，看起来 <code>post.toc != false</code> 和 <code>post.toc</code> 应该逻辑差不多，这里是 Shaun 感到十分奇怪的一个地方？后面查阅相关资料（<a href="http://www.w3school.com.cn/jsref/jsref_undefined.asp">JavaScript undefined 属性</a>）得知:</p>
<blockquote>
<p>注释：null 表示无值，而 undefined 表示一个未声明的变量，或已声明但没有赋值的变量，或一个并不存在的对象属性。</p>
</blockquote>
<p>而本文这里因为没有在文章开头设置 toc 属性，所以其为 <code>undefined</code>，其既不为 false 也不为 true，只为 undefined，当在 <code>if</code> 语句中做判断，会执行 <code>else</code> 分支，作 <code>!</code> 运算，结果则为：<code>true</code>。所以 <code>if(post.toc)</code> 不能执行其下代码，因为 <code>post.toc</code> 为undefined，不为 true 也不为 false，而 <code>if(post.toc != false)</code> 能执行其下代码，因为 <code>post.toc != false</code> 为真。至于 javascript 中 <code>if(a == ture)</code> 和 <code>if(a)</code> 的区别具体为：前一种是 a 必须为 1 或者 true 才执行；而后一种只要 a 不为 <code>false undefined null 0 -0 NaN ""</code> 这 7 个字符中的其中任何一个都能执行。</p>
<h3 id="交换内容栏和左侧栏位置"><font color=#FA8072>5、交换内容栏和左侧栏位置</font></h3>
<p><strong><em>修改日期：2017-11-22 ~ 2017-11-23</em></strong></p>
<p><strong>需求描述：</strong>Shaun 最近逛网站时发现，好像一些博客网站基本都是把内容放在左侧，百度和 google 的搜索结果也是在左侧，可能是内容在左侧要好一点吧，于是 Shaun 略微修改之后，将内容放在左侧，而原来的左侧栏放到最右侧，好像是顺眼了一点（不排除是心理作用 (ಡωಡ)），如果以后还觉得不错的话，再把相关的变量名换掉吧（此次修改仅仅是将 CSS 相关的值改变，div 类名没变）。</p>
<p><strong>解决办法：</strong>首先当然是定位左侧栏 <code>.left-col</code>，它在主题文件夹下 source/css/_partial/main.styl 文件中，为其添加 <code>right: 0px;</code> 属性，使左侧栏靠右侧停放；在定位内容栏 <code>.mid-col</code> ，将 <code>right:0;</code> 改成 <code>left:0;</code>，将 <code>left: 300px;</code> 改成 <code>right: left-col-width;</code>，使内容栏靠左侧停放，同时使其距离右侧有左侧栏的宽度。最后就是再修改其他一些小东西（比如目录按钮和目录内容 div 等）的 css 值，关于这个 Shaun 就不细述了，反正也就是更改 left、right、bottom 以及 top 属性及其值，具体修改了哪些内容可以见 Shaun github 提交记录。</p>
<p><strong>BTW：</strong>诶呀呀！昨天忘记测试手机端，今天用手机打开一看，手机端页面也距右边 left-col-width 宽度，这使得内容全挤在一起了，完全没法看 ರ_ರ ...。所以不得不添加手机端样式，定位手机端 .mid-col，它在主题文件夹下 /source/css/_partial/mobile.styl 文件中，为其添加 <code>right: 0;</code> 属性值；后面看见回到顶部、回到底部的导航栏也有点问题，就在该文件中 <code>/*导航*/</code> 下面 <code>.scroll</code> 上面添加：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="CSS"><div class="code-copy"></div><figure class="highlight hljs css"><table><tr><td class="code"><pre><span class="line"><span class="selector-id">#scroll</span>&#123;</span><br><span class="line">    <span class="attribute">right</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>使得该导航栏靠右停靠。</p>
<h3 id="更新站点部分-css-文件和代码结构"><font color=#FA8072>6、更新站点部分 CSS 文件和代码结构</font></h3>
<p><strong><em>修改日期：2017-12-04 ~ 2017-12-06</em></strong></p>
<p><strong>更新日志：</strong></p>
<ol type="1">
<li><p>Shaun 将 left-col 相关的东西（比如 css 样式和 ejs 文件）全部重名为 right-col，毕竟经过几天的适应，感觉放在右侧还不错，就干脆也将其重命名算了，所以原左侧栏 left-col 从现在开始就完全变成右侧栏 right-col 了；</p></li>
<li><p>原来的本地搜索框有两个 .search 样式，本次修改将两个 .search 样式合并了，删除重复的样式，只留下一个合并后的 .search 样式；Shaun 同时还优化了一下本地搜索功能的结构，将原来主题配置文件中的 search_box 属性删掉，给 search 属性添加一个 on 的属性来代替 search_box 属性，这样让结构不那么混乱，只由一个 search 属性决定本地搜索功能的开启和关闭及功能的实现，而不是像以前那样由 search_box 属性决定右侧栏搜索框的显示，而 search 属性决定本地搜索功能的实现；</p></li>
<li><p>更改右侧栏 right-col 的 overflow 样式，原来是右侧栏 right-col 垂直超出滚动，水平超出隐藏，这样在屏幕比较窄的情况在右侧会出现两条滚动条，很不美观。现在 Shaun 将 overflow 样式改成 <code>&amp;:hover &#123;overflow-y: auto; overflow-x: hidden;&#125;</code> ，这样只有在鼠标指针悬浮在右侧栏 right-col 上时才会再右侧栏出现滚动条，这样虽然不能从根本上解决问题，但稍微缓解了一下，等以后再看能不能彻底解决滚动条的问题 ರ_ರ ...；</p></li>
<li><p>Shaun 以前添加 RevolverMaps 这个小部件的时候只是简单粗暴的添加 div 及对应的样式，完全没考虑到主题的扩展性和易修改性。于是 Shaun 将其改成配置文件的形式，在主题配置文件中添加 <code>visual_visitor</code> 属性，只要将其值设置为 <a href="http://www.revolvermaps.com/">RevolverMaps官网</a> 获取的那串 script code，eg：</p>
<p><code>&lt;script type="text/javascript" src="//ra.revolvermaps.com/0/0/8.js?i=0lpycb5p234&amp;amp;m=7&amp;amp;c=ff0000&amp;amp;cr1=ffffff&amp;amp;f=arial&amp;amp;l=49" async="async"&gt;&lt;/script&gt;</code>，即可在右侧栏菜单下的访问情况中看到一个 3D 地球实时显示访客的位置信息，Shaun 为了优化异步访问信息，将其中的 <code>async="async"</code> 改成 <code>defer="defer"</code>，这样好像能优化加载次序。这两者的区别可参考 <a href="https://segmentfault.com/q/1010000000640869">defer和async的区别</a>，好像是都能异步加载，只是 async 是该 script 加载完立即执行，而 defer 是该 script 加载完之后在整个页面结束加载之前执行，也就是最后执行的；</p></li>
<li><p>最后还修改了 MathJax 的 CDN 地址及配置属性。MathJax 的配置属性可参考 <a href="http://mathjax-chinese-doc.readthedocs.io/en/latest/configuration.html#id3">加载和配置MathJax</a>，具体如下：</p>
<blockquote>
<p>第一种配置Mahtjax的方法就是使用配置文件。MathJax附带了很多种预制配置文件。它们存储在<code>MathJax/config</code> 目录。主要有其中以下几个：</p>
<ul>
<li><code>default.js</code>：这个文件包含了所有MathJax可用的配置选项，并附有注释和说明，你可以编辑它们来满足你的需要。</li>
<li><code>TeX-AMS-MML_HTMLorMML.js</code>：允许使用 <a href="http://mathjax-chinese-doc.readthedocs.io/en/latest/glossary.html#term-tex"><em>TeX</em></a>, <a href="http://mathjax-chinese-doc.readthedocs.io/en/latest/glossary.html#term-latex"><em>LaTeX</em></a>, 或者<a href="http://mathjax-chinese-doc.readthedocs.io/en/latest/glossary.html#term-mathml"><em>MathML</em></a> 符号书写公式。如果浏览器支持就处理为MathML，否则就使用Html和Css渲染。</li>
<li><code>TeX-AMS_HTML.js</code>：允许使用 <a href="http://mathjax-chinese-doc.readthedocs.io/en/latest/glossary.html#term-tex"><em>TeX</em></a> 或者 <a href="http://mathjax-chinese-doc.readthedocs.io/en/latest/glossary.html#term-latex"><em>LaTeX</em></a> 符号书写公式。使用Html和Css渲染。</li>
<li><code>MML_HTMLorMML.js</code>：允许使用 <a href="http://mathjax-chinese-doc.readthedocs.io/en/latest/glossary.html#term-mathml"><em>MathML</em></a> 符号书写公式。如果浏览器支持就处理为MathML，否则就使用Html和Css渲染。</li>
<li><code>AM_HTMLorMML.js</code>：允许使用 <a href="http://mathjax-chinese-doc.readthedocs.io/en/latest/glossary.html#term-asciimath"><em>AsciiMath</em></a> 符号书写。如果浏览器支持就处理为MathML，否则就使用Html和Css渲染。</li>
<li><code>TeX-AMS-MML_SVG.js</code>：允许使用 <a href="http://mathjax-chinese-doc.readthedocs.io/en/latest/glossary.html#term-tex"><em>TeX</em></a>, <a href="http://mathjax-chinese-doc.readthedocs.io/en/latest/glossary.html#term-latex"><em>LaTeX</em></a>, 或者<a href="http://mathjax-chinese-doc.readthedocs.io/en/latest/glossary.html#term-mathml"><em>MathML</em></a> 符号书写公式。使用SVG产生输出。</li>
<li><code>TeX-MML-AM_HTMLorMML.js</code>：允许使用 <a href="http://mathjax-chinese-doc.readthedocs.io/en/latest/glossary.html#term-tex"><em>TeX</em></a>, <a href="http://mathjax-chinese-doc.readthedocs.io/en/latest/glossary.html#term-latex"><em>LaTeX</em></a>,<a href="http://mathjax-chinese-doc.readthedocs.io/en/latest/glossary.html#term-mathml"><em>MathML</em></a>,或者 <a href="http://mathjax-chinese-doc.readthedocs.io/en/latest/glossary.html#term-asciimath"><em>AsciiMath</em></a> 符号书写公式。如果浏览器支持就处理为MathML，否则就使用Html和Css渲染。</li>
</ul>
<p>第一个文件是提供给你修改的。它基本上包含了MathJax的所有配置选项，同时有注释解释。其他的文件就是我们联合配置文件。它们不仅仅配置Mathjax,还预加载了一些配置所需的文件。这些文件内容在 <a href="http://mathjax-chinese-doc.readthedocs.io/en/latest/common-configurations">联合配置</a> 中有详细的解释。</p>
</blockquote>
<p>原来的 CDN 地址 <strong><em>cdn.mathjax.org</em></strong> 已经在 2017-04-30 日关闭，所以必须更新 CDN 地址，其推荐的 CDN 地址为 <strong><em>cdnjs.cloudflare.com/ajax/libs/mathjax</em></strong>，而新的 MathJax 也提供一种一种新的配置文件 <code>TeX-MML-AM_CHTML</code>（允许使用 <a href="http://mathjax-chinese-doc.readthedocs.io/en/latest/glossary.html#term-tex"><em>TeX</em></a>, <a href="http://mathjax-chinese-doc.readthedocs.io/en/latest/glossary.html#term-latex"><em>LaTeX</em></a>,<a href="http://mathjax-chinese-doc.readthedocs.io/en/latest/glossary.html#term-mathml"><em>MathML</em></a>或者 <a href="http://mathjax-chinese-doc.readthedocs.io/en/latest/glossary.html#term-asciimath"><em>AsciiMath</em></a> 符号书写公式，使用 CommonHTML 产生输出），新的 MathJax 推荐使用的就是这种配置文件，因为它计划在 V3.0 将 HTML-CSS 输出格式丢弃，只留下 CommonHTML 和 SVG 这两种输出格式。而且新的 CDN 地址不支持 <code>/latest/MathJax.js</code> 这种格式，必须指定一个确定的版本，截止 Shaun 此次修改日期之前，最新的版本为 2.7.2，所以比较推荐的一种加载格式为：</p>
<p><code>&lt;script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"&gt;&lt;/script&gt;</code> 。</p></li>
</ol>
<h3 id="添加-404-页面和一些插件等"><font color=#FA8072>7、添加 404 页面和一些插件等</font></h3>
<p><strong><em>修改日期：2017-12-09 ~ 2017-12-10</em></strong></p>
<p><strong>更新日志：</strong></p>
<ol type="1">
<li><p>修改文章内 a 标签的高度，即 .article-entry p a 中 padding 的上下边距。文章内的 a 标签在外面加个虚线框本来就很突出了，还设置上下 padding 为 8px，这就显得有点浮夸了 :) 。最后将其上下边距设为 0px；</p></li>
<li><p>添加 404 页面，具体参考自：<a href="http://moxfive.xyz/2015/10/16/hexo-404-page/">在 Hexo 中创建匹配主题的404页面</a>，</p>
<blockquote>
<blockquote>
<ol type="1">
<li>启动 Git Bash，进入 Hexo 所在文件夹，输入 <code>hexo new page 404</code> ；</li>
<li>打开刚新建的页面文件，默认在 Hexo 文件夹根目录下 <code>/source/404/index.md</code>；</li>
<li>在顶部插入一行，写上<code>permalink: /404</code>，这表示指定该页固定链接为 <code>http://"主页"/404.html</code></li>
</ol>
</blockquote>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="YAML"><div class="code-copy"></div><figure class="highlight hljs yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">title:</span> <span class="number">404</span> <span class="string">Not</span> <span class="string">Found：该页面无法显示</span></span><br><span class="line"><span class="attr">toc:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">comments:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">permalink:</span> <span class="string">/404</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure></div>
</blockquote></li>
<li><p>添加 hexo-abbrlink 插件，使文章生成唯一永久链接。这个插件最好是在建站之初就加上，不然写了很多文章之后又都得重新生成链接，搜索引擎需要再次抓取新链接，不利于 SEO，Shaun 这里也就只有等 Google 慢慢抓取更新，还好写的不多，不算太迟。安装完之后 Shaun 在站点配置文件中添加：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="YAML"><div class="code-copy"></div><figure class="highlight hljs yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">permalink:</span> <span class="string">posts/:abbrlink.html</span> <span class="comment"># 需安装hexo-abbrlink插件</span></span><br><span class="line"><span class="attr">abbrlink:</span></span><br><span class="line">  <span class="attr">alg:</span> <span class="string">crc32</span>  <span class="comment"># 算法：crc16(default) and crc32</span></span><br><span class="line">  <span class="attr">rep:</span> <span class="string">hex</span>    <span class="comment"># 进制：dec(default) and hex</span></span><br></pre></td></tr></table></figure></div>
<p><strong><em>※BTW：</em></strong>需要将原来的 permalink 注释掉或直接删除。</p>
<p>更多设置可参考 <a href="https://github.com/rozbo/hexo-abbrlink"><strong>hexo-abbrlink</strong></a> 。</p></li>
<li><p>添加 hexo-all-minifier 插件，快速压缩代码，分别对 html、css、js、images 进行优化。Shaun 这里就直接使用推荐的配置了，直接在站点配置文件中添加：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="YAML"><div class="code-copy"></div><figure class="highlight hljs yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">all_minifier:</span> <span class="literal">true</span>  <span class="comment"># 需安装hexo-all-minifier插件</span></span><br></pre></td></tr></table></figure></div>
<p>更多设置可参考 <a href="https://github.com/chenzhutian/hexo-all-minifier"><strong>hexo-all-minifier</strong></a> 。</p></li>
<li><p>原来文章标题不可点击，反而日期可点击，这有点奇怪 ◔ ‸◔?。本次修改之后，点击文章标题即为刷新页面。</p></li>
</ol>
<h4 id="更新日期2017-12-19-2017-12-19"><strong><em>更新日期：2017-12-19 ~ 2017-12-19</em></strong></h4>
<p><strong>具体修改内容：</strong>主要更新了 404 页面上面的动图，个人偏好喜欢一些星系漩涡之内的动图，偶然发现这个东西（<a href="http://www.jb51.net/jiaoben/576717.html">HTML5+Three.js实现的3D可拖拽银河星系旋转动画特效源码</a>），于是将它的源码略作修改放进 Shaun 的 404 页面，将相关的 js 文件放入主题文件夹中 <code>\source\js</code> 文件夹里，最初时是将相关 js 文件引入路径当成相对路径引入，没想到这样造成有的 404 页面会显示旋转动图，而有的 404 页面则不会显示，后面参考网上资料（<a href="https://segmentfault.com/a/1190000007491687">解惑页面中的相对路径和绝对路径</a>）了解到：</p>
<blockquote>
<ol type="1">
<li><code>html</code> 中引入的资源（包括<code>js</code>、<code>css</code>、<code>img</code>）
<ul>
<li>相对路径：相对的是 <strong>网页本身的 URL</strong> ；</li>
<li>绝对路径：相对的是 <strong>网页 URL 的根路径</strong> ；</li>
</ul></li>
<li><code>css</code> 中引入的资源
<ul>
<li>相对路径：相对的是 <strong>css 文件本身的 URL</strong> ；</li>
<li>绝对路径：相对的是 <strong>网页 URL 的根路径</strong>；</li>
</ul></li>
</ol>
<p><strong>结论：</strong> <code>html</code> 中引入资源的相对路径与 <strong>网页的 URL </strong>有关，而<code>css</code>中则与 <strong>css 资源本身 URL </strong>有关。但使用绝对路径时，不管是在 <code>html</code>中，还是<code>css</code>中，都只与 <strong>网页 URL的根路径</strong>有关。</p>
</blockquote>
<p>将相对路径改为绝对路径，即可在 Shaun 博客域名下所有 404 页面正常显示旋转动图。</p>
<h3 id="添加-gitalk-评论系统"><font color=#FA8072>8、添加 Gitalk 评论系统</font></h3>
<p><strong><em>修改日期：2017-12-16</em></strong></p>
<p>　　Gitalk 是一款类似 gitment 的评论系统，Shaun 先是照着它提供的配置添加之后，发现居然与 spfk 主题中的 require-2.1.6,jquery-1.9.1.min.js 冲突，显示不了 Gitalk，Shaun 以为是 bug，所以就去提了个 <a href="https://github.com/gitalk/gitalk/issues/80">issue</a>，作者 <strong>booxood</strong> 还是挺认真负责的（°Д°）Ъ，耐心的解决 Shaun 的问题，原来是 Shaun 的引用方式有问题，需要用 require 方式引用，大佬就是大佬 <strong>○|￣|_</strong>，小白还是小白，萌新完全没见过还有这种操作，也算是开眼界了 ✪ω✪。由于大佬解决完问题之后就直接把 issue 关闭了，所以 Shaun 就只有在这里表示感谢了 /つ∇T)。Shaun 最后添加 gitalk 的 ejs 代码如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="code"><pre><span class="line">&lt;div id=&quot;comments&quot; class=&quot;gitalk&quot;&gt;</span><br><span class="line">    &lt;div id=&quot;gitalk-container&quot; class=&quot;article article-inner article-entry&quot;&gt;&lt;/div&gt;</span><br><span class="line">    &lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">        require([&#x27;https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js&#x27;], function (Gitalk) &#123;</span><br><span class="line">            var gitalk = new Gitalk(&#123;</span><br><span class="line">                clientID: &#x27;&lt;%= theme.gitalk.client_id%&gt;&#x27;,</span><br><span class="line">                clientSecret: &#x27;&lt;%= theme.gitalk.client_secret%&gt;&#x27;,</span><br><span class="line">                id: window.location.pathname,</span><br><span class="line">                repo: &#x27;&lt;%= theme.gitalk.repo%&gt;&#x27;,</span><br><span class="line">                owner: &#x27;&lt;%= theme.gitalk.owner%&gt;&#x27;,</span><br><span class="line">                admin: &#x27;&lt;%= theme.gitalk.admin%&gt;&#x27;,</span><br><span class="line">                // facebook-like distraction free mode</span><br><span class="line">                distractionFreeMode: true</span><br><span class="line">            &#125;)</span><br><span class="line">            gitalk.render(&#x27;gitalk-container&#x27;)</span><br><span class="line">        &#125;) </span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure></div>
<p>还有其它的一些修改也是仿照 gitment 的代码添加的，我这上面没有添加 css 文件是因为 gitalk 原有的 css 文件与 Shaun 的主题不相符，所以就稍微修改了一下。</p>
<p><strong>※BTW：</strong>上次修改文章内a标签的高度后突然发现打赏的“<strong>赏</strong>”字背景圆形变成椭圆了 o(╯□╰)o，后面发现原来它也继承文章内 a 标签的属性，没有自己的 padding，后面只有给 <code>.dashang</code> 添加个独立的 <code>padding: 8px;</code>。</p>
<h3 id="fix-bugs"><font color=#FA8072>9、Fix Bugs</font></h3>
<h4 id="修改日期2017-12-20"><strong><em>修改日期：2017-12-20</em></strong></h4>
<p><strong>修复bug：</strong>鼠标悬浮 a 标签之上会出现显示 a 标签 title 内容的气泡，当 title 内容过多时，会造成气泡位置下调，从而遮住相应 a 标签内容的 bug。</p>
<p><strong>解决方案为：</strong>定位气泡文件为主题文件夹下 <code>\layout\_partial\post\TipTitle.ejs</code> 文件，将其中气泡出现的位置改变，原来气泡的位置确定由 top 和 left 决定，现改为 bottom 和 left，毕竟气泡是出现在 a 标签上方，如果将 top 确定，则 title 内容过多时，其只能向下扩张，造成气泡位置下移现象，从而遮住原来的 a 标签内容，改为 bottom 确定之后，气泡只会向上扩张，气泡位置相对稳定，不会遮住原来的 a 标签内容。具体修改内容为，将 <code>top: offset.top - a.outerHeight() - 15</code> 替换为 <code>bottom: window.innerHeight - offset.top + 10</code> ，其它内容保持不变。</p>
<h4 id="修改日期2017-12-26"><strong><em>修改日期：2017-12-26</em></strong></h4>
<p><strong>BUG描述：</strong>由于 spfk 主题启用的是百度分享，而原作者没有为其添加邮件分享，Shaun 为了好玩就添加个邮件分享，但是在添加过程中，Shaun 发现了个 BUG，就是为其添加的 title 属性没有作用，它会自动更改 title 内容，而 spfk 主题有显示 title 的气泡 TipTitle，所以不需要用默认的东西显示 title 内容，但是，这个百度分享还是强制默认显示，TipTitle 并不能消除其 title 内容。</p>
<p><strong>解决方案：</strong>定位百度分享强制添加 title 的代码，其位于主题文件夹下<code>\source\static\api\js\view\share_view.js</code> 中，具体代码如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="JAVASCRIPT"><div class="code-copy"></div><figure class="highlight hljs javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> i=e.partners,s=i[n]?<span class="string">&quot;\u5206\u4eab\u5230&quot;</span>+i[n].name:<span class="string">&quot;&quot;</span>;</span><br><span class="line">  !r(t).attr(<span class="string">&quot;title&quot;</span>)&amp;&amp;s&amp;&amp;r(t).attr(<span class="string">&quot;title&quot;</span>,s)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>因为 TipTitle 会首先将 title 去掉，所以这里会强制添加百度分享自己的 title，所以需要将其注释掉，具体注释代码为：<code>/*&amp;&amp;r(t).attr("title",s)*/</code>。本来这样就可以了，但是 Shaun 发现添加邮件分享之后，布局又不对，所以定位主题文件夹下 <code>\source\css\_partial\baidushare.styl</code> 文件，发现它的居中布局居然是有宽度决定的，于是 Shaun 为其添加 <code>text-align: center;</code> 谁知还是没变，不能自动居中，后来在主题文件夹下找到 <code>\source\static\api\css\share_style2_24.css</code> 文件，发现 .bdshare-button-style2-24 a 设置了浮动样式，难怪（⊙﹏⊙），最后将其注释掉就能自动居中了。最后还需要更改移动端 <code>\source\css\_partial\mobile.styl</code> 中 .bdshare-button-style2-24 的样式设置为自动居中就可以了。</p>
<h3 id="使文章目录可折叠"><font color=#FA8072>10、使文章目录可折叠</font></h3>
<p><strong><em>修改日期：2017-12-28</em></strong></p>
<p>首先声明，本次修改完全参考：<a href="http://moxfive.xyz/2016/06/13/hexo-collapsible-toc/">为 Hexo 添加可折叠的文章目录</a>，所用代码也来自其文（Shaun 只是做了点微不足道的修改），在此表示感谢 <a href="https://github.com/MOxFIVE/hexo-theme-yelee/">Yelee</a> 主题的作者 <a href="http://moxfive.xyz/">MOxFIVE</a> 👍 。</p>
<p>具体修改如下：首先在主题文件夹下 <code>\layout\_partial\toc.ejs</code> 中添加 js 代码：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!-- 折叠目录 --&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">    // -------------添加小图标--------------</span><br><span class="line">    var $itemHasChild = $(&quot;#toc .toc-item:has(&gt; .toc-child)&quot;);</span><br><span class="line">    var $titleHasChild = $itemHasChild.children(&quot;.toc-link&quot;);</span><br><span class="line">    $itemHasChild.prepend(&quot;&lt;i class=&#x27;fa fa-caret-down&#x27;&gt;&lt;/i&gt;&lt;i class=&#x27;fa fa-caret-right&#x27;&gt;&lt;/i&gt;&quot;);</span><br><span class="line"></span><br><span class="line">    var $iconToFold = $(&quot;.toc-item &gt; .fa-caret-down&quot;);</span><br><span class="line">    var $iconToExpand = $(&quot;.toc-item &gt; .fa-caret-right&quot;);</span><br><span class="line">    $iconToExpand.addClass(&quot;hide&quot;);</span><br><span class="line"></span><br><span class="line">    // --------------点击小图标--------------</span><br><span class="line">    var clickIcon = function () &#123;</span><br><span class="line">        $(&quot;#toc .toc-item &gt; i&quot;).click(function () &#123;</span><br><span class="line">            $(this).siblings(&quot;.toc-child&quot;).slideToggle(100);</span><br><span class="line">            $(this).toggleClass(&quot;hide&quot;);</span><br><span class="line">            $(this).siblings(&quot;i&quot;).toggleClass(&quot;hide&quot;);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    // 默认展开目录，所以隐藏掉表示“目录已展开”的图标（向下的小三角）</span><br><span class="line">    var $iconToFold = $(&quot;.toc-item &gt; .fa-caret-down&quot;);</span><br><span class="line">    $iconToExpand.addClass(&quot;hide&quot;);</span><br><span class="line"></span><br><span class="line">    // ------------点击大标题-----------------</span><br><span class="line">    var clickTitle = function () &#123;</span><br><span class="line">        $titleHasChild.dblclick(function () &#123;</span><br><span class="line">            $(this).siblings(&quot;.toc-child&quot;).hide(100);</span><br><span class="line">            $(this).siblings(&quot;i&quot;).toggleClass(&quot;hide&quot;);</span><br><span class="line">        &#125;)</span><br><span class="line">        // After dblclick enent</span><br><span class="line">        $titleHasChild.click(function () &#123;</span><br><span class="line">            var $curentTocChild = $(this).siblings(&quot;.toc-child&quot;);</span><br><span class="line">            if ($curentTocChild.is(&quot;:hidden&quot;)) &#123;</span><br><span class="line">                $curentTocChild.show(100);</span><br><span class="line">                $(this).siblings(&quot;i&quot;).toggleClass(&quot;hide&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    // ---------点击总标题-----------------</span><br><span class="line">    var clickTocTitle = function () &#123;</span><br><span class="line">        var $iconToExpand = $(&quot;.toc-item &gt; .fa-caret-right&quot;);</span><br><span class="line">        var $iconToFold = $(&quot;.toc-item &gt; .fa-caret-down&quot;);</span><br><span class="line">        var $subToc = $titleHasChild.next(&quot;.toc-child&quot;);</span><br><span class="line"></span><br><span class="line">        var $tocTitle = $(&quot;#toc .toc-title&quot;);</span><br><span class="line"></span><br><span class="line">        // 当包含多级目录时再执行</span><br><span class="line">        if ($titleHasChild.length) &#123;</span><br><span class="line">            $tocTitle.addClass(&quot;clickable&quot;);</span><br><span class="line">            $tocTitle.click(function () &#123;</span><br><span class="line">                if ($subToc.is(&quot;:hidden&quot;)) &#123;</span><br><span class="line">                    $subToc.show(150);</span><br><span class="line">                    $iconToExpand.removeClass(&quot;hide&quot;);</span><br><span class="line">                    $iconToFold.addClass(&quot;hide&quot;);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    $subToc.hide(100);</span><br><span class="line">                    $iconToExpand.addClass(&quot;hide&quot;);</span><br><span class="line">                    $iconToFold.removeClass(&quot;hide&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></div>
<p>然后添加相应的 css 样式，在主题文件夹下 <code>\source\css\_partial\article.styl</code> 中 <strong>#toc</strong> 样式里添加 css 样式：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SCSS"><div class="code-copy"></div><figure class="highlight hljs scss"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">ol</span><span class="selector-class">.toc</span> <span class="selector-tag">li</span><span class="selector-class">.toc-item</span> <span class="selector-tag">i</span> &#123;</span><br><span class="line">   <span class="attribute">display</span>: inline-block;</span><br><span class="line">   <span class="attribute">margin-left</span>: -<span class="number">0.9em</span>;</span><br><span class="line">   <span class="attribute">width</span>: <span class="number">0.9em</span>;</span><br><span class="line">   <span class="attribute">color</span>: <span class="number">#b3b3b3</span>;</span><br><span class="line">   <span class="attribute">font-weight</span>: bold;</span><br><span class="line">   <span class="attribute">cursor</span>: pointer;</span><br><span class="line"></span><br><span class="line">   &amp;<span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">       <span class="attribute">color</span>: <span class="number">#000</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   &amp;<span class="selector-class">.hide</span> &#123;</span><br><span class="line">       <span class="attribute">display</span>: none;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;  </span><br><span class="line"><span class="selector-class">.toc-title</span><span class="selector-class">.clickable</span> &#123;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line"></span><br><span class="line">    &amp;<span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">        <span class="attribute">color</span>: <span class="number">#88acdb</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    &amp;<span class="selector-pseudo">:active</span> &#123;</span><br><span class="line">        <span class="attribute">color</span>: <span class="number">#d3d3d3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>以上两步做完之后，点击目录前的小三角符号或双击目录名就能折叠相应目录，点击“<strong>文章目录</strong>”就能折叠所有目录。</p>
<hr />
<p>待续。。。</p>
<h2 id="后记">后记</h2>
<p>　　先就写到这里，如后续修改中发现问题再继续记录吧 ↖(^ω^)↗。</p>
]]></content>
      <categories>
        <category>建站小记</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>IDEA使用Docker环境开发调试</title>
    <url>/posts/3692cd6.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　IDEA 以前基本没用过，只是简单用过 Android Studio，还基本都忘记了 ( ╯□╰ )，以后应该会用 Scala 做一些大数据方面的东西，而大数据的环境都是 Linux 下的，而 Shaun 日常都是在 Windows 下开发，所以需要用日前做的容器环境来测试调试运行程序，简单记录一下 IDEA 在这方面的使用方法。</p>
<span id="more"></span>
<h2 id="运行篇">运行篇</h2>
<p>　　右键项目名（HelloWorld），新建文件（New =》File），指定文件名为 <code>Dockerfile</code> 。写入内容示例如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="DOCKERFILE"><div class="code-copy"></div><figure class="highlight hljs dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> stc:<span class="number">2.0</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> ./target/classes/ /tmp</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /tmp</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">&quot;scala&quot;</span>,<span class="string">&quot;HelloWorld&quot;</span>]</span></span><br></pre></td></tr></table></figure></div>
<p>点击左上角绿色双箭头，可编辑 Dockerfile（Edit 'Dockerfile'） ，指定当前上下文目录（Context folder），Contaier name 等容器启动选项。直接运行 Dockerfile（Run 'Dockerfile'），IDEA 即可自动创建容器，并在容器中运行程序，程序运行完则容器自动停止，若需要运行存在外部依赖的程序，则只能以 jar 包的方式运行。</p>
<p>　　设置 IDEA 生成 jar 包如下：在最上面的菜单栏中 File =》Project Structure =》Artifacts =》+ =》JAR =》From modules with dependencies，选择 Main Class，点击右边的文件夹图标即可选择相应类，由于存在外部依赖，所以不能直接用默认的 extract to the target JAR，而是应该选择下面的 <strong>copy to the output directory and link via manifest</strong>，点击 OK 后，自动或手动选择导出的依赖 jar 包，点击 OK。在最上面的菜单栏中 Build =》Build Artifacts...，可在 out/artifacts/HelloWorld_jar 文件夹中生成所有 jar 包。之后编辑 Dockerfile， <strong>更改 Dockerfile 上下文目录</strong>为 out/artifacts/HelloWorld_jar ，指定容器名，在 Command 中输入 <code>java -jar HelloWorld.jar</code> 修改 Dockerfile 中第 2 行命令为 <code>COPY . /tmp</code>，修改第 4 行命令为 <code>CMD ["java", "-jar", "HelloWorld.jar"]</code>。之后运行 Dockerfile 即可在下面 Services 栏对应 Docker 容器 Attached Console 中看到程序运行结果。</p>
<h2 id="调试篇">调试篇</h2>
<p>　　除了使用 IDEA 生成 jar 包外，还需要使用 IDEA 的远程调试功能，设置 IDEA 远程调试功能如下：在最上面的菜单栏中 Run =》Edit Configurations... =》+ =》Remote JVM Debug，上方的 Debugger mode 中使用默认的 Attach to remote JVM， 在下面的 Before launch 添加 Launch Docker before debug。在弹窗中选择相应 Dockerfile，在下方的 Custom command 中输入 <code>java -agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=5005 -jar HelloWorld.jar</code>， 完成后即可使用该配置在 IDEA 调试容器中运行的程序。</p>
<h2 id="后记">后记</h2>
<p>　　用这种方式使用 IDEA 确实达到了 Shaun 理想的结果，Windows 下开发，Docker 中调试和运行，应付简单的代码调试和运行确实是没问题，但是在复杂的分布式环境下总会碰到一些莫名奇妙的问题，这些问题就是纯粹的经验了。</p>
<h2 id="参考资料">参考资料</h2>
<p><a href="https://www.jetbrains.com/help/idea/supported-languages.html/running-a-java-app-in-a-container.html">Run a Java application in a Docker container</a></p>
<p><a href="https://www.jetbrains.com/help/idea/supported-languages.html/debug-a-java-application-using-a-dockerfile.html#create-dockerfile-run-config">Debug a Java application using a Dockerfile</a></p>
]]></content>
      <categories>
        <category>Study</category>
      </categories>
      <tags>
        <tag>devtool</tag>
      </tags>
  </entry>
  <entry>
    <title>K8S 应用开发指北</title>
    <url>/posts/55e674ff.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　在周志明的『凤凰架构』中需要思考这样一个问题，如何用不可靠的部件来构造一个可靠的系统？对于程序员来说，写的代码从某种程度上来说都是不可靠的，但这些代码组成的一些系统却可以是可靠的。程序员对于错误的处理可以分为两派，一派是必须对错误进行处理，以保证系统的稳定行；另一派不对错误进行处理，任由程序 crash，只要有兜底方案，后面再不断完善。这两派并无孰优孰劣，只是两种不同的思维方式，甚至在同一个程序中，有些错误会处理，有些错误不会处理，这都是可能的。K8S 作为事实上的云原生操作系统，其目的就是为了将程序员写的各个程序组装成一个稳定的系统，并减少运维成本。</p>
<span id="more"></span>
<h2 id="基础篇">基础篇</h2>
<p>　　K8S 调度的基本单元是 Pod，Pod 也是 K8S 自带的一个资源对象，其可以简单理解为是一个容器集合体，程序员可控的容器有两类（Pause 容器除外），一类是 InitContainer，另一类是普通业务容器，InitContainer 按数组顺序创建，顺序执行，若一个失败，则整个 Pod 创建失败，普通业务容器同样按数组顺序创建，但异步执行，所以执行顺序不可控（可以通过 postStart Hook 简单控制一下）。由于 InitContainer 先于 Pod 其他容器执行，所以一般用来做普通业务容器执行前置条件的一些事情，比如：下载文件，初始化配置，状态消息通知等。</p>
<p>　　同一 Pod 中存储卷和网络可以共享。存储卷共享是指 Pod 内各容器可以挂载相同存储卷，从而数据共享。K8S 目前支持的存储卷共有三种：第一种是 emptyDir，这种存储是临时的，只能在 Pod 内使用，当 Pod 被销毁时，该存储的内容也会消失，只能在同一 Pod 内共享数据；第二种是 hostPath，这种存储会直接和集群中物理机存储相关联，是一种跨 Pod 持久化存储，但仅限该物理机，当 pod 被调度到其他物理机时就无法实现跨 Pod 共享数据；最后一种是外部存储（NFS，Ceph，GlusterFS，AWS EBS 等），这种方式可以真正实现数据持久化并共享，而且可以支持存储与计算分离，对系统会更友好一些，当然运维的成本也会更大。当然除了 K8S 自身提供的存储卷挂载可以实现数据共享，从程序的角度上，使用传统的方式一样也能数据共享，如数据库，DFS，OSS 等。</p>
<p>　　而网络共享是指 Pod 内各容器直接可以使用 localhost 以及容器暴露的端口进行相互通信，K8S 的端口有三种，分别为：容器端口（containerPort，容器中对外暴露的端口），集群内端口（port，集群内 pod 相互通信的端口），集群外端口（nodePort，集群外请求集群内的端口），其中容器端口和集群内是正常的动态端口，取值范围为 [1024, 65535]，集群外端口只能设置为 [30000, 32767]，若集群中服务不与集群外通信，则只需要设置集群内端口就行。K8S 中 IP 也同样有三种，分别为：Pod IP（两不同 Pod 资源对象相互通信的地址，集群外不可访问），Cluster IP（Service 资源对象的通信地址，集群外不可访问），Node IP（K8S 物理节点的 IP 地址，是真实的物理网络，集群外配合 nodePort 即可访问）。集群内端口和集群外端口由 K8S 的 Service 资源提供设置。<em>在创建 Service 时需要注意，一个 Pod 资源对应一个 Service 资源，不要想着一个 Service 管理两个 Pod 暴露的端口，这样做会使 Service 提供服务的能力异常，经常会接口超时</em>。</p>
<p>　　K8S 编程可以简单称之为面向 config 编程，一切需要动态变化的程序初始化变量，都应该以 config 的形式提供，然后交给运维就行，这样可以避免程序员频繁的修改程序，减少运维负担，K8S 的 config 有三种形式，第一种是程序启动参数，通过创建容器时的 args 参数配置；第二种是系统环境变量，通过创建容器时的 env 参数配置；最后一种是 K8S 提供的 ConfigMap 资源，该资源可以从文件，目录或 key-value 字符串创建，创建后的 ConfinMap 被全集群同命名空间所共享，可以通过 volumes 参数挂载到 pod 中，进而 mount 进容器中，被程序读取。前两种 config 方式对于配置变量少的可以使用，当配置变量很多或配置参数很长时，还是使用 ConfigMap 比较合适。</p>
<h2 id="调度篇">调度篇</h2>
<p>　　调度，广义上的调度可指一切管理安排，CPU 的指令执行就涉及到三级缓存的调度，程序运行时的 GC 可认为是运行时对内存资源的调度，操作系统的进程轮转可认为是系统对进程的调度，而 K8S 中的调度可简单理解为是对操作系统的调度。</p>
<p>　　K8S 的调度可简单分为两个层面上的调度，最底层的调度自然是 K8S 自身的调度策略，根据不同的资源用度和调度策略将 Pod 分配到不同的物理节点之上执行，根据指定的重启或恢复策略启动相应的 Pod，这个层面上的调度，K8S 有一套默认的调度器，对于特殊的调度需求，K8S 也支持自定义调度器，使用外部调度器代替默认调度器，这个层面的调度器 Shaun 没做太多研究，所以在这篇里对这层面的调度器不做过多描述。Shaun 接触过的是更上层的调度器，业务层面的调度服务，业务调度服务一般与业务紧密相关，但最核心的一点就是能够从业务入手，负责 Pod 的创建和销毁，并能掌握其运行状态，就算是完成了一个基础的业务调度服务器。</p>
<p>　　在设计业务调度服务时，有一种通用的模式，可以称之为 master-worker 模式，与同名的并发模式细节上有所不同，这里的 master 是指调度服务本体，只负责对外服务，资源监控，以及任务分发，任务状态感知等，不负责做具体的任务，一般也不关心任务的输入输出。在部署 master 时，一般会创建一个 Service 资源对象，毕竟其主要功能就是对外服务，master 一般由运维进行部署创建销毁。而 worker 是指真正做任务的 Pod，该 Pod 中可能会有多个容器，主容器负责真正执行任务，其他一些容器可能会负责保障任务的前置条件（输入，配置等），以及向 master 汇报任务执行状态信息（执行任务的主容器可能并不知道 master 的存在）等。worker 对应的 Pod 一般由 master 进行创建销毁，worker 的一些配置信息则可能会由运维管理。</p>
<p>　　由于 K8S 并没有在整个集群物理资源之上抽象出一层集群资源，所以 K8S 分配的节点实际还是在物理机上，若所有物理机剩余资源（是单个剩余资源，而不是所有剩余资源之和）都不满足 Pod 所需资源，则该 Pod 无法调度，类比内存碎片化，可以称之为资源碎片化。所以在创建 Pod 时，所需资源最好不要太多，以免调度失败。</p>
<h2 id="实践篇">实践篇</h2>
<p>　　Shaun 目前在 K8S 上开发的主要就是重计算（单机计算时间以小时计）调度服务。这类调度服务其实也分两种，一种是并发调度，一种是流水线（pipeline）式的串行调度，当然也可以将这两种混合起来，串行中有并行。在设计这类调度服务时，需要考虑集群上的资源（内存，CPU）是否足够，若不足，则可以考虑加入一个简单的等待机制，将任务放进一个队列中，当然加入这样一个等待机制，又会增加系统复杂性，需要考虑队列容量，队列优先级等。所以可执行的最小任务消耗的资源越少约好，否则集群中可能完全无法执行相关任务。</p>
<p>　　由于 Shaun 是独立开发，能完全控制 master 和 worker 的编写，所以 worker 设计的比较简单，一个主容器即完成了前置数据处理，主任务执行，执行状态汇报等全部事情，这是从时间和性能上以及系统复杂度上等多方面权衡的结果，当然在时间足够人手够的情况，是应该把现有的 worker 进一步分离的，而 master 就是比较通用的设计，资源监控，任务队列，任务 Pod 创建与销毁，任务状态信息保存，服务接口等，其中常规的服务接口应该有添加任务，开始任务，停止任务，恢复任务，删除任务，任务状态查询，任务日志查询，任务状态汇报等接口，如果任务是并行且无依赖的，还应该支持开始指定子任务等接口。</p>
<p>　　在工作中，Shaun 也接触到一个 pipeline 式的任务调度服务，pipeline 式的工作流有个特点就是下一个子任务的输入必定依赖上一个子任务的输出，在这个任务调度服务中，其子任务的输入输出都是文件态，并且 master 不关心子任务的输入输出，子任务的执行程序也不知道 master 的存在，尽量低耦合。在云上，文件态的存储载体比较好的自然是 OSS，但原本的子任务执行程序只支持本地读取文件，而且在原来的程序中引入 OSS 的读写逻辑并不十分合适，所以在 K8S 中引入了 NFS，由 master 负责将 NFS 挂载到各子任务的 Pod 中，并在挂载到主容器时使用 SubPath 完成 pipeline 之间的资源隔离，使用 emptyDir 完成各子任务之间的资源隔离，每条 pipeline 开始的子任务是从 OSS 中拉取文件到 NFS 中对应的 SubPath 目录中，结束的子任务是将 NFS 中对应的 SubPath 目录中约定好的生成物上传到 OSS 中，并清空该 SubPath 目录，从而使原来的程序在 IO 这块完全不用改动。在监听任务运行状态方面，有两种方案：一种是利用 K8S 的 InitContainer，另一种是借助 K8S 的 shareProcessNamespace。InitContainer 的方案比较简单，InitContainer 第一个容器只做汇报子任务开始这一件事， 第二个容器则是真正执行子任务的容器，而业务容器只做汇报子任务结束这一件事，该方案利用 InitContainer 顺序且先于业务容器执行这两特点，并且若执行子任务的容器失败，则 Pod 也会创建失败，查询 Pod 状态即可知道子任务是否正常运行。而 shareProcessNamespace 的方案稍微复杂一些，同样使用一个 InitContainer 做汇报子任务开始这件事，而业务容器中放两个容器：一个主容器和一个 sidecar 容器（希望 K8S 原生支持的 SideCar 早日做好 ╯△╰），sidecar 容器中以轮询的方式监听主容器的运行状态（查询是否存在主进程）以及是否正常退出（获取容器退出码），并向 master 推送状态信息，该方案借助进程空间共享，使 sidecar 容器能直接查询主容器中的进程，从而达到监听主容器运行状态的目的，该方案的执行还需要一个小 trick，就是要让主容器先执行，由两种方案：一种是借助 postStart Hook，另一种是直接让 sidecar 容器先休眠个 10s 钟。关于 sidecar 容器的另外一种应用方案可参考 <a href="https://zhuanlan.zhihu.com/p/143845408">Nginx容器配置文件如何热更新？</a> 。</p>
<p>　　虽然分布式任务调度框架有很多，eg：<a href="https://airflow.apache.org/">Airflow</a>、<a href="https://github.com/spotify/luigi">Luigi</a> 以及 <a href="https://dolphinscheduler.apache.org">DolphinScheduler</a> 等，但目前与 K8S 联系最紧密的应该就是 <a href="https://argoproj.github.io/">Argo</a> 了，其利用 K8S 的自定义资源对 K8S 已有功能进行扩展，仅使用 YAML 即可完成整个 pipeline 的任务调度和部署，虽然在并发任务调度时有一定的缺陷，但仅使用 YAML 表示其对 K8S 运维的足够友好性，对于常规 pipeline 式任务，Argo 已足以应付，除特殊需求外，程序员可少写很多代码。</p>
<h3 id="附录">附录</h3>
<p>　　对于 Spring 编写的程序，在 K8S 中运行，在导出日志时可参考 <a href="https://www.cnblogs.com/varyuan/p/14243472.html">k8s:获取pod的ip</a>，通过 valueFrom 使用 Pod 的 metadata 作为环境变量，以区分日志的来源，不过挂载存储时最好还是用外部存储，用 hostPath 的话就需要保证每个物理节点都有相同的日志存储目录。</p>
<h2 id="后记">后记</h2>
<p>　　K8S 作为云原生时代的操作系统，不要求人人都完全掌握，但至少需要了解，知道什么该开发干，什么该运维干，这样才能充分发挥各个角色（包括 K8S）的价值。</p>
]]></content>
      <categories>
        <category>CloudNative</category>
      </categories>
      <tags>
        <tag>k8s</tag>
      </tags>
  </entry>
  <entry>
    <title>Mapbox显示GeoServer地图</title>
    <url>/posts/e225d8fd.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　最近做项目需要用到 Mapbox 这个地图可视化框架，以前也没用过，甲方有自己的地图数据，所以得结合 GeoServer 发布一下，简单记录一下流程。</p>
<span id="more"></span>
<h2 id="发布篇">发布篇</h2>
<h3 id="环境准备">环境准备</h3>
<p>　　下载 <a href="http://geoserver.org/release/maintain/">GeoServer</a> 以及同页面下的 <a href="http://sourceforge.net/projects/geoserver/files/GeoServer/2.16.5/extensions/geoserver-2.16.5-vectortiles-plugin.zip">Vector Tiles</a> 插件，将插件中所有 jar 包都复制到 GeoServer 中<code>webapps\geoserver\WEB-INF\lib</code>目录下。在 bin 下执行 startup.bat 启动 geoserver，若需要修改端口，可修改 <code>start.ini</code> 文件中的<code>jetty.port=8080</code>，在浏览器中输入 <code>http://localhost:8080/geoserver/web/</code>，geoserver 中默认账号为<code>admin</code>，密码为<code>geoserver</code>，geoserver 中常用的两个坐标系为 <code>EPSG:4326</code>：wgs84坐标，Mercator 投影，<code>EPSG:900913</code>：wgs84 坐标，Web Mercator 投影，即保证投影为正方形，MapBox 中必须使用<code>EPSG:900913</code>坐标系统，900913 和 3857 是一样的坐标系统，在 PostGIS 中对应的 SRID 是 3857。</p>
<h3 id="设置-tile-caching">设置 Tile Caching</h3>
<p>　　Tile Layers 中可进行图层和图层组的预览，以及切片，在 seed/truncate 中可以设置切片类型以及自动将切片保存到 <code>\data_dir\gwc</code> 目录中。</p>
<p>　　Caching Defaults 需要勾选 Enable TMS Service，以及在 Default Tile Image Formats for:中勾选 <code>application/vnd.mapbox-vector-tile</code>，其它默认即可。</p>
<p>Gridsets 设置新的坐标系统。</p>
<h3 id="地图发布">地图发布</h3>
<p>在 数据 栏下：</p>
<ol type="1">
<li>点击工作区，添加新的工作区，命名以及填写 URI，勾选默认工作区。</li>
<li>点击数据存储，添加新的数据存储，选择数据源，以 Directory of spatial files (shapefiles) 为例，在连接参数下点击 浏览，选择shape文件存放目录，DBF 文件字符集选择 UTF-8 或 GBK。注： shape 文件名中不能有中文。</li>
<li>点击图层，添加新的资源，添加图层，选择上一步的添加的数据存储名称，点击发布或再次发布，进入发布配置界面，勾选 广告则会在 Layer Preview 中显示，一般不需要勾选，点击<code>Compute from native bounds</code>，GeoServer 会自动计算边框和经纬度信息，然后勾选<code>Linear geometries can contain cicular arcs</code>，使线性几何图形包含环形弧，然后保存。重复当前步骤，直到数据存储中所有图层都发布完毕。</li>
<li>点击图层组，添加新的图层组，添加图层，然后点击 生成边界，保存，即完成整个地图的发布。</li>
</ol>
<p>在 Layer Preview 中点击 openLayers 进行地图预览，随意点击地图，若出现乱码，则需要在数据存储中修改 DBF 文件字符集。</p>
<h3 id="mapbox-访问-geoserver-地图">Mapbox 访问 GeoServer 地图</h3>
<p>　　点击 Geoserver 的<code>logo</code>，然后点击 <code>TMS</code> 1.0.0协议，页面跳转后，查找需要访问的外部地址，即对应 TileMap 的 href 属性。MapBox 中访问发布好的切片服务需要在 <code>http://localhost:8080/geoserver/gwc/service/tms/1.0.0/MapBoxTest:Test@EPSG:900913@pbf/&#123;z&#125;/&#123;x&#125;/&#123;y&#125;.pbf</code>，即 href 属性值后面加上 <code>/&#123;z&#125;/&#123;x&#125;/&#123;y&#125;.pbf</code> ，同时注意 在 MapBox style 下 layers 中 <code>source-layer</code> 的值必须为图层名，这里为 <code>"Test"</code> （若使用图层组，则需要找到 Test 图层组下面的图层，使用对应图层名）。简单示例代码如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="TYPESCRIPT"><div class="code-copy"></div><figure class="highlight hljs typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> mapStyle: mapboxgl.Style = &#123;</span><br><span class="line">  <span class="attr">version</span>: <span class="number">8</span>,</span><br><span class="line">  <span class="attr">sources</span>: &#123;</span><br><span class="line">    <span class="attr">geoserverData</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;vector&#x27;</span>,</span><br><span class="line">      <span class="attr">scheme</span>: <span class="string">&#x27;tms&#x27;</span>,</span><br><span class="line">      <span class="attr">tiles</span>: [<span class="string">&quot;http://localhost:8080/geoserver/gwc/service/tms/1.0.0/MapBoxTest:Test@EPSG:900913@pbf/&#123;z&#125;/&#123;x&#125;/&#123;y&#125;.pbf&quot;</span>],</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 OSM 数据源作为底图</span></span><br><span class="line">    <span class="comment">// OsmTiles: &#123;</span></span><br><span class="line">    <span class="comment">//     type: &quot;raster&quot;,</span></span><br><span class="line">    <span class="comment">//     tiles: [&quot;http://a.tile.openstreetmap.org/&#123;z&#125;/&#123;x&#125;/&#123;y&#125;.png&quot;],</span></span><br><span class="line">    <span class="comment">//     tileSize: 256,</span></span><br><span class="line">    <span class="comment">// &#125;,</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="attr">layers</span>: [</span><br><span class="line">    <span class="comment">// 背景图层</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">id</span>: <span class="string">&#x27;background&#x27;</span>,</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;background&#x27;</span>,</span><br><span class="line">      <span class="attr">paint</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;background-color&#x27;</span>: <span class="string">&quot;rgb(0, 0, 0)&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// interactive: true,</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//     id: &quot;OsmTiles&quot;,</span></span><br><span class="line">    <span class="comment">//     type: &quot;raster&quot;,</span></span><br><span class="line">    <span class="comment">//     source: &quot;OsmTiles&quot;,</span></span><br><span class="line">    <span class="comment">//     &quot;source-layer&quot;: &quot;osmtiles&quot;,</span></span><br><span class="line">    <span class="comment">// &#125;,</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 道路</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">id</span>: <span class="string">&#x27;road&#x27;</span>,</span><br><span class="line">      <span class="attr">source</span>: <span class="string">&#x27;geoserverData&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;source-layer&#x27;</span>: <span class="string">&#x27;Test&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;line&#x27;</span>,</span><br><span class="line">      <span class="attr">layout</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;line-cap&#x27;</span>: <span class="string">&#x27;round&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;line-join&#x27;</span>: <span class="string">&#x27;round&#x27;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">paint</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;line-width&#x27;</span>: &#123;</span><br><span class="line">          <span class="attr">base</span>: <span class="number">1.5</span>,</span><br><span class="line">          <span class="attr">stops</span>: [</span><br><span class="line">            [<span class="number">5</span>, <span class="number">0.75</span>],</span><br><span class="line">            [<span class="number">18</span>, <span class="number">32</span>],</span><br><span class="line">          ],</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;line-color&#x27;</span>: <span class="string">&#x27;rgb(255, 255, 255)&#x27;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="attr">interactive</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 地图标注</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">id</span>: <span class="string">&#x27;label&#x27;</span>,</span><br><span class="line">      <span class="attr">source</span>: <span class="string">&#x27;geoserverData&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;source-layer&#x27;</span>: <span class="string">&#x27;Test&#x27;</span>,</span><br><span class="line"></span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;symbol&#x27;</span>,</span><br><span class="line">      <span class="attr">layout</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;text-size&#x27;</span>: &#123;</span><br><span class="line">          <span class="attr">base</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">stops</span>: [</span><br><span class="line">            [<span class="number">9</span>, <span class="number">10</span>],</span><br><span class="line">            [<span class="number">20</span>, <span class="number">16</span>],</span><br><span class="line">          ],</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;text-max-angle&#x27;</span>: <span class="number">30</span>,</span><br><span class="line">        <span class="string">&#x27;symbol-spacing&#x27;</span>: <span class="number">250</span>,</span><br><span class="line">        <span class="string">&#x27;text-font&#x27;</span>: [<span class="string">&#x27;Microsoft YaHei&#x27;</span>], <span class="comment">// 标注使用字体</span></span><br><span class="line">        <span class="string">&#x27;symbol-placement&#x27;</span>: <span class="string">&#x27;line&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;text-padding&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">&#x27;text-rotation-alignment&#x27;</span>: <span class="string">&#x27;map&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;text-pitch-alignment&#x27;</span>: <span class="string">&#x27;viewport&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;text-field&#x27;</span>: <span class="string">&#x27;&#123;name&#125;&#x27;</span>, <span class="comment">// 标注显示属性名</span></span><br><span class="line">        <span class="string">&#x27;text-letter-spacing&#x27;</span>: <span class="number">0.01</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">paint</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;text-color&#x27;</span>: <span class="string">&#x27;hsl(0, 0%, 0%)&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;text-halo-color&#x27;</span>: <span class="string">&#x27;hsla(0, 0%, 100%, 0.75)&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;text-halo-width&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">&#x27;text-halo-blur&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">interactive</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  ]</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> map = <span class="keyword">new</span> <span class="built_in">Map</span>(&#123;</span><br><span class="line">  <span class="attr">container</span>: <span class="string">&quot;map-container&quot;</span>, <span class="comment">// html container id</span></span><br><span class="line">  <span class="comment">// style: &quot;mapbox://styles/mapbox/outdoors-v11&quot;, //hosted style id</span></span><br><span class="line">  <span class="attr">style</span>: mapStyle,</span><br><span class="line">  <span class="attr">center</span>: [<span class="number">0</span>, <span class="number">0</span>], <span class="comment">// starting position [经度, 纬度]</span></span><br><span class="line">  <span class="attr">zoom</span>: <span class="number">1</span>, <span class="comment">// starting zoom</span></span><br><span class="line">  <span class="attr">antialias</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="comment">// maxZoom: 24,</span></span><br><span class="line">  <span class="comment">// minZoom: 1,</span></span><br><span class="line">  <span class="comment">// pitch: 0,</span></span><br><span class="line">  <span class="comment">// maxPitch: 60,</span></span><br><span class="line">  <span class="comment">// // minPitch: 0,</span></span><br><span class="line">  <span class="attr">crossSourceCollisions</span>: <span class="literal">false</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></div>
<h3 id="geoserver-跨域问题">GeoServer 跨域问题</h3>
<p>　　将 lib 目录中的 jetty-servlets 和 jetty-util 两个 jar 包复制到<code>\webapps\geoserver\WEB-INF\lib</code>目录下，将<code>\webapps\geoserver\WEB-INF\web.xml</code>文件中两个 <code>&lt;!-- Uncomment following filter to enable CORS</code> 注释取消，重启 GeoSever。</p>
<h2 id="后记">后记</h2>
<p>　　Mapbox 显示的地图可以自定义样式，而且加载速度渲染性能方面也都还可以，最重要的是由于采用前端渲染矢量，所以没有传统瓦片那种缩放模糊的感觉，这点非常好，本来想总结一篇简单的 Mapbox 使用手册，但没时间整理了，还是算了 😅。</p>
<h2 id="参考资料">参考资料</h2>
<p><a href="https://www.dazhuanlan.com/2019/10/01/5d92e1fa6d695/">基于geoserver+mapbox的定制化离线地图技术方案</a></p>
]]></content>
      <categories>
        <category>Study</category>
      </categories>
      <tags>
        <tag>mapbox</tag>
      </tags>
  </entry>
  <entry>
    <title>M1 个人配置</title>
    <url>/posts/4b1f50ff.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　记录一下 Shaun 个人的 Mac 装机配置。</p>
<span id="more"></span>
<h2 id="必备">必备</h2>
<p><strong><a href="https://github.com/davidwernhart/AlDente-Charge-Limiter">AlDente</a></strong>：Mac 电池健康保护神器，默认 80% 就行，想充满就设置为 100%，需要<em>禁掉自带的优化电池充电</em>。</p>
<p><strong><a href="https://github.com/objective-see/LuLu">LuLu</a></strong>：防火墙，控制应用联网权限。</p>
<p><a href="https://github.com/waydabber/BetterDisplay"><strong>BetterDisplay</strong></a>：使外接显示器更清晰，需设置与笔记本同宽高比/同分辨率的 Dummy 以及将 Dummy 屏幕镜像到外接显示器。</p>
<p><a href="https://maczip.cn/"><strong>MacZip</strong></a>：解压缩。</p>
<h2 id="mac-黑魔法">Mac 黑魔法</h2>
<p>　　有时 Mac 系统抽风，部分设置在界面上无法修改，需要通过终端命令强制修改。现记录部分命令：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 允许安装任何来源的 app</span></span><br><span class="line">sudo spctl --master-disable</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置时区为中国标准时间</span></span><br><span class="line">sudo systemsetup -settimezone Asia/Shanghai</span><br></pre></td></tr></table></figure></div>
<hr />
<h2 id="iterm2">iTerm2</h2>
<p>　　下载安装 <a href="https://iterm2.com/">iTerm2</a>，默认 shell 就是 zsh，所以不需要安装。</p>
<p>　　<em>※注：推荐用 Mac 系统自带的终端安装 Oh My Zsh 和 Powerlevel10k，之后才使用 iTerm2</em>。</p>
<p>　　安装 <a href="https://github.com/ohmyzsh/ohmyzsh#basic-installation">Oh My Zsh</a>，github 上的命令在国内可能无法顺利执行，先 clone 下来，手动执行 <code>sh tools/install.sh</code>。</p>
<p>　　安装 <a href="https://github.com/romkatv/powerlevel10k/#oh-my-zsh">Powerlevel10k</a> 之前，先安装 <a href="https://www.nerdfonts.com/font-downloads">nerd font 字体</a>，Shaun 个人还是比价喜欢 Fira Code 字体，所以就选择下载 Fira Code Nerd Font 字体，只需要安装 <code>Fira Code Retina Nerd Font Complete.ttf</code> 即可。设置 iTerm2 字体为 FiraCode Nerd Font。</p>
<p>　　随后开始安装 Powerlevel10k，安装完之后重启 iTerm2，会有 Powerlevel10k 的配置提问，依次回答（有推荐按推荐）完成即可配置好 Powerlevel10k，若后续想修改配置，可直接编辑 <code>~/.p10k.zsh</code> 文件或使用 <code>p10k configure</code> 命令重新回答配置提问。最后在 zsh 的配置文件 <code>~/.zshrc</code> 中设置 <code>ZSH_THEME=powerlevel10k/powerlevel10k</code>。</p>
<p>　　推荐安装 zsh 插件 <a href="https://github.com/zsh-users/zsh-syntax-highlighting">zsh-syntax-highlighting</a> 和 <a href="https://github.com/zsh-users/zsh-autosuggestions">zsh-autosuggestions</a>，在执行完</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="code"><pre><span class="line">git clone https://github.com/zsh-users/zsh-syntax-highlighting.git $&#123;ZSH_CUSTOM:-~/.oh-my-zsh/custom&#125;/plugins/zsh-syntax-highlighting</span><br><span class="line"></span><br><span class="line">git clone https://github.com/zsh-users/zsh-autosuggestions $&#123;ZSH_CUSTOM:-~/.oh-my-zsh/custom&#125;/plugins/zsh-autosuggestions</span><br></pre></td></tr></table></figure></div>
<p>后修改 ~/.zshrc 的 plugins 值，</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="code"><pre><span class="line">plugins=( </span><br><span class="line">    git</span><br><span class="line">    zsh-syntax-highlighting</span><br><span class="line">    zsh-autosuggestions</span><br><span class="line">    # other plugins...</span><br><span class="line">)</span><br></pre></td></tr></table></figure></div>
<h2 id="vi">Vi</h2>
<p>　　Vi 使用 <a href="https://spacevim.org/cn/"><strong>SpaceVim</strong></a>，Mac 中如果无法使用 vim 命令，需要先安装 Vim。</p>
<h2 id="vscode">VSCode</h2>
<p>　　VSCode 同样需要设置终端字体为 <code>FiraCode Nerd Font</code>，在终端中进入 Downloads 目录执行 <code>mv Visual\ Studio\ Code.app /Applications</code> 命令，将 VSCode 放进 应用程序 中，再执行 <code>sudo ln -s "/Applications/Visual Studio Code.app/Contents/Resources/app/bin/code" /usr/local/bin/code</code>，之后可在终端使用命令（<code>code .</code>）直接打开 VSCode。若无法自动更新，需执行：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="code"><pre><span class="line">sudo chown -R $USER ~/Library/Caches/com.microsoft.VSCode.ShipIt</span><br><span class="line">xattr -dr com.apple.quarantine /Applications/Visual\ Studio\ Code.app</span><br></pre></td></tr></table></figure></div>
<h3 id="vsc-插件">VSC 插件</h3>
<ul>
<li><a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode.hexeditor">Hex Editor</a>：编辑二进制文件，可替换和新增字节；</li>
<li><a href="https://marketplace.visualstudio.com/items?itemName=ryu1kn.partial-diff">Partial Diff</a>：文本比较差分，支持选中的文本和剪贴板内容比较；</li>
<li><a href="https://marketplace.visualstudio.com/items?itemName=josee9988.minifyall">MinifyAll</a>：代码压缩，支持大部分常见格式（xml，json，html 等）；</li>
</ul>
<h2 id="homebrew">Homebrew</h2>
<p><strong>20241112 更新：</strong></p>
<p>可一键直接 <a href="https://brew.idayer.com/">安装 Homebrew</a>，<a href="http://mirrors.ustc.edu.cn/help/brew.git.html">中科大源</a>，<a href="https://mirror.tuna.tsinghua.edu.cn/help/homebrew/">清华大学源</a></p>
<p><strong><em>以下命令无需执行。</em></strong></p>
<hr />
<p>　　直接执行：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="code"><pre><span class="line">/bin/bash -c &quot;$(curl -fsSL https://cdn.jsdelivr.net/gh/ineo6/homebrew-install/install.sh)&quot;</span><br><span class="line"></span><br><span class="line">echo &#x27;eval &quot;$(/opt/homebrew/bin/brew shellenv)&quot;&#x27; &gt;&gt; ~/.zprofile</span><br><span class="line">eval &quot;$(/opt/homebrew/bin/brew shellenv)&quot;</span><br></pre></td></tr></table></figure></div>
<p>安装完成后先检查目录 <code>/opt/homebrew/Library/Taps/homebrew/homebrew-cask</code> 是否存在，若不存在，则执行：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="code"><pre><span class="line">cd /opt/homebrew/Library/Taps/homebrew/</span><br><span class="line">git clone https://mirrors.ustc.edu.cn/homebrew-cask.git</span><br></pre></td></tr></table></figure></div>
<p>　　最后设置中科大源：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="code"><pre><span class="line">git -C &quot;$(brew --repo)&quot; remote set-url origin https://mirrors.ustc.edu.cn/brew.git</span><br><span class="line">git -C &quot;$(brew --repo homebrew/core)&quot; remote set-url origin https://mirrors.ustc.edu.cn/homebrew-core.git</span><br><span class="line">git -C &quot;$(brew --repo homebrew/cask)&quot; remote set-url origin https://mirrors.ustc.edu.cn/homebrew-cask.git</span><br><span class="line">brew update</span><br><span class="line"></span><br><span class="line">echo &#x27;export HOMEBREW_BOTTLE_DOMAIN=https://mirrors.ustc.edu.cn/homebrew-bottles/bottles&#x27; &gt;&gt; ~/.zprofile</span><br><span class="line">source ~/.zprofile</span><br></pre></td></tr></table></figure></div>
<h2 id="aria2">Aria2</h2>
<p>　　直接使用命令 <code>brew install aria2</code> 安装，生成配置文件：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="code"><pre><span class="line">cd ~</span><br><span class="line">mkdir .aria2</span><br><span class="line">cd .aria2</span><br><span class="line">touch aria2.conf</span><br></pre></td></tr></table></figure></div>
<p>　　打开 Finder，通过 Shift+Cmd+G 进入路径：~/.aria2/，编辑文件 <code>aria2.conf</code>，添加以下内容：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="code"><pre><span class="line">#用户名</span><br><span class="line">#rpc-user=user</span><br><span class="line">#密码</span><br><span class="line">#rpc-passwd=passwd</span><br><span class="line">#上面的认证方式不建议使用,建议使用下面的token方式</span><br><span class="line">#设置加密的密钥</span><br><span class="line">#rpc-secret=token</span><br><span class="line">#允许rpc</span><br><span class="line">enable-rpc=true</span><br><span class="line">#允许所有来源, web界面跨域权限需要</span><br><span class="line">rpc-allow-origin-all=true</span><br><span class="line">#允许外部访问，false的话只监听本地端口</span><br><span class="line">rpc-listen-all=true</span><br><span class="line">#RPC端口, 仅当默认端口被占用时修改</span><br><span class="line">#rpc-listen-port=6800</span><br><span class="line">#最大同时下载数(任务数), 路由建议值: 3</span><br><span class="line">max-concurrent-downloads=5</span><br><span class="line">#断点续传</span><br><span class="line">continue=true</span><br><span class="line">#同服务器连接数</span><br><span class="line">max-connection-per-server=5</span><br><span class="line">#最小文件分片大小, 下载线程数上限取决于能分出多少片, 对于小文件重要</span><br><span class="line">min-split-size=10M</span><br><span class="line">#单文件最大线程数, 路由建议值: 5</span><br><span class="line">split=10</span><br><span class="line">#下载速度限制</span><br><span class="line">max-overall-download-limit=0</span><br><span class="line">#单文件速度限制</span><br><span class="line">max-download-limit=0</span><br><span class="line">#上传速度限制</span><br><span class="line">max-overall-upload-limit=0</span><br><span class="line">#单文件速度限制</span><br><span class="line">max-upload-limit=0</span><br><span class="line">#断开速度过慢的连接</span><br><span class="line">#lowest-speed-limit=0</span><br><span class="line">#验证用，需要1.16.1之后的release版本</span><br><span class="line">#referer=*</span><br><span class="line">#文件保存路径, 默认为当前启动位置</span><br><span class="line">dir=/Users/yuanxu/Downloads</span><br><span class="line">#文件缓存, 使用内置的文件缓存, 如果你不相信Linux内核文件缓存和磁盘内置缓存时使用, 需要1.16及以上版本</span><br><span class="line">#disk-cache=0</span><br><span class="line">#另一种Linux文件缓存方式, 使用前确保您使用的内核支持此选项, 需要1.15及以上版本(?)</span><br><span class="line">#enable-mmap=true</span><br><span class="line">#文件预分配, 能有效降低文件碎片, 提高磁盘性能. 缺点是预分配时间较长</span><br><span class="line">#所需时间 none &lt; falloc ? trunc &lt;&lt; prealloc, falloc和trunc需要文件系统和内核支持</span><br><span class="line">file-allocation=prealloc</span><br><span class="line">bt-tracker=udp://tracker.opentrackr.org:1337/announce,udp://open.tracker.cl:1337/announce,udp://9.rarbg.com:2810/announce,udp://tracker.openbittorrent.com:6969/announce,udp://exodus.desync.com:6969/announce,udp://www.torrent.eu.org:451/announce,udp://vibe.sleepyinternetfun.xyz:1738/announce,udp://tracker1.bt.moack.co.kr:80/announce,udp://tracker.zerobytes.xyz:1337/announce,udp://tracker.torrent.eu.org:451/announce,udp://tracker.theoks.net:6969/announce,udp://tracker.srv00.com:6969/announce,udp://tracker.pomf.se:80/announce,udp://tracker.ololosh.space:6969/announce,udp://tracker.monitorit4.me:6969/announce,udp://tracker.moeking.me:6969/announce,udp://tracker.lelux.fi:6969/announce,udp://tracker.leech.ie:1337/announce,udp://tracker.jordan.im:6969/announce,udp://tracker.blacksparrowmedia.net:6969/announce</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
<p>最后的 bt-tracker 可以从 <a href="https://github.com/ngosang/trackerslist">trackerslist</a> 获取，只用最好的 20 个即可（trackers_best (20 trackers) =&gt; <a href="https://raw.githubusercontent.com/ngosang/trackerslist/master/trackers_best.txt">link</a> / <a href="https://ngosang.github.io/trackerslist/trackers_best.txt">mirror</a> / <a href="https://cdn.jsdelivr.net/gh/ngosang/trackerslist@master/trackers_best.txt">mirror 2</a>）。</p>
<p>　　接着启动 aria2：<code>aria2c --conf-path="/Users/xxx/.aria2/aria2.conf" -D</code> （xxx 为电脑用户名），在 ~/.zshrc 中加入</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="code"><pre><span class="line">alias start-aria2=&#x27;aria2c --conf-path=&quot;/Users/xxx/.aria2/aria2.conf&quot; -D&#x27;</span><br><span class="line">start-aria2</span><br></pre></td></tr></table></figure></div>
<p>将 start-aria2c 作为启动 aria2 的命令别名，顺便开机自启。</p>
<p>　　最后从 <a href="http://aria2.baisheng999.com/">Aria2中文网</a> 安装 Chrome 插件，打开 aria2 的 WebUI 界面。</p>
<h2 id="expect">expect</h2>
<p>　　经常需要使用 ssh 远程登陆堡垒机再到远程服务器，输密码选机器都很麻烦，可以用 expect 写些脚本，自动填充密码和机器，一键直接进到远程服务器。首先安装 expect：<code>brew install expect</code>。在 /usr/local/bin 目录中新建脚本：<code>sudo vi mysl.sh</code>，填充相应内容：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/expect -f</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> USER [用户名]</span><br><span class="line"><span class="built_in">set</span> PWD [密码]</span><br><span class="line"><span class="built_in">set</span> TERMSERVIP [堡垒机服务器ip]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 全部的远程服务器（[remote_server_name] 需要修改为对应的服务器名</span></span><br><span class="line"><span class="built_in">set</span> RS1 [remote_server_name]</span><br><span class="line"><span class="built_in">set</span> RS2 [remote_server_name]</span><br><span class="line"></span><br><span class="line"><span class="comment"># help 命令，查看所有需要登录的远程服务器</span></span><br><span class="line"><span class="keyword">if</span> &#123;[lindex <span class="variable">$argv</span> 0] == <span class="string">&quot;help&quot;</span>&#125; &#123;</span><br><span class="line">    puts <span class="string">&quot;1: <span class="variable">$RS1</span> [说明]&quot;</span></span><br><span class="line">    puts <span class="string">&quot;2: <span class="variable">$RS2</span> [说明]&quot;</span></span><br><span class="line">    send <span class="string">&quot;exit\r&quot;</span></span><br><span class="line">    <span class="built_in">exit</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#  ===== 脚本正文 =====</span></span><br><span class="line"><span class="comment"># 默认登陆远程服务器1</span></span><br><span class="line"><span class="built_in">set</span> RS <span class="variable">$RS1</span></span><br><span class="line"><span class="built_in">set</span> timeout 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输入命令 1，则登陆第一台服务器</span></span><br><span class="line"><span class="keyword">if</span> &#123;[lindex <span class="variable">$argv</span> 0] == <span class="string">&quot;1&quot;</span>&#125; &#123;</span><br><span class="line">    <span class="built_in">set</span> RS <span class="variable">$RS1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> &#123;[lindex <span class="variable">$argv</span> 0] == <span class="string">&quot;2&quot;</span>&#125; &#123;</span><br><span class="line">    <span class="built_in">set</span> RS <span class="variable">$RS2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">spawn ssh <span class="variable">$&#123;USER&#125;</span>@<span class="variable">$&#123;TERMSERVIP&#125;</span> -p 22</span><br><span class="line">expect &#123;</span><br><span class="line">    <span class="string">&quot;yes/no&quot;</span> &#123; send <span class="string">&quot;yes\r&quot;</span>; exp_continue; &#125;</span><br><span class="line">    <span class="string">&quot;*assword*&quot;</span> &#123; send <span class="string">&quot;<span class="variable">$PWD</span>\n&quot;</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 选择几号跳板机</span></span><br><span class="line">expect <span class="string">&quot;*num*&quot;</span> &#123; send <span class="string">&quot;0\n&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登陆远程服务器</span></span><br><span class="line">expect <span class="string">&quot;<span class="variable">$&#123;USER&#125;</span>@&quot;</span> &#123; send <span class="string">&quot;ssh <span class="variable">$RS</span>\n&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 退出 expect（保持在远程服务器终端</span></span><br><span class="line">interact</span><br><span class="line"></span><br><span class="line"><span class="comment"># 退出 expect（回到本地终端</span></span><br><span class="line"><span class="comment"># expect eof  </span></span><br></pre></td></tr></table></figure></div>
<p>为新建的脚本增加可执行权限：<code>sudo chmod 777 mysl.sh</code>，之后可直接使用 <code>mysl.sh 1</code> 登录到对应的远程服务器。</p>
<h2 id="lrzsz">lrzsz</h2>
<p>　　与 FTP 和 NFS 相比，使用 lrzsz 与远程 linux 服务器做文件上传和下载是最简单的，在 iTerm2 中使用 <code>rz</code> 和 <code>sz</code> 命令进行上传和下载文件需要一定的配置。<strong><em>※注</em></strong>： <em>使用 expect 自动登录的远程环境可能无法使用 sz rz 命令</em>。</p>
<p>　　首先安装 lrzsz：<code>brew install lrzsz</code>。再跳转目录：<code>cd /usr/local/bin</code>，新建文件：<code>sudo vi iterm2-recv-zmodem.sh</code>，添加内容：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Author: Matt Mastracci (matthew@mastracci.com)</span></span><br><span class="line"><span class="comment"># AppleScript from http://stackoverflow.com/questions/4309087/cancel-button-on-osascript-in-a-bash-script</span></span><br><span class="line"><span class="comment"># licensed under cc-wiki with attribution required </span></span><br><span class="line"><span class="comment"># Remainder of script public domain</span></span><br><span class="line"></span><br><span class="line">osascript -e <span class="string">&#x27;tell application &quot;iTerm2&quot; to version&#x27;</span> &gt; /dev/null 2&gt;&amp;1 &amp;&amp; NAME=iTerm2 || NAME=iTerm</span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$NAME</span> = <span class="string">&quot;iTerm&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    FILE=`osascript -e <span class="string">&#x27;tell application &quot;iTerm&quot; to activate&#x27;</span> -e <span class="string">&#x27;tell application &quot;iTerm&quot; to set thefile to choose folder with prompt &quot;Choose a folder to place received files in&quot;&#x27;</span> -e <span class="string">&quot;do shell script (\&quot;echo \&quot;&amp;(quoted form of POSIX path of thefile as Unicode text)&amp;\&quot;\&quot;)&quot;</span>`</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    FILE=`osascript -e <span class="string">&#x27;tell application &quot;iTerm2&quot; to activate&#x27;</span> -e <span class="string">&#x27;tell application &quot;iTerm2&quot; to set thefile to choose folder with prompt &quot;Choose a folder to place received files in&quot;&#x27;</span> -e <span class="string">&quot;do shell script (\&quot;echo \&quot;&amp;(quoted form of POSIX path of thefile as Unicode text)&amp;\&quot;\&quot;)&quot;</span>`</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$FILE</span> = <span class="string">&quot;&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> Cancelled.</span><br><span class="line">    <span class="comment"># Send ZModem cancel</span></span><br><span class="line">    <span class="built_in">echo</span> -e \\x18\\x18\\x18\\x18\\x18</span><br><span class="line">    sleep 1</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    <span class="built_in">echo</span> \<span class="comment"># Cancelled transfer</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">cd</span> <span class="string">&quot;<span class="variable">$FILE</span>&quot;</span></span><br><span class="line">    /usr/<span class="built_in">local</span>/bin/rz -E -e -b</span><br><span class="line">    sleep 1</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    <span class="built_in">echo</span> \<span class="comment"># Sent \-\&gt; $FILE</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></div>
<p>再新建文件：<code>sudo vi iterm2-send-zmodem.sh</code>，添加内容：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Author: Matt Mastracci (matthew@mastracci.com)</span></span><br><span class="line"><span class="comment"># AppleScript from http://stackoverflow.com/questions/4309087/cancel-button-on-osascript-in-a-bash-script</span></span><br><span class="line"><span class="comment"># licensed under cc-wiki with attribution required </span></span><br><span class="line"><span class="comment"># Remainder of script public domain</span></span><br><span class="line"></span><br><span class="line">osascript -e <span class="string">&#x27;tell application &quot;iTerm2&quot; to version&#x27;</span> &gt; /dev/null 2&gt;&amp;1 &amp;&amp; NAME=iTerm2 || NAME=iTerm</span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$NAME</span> = <span class="string">&quot;iTerm&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    FILE=`osascript -e <span class="string">&#x27;tell application &quot;iTerm&quot; to activate&#x27;</span> -e <span class="string">&#x27;tell application &quot;iTerm&quot; to set thefile to choose file with prompt &quot;Choose a file to send&quot;&#x27;</span> -e <span class="string">&quot;do shell script (\&quot;echo \&quot;&amp;(quoted form of POSIX path of thefile as Unicode text)&amp;\&quot;\&quot;)&quot;</span>`</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    FILE=`osascript -e <span class="string">&#x27;tell application &quot;iTerm2&quot; to activate&#x27;</span> -e <span class="string">&#x27;tell application &quot;iTerm2&quot; to set thefile to choose file with prompt &quot;Choose a file to send&quot;&#x27;</span> -e <span class="string">&quot;do shell script (\&quot;echo \&quot;&amp;(quoted form of POSIX path of thefile as Unicode text)&amp;\&quot;\&quot;)&quot;</span>`</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$FILE</span> = <span class="string">&quot;&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> Cancelled.</span><br><span class="line">    <span class="comment"># Send ZModem cancel</span></span><br><span class="line">    <span class="built_in">echo</span> -e \\x18\\x18\\x18\\x18\\x18</span><br><span class="line">    sleep 1</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    <span class="built_in">echo</span> \<span class="comment"># Cancelled transfer</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    /usr/<span class="built_in">local</span>/bin/sz <span class="string">&quot;<span class="variable">$FILE</span>&quot;</span> -e -b</span><br><span class="line">    sleep 1</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    <span class="built_in">echo</span> \<span class="comment"># Received $FILE</span></span><br><span class="line"><span class="keyword">fi</span> </span><br></pre></td></tr></table></figure></div>
<p>　　为新建的两文件添加可执行权限：<code>sudo chmod 777 iterm2-*</code>。之后添加 rz sz 命令的软连接：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="code"><pre><span class="line">sudo ln -s /opt/homebrew/bin/rz /usr/local/bin/rz</span><br><span class="line">sudo ln -s /opt/homebrew/bin/sz /usr/local/bin/sz</span><br></pre></td></tr></table></figure></div>
<p>　　最后配置 iTerm2，选择 Preference... -&gt; Profiles -&gt; Default -&gt; Advanced -&gt; Edit （in Triggers），添加下载触发器：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. Regular expression 中填写</span></span><br><span class="line">rz waiting to receive.\*\*B0100</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Action 选择</span></span><br><span class="line">Run Silent Coprocess...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. Parameters 中填写</span></span><br><span class="line">/usr/<span class="built_in">local</span>/bin/iterm2-send-zmodem.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. Instant 不勾选</span></span><br><span class="line"><span class="comment"># 5. Enabled 勾选</span></span><br></pre></td></tr></table></figure></div>
<p>再添加上传触发器：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. Regular expression 中填写</span></span><br><span class="line">\*\*B00000000000000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Action 选择</span></span><br><span class="line">Run Silent Coprocess...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. Parameters 中填写</span></span><br><span class="line">/usr/<span class="built_in">local</span>/bin/iterm2-recv-zmodem.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. Instant 不勾选</span></span><br><span class="line"><span class="comment"># 5. Enabled 勾选</span></span><br></pre></td></tr></table></figure></div>
<p>　　至此 M1 中 iTerm2 rz sz 命令配置完成。</p>
<h2 id="参考资料">参考资料</h2>
<p><a href="https://suixinblog.cn/2019/09/beautify-terminal.html">iTerm2 + zsh + Oh My Zsh + Powerlevel10k 打造 Mac 下最强终端</a></p>
<p><a href="https://www.jianshu.com/p/6f344a1fd2e8">Mac M1 iTerm2 配置rz sz 上传下载文件</a></p>
]]></content>
      <categories>
        <category>Share</category>
      </categories>
      <tags>
        <tag>record</tag>
      </tags>
  </entry>
  <entry>
    <title>LaTex语法指北</title>
    <url>/posts/bcdf334e.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　本文就简单记录一下使用 LaTex 可能会用到的一些语法，LaTex 的语法公式需要用符号 <code>$</code> 括起来，其中 <code>$...$</code> 代表行内公式，<code>$$...$$</code> 代表行间公式。</p>
<span id="more"></span>
<h2 id="常用篇">常用篇</h2>
<h3 id="数学符号">§ 数学符号</h3>
<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 18%" />
<col style="width: 18%" />
<col style="width: 6%" />
<col style="width: 24%" />
<col style="width: 24%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">名称</th>
<th style="text-align: center;">示例</th>
<th style="text-align: center;">预览</th>
<th style="text-align: left;">名称</th>
<th style="text-align: center;">示例</th>
<th style="text-align: center;">预览</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>属于</strong></td>
<td style="text-align: center;"><code>\in</code></td>
<td style="text-align: center;"><span class="math inline">\(\in\)</span></td>
<td style="text-align: left;"><strong>不属于</strong></td>
<td style="text-align: center;"><code>\notin</code></td>
<td style="text-align: center;"><span class="math inline">\(\notin\)</span></td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>并集</strong></td>
<td style="text-align: center;"><code>\cup</code> 或 <code>\bigcup</code></td>
<td style="text-align: center;"><span class="math inline">\(\cup\)</span> 或 <span class="math inline">\(\bigcup\)</span></td>
<td style="text-align: left;"><strong>交集</strong></td>
<td style="text-align: center;"><code>\cap</code> 或 <code>\bigcap</code></td>
<td style="text-align: center;"><span class="math inline">\(\cap\)</span> 或 <span class="math inline">\(\bigcap\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>包含于</strong></td>
<td style="text-align: center;"><code>\subset</code></td>
<td style="text-align: center;"><span class="math inline">\(\subset\)</span></td>
<td style="text-align: left;"><strong>真包含于</strong></td>
<td style="text-align: center;"><code>\subsetneqq</code></td>
<td style="text-align: center;"><span class="math inline">\(\subsetneqq\)</span></td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>包含</strong></td>
<td style="text-align: center;"><code>\supset</code></td>
<td style="text-align: center;"><span class="math inline">\(\supset\)</span></td>
<td style="text-align: left;"><strong>真包含</strong></td>
<td style="text-align: center;"><code>\supsetneqq</code></td>
<td style="text-align: center;"><span class="math inline">\(\supsetneqq\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>不包含于</strong></td>
<td style="text-align: center;"><code>\not\subset</code></td>
<td style="text-align: center;"><span class="math inline">\(\not\subset\)</span></td>
<td style="text-align: left;"><strong>空集</strong></td>
<td style="text-align: center;"><code>\emptyset</code></td>
<td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>左大括号</strong></td>
<td style="text-align: center;"><code>\&#123;</code></td>
<td style="text-align: center;"><span class="math inline">\(\{\)</span></td>
<td style="text-align: left;"><strong>右大括号</strong></td>
<td style="text-align: center;"><code>\&#125;</code></td>
<td style="text-align: center;"><span class="math inline">\(\}\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>正比于</strong></td>
<td style="text-align: center;"><code>\propto</code></td>
<td style="text-align: center;"><span class="math inline">\(\propto\)</span></td>
<td style="text-align: left;"><strong>省略号</strong></td>
<td style="text-align: center;"><code>\cdots</code> 或 <code>\ddots</code> 或 <code>\vdots</code></td>
<td style="text-align: center;"><span class="math inline">\(\cdots\)</span> 或 <span class="math inline">\(\ddots\)</span> 或 <span class="math inline">\(\vdots\)</span></td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>不等于</strong></td>
<td style="text-align: center;"><code>\neq</code></td>
<td style="text-align: center;"><span class="math inline">\(\neq\)</span></td>
<td style="text-align: left;"><strong>等价于</strong></td>
<td style="text-align: center;"><code>\Leftrightarrow</code> 或 <code>\Longleftrightarrow</code></td>
<td style="text-align: center;"><span class="math inline">\(\Leftrightarrow\)</span> 或 <span class="math inline">\(\Longleftrightarrow\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>左推出</strong></td>
<td style="text-align: center;"><code>\Leftarrow</code> 或 <code>\Longleftarrow</code></td>
<td style="text-align: center;"><span class="math inline">\(\Leftarrow\)</span> 或 <span class="math inline">\(\Longleftarrow\)</span></td>
<td style="text-align: left;"><strong>右推出</strong></td>
<td style="text-align: center;"><code>\Rightarrow</code> 或 <code>\Longrightarrow</code></td>
<td style="text-align: center;"><span class="math inline">\(\Rightarrow\)</span> 或 <span class="math inline">\(\Longrightarrow\)</span></td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>大于等于</strong></td>
<td style="text-align: center;"><code>\ge</code> 或 <code>\geq</code></td>
<td style="text-align: center;"><span class="math inline">\(\ge\)</span> 或 <span class="math inline">\(\geq\)</span></td>
<td style="text-align: left;">小于等于</td>
<td style="text-align: center;"><code>\le</code> 或 <code>\leq</code></td>
<td style="text-align: center;"><span class="math inline">\(\le\)</span> 或 <span class="math inline">\(\leq\)</span></td>
</tr>
</tbody>
</table>
<h3 id="希腊字母">§ 希腊字母</h3>
<table>
<colgroup>
<col style="width: 13%" />
<col style="width: 24%" />
<col style="width: 24%" />
<col style="width: 6%" />
<col style="width: 15%" />
<col style="width: 15%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">名称</th>
<th style="text-align: center;">示例（小写和大写）</th>
<th style="text-align: center;">预览（小写和大写）</th>
<th style="text-align: left;">名称</th>
<th style="text-align: center;">示例（小写和大写）</th>
<th style="text-align: center;">预览（小写和大写）</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>alpha</strong></td>
<td style="text-align: center;"><code>\alpha</code> 和<code>\Alpha</code></td>
<td style="text-align: center;"><span class="math inline">\(\alpha\)</span> 和 <span class="math inline">\(\Alpha\)</span></td>
<td style="text-align: left;"><strong>beta</strong></td>
<td style="text-align: center;"><code>\beta</code> 和 <code>\Beta</code></td>
<td style="text-align: center;"><span class="math inline">\(\beta\)</span> 和 <span class="math inline">\(\Beta\)</span></td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>gamma</strong></td>
<td style="text-align: center;"><code>\gamma</code> 和 <code>\Gamma</code></td>
<td style="text-align: center;"><span class="math inline">\(\gamma\)</span> 和 <span class="math inline">\(\Gamma\)</span></td>
<td style="text-align: left;"><strong>delta</strong></td>
<td style="text-align: center;"><code>\delta</code> 和 <code>\Delta</code></td>
<td style="text-align: center;"><span class="math inline">\(\delta\)</span> 和 <span class="math inline">\(\Delta\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>theta</strong></td>
<td style="text-align: center;"><code>\theta</code> 、 <code>\vartheta</code> 和 <code>\Theta</code></td>
<td style="text-align: center;"><span class="math inline">\(\theta\)</span> 、 <span class="math inline">\(\vartheta\)</span> 和 <span class="math inline">\(\Theta\)</span></td>
<td style="text-align: left;"><strong>lambda</strong></td>
<td style="text-align: center;"><code>\lambda</code> 和 <code>\Lambda</code></td>
<td style="text-align: center;"><span class="math inline">\(\lambda\)</span> 和 <span class="math inline">\(\Lambda\)</span></td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>mu</strong></td>
<td style="text-align: center;"><code>\mu</code> 和 <code>\Mu</code></td>
<td style="text-align: center;"><span class="math inline">\(\mu\)</span> 和 <span class="math inline">\(\Mu\)</span></td>
<td style="text-align: left;"><strong>pi</strong></td>
<td style="text-align: center;"><code>\pi</code> 和 <code>\Pi</code></td>
<td style="text-align: center;"><span class="math inline">\(\pi\)</span> 和 <span class="math inline">\(\Pi\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>sigma</strong></td>
<td style="text-align: center;"><code>\sigma</code> 和 <code>\Sigma</code></td>
<td style="text-align: center;"><span class="math inline">\(\sigma\)</span> 和 <span class="math inline">\(\Sigma\)</span></td>
<td style="text-align: left;"><strong>omega</strong></td>
<td style="text-align: center;"><code>\omega</code> 和 <code>\Omega</code></td>
<td style="text-align: center;"><span class="math inline">\(\omega\)</span> 和 <span class="math inline">\(\Omega\)</span></td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>chi（卡方分布）</strong></td>
<td style="text-align: center;"><code>\chi</code> 和 <code>\Chi</code></td>
<td style="text-align: center;"><span class="math inline">\(\chi\)</span> 和 <span class="math inline">\(\Chi\)</span></td>
<td style="text-align: left;"><strong>phi</strong></td>
<td style="text-align: center;"><code>\phi</code> 和 <code>\Phi</code></td>
<td style="text-align: center;"><span class="math inline">\(\phi\)</span> 和 <span class="math inline">\(\Phi\)</span></td>
</tr>
</tbody>
</table>
<h3 id="运算符">§ 运算符</h3>
<table>
<thead>
<tr class="header">
<th>名称</th>
<th style="text-align: center;">示例</th>
<th style="text-align: center;">预览</th>
<th>名称</th>
<th style="text-align: center;">示例</th>
<th style="text-align: center;">预览</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>点乘</strong></td>
<td style="text-align: center;"><code>\cdot</code></td>
<td style="text-align: center;"><span class="math inline">\(\cdot\)</span></td>
<td><strong>叉乘</strong></td>
<td style="text-align: center;"><code>\times</code></td>
<td style="text-align: center;"><span class="math inline">\(\times\)</span></td>
</tr>
<tr class="even">
<td><strong>除号</strong></td>
<td style="text-align: center;"><code>\div</code></td>
<td style="text-align: center;"><span class="math inline">\(\div\)</span></td>
<td><strong>分数</strong></td>
<td style="text-align: center;"><code>\frac&#123;c&#125;&#123;a+b&#125;</code></td>
<td style="text-align: center;"><span class="math inline">\(\frac{c}{a+b}\)</span></td>
</tr>
<tr class="odd">
<td><strong>累加</strong></td>
<td style="text-align: center;"><code>\sum</code></td>
<td style="text-align: center;"><span class="math inline">\(\sum\)</span></td>
<td><strong>累乘</strong></td>
<td style="text-align: center;"><code>\prod</code></td>
<td style="text-align: center;"><span class="math inline">\(\prod\)</span></td>
</tr>
<tr class="even">
<td></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td><strong>积分</strong></td>
<td style="text-align: center;"><code>\int</code></td>
<td style="text-align: center;"><span class="math inline">\(\int\)</span></td>
</tr>
</tbody>
</table>
<h2 id="特殊篇">特殊篇</h2>
<h3 id="公式书写">§ 公式书写</h3>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 40%" />
<col style="width: 40%" />
</colgroup>
<thead>
<tr class="header">
<th>名称</th>
<th>示例</th>
<th>预览</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>大括号多行公式</strong></td>
<td><code>\begin&#123;cases&#125; x=v , \\ y=w \end&#123;cases&#125;</code></td>
<td><span class="math inline">\(\begin{cases} x=v , \\ y=w \end{cases}\)</span></td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="矩阵书写">§ 矩阵书写</h3>
<p>示例语法：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="code"><pre><span class="line">\begin&#123;matrix&#125;</span><br><span class="line">  1 &amp; 2 &amp; 3 \\</span><br><span class="line">  4 &amp; 5 &amp; 6 \\</span><br><span class="line">  7 &amp; 8 &amp; 9</span><br><span class="line">\end&#123;matrix&#125;</span><br><span class="line">\quad</span><br><span class="line">\begin&#123;bmatrix&#125; 1 &amp; 2 &amp; 3 \\ 4 &amp; 5 &amp; 6 \\ 7 &amp; 8 &amp; 9 \end&#123;bmatrix&#125;</span><br><span class="line">\quad</span><br><span class="line">\begin&#123;Bmatrix&#125; 1 &amp; 2 &amp; 3 \\ 4 &amp; 5 &amp; 6 \\ 7 &amp; 8 &amp; 9 \end&#123;Bmatrix&#125;</span><br><span class="line">\quad</span><br><span class="line">\begin&#123;pmatrix&#125; 1 &amp; 2 &amp; 3 \\ 4 &amp; 5 &amp; 6 \\ 7 &amp; 8 &amp; 9 \end&#123;pmatrix&#125;</span><br><span class="line">\quad</span><br><span class="line">\begin&#123;vmatrix&#125; 1 &amp; 2 &amp; 3 \\ 4 &amp; 5 &amp; 6 \\ 7 &amp; 8 &amp; 9 \end&#123;vmatrix&#125;</span><br><span class="line">\qquad</span><br><span class="line">\begin&#123;Vmatrix&#125; 1 &amp; 2 &amp; 3 \\ 4 &amp; 5 &amp; 6 \\ 7 &amp; 8 &amp; 9 \end&#123;Vmatrix&#125;</span><br></pre></td></tr></table></figure></div>
<p>显示效果： <span class="math display">\[
\begin{matrix}
  1 &amp; 2 &amp; 3 \\
  4 &amp; 5 &amp; 6 \\
  7 &amp; 8 &amp; 9
\end{matrix}
\quad
\begin{bmatrix} 1 &amp; 2 &amp; 3 \\ 4 &amp; 5 &amp; 6 \\ 7 &amp; 8 &amp; 9 \end{bmatrix}
\quad
\begin{Bmatrix} 1 &amp; 2 &amp; 3 \\ 4 &amp; 5 &amp; 6 \\ 7 &amp; 8 &amp; 9 \end{Bmatrix}
\quad
\begin{pmatrix} 1 &amp; 2 &amp; 3 \\ 4 &amp; 5 &amp; 6 \\ 7 &amp; 8 &amp; 9 \end{pmatrix}
\quad
\begin{vmatrix} 1 &amp; 2 &amp; 3 \\ 4 &amp; 5 &amp; 6 \\ 7 &amp; 8 &amp; 9 \end{vmatrix}
\quad
\begin{Vmatrix} 1 &amp; 2 &amp; 3 \\ 4 &amp; 5 &amp; 6 \\ 7 &amp; 8 &amp; 9 \end{Vmatrix}
\]</span></p>
<h2 id="扩展篇">扩展篇</h2>
<h2 id="技巧篇">技巧篇</h2>
<p><strong>将下标放在正下方：</strong></p>
<p>将普通下标 <code>\max_&#123;x&lt;y&#125;</code> <span class="math inline">\(\max_{x&lt;y}\)</span> 改为 <code>\max\limits_&#123;x&lt;y&#125;</code> <span class="math inline">\(\max\limits_{x&lt;y}\)</span>，即在下标符号 <code>_</code> 前添加 <code>\limits</code>。</p>
<p><strong>至于分块矩阵的虚线可参考：</strong> <a href="http://www.biwako.shiga-u.ac.jp/sensei/kumazawa/tex/form012.html">数式: 行列、ベクトル matrix, vector TeX</a></p>
<p><strong>字符加粗：</strong> 通过 <code>\mathbf&#123;X&#125;</code>， eg. <span class="math inline">\(\mathbf{X}\)</span> 和 <span class="math inline">\(X\)</span> ,</p>
<h2 id="后记">后记</h2>
<p>　　写 Wiki 毕竟不是一蹴而就的事，等以后碰到一些常用的或有时间在继续更新吧 ↖(^ ω ^)↗。</p>
<h2 id="参考资料">参考资料</h2>
<p>[1] <a href="http://mohu.org/info/symbols/symbols.htm">常用数学符号的 LaTeX 表示方法</a></p>
<p>[2] <a href="https://blog.csdn.net/xxzhangx/article/details/52778539">latex中的希腊字母</a></p>
<p>[3] <a href="https://blog.csdn.net/perfumekristy/article/details/8816340">Latex中将下标放在正下方</a></p>
]]></content>
      <categories>
        <category>Wiki</category>
      </categories>
      <tags>
        <tag>note</tag>
        <tag>latex</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux服务器运维文档</title>
    <url>/posts/b59e3e7b.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　记录一下服务器问题排查常用的一些命令。</p>
<span id="more"></span>
<h2 id="常用篇">常用篇</h2>
<h3 id="linux">Linux</h3>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 只列出含 XXX 的文件</span></span><br><span class="line">ll | grep &quot;XXX&quot;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 按列显示文件名</span></span><br><span class="line">ls -1</span><br><span class="line">ls -l | grep ^[^d] | awk &#x27;&#123;print $9&#125;&#x27;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 返回进入当前目录之前的目录</span></span><br><span class="line">cd -</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在文件中查找带 XXX 的行，并输出到 /tmp/99</span></span><br><span class="line">fgrep &quot;XXX&quot; a.txt &gt; /tmp/99</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在当前文件夹中查找带 XXX 的行，并输出到 /tmp/99</span></span><br><span class="line">fgrep &quot;XXX&quot; -r ./* &gt; /tmp/99</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示前5行</span></span><br><span class="line">head -n 5 a.txt</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示倒数第5行</span></span><br><span class="line">tail -n 5 a.txt</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示第5行至末尾</span></span><br><span class="line">tail -n +5 a.txt</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">  提取第二行 [linux系统中sed命令输出指定的行](https://www.cnblogs.com/superbaby11/p/16556602.html)</span></span><br><span class="line">sed -n &#x27;2p&#x27; a.txt</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 以;分隔每一行，并提取第一列和第三列</span></span><br><span class="line">awk -F &#x27;;&#x27; &#x27;&#123;print $1,$3&#125;&#x27; a.txt</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 以:分隔每一行，并提取第一列和第三列</span></span><br><span class="line">awk -F &#x27;[:]&#x27; &#x27;&#123;print $1,$3&#125;&#x27; a.txt</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看 8080 端口占用</span></span><br><span class="line">lsof -i:8080</span><br><span class="line">netstat -tnlp | grep :8080</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看系统运行状态</span></span><br><span class="line">top</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看一定时间内进程cpu占用情况</span></span><br><span class="line">pidstat</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看运行进程</span></span><br><span class="line">ps -ef</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看postgres数据库连接状态，并按cpu使用率排序</span></span><br><span class="line">ps -aux | grep postgres | sort -nrk 3,3</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看磁盘占用大小</span></span><br><span class="line">du -sh *</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看磁盘剩余空间</span></span><br><span class="line">df -h</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看程序被 killed 的原因</span></span><br><span class="line">dmesg | egrep -i -B100 &#x27;killed process&#x27;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看 url 请求时间</span></span><br><span class="line">curl -o /dev/null -s -w %&#123;time_namelookup&#125;:%&#123;time_connect&#125;:%&#123;time_starttransfer&#125;:%&#123;time_total&#125; [url]</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看硬盘序列号</span></span><br><span class="line">sudo lshw -class disk | grep serial</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
<h4 id="正则表达式">正则表达式</h4>
<p>常用正则：<a href="https://ihateregex.io">i Hate Regex</a></p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="code"><pre><span class="line">// 匹配 hello 之前的字符</span><br><span class="line">(.+(?=hello))</span><br><span class="line"></span><br><span class="line">// 匹配其他数字和英文字母但不匹配结尾的 2</span><br><span class="line">([a-zA-Z_0-9]+[^2])</span><br><span class="line"></span><br><span class="line">// 提取包含test以及time后的数字</span><br><span class="line">test[a-zA-Z0-9\-\_\=\|\ ]*time=([\d+])</span><br><span class="line"></span><br><span class="line">// 提取中括号里的内容</span><br><span class="line">[\[](.*?)[\]]</span><br></pre></td></tr></table></figure></div>
<h4 id="工具">工具</h4>
<ul>
<li><strong>crontab</strong>：设置定时任务工具；</li>
<li><strong>Socat</strong>：网络工具（透明代理，端口转发，文件传输等），<a href="https://zhuanlan.zhihu.com/p/347722248">新版瑞士军刀：socat</a></li>
</ul>
<h4 id="服务器之间文件传输">服务器之间文件传输</h4>
<p>参考资料：<a href="https://blog.csdn.net/AnChenliang_1002/article/details/131466784">Linux下的SCP指令详解</a></p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 本地主机传输文件到远程主机</span></span><br><span class="line">scp [本地文件路径] [用户名]@[远程主机IP地址]:[目标路径]</span><br><span class="line"><span class="meta">#</span><span class="bash"> eg:</span></span><br><span class="line">scp file.txt user@example.com:/home/user/</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 远程主机传输文件到本地主机</span></span><br><span class="line">scp [用户名]@[远程主机IP地址]:[远程文件路径] [本地目标路径]</span><br><span class="line"><span class="meta">#</span><span class="bash"> eg:</span></span><br><span class="line">scp user@example.com:/home/user/file.txt /path/to/local/</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 传输本地主机整个目录到远程主机</span></span><br><span class="line">scp -r [本地目录路径] [用户名]@[远程主机IP地址]:[目标路径]</span><br><span class="line"><span class="meta">#</span><span class="bash"> eg:</span></span><br><span class="line">scp -r directory/ user@example.com:/home/user/</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 若远程主机的SSH服务器端口不是默认的22端口，则需要指定端口号</span></span><br><span class="line">scp -P [端口号] [本地文件路径] [用户名]@[远程主机IP地址]:[目标路径]</span><br></pre></td></tr></table></figure></div>
<h3 id="postgresql">PostgreSQL</h3>
<h4 id="编译安装">编译安装</h4>
<p><em>参考自：<a href="https://blog.csdn.net/GJ454221763/article/details/113700717">【CentOS7】PostgreSQL-10.3的安装</a></em></p>
<ol type="1">
<li><p>安装编译工具：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="code"><pre><span class="line">yum install -y vim lrzsz tree wget gcc gcc-c++ readline-devel zlib-devel</span><br></pre></td></tr></table></figure></div></li>
<li><p>进入/usr/local/目录下：<code>cd /usr/local</code></p></li>
<li><p>下载 tar 包：<code>curl -O https://ftp.postgresql.org/pub/source/v16.2/postgresql-16.2.tar.gz</code></p></li>
<li><p>解压：<code>tar -xzvf postgresql-16.2.tar.gz</code></p></li>
<li><p>编译安装：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="code"><pre><span class="line">cd /usr/local/postgresql-16.2</span><br><span class="line">./configure --prefix=/usr/local/pgsql-16.2 # /usr/local/pgsql-16.2 为安装目录</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Two thousand years later，出现「PostgreSQL installation complete.」代表安装成功</span></span><br></pre></td></tr></table></figure></div></li>
<li><p>配置系统环境变量：<code>vi /etc/profile</code></p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment"># /etc/profile 文件末尾添加</span></span><br><span class="line"><span class="built_in">export</span> PGHOME=/usr/<span class="built_in">local</span>/pgsql-16.2</span><br><span class="line"><span class="built_in">export</span> PGDATA=<span class="variable">$PGHOME</span>/data</span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=<span class="variable">$PGHOME</span>/lib:<span class="variable">$LD_LIBRARY_PATH</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PGHOME</span>/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure></div></li>
<li><p>使配置文件立即生效：<code>source /etc/profile</code></p></li>
<li><p>创建数据库用户：<code>useradd -m -d /home/postgres postgres</code></p></li>
<li><p>切换到数据库用户：<code>su postgres</code></p></li>
<li><p>初始化数据库：<code>pg_ctl init -D /home/postgres/db_data</code></p></li>
<li><p>启动数据库：<code>pg_ctl start -D /home/postgres/db_data</code></p></li>
</ol>
<h4 id="自启动设置">自启动设置</h4>
<p>复制 PostgreSQL 自启动文件：<code>cp /usr/local/postgresql-16.2/contrib/start-scripts/linux /etc/init.d/postgresql</code></p>
<p>修改自启动文件：<code>vi /etc/init.d/postgresql</code>，</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#! /bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># chkconfig: 2345 98 02</span></span><br><span class="line"><span class="comment"># description: PostgreSQL RDBMS</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This is an example of a start/stop script for SysV-style init, such</span></span><br><span class="line"><span class="comment"># as is used on Linux systems.  You should edit some of the variables</span></span><br><span class="line"><span class="comment"># and maybe the &#x27;echo&#x27; commands.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Place this file at /etc/init.d/postgresql (or</span></span><br><span class="line"><span class="comment"># /etc/rc.d/init.d/postgresql) and make symlinks to</span></span><br><span class="line"><span class="comment">#   /etc/rc.d/rc0.d/K02postgresql</span></span><br><span class="line"><span class="comment">#   /etc/rc.d/rc1.d/K02postgresql</span></span><br><span class="line"><span class="comment">#   /etc/rc.d/rc2.d/K02postgresql</span></span><br><span class="line"><span class="comment">#   /etc/rc.d/rc3.d/S98postgresql</span></span><br><span class="line"><span class="comment">#   /etc/rc.d/rc4.d/S98postgresql</span></span><br><span class="line"><span class="comment">#   /etc/rc.d/rc5.d/S98postgresql</span></span><br><span class="line"><span class="comment"># Or, if you have chkconfig, simply:</span></span><br><span class="line"><span class="comment"># chkconfig --add postgresql</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Proper init scripts on Linux systems normally require setting lock</span></span><br><span class="line"><span class="comment"># and pid files under /var/run as well as reacting to network</span></span><br><span class="line"><span class="comment"># settings, so you should treat this with care.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Original author:  Ryan Kirkpatrick &lt;pgsql@rkirkpat.net&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># contrib/start-scripts/linux</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## EDIT FROM HERE</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###### 上面不改 #####################</span></span><br><span class="line"><span class="comment"># Installation prefix</span></span><br><span class="line">prefix=/usr/<span class="built_in">local</span>/pgsql-16.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># Data directory</span></span><br><span class="line">PGDATA=<span class="string">&quot;/home/postgres/db_data&quot;</span></span><br><span class="line"><span class="comment">###### 下面不改 #####################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Who to run postgres as, usually &quot;postgres&quot;.  (NOT &quot;root&quot;)</span></span><br><span class="line">PGUSER=postgres</span><br><span class="line"></span><br><span class="line"><span class="comment"># Where to keep a log file</span></span><br><span class="line">PGLOG=<span class="string">&quot;<span class="variable">$PGDATA</span>/serverlog&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># It&#x27;s often a good idea to protect the postmaster from being killed by the</span></span><br><span class="line"><span class="comment"># OOM killer (which will tend to preferentially kill the postmaster because</span></span><br><span class="line"><span class="comment"># of the way it accounts for shared memory).  To do that, uncomment these</span></span><br><span class="line"><span class="comment"># three lines:</span></span><br><span class="line"><span class="comment">#PG_OOM_ADJUST_FILE=/proc/self/oom_score_adj</span></span><br><span class="line"><span class="comment">#PG_MASTER_OOM_SCORE_ADJ=-1000</span></span><br><span class="line"><span class="comment">#PG_CHILD_OOM_SCORE_ADJ=0</span></span><br><span class="line"><span class="comment"># Older Linux kernels may not have /proc/self/oom_score_adj, but instead</span></span><br><span class="line"><span class="comment"># /proc/self/oom_adj, which works similarly except for having a different</span></span><br><span class="line"><span class="comment"># range of scores.  For such a system, uncomment these three lines instead:</span></span><br><span class="line"><span class="comment">#PG_OOM_ADJUST_FILE=/proc/self/oom_adj</span></span><br><span class="line"><span class="comment">#PG_MASTER_OOM_SCORE_ADJ=-17</span></span><br><span class="line"><span class="comment">#PG_CHILD_OOM_SCORE_ADJ=0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## STOP EDITING HERE</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The path that is to be used for the script</span></span><br><span class="line">PATH=/usr/<span class="built_in">local</span>/sbin:/usr/<span class="built_in">local</span>/bin:/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># What to use to start up postgres.  (If you want the script to wait</span></span><br><span class="line"><span class="comment"># until the server has started, you could use &quot;pg_ctl start&quot; here.)</span></span><br><span class="line">DAEMON=<span class="string">&quot;<span class="variable">$prefix</span>/bin/postgres&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># What to use to shut down postgres</span></span><br><span class="line">PGCTL=<span class="string">&quot;<span class="variable">$prefix</span>/bin/pg_ctl&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line"><span class="comment"># Only start if we can find postgres.</span></span><br><span class="line"><span class="built_in">test</span> -x <span class="variable">$DAEMON</span> ||</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$DAEMON</span> not found&quot;</span></span><br><span class="line">	<span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> = <span class="string">&quot;stop&quot;</span> ]</span><br><span class="line">	<span class="keyword">then</span> <span class="built_in">exit</span> 0</span><br><span class="line">	<span class="keyword">else</span> <span class="built_in">exit</span> 5</span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># If we want to tell child processes to adjust their OOM scores, set up the</span></span><br><span class="line"><span class="comment"># necessary environment variables.  Can&#x27;t just export them through the &quot;su&quot;.</span></span><br><span class="line"><span class="keyword">if</span> [ -e <span class="string">&quot;<span class="variable">$PG_OOM_ADJUST_FILE</span>&quot;</span> -a -n <span class="string">&quot;<span class="variable">$PG_CHILD_OOM_SCORE_ADJ</span>&quot;</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">	DAEMON_ENV=<span class="string">&quot;PG_OOM_ADJUST_FILE=<span class="variable">$PG_OOM_ADJUST_FILE</span> PG_OOM_ADJUST_VALUE=<span class="variable">$PG_CHILD_OOM_SCORE_ADJ</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Parse command line parameters.</span></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">  start)</span><br><span class="line">	<span class="built_in">echo</span> -n <span class="string">&quot;Starting PostgreSQL: &quot;</span></span><br><span class="line">	<span class="built_in">test</span> -e <span class="string">&quot;<span class="variable">$PG_OOM_ADJUST_FILE</span>&quot;</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$PG_MASTER_OOM_SCORE_ADJ</span>&quot;</span> &gt; <span class="string">&quot;<span class="variable">$PG_OOM_ADJUST_FILE</span>&quot;</span></span><br><span class="line">	su - <span class="variable">$PGUSER</span> -c <span class="string">&quot;<span class="variable">$DAEMON_ENV</span> <span class="variable">$DAEMON</span> -D &#x27;<span class="variable">$PGDATA</span>&#x27; &gt;&gt;<span class="variable">$PGLOG</span> 2&gt;&amp;1 &amp;&quot;</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;ok&quot;</span></span><br><span class="line">	;;</span><br><span class="line">  stop)</span><br><span class="line">	<span class="built_in">echo</span> -n <span class="string">&quot;Stopping PostgreSQL: &quot;</span></span><br><span class="line">	su - <span class="variable">$PGUSER</span> -c <span class="string">&quot;<span class="variable">$PGCTL</span> stop -D &#x27;<span class="variable">$PGDATA</span>&#x27; -s&quot;</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;ok&quot;</span></span><br><span class="line">	;;</span><br><span class="line">  restart)</span><br><span class="line">	<span class="built_in">echo</span> -n <span class="string">&quot;Restarting PostgreSQL: &quot;</span></span><br><span class="line">	su - <span class="variable">$PGUSER</span> -c <span class="string">&quot;<span class="variable">$PGCTL</span> stop -D &#x27;<span class="variable">$PGDATA</span>&#x27; -s&quot;</span></span><br><span class="line">	<span class="built_in">test</span> -e <span class="string">&quot;<span class="variable">$PG_OOM_ADJUST_FILE</span>&quot;</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$PG_MASTER_OOM_SCORE_ADJ</span>&quot;</span> &gt; <span class="string">&quot;<span class="variable">$PG_OOM_ADJUST_FILE</span>&quot;</span></span><br><span class="line">	su - <span class="variable">$PGUSER</span> -c <span class="string">&quot;<span class="variable">$DAEMON_ENV</span> <span class="variable">$DAEMON</span> -D &#x27;<span class="variable">$PGDATA</span>&#x27; &gt;&gt;<span class="variable">$PGLOG</span> 2&gt;&amp;1 &amp;&quot;</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;ok&quot;</span></span><br><span class="line">	;;</span><br><span class="line">  reload)</span><br><span class="line">	<span class="built_in">echo</span> -n <span class="string">&quot;Reload PostgreSQL: &quot;</span></span><br><span class="line">	su - <span class="variable">$PGUSER</span> -c <span class="string">&quot;<span class="variable">$PGCTL</span> reload -D &#x27;<span class="variable">$PGDATA</span>&#x27; -s&quot;</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;ok&quot;</span></span><br><span class="line">	;;</span><br><span class="line">  status)</span><br><span class="line">	su - <span class="variable">$PGUSER</span> -c <span class="string">&quot;<span class="variable">$PGCTL</span> status -D &#x27;<span class="variable">$PGDATA</span>&#x27;&quot;</span></span><br><span class="line">	;;</span><br><span class="line">  *)</span><br><span class="line">	<span class="comment"># Print help</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="variable">$0</span> &#123;start|stop|restart|reload|status&#125;&quot;</span> 1&gt;&amp;2</span><br><span class="line">	<span class="built_in">exit</span> 1</span><br><span class="line">	;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure></div>
<hr />
<p>接下来有两种方式：</p>
<p>一种是直接执行：<code>cd /etc/rc.d/init.d/ &amp;&amp; chkconfig --add postgresql</code>；</p>
<p>一种是修改 <code>/etc/rc.d/rc.local</code> 文件：<code>vi /etc/rc.d/rc.local</code>，</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># THIS FILE IS ADDED FOR COMPATIBILITY PURPOSES</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># It is highly advisable to create own systemd services or udev rules</span></span><br><span class="line"><span class="comment"># to run scripts during boot instead of using this file.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># In contrast to previous versions due to parallel execution during boot</span></span><br><span class="line"><span class="comment"># this script will NOT be run after all other services.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Please note that you must run &#x27;chmod +x /etc/rc.d/rc.local&#x27; to ensure</span></span><br><span class="line"><span class="comment"># that this script will be executed during boot.</span></span><br><span class="line"> </span><br><span class="line"><span class="built_in">exec</span> 2&gt; /tmp/rc.local.log      <span class="comment"># send stderr from rc.local to a log file</span></span><br><span class="line"><span class="built_in">exec</span> 1&gt;&amp;2                      <span class="comment"># send stdout to the same log file</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;rc.local starting...&quot;</span>        <span class="comment"># show start of execution</span></span><br><span class="line"><span class="built_in">set</span> -x</span><br><span class="line"></span><br><span class="line">touch /var/lock/subsys/<span class="built_in">local</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /etc/rc.d/init.d/</span><br><span class="line">sudo sh postgresql start &amp;      <span class="comment"># 以root执行，不然可能会出现权限错误，&amp;表示后台执行</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 脚本执行完后也给个日志</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;rc.local completed&quot;</span></span><br></pre></td></tr></table></figure></div>
<p>添加可执行权限：<code>chmod a+x /etc/rc.d/rc.local</code>，最后查看一下 rc.local 服务是否启动：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="code"><pre><span class="line">systemctl status rc-local.serives</span><br><span class="line"><span class="meta"> </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动命令</span></span><br><span class="line">systemctl enable rc-local.service</span><br><span class="line">systemctl start rc-local.service</span><br><span class="line"><span class="meta"> </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看数据库服务</span></span><br><span class="line">ps -ef | grep postgres</span><br></pre></td></tr></table></figure></div>
<hr />
<p>若要在容器中设置自启动，在没给容器提权的情况下，则需要第三种方式：将 <code>/etc/rc.d/init.d/postgresql</code> 放进 <code>/root/.bashrc</code> 中启动，<code>vi /root/.bashrc</code>，</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment"># /root/.bashrc 文件末尾添加</span></span><br><span class="line"><span class="keyword">if</span> [ -f /etc/rc.d/init.d/postgresql ]; <span class="keyword">then</span></span><br><span class="line">    sh /etc/rc.d/init.d/postgresql start &gt; /tmp/postgresql.start.log 2&gt;&amp;1</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></div>
<p>原理是：docker 容器在启动时，会自动执行 <code>~/.bashrc</code> 文件，加载环境变量，当有其他命令在该文件时，也会一起执行。</p>
<p>当然，容器中自启动更普遍的方式应该是在镜像/容器中通过 CMD 或者 ENTRYPOINT 直接指定 shell 脚本启动执行。</p>
<h4 id="配置文件设置">配置文件设置</h4>
<p>PG 电子书：<a href="https://postgres-internals.cn/docs/">PostgreSQL 14 Internals</a></p>
<p>配置参数解析文档：<a href="https://postgresqlco.nf/doc/zh/param/">PostgresqlCO.NF: 人类的PostgreSQL配置</a></p>
<p>自动化参数调优：<a href="https://pgtune.leopard.in.ua/">PGTune</a></p>
<p>PG13 一个推荐的配置解析（SSD，48 核，128GB 内存，机器资源独占，混布相当于降低内存和 cpu）</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="code"><pre><span class="line"># 允许任何机器连接。默认只允许本地连接</span><br><span class="line">listen_addresses = &#x27;*&#x27;</span><br><span class="line"></span><br><span class="line"># 数据库连接端口。默认为5432</span><br><span class="line">port = 5432</span><br><span class="line"></span><br><span class="line"># 最大允许512个连接。默认为100</span><br><span class="line">max_connections = 512</span><br><span class="line"></span><br><span class="line"># 锁超时20s。默认为0，不超时</span><br><span class="line">lock_timeout = 20000</span><br><span class="line"># sql超时60s。默认为0，不超时</span><br><span class="line">statement_timeout = 60000</span><br><span class="line"></span><br><span class="line"># 数据库用于缓存数据的使用内存大小，一般设置为系统内存的 25%～30%，不宜过大，最多不超过40%。默认为128MB</span><br><span class="line">shared_buffers = 64GB</span><br><span class="line"></span><br><span class="line"># 查询优化器可用的内存大小，只是预估，不实际使用，值越大，越倾向于索引扫描，一般设置为系统内存的30%～50%，最大不超过90%。默认为4GB</span><br><span class="line">effective_cache_size = 96GB</span><br><span class="line"></span><br><span class="line"># 数据库维护性操作使用的内存（eg：vacuum, create index等），若需加快维护速度，可临时增大该参数 set maintenance_work_mem = 2GB;。默认为64MB</span><br><span class="line">maintenance_work_mem = 64MB</span><br><span class="line"></span><br><span class="line"># 尚未写入磁盘的WAL数据的共享内存量，增大该值有利于提高写入性能，不建议太大，最多不超过 128MB。默认与shared_buffers一致</span><br><span class="line">wal_buffers = 16MB</span><br><span class="line"></span><br><span class="line"># 查询优化器中统计信息的详细程度，越大越详细，查询优化器的决策越好，但会增加 ANALYZE 耗时。默认为100</span><br><span class="line">default_statistics_target = 100</span><br><span class="line"></span><br><span class="line"># 查询优化器获取一个随机页的cost（相比于一个顺序扫描页（seq_page_cost=1）的cost为1），该值相对seq_page_cost越小，越倾向于索引扫描，但不可低于 seq_page_cost。默认为4</span><br><span class="line"># 默认值可以被想成把随机访问建模为比顺序访问慢 40 倍，而期望 90% 的随机读取会被内存缓存。</span><br><span class="line">random_page_cost = 1.1</span><br><span class="line"></span><br><span class="line"># 顺序扫描时并行 I/O 操作的最大数量。默认为1</span><br><span class="line">effective_io_concurrency = 8</span><br><span class="line"></span><br><span class="line"># 每个排序操作、哈希表等操作所能使用的内存大小，增大该值可以提高某些查询性能，但设置过高可能会导致内存耗尽。默认为4MB</span><br><span class="line">work_mem = 4MB</span><br><span class="line"></span><br><span class="line"># 是否为主共享内存区域请求巨型页，巨型页面的使用会导致更小的页面表以及花费在内存管理上的 CPU 时间更少，从而提高性能。默认为try</span><br><span class="line">huge_pages = try</span><br><span class="line"></span><br><span class="line"># 最大工作进程数，增加该值可以增加数据库并行处理能力，过大可能导致资源消耗过多，一般可以设置为CPU核数。默认为8</span><br><span class="line">max_worker_processes = 16</span><br><span class="line"></span><br><span class="line"># 并行查询的最大并行数。默认为2</span><br><span class="line">max_parallel_workers_per_gather = 4</span><br><span class="line"></span><br><span class="line"># 与 max_worker_processes 相同。默认为8</span><br><span class="line">max_parallel_workers = 16</span><br><span class="line"></span><br><span class="line"># 数据库维护性操作的最大并行数。默认为2</span><br><span class="line">max_parallel_maintenance_workers = 4</span><br><span class="line"></span><br><span class="line"># WAL级别，minimal&lt;replica&lt;logical，级别越高记录的WAL越详细，replica用于物理复制，logical用于逻辑复制。默认为replica</span><br><span class="line">wal_level = replica</span><br><span class="line"></span><br><span class="line"># 启用文件系统同步，确保即使系统发生崩溃或断电等异常情况，数据也不会丢失，在高写入负载下，会导致性能下降。默认为on</span><br><span class="line">fsync = on</span><br><span class="line"></span><br><span class="line"># 最小的 WAL 文件大小，WAL 文件用于确保数据的持久性和恢复能力。默认为80MB</span><br><span class="line">min_wal_size = 128MB</span><br><span class="line"></span><br><span class="line"># 最大的 WAL 文件大小，过小会导致频繁的 checkpoint，从而影响性能，过大则可能会占用过多存储空间。默认为1GB</span><br><span class="line">max_wal_size = 4GB</span><br><span class="line"></span><br><span class="line"># 控制checkpoint（用来保证内存数据和磁盘数据一致性和完整性）分散写入，值越大，越分散，写入耗时越长，系统负载越小，一般设置为0.7～0.9，对于写入较大的数据库，该值越大越好。默认为0.5</span><br><span class="line">checkpoint_completion_target = 0.9</span><br><span class="line"></span><br><span class="line">### --- 主从同步相关参数 ---</span><br><span class="line">## 主库设置</span><br><span class="line">## 确保 wal_level 为 replica或logical</span><br><span class="line"># 最大的从库连接数，需大于当前从库数。默认为10</span><br><span class="line">max_wal_senders = 10</span><br><span class="line"></span><br><span class="line"># WAL文件保留的最小磁盘空间。默认为0，不保留</span><br><span class="line">wal_keep_size = 1GB</span><br><span class="line"></span><br><span class="line"># 主库等待从库接收WAL文件后响应的超时时间。默认为60s</span><br><span class="line">wal_sender_timeout = 300s</span><br><span class="line"></span><br><span class="line"># 最大复制槽数量，和 max_wal_senders 相同。默认为10</span><br><span class="line">max_replication_slots = 10</span><br><span class="line"></span><br><span class="line">## 从库设置</span><br><span class="line"># 连接主库的信息</span><br><span class="line">primary_conninfo = &quot;host=master-db-host port=5432 user=replicator password=pwd&quot;</span><br><span class="line"></span><br><span class="line"># 指定主库的复制槽名称</span><br><span class="line">primary_slot_name = &#x27;xxx&#x27;</span><br><span class="line"></span><br><span class="line"># 允许从库进行只读查询。默认为on</span><br><span class="line">hot_standby = on</span><br><span class="line"></span><br><span class="line"># 从库向主库发送状态信息的时间间隔（状态信息包括 WAL 接收器的状态、当前接收进度等数据，主数据库可以使用这些信息监控复制的健康状况和同步延迟）。默认为10s</span><br><span class="line">wal_receiver_status_interval = 10s</span><br><span class="line"></span><br><span class="line"># 允许从库向主库发送反馈信息，以减少查询延迟和 WAL 日志的删除（启用该配置需要确保有足够的磁盘空间，并定期监控主库的 WAL 文件状态）。默认为off</span><br><span class="line">hot_standby_feedback = on</span><br><span class="line"></span><br><span class="line"># 从库等待 WAL 发送的超时时间。默认为60s</span><br><span class="line">wal_receiver_timeout = 300s</span><br><span class="line"></span><br><span class="line">### --- log 相关参数 ---</span><br><span class="line"># 将日志输出到标准错误输出</span><br><span class="line">log_destination = &#x27;stderr&#x27;</span><br><span class="line"># 启用日志收集器（按照 log_directory 和 log_filename 指定的路径保存）。默认为off</span><br><span class="line">logging_collector = on</span><br><span class="line"># 日志文件的存储目录</span><br><span class="line">log_directory = &#x27;log&#x27;</span><br><span class="line"># 日志文件的命名格式</span><br><span class="line">log_filename = &#x27;pgsql-%Y%m%d_%H%M%S.log&#x27;</span><br><span class="line"># 日志文件切分周期</span><br><span class="line">log_rotation_age = 1d</span><br><span class="line"># 不根据文件大小切分</span><br><span class="line">log_rotation_size = 0</span><br><span class="line"># 日志记录的最低级别</span><br><span class="line">log_min_messages = warning</span><br><span class="line"># 记录 SQL 语句的最低错误级别</span><br><span class="line">log_min_error_statement = error</span><br><span class="line"># 记录慢查询时间，单位毫秒，超过该值会记录到日志中。默认不记录</span><br><span class="line">log_min_duration_statement = 5000</span><br><span class="line"># 日志格式。默认只记录时间和进程id</span><br><span class="line">log_line_prefix = &#x27;&lt;%m [%p] %r %u@%d&gt; &#x27;</span><br><span class="line"># 记录等待锁时间超过deadlock_timeout的日志。默认为off，不记录</span><br><span class="line">log_lock_waits = on</span><br><span class="line"></span><br><span class="line">### --- autovacuum 相关参数（需根据表大小，表数据更新频率调整，系统资源） ---</span><br><span class="line"># 启用自动清理，需同时开启track_counts。默认为on</span><br><span class="line">autovacuum = on</span><br><span class="line"># 执行自动清理的最大并发数。默认为3</span><br><span class="line">autovacuum_max_workers = 3</span><br><span class="line"># 每分钟启动一次自动清理进程。默认为1min</span><br><span class="line">autovacuum_naptime = 1min</span><br><span class="line"># 当表中的死行数超过该阈值时，触发 VACUUM 操作。默认为50</span><br><span class="line">autovacuum_vacuum_threshold = 10000</span><br><span class="line"># 在表中插入的行数超过此阈值时，触发 VACUUM 操作。默认为1000</span><br><span class="line">autovacuum_vacuum_insert_threshold = 10000</span><br><span class="line"># 当表中有足够的变化（如插入、更新、删除）且行数超过该阈值时，触发 ANALYZE 操作以更新统计信息。默认为50</span><br><span class="line">autovacuum_analyze_threshold = 5000</span><br><span class="line"># 当表中死行数达到表行数的5%时触发 VACUUM。默认为0.2</span><br><span class="line">autovacuum_vacuum_scale_factor = 0.05</span><br><span class="line"># 在表中插入的行数超过5%时，触发 VACUUM 操作。默认为0.2</span><br><span class="line">autovacuum_vacuum_insert_scale_factor = 0.05</span><br><span class="line"># 当数据变化超过表大小的 5% 时，触发 ANALYZE 操作，更新表的统计信息。默认为0.1</span><br><span class="line">autovacuum_analyze_scale_factor = 0.05</span><br><span class="line"># 每次vacuum操作执行一定量的 I/O 操作后休眠的时间（毫秒），目的是限制自动清理操作对磁盘 I/O 的影响，避免过多的 I/O 操作导致系统性能下降，可增加该值以减少对系统性能的影响。默认是2ms，需与autovacuum_vacuum_cost_limit配合使用</span><br><span class="line">autovacuum_vacuum_cost_delay = 20ms</span><br><span class="line"># 每次vacuum操作的最大 I/O 成本。默认是 -1（即使用 vacuum_cost_limit），可降低该值以减少对系统性能的影响</span><br><span class="line">autovacuum_vacuum_cost_limit = 200</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">可单独针对表设置vacuum参数：</span><br><span class="line">ALTER TABLE large_table</span><br><span class="line">SET (</span><br><span class="line">    autovacuum_vacuum_threshold = 10000,</span><br><span class="line">    autovacuum_vacuum_scale_factor = 0.05,</span><br><span class="line">    autovacuum_analyze_threshold = 5000,</span><br><span class="line">    autovacuum_analyze_scale_factor = 0.05</span><br><span class="line">);</span><br></pre></td></tr></table></figure></div>
<h4 id="psql">psql</h4>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="code"><pre><span class="line">nohup psql postgresql://user:password@host:port/dbname -f update.sql &gt; update.sql 2&gt;&amp;1 &amp;  # 刷库命令，update.sql 文件以 begin; 开始，commit; 结束</span><br><span class="line">\q # 退出数据库</span><br><span class="line">\c exampledb # 切换数据库</span><br><span class="line">\l+ # 查看全部数据库</span><br><span class="line">\du+ # 查看全部用户</span><br><span class="line">\d+ # 查看全部表</span><br><span class="line">\dt+ [table_name] # 查看表大小</span><br><span class="line">\di+ [index_name] # 查看索引大小</span><br><span class="line">\dn+ # 查看全部schema</span><br><span class="line">\dp [table_name] # 查看表的权限详情</span><br><span class="line">\x # 竖式显示记录</span><br></pre></td></tr></table></figure></div>
<h4 id="sql">sql</h4>
<h5 id="查看锁等待状态">查看锁等待状态</h5>
<p><a href="https://developer.aliyun.com/ask/54578?spm=a2c6h.13159736">pg中关于AccessShareLock和ExclusiveLock的问题</a>：</p>
<blockquote>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SQL"><div class="code-copy"></div><figure class="highlight hljs sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 1. 先用一个函数来将锁转换为数字，</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> f_lock_level(i_mode text) <span class="keyword">returns</span> <span class="type">int</span> <span class="keyword">as</span> </span><br><span class="line">$$</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">case</span> i_mode</span><br><span class="line"> <span class="keyword">when</span> <span class="string">&#x27;INVALID&#x27;</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"> <span class="keyword">when</span> <span class="string">&#x27;AccessShareLock&#x27;</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"> <span class="keyword">when</span> <span class="string">&#x27;RowShareLock&#x27;</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line"> <span class="keyword">when</span> <span class="string">&#x27;RowExclusiveLock&#x27;</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line"> <span class="keyword">when</span> <span class="string">&#x27;ShareUpdateExclusiveLock&#x27;</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line"> <span class="keyword">when</span> <span class="string">&#x27;ShareLock&#x27;</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line"> <span class="keyword">when</span> <span class="string">&#x27;ShareRowExclusiveLock&#x27;</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="number">6</span>;</span><br><span class="line"> <span class="keyword">when</span> <span class="string">&#x27;ExclusiveLock&#x27;</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="number">7</span>;</span><br><span class="line"> <span class="keyword">when</span> <span class="string">&#x27;AccessExclusiveLock&#x27;</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="number">8</span>;</span><br><span class="line"> <span class="keyword">else</span> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">end</span> <span class="keyword">case</span>;</span><br><span class="line"><span class="keyword">end</span>; </span><br><span class="line"></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">language</span> plpgsql strict;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. 修改查询语句，按锁级别排序：</span></span><br><span class="line"><span class="keyword">with</span> t_wait <span class="keyword">as</span>                     </span><br><span class="line">(<span class="keyword">select</span> a.mode,a.locktype,a.database,a.relation,a.page,a.tuple,a.classid,a.objid,a.objsubid,</span><br><span class="line">a.pid,a.virtualtransaction,a.virtualxid,a,transactionid,b.query,b.xact_start,b.query_start,</span><br><span class="line">b.usename,b.datname <span class="keyword">from</span> pg_locks a,pg_stat_activity b <span class="keyword">where</span> a.pid<span class="operator">=</span>b.pid <span class="keyword">and</span> <span class="keyword">not</span> a.granted),</span><br><span class="line">t_run <span class="keyword">as</span> </span><br><span class="line">(<span class="keyword">select</span> a.mode,a.locktype,a.database,a.relation,a.page,a.tuple,a.classid,a.objid,a.objsubid,</span><br><span class="line">a.pid,a.virtualtransaction,a.virtualxid,a,transactionid,b.query,b.xact_start,b.query_start,</span><br><span class="line">b.usename,b.datname <span class="keyword">from</span> pg_locks a,pg_stat_activity b <span class="keyword">where</span> a.pid<span class="operator">=</span>b.pid <span class="keyword">and</span> a.granted) </span><br><span class="line"><span class="keyword">select</span> r.locktype,r.mode r_mode,r.usename r_user,r.datname r_db,r.relation::regclass,r.pid r_pid,</span><br><span class="line">r.page r_page,r.tuple r_tuple,r.xact_start r_xact_start,r.query_start r_query_start,</span><br><span class="line">now()<span class="operator">-</span>r.query_start r_locktime,r.query r_query,w.mode w_mode,w.pid w_pid,w.page w_page,</span><br><span class="line">w.tuple w_tuple,w.xact_start w_xact_start,w.query_start w_query_start,</span><br><span class="line">now()<span class="operator">-</span>w.query_start w_locktime,w.query w_query  </span><br><span class="line"><span class="keyword">from</span> t_wait w,t_run r <span class="keyword">where</span></span><br><span class="line">r.locktype <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">distinct</span> <span class="keyword">from</span> w.locktype <span class="keyword">and</span></span><br><span class="line">r.database <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">distinct</span> <span class="keyword">from</span> w.database <span class="keyword">and</span></span><br><span class="line">r.relation <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">distinct</span> <span class="keyword">from</span> w.relation <span class="keyword">and</span></span><br><span class="line">r.page <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">distinct</span> <span class="keyword">from</span> w.page <span class="keyword">and</span></span><br><span class="line">r.tuple <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">distinct</span> <span class="keyword">from</span> w.tuple <span class="keyword">and</span></span><br><span class="line">r.classid <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">distinct</span> <span class="keyword">from</span> w.classid <span class="keyword">and</span></span><br><span class="line">r.objid <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">distinct</span> <span class="keyword">from</span> w.objid <span class="keyword">and</span></span><br><span class="line">r.objsubid <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">distinct</span> <span class="keyword">from</span> w.objsubid <span class="keyword">and</span></span><br><span class="line">r.transactionid <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">distinct</span> <span class="keyword">from</span> w.transactionid <span class="keyword">and</span></span><br><span class="line">r.pid <span class="operator">&lt;&gt;</span> w.pid</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> f_lock_level(w.mode)<span class="operator">+</span>f_lock_level(r.mode) <span class="keyword">desc</span>,r.xact_start;</span><br></pre></td></tr></table></figure></div>
<p>现在可以排在前面的就是锁级别高的等待，优先干掉这个。</p>
<p>-[ RECORD 1 ]-+----------------------------------------------------------</p>
<p>locktype | relation -- 冲突类型</p>
<p>r_mode | ShareUpdateExclusiveLock -- 持锁模式</p>
<p>r_user | postgres -- 持锁用户</p>
<p>r_db | postgres -- 持锁数据库</p>
<p>relation | tbl -- 持锁对象</p>
<p>r_pid | 25656 -- 持锁进程</p>
<p>r_xact_start | 2015-05-10 14:11:16.08318+08 -- 持锁事务开始时间</p>
<p>r_query_start | 2015-05-10 14:11:16.08318+08 -- 持锁SQL开始时间</p>
<p>r_locktime | 00:01:49.460779 -- 持锁时长</p>
<p>r_query | vacuum freeze tbl; -- 持锁SQL,注意不一定是这个SQL带来的锁,也有可能是这个事务在之前执行的SQL加的锁</p>
<p>w_mode | AccessExclusiveLock -- 等待锁模式</p>
<p>w_pid | 26731 -- 等待锁进程</p>
<p>w_xact_start | 2015-05-10 14:11:17.987362+08 -- 等待锁事务开始时间</p>
<p>w_query_start | 2015-05-10 14:11:17.987362+08 -- 等待锁SQL开始时间</p>
<p>w_locktime | 00:01:47.556597 -- 等待锁时长</p>
<p>w_query | truncate tbl; -- 等待锁SQL</p>
<p>-[ RECORD 2 ]-+----------------------------------------------------------</p>
<p>locktype | relation</p>
<p>r_mode | ShareUpdateExclusiveLock</p>
<p>r_user | postgres</p>
<p>r_db | postgres</p>
<p>relation | tbl</p>
<p>r_pid | 25656</p>
<p>r_xact_start | 2015-05-10 14:11:16.08318+08</p>
<p>r_query_start | 2015-05-10 14:11:16.08318+08</p>
<p>r_locktime | 00:01:49.460779</p>
<p>r_query | vacuum freeze tbl;</p>
<p>w_mode | RowExclusiveLock</p>
<p>w_pid | 25582</p>
<p>w_xact_start | 2015-05-10 14:11:22.845+08</p>
<p>w_query_start | 2015-05-10 14:11:22.845+08</p>
<p>w_locktime | 00:01:42.698959</p>
<p>w_query | insert into tbl(crt_time) select now() from generate_series(1,1000); -- 这个SQL其实等待的是truncate tbl的锁;</p>
<p>......</p>
</blockquote>
<h5 id="统计数据库表以及索引存储空间">统计数据库表以及索引存储空间</h5>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SQL"><div class="code-copy"></div><figure class="highlight hljs sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 按从大到小排序输出数据库每个索引大小</span></span><br><span class="line"><span class="keyword">select</span> indexrelname, pg_size_pretty(pg_relation_size(indexrelid)) <span class="keyword">as</span> size <span class="keyword">from</span> pg_stat_user_indexes <span class="keyword">where</span> schemaname<span class="operator">=</span><span class="string">&#x27;public&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> pg_relation_size(<span class="string">&#x27;public&#x27;</span><span class="operator">||</span><span class="string">&#x27;.&#x27;</span><span class="operator">||</span>indexrelname) <span class="keyword">desc</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- [PostgreSQL中查询 每个表的总大小、索引大小和数据大小，并按总大小降序排序](https://blog.csdn.net/sunny_day_day/article/details/131455635)</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    pg_size_pretty(pg_total_relation_size(c.oid)) <span class="keyword">AS</span> total_size,</span><br><span class="line">    pg_size_pretty(pg_indexes_size(c.oid)) <span class="keyword">AS</span> index_size,</span><br><span class="line">    pg_size_pretty(pg_total_relation_size(c.oid) <span class="operator">-</span> pg_indexes_size(c.oid)) <span class="keyword">AS</span> data_size,</span><br><span class="line">    nspname <span class="keyword">AS</span> schema_name,</span><br><span class="line">    relname <span class="keyword">AS</span> table_name</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    pg_class c</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span></span><br><span class="line">    pg_namespace n <span class="keyword">ON</span> n.oid <span class="operator">=</span> c.relnamespace</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    relkind <span class="operator">=</span> <span class="string">&#x27;r&#x27;</span></span><br><span class="line">    <span class="keyword">AND</span> nspname <span class="keyword">NOT</span> <span class="keyword">LIKE</span> <span class="string">&#x27;pg_%&#x27;</span></span><br><span class="line">    <span class="keyword">AND</span> nspname <span class="operator">!=</span> <span class="string">&#x27;information_schema&#x27;</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    pg_total_relation_size(c.oid) <span class="keyword">DESC</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
<h5 id="常用sql语句">常用sql语句</h5>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SQL"><div class="code-copy"></div><figure class="highlight hljs sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查找超过1小时的长事务</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> pg_stat_activity <span class="keyword">where</span> state <span class="operator">&lt;&gt;</span> <span class="string">&#x27;idle&#x27;</span> <span class="keyword">and</span> (backend_xid <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">or</span> backend_xmin <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span>) <span class="keyword">and</span> now()<span class="operator">-</span>xact_start <span class="operator">&gt;</span> <span class="type">interval</span> <span class="string">&#x27;3600 sec&#x27;</span>::<span class="type">interval</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看处于等待锁状态</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> pg_locks <span class="keyword">where</span> <span class="keyword">not</span> granted;</span><br><span class="line"><span class="comment">-- 查看等待锁的关系（表，索引，序列等）</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> pg_class <span class="keyword">where</span> oid<span class="operator">=</span>[上面查出来的relation];</span><br><span class="line"><span class="comment">-- 查看等待锁的数据库</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> pg_database <span class="keyword">where</span> oid<span class="operator">=</span>[上面查出来的database];</span><br><span class="line"><span class="comment">-- 锁表状态</span></span><br><span class="line"><span class="keyword">select</span> oid <span class="keyword">from</span> pg_class <span class="keyword">where</span> relname<span class="operator">=</span><span class="string">&#x27;可能锁表了的表&#x27;</span>;</span><br><span class="line"><span class="comment">-- 查询出结果则被锁</span></span><br><span class="line"><span class="keyword">select</span> pid <span class="keyword">from</span> pg_locks <span class="keyword">where</span> relation<span class="operator">=</span><span class="string">&#x27;上面查出的oid&#x27;</span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">-- 关闭事务并回滚</span></span><br><span class="line"><span class="keyword">select</span> pg_cancel_backend(pid);</span><br><span class="line"><span class="comment">-- 若无法关闭，则强制杀死进程连接</span></span><br><span class="line"><span class="keyword">select</span> pg_terminate_backend(pid);</span><br><span class="line">  </span><br><span class="line"><span class="comment">-- 查看连接信息，重点关注state处于idle in transaction</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> pg_stat_activity;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 替换数据库名称</span></span><br><span class="line">update pg_database <span class="keyword">set</span> datname <span class="operator">=</span> <span class="string">&#x27;destniationDb&#x27;</span> <span class="keyword">where</span> datname <span class="operator">=</span> <span class="string">&#x27;sourceDb&#x27;</span>;</span><br><span class="line"><span class="comment">-- 清除数据库所有连接</span></span><br><span class="line"><span class="keyword">SELECT</span> pg_terminate_backend(pg_stat_activity.pid) <span class="keyword">FROM</span> pg_stat_activity <span class="keyword">WHERE</span> datname<span class="operator">=</span><span class="string">&#x27;test_db&#x27;</span> <span class="keyword">AND</span> pid<span class="operator">&lt;&gt;</span>pg_backend_pid();</span><br><span class="line"><span class="comment">-- 复制数据库，需断开sourceDb的全部连接</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE destniationDb TEMPLATE sourceDb OWNER test_user; </span><br><span class="line"></span><br><span class="line"><span class="comment">-- 清空表并重置自增序列</span></span><br><span class="line"><span class="keyword">truncate</span> <span class="keyword">table</span> table1,table2 RESTART <span class="keyword">IDENTITY</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 导出数据库中数据，HEADER 可不带</span></span><br><span class="line">\<span class="keyword">COPY</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> table1) <span class="keyword">TO</span> <span class="string">&#x27;/tmp/sql_output.csv&#x27;</span> <span class="keyword">WITH</span> CSV HEADER;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 输出删除全部表的sql</span></span><br><span class="line">\<span class="keyword">COPY</span> (<span class="keyword">SELECT</span> <span class="string">&#x27;DROP TABLE IF EXISTS &quot;&#x27;</span> <span class="operator">||</span> tablename <span class="operator">||</span> <span class="string">&#x27;&quot; CASCADE;&#x27;</span> <span class="keyword">from</span> pg_tables <span class="keyword">WHERE</span> schemaname <span class="operator">=</span> <span class="string">&#x27;public&#x27;</span>) <span class="keyword">TO</span> <span class="string">&#x27;/tmp/sql_output.sql&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 添加部分索引（满足条件才建立索引）, where 和 select 语句的一致</span></span><br><span class="line"><span class="keyword">create</span> index [XXX] <span class="keyword">where</span> [XXX]</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看当前连接事务执行超时时间</span></span><br><span class="line"><span class="keyword">show</span> statement_timeout;</span><br><span class="line"><span class="comment">-- 设置数据库事务执行超时时间为 60 秒</span></span><br><span class="line"><span class="keyword">AlTER</span> DATABASE mydatabse <span class="keyword">SET</span> statement_timeout<span class="operator">=</span><span class="string">&#x27;60s&#x27;</span>;</span><br><span class="line"><span class="comment">-- 设置用户事务执行超时时间为 5 分钟</span></span><br><span class="line"><span class="keyword">ALTER</span> ROLE guest <span class="keyword">SET</span> statement_timeout<span class="operator">=</span><span class="string">&#x27;5min&#x27;</span>;</span><br></pre></td></tr></table></figure></div>
<h5 id="子查询优化">子查询优化</h5>
<p>PG 的子查询实际有两种，分为子连接（Sublink）和子查询（SubQuery），按子句的位置不同，出现在 from 关键字后的是子查询，出现在 where/on 等约束条件中或投影中的子句是子连接。</p>
<p>子查询：<code>select a.* from table_a a, （select a_id from table_b where id=1) b where b.a_id = a.id;</code></p>
<p>子连接：<code>select * from table_a where id in（select a_id from table_b where id=1);</code></p>
<p>在简单的子连接查询下，PG 数据库查询优化器一般会将其转化为内连接的方式：<code>select a.* from table_a a, table_b b where a.id=b.a_id and b.id=1;</code>，正常索引没问题情况下这两种方式都能得一样的结果，最终执行的都是索引内连接结果。但在某些情况下，PG 查询优化器在子连接的 SQL 下，子连接的查询会走索引，而主查询会顺序扫描（Seq Scan），原因是当 table_a 的数据量很大时，索引值又有很多重复的，同时查询优化器也不知道子连接返回的具体数据，这时查询优化器可能会认为顺序扫描更快，从而不走索引，导致耗时增加，所以为减少查询优化器的不确定性，最好是直接使用内连接的方式代替 in 语句。 <em>当然，对于特别复杂的查询业务，还是开启事务，分多次查询，在代码层做一些业务逻辑处理更合适，别让数据库把事情全做了，这也能减轻数据库的压力</em>。 PG 查询计划执行路径可以看看： <a href="http://www.postgres.cn/news/viewone/1/156">PostgreSQL 查询语句优化</a>，<a href="https://www.jb51.net/article/203010.htm">postgresql通过索引优化查询速度操作</a></p>
<h5 id="tricks">tricks</h5>
<ul>
<li>由于 <a href="https://stackoverflow.com/questions/309786/how-do-i-force-postgres-to-use-a-particular-index">pg 无法强制使用索引</a>，所以只能通过一些其他方法来引导查询优化器使用索引，比如调整查询条件；</li>
<li><a href="https://stackoverflow.com/questions/3800551/select-first-row-in-each-group-by-group">获取分组中最大值对应的一行数据</a>；</li>
</ul>
<hr />
<p>权限配置，<a href="https://blog.csdn.net/zou8944/article/details/121528128">PostgreSQL权限管理详解</a>：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SQL"><div class="code-copy"></div><figure class="highlight hljs sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建只读组</span></span><br><span class="line"><span class="keyword">create</span> role readonly_group;</span><br><span class="line"><span class="comment">-- 创建只读用户继承只读组</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> reader <span class="keyword">with</span> password <span class="string">&#x27;reader&#x27;</span> <span class="keyword">in</span> role readonly_group;</span><br><span class="line"><span class="comment">-- 删除用户</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">user</span> reader;</span><br><span class="line"><span class="comment">-- 将只读组权限赋给只读用户</span></span><br><span class="line"><span class="keyword">grant</span> readonly_group <span class="keyword">to</span> reader;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 读权限</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span> <span class="keyword">ON</span> <span class="keyword">ALL</span> TABLES <span class="keyword">IN</span> SCHEMA public <span class="keyword">TO</span> readonly_group;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span> <span class="keyword">ON</span> <span class="keyword">ALL</span> SEQUENCES <span class="keyword">IN</span> SCHEMA public <span class="keyword">TO</span> readonly_group;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">EXECUTE</span> <span class="keyword">ON</span> <span class="keyword">ALL</span> FUNCTIONS <span class="keyword">IN</span> SCHEMA public <span class="keyword">TO</span> readonly_group;</span><br><span class="line"><span class="comment">-- 写权限</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">INSERT</span>, UPDATE, <span class="keyword">DELETE</span> <span class="keyword">ON</span> <span class="keyword">ALL</span> TABLES <span class="keyword">IN</span> SCHEMA public <span class="keyword">TO</span> write_group;</span><br><span class="line"><span class="keyword">GRANT</span> USAGE <span class="keyword">ON</span> <span class="keyword">ALL</span> SEQUENCES <span class="keyword">IN</span> SCHEMA public <span class="keyword">TO</span> write_group;</span><br></pre></td></tr></table></figure></div>
<hr />
<h4 id="主从备份">主从&amp;备份</h4>
<p>参考资料：<a href="https://www.jianshu.com/p/478d07af204d">postgresql流式复制(Streaming Replication)</a>、<a href="https://www.cnblogs.com/abclife/p/16391659.html">【PostgreSQL】PostgreSQL复制的监控</a>、<a href="https://blog.csdn.net/weixin_41093846/article/details/132429564">【PostgreSQL】导出数据库表(或序列)的结构和数据</a>、<a href="http://www.postgres.cn/docs/13/app-pg-ctl.html">pg_ctl</a>、<a href="http://www.postgres.cn/docs/13/app-pgbasebackup.html">pg_basebackup</a></p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SQL"><div class="code-copy"></div><figure class="highlight hljs sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建流复制备份用户（主从）</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> replicator replication login encrypted password <span class="string">&#x27;replicator&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在主库创建一个物理复制槽（PG9.4引入，一个从库一个复制槽）</span></span><br><span class="line"><span class="keyword">select</span> pg_create_physical_replication_slot(<span class="string">&#x27;phy_repl_slot_1&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看复制槽状态</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> pg_replication_slots;</span><br></pre></td></tr></table></figure></div>
<p>相关命令：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 冷备数据库(结合刷库命令可恢复数据库)，加 -s 参数只导出数据库表结构</span></span><br><span class="line">nohup pg_dump postgresql://user:password@host:port/dbname -f db_dump.20240107.sql &gt; dump.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建一个数据库</span></span><br><span class="line">pg_ctl init -D /home/postgres/db_data_dir</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改配置后重新加载配置</span></span><br><span class="line">pg_ctl reload -D /home/postgres/db_data_dir</span><br><span class="line"><span class="comment"># 或者重启数据库</span></span><br><span class="line">pg_ctl restart -D /home/postgres/db_data_dir</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置数据库默认连接密码</span></span><br><span class="line"><span class="built_in">export</span> PGPASSWORD=test_pswd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 完整复制数据库（作为从库）</span></span><br><span class="line">nohup pg_basebackup -h localhost -p port -U replicator -D /home/postgres/db_data1_dir -v -P -R -Xs &gt; ./backup.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从库提升为主库</span></span><br><span class="line">pg_ctl promote -D /home/postgres/db_data_dir</span><br></pre></td></tr></table></figure></div>
<p>设置主库：postgresql.conf</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="code"><pre><span class="line">wal_level = hot_standby </span><br><span class="line"># PG12 之后，wal_level = replica</span><br><span class="line"></span><br><span class="line"># 主备机不同步时，re_wind恢复结点</span><br><span class="line">wal_log_hints = on</span><br><span class="line"># 设置最大流复制数（从库数）</span><br><span class="line">max_wal_senders = 3</span><br><span class="line">wal_keep_segments = 64</span><br><span class="line"># 支持从库读，以及从库再拉从库</span><br><span class="line">hot_standby = on</span><br></pre></td></tr></table></figure></div>
<p>设置主库：pg_hba.conf</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="code"><pre><span class="line"># Allow replication connections from localhost, by a user with the</span><br><span class="line"># replication privilege.</span><br><span class="line">local   replication     all                                     trust</span><br><span class="line">host    replication     all             127.0.0.1/32            trust</span><br><span class="line">host    replication     all             ::1/128                 trust</span><br><span class="line">host    replication     all             0.0.0.0/0             md5</span><br></pre></td></tr></table></figure></div>
<p>设置从库 recovery.conf（自 Postgresql 12 起，recovery.conf 并入 postgresql.conf）：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="code"><pre><span class="line">standby_mode          = &#x27;on&#x27; # PG12之后，删除该配置项</span><br><span class="line">primary_conninfo      = &#x27;host=db_addr port=db_port user=replicator password=&lt;password&gt;&#x27;</span><br><span class="line">primary_slot_name     = &#x27;phy_repl_slot_1&#x27;</span><br></pre></td></tr></table></figure></div>
<h5 id="区分主库从库">区分主库从库</h5>
<p>主要方式：从库的根目录下存在 recovery.conf 文件（PG12 之后无该文件，而是存在一个 0KB 的 standby.signal 文件）。</p>
<p><code>SELECT * FROM pg_stat_replication;</code> 如果有结果（显示所有连接到该节点的从库），则表示当前节点为主库。</p>
<p>主库一般配置参数：</p>
<ul>
<li>PG12 之后，wal_level = replica<code>或</code>logical；</li>
<li>max_wal_senders 一般设置较大，允许多个从库；</li>
<li>hot_standby，主库一般为 off；</li>
</ul>
<p>从库一般配置参数：</p>
<ul>
<li>hot_standby，从库为 on；</li>
<li>primary_conninfo，有连接到主库的相关配置信息；</li>
</ul>
<h4 id="并发-dumprestore-数据库">并发 dump&amp;restore 数据库</h4>
<ol type="1">
<li><p>导出数据库全部表结构</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="code"><pre><span class="line">pg_dump -d postgresql://user:pswd@host:port/db_name --schema-only -f db_name_schema.sql</span><br></pre></td></tr></table></figure></div></li>
<li><p>导出外键约束</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="code"><pre><span class="line">psql -d postgresql://owner_user:pswd@host:port/db_name -t -A -F&quot;,&quot; -c &quot;</span><br><span class="line">SELECT DISTINCT</span><br><span class="line">    &#x27;ALTER TABLE &#x27; || quote_ident(nsp.nspname) || &#x27;.&#x27; || quote_ident(cls.relname) || </span><br><span class="line">    &#x27; ADD CONSTRAINT &#x27; || quote_ident(con.conname) || </span><br><span class="line">    &#x27; FOREIGN KEY (&#x27; || array_to_string(ARRAY(</span><br><span class="line">        SELECT quote_ident(att.attname)</span><br><span class="line">        FROM pg_attribute att</span><br><span class="line">        WHERE att.attnum = ANY(con.conkey)</span><br><span class="line">          AND att.attrelid = cls.oid), &#x27;, &#x27;) || </span><br><span class="line">    &#x27;) REFERENCES &#x27; || quote_ident(f_nsp.nspname) || &#x27;.&#x27; || quote_ident(f_cls.relname) || </span><br><span class="line">    &#x27; (&#x27; || array_to_string(ARRAY(</span><br><span class="line">        SELECT quote_ident(att.attname)</span><br><span class="line">        FROM pg_attribute att</span><br><span class="line">        WHERE att.attnum = ANY(con.confkey)</span><br><span class="line">          AND att.attrelid = f_cls.oid), &#x27;, &#x27;) || </span><br><span class="line">    &#x27;) ON DELETE &#x27; || CASE con.confdeltype</span><br><span class="line">                        WHEN &#x27;a&#x27; THEN &#x27;NO ACTION&#x27;</span><br><span class="line">                        WHEN &#x27;r&#x27; THEN &#x27;RESTRICT&#x27;</span><br><span class="line">                        WHEN &#x27;c&#x27; THEN &#x27;CASCADE&#x27;</span><br><span class="line">                        WHEN &#x27;n&#x27; THEN &#x27;SET NULL&#x27;</span><br><span class="line">                        WHEN &#x27;d&#x27; THEN &#x27;SET DEFAULT&#x27;</span><br><span class="line">                      END ||</span><br><span class="line">    &#x27; ON UPDATE &#x27; || CASE con.confupdtype</span><br><span class="line">                        WHEN &#x27;a&#x27; THEN &#x27;NO ACTION&#x27;</span><br><span class="line">                        WHEN &#x27;r&#x27; THEN &#x27;RESTRICT&#x27;</span><br><span class="line">                        WHEN &#x27;c&#x27; THEN &#x27;CASCADE&#x27;</span><br><span class="line">                        WHEN &#x27;n&#x27; THEN &#x27;SET NULL&#x27;</span><br><span class="line">                        WHEN &#x27;d&#x27; THEN &#x27;SET DEFAULT&#x27;</span><br><span class="line">                      END || &#x27;;&#x27;</span><br><span class="line">FROM pg_constraint con</span><br><span class="line">JOIN pg_class cls ON con.conrelid = cls.oid</span><br><span class="line">JOIN pg_namespace nsp ON cls.relnamespace = nsp.oid</span><br><span class="line">JOIN pg_class f_cls ON con.confrelid = f_cls.oid</span><br><span class="line">JOIN pg_namespace f_nsp ON f_cls.relnamespace = f_nsp.oid</span><br><span class="line">WHERE con.contype = &#x27;f&#x27;;&quot; &gt; db_name_fkeys.sql</span><br></pre></td></tr></table></figure></div></li>
<li><p>导出数据库全局用户/权限</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="code"><pre><span class="line">pg_dumpall -d postgresql://superuser:pswd@host:port --globals-only -f db_name_user.sql</span><br></pre></td></tr></table></figure></div></li>
<li><p>4个并行任务导出全部数据</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="code"><pre><span class="line">pg_dump -d postgresql://user:pswd@host:port/db_name --data-only -F d -j 4 -f ./db_name_data_dir</span><br></pre></td></tr></table></figure></div></li>
<li><p>新建数据库实例</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="code"><pre><span class="line">pg_ctl init -D ~/new_db_data</span><br></pre></td></tr></table></figure></div></li>
<li><p>导入数据库全局用户/权限</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="code"><pre><span class="line">psql -U superuser -p port -f db_name_user.sql</span><br></pre></td></tr></table></figure></div></li>
<li><p>新建数据库</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SQL"><div class="code-copy"></div><figure class="highlight hljs sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> database new_db_name owner owner_user</span><br></pre></td></tr></table></figure></div></li>
<li><p>导入数据库全部表结构</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="code"><pre><span class="line">psql -U superuser -p port -f db_name_schema.sql</span><br></pre></td></tr></table></figure></div></li>
<li><p>移除新库外键约束</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="code"><pre><span class="line">psql -d postgresql://owner_user:pswd@host:port/db_name &lt;&lt;EOF</span><br><span class="line">DO \$\$ </span><br><span class="line">DECLARE</span><br><span class="line">    r RECORD;</span><br><span class="line">BEGIN</span><br><span class="line">    FOR r IN (SELECT conname, conrelid::regclass</span><br><span class="line">              FROM pg_constraint</span><br><span class="line">              WHERE contype = &#x27;f&#x27;) LOOP</span><br><span class="line">        EXECUTE &#x27;ALTER TABLE &#x27; || r.conrelid || &#x27; DROP CONSTRAINT &#x27; || r.conname;</span><br><span class="line">    END LOOP;</span><br><span class="line">END \$\$;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></div></li>
<li><p>4个并行任务导入数据</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="code"><pre><span class="line">pg_restore -d postgresql://owner_user:pswd@host:port/db_name -j 4 ./db_name_data_dir</span><br></pre></td></tr></table></figure></div></li>
<li><p>恢复新库外键约束</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="code"><pre><span class="line">psql -d postgresql://owner_user:pswd@host:port/db_name -f db_name_fkeys.sql</span><br></pre></td></tr></table></figure></div></li>
</ol>
<hr />
<h4 id="mvcc数据碎片索引膨胀freeze">MVCC/数据碎片/索引膨胀/FREEZE</h4>
<p>参考自：<a href="https://www.modb.pro/db/48183">PostgreSQL | 空间又告警了，先从整理索引碎片开始</a>，<a href="https://blog.csdn.net/wonder191/article/details/131787424">正确的评估postgres index膨胀</a>，<a href="https://www.cnblogs.com/dbadaily/p/vacuum1.html">PostgreSQL VACUUM 之深入浅出 (一)</a>，<a href="https://blog.csdn.net/qq_44866828/article/details/132031913">深入理解 PostgreSQL 中的 MVCC（多版本并发控制）机制</a>，<a href="https://cloud.tencent.com/developer/article/1555360">硬核-深度剖析PostgreSQL数据库“冻结炸弹”原理机制</a></p>
<p>简单总结一下：</p>
<ul>
<li>mvcc 主要通过锁或乐观并发控制机制来解决冲突，通过事务号实现多版本及查询可见性（当前事务只能看到当前事务启动前已提交的数据，即只可能大事务号看到小事务号的数据），当事务号达到设定值时，事务号会发生回卷，此时需要以单用户模式执行 vacuum freeze 操作，将所有事务号置为2，代表冻结事务，对所有事务可见，当然可通过设置参数实现自动 freeze，减少人工介入维护时间；</li>
<li>由于 postgres 的 mvcc 机制，更新和删除以及新增的回滚都会造成数据碎片，虽然有 vacuum，但仍然存在部分数据碎片无法再被重复利用（连续空间释放中间一部分，再重新分配后，可能导致少许剩余空间太小无法再利用，实时清理或合并这些小空间的代价又太大），且索引的膨胀不可避免（当数据被删除标记为死元组时，被删除数据的索引仍然存在，而 vacuum 不会清理无效索引），所以当发现索引碎片率超过 30% 时，需要进行重建索引 REINDEX，但常规的 REINDEX 会锁表，在 pg12 之后才有 REINDEX CONCURRENTLY，可在线重建，不会锁表，重建完之后需要执行 ANALYZE 更新一下统计信息使索引立即生效。</li>
</ul>
<h4 id="空间清理">空间清理</h4>
<p>　　<a href="http://www.postgres.cn/docs/14/routine-vacuuming.html">由于标准的 vacuum 无法释放空间归还给操作系统</a>，只是在数据库内部清理/释放/使用（<em>所以 vacuum 只对于未造成空间膨胀的数据库有效，而且当存在大量更新/删除操作时，vacuum 也不一定能及时控制数据库大小，导致数据库空间一步步变大</em>）。而 VACUUM FULL 或者 CLUSTER 在清理磁盘时会进行锁表（SELECT、INSERT、UPDATE 和 DELETE 等操作都无法正常进行，基本可认为是需要停机维护），对于已经占用大量存储空间的数据库，可以使用 <a href="https://github.com/reorg/pg_repack">pg_repack</a> 进行在线清理/释放表空间，相比 CLUSTER 或 VACUUM FULL，<a href="https://help.aliyun.com/zh/rds/apsaradb-rds-for-postgresql/use-the-pg-repack-extension-to-clear-tablespaces">pg_repack 无需获取排它锁</a>，更轻量。</p>
<p>　　针对 vacuum 不及时导致一直新申请磁盘空间膨胀的问题，PG 支持设置 autovacuum，根据系统资源调整相关参数后，可以使用 pg_stat_user_tables 视图监控表的膨胀情况，关注 n_dead_tup（死元组数量）和 last_autovacuum（上次vacuum时间）：<code>SELECT relname, n_live_tup, n_dead_tup, last_vacuum, last_autovacuum FROM pg_stat_user_tables ORDER BY n_dead_tup DESC;</code>，以及使用 pg_stat_activity 视图检查 vacuum 进程的执行情况和影响：<code>SELECT datname, pid, usename, query_start, state, query FROM pg_stat_activity WHERE query LIKE '%vacuum%';</code>。</p>
<p>　　对于既成事实占用存储空间超大的数据库，缩减空间一个可能的方案是先 dump 数据，同时开始记录原数据库增量的 dml sql（log_statement=mod），新建一个数据库，用 dump sql 文件写入，记录 dump 最新的节点（时间或者啥 id，再将原数据库节点之外的数据迁移到新数据库中（用之前记录的增量 dml sql，需过滤回滚的事务），再用新数据库替换原数据库，如此达到释放空间的目的（该方案同样适用于数据库版本升级）。（当然也可以用时间字段过滤出增量数据）</p>
<hr />
<p>常见问题：</p>
<ol type="1">
<li><p>当自增主键报 <code>duplicate key value violates unique constraint</code> 主键冲突时，一般是因为存在手动分配 id 的数据（复制表或着手动插入分配了 id），自增主键 seqence TABLE_COLUMN_seq 没有更新，新插入一个值自增 id 和数据库已插入的分配 id 冲突，此时需要执行 <code>SELECT setval('TABLE_COLUMN_seq', (SELECT max(COLUMN) FROM "TABLE"))</code> 更新自增主键;</p></li>
<li><p>分析 sql 性能时，可在 sql 语句前增加 <code>EXPLAIN</code> 关键字，查看执行计划，EXPLAIN 一般不会实际执行 sql，但 sql 中带有子语句时，子语句可能会执行，所以为保险起见，最好是在事务中使用 EXPLAIN；eg:</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SQL"><div class="code-copy"></div><figure class="highlight hljs sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">begin</span>;</span><br><span class="line">EXPLAIN <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> table1 <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="keyword">rollback</span>;</span><br></pre></td></tr></table></figure></div>
<p>若要分析实际执行时间，可以使用 EXPLAIN ANALYZE，<em>该选项会实际执行 SQL</em>，也可以组合参数一起分析执行命令 <code>explain (analyze,verbose,costs,buffers,timing) select * from table1 where id=1;</code>。</p></li>
<li><p>如果业务数据无法直接使用批量写入数据库，就最好在一个事务中写入（当然也得看数据量），在同一个事务中写入，不仅能利用事务本身的 ACID 特性，而且比单独分次执行 sql 效率更高；</p></li>
<li><p>PG 数据库中，如果要使用 order 排序查询时，一般带主键的复合索引比单个字段索引更有效，因为 PG 数据在数据更新后，一般会乱序存储，导致单字段索引在查询时需要访问的页面会更多；</p></li>
<li><p>PG 刚创建/删除索引后，不一定会及时生效，需要数据库运行一段时间后才会开始生效，如需要立即生效，可执行 <code>ANALYZE VERBOSE table_name;</code>命令，离线或者低负载的时候可以执行 <code>VACUUM VERBOSE ANALYZE table_name</code>，清理表的同时更新统计信息，得到更好的 SQL 执行计划。</p></li>
</ol>
<h2 id="后记">后记</h2>
<p>　　后面持续更新。。。</p>
]]></content>
      <categories>
        <category>Wiki</category>
      </categories>
      <tags>
        <tag>note</tag>
        <tag>unix-like</tag>
      </tags>
  </entry>
  <entry>
    <title>Matlab和OpenCV混合编程小结</title>
    <url>/posts/64889158.html</url>
    <content><![CDATA[<p><font color=#FA8072>本文所用的 Matlab 版本为 Matlab R2017b，OpenCV 版本为 opencv-3.4.3，C++ IDE 为 Visual Studio 2017，系统环境为 Windows 10_x64。</font></p>
<h2 id="前言">前言</h2>
<p>　　秋招告一段落了，又要回到最初的起点，继续搞（qu）科（hua）研（shui）了，由于前人的代码主要是用 C++ 和 Matlab 混编实现的，而 Shaun 比较熟悉的是 C++ 和 OpenCV，而用 OpenCV 完全重写前人的代码工作量又太大了而且有些 API 不是很好互换，为了方便站在巨人的肩膀上继续前进，所以只能学习一下 OpenCV 和 Matlab 的混合编程了，这样在前人的基础上实现 Shaun 自己的想法相对来说更容易一些。</p>
<span id="more"></span>
<h2 id="准备篇">准备篇</h2>
<p>　　由于目前主要用 C++ 实现的是一些小功能，也不需要调试，所以就直接使用 VSCode 进行编程了（或许以后还是会用 VS 进行一些简单的调试），而在没有配置相关环境的前提下，VSCode 无法实现自动补全，所以需要在 VSCode 中配置相应环境。具体添加方法如下：在 VSCode 中点击菜单栏 “<strong>查看</strong>” ==》“<strong>命令面板...</strong>” ==》选择 “<strong>C/Cpp: Edit Configurations...</strong>”==》在出现的 <code>c_cpp_properties.json</code> 文件中 <code>"includePath"</code> 对应的值中添加 OpenCV 的 include 目录和 Matlab 的 include 目录，添加之后的 <code>"includePath"</code> 如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="JSON"><div class="code-copy"></div><figure class="highlight hljs json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">&quot;includePath&quot;</span>: [</span><br><span class="line">	<span class="string">&quot;$&#123;workspaceFolder&#125;/**&quot;</span></span><br><span class="line">	, <span class="string">&quot;D:/ProgramFiles/OpenCV/3.4.3/build/include/**&quot;</span></span><br><span class="line">	, <span class="string">&quot;C:/Program Files/MATLAB/R2017b/extern/include/**&quot;</span></span><br><span class="line">]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>如此就能在 VSCode 中写 OpenCV 和 Matlab 相关函数时实现自动补全了。</p>
<h2 id="matlab-和-c-混编篇">Matlab 和 C++ 混编篇</h2>
<p>　　由于 Shaun 使用的是 OpenCV 的 C++ 接口，所以需要先知道 Matlab 和 C++ 混合编程如何进行。以实现两个数的加法为例，首先创建一个 mexAdd.cpp 文件，其中 C++ 代码具体如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mex.h&gt;</span>    <span class="comment">// 必须包含头文件 mex.h</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查输入是否合法</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">checkInputs</span><span class="params">(<span class="keyword">int</span> nrhs, <span class="keyword">const</span> mxArray *prhs[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (nrhs != <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">mexErrMsgTxt</span>(<span class="string">&quot;Incorrect number of inputs. Function expects 2 inputs.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">mxIsDouble</span>(prhs[<span class="number">0</span>]))</span><br><span class="line">    &#123;       </span><br><span class="line">        <span class="built_in">mexErrMsgTxt</span>(<span class="string">&quot;Input number must be double.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">add</span><span class="params">(<span class="keyword">double</span> x, <span class="keyword">double</span> y)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x + y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * nlhs：matlab 函数左边变量个数，即返回值参数个数</span></span><br><span class="line"><span class="comment"> * plhs： matlab 函数左边变量，即返回值参数</span></span><br><span class="line"><span class="comment"> * nrhs： matlab 右边变量个数，即函数输入参数个数</span></span><br><span class="line"><span class="comment"> * prhs： matlab 函数右边变量，即函数输入参数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mexFunction</span><span class="params">(<span class="keyword">int</span> nlhs, mxArray *plhs[], <span class="keyword">int</span> nrhs, <span class="keyword">const</span> mxArray *prhs[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">checkInputs</span>(nrhs, prhs);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输入参数可以不使用指针，但输出参数必须使用指针</span></span><br><span class="line">    <span class="keyword">double</span> *a = <span class="literal">nullptr</span>;    <span class="comment">// 输出参数</span></span><br><span class="line">    <span class="keyword">double</span> b = <span class="number">0.0</span>, c = <span class="number">0.0</span>;    <span class="comment">// 两个输入参数</span></span><br><span class="line">    plhs[<span class="number">0</span>] = <span class="built_in">mxCreateDoubleMatrix</span>(<span class="number">1</span>, <span class="number">1</span>, mxREAL);   <span class="comment">// 创建1x1的实数矩阵用作输出第一个参数</span></span><br><span class="line">    a = <span class="built_in">mxGetPr</span>(plhs[<span class="number">0</span>]);  <span class="comment">// 用指针a指向第一个输出</span></span><br><span class="line">    b = *(<span class="built_in">mxGetPr</span>(prhs[<span class="number">0</span>]));   <span class="comment">// b作为第一个输入</span></span><br><span class="line">    c = *(<span class="built_in">mxGetPr</span>(prhs[<span class="number">1</span>]));   <span class="comment">// c作为第二个输入</span></span><br><span class="line">    *a = <span class="built_in">add</span>(b, c); <span class="comment">// 计算b、c之和得到a</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>　　若要使用 Matlab 混合编译 C++，必须要添加头文件 <code>mex.h</code>，使用 <code>void mexFunction(int nlhs, mxArray *plhs[], int nrhs, const mxArray *prhs[])</code> 函数接收输入输出参数，如此编译完成之后，就和使用普通的 Matlab 函数一样了。具体编译调用方法如下，新建 addTest.m 文件，其中 Matlab 代码如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="MATLAB"><div class="code-copy"></div><figure class="highlight hljs matlab"><table><tr><td class="code"><pre><span class="line">clc, clear, close all;  <span class="comment">% 清空变量和关闭所有打开窗口</span></span><br><span class="line"></span><br><span class="line">current_folder = pwd;   <span class="comment">% 获取当前文件路径</span></span><br><span class="line">addpath(genpath(current_folder));    <span class="comment">% 添加matlab临时搜索路径，并包含子文件夹（matlab退出后该路径不存在）</span></span><br><span class="line"></span><br><span class="line">mex mexAdd.cpp; <span class="comment">% 混合编译C++，得到matlab可识别的函数</span></span><br><span class="line"></span><br><span class="line">a = <span class="number">3.1</span>; b = <span class="number">2.6</span>;</span><br><span class="line">c = mexAdd(a, b);</span><br></pre></td></tr></table></figure></div>
<p>其中 <code>mex mexAdd.cpp</code> 可以直接在 Matlab 命令行窗口下预先执行编译动作，编译成功后会输出一个 mexAdd.mexw64 文件，若是 32 位系统则后缀为 mexw32，之后直接执行 <code>ans = mexAdd(3.1, 2.6);</code> 即可在 Matlab 中调用该函数。在 Matlab 首次执行 mex 命令时，Matlab 会自动选择 VS 编译器作为默认 C++ 编译器，也可以执行 <code>mex -setup</code> 初始化或更换默认编译器。</p>
<p><strong>BTW：</strong> 最好在安装 Matlab 之前安装 Visual Studio，否则使用 <code>mex</code> 编译时，可能会出现找不到编译器的情况。</p>
<h2 id="matlab-和-opencv-混编篇">Matlab 和 OpenCV 混编篇</h2>
<p>　　Matlab 和 OpenCV 混编大体上和 C++ 混编差不多，最大的区别在于如何利用 OpenCV 的 cv::Mat 对象和相关的库函数，Matlab 良心的提供了 OpenCV 接口以实现 mexArray 和 cv::Mat 格式之间的互相转化，使用这些接口需要包含头文件 <code>opencvmex.hpp</code> 。如果不使用 Matlab 提供的这些接口而是自己写转换过程的话有点麻烦，因为 Matlab 的数据是以列优先方式存储的，而 OpenCV 的数据是以行优先方式存储的。至于如何进行混编，主要有以下三种方式：</p>
<ol type="1">
<li>第一种是自己写 make.m 文件，相当于 gcc 编译时需要的 Makefile 文件，需要手动拼接各种编译命令和添加相应的附加依赖库；</li>
<li>第二种是通过 Matlab 官方提供的 <a href="http://cn.mathworks.com/help/vision/ug/opencv-interface.html">Computer Vision System Toolbox OpenCV Interface</a> 功能，Matlab 没有默认安装该功能，这个功能需要另外安装，具体安装方法为：在 Matlab 命令行窗口输入 <code>visionSupportPackages</code>，即可弹出“<strong>附加功能资源管理器</strong>”窗口选择对应附加功能安装即可，安装完之后可通过 <code>mexOpenCV</code> 命令对包含 OpenCV 库函数的 .cpp 文件进行编译，查看 mexOpenCV.m 的源码可知，<code>mexOpenCV</code> 其实是对 <code>mex</code> 命令进行了封装，其调用的 OpenCV 库也是其工具箱自带的 OpenCV，而且有些库还没有包含，有一定的局限性，不过该附加功能自带了些示例程序，可以参考学习一下；</li>
<li>第三种是使用第三方的 <a href="https://github.com/kyamagu/mexopencv">mexopencv</a>，不过需要安装与该工具对应的 OpenCV 版本，并需要进行一定的配置工作，略显麻烦。</li>
</ol>
<p>　　Shaun 这里直接使用的是第一种方式，自己写 make.m 文件，比较灵活，想怎么配置就怎么配置。下面具体以 RGB 转 GRAY 为例，首先新建 mexRGB2GRAY.cpp，其中 C++ 代码如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencvmex.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _DO_NOT_EXPORT</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(_DO_NOT_EXPORT)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DllExport  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DllExport __declspec(dllexport)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Usage: [img_matrix] = mexRGB2GRAY(&#x27;img.jpg&#x27;);</span></span><br><span class="line"><span class="comment"> * Input: a image file;</span></span><br><span class="line"><span class="comment"> * Output: a matrix of image which can be read by Matlab</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查输入是否合法</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">checkInputs</span><span class="params">(<span class="keyword">int</span> nrhs, <span class="keyword">const</span> mxArray *prhs[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (nrhs != <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">mexErrMsgTxt</span>(<span class="string">&quot;Incorrect number of inputs. Function expects 1 inputs.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">mxGetNumberOfDimensions</span>(prhs[<span class="number">0</span>]) != <span class="number">3</span>) <span class="comment">// 获取Matlab图像总的维度个数（灰度图为2维，RGB彩色图为3维）</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">mexErrMsgTxt</span>(<span class="string">&quot;Incorrect number of dimensions. First input must be a RGB image.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查图像数据类型</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">mxIsUint8</span>(prhs[<span class="number">0</span>]))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">mexErrMsgTxt</span>(<span class="string">&quot;Template and image must be UINT8.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">exit_with_help</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">mexPrintf</span>(<span class="string">&quot;Uasge: [image_matrix] = mexRGB2GRAY(&#x27;image_file.jpg&#x27;);\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fakeAnswer</span><span class="params">(mxArray *plhs[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    plhs[<span class="number">0</span>] = <span class="built_in">mxCreateNumericMatrix</span>(<span class="number">0</span>, <span class="number">0</span>, mxDOUBLE_CLASS, mxREAL);  <span class="comment">// 创建一个0x0的空双精度matlab矩阵</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">cv::Mat <span class="title">RGB2GRAY</span><span class="params">(<span class="keyword">const</span> mxArray *prhs[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cv::Ptr&lt;cv::Mat&gt; img_cv = <span class="built_in">ocvMxArrayToMat_uint8</span>(prhs[<span class="number">0</span>], <span class="literal">true</span>);   <span class="comment">// 将unit8数据类型的matlab矩阵转换为OpenCV的mat对象智能指针</span></span><br><span class="line">    <span class="keyword">if</span> (img_cv.<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> cv::Mat_&lt;<span class="keyword">double</span>&gt;(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将RGB转化为GRAY图</span></span><br><span class="line">    <span class="function">cv::Mat <span class="title">gray</span><span class="params">((*img_cv).size(), CV_8UC1)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> ((*img_cv).<span class="built_in">channels</span>() == <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cv::<span class="built_in">cvtColor</span>(*img_cv, gray, CV_RGB2GRAY);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>((*img_cv).<span class="built_in">channels</span>() == <span class="number">4</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cv::<span class="built_in">cvtColor</span>(*img_cv, gray, CV_RGBA2GRAY);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        (*img_cv).<span class="built_in">copyTo</span>(gray);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> gray;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mexFunction</span><span class="params">(<span class="keyword">int</span> nlhs, mxArray *plhs[], <span class="keyword">int</span> nrhs, <span class="keyword">const</span> mxArray *prhs[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">checkInputs</span>(nrhs, prhs);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nrhs == <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cv::Mat gray = <span class="built_in">RGB2GRAY</span>(prhs);</span><br><span class="line">        plhs[<span class="number">0</span>] = <span class="built_in">ocvMxArrayFromMat_uint8</span>(gray);   <span class="comment">// 将unit8数据类型的OpenCV的mat对象转换为matlab矩阵</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">exit_with_help</span>();</span><br><span class="line">        <span class="built_in">fakeAnswer</span>(plhs);</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>然后新建 makefile.m 文件，自己配置相关编译环境， Shaun 这里具体如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="MATLAB"><div class="code-copy"></div><figure class="highlight hljs matlab"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makefile</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">% 选择相应计算机系统版本</span></span><br><span class="line">    is_64bit = strcmp(computer, <span class="string">&#x27;MACI64&#x27;</span>) || strcmp(computer, <span class="string">&#x27;GLNXA64&#x27;</span>) || strcmp(computer, <span class="string">&#x27;PCWIN64&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">% 配置OpenCV编译环境，如果系统是64位的，则OpenCV也需要是64位的</span></span><br><span class="line">    out_dir = <span class="string">&#x27;.&#x27;</span>; <span class="comment">% 输出目录,这里为当前目录</span></span><br><span class="line">    CPPFLAGS = <span class="string">&#x27; -O -DNDEBUG -I./ -ID:/ProgramFiles/OpenCV/3.4.3/build/include&#x27;</span>; <span class="comment">% OpenCV “include” 目录</span></span><br><span class="line">    LDFLAGS = <span class="string">&#x27; -LD:/ProgramFiles/OpenCV/3.4.3/build/x64/vc15/lib -LC:/PROGRA~1/MATLAB/R2017b/extern/lib/win64/microsoft&#x27;</span>;  <span class="comment">% OpenCV “lib” 目录 和 MatLab 附加库目录</span></span><br><span class="line">    LIBS = <span class="string">&#x27; -lopencv_world343 -lmwocvmex&#x27;</span>; <span class="comment">% 添加OpenCV相关库和Matlab libmwocvmex.lib库</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> is_64bit</span><br><span class="line">        CPPFLAGS = [CPPFLAGS <span class="string">&#x27; -largeArrayDims&#x27;</span>];</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">% 需要编译的 cpp 文件</span></span><br><span class="line">    compile_files = &#123;</span><br><span class="line">        <span class="string">&#x27;mexRGB2GRAY.cpp&#x27;</span></span><br><span class="line">        <span class="string">&#x27;mexAdd.cpp&#x27;</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">% 开始编译</span></span><br><span class="line">    <span class="keyword">for</span> k = <span class="number">1</span> : <span class="built_in">length</span>(compile_files)</span><br><span class="line">        str = compile_files&#123;k&#125;;</span><br><span class="line">        fprintf(<span class="string">&#x27;compilation of: %s\n&#x27;</span>, str);</span><br><span class="line">        str = [str <span class="string">&#x27; -outdir &#x27;</span> out_dir CPPFLAGS LDFLAGS LIBS];</span><br><span class="line">        args = regexp(str, <span class="string">&#x27;\s+&#x27;</span>, <span class="string">&#x27;split&#x27;</span>);</span><br><span class="line">        mex(args&#123;:&#125;);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></div>
<p>其中 Matlab 配置路径中的 <code>PROGRA~1</code> 是指 Windows 下的 C 盘中的 Program Files 文件夹，为了使用 Matlab 提供的转换接口，<code>libmwocvmex.lib</code> 是必须要添加的一个库。最后具体使用示例 Matlab 代码如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="MATLAB"><div class="code-copy"></div><figure class="highlight hljs matlab"><table><tr><td class="code"><pre><span class="line">clc, clear, close all;  <span class="comment">% 清空变量和关闭所有打开窗口</span></span><br><span class="line"></span><br><span class="line">current_folder = pwd;   <span class="comment">% 获取当前文件路径</span></span><br><span class="line">addpath(genpath(current_folder));    <span class="comment">% 添加matlab临时搜索路径，并包含子文件夹（matlab退出后该路径不存在）</span></span><br><span class="line"></span><br><span class="line">makefile();</span><br><span class="line"></span><br><span class="line">image = imread(<span class="string">&#x27;lena.jpg&#x27;</span>);</span><br><span class="line"></span><br><span class="line">I = mexRGB2GRAY(image);</span><br><span class="line"><span class="built_in">figure</span>, imshow(I);</span><br></pre></td></tr></table></figure></div>
<p>也可以将 <code>makefile();</code> 函数预先执行。<strong>※注：</strong> <em>这里如果出现编译报错 “<font color=#FA8072>缺少依赖共享库</font>” 的情况可能还需要把 OpenCV 的 bin 目录加到系统环境变量 Path 中，Shaun 这里是路径 <code>D:\ProgramFiles\OpenCV\3.4.3\build\x64\vc15\bin</code>，然后重启 Matlab</em>。</p>
<h2 id="调试篇">调试篇</h2>
<p>　　若要对写的 mexAdd.cpp 文件进行调试，则需要</p>
<ol type="1">
<li><p>先使用 <code>mex -g mexAdd.cpp</code> 编译该文件，由于添加了 -g 参数，此时除了会生成 mexAdd.mexw64 文件之外，还会生成一个 mexAdd.mexw64.pdb 文件，该文件即包含调试信息；</p></li>
<li><p>然后在相应 .m 文件中调用 mexAdd 函数的位置设置断点，运行该相关文件，matlab 程序会在调用 mexAdd 函数之前停下；</p></li>
<li><p>此时使用 VS2017 打开 mexAdd.cpp 文件，在需要调试的地方设置好断点，选中菜单栏中的“<strong>调试</strong>” ==》“<strong>附加到进程</strong> ”，或者直接点击菜单栏上的<strong><em>绿色三角</em> 附加...</strong>，选中 <strong>MATLAB.exe</strong> ，点击附加，即可看到 VS2017 调试程序已启动；</p></li>
<li><p>最后回到 matlab 中继续运行相关文件，即可看到程序跳转到 VS2017，并执行到设置断点的地方，此时即可在 VS2017 中按调试 C++ 程序一样对其进行调试。</p></li>
</ol>
<p>　　完成调试并执行完 mexAdd.cpp 之后，程序将回到 matlab 界面继续执行，直到整个 matlab 程序执行完成。</p>
<h2 id="后记">后记</h2>
<p>　　这次主要是记录 Matlab 如何调用 C++ 编写的函数，其实还可以用 C++ 调用 Matlab 编写的函数，不过那是另一种混编方式了，以后有机会碰到的话再继续记录吧。</p>
<h2 id="参考资料">参考资料</h2>
<p>[１] <a href="https://blog.csdn.net/zouxy09/article/details/20553007">Matlab与C++混合编程（依赖OpenCV）</a></p>
<p>[２] <a href="https://ww2.mathworks.cn/help/matlab/matlab_external/changing-default-compiler.html">更改默认编译器</a></p>
<p>[３] <a href="http://www.mathworks.com/help/vision/opencv-interface-support-package.html">OpenCV Interface Support</a></p>
<p>[４] <a href="https://blog.csdn.net/linzhineng44/article/details/51646765">Matlab OpenCV混合编程</a></p>
<p>[５] <a href="http://blog.sina.com.cn/s/blog_620b47660100h3yn.html">vc与matlab连接的实用函数简介</a></p>
]]></content>
      <categories>
        <category>Study</category>
      </categories>
      <tags>
        <tag>matlab</tag>
        <tag>opencv</tag>
      </tags>
  </entry>
  <entry>
    <title>OpenCV中Selective Search算法的使用</title>
    <url>/posts/35132cb7.html</url>
    <content><![CDATA[<p><font color=#FA8072>本文所用的 OpenCV 版本为 opencv-3.2.0，编程语言为 C++。</font></p>
<h2 id="前言">前言</h2>
<p>　　OpenCV-3.2 中的 Selective Search 算法是在其扩展包中，所以要想使用该算法需自行编译 opencv_contrib-3.2.0。由于扩展包中的示例程序有点简陋，对初学者也不友好（Shaun 编程水平有限，粗浅评价，勿怪 (*^__^ *) 嘻嘻……），所以 Shaun 参考其<a href="http://docs.opencv.org/3.2.0/d5/df0/group__ximgproc__segmentation.html">官方文档</a>及其<a href="https://github.com/opencv/opencv_contrib/blob/master/modules/ximgproc/samples/selectivesearchsegmentation_demo.cpp">官方示例程序</a>写下此文。</p>
<span id="more"></span>
<h2 id="说明篇">说明篇</h2>
<p>　　该算法是选取 region proposal（一般翻译成候选区域 / 区域建议）领域中当时的 <em>state-of-the-art</em>。其算法具体思想出自 <strong>Jasper RR Uijlings, Koen EA van de Sande, Theo Gevers, and Arnold WM Smeulders. Selective search for object recognition. <em>International journal of computer vision</em>, 104(2):154–171, 2013.</strong>，若英文水平不够，还想了解其中文思想请参考文末参考资料。</p>
<p>　　<strong>OpenCV中实现的相应函数：</strong></p>
<p><code>void cv::ximgproc::segmentation::SelectiveSearchSegmentation::addGraphSegmentation(Ptr&lt;GraphSegmentation&gt; g);</code>：添加相应的图割算法；</p>
<p><code>void cv::ximgproc::segmentation::SelectiveSearchSegmentation::addImage(InputArray img) ;</code> ：添加待处理的图片；</p>
<p><code>void cv::ximgproc::segmentation::SelectiveSearchSegmentation::addStrategy(Ptr&lt;SelectiveSearchSegmentationStrategy&gt; s);</code> ：添加相应的策略（颜色相似度、纹理相似度、尺寸相似度和填充相似度）；</p>
<p><code>void cv::ximgproc::segmentation::SelectiveSearchSegmentation::process(std::vector&lt;Rect&gt; &amp;rects);</code>：结合图割算法和相应策略进行处理，返回候选框。</p>
<h2 id="实例篇">实例篇</h2>
<p>　　使用 Selective Search 算法需包含<code>#include &lt;opencv2/ximgproc.hpp&gt;</code>，完整示例程序如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/opencv.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/ximgproc.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SSTest</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// [Image segmentation](http://docs.opencv.org/3.2.0/d5/df0/group__ximgproc__segmentation.html#ga5e3e721c5f16e34d3ad52b9eeb6d2860) </span></span><br><span class="line"></span><br><span class="line">	cv::Mat src_img = cv::<span class="built_in">imread</span>(<span class="string">&quot;../data/true.png&quot;</span>, CV_LOAD_IMAGE_ANYDEPTH | CV_LOAD_IMAGE_ANYCOLOR);	<span class="comment">// 载入原始图像</span></span><br><span class="line">	cv::<span class="built_in">namedWindow</span>(<span class="string">&quot;src_img&quot;</span>, CV_WINDOW_KEEPRATIO);</span><br><span class="line">	cv::<span class="built_in">imshow</span>(<span class="string">&quot;src_img&quot;</span>, src_img);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//// 转换为灰度图</span></span><br><span class="line">	<span class="comment">//cv::Mat gray_img;</span></span><br><span class="line">	<span class="comment">//cvtColor(src_img, gray_img, cv::COLOR_BGR2GRAY);</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 图割算法</span></span><br><span class="line">	cv::Ptr&lt;cv::ximgproc::segmentation::GraphSegmentation&gt; gs = cv::ximgproc::segmentation::<span class="built_in">createGraphSegmentation</span>();</span><br><span class="line">	cv::Mat graph_segmented;</span><br><span class="line">	gs-&gt;<span class="built_in">processImage</span>(src_img, graph_segmented);</span><br><span class="line">	<span class="built_in">normalize</span>(graph_segmented, graph_segmented, <span class="number">0</span>, <span class="number">255</span>, CV_MINMAX); <span class="comment">// 归一化到[0,255]供显示</span></span><br><span class="line">	graph_segmented.<span class="built_in">convertTo</span>(graph_segmented, CV_8U); <span class="comment">// 数据类型转化成CV_8U型</span></span><br><span class="line">	<span class="comment">// cvtColor(graph_segmented, graph_segmented, CV_GRAY2BGR);</span></span><br><span class="line">	cv::<span class="built_in">namedWindow</span>(<span class="string">&quot;graph_segmented&quot;</span>, CV_WINDOW_KEEPRATIO);</span><br><span class="line">	<span class="built_in">imshow</span>(<span class="string">&quot;graph_segmented&quot;</span>, graph_segmented);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 为selective search算法添加图割算法处理结果</span></span><br><span class="line">	cv::Ptr&lt;cv::ximgproc::segmentation::SelectiveSearchSegmentation&gt; ss = cv::ximgproc::segmentation::<span class="built_in">createSelectiveSearchSegmentation</span>();</span><br><span class="line">	ss-&gt;<span class="built_in">addGraphSegmentation</span>(gs);</span><br><span class="line"></span><br><span class="line">	ss-&gt;<span class="built_in">addImage</span>(src_img);	<span class="comment">// 添加待处理的图片</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 自定义策略</span></span><br><span class="line">	cv::Ptr&lt;cv::ximgproc::segmentation::SelectiveSearchSegmentationStrategy&gt; sss_color = cv::ximgproc::segmentation::<span class="built_in">createSelectiveSearchSegmentationStrategyColor</span>();	<span class="comment">// 颜色相似度策略</span></span><br><span class="line">	cv::Ptr&lt;cv::ximgproc::segmentation::SelectiveSearchSegmentationStrategy&gt; sss_texture = cv::ximgproc::segmentation::<span class="built_in">createSelectiveSearchSegmentationStrategyTexture</span>();	<span class="comment">// 纹理相似度策略</span></span><br><span class="line">	cv::Ptr&lt;cv::ximgproc::segmentation::SelectiveSearchSegmentationStrategy&gt; sss_size = cv::ximgproc::segmentation::<span class="built_in">createSelectiveSearchSegmentationStrategySize</span>();	<span class="comment">// 尺寸相似度策略</span></span><br><span class="line">	cv::Ptr&lt;cv::ximgproc::segmentation::SelectiveSearchSegmentationStrategy&gt; sss_fill = cv::ximgproc::segmentation::<span class="built_in">createSelectiveSearchSegmentationStrategyFill</span>();	<span class="comment">// 填充相似度策略</span></span><br><span class="line">	<span class="comment">// 添加策略</span></span><br><span class="line">	cv::Ptr&lt;cv::ximgproc::segmentation::SelectiveSearchSegmentationStrategy&gt; sss = cv::ximgproc::segmentation::<span class="built_in">createSelectiveSearchSegmentationStrategyMultiple</span>(sss_color, sss_texture, sss_size, sss_fill);	<span class="comment">// 合并以上4种策略</span></span><br><span class="line">	ss-&gt;<span class="built_in">addStrategy</span>(sss);</span><br><span class="line"></span><br><span class="line">	std::vector&lt;cv::Rect&gt; regions;</span><br><span class="line">	ss-&gt;<span class="built_in">process</span>(regions);	<span class="comment">// 处理结果</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 显示结果</span></span><br><span class="line">	cv::Mat show_img = src_img.<span class="built_in">clone</span>();</span><br><span class="line">	<span class="keyword">for</span> (std::vector&lt;cv::Rect&gt;::iterator it_r = regions.<span class="built_in">begin</span>(); it_r != regions.<span class="built_in">end</span>(); ++it_r)</span><br><span class="line">	&#123;</span><br><span class="line">		cv::<span class="built_in">rectangle</span>(show_img, *it_r, cv::<span class="built_in">Scalar</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>), <span class="number">3</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	cv::<span class="built_in">namedWindow</span>(<span class="string">&quot;show_img&quot;</span>, CV_WINDOW_KEEPRATIO);</span><br><span class="line">	<span class="built_in">imshow</span>(<span class="string">&quot;show_img&quot;</span>, show_img);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">// -------忽略上述步骤，直接采用方便算法提取候选区域------------------------</span></span><br><span class="line">	<span class="comment">/***************************************************************************</span></span><br><span class="line"><span class="comment">	cv::Ptr&lt;cv::ximgproc::segmentation::SelectiveSearchSegmentation&gt; ss = cv::ximgproc::segmentation::createSelectiveSearchSegmentation();</span></span><br><span class="line"><span class="comment">	ss-&gt;setBaseImage(src_img);	// 采用switch* functions提取候选区域</span></span><br><span class="line"><span class="comment">	ss-&gt;switchToSelectiveSearchFast();	// 快速提取区域</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	std::vector&lt;cv::Rect&gt; rects;</span></span><br><span class="line"><span class="comment">	ss-&gt;process(rects);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	int nb_rects = 10;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	char c = (char)cv::waitKey();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	while (c != &#x27;q&#x27;)</span></span><br><span class="line"><span class="comment">	&#123;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">		cv::Mat wimg = src_img.clone();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">		int i = 0;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">		for (std::vector&lt;cv::Rect&gt;::iterator it = rects.begin(); it != rects.end(); ++it)</span></span><br><span class="line"><span class="comment">		&#123;</span></span><br><span class="line"><span class="comment">			if (i++ &lt; nb_rects)</span></span><br><span class="line"><span class="comment">			&#123;</span></span><br><span class="line"><span class="comment">				cv::rectangle(wimg, *it, cv::Scalar(0, 0, 255), 3);</span></span><br><span class="line"><span class="comment">			&#125;</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">		cv::namedWindow(&quot;Output&quot;, CV_WINDOW_KEEPRATIO);</span></span><br><span class="line"><span class="comment">		imshow(&quot;Output&quot;, wimg);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">		c = (char)cv::waitKey();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">		if (c == &#x27;d&#x27;)</span></span><br><span class="line"><span class="comment">		&#123;</span></span><br><span class="line"><span class="comment">			nb_rects += 10;</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">		if (c == &#x27;a&#x27; &amp;&amp; nb_rects &gt; 10)</span></span><br><span class="line"><span class="comment">		&#123;</span></span><br><span class="line"><span class="comment">			nb_rects -= 10;</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	********************************************************/</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">SSTest</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (cv::<span class="built_in">waitKey</span>(<span class="number">0</span>) != <span class="number">27</span>) &#123;&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p><em>以上代码在 Win10 VS2013 中编译运行成功。</em></p>
<h2 id="后记">后记</h2>
<p>　　使用该算法，要想达到理想效果，一般需要调整图割算法的参数或注释中方法 <code>switchToSelectiveSearchFast()</code> 的参数。Shaun 的这次实验为了达到理想的选取的效果，其调整参数花了不少时间，而且该算法运行时间在 Shaun 电脑上略显长。GitHub 上也有大神自己用 opencv 实现了该算法，参考 <a href="https://github.com/watanika/selective-search-cpp">watanika/selective-search-cpp</a>，该算法的参数感觉比 OpenCV 自带的 Selective Search 算法要好调一些，但优化效果没有 opencv 好，其运行时间在 Shaun 电脑上更长，毕竟 OpenCV 是 Intel 的亲儿子，Intel 肯定针对处理器对 OpenCV 底层做了一定的优化。</p>
<h2 id="参考资料">参考资料</h2>
<p>[1] <a href="http://jermmy.xyz/2017/05/04/2017-5-4-paper-notes-selective-search/">论文笔记：Selective Search for Object Recognition</a>（<a href="http://jermmy.xyz/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89/" class="uri">http://jermmy.xyz/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89/</a>）</p>
<p>[2] <a href="http://blog.csdn.net/langb2014/article/details/52575507">Selective Search for Object Recognition(阅读)</a>（<a href="http://blog.csdn.net/langb2014/article/category/5772811" class="uri">http://blog.csdn.net/langb2014/article/category/5772811</a>）</p>
<p>[3] <a href="http://blog.csdn.net/csyhhb/article/details/50425114">论文笔记 《Selective Search for Object Recognition》</a>（<a href="http://blog.csdn.net/csyhhb/article/category/6048588" class="uri">http://blog.csdn.net/csyhhb/article/category/6048588</a>）</p>
]]></content>
      <categories>
        <category>Image&amp;Graphic</category>
      </categories>
      <tags>
        <tag>opencv</tag>
        <tag>cv</tag>
      </tags>
  </entry>
  <entry>
    <title>MyThoughts</title>
    <url>/posts/17017530.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　本篇主要用来记录 Shaun 的心路历程。</p>
<span id="more"></span>
<h2 id="thoughts">Thoughts</h2>
<table>
<colgroup>
<col style="width: 14%" />
<col style="width: 85%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">日期</th>
<th style="text-align: center;">Thought</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">2024-10-19</td>
<td style="text-align: center;">纵观全书，对中国人性的理解非常透彻，回顾中国历史和现状，中国人民的几千年来直至现在的生活方式并没有本质变化，暴力掌控者就是话事人，社会并行两套规则，很多时候台面下的规则才是生存之道，一切政策以稳定为前提，客观的好坏无意义，个人无保障，洋人至上，内斗内行，外邦和家奴区分明显，小家如此，大家如此，社会如此；<br/>利于执行者的政策才更容易推动，反之对执行者利益有损的政策难以推动甚至导致失败；<br/>代理人也是个很有意思的社会现象，中介临时工二房东等，每人都有自己的利场；<br/>事实本身并不重要，重要的是信息筛选者的偏好；<br/>中国农民的天然弱点在于善分不善合，又何止于农民，当然很多人也都期待有圣主领导；<br/>哪都不缺别扭人，就是要借着集体利益多捞一把；<br/>——读《血酬定律》</td>
</tr>
<tr class="even">
<td style="text-align: center;">2024-03-19</td>
<td style="text-align: center;">这才是爽片，没想到十几年前的片到现在还这么有现实意义。——观《上帝保佑美国》</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2023-05-01</td>
<td style="text-align: center;">人们喜欢说三道四，你需要决定相信自己的眼睛和耳朵，还是别人的话。<br /> 你不能总是相信别人说的话。<br /> 如果生活中的某件事带给你快乐，你只需要去做它就行，不要别人说什么。<br />——《海蒂与爷爷》 <br /> 所谓的风景，就是从来没亲身体验过的东西。——观《海蒂与爷爷》</td>
</tr>
<tr class="even">
<td style="text-align: center;">2022-09-04</td>
<td style="text-align: center;">人世间最痛苦的莫过于拥有后又失去。——观《隐入尘烟》</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2022-04-17</td>
<td style="text-align: center;">1. 如果某样东西是免费的，那商品就是使用这样东西的人。<br /> 2. 技术滥用的最大毒瘤——推荐算法。<br />——观《The Social Dilemma》</td>
</tr>
<tr class="even">
<td style="text-align: center;">2022-04-09</td>
<td style="text-align: center;">经济是一群人的行为，单个人无法预测，一群人却比较好预测。收入分配的例子也很有意思，群体可支配收入取决于个人的最差收入情况。对于不平等和税收的阐述确实比较深刻，继承体现了最大的不平等。——观《Paul Krugman 经济学大师课》</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2022-03-30</td>
<td style="text-align: center;">日剧中的逆转还是那么爽，万众一心，绝处逢生，虽说现实中这种公司大部分会过的比较艰难，不过这也是 Shaun 比较理想的上班环境了。——观《罗斯福游戏》</td>
</tr>
<tr class="even">
<td style="text-align: center;">2022-03-16</td>
<td style="text-align: center;">mapping井字棋，机场内系鞋带的例子都很有意思，数学和其他学科，甚至数学本身代数几何之间的联系比喻成风景城市非常精妙，数学游戏最不怕的就是失败，可以无代价的反复多次重来。数学思维就是洞察解构逆反抽象类比转换，最直接的体现就是核酸群体测试。——观《陶哲轩数学思维大师课》</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2022-02-21</td>
<td style="text-align: center;">善用零碎时间汲取新知识。柳比歇夫的工作哲学也很有意思：1、不承担必须完成的任务；2、不接受紧急的任务；3、一累就马上停止工作去休息；4、睡十小时左右；5、工作有张有驰。只可惜这是大师才有的特权了，普通人哪有拒绝的权利，一般都只能被动无奈接受。——读《奇特的一生》</td>
</tr>
<tr class="even">
<td style="text-align: center;">2022-02-03</td>
<td style="text-align: center;">步入世俗，终将被染，人生无常，纵有初心也无奈。——观《香火》</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2020-04-09</td>
<td style="text-align: center;">有 1984 那味了，甚至更可怖，设定有趣，但剧情漏洞百出，不过说不好这样的事情马上就会发生，可以简单设想一下，在微信聊天记录可作为证据的今天，若腾讯被黑或主动或被动作恶，直接伪造聊天信息，将会如何？视频以高超手段做假，又将何如？——观《真相捕捉》</td>
</tr>
<tr class="even">
<td style="text-align: center;">2020-03-27</td>
<td style="text-align: center;">人类之前是否有智慧生物？意识的本质是啥？知识积累就如同滚雪球一般，短短几百年人类社会就颠覆了好几次，未来如何？无人知晓。唯一能确定的是，总有一天，人将非人。——读《人类简史》</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2020-02-16</td>
<td style="text-align: center;">对比如今，吃人血馒头的有之，欺下瞒下的有之，病人到处乱走的有之，封锁有之，集中调配有之，社会资源紧张有之，社会动荡暂时没有，摇号有之，搞特权的同样的有之，电影里还差病人隐瞒自身情况的事迹了，瘟疫公司估计会新加一个病人表现的指标了（doge）——观《传染病》</td>
</tr>
<tr class="even">
<td style="text-align: center;">2019-06-25</td>
<td style="text-align: center;">权力不想用，义务也不想承担，又只想拿好处，或许这就是大部分国人的现状了。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2019-05-30</td>
<td style="text-align: center;">切尔诺贝利最大的灾难是普通人一点知情权都没有，中层又极力隐瞒。——观《HBO 切尔诺贝利》</td>
</tr>
<tr class="even">
<td style="text-align: center;">2019-03-10</td>
<td style="text-align: center;">学校是为了老师而不是学生存在的。——《李狗嗨》SP1 <br /> 学生终究只是学校的过客而已，不过还是感觉教育的这种存在形式很有问题，不过目前好像也没有更好的解决方案，毕竟有人的地方就需要管理，有管理的地方就有利益和权力，而有利益和权力的地方必然存在纷争。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2019-01-08</td>
<td style="text-align: center;">不要抢话，适当保持沉默。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2018-06-09</td>
<td style="text-align: center;">从维度的角度来解析信号，不愧是卡尔·萨根，或许有一天阻碍人类科技发展的事物就是维度吧。 ——观《超时空接触》</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2018-06-03</td>
<td style="text-align: center;">1. 白色巨塔，尸骨成堆，在通往理想之路上，医者的信念并无对错； <br /> 2. 想改变什么，必先提升自己，但在提升自己之后，又很可能忘记自己的初心； <br /> 3. 能屈能伸终究还是对人来说的，阶级层次之间终究有别； <br /> 4. 呀吧哩钱和权才是永恒的话题，但只有生命才是最真实的。 ——观《白色巨塔》</td>
</tr>
<tr class="even">
<td style="text-align: center;">2018-05-18</td>
<td style="text-align: center;">「暴漫」死亡的原因应该是用户基数太大，而且又不合作。嗯，大概是这样吧 ╮(╯▽╰)╭ ，至于真相是。。。。。。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2018-03-14</td>
<td style="text-align: center;">曾看到一句类似这样的话：“死刑最可怕的不是它本身，而是其漫长的等待过程”。——观《大卫·戈尔的一生》</td>
</tr>
<tr class="even">
<td style="text-align: center;">2018-03-06</td>
<td style="text-align: center;">吃饭抢单，一如既往的高质量反转。——观《九号秘事》S03E03</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2018-02-06</td>
<td style="text-align: center;">每件事都有其价值，做的事不同，得到的也不同，有些人辛劳一生，却穷困潦倒，有些人游手好闲，照样荣华富贵。这取决于你的爹和你做的事。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2018-01-30</td>
<td style="text-align: center;">重复的事情总有一天都会被机器取代。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2018-01-10</td>
<td style="text-align: center;">真正的真相只掌握在少数人手里。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2018-01-06</td>
<td style="text-align: center;">老师终究只是一种职业，而学校服务的对象以老师为主，学生明明是被约束自由的一方，却还要给学校支付相应的费用，这感觉有点不正常啊。仔细想想又挺正常的，毕竟学校本身没逼你去，是你自己去的，既然要去一个本身不属于你的地方，当然要先缴各种服务费，即使物非所值。那为啥要去呢？</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2017-12-24</td>
<td style="text-align: center;">当隐私荡然无存，你又会如何 🤔。——观《 菲利普·K·迪克的电子梦》S01E01</td>
</tr>
<tr class="even">
<td style="text-align: center;">2017-12-21</td>
<td style="text-align: center;">世界很渺小，差的只是一个引路人。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2017-12-20</td>
<td style="text-align: center;">无知是福，不谈国是 :）。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2017-12-07</td>
<td style="text-align: center;">社会工程学，有意思的领域。——观《我是谁：没有绝对安全的系统》</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2017-11-29</td>
<td style="text-align: center;">知道的越多，不知道的也越多。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2017-11-15</td>
<td style="text-align: center;">我所理解的编程就是用尽可能简单的方法得到想要的变量值。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2017-10-24</td>
<td style="text-align: center;">读研究生两个月，最大的改变就是对人对事都比以前有更大的耐心了 :）。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2017-10-21</td>
<td style="text-align: center;">无论什么事，当ta成为一种任务的时候，都是一种负担。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2017-10-20</td>
<td style="text-align: center;">键盘侠就该看看《黑镜》S03E06，真看热闹不嫌事大啊 😒。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2017-10-19</td>
<td style="text-align: center;">人类基因组计划，真不知道是好是坏，希望是好的吧 😶。——观《黑镜》S03E05</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2017-10-15</td>
<td style="text-align: center;">镇定，面不改色；节奏很快，就一个晚上的事，音乐和光影也很赞 👍。——观《暗花》</td>
</tr>
<tr class="even">
<td style="text-align: center;">2017-10-07</td>
<td style="text-align: center;">国家意志啊，让人不由得想起那年春夏之交（5月35日）的一场风波╮(╯▽╰)╭。——观《出租车司机》</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2017-10-04</td>
<td style="text-align: center;">什么时候能控制情绪了，什么时候就成熟了。——观《头脑特工队》</td>
</tr>
<tr class="even">
<td style="text-align: center;">2017-10-03</td>
<td style="text-align: center;">所谓的朋友（ta）只是在正确的时间正确的地点遇到的正确的人。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2017-09-29</td>
<td style="text-align: center;">1. 有些事不知道比知道要好，但真相总还是知道要好。<br /> 2. 不同层次的人心态不同，难以相互理解。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2017-09-28</td>
<td style="text-align: center;">各大（网络）小说家的风格真的很难改变啊！ 😪</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2017-09-23</td>
<td style="text-align: center;">1. 你想成为什么样的人，必须自己决定。——《虫师》 <br /> 2. 情感是最不可控的。——观《宝莱坞机器人之恋》 <br /> 3. 人或许只有善恶，没有好坏。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2017-08-29</td>
<td style="text-align: center;">科研之上，如何能成为一个挖坑人（开创性的结果）？ 😕</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2017-08-11</td>
<td style="text-align: center;">学生最重要的两种能力是学习能力和解决问题的能力。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2017-08-10</td>
<td style="text-align: center;">爱情是需要理由的。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2017-08-05</td>
<td style="text-align: center;">无能是万恶之源。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2017-07-20</td>
<td style="text-align: center;">有些话，自己心里明白就行，绝对不能说出来，否则可能存在某种未知的危险。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2017-07-18</td>
<td style="text-align: center;">很多东西是不能向别人推荐的，比如音乐，电影，小说等自己喜欢的东西。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2017-07-14</td>
<td style="text-align: center;">有些事是交给别人判断的，自己心里知道就行；有些事是交给自己判断的，自己心里知道就行。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2017-07-11</td>
<td style="text-align: center;">走进一个学科之前，最先应该知道的是该学科的研究对象、研究方法，以及当前研究中的热点难点问题，而不应该被广告一样的花哨演示糊弄住。——《上海交通大学学生生存手册》</td>
</tr>
<tr class="even">
<td style="text-align: center;">2017-04-09</td>
<td style="text-align: center;">真正的独立，应该是离开任何人你都能活的好好的；真正的自由，应该是任何人都不能让你做违背你意志的事。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2017-02-08</td>
<td style="text-align: center;">小提琴，悠扬，忧伤。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2017-01-27</td>
<td style="text-align: center;">唉！渐行渐远╮(╯▽╰)╭。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2017-01-18</td>
<td style="text-align: center;">不能飞的猪，就只是猪而已。——《红猪》</td>
</tr>
<tr class="even">
<td style="text-align: center;">2016-12-30</td>
<td style="text-align: center;">梦想还是要有的，万一实现了呢，试一下又不吃亏。——观《百日梦想家》</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2016-12-26</td>
<td style="text-align: center;">过去的如果就这么过去了，那以后只会越来越糟。——《驴得水》</td>
</tr>
<tr class="even">
<td style="text-align: center;">2016-12-25</td>
<td style="text-align: center;">只有人才是最重要的。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2016-12-10</td>
<td style="text-align: center;">与人相处之道，不外乎尊重和坚强。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2016-11-06</td>
<td style="text-align: center;">烈日灼心，片如其名。——观《烈日灼心》</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2016-11-04</td>
<td style="text-align: center;">后来我发现，教授们貌似不喜欢有自己想法的学生，他们更希望找到愿意“打下手”的学生，帮助实现他们自己的想法。——《王垠：我和权威的故事》</td>
</tr>
<tr class="even">
<td style="text-align: center;">2016-10-31</td>
<td style="text-align: center;">为何总要责怪自己？为何要为没必要的人改变自己？不需要做老好人，做好自己，随便别人。——观《被嫌弃的松子的一生》</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2016-10-30</td>
<td style="text-align: center;">3~7的小孩的自主谎言最可怕，撒谎乃人之天性，远离无脑之人。——观《狩猎》</td>
</tr>
<tr class="even">
<td style="text-align: center;">2016-10-27</td>
<td style="text-align: center;">世界上有三种人，一种是人渣，一种愚漠的人，还有一种是所谓的好人。第二种人最多，参考正态分布。——观《熔炉》</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2016-10-22</td>
<td style="text-align: center;">面对长者（诸如领导，老师等），要多听他们说，自己尽量少说，绝对不要找理由，要多说嗯，是的，对的，没错，明白，可以等肯定语句，绝对不要说由于，因为等原因语句。更重要的是尽量少说自己不知道，忘记了，了解一点等否定语句，不要把自己差的一面表现出来；要说自己会，行，知道等肯定语句，一定要把自己好的一面表现120%出来。（※附：以 Shaun 2017-12-21的眼光来看这段话还是不妥）</td>
</tr>
<tr class="even">
<td style="text-align: center;">2016-10-02</td>
<td style="text-align: center;">平静中的悲和喜，最悲痛。——观《那年夏天，宁静的海》</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2016-09-22</td>
<td style="text-align: center;">韩国好的电影对人性的把握比较到位，但有时为了突出人性好的一面，而做的有点婊了，为了剧情而剧情。——观《摩天楼》《流感》《铁线虫入侵》《釜山行》</td>
</tr>
<tr class="even">
<td style="text-align: center;">2016-09-13</td>
<td style="text-align: center;">这世上有很多事，不试一下永远不会知道结果。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2016-09-05</td>
<td style="text-align: center;">公式本就存在，就等有天赋的人去感知并发现它。——观《知无涯者》</td>
</tr>
<tr class="even">
<td style="text-align: center;">2016-09-03</td>
<td style="text-align: center;">管理者需要心平气和，更要沉得住气，有耐心。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2016-08-12</td>
<td style="text-align: center;">自紧力，自紧扳手，和初中做的物理实验：把两本书夹在一起后，无论怎么用力向两边拉都拉不开，估计有点类似吧。（※附：以 Shaun 2017-12-21的眼光来看这个事感觉有点玄学）</td>
</tr>
<tr class="even">
<td style="text-align: center;">2016-08-10</td>
<td style="text-align: center;">为什么人们总认为小孩（弱者）说的是对的？有没有想过，有时候小孩并不小，弱者并不弱。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2016-08-09</td>
<td style="text-align: center;">《人工智能》，好可怖的一个世界。——观《人工智能》</td>
</tr>
<tr class="even">
<td style="text-align: center;">2016-08-06</td>
<td style="text-align: center;">一起做一件事能很好的增进感情。（※附：以 Shaun 2017-12-21的眼光来看也有可能增加矛盾╮(╯▽╰)╭）</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2016-08-04</td>
<td style="text-align: center;">尽量不要去接手别人已经做了一部分的事物。（※附：以 Shaun 2017-12-21的眼光来看如果别人做的很好理解的话接手也可以）</td>
</tr>
<tr class="even">
<td style="text-align: center;">2016-08-02</td>
<td style="text-align: center;">1. 有时候很难理解他人，只是因为没有和他人类似的经历而已。<br />2. 让人的本性被改变咋就这么难？读大学是掉噶果？（※附：以 Shaun 2017-12-21的眼光来看ta确实老了，也变了，或许时间能改变一切吧）</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2016-07-29</td>
<td style="text-align: center;">《计算机：一部历史》，很有意思的一本计算机史。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2016-07-26</td>
<td style="text-align: center;">人们总是习惯于用固有的标准看待新事物。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2016-07-24</td>
<td style="text-align: center;">《妖尾》的世界观简直不敢苟同，世界上真有那种人，杀了或要杀自己朋友的人还能做伙伴？每遇到boss第一次总被秒杀，第二次才能完胜？这尼玛是什么逻辑。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2016-07-17</td>
<td style="text-align: center;">1. 不要嘲笑别人的梦想，也不要轻易说出自己的梦想。 <br />2. 看完《活着》，心情有点沉重，难道生命的意义就在于为活着而活着？或者还是太年轻了。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2016-07-16</td>
<td style="text-align: center;">1. 是待人以诚，人待以诚，还是人待以诚，待人以诚？不好说。<br />2. 游戏能代表计算机应用技术的最高水平。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2016-07-13</td>
<td style="text-align: center;">情景不同，分类不同。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2016-07-12</td>
<td style="text-align: center;">下属（泛指），多看，多听，多想，多做，少说话。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2016-07-10</td>
<td style="text-align: center;">1. 世上最痛苦的事莫过于对着自己不想看到的人谄媚。<br />2. 不同的时刻，不同的场景，不同的心情，喜好不一样。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2016-06-29</td>
<td style="text-align: center;">口吃可能不是遗传的，也可能是婴儿学习过程中的一种畸形。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2016-06-23</td>
<td style="text-align: center;">1. 何不让自己的人生多些经历。<br />2. 世上大多数的猜忌、争论，都是由于每个人总是认为自己是对的。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2016-06-16</td>
<td style="text-align: center;">1. 多媒体识别的关键在于提取图像、视频和音频的“特征”（即向量）。<br /> 2. 我们周围的人是否在演戏？我们是否在戏中？人生入戏，戏如人生。——观《楚门的世界》</td>
</tr>
<tr class="even">
<td style="text-align: center;">2016-06-13</td>
<td style="text-align: center;">1. 不管变成什么样，问心无愧就好。 <br /> 2. 人越成熟就藏得越深。 <br /> 3. 完全不需要和别人比，只需和昨天的自己比。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2016-06-09</td>
<td style="text-align: center;">1. 在公共环境（贴吧，评论区等）下发言，首先要做好被喷的准备，网络上从来不缺少键盘侠。 <br /> 2. 眼中世界不同的人，终究会分开。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2016-05-27</td>
<td style="text-align: center;">有些东西是让人看到会产生反感的，而有些东西明明被人讨厌，却因为它没有那么张扬的外面，所以很容易被人忽视的。——七月寒风《幻灵》</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2016-05-20</td>
<td style="text-align: center;">1. 不要随便对别人说出你的想法和理解，因为可能在别人看来，你的想法和理解完全就是个笑话和讽点。最后，最重要的是看清他人是不是和你是一个世界的，世界不同，观念，观点很难相同。 <br /> 2. 绝大部分老师只看结课论文的排版如何。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2016-05-18</td>
<td style="text-align: center;">儒家治国，道家处事。（※附：以 Shaun 2017-12-22的眼光来看有点不敢苟同）</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2016-05-16</td>
<td style="text-align: center;">人们或多或少都有一种同情弱者的心态，所以有时候适当的处于弱势并不是一件坏事。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2016-05-09</td>
<td style="text-align: center;">大学里的成绩更多的是取决于你了不了解老师，你知不知道老师真正想要你写什么，讲什么。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2016-05-02</td>
<td style="text-align: center;">看完《浪潮之巅》才明白“软件即服务”，软件提供的实际上是某种功能，某种作用，而这种功能是软件所在平台没有的，但是却是人们使用时不可或缺的，那么企业提供这个软件，就是在提供一种服务。就像饭店里的服务员一样，上菜时饭店提供的一种服务，但不是饭店本身就有的，饭店真正提供的只是一个场所和食物。<br /> 使用的人数决定市场，不管是付费还是免费，只要能抓住更多的用户，就是胜者。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2016-04-29</td>
<td style="text-align: center;">世界上有两种程序员，一种是写技术的，另一种是用技术的。（※附：以 Shaun 2017-12-22的眼光来看写者和用者并没有很明确的界线，更像是一种心态吧）</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2016-04-24</td>
<td style="text-align: center;">真没想到，最近看到“人生若只如初见”才知道是什么意思，高中老师曾出了个作文题就叫这个，当时傻傻的不知道什么意思，呵呵，当年的阅历实在太浅。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2016-04-07</td>
<td style="text-align: center;">你强ta越怕，你弱ta越欺。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2016-04-02</td>
<td style="text-align: center;">黑色幽默，挺有意思的！比较推荐的有：《黑镜》、《蛮荒故事》。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2016-03-31</td>
<td style="text-align: center;">1. 两个公司在技术上的竞争，除了人的竞争，就是执行力的竞争。——吴军《浪潮之巅》雅虎、惠普精兵简政 <br /> 2. 托尔斯泰讲，幸福的家庭都是相似的，不幸的家庭都是各有各的不幸。在信息工业中，这句话要反过来讲，成功的公司各有各的绝招，失败的公司到是有不少的共同之处。——吴军《浪潮之巅》思科 留住早期员工</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2016-03-24</td>
<td style="text-align: center;">有时候，我们想要的东西就在我们面前，我们却因年代久远可能不认得，反而可能亲手毁了ta。——观《SINTEL》</td>
</tr>
<tr class="even">
<td style="text-align: center;">2016-03-21</td>
<td style="text-align: center;">每次去以前贾里尼克都要确认我们报告的每一页内容都是已经公开发表过的。原因很简单，IBM有世界最好的科学家和工程师，他们可以用比你还快的速度将你还没发表的想法实现、申请专利并发表。<br /> 盖茨意识到只要垄断了操作系统，就间接垄断了整个行业。——吴军《浪潮之巅》Microsoft <br /> 在商业领域，保密性是十分重要的，尤其是一个新颖的想法。<br /> 在积累了一定的用户量之后，商业化也是很简单的。商业的前提是用户。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2016-03-20</td>
<td style="text-align: center;">整个信息技术（Information Technologies，简称IT）产业包括很多领域、很多环节，这些环节之间都是互相关联的。和世界上任何事物同样，IT产业也是不断变化和发展并且有着它自身发展规律的。——吴军《浪潮之巅》IT Law <br /> 万物发展自有其规律，但这个规律只是一种趋势，趋势总有其临界点，到临界点时将呈现另一种趋势，比如Moore's Law，功耗就是其临界点。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2016-03-20</td>
<td style="text-align: center;">英特尔公司做事情非常专注，直到今天，它一直集中精力于个人微机的处理器，每一代产品的研发都是集中大量的人力和资金，每一次都是只能成功不能失败。——吴军《浪潮之巅》Intel <br /> 专一，虽然能保证做好，但面太窄，一旦市场发生变化，讲很难应对。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2016-03-19</td>
<td style="text-align: center;">时不时调整内部结构，将一些非核心的、长期效益不好的部门卖掉，同时扩大核心的利润高的生意。——吴军《浪潮之巅》IBM <br /> 认清自己的定位，抓牢自己的核心业务，同时开拓创新。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2016-03-19</td>
<td style="text-align: center;">当一个公司没有人对它有完全控制时，它的长期发展就会有问题。——吴军《浪潮之巅》AT&amp;T <br /> 合则生，分则死。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2016-03-19</td>
<td style="text-align: center;">社会在发展，人也在发展，社会的发展体现在人周围事物的变化，而人的发展体现在人自身的变化，这种变化是好是坏，每个人的观点可能不同，没人能预料变化将带来什么，我们唯一所能判断的就是变化给我们现在带来了什么，以此判断以前的变化是好是坏，此时的变化将由未来的人判断。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2016-03-19</td>
<td style="text-align: center;">大学生和高中生的本质区别在于大学生更会思考，更加注重自学能力，遇到问题是主动去寻找解决方案，而不是像高中生那样被动的等老师来讲解。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2016-03-11</td>
<td style="text-align: center;">时间使人安稳，失去时间将使人迷失，疯狂。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2016-02-17</td>
<td style="text-align: center;">别人肯不肯帮忙主要取决于你自身的实力基础。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2016-02-03</td>
<td style="text-align: center;">生而不养，养而不教，不如不生。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2016-01-26</td>
<td style="text-align: center;">为人子女，与父母相处的机会，其实都是见一次少一次的。——罗森《万界天王》</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2016-01-24</td>
<td style="text-align: center;">四十多岁的父母是最能包容你的人。（※附：以 Shaun 2017-12-22的眼光来看这里有点欠妥）</td>
</tr>
<tr class="even">
<td style="text-align: center;">2016-01-23</td>
<td style="text-align: center;">以己度人，更多的是指包容别人的缺点，而不是抱怨别人没有的缺点。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2016-01-16</td>
<td style="text-align: center;">人之为人，在于自制。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2016-01-08</td>
<td style="text-align: center;">读高中时，我接触到靠自己；读大学时，我逐渐学会靠自己；步入社会时，我将真正靠自己。（※附：以 Shaun 2017-12-22的眼光来看是不可能真正靠自己的，总要与外界交互）</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2015-12-30</td>
<td style="text-align: center;">读大学，选择不同的专业，就是选择不同的圈子，而圈子决定话题。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2015-12-28</td>
<td style="text-align: center;">1. 很多时候，我们买一件东西只是因为心血来潮，而不是真正需要它。 <br /> 2. 贯彻落实“尽量学习”理念。尽量学习有两个方面：尽量多学和尽量精学。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2015-12-07</td>
<td style="text-align: center;">人生充满太多的偶然性。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2015-11-09</td>
<td style="text-align: center;">所谓杀心，就是去除仇恨。恨一个人也常常意味着怕这个人，只有克服了“怕”之后，“恨”才能转化为杀心，化为力量。—— 冰临神下《死人经》</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2015-11-08</td>
<td style="text-align: center;">每天都学一点小知识</td>
</tr>
<tr class="even">
<td style="text-align: center;">2015-11-05</td>
<td style="text-align: center;">有没有想过，人类也是一种寄生虫，寄生在地球，依靠于太阳，而太阳和地球也只是宇宙里的一粒微尘。——观《宇宙的奇迹》</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2015-09-15</td>
<td style="text-align: center;">虽然这不是你理想中的大学，但你可以选择过理想的大学生活。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2015-09-05</td>
<td style="text-align: center;">没有对生明的敬畏，就永远无法体会到生命的可怕。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2015-09-01</td>
<td style="text-align: center;">因为在乎，所以在意。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2015-05-16</td>
<td style="text-align: center;">我虽然现在不知道，但我可以学。（※附：以 Shaun 2017-12-22的眼光来看这句话在大部分情况下行不通）</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2015-05-15</td>
<td style="text-align: center;">唉！这次回去，已是物是人非，院子不再是院子。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2015-05-15</td>
<td style="text-align: center;">自杀乃傻之至极。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2015-05-15</td>
<td style="text-align: center;">1. 不抱怨，不找理由。（面对教、训之终极奥义） <br /> 2. 一本书，读过之后如果没有思考，相当于没读。 <br /> 3. 前人的言行是我们的指路明灯。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2015-05-15</td>
<td style="text-align: center;">鹿角杀死了冰原狼预示着拜拉席恩将导致史塔克的死亡。<br /> 不会玩的游戏不要硬去玩，否则终将害人害己。<br /> 当大雪降下，冷风吹起，独行狼死，群聚狼生。夏天时可以争吵，但一到冬天，我们必须保卫彼此，相互温暖，共享力量。——《冰与火之歌：权利的游戏》</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2015-05-15</td>
<td style="text-align: center;">1. 海贼王的海军每个人都有自己坚守的正义。 <br /> 2. 尊重不是别人施舍的，而是自己争取的。 <br /> 3. 环境决定年龄。 <br /> 4. 和平利于知识传播交流，战争利于知识创新突破。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2015-05-15</td>
<td style="text-align: center;">1. 不要等到老师教，尽量去学自己想学的，要学的。 <br /> 2. 介绍和学习是两码事，介绍可以用PPT，而学习用板书更好。 <br /> 3. 电给人方便，也使人孤独，人与人的联系似存而亡。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2015-04-15</td>
<td style="text-align: center;">是为自己而活？还是为他人而活？</td>
</tr>
<tr class="even">
<td style="text-align: center;">2015-04-03</td>
<td style="text-align: center;">有时候，人对自己的东西会突然莫名其妙的产生一种厌烦感，从而不想要，从而做错事，但其实这种厌烦感只是暂时的，过一段时间又会恢复成以前那样。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2015-03-10</td>
<td style="text-align: center;">人当想人之不能。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2014-10-04</td>
<td style="text-align: center;">1. 人之成长，取决于见。<br /> 2. 世风日下，好人难做。 <br /> 3. 在社会这个大染缸里，我只想做我自己。 <br /> 4. 有些雷区是不能碰的，碰，就会惹火上身。 <br /> 5. 每个人的注重点不一样，带出来的人也不一样。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2014-09-20</td>
<td style="text-align: center;">How did we escape from the prison? It was the work of generations of searchers who took five simple rules to heart . Question authority. No idea is true just because someone says so. Think for yourself . Question yourself. Don't believe anything just because you want to. Believing something doesn't make it so. Test ideas by the evidence gained from observation and experiment. If a favorite idea fails a well-desidned test, it's wrong! Get over it. Follow the evidence, wherever it leads. If you have no evidence , reserve judgment. And perhaps the most important rule of all…… Rember, you could be wrong. Even the best scientists have been wrong about somethings. Newton, Einstein, and every other great scientist in history, they all made mistakes. of course they did -- they were human, Science is a way to keep from fooling ourselves and each other. Have scientists known sin? of course. We have misused science, just as we have every other tool at our disposal, and that's why we can't afford to leave it in the hands of a powerful few. The more science belongs to all of us, the less likely it is to be misused. These values undermine the appeals of fanaticism and ignorance. ——《Cosmos: A Spacetime Odyssey》 <br /> 我们如何逃出囚笼？是因为世世代代探索者的不懈努力，并且他们发自内心地遵从这5条简单规则。质疑权威。不轻信人言。独立思考。自我质疑。不因自己想要相信，而相信任何事。相信不代表能成为现实。以依靠观察和实验得来的证据来检验想法。如果自己喜欢的想法没有通过全面的检验，它就是错的！ 乐观一点。遵循证据，无论它指向哪里。如果没有证据，不妄下结论。也许最重要的规则就是，要记住，你也会犯错。牛顿、爱因斯坦，还有历史上每一位伟大的科学家，他们都犯过错，这很正常，是人都会犯错。科学让我们不再欺骗别人和自己。科学家们有罪吗？有的。我们曾滥用科学就像手边的工具一样随意使用，因此我们不能把科学放在少数的掌权者手中。当科学更多的属于全人类时，它就越不会被乱用。科学的价值在于能阻止狂热和无知。 ——纪录片《宇宙时空之旅》</td>
</tr>
<tr class="even">
<td style="text-align: center;">2014-09-20</td>
<td style="text-align: center;">Telling someone your goal makes it less likely to happen. <br />告诉别人你的目标反而使目标不能实现。 ——网易公开课《不要公开宣布个人目标》</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2014-09-14</td>
<td style="text-align: center;">每一个客户都是一群客户。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2014-08-22</td>
<td style="text-align: center;">快做眼前事，未来不可知。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2014-08-13</td>
<td style="text-align: center;">既然扎根于此，何不刻苦努力！</td>
</tr>
<tr class="even">
<td style="text-align: center;">2014-07-31</td>
<td style="text-align: center;">这个世界很大，你总能找到你的伙伴。<br /> 既然出生到这个世上，你绝不会总是孤身一人的。 ——《One Piece》</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2014-07-26</td>
<td style="text-align: center;">There's a time when a man needs to fight and a time when he needs to accept that his destiny's lost. 人有必须奋战的时刻，也有必须接受现实的时刻。 ——《Big Fish》</td>
</tr>
<tr class="even">
<td style="text-align: center;">2014-07-23</td>
<td style="text-align: center;">每个人的一生都是一部独有的长篇小说。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2014-07-11</td>
<td style="text-align: center;">就算你讨厌ta，也不要在背后议论ta的是非，毕竟议论是非之事必是是非之人。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2014-06-29</td>
<td style="text-align: center;">世事无常，计划赶不上变化，无须太过伤感。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2014-06-27</td>
<td style="text-align: center;">大 极，小 极，差，和，无大无小。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2014-06-25</td>
<td style="text-align: center;">荣耀只属于特定的时空。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2014-06-16</td>
<td style="text-align: center;">1. 一个秘密有两个人知道，也便不是秘密。 <br /> 2. 没有做好准备就准备失败。<br /> 3. 初学计算机语言，多敲代码。 <br /> 4. 不要太在乎别人对你的看法（不管是好是坏），不然你会活的很累。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2014-06-11</td>
<td style="text-align: center;">分数是老师给的，东西才是自己学的。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2014-06-06</td>
<td style="text-align: center;">参数——来自另一维度的手（上帝之手）（二维中的蚂蚁、三维中的蚂蚁、轻易逃脱囚笼）</td>
</tr>
<tr class="even">
<td style="text-align: center;">2014-05-30</td>
<td style="text-align: center;">1. 有些话（事）能说（做），有些话（事）不能说（做）。（要会判断）<br /> 2. 不要在心情极端时做出让自己后悔的事。<br /> 3. 相比于自律自觉能力，考上一个好大学显得并不是那么重要。 <br /> 4. 在这个人人都装逼的社会，对不对需要自己判断！</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2014-05-26</td>
<td style="text-align: center;">"取法乎下，得乎下下；取法乎中，得乎其下；取法乎上，得乎其中；取法上上，得乎其上。" —— 《读大学怎么读》</td>
</tr>
<tr class="even">
<td style="text-align: center;">2014-05-21</td>
<td style="text-align: center;">1. 其实学校是第一个教会我们说谎的地方。 <br /> 2. 成绩只是老师给的，更重要地是在于你自己有没有学到东西，大学注重的不应是分数，而应是你真正学到的东西！</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2014-05-12</td>
<td style="text-align: center;">每个人都是自己生活的主角。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2014-04-21</td>
<td style="text-align: center;">1. 闲事为何事，何事为闲事！ <br /> 2. 距离！ 适度！ <br /> 3. 人生总有种种不如意之事，但也会有种种如意之事！ <br /> 4. 一般而言，抄不如乱写，乱写不如不写！</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2014-04-21</td>
<td style="text-align: center;">1. 世上的事很多，只是看你去不去做，所以何来无聊之说！ <br /> 2. 上大学易，读大学难，且读且珍惜！</td>
</tr>
<tr class="even">
<td style="text-align: center;">2014-04-19</td>
<td style="text-align: center;">浑浑噩噩的一天，糊糊涂涂的人。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2014-04-01</td>
<td style="text-align: center;">1. 不去争的话就什么都不会有！ <br /> 2. 因为在意，所以紧张！ <br /> 3. 人生就是一个奋斗的过程，人生也因奋斗而精彩！</td>
</tr>
<tr class="even">
<td style="text-align: center;">2014-04-01</td>
<td style="text-align: center;">1. 永远都不要以为你的时间很多！ <br /> 2. 深沉一点！ <br /> 3. 真搞不懂为什么这么多人喜欢听假话，假话比真话真的管用吗？也难怪现在有这么多假冒伪劣产品，连个话都是假的好。（※附：以 Shaun 2017-12-23的眼光来看在多数情况下假话确实比真话管用，说话也是一门学问啊）</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2014-04-01</td>
<td style="text-align: center;">1. 有些路还是自己走得好！ <br /> 2. 天下哪里有白吃的午餐，只有白痴的人。 <br /> 3. 做人可以懒，但不能傻！</td>
</tr>
</tbody>
</table>
<p>以上均为 Shaun 当时感想，也算是记录一下 Shaun 的心智成长过程吧，有不同意见请保持理智 (๑•̀ㅁ•́ฅ)。</p>
<h2 id="后记">后记</h2>
<p>　　哪来的后记，Shaun 的这一生还没过完呢 (╯°□°）╯︵ ┻━┻，（#-_-)┯━┯ 。</p>
]]></content>
      <categories>
        <category>Life</category>
      </categories>
      <tags>
        <tag>thought</tag>
      </tags>
  </entry>
  <entry>
    <title>OpenCV中滑动条和鼠标事件响应操作的使用小结</title>
    <url>/posts/e8b35736.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　既然在<a href="https://cniter.github.io/posts/b6fb6109.html">上一篇</a>中提到了回调函数，Shaun 就干脆把 OpenCV 中较常使用的两个使用回调函数的函数使用方法也一并记录下来吧。</p>
<span id="more"></span>
<h2 id="说明篇">说明篇</h2>
<p>OpenCV 中使用回调函数的两个函数为：</p>
<ol type="1">
<li><p><strong>鼠标事件响应操作函数：</strong><code>void cv::setMouseCallback(const string&amp; winname, MouseCallback onMouse, void* userdata = 0);</code></p>
<p><strong><em>参数浅解：</em></strong></p>
<blockquote>
<p><code>const string&amp; winname</code>：窗口名称，对名为winname的窗口执行鼠标事件响应操作；</p>
<p><code>MouseCallback onMouse</code>：鼠标响应事件回调函数，监听鼠标的点击，移动，松开，判断鼠标的操作类型并做出相应处理；</p>
<p><code>void* userdata</code>：对应回调函数的可选参数，若使用全局变量可以忽略该参数。</p>
</blockquote>
<p><em>对应的回调函数声明为：</em><code>typedef void (*MouseCallback)(int event, int x, int y, int flags, void* userdata);</code></p>
<p><strong><em>参数浅解：</em></strong></p>
<blockquote>
<p><code>int event</code>：鼠标滑动（CV_EVENT_MOUSEMOVE）、左键单击（CV_EVENT_LBUTTONDOWN）、右键单击（CV_EVENT_RBUTTONDOWN ）等10种鼠标点击事件的int型代号；</p>
<p><code>int x, int y</code>：鼠标位于窗口的（x，y）坐标位置，窗口左上角默认为原点，向右为x正轴，向下为y正轴；</p>
<p><code>int flags</code>：鼠标左键拖拽（CV_EVENT_FLAG_LBUTTON）、右键拖拽（CV_EVENT_FLAG_RBUTTON）等6种鼠标拖拽事件的int型代号；</p>
<p><code>void* userdata</code>：回调函数的参数，若使用全局变量可以忽略该参数。</p>
</blockquote></li>
<li><p><strong>创建滑动条函数：</strong><code>int cv::createTrackbar(const string&amp; trackbarname, const string&amp; winname, int* value, int count, TrackbarCallback onChange=0, void* userdata=0);</code></p>
<p><strong><em>参数浅解：</em></strong></p>
<blockquote>
<p><code>const string&amp; trackbarname</code>：创建的滑动条名称；</p>
<p><code>const string&amp; winname</code>：所在窗口名称，对名为winname的窗口添加滑动条；</p>
<p><code>int* value</code>：滑块的位置，其初始值对应滑块的初始位置；</p>
<p><code>int count</code>：滑块可达到的最大位置的值，滑块最小位置的值总为0；</p>
<p><code>TrackbarCallback onChange</code>：滑动条事件回调函数，当滑动条上位置改变的时，则执行该回调函数；</p>
<p><code>void* userdata</code>：对应回调函数的可选参数，若使用全局变量可以忽略该参数。</p>
</blockquote>
<p><em>对应的回调函数声明为：</em><code>typedef void (CV_CDECL *TrackbarCallback)(int pos, void* userdata);</code></p>
<p><strong><em>参数浅解：</em></strong></p>
<blockquote>
<p><code>int pos</code>：滑动条的位置对应的值；</p>
<p><code>void* userdata</code>：回调函数的参数，若使用全局变量可以忽略该参数。</p>
</blockquote></li>
</ol>
<p><em>※注：本文的函数说明采用的是 opencv-2.4.11 的函数声明，与 opencv-3.2.0 的函数声明区别在于 <code>string</code> 类型，opencv-3.2.0 采用的是其自己实现的一个 <code>String</code> 类。</em></p>
<h2 id="实例篇">实例篇</h2>
<p>Show u the code，具体 C++ 实现代码为：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/opencv.hpp&gt;</span> </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/core/core.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/imgproc/imgproc.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/highgui/highgui.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ---------------- 鼠标事件回调函数 ---------------------------------</span></span><br><span class="line"><span class="keyword">static</span> cv::Mat src_img;	<span class="comment">// 原始图像全局变量</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">mouseCallback</span><span class="params">(<span class="keyword">int</span> event, <span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> flags, <span class="keyword">void</span> *)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">bool</span> selected = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">static</span> cv::Point left_top_vertex, right_down_vertex;	<span class="comment">// 左上角顶点和右下角顶点</span></span><br><span class="line">	<span class="comment">// When the left mouse button is pressed, record its position and save it in corner1  </span></span><br><span class="line">	<span class="keyword">if</span> (event == CV_EVENT_LBUTTONDOWN)	<span class="comment">// 左键按下</span></span><br><span class="line">	&#123;</span><br><span class="line">		left_top_vertex.x = x;</span><br><span class="line">		left_top_vertex.y = y;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;Corner 1 recorded at &quot;</span> &lt;&lt; left_top_vertex &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// When the left mouse button is released, record its position and save it in corner2  </span></span><br><span class="line">	<span class="keyword">if</span> (event == cv::EVENT_LBUTTONUP)	<span class="comment">// 左键弹起</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Also check if user selection is bigger than 20 pixels (jut for fun!)  </span></span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">abs</span>(x - left_top_vertex.x) &gt; <span class="number">10</span> &amp;&amp; <span class="built_in">abs</span>(y - left_top_vertex.y) &gt; <span class="number">10</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			right_down_vertex.x = x;</span><br><span class="line">			right_down_vertex.y = y;</span><br><span class="line">			std::cout &lt;&lt; <span class="string">&quot;Corner 2 recorded at &quot;</span> &lt;&lt; right_down_vertex &lt;&lt; std::endl &lt;&lt; std::endl;</span><br><span class="line">			selected = <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			std::cout &lt;&lt; <span class="string">&quot;Please select a bigger region&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Update the box showing the selected region as the user drags the mouse  </span></span><br><span class="line">	<span class="keyword">if</span> (flags == CV_EVENT_FLAG_LBUTTON)	<span class="comment">// 左键拖拽</span></span><br><span class="line">	&#123;</span><br><span class="line">		cv::Point pt;</span><br><span class="line">		pt.x = x;</span><br><span class="line">		pt.y = y;</span><br><span class="line">		cv::Mat local_img = src_img.<span class="built_in">clone</span>();</span><br><span class="line">		<span class="built_in">rectangle</span>(local_img, left_top_vertex, pt, cv::<span class="built_in">Scalar</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>));</span><br><span class="line">		<span class="built_in">imshow</span>(<span class="string">&quot;Cropping app&quot;</span>, local_img);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Define ROI and crop it out when both corners have been selected  </span></span><br><span class="line">	<span class="keyword">if</span> (selected)</span><br><span class="line">	&#123;</span><br><span class="line">		cv::Rect box;</span><br><span class="line">		box.width = <span class="built_in">abs</span>(left_top_vertex.x - right_down_vertex.x);</span><br><span class="line">		box.height = <span class="built_in">abs</span>(left_top_vertex.y - right_down_vertex.y);</span><br><span class="line">		box.x = cv::<span class="built_in">min</span>(left_top_vertex.x, right_down_vertex.x);</span><br><span class="line">		box.y = cv::<span class="built_in">min</span>(left_top_vertex.y, right_down_vertex.y);</span><br><span class="line">		<span class="comment">// Make an image out of just the selected ROI and display it in a new window  </span></span><br><span class="line">		<span class="function">cv::Mat <span class="title">crop</span><span class="params">(src_img, box)</span></span>;</span><br><span class="line">		cv::<span class="built_in">namedWindow</span>(<span class="string">&quot;Crop&quot;</span>);</span><br><span class="line">		<span class="built_in">imshow</span>(<span class="string">&quot;Crop&quot;</span>, crop);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---------- 响应鼠标事件 ------------------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setMouseCallbackTest</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	src_img = cv::<span class="built_in">imread</span>(<span class="string">&quot;../data/lena.jpg&quot;</span>, CV_LOAD_IMAGE_ANYDEPTH | CV_LOAD_IMAGE_ANYCOLOR);</span><br><span class="line">	cv::<span class="built_in">namedWindow</span>(<span class="string">&quot;Cropping app&quot;</span>);</span><br><span class="line">	<span class="built_in">imshow</span>(<span class="string">&quot;Cropping app&quot;</span>, src_img);</span><br><span class="line">	<span class="comment">// Set the mouse event callback function  </span></span><br><span class="line">	cv::<span class="built_in">setMouseCallback</span>(<span class="string">&quot;Cropping app&quot;</span>, mouseCallback);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="built_in"><span class="keyword">char</span></span>(cv::<span class="built_in">waitKey</span>(<span class="number">30</span>)) != <span class="string">&#x27;q&#x27;</span>) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// -------------- 滑动条回调函数 ------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">thresholdCallback</span><span class="params">(<span class="keyword">int</span> slider_value, <span class="keyword">void</span>* gray)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//static_cast&lt;&gt;用于安全转换指针</span></span><br><span class="line">	cv::Mat *tmp_gray = <span class="keyword">static_cast</span>&lt;cv::Mat *&gt;(gray);</span><br><span class="line">	cv::Mat tmp = *tmp_gray;</span><br><span class="line">	cv::Mat dst;</span><br><span class="line">	<span class="built_in">threshold</span>(tmp, dst, slider_value, <span class="number">255</span>, CV_THRESH_BINARY);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//显示效果图</span></span><br><span class="line">	cv::<span class="built_in">imshow</span>(<span class="string">&quot;Trackbar Demo&quot;</span>, dst);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ------------ 创建滑动条 ----------------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">createTrackbarTest</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	cv::Mat src_gray = cv::<span class="built_in">imread</span>(<span class="string">&quot;../data/lena.jpg&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">int</span> max_value = <span class="number">255</span>;	<span class="comment">//滑动条的最大值</span></span><br><span class="line">	<span class="keyword">int</span> slider_value = <span class="number">0</span>;	<span class="comment">// 滑动条的初始值</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">char</span> *window_name = <span class="string">&quot;Trackbar Demo&quot;</span>;</span><br><span class="line">	<span class="keyword">char</span> *trackbar_name = <span class="string">&quot;Value:&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建一个窗口显示图片</span></span><br><span class="line">	cv::<span class="built_in">namedWindow</span>(window_name, CV_WINDOW_AUTOSIZE);</span><br><span class="line">	<span class="built_in">imshow</span>(window_name, src_gray);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建滑动条来控制阈值</span></span><br><span class="line">	<span class="built_in">createTrackbar</span>(trackbar_name, window_name, &amp;slider_value, max_value, thresholdCallback, &amp;src_gray);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="built_in"><span class="keyword">char</span></span>(cv::<span class="built_in">waitKey</span>(<span class="number">30</span>)) != <span class="string">&#x27;q&#x27;</span>) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ------- 将两个函数在同一个窗口执行 ------------</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">callbackTest</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	src_img = cv::<span class="built_in">imread</span>(<span class="string">&quot;../data/lena.jpg&quot;</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">int</span> max_value = <span class="number">255</span>;	<span class="comment">//滑动条的最大值</span></span><br><span class="line">	<span class="keyword">int</span> slider_value = <span class="number">0</span>;	<span class="comment">// 滑动条的初始值</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">char</span> *window_name = <span class="string">&quot;Callback Demo&quot;</span>;</span><br><span class="line">	<span class="keyword">char</span> *trackbar_name = <span class="string">&quot;Value:&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建一个窗口显示图片</span></span><br><span class="line">	cv::<span class="built_in">namedWindow</span>(window_name, CV_WINDOW_AUTOSIZE);</span><br><span class="line">	<span class="built_in">imshow</span>(window_name, src_img);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建滑动条来控制阈值</span></span><br><span class="line">	<span class="built_in">createTrackbar</span>(trackbar_name, window_name, &amp;slider_value, max_value, thresholdCallback, &amp;src_img);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 鼠标事件响应</span></span><br><span class="line">	cv::<span class="built_in">setMouseCallback</span>(window_name, mouseCallback);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="built_in"><span class="keyword">char</span></span>(cv::<span class="built_in">waitKey</span>(<span class="number">30</span>)) != <span class="string">&#x27;q&#x27;</span>) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//setMouseCallbackTest();</span></span><br><span class="line">	<span class="comment">//createTrackbarTest();</span></span><br><span class="line">	<span class="built_in">callbackTest</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="built_in"><span class="keyword">char</span></span>(cv::<span class="built_in">waitKey</span>(<span class="number">30</span>)) != <span class="string">&#x27;q&#x27;</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>　　经 Shaun 测试，上面示例程序在 Win10 的 VS2013 中 opencv-2.4.11 和 opencv-3.2.0 下都能完美运行。</p>
<h2 id="后记">后记</h2>
<p>　　本来这两个函数都已经写（chao）好了，但为了更好的体现示例程序，又稍作了修改：添加鼠标左键拖拽事件及不使用全局变量等。</p>
<h2 id="参考资料">参考资料</h2>
<p>[1] <a href="http://www.cnblogs.com/lidabo/p/3437587.html">opencv2 使用鼠标绘制矩形并截取和保存矩形区域图像</a>（<a href="http://www.cnblogs.com/lidabo/category/516776.html" class="uri">http://www.cnblogs.com/lidabo/category/516776.html</a>）</p>
<p>[2] <a href="http://blog.csdn.net/weixin_35738542/article/details/52071963">Opencv中添加进度条及回调函数</a>（<a href="http://blog.csdn.net/weixin_35738542/article/category/6337413" class="uri">http://blog.csdn.net/weixin_35738542/article/category/6337413</a>）</p>
<p>[3] <a href="http://blog.csdn.net/u014291399/article/details/47811905">OpenCV2中滑动条（Trackbar）回调函数的小发现</a>（<a href="http://blog.csdn.net/u014291399/article/category/3097955" class="uri">http://blog.csdn.net/u014291399/article/category/3097955</a>）</p>
<p>[4] <a href="http://blog.csdn.net/wangyaninglm/article/details/42032825">OpenCV GUI基本操作，回调函数，进度条，裁剪图像等</a>（<a href="http://blog.csdn.net/wangyaninglm/article/category/1653815" class="uri">http://blog.csdn.net/wangyaninglm/article/category/1653815</a>）</p>
]]></content>
      <categories>
        <category>Study</category>
      </categories>
      <tags>
        <tag>opencv</tag>
      </tags>
  </entry>
  <entry>
    <title>OpenDrive解析小结</title>
    <url>/posts/b7d79231.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　接触并使用高精地图和 OpenDRIVE 已有一年的时间，简要写写 Shaun 对 OpenDRIVE 的一些认知。</p>
<span id="more"></span>
<h2 id="基础篇">基础篇</h2>
<p>OpenDRIVE 目前最新的版本的 1.6，下面主要结合 1.4，1.5 和1.6 版本一起看。</p>
<p>　　在 OpenDRIVE 中主要有两种坐标系统，一种是常见的 X/Y/Z 空间坐标系统，另一种是 S/T/H 坐标系统。其中 X/Y/Z 坐标系统常与地理信息的各种坐标系统一起使用，S/T/H 坐标系统是针对 OpenDRIVE 中道路参考线设定的一种局部坐标系统，在 OpenDRIVE 中称前者为 “inertial co-ordinates”，后者为 “track co-ordinates”（1.6 中直接为 Reference Line System）。除此之外，还有个局部坐标系 U/V/Z，该坐标系统系统是相对于 S/T/H 坐标系统平移旋转而来的。</p>
<p>对于旋转，以逆时针为正，heading 是指绕 z/h 轴旋转，pitch 是指绕 y/t 轴旋转，roll 是指绕 x/s 轴旋转。</p>
<p>对于曲率，逆时针延申的曲线曲率为正，顺时针延申的曲线曲率为负。</p>
<p>在 OpenDRIVE 中对于道路和车道的描述，有以下几个重要的概念：</p>
<ul>
<li>Reference Line。用来指示一条道路的骨架，是 S/T/H 坐标系统的依据，道路中各车道线需要参考这条线。</li>
<li>Lanes。用来描述各车道以及各车道所属 Lane Section。</li>
<li>Lane Offset。其意义在 OpenDRIVE 标准看起来很清除，但实际用起来非常模糊，offset 到底是只能偏移一个车道，或半个车道或多个车道，所属哪个 Lane Section，其意义不明，故下文解析篇将直接忽略该属性。</li>
<li>Lane Section。可以简单理解为子道路，一个 lane section 中包含多条车道，一条道路包含多个 lane section。一个 lane section 中车道数是一个常数，所以对于存在 m 变 n 车道的一条道路，至少要划分为两个 lane section。</li>
<li>Superelevation、Crossfall 和 Shape。用来表示路面倾斜程度。Superelevation 是整个路面侧向太高，即路面倾斜程度，<strong>Crossfall 在 1.6 中已被废弃</strong>，原因为 1.6 完善了 Shape，可以完全取代 CrossFall，甚至能做的更好，Shape 主要用来描述路面两侧车道的倾斜程度，通过三次曲线和线性插值可以精确到车道各点倾斜程度。</li>
<li>Road Linkage。道路之间的连接关系，通过前继（predecessor）和后继（successor）建立道路之间连接关系，若一条路存在多个前继或后继，则其对应前继或后继应该为 Junction ，即目前的标准中暂不支持道路多前后继，1.5 中只支持车道多前后继，道路多前后继依然不支持。</li>
<li>Junction。交汇处，通俗意义上的路口，主要包含 incomingRoad 和 connectingRoad。</li>
<li>Junction Group。可以简单理解为交通环岛。</li>
<li>Neighbors。相邻关系，和 Road Linkage 类似，一个是前后连接关系，一个侧面相邻关系。</li>
<li>Surface。车道或道路表面材质，有 OpenCRG 则优先使用，没有则由应用程序自定义字符串。</li>
<li>....... 等等。还有一些冷门的元素暂时没用到，就不介绍了。</li>
</ul>
<p>下面就是真正的解析内容了。</p>
<h2 id="解析篇">解析篇</h2>
<p>　　一些简单的就不介绍了，就介绍解析时需要注意的一些重点元素。</p>
<h3 id="road-geometry">Road Geometry</h3>
<p>　　geometry 信息可以说是 OpenDRIVE 中最重要的信息，没有之一。OpenDRIVE 中最重要的元素为 Road，而 Road 中最重要的是 Reference Line，而 geometry 正是用来描述 Reference Line 几何线条形状的信息。</p>
<p>　　首先 geometry 标签中共有 5 个属性，分别为 s （该段 geometry 沿参考线起始位置），x（该段 geometry 在 inertial system 下起始横坐标），y（该段 geometry 在 inertial system 下起始纵坐标），hdg（该段 geometry 在 inertial system 下起始弧度），length（该段 geometry 长度）。其次，geometry 共有 5 种线型，分别为 straight lines（直线），spirals（螺线），arcs（圆弧线），cubic polynomials（三次曲线），parametric cubic polynomials（参数化三次曲线），这 5 种线型分别由 geometry 下 5 种标签控制。解析 geometry 的要点在于：<strong>先不用管 geometry 标签中的属性，直接解析对应线型标签，需要满足两点：1、起始点坐标一定为 (0, 0)；2、起始点斜率，即导数也一定为 0。依据这两点正确解析完线型之后，再根据 hdg 旋转线型，根据 (x, y) 将线型平移到正确位置。</strong> 下面就具体看看这 5 种线型：</p>
<ol type="1">
<li>line，直线。没有任何属性，直接根据 geometry 中 (x, y) 和 hdg 就可得到直线方程。</li>
<li>spiral，螺线。有两个属性 curvStart（起始曲率），curvEnd（结束曲率）。螺线解析的代码已经由 OpenDRIVE 官方直接给出了，里面涉及到的数值计算方法就不详解了，直接看官方提供 API 的输入输出，输入有两个：s（从原点开始，螺线延展的长度），cDot（螺线的曲率关于 s 的一阶导数）；输出有 3 个：x（横坐标），y（纵坐标），t（该点的切线弧度）。解析螺线最大的问题应该就是如何得到这两个输入参数，由螺线的性质可以得到，螺线的曲率一定随着螺线的长度均匀变化的，换句话说，对于一条已知螺线，cDot 一定是常数。则 <span class="math inline">\(cDot = (curvEnd - curvStart) / length\)</span>，其中 length 为 geometry 中的长度属性，下一步需要求出 s，由于已知螺线在原点处的曲率一定为 0，则 (curv - 0) / (s - 0) = cDot，即 s = curv / cDot。由此可得到螺线的各点坐标和切向方向，但由于解析线型需要满足上面说的两点，所以需要将螺线坐标以起始点进行平移和旋转，以满足起始点为原点，起始点切线弧度为 0，最后再将完成平移和旋转后的点根据 geometry 的属性进行旋转和平移以得到真正的坐标点。</li>
<li>arc，圆弧线。只有一个属性 curvature（曲率），可根据曲率直接得到圆的半径，在根据曲率的正负可得到该曲线是以顺时针延申还是逆时针延申，再根据解析线型需要满足的两点和 geometry 的属性可得到真正的 inertial system 中的点。</li>
<li>poly3，三次曲线，<strong>在 1.6 中已被废弃</strong>。精度要求低一点可直接插值计算，要求高一点则需要利用 length ，数值计算和二分法直接求出最大的 u，然后插值。</li>
<li>paramPoly3，参数化三次曲线。最有名的两个参数化三次曲线就是 Bezier 曲线和 Hermite 曲线，为满足解析线型需要满足的两点，一定有 <span class="math inline">\(a_u=0, a_v=0,b_v=0\)</span>，需要注意的是一般参数化曲线的参数取值范围为 <span class="math inline">\([0,1]\)</span>，即该标签最后一个属性 pRange="normalized"，若碰到特殊情况 pRange="arcLength"，则需要将 <span class="math inline">\(a_u,b_u,\dots\)</span> 等属性转化为参数取值范围为 <span class="math inline">\([0,1]\)</span> 时对应的属性。</li>
</ol>
<p>最重要的元素 Geometry 的解析就是这样了，下面谈谈 Shaun 对基于三次曲线的一些元素的理解。</p>
<hr />
<p>　　比较重要的基于三次曲线的元素主要有 elevation（控制路面的高度），superelevation（道路侧面抬高弧度），crossfall（路面两侧弧度，<strong>已被废弃</strong>），shape（路面两侧形状，<em>特殊，下文详细介绍</em>），laneOffset（车道偏移量），border 和 width（<em>特殊，下文详细介绍</em>），这些元素所使用的三次曲线一般都基于道路参考线（<em>特殊除外</em>），即该三次曲线的横坐标一般为 s，纵坐标即三次曲线的值则为各元素的信息，这些三次曲线一般是分段描述的，即道路参考线上两个关键点的 s 之间必会生成对应的一段三次曲线，每一段三次曲线的横坐标取值范围都为 <span class="math inline">\([0,poly3Length]\)</span>，其中 ploy3Length 为该段三次曲线的长度。这些三次曲线段全部合起来则构成沿道路参考线的一条三次曲线，根据 s 计算三次曲线的取值得到对应的信息。</p>
<h3 id="laneoffset">LaneOffset</h3>
<p>　　laneOffset 用来指示的是所有车道沿参考线法线方向的偏移量，所有车道包括中心车道（centerLane），由于中心车道没有宽度，所以也可以叫道路中心线，这和道路参考线是两个概念，若 laneOffset 都为 0，则道路中心线和道路参考线重合。</p>
<h3 id="shape">Shape</h3>
<p>　　路面两侧车道的高度，该元素虽然也是使用三次曲线进行描述的，但是该三次曲线的横坐标为 S/T/H 坐标中的 t，不是 s，不同的 t 得到不同的高度，该元素下可能存在多段三次曲线，这些三次曲线段是独立的，只是描述其属性 s 所在位置横截面的 shape，而没有完全指定 s 的横截面的 shape，则由两临近 s 的 三次曲线计算相同的 t 对应的高度然后线型插值得到（1.6 标准中插值的公式 Shaun 觉得有问题）。</p>
<h3 id="border-和-width">border 和 width</h3>
<p>　　之所以把这个两个元素放在一起写，是因为这两个元素描述的本质上是一个东西，都是车道边界所在的位置。同时，Shaun 还是想吐槽一下，作为一个既定的标准，完全不应该把这两个元素同时放出来，只需要放出一个即可，既然为标准就应该做到完全统一，至于具体用哪个是应用程序的事，但是出来的东西必须得唯一。border 是指车道边界到道路中心线在道路参考线法线上的投影，有正负之分，一般左边车道为正，右边车道为负，而 width 是指车道的宽度，这两者完全可以相互转换。虽然描述这两者的三次曲线是基于道路参考线 s 的，但是这个 s 是相对于 laneSection 标签中 s 属性的，即其真正沿道路参考线的 s' 应该为 s' = s + laneSection.s。</p>
<hr />
<p>　　至于Junction 的解析好像没什么需要注意的，就不写了，至于 1.5 中的 Virtual Junction，引入新的道路前后继描述方式，也新加了一个 virtual connection，解析时到也没有需要注意的，唯一需要注意是在应用程序中该如何利用这些信息。</p>
<hr />
<p>　　对于 Signal 和 Object，Shaun 觉得标准中强制规定 s &gt; 0 同样是一件非常不合理的事情，既然能超出道路长度，只准正向超出，不能反向超出，这有点不讲道理。 Signal 和 Object 同样需要注意在应用程序中的用法，至于解析方面，需要注意的应该就是 Object 中 outline 下面的 cornerRoad 和 cornerLocal。</p>
<h3 id="cornerroad-和-cornerlocal">cornerRoad 和 cornerLocal</h3>
<p>　　这两个元素描述的本质上也是一个东西，都是面域对象多边形边界上的轮廓点，虽然 1.5 中引入了复杂多边形的概念，即有内轮廓和外轮廓，但 cornerRoad 和 cornerLocal 还是一样的解析。cornerRoad 是直接相对于道路参考线的坐标，即将 X/Y/Z 坐标直接转换为 S/T/H 坐标得到的，所以直接解析转换就可得到该点的真正坐标。而 cornerLocal 的解析则相对要麻烦些，首先根据 object 标签中 s 和 t 属性计算得到 Object 的位置，以道路参考线上 s 所在的位置建立 S/T/H 坐标系统，将该坐标系统平移到 Object 所在位置，即该 S/T/H 系统以Object 的位置为原点，将 cornerLocal 上 u,v,z 属性带入该坐标系统计算出真正的坐标。由于 Object 中的 roll,pitch,hdg 属性，所以还需要对坐标以 Object 的位置为中心进行相应旋转才能得到真正 X/Y/Z 坐标系统中坐标。</p>
<hr />
<p>好了，以上就是 Shaun 觉得在解析 OpenDRIVE 时需要注意的一些地方了。</p>
<h2 id="后记">后记</h2>
<p>　　整个地图行业本来就存在很强的壁垒，国内更是如此，而高精地图作为专为自动驾驶服务的地图，国内估计更是少有人接触过。</p>
<p>　　OpenDRIVE 虽作为一种高精地图标准，但离那种被广泛认可关注的标准还有很长一段距离，虽然它发展了十几年，但奈何整个行业才算是起步阶段，所以之前其一直发展的十分缓慢，之前用 OpenDRIVE 较多的应该是交通仿真领域，这个领域同样存在很强的壁垒，要在这种领域得到整个行业的认可是一件非常困难的事，因为其本来就存在一套自己的格式，而想要应用别人的标准，就势必需要逐渐抛弃自己的格式，这对企业来说需要下很大的决心。</p>
<p>　　就 Shaun 目前所知，行业内虽然有许多企业使用 OpenDRIVE 标准，但基本都是自己魔改后的标准，原因在于 OpenDRIVE 标准还没做到真正成为标准的地步，虽然其一些基本元素具备，但很有很多元素是完全缺失或不完善的，更重要的是，其可视化程序竟然不开源，在整个计算机领域内，还从没见过一种标准没有其开源实现的东西，没有相应的源码，只靠文字来理解难免会产生歧义，各大厂商自然就会选择实现自己的 OpenDRIVE，很难统一。历史上一些经典的论文和算法，都有其相应的开源实现，没有开源实现的论文和算法基本都淹没在了历史长河之中。所以没有开源实现，在计算机领域内很难真正推广开，就很难成为真正的标准。综上，OpenDRIVE 的发展任重而道远啊！希望现在在 ASAM 手中能发展的更快更完善些吧。</p>
]]></content>
      <categories>
        <category>Share</category>
      </categories>
      <tags>
        <tag>note</tag>
        <tag>opendrive</tag>
      </tags>
  </entry>
  <entry>
    <title>PyQt5使用小结</title>
    <url>/posts/5f54aa2c.html</url>
    <content><![CDATA[<p><font color=#FA8072>本文所用的 Python 版本为 python-3.6.2，PyQt5 版本为 pyqt5-5.9.1，OpenCV 版本为 opencv-python-3.3.0.10 和 opencv-contrib-python-3.3.0.10，TensorFlow 版本为 tensorflow-1.4.0，编程语言为 python3，系统环境为 Windows 10。</font></p>
<h2 id="前言">前言</h2>
<p>　　本文是上一篇（<a href="https://cniter.github.io/posts/82d3b275.html">TensorFlow Object Detection API使用小结</a>）的后续，因为那个 project 还需要一个界面，所以 Shaun 使用 PyQt 做了这么个界面，其中借用 OpenCV 的图像数据显示。</p>
<span id="more"></span>
<h2 id="准备篇">准备篇</h2>
<p>　　首先使用 pip 安装所需库，由于上一篇已经安装了 tensorflow，所以本文其实只需要安装 pyqt5 和 opencv-python 就可以了，安装 pyqt5 指令为：<code>pip install pyqt5</code>，相关依赖关系解决办法在上一篇中已提到，这里不再赘述，然后再使用指令 <code>pip install opencv-python</code> 安装 opencv，这里 Shaun 发现在 python 中配置 OpenCV 简直不要太轻爽 O(∩_∩)O~~，就一个 pip 就解决了，哪有 C++ 那么麻烦，以后可能还会继续使用 python 版的 opencv，所以就顺便把它 python 版的扩展包也顺便一起装上，安装指令为：<code>pip install opencv-contrib-python</code>。至此所需环境库安装完毕。</p>
<p>　　<strong>※注</strong>：相对于上文中使用 pip 在线安装的方式，还有另一种使用 pip 进行离线安装的方式，在 <a href="https://www.lfd.uci.edu/~gohlke/pythonlibs/">Unofficial Windows Binaries for Python Extension Packages</a>上下载离线包，即 XXXXXX.whl 文件，文件名一般包含库名称和对应版本、python 版本以及是 64 位还是 32 位的等信息，这里以离线包 <a href="https://www.lfd.uci.edu/~gohlke/pythonlibs/#numpy">numpy-1.13+mkl</a> 为例，首先下载适合自己的库版本，适合 Shaun 的当然是 numpy-1.13.3+mkl-cp36-cp36m-win_amd64.whl（这适合 64 位的 python3.6 安装），将命令行目录切换至 numpy-1.13.3+mkl-cp36-cp36m-win_amd64.whl 文件所在目录，输入指令 <code>pip install numpy-1.13.3+mkl-cp36-cp36m-win_amd64.whl</code> 即可离线安装 numpy-1.13+mkl 库。相比在线安装，这种离线安装更加灵活，而且能够安装一些在线安装无法安装的库，像上文中的 numpy-1.13+mkl 库只能采取离线安装的方式，在线安装只能安装不带 mkl 的 numpy 库。采用离线安装方式也可以直接安装带扩展包的 opencv-python库：<em>opencv_python‑3.3.1+contrib‑cp36‑cp36m‑win_amd64.whl</em> ，不需要像在线安装那样装两个库。</p>
<h2 id="实践篇">实践篇</h2>
<p>　　以前有用过 Qt 的基础，所以这次使用 PyQt5 感觉上手很快，毕竟这里面的语法有很多是相通的，再加上网上的资料也有很多，所以很快就做了个简陋的界面。不过直接用代码控制界面的布局确实很麻烦，每改下布局都要重新运行一下看看，而且启动时间还有点长 ╮(╯﹏╰）╭。网上有种说法是：</p>
<blockquote>
<p>可以先通过QtDesigner设计UI，然后通过Qt提供的命令行工具pyuic5将.ui文件转换成python代码，具体用法是：若ui文件名称为firstPyQt5.ui，则在命令行界面中输入指令：<code>pyuic5 -o firstPyQt5.py firstPyQt5.ui</code>，即可将firstPyQt5.ui文件转换成python代码文件firstPyQt5.py</p>
</blockquote>
<p>不过 Shaun 这里由于界面比较简陋，没有几个控件，所以就直接将其用 python 代码控制了，没去尝试这个命令行工具 pyuic5 了，下次有机会再尝试吧 ↖(^ω^)↗。</p>
<p>　　Shaun 做的这个小界面实现的功能是：1、可以选择已经训练好的模型来检测选定图片中的目标；2、可以播放选定的视频；3、还有打开摄像头，显示摄像头拍摄的视频。</p>
<p>其中由于 Shaun 电脑无法实时检测目标，所以在视频和摄像头拍摄中就没有添加检测的代码，只有选择图片时才会执行检测功能，有需要的童靴可以自行添加(•̀ᴗ•́)。</p>
<p>附完整代码如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PYTHON"><div class="code-copy"></div><figure class="highlight hljs python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys  </span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> PyQt5.QtCore <span class="keyword">import</span> * </span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtGui <span class="keyword">import</span> * </span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span> object_detection.utils <span class="keyword">import</span> label_map_util</span><br><span class="line"><span class="keyword">from</span> object_detection.utils <span class="keyword">import</span> visualization_utils <span class="keyword">as</span> vis_util</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Detector</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.PATH_TO_CKPT = <span class="string">&#x27;./model/hand_model_faster_rcnn_resnet101.pb&#x27;</span>   <span class="comment"># 选择模型文件</span></span><br><span class="line">        self.PATH_TO_LABELS = <span class="string">r&#x27;./model/hands_label_map.pbtxt&#x27;</span>  <span class="comment"># 选择类别标签文件</span></span><br><span class="line">        self.NUM_CLASSES = <span class="number">1</span></span><br><span class="line">        self.detection_graph = self._load_model()   <span class="comment"># 加载模型</span></span><br><span class="line">        self.category_index = self._load_label_map()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_load_model</span>(<span class="params">self</span>):</span></span><br><span class="line">        detection_graph = tf.Graph()</span><br><span class="line">        <span class="keyword">with</span> detection_graph.as_default():</span><br><span class="line">            od_graph_def = tf.GraphDef()</span><br><span class="line">            <span class="keyword">with</span> tf.gfile.GFile(self.PATH_TO_CKPT, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> fid:</span><br><span class="line">                serialized_graph = fid.read()</span><br><span class="line">                od_graph_def.ParseFromString(serialized_graph)</span><br><span class="line">                tf.import_graph_def(od_graph_def, name=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> detection_graph</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_load_label_map</span>(<span class="params">self</span>):</span></span><br><span class="line">        label_map = label_map_util.load_labelmap(self.PATH_TO_LABELS)</span><br><span class="line">        categories = label_map_util.convert_label_map_to_categories(label_map,</span><br><span class="line">                                                                    max_num_classes=self.NUM_CLASSES,</span><br><span class="line">                                                                    use_display_name=<span class="literal">True</span>)</span><br><span class="line">        category_index = label_map_util.create_category_index(categories)</span><br><span class="line">        <span class="keyword">return</span> category_index</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">detect</span>(<span class="params">self, image</span>):</span></span><br><span class="line">        <span class="keyword">with</span> self.detection_graph.as_default():</span><br><span class="line">            <span class="keyword">with</span> tf.Session(graph=self.detection_graph) <span class="keyword">as</span> sess:</span><br><span class="line">                <span class="comment"># Expand dimensions since the model expects images to have shape: [1, None, None, 3]</span></span><br><span class="line">                image_np_expanded = np.expand_dims(image, axis=<span class="number">0</span>)</span><br><span class="line">                image_tensor = self.detection_graph.get_tensor_by_name(<span class="string">&#x27;image_tensor:0&#x27;</span>)</span><br><span class="line">                boxes = self.detection_graph.get_tensor_by_name(<span class="string">&#x27;detection_boxes:0&#x27;</span>)</span><br><span class="line">                scores = self.detection_graph.get_tensor_by_name(<span class="string">&#x27;detection_scores:0&#x27;</span>)</span><br><span class="line">                classes = self.detection_graph.get_tensor_by_name(<span class="string">&#x27;detection_classes:0&#x27;</span>)</span><br><span class="line">                num_detections = self.detection_graph.get_tensor_by_name(<span class="string">&#x27;num_detections:0&#x27;</span>)</span><br><span class="line">                <span class="comment"># Actual detection.</span></span><br><span class="line">                (boxes, scores, classes, num_detections) = sess.run(</span><br><span class="line">                    [boxes, scores, classes, num_detections],</span><br><span class="line">                    feed_dict=&#123;image_tensor: image_np_expanded&#125;)</span><br><span class="line">                <span class="comment"># Visualization of the results of a detection.</span></span><br><span class="line">                vis_util.visualize_boxes_and_labels_on_image_array(</span><br><span class="line">                    image,</span><br><span class="line">                    np.squeeze(boxes),</span><br><span class="line">                    np.squeeze(classes).astype(np.int32),</span><br><span class="line">                    np.squeeze(scores),</span><br><span class="line">                    self.category_index,</span><br><span class="line">                    use_normalized_coordinates=<span class="literal">True</span>,</span><br><span class="line">                    line_thickness=<span class="number">8</span>)</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">return</span> image</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DetectUI</span>(<span class="params">QWidget</span>):</span></span><br><span class="line">     </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">         </span><br><span class="line">        self.initUI()</span><br><span class="line">        self.detector = Detector()</span><br><span class="line">        self.cap = cv2.VideoCapture()</span><br><span class="line">         </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initUI</span>(<span class="params">self</span>):</span>  </span><br><span class="line">        self.timer = QTimer(self)   <span class="comment"># 初始化一个定时器</span></span><br><span class="line">        self.timer.timeout.connect(self.showFrame)  <span class="comment"># 计时结束调用showFrame()方法</span></span><br><span class="line">        </span><br><span class="line">        self.show_pic_label = QLabel(self) </span><br><span class="line">        self.show_pic_label.resize(<span class="number">640</span>, <span class="number">480</span>)</span><br><span class="line">        self.show_pic_label.move(<span class="number">10</span>, <span class="number">10</span>)</span><br><span class="line">        self.show_pic_label.setStyleSheet(<span class="string">&quot;border-width: 1px; border-style: solid; border-color: rgb(255, 170, 0);&quot;</span>)            </span><br><span class="line"></span><br><span class="line">        self.show_filename_lineEdit = QLineEdit(self) </span><br><span class="line">        self.show_filename_lineEdit.resize(<span class="number">200</span>, <span class="number">22</span>)</span><br><span class="line">        self.show_filename_lineEdit.move(<span class="number">10</span>, <span class="number">500</span>) </span><br><span class="line"></span><br><span class="line">        self.select_img_btn = QPushButton(<span class="string">&#x27;Select File&#x27;</span>, self)   </span><br><span class="line">        self.select_img_btn.clicked.connect(self.selectImg) </span><br><span class="line">        self.select_img_btn.resize(self.select_img_btn.sizeHint())</span><br><span class="line">        self.select_img_btn.move(<span class="number">218</span>, <span class="number">500</span>) </span><br><span class="line"></span><br><span class="line">        self.open_camera_btn = QPushButton(<span class="string">&#x27;Open Camera&#x27;</span>, self)   </span><br><span class="line">        self.open_camera_btn.clicked.connect(self.openCamera) </span><br><span class="line">        self.open_camera_btn.resize(self.open_camera_btn.sizeHint())</span><br><span class="line">        self.open_camera_btn.move(<span class="number">292</span>, <span class="number">500</span>)</span><br><span class="line"></span><br><span class="line">        self.select_model_btn = QPushButton(<span class="string">&#x27;Select Model&#x27;</span>, self)   </span><br><span class="line">        self.select_model_btn.clicked.connect(self.selectModel) </span><br><span class="line">        self.select_model_btn.resize(self.select_model_btn.sizeHint())</span><br><span class="line">        self.select_model_btn.move(<span class="number">366</span>, <span class="number">500</span>) </span><br><span class="line"></span><br><span class="line">        self.show_modelname_lineEdit = QLineEdit(self) </span><br><span class="line">        self.show_modelname_lineEdit.setText(<span class="string">&#x27;hand_model_faster_rcnn_resnet101.pb&#x27;</span>)</span><br><span class="line">        self.show_modelname_lineEdit.resize(<span class="number">200</span>, <span class="number">22</span>)</span><br><span class="line">        self.show_modelname_lineEdit.move(<span class="number">450</span>, <span class="number">500</span>) </span><br><span class="line"></span><br><span class="line">        self.setGeometry(<span class="number">200</span>, <span class="number">100</span>, <span class="number">660</span>, <span class="number">530</span>)</span><br><span class="line">        self.setWindowTitle(<span class="string">&#x27;Hand Detector&#x27;</span>)   </span><br><span class="line">        self.show()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">showImg</span>(<span class="params">self, src_img, qlabel</span>):</span></span><br><span class="line">        src_img = cv2.cvtColor(src_img, cv2.COLOR_BGR2RGB)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># src_img = self.detector.detect(src_img) # 检测目标</span></span><br><span class="line"></span><br><span class="line">        height, width, bytesPerComponent = src_img.shape</span><br><span class="line">        bytesPerLine = bytesPerComponent * width</span><br><span class="line">        <span class="comment"># 转为QImage对象</span></span><br><span class="line">        q_image = QImage(src_img.data, width, height, bytesPerLine, QImage.Format_RGB888)</span><br><span class="line">        qlabel.setPixmap(QPixmap.fromImage(q_image).scaled(qlabel.width(), qlabel.height())) </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">showFrame</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span>(self.cap.isOpened()):</span><br><span class="line">            ret, frame = self.cap.read()</span><br><span class="line">            <span class="keyword">if</span> ret:</span><br><span class="line">                self.showImg(frame, self.show_pic_label)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.cap.release()</span><br><span class="line">                self.timer.stop()   <span class="comment"># 停止计时器</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">selectImg</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.cap.isOpened():</span><br><span class="line">            self.cap.release()</span><br><span class="line"></span><br><span class="line">        file_name, file_type = QFileDialog.getOpenFileName(self,  </span><br><span class="line">                                    <span class="string">&quot;选取文件&quot;</span>,  </span><br><span class="line">                                    <span class="string">&quot;./&quot;</span>,  </span><br><span class="line">                                    <span class="string">&quot;Image Files (*.jpg *.png *.bmp *.tif);;Video Files (*.avi *.mp4)&quot;</span>)   <span class="comment">#设置文件扩展名过滤,注意用双分号间隔过滤，用空格分隔多个文件  </span></span><br><span class="line">        <span class="comment"># print(file_name,file_type)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> file_type.find(<span class="string">&quot;Image&quot;</span>) &gt;= <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> file_name:</span><br><span class="line">                self.show_filename_lineEdit.setText(os.path.split(file_name)[<span class="number">1</span>])</span><br><span class="line">            </span><br><span class="line">                img = cv2.imread(file_name, cv2.IMREAD_COLOR)</span><br><span class="line">                cv2.cvtColor(img, cv2.COLOR_BGR2RGB, img)</span><br><span class="line"></span><br><span class="line">                img = self.detector.detect(img) <span class="comment"># 检测目标</span></span><br><span class="line"></span><br><span class="line">                height, width, bytesPerComponent = img.shape</span><br><span class="line">                bytesPerLine = bytesPerComponent * width</span><br><span class="line">                <span class="comment"># 转为QImage对象</span></span><br><span class="line">                q_image = QImage(img.data, width, height, bytesPerLine, QImage.Format_RGB888)</span><br><span class="line">                self.show_pic_label.setPixmap(QPixmap.fromImage(q_image).scaled(self.show_pic_label.width(), self.show_pic_label.height()))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> file_type.find(<span class="string">&quot;Video&quot;</span>) &gt;= <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> file_name:</span><br><span class="line">                self.show_filename_lineEdit.setText(os.path.split(file_name)[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">                self.cap.<span class="built_in">open</span>(file_name)</span><br><span class="line">                self.timer.start(<span class="number">30</span>)    <span class="comment"># 设置时间隔30ms并启动</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">openCamera</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.cap.<span class="built_in">open</span>(<span class="number">0</span>)    <span class="comment"># 默认打开0号摄像头</span></span><br><span class="line">        self.timer.start(<span class="number">30</span>)    <span class="comment"># 设置时间隔30ms并启动</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">selectModel</span>(<span class="params">self</span>):</span>  </span><br><span class="line">        model_name, file_type = QFileDialog.getOpenFileName(self,  </span><br><span class="line">                                    <span class="string">&quot;选取文件&quot;</span>,  </span><br><span class="line">                                    <span class="string">&quot;./&quot;</span>,  </span><br><span class="line">                                    <span class="string">&quot;model Files (*.pb);;All Files (*)&quot;</span>)   <span class="comment">#设置文件扩展名过滤,注意用双分号间隔过滤，用空格分隔多个文件  </span></span><br><span class="line">               </span><br><span class="line">        <span class="keyword">if</span> model_name:</span><br><span class="line">            self.show_modelname_lineEdit.setText(os.path.split(model_name)[<span class="number">1</span>])</span><br><span class="line">            self.detector.PATH_TO_CKPT = model_name</span><br><span class="line">            self.detector.detection_graph = self.detector._load_model() <span class="comment"># 重新加载模型</span></span><br><span class="line">         </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app = QApplication(sys.argv)</span><br><span class="line">    dtcui = DetectUI()</span><br><span class="line">    sys.exit(app.exec_())</span><br></pre></td></tr></table></figure></div>
<h2 id="后记">后记</h2>
<p>　　初次使用 Python 做一个小东西，其语法确实简洁，不过对于 Shaun 这种习惯用 C++ 的人来说确实还有点不太习惯 (˘•ω•˘)。</p>
<h2 id="参考资料">参考资料</h2>
<p>[1] <a href="http://blog.csdn.net/m0_37928067/article/details/75883535">用PyQt5+Caffe+Opencv搭建一个人脸识别登录界面</a></p>
<p>[2] <a href="http://blog.csdn.net/a359680405/article/details/45166271">PyQt5学习笔记09----标准文件打开保存框QFileDialog</a></p>
<p>[3] <a href="http://www.cnblogs.com/archisama/p/5444032.html">PyQt5教程——第一个程序（2）</a>（<a href="http://www.cnblogs.com/archisama/tag/PyQt5/" class="uri">http://www.cnblogs.com/archisama/tag/PyQt5/</a>）</p>
<p>[4] <a href="http://www.cnblogs.com/skynet/p/4229556.html">PyQt5应用与实践</a></p>
<p>[5] <a href="http://www.cnblogs.com/tkinter/p/5632245.html">PyQt5系列教程(二)利用QtDesigner设计UI界面</a>（<a href="http://www.cnblogs.com/tkinter/tag/pyqt5/" class="uri">http://www.cnblogs.com/tkinter/tag/pyqt5/</a>）</p>
<p>[6] <a href="https://docs.opencv.org/3.2.0/index.html">OpenCV 3.2.0</a>/<a href="https://docs.opencv.org/3.2.0/d6/d00/tutorial_py_root.html">OpenCV-Python Tutorials</a>/<a href="https://docs.opencv.org/3.2.0/dc/d4d/tutorial_py_table_of_contents_gui.html">Gui Features in OpenCV</a>/<a href="https://docs.opencv.org/3.2.0/dc/d2e/tutorial_py_image_display.html">Getting Started with Images</a></p>
<p>[7] <a href="https://docs.opencv.org/3.2.0/index.html">OpenCV 3.2.0</a>/<a href="https://docs.opencv.org/3.2.0/d6/d00/tutorial_py_root.html">OpenCV-Python Tutorials</a>/<a href="https://docs.opencv.org/3.2.0/dc/d4d/tutorial_py_table_of_contents_gui.html">Gui Features in OpenCV</a>/<a href="https://docs.opencv.org/3.2.0/dd/d43/tutorial_py_video_display.html">Getting Started with Videos</a></p>
<p>[8] <a href="http://blog.csdn.net/keenweiwei/article/details/9037757">python3.3 分割路径与文件名 小例</a></p>
]]></content>
      <categories>
        <category>Study</category>
      </categories>
      <tags>
        <tag>opencv</tag>
        <tag>python</tag>
        <tag>qt</tag>
      </tags>
  </entry>
  <entry>
    <title>Scala 多线程编程小结</title>
    <url>/posts/9c9b4035.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　多线程的执行方式有两种：并发（Concurrent）和并行（Parallel），简单来说，并发就是两个线程轮流在一个 CPU 核上执行，而并行则是两个线程分别在两个 CPU 核上运行。一般而言，程序员无法直接控制线程是并发执行还是并行执行，线程的执行一般由操作系统直接控制，当然程序运行时也可以做简单调度。所以对于一般程序员来说，只需要熟练使用相关语言的多线程编程库即可，至于是并发执行还是并行执行，可能并不是那么重要，只要能达到预期效果就行。</p>
<span id="more"></span>
<p>　　Shaun 目前接触的 Scala 原生多线程编程语法就两个：Future 和 Parallel Collections。其中 Future 用的的最多，并且 Parallel Collections 语法非常简单，所以主要介绍 Future，附带提一下 Parallel Collections。</p>
<h2 id="executioncontext-篇">ExecutionContext 篇</h2>
<p>　　ExecutionContext 是 Future 的执行上下文，相当于是 Java 的线程池，Java 的线程池主要有以下两类：</p>
<ul>
<li>ThreadPool：所有线程共用一个任务队列，当线程空闲时，从队列中取一个任务执行。</li>
<li>ForkJoinPool：每个线程各有一个任务队列，当线程空闲时，从其他线程的任务队列中取一批任务放进自己的队列中执行。</li>
</ul>
<p>　　对于少量任务，这两个池子没啥区别，只是 ThreadPool 在某些情况下会死锁，比如在一个并行度为 2 （最多两个线程）的 ThreadPool 中执行两个线程，两个线程又分别提交一个子任务，并等到子任务执行完才退出，这时会触发相互等待的死锁条件，因为没有多余的空闲线程来执行子任务，而 ForkJoinPool 中每个线程产生的子任务会放在自己的任务队列中，ForkJoinPool 可以在线程耗尽时额外创建线程，也可以挂起当前任务，执行子任务，从而防止死锁。对于大量任务，ForkJoinPool 中的空闲线程会从其他线程的任务队列中一批一批的取任务执行，所以一般会更快，当然若各个任务执行时间比较均衡，则 ThreadPool 会更快。</p>
<p>　　根据线程池创建的参数不同，Executors 中提供了 5 种线程池：newSingleThreadExecutor（单线程线程池，可保证任务执行顺序），newFixedThreadPool（固定大小线程池，限制并行度），newCachedThreadPool（无限大小线程池，任务执行时间小采用），newScheduledThreadPool（同样无限大小，用来处理延时或定时任务），newWorkStealingPool（ForkJoinPool 线程池）。前四种都属于 ThreadPool，根据阿里的 Java 的编程规范，不推荐直接使用 Executors 创建线程池，不过对于计算密集型任务，一般使用 newFixedThreadPool 或 newWorkStealingPool 即可，线程数设置当前 CPU 数即可（Runtime.getRuntime.availableProcessors()），多了反而增加线程上下文切换次数，对CPU 的利用率不增反减。</p>
<p>　　Scala 提供了一个默认的 ExecutionContext：<code>scala.concurrent.ExecutionContext.Implicits.global</code>，其本质也是一个 ForkJoinPool，并行度默认设置为当前可用 CPU 数，当然也会根据需要（比如当前全部线程被阻塞）额外创建更多线程。一般做计算密集型任务就用默认线程池即可，特殊情况也可以自己创建 <code>ExecutionContext.fromExecutor(Executors.newFixedThreadPool(8))</code>，下面的代码就可以创建一个同步阻塞的 ExecutionContext：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> currentThreadExecutionContext = <span class="type">ExecutionContext</span>.fromExecutor(</span><br><span class="line">  <span class="keyword">new</span> <span class="type">Executor</span> &#123;</span><br><span class="line">    <span class="comment">// Do not do this!</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">execute</span></span>(runnable: <span class="type">Runnable</span>) &#123; runnable.run() &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></div>
<p>原因是 <code>runnable.run()</code> 并不会新开一个线程，而是直接在主线程上执行，和调用普通函数一样。</p>
<h2 id="future-篇">Future 篇</h2>
<p>　　先上一个简单的 Future 并发编程 Demo：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="code"><pre><span class="line"><span class="comment">////import scala.concurrent.ExecutionContext.Implicits.global</span></span><br><span class="line"><span class="comment">//val pool = Executors.newFixedThreadPool(Runtime.getRuntime.availableProcessors())</span></span><br><span class="line"><span class="keyword">val</span> pool = <span class="type">Executors</span>.newWorkStealingPool()</span><br><span class="line"><span class="keyword">implicit</span> <span class="keyword">val</span> ec = <span class="type">ExecutionContext</span>.fromExecutorService(pool)</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> futures = <span class="type">Array</span>.range(<span class="number">0</span>, <span class="number">10000</span>).map(i =&gt; <span class="type">Future</span> &#123;</span><br><span class="line">  println(i)</span><br><span class="line">  <span class="type">Thread</span>.sleep(<span class="number">100</span>)</span><br><span class="line">  i</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> futureSequence = <span class="type">Future</span>.sequence(futures)</span><br><span class="line">futureSequence.onComplete(&#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="type">Success</span>(results) =&gt; &#123;</span><br><span class="line">    println(results.mkString(<span class="string">&quot;Array(&quot;</span>, <span class="string">&quot;, &quot;</span>, <span class="string">&quot;)&quot;</span>))</span><br><span class="line">    println(<span class="string">s&quot;Success&quot;</span>)</span><br><span class="line"></span><br><span class="line">    ec.shutdown()</span><br><span class="line">    pool.shutdownNow()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">case</span> <span class="type">Failure</span>(e) =&gt; println(<span class="string">s&quot;Error processing future operations, error = <span class="subst">$&#123;e.getMessage&#125;</span>&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="type">Await</span>.result(futureSequence, <span class="type">Duration</span>.<span class="type">Inf</span>)</span><br></pre></td></tr></table></figure></div>
<p>　　如果计算机 CPU 核数为 8 核，则程序运行成功后将会从 VisualVM 中看到有 8 个线程数在运行，控制台中会每次打印 8 条记录，最后打印出完整数组。</p>
<p>　　onComplete 是 Future 的回调函数，可对 Success 和 Failure 分别处理，Await 是为了阻塞主线程，当 futureSequence 执行完成后，才继续执行下面的任务。当然，主线程的阻塞也可以使用 Java 中的 CountDownLatch 来实现，只需要在每个 Future 执行完成后调用一次 countDown() 即可，或者直接在 onComplete 的回调函数中调用一次也行。（<em>题外话：CountDownLatch 和 Golang 中的 sync.WaitGroup 感觉区别不大</em>）。</p>
<p>　　如果不想让程序并发执行，则将 <code>Future.sequence(futures)</code> 改为 <code>Future.traverse(futures)(x =&gt; x)</code> 即可，此时就会一条条打印，但不保证打印顺序与数组一致。</p>
<p>　　如果使用 <code>ExecutionContext.Implicits.global</code>，并将上面创建 futures 的代码改为：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> futures = <span class="type">Array</span>.range(<span class="number">0</span>, <span class="number">10000</span>).map(i =&gt; <span class="type">Future</span> &#123;</span><br><span class="line">  blocking &#123;</span><br><span class="line">    println(i)</span><br><span class="line">    <span class="type">Thread</span>.sleep(<span class="number">100</span>)</span><br><span class="line">    i</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></div>
<p>　　则控制台会马上将数组全部打印出来，从 VisualVM 中看会有非常多的线程在运行，远远超过 8 个，这是因为 ForkJoinPool 检测到当前线程以全部阻塞，所以需要另开线程继续执行，如果将线程池改为 <code>Executors.newFixedThreadPool(8)</code>，则不会马上将数组全部打印，而是恢复原样，每次打印 8 条。<code>blocking</code> 需要慎用，如果 ForkJoinPool 中线程数太多，同样会 OOM，一般在大量运行时间短内存小的并发任务中使用。</p>
<hr />
<p>　　Parallel Collections 并发编程就很简单了，demo 如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="code"><pre><span class="line"><span class="type">Array</span>.range(<span class="number">0</span>, <span class="number">10000</span>).par.foreach(i =&gt; &#123;</span><br><span class="line">  println(i)</span><br><span class="line">  <span class="type">Thread</span>.sleep(<span class="number">100</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></div>
<p>　　关键字为 <code>par</code>，调用该方法即可轻松进行并发计算，不过需要注意的是并发操作的副作用（side-effects）和“乱序”（out of order）语义，副作用就是去写函数外的变量，不仅仅只读写并发操作函数内部声明的变量，乱序语义是指并发操作不会严格按照数组顺序执行，所以如果并发操作会同时操作两个数组元素（eg：reduce），则需要慎重使用，有的操作结果不变，而有的操作会导致结果不唯一。</p>
<h2 id="经验篇">经验篇</h2>
<p>　　Shaun 目前使用 Scala 进行多线程编程主要碰到过以下几个问题：</p>
<ul>
<li>数据竞争问题</li>
<li>任务拆分问题</li>
<li>内存占用问题</li>
</ul>
<p>　　数据竞争问题算是多线程编程中最常见的问题，简单来说就是两个线程同时写同一个变量，导致变量值不确定，引发后续问题，解决该问题有很多方法，性能由高到底有：Atomic，volatile，线程安全数据结构（eg：ConcurrentHashMap），Lock，synchronized，前两个方法性能最高，但局限性也很大，如果有现成的线程安全对象使用是最好的，没有的只能用 Lock 和 synchronized，这两种各有优缺点，synchronized 用法简单，能应付绝大部分问题，但对读也会加锁并且无法中断等待线程，Lock 是个接口，有比较多的派生对象（ReentrantLock，ReadWriteLock，ReentrantReadWriteLock 等），能更灵活的控制锁，不过使用起来相对复杂，需要显式地加锁解锁。</p>
<p>　　任务拆分问题，这个问题发生在任务量非常多（千万级以上）的时候，当需要对千万级数据进行并发处理时，单纯的生成相应的千万级 Future 在默认的 ExecutionContext 中执行会比较慢，甚至出现程序运行一段时间卡一段时间的现象（可能是内存不足，GC 卡了），此时需要人为对千万级任务进行合并。Shaun 这里有两种方案：一种是使用 grouped 将千万级任务划分为 16 组，从而降级为 16 个任务，生成 16 个Future，这时执行速度会快很多，且不会有卡的现象出现；另一种方案就是，每次只生成 10 万个 Future 放进 ExecutionContext 中执行，如此将千万级任务拆分成每次 10 万并发执行，同样能解决问题。</p>
<p>　　内存占用问题，这个问题发生在单个任务需要占用大量内存（1G 以上）的时候，当单个任务需要 1G 以上内存，8 个任务并行则需要 8G 以上内存，内存占用过高，提高 JVM 的内存，但也只是治标不治本。Shaun 的解决方案是对单个任务进行进一步拆分，将单个任务继续拆分为 16 个子任务，再将 16 个子任务的结果进行合并，作为单个大任务的结果，8 个大任务串行执行，如此内存占用极大减少，只需要单个任务的内存即可完成全部任务，且 CPU 利用率不变，执行速度甚至会更快（Full GC 次数变少）。</p>
<hr />
<p>　　Shaun 在写大文件的时候会用到 newSingleThreadExecutor 和 Future.traverse，将写文件的操作放在 Future 里面，每次只写一个大文件（不用多线程写是因为机械硬盘的顺序读写肯定比随机读写快），而生产大文件内容的操作由默认的 ExecutionContext 执行，从而使生产与消费互不干扰，写大文件操作不会阻塞生产操作。</p>
<p>　　一个用 Future 实现的生产者消费者 demo：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> poolProducer = <span class="type">Executors</span>.newWorkStealingPool()</span><br><span class="line"><span class="keyword">implicit</span> <span class="keyword">val</span> ecProducer = <span class="type">ExecutionContext</span>.fromExecutorService(poolProducer)</span><br><span class="line"><span class="keyword">val</span> poolConsumer = <span class="type">Executors</span>.newSingleThreadExecutor()</span><br><span class="line"><span class="keyword">val</span> ecConsumer = <span class="type">ExecutionContext</span>.fromExecutorService(poolConsumer)</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> futures = <span class="type">Array</span>.range(<span class="number">0</span>, <span class="number">1000</span>).map(i =&gt; <span class="type">Future</span> &#123;</span><br><span class="line">  <span class="keyword">val</span> x = produce(i) <span class="comment">// produce something...</span></span><br><span class="line">  x</span><br><span class="line">&#125;(ecProducer).andThen &#123; <span class="keyword">case</span> <span class="type">Success</span>(x) =&gt;</span><br><span class="line">  consume(x) <span class="comment">// consume something...</span></span><br><span class="line">&#125;(ecConsumer))</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> futureSequence = <span class="type">Future</span>.sequence(futures)</span><br><span class="line">futureSequence.onComplete(&#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="type">Success</span>(results) =&gt; &#123;</span><br><span class="line">    println(<span class="string">&quot;Success.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    ecProducer.shutdown()</span><br><span class="line">    poolProducer.shutdownNow()</span><br><span class="line">    ecConsumer.shutdown()</span><br><span class="line">    poolConsumer.shutdownNow()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">case</span> <span class="type">Failure</span>(e) =&gt; println(<span class="string">s&quot;Error processing future operations, error = <span class="subst">$&#123;e.getMessage&#125;</span>&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="type">Await</span>.result(futureSequence, <span class="type">Duration</span>.<span class="type">Inf</span>)</span><br></pre></td></tr></table></figure></div>
<h2 id="后记">后记</h2>
<p>　　Shaun 这里写的 Scala 多线程编程主要是针对计算密集型任务，而 IO 密集型任务一般会用专门的一些框架，计算密集型考虑的是如何最大化利用 CPU，加快任务执行速度，线程数一般比较固定。Scala 的 Future 多线程编程相比 Java 的多线程编程要简洁了很多，唯一需要控制的就是并行度和任务拆分，Shaun 自己在用时也对 Future 做了简单封装，进一步简化了 Scala 的多线程编程，对 Iterable 的并发计算会更方便。</p>
<h2 id="参考资料">参考资料</h2>
<p>[1] <a href="https://docs.scala-lang.org/overviews/core/futures.html">Futures and Promises</a></p>
<p>[2] <a href="https://stackoverflow.com/questions/29068064/scala-concurrent-blocking-what-does-it-actually-do">scala.concurrent.blocking - what does it actually do?</a></p>
<p>[3] <a href="https://docs.scala-lang.org/overviews/parallel-collections/overview.html">Parallel Collections</a></p>
<p>[4] <a href="https://www.cnblogs.com/dolphin0520/p/3923167.html">Java并发编程：Lock</a></p>
]]></content>
      <categories>
        <category>Study</category>
      </categories>
      <tags>
        <tag>language</tag>
      </tags>
  </entry>
  <entry>
    <title>OpenCV中显著性检测算法的使用</title>
    <url>/posts/fd0f8195.html</url>
    <content><![CDATA[<p><font color=#FA8072>本文所用的 OpenCV 版本为 opencv-3.2.0，编程语言为 C++。</font></p>
<h2 id="前言">前言</h2>
<p>　　OpenCV 中实现了两种显著性检测算法，分别为 Spectral Residual 算法,出自 <strong>Xiaodi Hou and Liqing Zhang. Saliency detection: A spectral residual approach. In <em>Computer Vision and Pattern Recognition, 2007. CVPR'07. IEEE Conference on</em>, pages 1–8. IEEE, 2007.</strong> 和 Fine Grained Saliency 算法,出自 <strong>Sebastian Montabone and Alvaro Soto. Human detection using a mobile platform and novel features derived from a visual saliency mechanism. In <em>Image and Vision Computing, Vol. 28 Issue 3</em>, pages 391–402. Elsevier, 2010.</strong>。这两种算法同样是在扩展包 opencv_contrib-3.2.0 中，也是由于 opencv <a href="https://github.com/opencv/opencv_contrib/blob/master/modules/saliency/samples/computeSaliency.cpp">官方示例程序</a>对初学者不友好（主要是 Shaun 境界不够 o(╯□╰)o），所以 Shaun 对照其<a href="http://docs.opencv.org/3.2.0/d8/d65/group__saliency.html">官方文档</a>重新整理了一下。</p>
<span id="more"></span>
<h2 id="说明篇">说明篇</h2>
<p>　　<strong>使用 OpenCV 中实现的显著性检测算法进行显著性检测十分方便简洁，利用以下三个函数就可以：</strong></p>
<p>创建 Spectral Residual 算法显著性检测对象：<code>static Ptr&lt;StaticSaliencySpectralResidual&gt; cv::saliency::StaticSaliencySpectralResidual::create();</code></p>
<p>Spectral Residual 算法计算显著性图：<code>bool cv::saliency::StaticSaliencySpectralResidual::computeSaliency(InputArray image, OutputArray saliencyMap);</code></p>
<p>Fine Grained Saliency 算法显著性检测对应的函数声明同 Spectral Residual 算法类似。</p>
<p>计算显著性图的二值图：<code>bool cv::saliency::StaticSaliency::computeBinaryMap(InputArray _saliencyMap, OutputArray _binaryMap) ;</code></p>
<p>具体使用方法可参考实例篇。</p>
<h2 id="实例篇">实例篇</h2>
<p>　　使用 OpenCV 中的显著性检测算法需要包含头文件<code>#include &lt;opencv2/saliency.hpp&gt;</code>，具体示例程序如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/opencv.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/saliency.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//******************************************************</span></span><br><span class="line"><span class="comment">// [opencv_contrib/modules/saliency/src/saliency.cpp](https://github.com/opencv/opencv_contrib/blob/b7dcf141507edbe544e75820c76769a7769223ac/modules/saliency/src/saliency.cpp)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//Ptr&lt;Saliency&gt; Saliency::create(const String&amp; saliencyType)</span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line"><span class="comment">//	if (saliencyType == &quot;SPECTRAL_RESIDUAL&quot;)</span></span><br><span class="line"><span class="comment">//		return makePtr&lt;StaticSaliencySpectralResidual&gt;();  //computeSaliency返回的是32FC1</span></span><br><span class="line"><span class="comment">//	else if (saliencyType == &quot;FINE_GRAINED&quot;)</span></span><br><span class="line"><span class="comment">//		return makePtr&lt;StaticSaliencyFineGrained&gt;();	 //computeSaliency返回的是8UC1</span></span><br><span class="line"><span class="comment">//	else if (saliencyType == &quot;BING&quot;)</span></span><br><span class="line"><span class="comment">//		return makePtr&lt;ObjectnessBING&gt;();</span></span><br><span class="line"><span class="comment">//	else if (saliencyType == &quot;BinWangApr2014&quot;)</span></span><br><span class="line"><span class="comment">//		return makePtr&lt;MotionSaliencyBinWangApr2014&gt;();</span></span><br><span class="line"><span class="comment">//	return Ptr&lt;Saliency&gt;();</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// [opencv_contrib/modules/saliency/src/staticSaliency.cpp](https://github.com/opencv/opencv_contrib/blob/41b0a71ac826b1489d3e5c208ac7a95e58556caf/modules/saliency/src/staticSaliency.cpp)</span></span><br><span class="line"><span class="comment">//computeBinaryMap()要求输入的saliencyMap为浮点数（eg:32FC1）</span></span><br><span class="line"><span class="comment">//*****************************************************</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">spectralResidualTest</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	cv::Mat src_img = cv::<span class="built_in">imread</span>(<span class="string">&quot;../data/true.png&quot;</span>, CV_LOAD_IMAGE_ANYDEPTH | CV_LOAD_IMAGE_ANYCOLOR);	<span class="comment">// 载入最真实的原始图像</span></span><br><span class="line">	cv::<span class="built_in">namedWindow</span>(<span class="string">&quot;src_img&quot;</span>, CV_WND_PROP_ASPECTRATIO);</span><br><span class="line">	cv::<span class="built_in">imshow</span>(<span class="string">&quot;src_img&quot;</span>, src_img);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">// [OpenCV实现显著性检测中的谱残差法（Spectral Residual Method）涉及到了傅立叶正反变换](http://blog.csdn.net/kena_m/article/details/49406687)</span></span><br><span class="line">	<span class="keyword">if</span> (src_img.<span class="built_in">empty</span>())</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">	<span class="keyword">if</span> (src_img.<span class="built_in">channels</span>() == <span class="number">3</span>)</span><br><span class="line">		cv::<span class="built_in">cvtColor</span>(src_img, src_img, CV_BGR2GRAY);</span><br><span class="line">	cv::Mat planes[] = &#123; cv::Mat_&lt;<span class="keyword">float</span>&gt;(src_img), cv::Mat::<span class="built_in">zeros</span>(src_img.<span class="built_in">size</span>(), CV_32F) &#125;;</span><br><span class="line">	cv::Mat complex_img; <span class="comment">//复数矩阵</span></span><br><span class="line">	<span class="built_in">merge</span>(planes, <span class="number">2</span>, complex_img); <span class="comment">//把单通道矩阵组合成复数形式的双通道矩阵</span></span><br><span class="line">	<span class="built_in">dft</span>(complex_img, complex_img);  <span class="comment">// 使用离散傅立叶变换</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//对复数矩阵进行处理，方法为谱残差</span></span><br><span class="line">	cv::Mat magnitude, phase_angle, mag_mean;</span><br><span class="line">	cv::Mat real_part, imaginary_part;</span><br><span class="line">	<span class="built_in">split</span>(complex_img, planes); <span class="comment">//分离复数到实部和虚部</span></span><br><span class="line">	real_part = planes[<span class="number">0</span>]; <span class="comment">//实部</span></span><br><span class="line">	imaginary_part = planes[<span class="number">1</span>]; <span class="comment">//虚部</span></span><br><span class="line">	cv::<span class="built_in">magnitude</span>(real_part, imaginary_part, magnitude); <span class="comment">//计算幅值</span></span><br><span class="line">	<span class="built_in">phase</span>(real_part, imaginary_part, phase_angle); <span class="comment">//计算相角</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">float</span> *pre, *pim, *pm, *pp;</span><br><span class="line">	<span class="comment">//对幅值进行对数化</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; magnitude.rows; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		pm = magnitude.ptr&lt;<span class="keyword">float</span>&gt;(i);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; magnitude.cols; j++)</span><br><span class="line">		&#123;</span><br><span class="line">			*pm = <span class="built_in">log</span>(*pm);</span><br><span class="line">			pm++;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">blur</span>(magnitude, mag_mean, cv::<span class="built_in">Size</span>(<span class="number">5</span>, <span class="number">5</span>)); <span class="comment">//对数谱的均值滤波</span></span><br><span class="line">	magnitude = magnitude - mag_mean; <span class="comment">//求取对数频谱残差</span></span><br><span class="line">	<span class="comment">//把对数谱残差的幅值和相角划归到复数形式</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; magnitude.rows; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		pre = real_part.ptr&lt;<span class="keyword">float</span>&gt;(i);</span><br><span class="line">		pim = imaginary_part.ptr&lt;<span class="keyword">float</span>&gt;(i);</span><br><span class="line">		pm = magnitude.ptr&lt;<span class="keyword">float</span>&gt;(i);</span><br><span class="line">		pp = phase_angle.ptr&lt;<span class="keyword">float</span>&gt;(i);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; magnitude.cols; j++)</span><br><span class="line">		&#123;</span><br><span class="line">			*pm = <span class="built_in">exp</span>(*pm);</span><br><span class="line">			*pre = *pm * <span class="built_in">cos</span>(*pp);</span><br><span class="line">			*pim = *pm * <span class="built_in">sin</span>(*pp);</span><br><span class="line">			pre++;</span><br><span class="line">			pim++;</span><br><span class="line">			pm++;</span><br><span class="line">			pp++;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	cv::Mat planes1[] = &#123; cv::Mat_&lt;<span class="keyword">float</span>&gt;(real_part), cv::Mat_&lt;<span class="keyword">float</span>&gt;(imaginary_part) &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">merge</span>(planes1, <span class="number">2</span>, complex_img); <span class="comment">//重新整合实部和虚部组成双通道形式的复数矩阵</span></span><br><span class="line">	<span class="built_in">idft</span>(complex_img, complex_img, cv::DFT_SCALE); <span class="comment">// 傅立叶反变换</span></span><br><span class="line">	<span class="built_in">split</span>(complex_img, planes); <span class="comment">//分离复数到实部和虚部</span></span><br><span class="line">	real_part = planes[<span class="number">0</span>];</span><br><span class="line">	imaginary_part = planes[<span class="number">1</span>];</span><br><span class="line">	cv::<span class="built_in">magnitude</span>(real_part, imaginary_part, magnitude); <span class="comment">//计算幅值和相角</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; magnitude.rows; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		pm = magnitude.ptr&lt;<span class="keyword">float</span>&gt;(i);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; magnitude.cols; j++)</span><br><span class="line">		&#123;</span><br><span class="line">			*pm = (*pm) * (*pm);</span><br><span class="line">			pm++;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">GaussianBlur</span>(magnitude, magnitude, cv::<span class="built_in">Size</span>(<span class="number">7</span>, <span class="number">7</span>), <span class="number">2.5</span>, <span class="number">2.5</span>);</span><br><span class="line">	cv::Mat invDFT, invDFTcvt;</span><br><span class="line">	<span class="built_in">normalize</span>(magnitude, invDFT, <span class="number">0</span>, <span class="number">255</span>, cv::NORM_MINMAX); <span class="comment">//归一化到[0,255]供显示</span></span><br><span class="line">	invDFT.<span class="built_in">convertTo</span>(invDFTcvt, CV_8U); <span class="comment">//转化成CV_8U型</span></span><br><span class="line">	cv::<span class="built_in">namedWindow</span>(<span class="string">&quot;SpectualResidual&quot;</span>, CV_WND_PROP_ASPECTRATIO);</span><br><span class="line">	cv::<span class="built_in">imshow</span>(<span class="string">&quot;SpectualResidual&quot;</span>, invDFTcvt);</span><br><span class="line"></span><br><span class="line">	cv::Mat thresholded;</span><br><span class="line">	cv::<span class="built_in">threshold</span>(invDFTcvt, thresholded, <span class="number">0</span>, <span class="number">255</span>, CV_THRESH_OTSU);</span><br><span class="line">	cv::<span class="built_in">namedWindow</span>(<span class="string">&quot;Thresholded Image&quot;</span>, CV_WND_PROP_ASPECTRATIO);</span><br><span class="line">	cv::<span class="built_in">imshow</span>(<span class="string">&quot;Thresholded Image&quot;</span>, thresholded);</span><br><span class="line"></span><br><span class="line">	cv::Mat eroded;</span><br><span class="line">	<span class="comment">// 纵向腐蚀</span></span><br><span class="line">	cv::<span class="built_in">erode</span>(thresholded, eroded, cv::<span class="built_in">Mat</span>(<span class="number">5</span>, <span class="number">1</span>, CV_8UC1, cv::<span class="built_in">Scalar</span>(<span class="number">1</span>)), cv::<span class="built_in">Point</span>(<span class="number">-1</span>, <span class="number">-1</span>), <span class="number">3</span>);	<span class="comment">// cv::Point(-1,-1)为默认参数，代表原点（描点）为矩阵中心</span></span><br><span class="line">	cv::<span class="built_in">namedWindow</span>(<span class="string">&quot;eroded Image&quot;</span>, CV_WND_PROP_ASPECTRATIO);</span><br><span class="line">	cv::<span class="built_in">imshow</span>(<span class="string">&quot;eroded Image&quot;</span>, eroded);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//cv::Mat thresholded;</span></span><br><span class="line">	cv::<span class="built_in">threshold</span>(eroded, thresholded, <span class="number">60</span>, <span class="number">255</span>, CV_THRESH_BINARY);</span><br><span class="line">	cv::<span class="built_in">namedWindow</span>(<span class="string">&quot;Thresholded eroded Image&quot;</span>, CV_WND_PROP_ASPECTRATIO);</span><br><span class="line">	cv::<span class="built_in">imshow</span>(<span class="string">&quot;Thresholded eroded Image&quot;</span>, thresholded);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 显著性检测算法基类</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saliencyTest</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	cv::Mat src_img = cv::<span class="built_in">imread</span>(<span class="string">&quot;../data/true.png&quot;</span>, CV_LOAD_IMAGE_ANYDEPTH | CV_LOAD_IMAGE_ANYCOLOR);</span><br><span class="line">	cv::<span class="built_in">namedWindow</span>(<span class="string">&quot;src_img&quot;</span>, CV_WND_PROP_ASPECTRATIO);</span><br><span class="line">	cv::<span class="built_in">imshow</span>(<span class="string">&quot;src_img&quot;</span>, src_img);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (src_img.<span class="built_in">empty</span>())</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">	<span class="keyword">if</span> (src_img.<span class="built_in">channels</span>() == <span class="number">3</span>)</span><br><span class="line">		cv::<span class="built_in">cvtColor</span>(src_img, src_img, CV_BGR2GRAY);</span><br><span class="line"></span><br><span class="line">	cv::Ptr&lt;cv::saliency::Saliency&gt; saliency_algorithm = cv::saliency::Saliency::<span class="built_in">create</span>(<span class="string">&quot;SPECTRAL_RESIDUAL&quot;</span>);	<span class="comment">// FINE_GRAINED为Fine Grained Saliency算法</span></span><br><span class="line">	cv::Mat saliency_map;</span><br><span class="line">	<span class="keyword">if</span> (saliency_algorithm-&gt;<span class="built_in">computeSaliency</span>(src_img, saliency_map))	<span class="comment">// 计算显著性图</span></span><br><span class="line">	&#123;</span><br><span class="line">		cv::<span class="built_in">namedWindow</span>(<span class="string">&quot;SR saliency map&quot;</span>, CV_WND_PROP_ASPECTRATIO);</span><br><span class="line">		cv::<span class="built_in">imshow</span>(<span class="string">&quot;SR saliency map&quot;</span>, saliency_map);</span><br><span class="line"></span><br><span class="line">		<span class="function">cv::Mat <span class="title">saliency_map_show</span><span class="params">(saliency_map.size(), CV_8UC1)</span></span>;</span><br><span class="line">		<span class="built_in">normalize</span>(saliency_map, saliency_map_show, <span class="number">0</span>, <span class="number">255</span>, CV_MINMAX); <span class="comment">//归一化到[0,255]供显示</span></span><br><span class="line">		saliency_map_show.<span class="built_in">convertTo</span>(saliency_map_show, CV_8U); <span class="comment">//转化成CV_8U型</span></span><br><span class="line">		cv::<span class="built_in">namedWindow</span>(<span class="string">&quot;saliency_map_show&quot;</span>, CV_WND_PROP_ASPECTRATIO);</span><br><span class="line">		cv::<span class="built_in">imshow</span>(<span class="string">&quot;saliency_map_show&quot;</span>, saliency_map_show);</span><br><span class="line"></span><br><span class="line">		cv::Mat binary_map;</span><br><span class="line">		cv::saliency::StaticSaliencySpectralResidual spec;</span><br><span class="line">		<span class="keyword">if</span> (spec.<span class="built_in">computeBinaryMap</span>(saliency_map, binary_map))	<span class="comment">// 对显著性图进行二值化</span></span><br><span class="line">		&#123;</span><br><span class="line">			cv::<span class="built_in">namedWindow</span>(<span class="string">&quot;binary map&quot;</span>, CV_WND_PROP_ASPECTRATIO);</span><br><span class="line">			cv::<span class="built_in">imshow</span>(<span class="string">&quot;binary map&quot;</span>, binary_map);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Fine Grained Saliency算法</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FGSTest</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	cv::Mat src_img = cv::<span class="built_in">imread</span>(<span class="string">&quot;../data/true.png&quot;</span>, CV_LOAD_IMAGE_ANYDEPTH | CV_LOAD_IMAGE_ANYCOLOR);</span><br><span class="line">	cv::<span class="built_in">namedWindow</span>(<span class="string">&quot;src_img&quot;</span>, CV_WND_PROP_ASPECTRATIO);</span><br><span class="line">	cv::<span class="built_in">imshow</span>(<span class="string">&quot;src_img&quot;</span>, src_img);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (src_img.<span class="built_in">empty</span>())</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">	<span class="keyword">if</span> (src_img.<span class="built_in">channels</span>() == <span class="number">3</span>)</span><br><span class="line">		cv::<span class="built_in">cvtColor</span>(src_img, src_img, CV_BGR2GRAY);</span><br><span class="line"></span><br><span class="line">	cv::Ptr&lt;cv::saliency::StaticSaliencyFineGrained&gt; fgs = cv::saliency::StaticSaliencyFineGrained::<span class="built_in">create</span>();</span><br><span class="line">	cv::Mat fgs_saliency_map;</span><br><span class="line">	fgs-&gt;<span class="built_in">computeSaliency</span>(src_img, fgs_saliency_map);</span><br><span class="line">	cv::<span class="built_in">namedWindow</span>(<span class="string">&quot;FGS saliency map&quot;</span>, CV_WND_PROP_ASPECTRATIO);</span><br><span class="line">	cv::<span class="built_in">imshow</span>(<span class="string">&quot;FGS saliency map&quot;</span>, fgs_saliency_map);</span><br><span class="line">	<span class="comment">//cv::imwrite(&quot;../data/T_S.png&quot;, fgs_saliency_map);</span></span><br><span class="line"></span><br><span class="line">	cv::Mat binary_map;</span><br><span class="line">	cv::<span class="built_in">threshold</span>(fgs_saliency_map, binary_map, <span class="number">0</span>, <span class="number">255</span>, CV_THRESH_OTSU);</span><br><span class="line">	cv::<span class="built_in">namedWindow</span>(<span class="string">&quot;binary map&quot;</span>, CV_WND_PROP_ASPECTRATIO);</span><br><span class="line">	cv::<span class="built_in">imshow</span>(<span class="string">&quot;binary map&quot;</span>, binary_map);</span><br><span class="line">	<span class="comment">//cv::imwrite(&quot;../data/T_S_B.png&quot;, binary_map);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Spectral Residual算法</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SRTest</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	cv::Mat src_img = cv::<span class="built_in">imread</span>(<span class="string">&quot;../data/true.png&quot;</span>, CV_LOAD_IMAGE_ANYDEPTH | CV_LOAD_IMAGE_ANYCOLOR);</span><br><span class="line">	cv::<span class="built_in">namedWindow</span>(<span class="string">&quot;src_img&quot;</span>, CV_WND_PROP_ASPECTRATIO);</span><br><span class="line">	cv::<span class="built_in">imshow</span>(<span class="string">&quot;src_img&quot;</span>, src_img);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (src_img.<span class="built_in">empty</span>())</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">	<span class="keyword">if</span> (src_img.<span class="built_in">channels</span>() == <span class="number">3</span>)</span><br><span class="line">		cv::<span class="built_in">cvtColor</span>(src_img, src_img, CV_BGR2GRAY);</span><br><span class="line"></span><br><span class="line">	cv::Ptr&lt;cv::saliency::StaticSaliencySpectralResidual&gt; sr = cv::saliency::StaticSaliencySpectralResidual::<span class="built_in">create</span>();</span><br><span class="line">	cv::Mat sr_saliency_map;</span><br><span class="line">	sr-&gt;<span class="built_in">computeSaliency</span>(src_img, sr_saliency_map);</span><br><span class="line">	cv::<span class="built_in">namedWindow</span>(<span class="string">&quot;SR saliency map&quot;</span>, CV_WND_PROP_ASPECTRATIO);</span><br><span class="line">	cv::<span class="built_in">imshow</span>(<span class="string">&quot;SR saliency map&quot;</span>, sr_saliency_map);</span><br><span class="line"></span><br><span class="line">	cv::Mat binary_map;</span><br><span class="line">	sr-&gt;<span class="built_in">computeBinaryMap</span>(sr_saliency_map, binary_map);</span><br><span class="line">	cv::<span class="built_in">namedWindow</span>(<span class="string">&quot;binary map&quot;</span>, CV_WND_PROP_ASPECTRATIO);</span><br><span class="line">	cv::<span class="built_in">imshow</span>(<span class="string">&quot;binary map&quot;</span>, binary_map);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//spectralResidualTest();</span></span><br><span class="line">	<span class="comment">//saliencyTest();</span></span><br><span class="line">	<span class="comment">//FGSTest();</span></span><br><span class="line">	<span class="built_in">SRTest</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (cv::<span class="built_in">waitKey</span>(<span class="number">0</span>) != <span class="number">27</span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p><em>以上代码在 Win10 VS2013 中编译运行成功。</em></p>
<p>　　这里面有个小东西需要注意，就是 <code>computeBinaryMap()</code> 函数，看其文档描述其中使用 <em>K-means</em> 算法和 <em>Otsu</em> 算法对显著性图进行二值化处理，其输入的显著性图数据类型应该为浮点数，OpenCV 中 Spectral Residual 算法 computeSaliency() 返回的结果为浮点数，而 Fine Grained Saliency 算法 computeSaliency() 返回的结果却是整型数据，所以这一点需要注意 Fine Grained Saliency 算法返回的结果不能直接使用 computeBinaryMap() 函数，一般对其结果直接使用 OTSU 算法进行阈值分割即可。</p>
<h2 id="后记">后记</h2>
<p>　　本文使用的这两种算法在 Shaun 的电脑上运行时间都较长，基本不可能用来处理视频流，而且在 Shaun 的这次实验中效果也不太理想，毕竟这是用来处理静态图像的两种显著性方法。不过 OpenCV 中也有用来处理视频流的显著性检测算法，其为 BING 算法,出自<strong>Ming-Ming Cheng, Ziming Zhang, Wen-Yan Lin, and Philip Torr. Bing: Binarized normed gradients for objectness estimation at 300fps. In <em>IEEE CVPR</em>, 2014.</strong>，实际上这是一种快速提取目标候选框的算法。</p>
]]></content>
      <categories>
        <category>Image&amp;Graphic</category>
      </categories>
      <tags>
        <tag>opencv</tag>
        <tag>cv</tag>
      </tags>
  </entry>
  <entry>
    <title>TXT数据转OpenCV中的Mat数据</title>
    <url>/posts/dece8eba.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　本文是以前做的一个小东西的处理前奏，当时也记录过，现在把它翻出来重新看看。那个东西需要利用深度图，Shaun 当时还没拿到 Kinect，就在网上下了一些<a href="https://drive.google.com/uc?export=download&amp;confirm=QRhv&amp;id=0B_9saHAqGFITODNmNzU0ZjctMjk0Yi00YjI5LWJmZDMtYTdiYTE2YzM5OTQ4">数据</a>（<a href="http://eeeweba.ntu.edu.sg/computervision/people/home/renzhou/HandGesture.htm" class="uri">http://eeeweba.ntu.edu.sg/computervision/people/home/renzhou/HandGesture.htm</a>），该数据集包含了彩色图及对应的深度图，但是该数据集没有以图像形式存储深度值，而是用 txt 文本以行列形式存储真正的深度值（单位为 mm），所以并不能直观的看到深度图像，Shaun 需要把这些深度值从 txt 文本提取出来并把它以图像的形式呈现出来，由于需求比较特殊，网上没看到现成的解决的方案，所以 Shaun 只有用现成的轮子自己做一个了。</p>
<span id="more"></span>
<h2 id="思路篇">思路篇</h2>
<p>　　程序的基本思路是：先找到目录及子目录下的所有 txt 文件路径；再根据路径分别读取 txt 文件，按行读取之后再进行字符串分割提取其中的深度值；为了便于以图像形式显示，将深度值归一化至 0~255 存入 8 位单通道的 Mat 类型数据中，最后以 png 图像形式保存至各个目录。</p>
<h2 id="实现篇">实现篇</h2>
<p>　　因为当时还在用 opencv-2.4.11，所以本文所实现的代码是基于 opencv-2.4.11，不过应该只要在 opencv-2.0 版本及以上只要有 Mat 数据结构的都能用，毕竟 Shaun 只用到了 OpenCV 中的 Mat 数据结构。Talk is cheap, show you the code（代码很乱，估计也只用这么一次，所以就没怎么注意了 :-P）。具体 C++ 实现代码为：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/core/core.hpp&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/imgproc/imgproc.hpp&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/highgui/highgui.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;io.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;direct.h&gt;</span>  </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> cv;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ******************************************************************</span></span><br><span class="line"><span class="comment">// @refer to  [C++文件读写操作（二）逐字符读取文本和逐行读取文本](http://blog.csdn.net/wangshihui512/article/details/8921924)</span></span><br><span class="line"><span class="comment">//            [字符串分割(C++)](http://www.cnblogs.com/MikeZhang/archive/2012/03/24/MySplitFunCPP.html)</span></span><br><span class="line"><span class="comment">//            [C++读取文件夹中所有的文件或者是特定后缀的文件](http://blog.csdn.net/adong76/article/details/39432467)</span></span><br><span class="line"><span class="comment">//            [C/C++ 判断文件夹是否存在以及创建、删除文件夹 windows以及linux通用](http://blog.csdn.net/u012005313/article/details/50688257)</span></span><br><span class="line"><span class="comment">//            [Split a string in C++?](http://stackoverflow.com/questions/236129/split-a-string-in-c)</span></span><br><span class="line"><span class="comment">//            [Kinect开发学习笔记之（六）带游戏者ID的深度数据的提取](http://blog.csdn.net/zouxy09/article/details/8151044)</span></span><br><span class="line"><span class="comment">//            [Depth Map Tutorial](http://www.pages.drexel.edu/~nk752/depthMapTut.html)</span></span><br><span class="line"><span class="comment">// ******************************************************************</span></span><br><span class="line"><span class="comment">// ----- 逐个字符读取文件 --------</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testByChar</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    fstream testByCharFile;  </span><br><span class="line">    <span class="keyword">char</span> c;  </span><br><span class="line">    testByCharFile.<span class="built_in">open</span>(<span class="string">&quot;./test.txt&quot;</span>,ios::in);  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(!testByCharFile.<span class="built_in">eof</span>())  </span><br><span class="line">    &#123;  </span><br><span class="line">        testByCharFile&gt;&gt;c;  </span><br><span class="line">        cout&lt;&lt;c;  </span><br><span class="line">    &#125;  </span><br><span class="line">    testByCharFile.<span class="built_in">close</span>();  </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">// -------- 逐行读取文件 -------------------</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testByLine</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">256</span>];  </span><br><span class="line">    fstream outFile;  </span><br><span class="line">    outFile.<span class="built_in">open</span>(<span class="string">&quot;./test.txt&quot;</span>,ios::in);  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(!outFile.<span class="built_in">eof</span>())  </span><br><span class="line">    &#123;  </span><br><span class="line">        outFile.<span class="built_in">getline</span>(buffer, <span class="number">256</span>, <span class="string">&#x27;\n&#x27;</span>);<span class="comment">//getline(char *,int,char) 表示该行字符达到256个或遇到换行就结束  </span></span><br><span class="line">        cout&lt;&lt;buffer&lt;&lt;endl; </span><br><span class="line">    &#125;  </span><br><span class="line">    outFile.<span class="built_in">close</span>();  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment">//  ------- 分割字符串 --------------</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">splitString</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">1280</span>];  </span><br><span class="line">    fstream outFile;  </span><br><span class="line">    outFile.<span class="built_in">open</span>(<span class="string">&quot;./test.txt&quot;</span>,ios::in);  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(!outFile.<span class="built_in">eof</span>())  </span><br><span class="line">    &#123;  </span><br><span class="line">        outFile.<span class="built_in">getline</span>(buffer, <span class="number">1280</span>, <span class="string">&#x27;\n&#x27;</span>);<span class="comment">//getline(char *,int,char) 表示该行字符达到1280个或遇到换行就结束  </span></span><br><span class="line">        cout&lt;&lt;buffer&lt;&lt;endl; </span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *d = <span class="string">&quot; ,*&quot;</span>;</span><br><span class="line">        <span class="keyword">char</span> *p;</span><br><span class="line">        p = <span class="built_in">strtok</span>(buffer, d);</span><br><span class="line">        <span class="keyword">while</span>(p)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, p);</span><br><span class="line">            p=<span class="built_in">strtok</span>(<span class="literal">NULL</span>, d);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line">    outFile.<span class="built_in">close</span>();  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取文件夹下指定格式所有文件名</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getAllFormatFiles</span><span class="params">( string path, string format, vector&lt;string&gt;&amp; files )</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="comment">//文件句柄    </span></span><br><span class="line">    <span class="keyword">long</span>   hFile   =   <span class="number">0</span>;    </span><br><span class="line">    <span class="comment">//文件信息    </span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">finddata_t</span> <span class="title">fileinfo</span>;</span>    </span><br><span class="line">    string pathName;    </span><br><span class="line">    <span class="keyword">if</span>((hFile = _findfirst(pathName.<span class="built_in">assign</span>(path).<span class="built_in">append</span>(<span class="string">&quot;/*.&quot;</span> + format).<span class="built_in">c_str</span>(),&amp;fileinfo)) !=  <span class="number">-1</span>)    </span><br><span class="line">    &#123;    </span><br><span class="line">        <span class="keyword">do</span>    </span><br><span class="line">        &#123;   </span><br><span class="line">            <span class="comment">//如果是目录,迭代之  </span></span><br><span class="line">            <span class="comment">//如果不是,加入列表  </span></span><br><span class="line">            <span class="keyword">if</span>((fileinfo.attrib &amp;  _A_SUBDIR))    </span><br><span class="line">            &#123;    </span><br><span class="line">                <span class="keyword">if</span>(<span class="built_in">strcmp</span>(fileinfo.name,<span class="string">&quot;.&quot;</span>) != <span class="number">0</span>  &amp;&amp;  <span class="built_in">strcmp</span>(fileinfo.name,<span class="string">&quot;..&quot;</span>) != <span class="number">0</span>)    </span><br><span class="line">                &#123;  </span><br><span class="line">                    <span class="comment">//files.push_back(p.assign(path).append(&quot;/&quot;).append(fileinfo.name) );  </span></span><br><span class="line">                    <span class="built_in">getAllFormatFiles</span>( pathName.<span class="built_in">assign</span>(path).<span class="built_in">append</span>(<span class="string">&quot;/&quot;</span>).<span class="built_in">append</span>(fileinfo.name), format, files);   </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;    </span><br><span class="line">            <span class="keyword">else</span>    </span><br><span class="line">            &#123;    </span><br><span class="line">                files.<span class="built_in">push_back</span>(pathName.<span class="built_in">assign</span>(path).<span class="built_in">append</span>(<span class="string">&quot;/&quot;</span>).<span class="built_in">append</span>(fileinfo.name) );    </span><br><span class="line">            &#125;    </span><br><span class="line">        &#125;<span class="keyword">while</span>(_findnext(hFile, &amp;fileinfo) == <span class="number">0</span>);    </span><br><span class="line"></span><br><span class="line">        _findclose(hFile);   </span><br><span class="line">    &#125;   </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment">// http://stackoverflow.com/questions/236129/split-a-string-in-c</span></span><br><span class="line"><span class="comment">// ---- stackoverflow上大神的C++版本分割字符串 --------------------</span></span><br><span class="line"><span class="function">std::vector&lt;std::string&gt; <span class="title">split</span><span class="params">(<span class="keyword">const</span> std::string&amp; text, <span class="keyword">const</span> std::string&amp; delims)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::vector&lt;std::string&gt; tokens;</span><br><span class="line">    std::<span class="keyword">size_t</span> start = text.<span class="built_in">find_first_not_of</span>(delims), end = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>((end = text.<span class="built_in">find_first_of</span>(delims, start)) != std::string::npos)</span><br><span class="line">    &#123;</span><br><span class="line">        tokens.<span class="built_in">push_back</span>(text.<span class="built_in">substr</span>(start, end - start));</span><br><span class="line">        start = text.<span class="built_in">find_first_not_of</span>(delims, end);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(start != std::string::npos)</span><br><span class="line">        tokens.<span class="built_in">push_back</span>(text.<span class="built_in">substr</span>(start));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tokens;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建文件夹及子文件夹</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">makeDir</span><span class="params">(<span class="keyword">const</span> string &amp;path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::vector&lt;std::string&gt; tokens;</span><br><span class="line">    std::<span class="keyword">size_t</span> start = <span class="number">0</span>, end = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ((end = path.<span class="built_in">find</span>(<span class="string">&#x27;/&#x27;</span>, start)) != std::string::npos) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (end != start) </span><br><span class="line">        &#123;</span><br><span class="line">            tokens.<span class="built_in">push_back</span>(path.<span class="built_in">substr</span>(<span class="number">0</span>, end));</span><br><span class="line">        &#125;</span><br><span class="line">        start = end + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (end != start) </span><br><span class="line">    &#123;</span><br><span class="line">        tokens.<span class="built_in">push_back</span>(path);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    vector&lt;string&gt;::const_iterator itp = tokens.<span class="built_in">begin</span>();</span><br><span class="line">    <span class="keyword">while</span> (itp != tokens.<span class="built_in">end</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">access</span>(itp-&gt;<span class="built_in">c_str</span>(), <span class="number">0</span>) == <span class="number">-1</span>)  <span class="comment">// 判断文件夹是否存在  </span></span><br><span class="line">        &#123;  </span><br><span class="line">            cout&lt;&lt;*itp&lt;&lt;<span class="string">&quot; is not existing&quot;</span>&lt;&lt;endl;  </span><br><span class="line">            cout&lt;&lt;<span class="string">&quot;now make it&quot;</span>&lt;&lt;endl;  </span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">mkdir</span>(itp-&gt;<span class="built_in">c_str</span>()) == <span class="number">0</span>)   <span class="comment">// 不存在则创建，只能一级一级的创建</span></span><br><span class="line">            &#123;</span><br><span class="line">                cout&lt;&lt;<span class="string">&quot;make successfully&quot;</span>&lt;&lt;endl; </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        cout &lt;&lt; *itp++ &lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Txt文件转opencv Mat（txt文件中存的是以行列形式的深度值）</span></span><br><span class="line"><span class="function">cv::Mat <span class="title">Txt2DepthMat</span><span class="params">(<span class="keyword">const</span> string &amp;txtname)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">cv::Mat <span class="title">result</span><span class="params">(<span class="number">480</span>, <span class="number">640</span>, CV_8UC1, cv::Scalar(<span class="number">0</span>))</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">12800</span>];     <span class="comment">// 按行读取文件</span></span><br><span class="line">    fstream outFile;  </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *d = <span class="string">&quot;,&quot;</span>;    <span class="comment">// 以,为分割点</span></span><br><span class="line">    <span class="keyword">char</span> *p;    <span class="comment">// 分割出的子串</span></span><br><span class="line">    outFile.<span class="built_in">open</span>(txtname, ios::in);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; outFile.<span class="built_in">getline</span>(buffer, <span class="number">12800</span>, <span class="string">&#x27;\n&#x27;</span>) != <span class="literal">NULL</span> &amp;&amp; i &lt; result.rows; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        p = <span class="built_in">strtok</span>(buffer, d);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; p &amp;&amp; j &lt; result.cols; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> realDepth = (<span class="built_in">atoi</span>(p) &amp; <span class="number">0xfff8</span>) &gt;&gt; <span class="number">3</span>; <span class="comment">//提取距离信息，高13位</span></span><br><span class="line">            <span class="keyword">int</span> depth = (<span class="keyword">int</span>)(<span class="number">256</span> * realDepth / <span class="number">0x0fff</span>); <span class="comment">//因为提取的信息是距离信息，为了便于显示，这里归一化为0-255  </span></span><br><span class="line">            result.at&lt;uchar&gt;(i, j) = cv::saturate_cast&lt;uchar&gt;(depth);</span><br><span class="line">            p = <span class="built_in">strtok</span>(<span class="literal">NULL</span>, d);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    outFile.<span class="built_in">close</span>();  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 以颜色表示深度信息，越暖（红色）越近，越冷（蓝色）越远</span></span><br><span class="line"><span class="function">cv::Mat <span class="title">Depth2Color</span><span class="params">(<span class="keyword">const</span> cv::Mat &amp;depth)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">cv::Mat <span class="title">result</span><span class="params">(depth.size(), CV_8UC3, cv::Scalar::all(<span class="number">0</span>))</span></span>;</span><br><span class="line">    <span class="keyword">int</span> tempDepth, depthRed, depthGreen, depthBlue;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; result.rows; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; result.cols; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            tempDepth = <span class="number">255</span> - depth.at&lt;uchar&gt;(i, j);</span><br><span class="line">            <span class="keyword">if</span>(tempDepth &lt; <span class="number">43</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                depthRed = tempDepth * <span class="number">6</span>;</span><br><span class="line">                depthGreen = <span class="number">0</span>;</span><br><span class="line">                depthBlue = tempDepth * <span class="number">6</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(tempDepth &gt; <span class="number">42</span> &amp;&amp; tempDepth &lt; <span class="number">85</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                depthRed = <span class="number">255</span> - (tempDepth - <span class="number">43</span>) * <span class="number">6</span>;</span><br><span class="line">                depthGreen = <span class="number">0</span>;</span><br><span class="line">                depthBlue = <span class="number">255</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(tempDepth &gt; <span class="number">84</span> &amp;&amp; tempDepth &lt; <span class="number">128</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                depthRed = <span class="number">0</span>;</span><br><span class="line">                depthGreen = (tempDepth - <span class="number">85</span>) * <span class="number">6</span>;</span><br><span class="line">                depthBlue = <span class="number">255</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(tempDepth &gt; <span class="number">127</span> &amp;&amp; tempDepth &lt; <span class="number">169</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                depthRed = <span class="number">0</span>;</span><br><span class="line">                depthGreen = <span class="number">255</span>;</span><br><span class="line">                depthBlue = <span class="number">255</span> - (tempDepth - <span class="number">128</span>) * <span class="number">6</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(tempDepth &gt; <span class="number">168</span> &amp;&amp; tempDepth &lt; <span class="number">212</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                depthRed = (tempDepth - <span class="number">169</span>) * <span class="number">6</span>;</span><br><span class="line">                depthGreen = <span class="number">255</span>;</span><br><span class="line">                depthBlue = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(tempDepth &gt; <span class="number">211</span> &amp;&amp; tempDepth &lt; <span class="number">254</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                depthRed = <span class="number">255</span>;</span><br><span class="line">                depthGreen = <span class="number">255</span> - (tempDepth - <span class="number">212</span>) * <span class="number">6</span>;</span><br><span class="line">                depthBlue = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(tempDepth &gt; <span class="number">253</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                depthRed = <span class="number">255</span>;</span><br><span class="line">                depthGreen = <span class="number">0</span>;</span><br><span class="line">                depthBlue = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (tempDepth == <span class="number">255</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                depthRed = <span class="number">0</span>;</span><br><span class="line">                depthGreen = <span class="number">0</span>;</span><br><span class="line">                depthBlue = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            result.at&lt;Vec3b&gt;(i, j)[<span class="number">0</span>] = depthBlue;</span><br><span class="line">            result.at&lt;Vec3b&gt;(i, j)[<span class="number">1</span>] = depthGreen;</span><br><span class="line">            result.at&lt;Vec3b&gt;(i, j)[<span class="number">2</span>] = depthRed;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string filePath = <span class="string">&quot;C:/Users/XXXXXX/Downloads/NTU-Microsoft-Kinect-HandGesture Dataset/Depth&quot;</span>;</span><br><span class="line">    vector&lt;string&gt; files;  </span><br><span class="line">    <span class="comment">//读取所有文件  </span></span><br><span class="line">    string format = <span class="string">&quot;*&quot;</span>;  <span class="comment">// 不知道为什么在我电脑读不了特定文件？</span></span><br><span class="line">    <span class="built_in">getAllFormatFiles</span>(filePath, format, files);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; files.<span class="built_in">size</span>(); i++)    </span><br><span class="line">    &#123;</span><br><span class="line">        cv::Mat tempMat = <span class="built_in">Txt2DepthMat</span>(files[i]);</span><br><span class="line">        files[i].<span class="built_in">replace</span>(<span class="number">0</span>, <span class="number">66</span>, <span class="string">&quot;../data&quot;</span>);</span><br><span class="line">        files[i].<span class="built_in">replace</span>(files[i].<span class="built_in">find</span>(<span class="string">&quot;.txt&quot;</span>), files[i].<span class="built_in">length</span>() - <span class="number">1</span>, <span class="string">&quot;.png&quot;</span>);</span><br><span class="line">        cout&lt;&lt; files[i] &lt;&lt; endl; </span><br><span class="line">        string tempString = files[i].<span class="built_in">substr</span>(<span class="number">0</span>, files[i].<span class="built_in">find_last_of</span>(<span class="string">&quot;/&quot;</span>));</span><br><span class="line">        <span class="built_in">makeDir</span>(tempString);</span><br><span class="line">        cv::<span class="built_in">imwrite</span>(files[i], tempMat);</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;File Size: &quot;</span> &lt;&lt; files.<span class="built_in">size</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//cv::imshow(&quot;test&quot;, Depth2Color(Txt2DepthMat(&quot;./1.txt&quot;)));</span></span><br><span class="line">    cv::<span class="built_in">waitKey</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p><strong><em>2018-01-01 BTW：</em></strong>以上代码在 VS2010+Win7 下编译运行通过，在 VS2013+Win10 下 <code>for (int i = 0; outFile.getline(buffer, 12800, '\n') != NULL &amp;&amp; i &lt; result.rows; i++)</code> 会报错，可能需要改成 <code>for (int i = 0; outFile.getline(buffer, 12800, '\n') &amp;&amp; i &lt; result.rows; i++)</code> ，即去掉后面的 <code>!= NULL</code>。</p>
<h2 id="后记">后记</h2>
<p>　　正如前言所说，本文是以前记录过的，一些细节也快忘记，这次重写算是回顾一下吧，这段程序可能也确实只用这么一次，但其中用到了不少 C++ 处理字符串和读写文件等相关知识，而这些知识，在以后有极大的可能会再次用到，因此记录 ↖(^ω^)↗。</p>
<h2 id="参考资料">参考资料</h2>
<p>[1] <a href="http://blog.csdn.net/wangshihui512/article/details/8921924">C++文件读写操作（二）逐字符读取文本和逐行读取文本</a>（<a href="http://blog.csdn.net/shihui512/article/category/1397194" class="uri">http://blog.csdn.net/shihui512/article/category/1397194</a>）</p>
<p>[2] <a href="http://www.cnblogs.com/MikeZhang/archive/2012/03/24/MySplitFunCPP.html">字符串分割(C++)</a>（<a href="http://www.cnblogs.com/MikeZhang/category/345894.html" class="uri">http://www.cnblogs.com/MikeZhang/category/345894.html</a>）</p>
<p>[3] <a href="http://blog.csdn.net/adong76/article/details/39432467">C++读取文件夹中所有的文件或者是特定后缀的文件</a>（<a href="http://blog.csdn.net/adong76/article/category/1632029" class="uri">http://blog.csdn.net/adong76/article/category/1632029</a>）</p>
<p>[4] <a href="http://blog.csdn.net/u012005313/article/details/50688257">C/C++ 判断文件夹是否存在以及创建、删除文件夹 windows以及linux通用</a>（<a href="http://blog.csdn.net/u012005313/article/category/5586103" class="uri">http://blog.csdn.net/u012005313/article/category/5586103</a>）</p>
<p>[5] <a href="https://stackoverflow.com/questions/236129/the-most-elegant-way-to-iterate-the-words-of-a-string/7408245#7408245">Split a string in C++?</a>（<a href="http://stackoverflow.com/questions/236129/split-a-string-in-c" class="uri">http://stackoverflow.com/questions/236129/split-a-string-in-c</a>）</p>
<p>[6] <a href="http://blog.csdn.net/zouxy09/article/details/8151044">Kinect开发学习笔记之（六）带游戏者ID的深度数据的提取</a>（<a href="http://blog.csdn.net/zouxy09/article/category/1273380" class="uri">http://blog.csdn.net/zouxy09/article/category/1273380</a>）</p>
<p>[7] <a href="http://www.pages.drexel.edu/~nk752/depthMapTut.html">Depth Map Tutorial</a>（<a href="http://www.pages.drexel.edu/~nk752/depthMapTut.html" class="uri">http://www.pages.drexel.edu/~nk752/depthMapTut.html</a>）</p>
]]></content>
      <categories>
        <category>Study</category>
      </categories>
      <tags>
        <tag>c/cpp</tag>
        <tag>opencv</tag>
      </tags>
  </entry>
  <entry>
    <title>Scala 学习小结</title>
    <url>/posts/8d3d87a2.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　最近要改行做大数据相关的东西了，经调研大数据开发的语言还是用 Scala 好，当然 Java 也可以，毕竟都运行在 JVM 上，不过 Java 也有很长时间没用过了，所以对于 Shaun 来说用 Scala 和 Java 的代价是一样的，都需要学习一下，所以决定用对大数据更友好的 Scala。</p>
<span id="more"></span>
<p>　　以 Martin Odersky 14 年写的「Scala By Example」为参考，虽然是 14 年的，但 Scala 的基本语法还是没变的，就学习本身而言没问题，毕竟不兼容的只是更上层的 API，Shaun 学习用的 Scala 版本为 2.12.12。Alvin Alexander 的「Scala Cookbook, 2nd Edition」预计今年 8 月会出版，到时可能这本书用来入门更好，但 Shaun 不需要系统的学，就简单的能上手写出比较理想的 Scala 代码就行了。</p>
<h2 id="学习篇">学习篇</h2>
<h3 id="第一章入门基础">第一章：入门基础</h3>
<h4 id="helloworld">HelloWorld</h4>
<p>　　由于「Scala By Example」第一章没啥内容，也为了在正式写 Scala 之前简单熟悉一下，这里先用「A Scala Tutorial for Java Programmers」简单上手一下，首先写个 HelloWorld，具体代码如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">HelloWorld</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">        println(<span class="string">&quot;Hello, world!&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>　　和 C 语言类似，程序唯一入口函数都是 main 函数，但 Scala 的变量在前，声明的类型在后，相比常规的语言是有点奇怪了，但这种语法规则和 Typescript 一样，所以很容易接受，但其模板的表示就有点奇怪了，Array[String] 表示一个 String 类型的数组，即表示方法为 Array[T]，常规的模板方式为 <code>Array&lt;T&gt;</code> 或 <code>T[]</code>，def 关键字用来定义一个函数，object 用来表示一个单例类，即在定义类的同时，又创建了一个类的实例。Scala 中没有 static 关键字，需要用 static 修饰的都放在 object 中即可。</p>
<h4 id="调用-java">调用 Java</h4>
<p>Scala 中默认已导入 java.lang 中的全部类，但其它类需要显式导入，以格式化输出本地日期为例：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.&#123;<span class="type">Date</span>, <span class="type">Locale</span>&#125;</span><br><span class="line"><span class="keyword">import</span> java.text.<span class="type">DateFormat</span>._</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">LocalDate</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">        <span class="keyword">val</span> now = <span class="keyword">new</span> <span class="type">Date</span></span><br><span class="line">        <span class="keyword">val</span> df = getDateInstance(<span class="type">LONG</span>, <span class="type">Locale</span>.<span class="type">CHINA</span>)</span><br><span class="line">        println(df format now) <span class="comment">// df format(now)</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>　　Scala 中的导入和 java 中 import 基本一样，但功能更强大，可以使用 <code>&#123;&#125;</code> 导入部分，也使用 <code>_</code> 导入全部（java 导入全部为 <code>*</code>，这不一样），当一个函数只有一个参数，可以通过 <em>空格+参数</em> 的形式调用，而不需要使用 <em>括号包裹</em> 的形式。这里采用 <code>val</code> 关键字声明的是常量，而要声明变量需要用 <code>var</code>。</p>
<h4 id="对象">对象</h4>
<p>Scala 中万物皆对象，一个数字也是一个对象，一个函数也是一个对象，具体如下图：</p>
<figure>
<img src="http://coredumper.cn/wordpress/wp-content/uploads/2017/06/MacHi-2017-06-03-17-18-18.png" alt="enter image description here" /><figcaption aria-hidden="true">enter image description here</figcaption>
</figure>
<p>以简单计时器函数为例：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Timer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">oncePerSecond</span></span>(callback: () =&gt; <span class="type">Unit</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            callback();</span><br><span class="line">            <span class="type">Thread</span> sleep <span class="number">1000</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">timeFiles</span></span>() &#123;</span><br><span class="line">        println(<span class="string">&quot;time files like an arrow...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">        <span class="comment">// oncePerSecond(timeFiles);</span></span><br><span class="line">        oncePerSecond(() =&gt; &#123;</span><br><span class="line">            println(<span class="string">&quot;time files like an arrow...&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>　　这个和 Typescript 函数式编程的用法基本差不多，唯一不同这里声明的函数返回的是 <code>Unit</code> ，这个 Unit 可认为是无返回的函数，大部分情况等同于 void，在 Scala 中真正的没有值指的是 Nothing。</p>
<h4 id="类">类</h4>
<p>Scala 中同样有类，具体代码示例如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Complex</span>(<span class="params">real: <span class="type">Double</span>, imaginary: <span class="type">Double</span></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// def re() = real;</span></span><br><span class="line">    <span class="comment">// def im() = imaginary;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">re</span> </span>= real;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">im</span> </span>= imaginary;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">toString</span></span>(): <span class="type">String</span> = <span class="string">&quot;&quot;</span> + re + (<span class="keyword">if</span> (im &lt; <span class="number">0</span>) <span class="string">&quot;&quot;</span> <span class="keyword">else</span> <span class="string">&quot;+&quot;</span>) + im + <span class="string">&quot;i&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">ComplexNumbers</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">        <span class="keyword">val</span> c = <span class="keyword">new</span> <span class="type">Complex</span>(<span class="number">1.2</span>, <span class="number">-3.4</span>);</span><br><span class="line">        <span class="comment">// println(&quot;real part: &quot; + c.re() + &quot; imaginary part: &quot; + c.im());</span></span><br><span class="line">        println(c.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>　　在 Scala 中所有类都会继承某个父类，若没有显式声明父类，则默认继承 scala.AnyRef 类，如上面的 Complex 类，若需要覆盖父类的函数，则需要在函数声明前加上 override 关键字。当函数没有参数时，可以不用加括号，在调用时也不用加括号，如上面示例的注释和非注释的代码。</p>
<h4 id="模式匹配与条件类">模式匹配与条件类</h4>
<p>　　接下来用 Scala 来写一个树结构表示表达式的示例代码，树的非叶节点表示操作符，叶子节点表示数值（这里为常量或变量），具体代码如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Tree</span></span></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Sum</span>(<span class="params">l: <span class="type">Tree</span>, r: <span class="type">Tree</span></span>) <span class="keyword">extends</span> <span class="title">Tree</span></span></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Var</span>(<span class="params">n: <span class="type">String</span></span>) <span class="keyword">extends</span> <span class="title">Tree</span></span></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Const</span>(<span class="params">v: <span class="type">Int</span></span>) <span class="keyword">extends</span> <span class="title">Tree</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Expression</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Environment</span> </span>= <span class="type">String</span> =&gt; <span class="type">Int</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">eval</span></span>(t: <span class="type">Tree</span>, env: <span class="type">Environment</span>): <span class="type">Int</span> = t <span class="keyword">match</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">Sum</span>(l, r) =&gt; eval(l, env) + eval(r, env)</span><br><span class="line">        <span class="keyword">case</span> <span class="type">Var</span>(n) =&gt; env(n)</span><br><span class="line">        <span class="keyword">case</span> <span class="type">Const</span>(v) =&gt; v</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">derive</span></span>(t: <span class="type">Tree</span>, v: <span class="type">String</span>): <span class="type">Tree</span> = t <span class="keyword">match</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">Sum</span>(l, r) =&gt; <span class="type">Sum</span>(derive(l, v), derive(r, v))</span><br><span class="line">        <span class="keyword">case</span> <span class="type">Var</span>(n) <span class="keyword">if</span> (v == n) =&gt; <span class="type">Const</span>(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">case</span> _ =&gt; <span class="type">Const</span>(<span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">        <span class="keyword">val</span> exp: <span class="type">Tree</span> = <span class="type">Sum</span>(<span class="type">Sum</span>(<span class="type">Var</span>(<span class="string">&quot;x&quot;</span>), <span class="type">Var</span>(<span class="string">&quot;x&quot;</span>)), <span class="type">Sum</span>(<span class="type">Const</span>(<span class="number">7</span>), <span class="type">Var</span>(<span class="string">&quot;y&quot;</span>))) </span><br><span class="line">        <span class="keyword">val</span> env: <span class="type">Environment</span> = &#123;<span class="keyword">case</span> <span class="string">&quot;x&quot;</span> =&gt; <span class="number">5</span> <span class="keyword">case</span> <span class="string">&quot;y&quot;</span> =&gt; <span class="number">7</span>&#125;</span><br><span class="line">        println(<span class="string">&quot;Expression: &quot;</span> + exp)</span><br><span class="line">        println(<span class="string">&quot;Evalution with x=5, y=7: &quot;</span> + eval(exp, env))</span><br><span class="line">        println(<span class="string">&quot;Derivative relative to x:\n&quot;</span> + derive(exp, <span class="string">&quot;x&quot;</span>))</span><br><span class="line">        println(<span class="string">&quot;Derivative relative to y:\n&quot;</span> + derive(exp, <span class="string">&quot;y&quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>　　该示例主要用来说明两种 case 关键字，分别为：case class 和 ... match case ...，前者可认为是一个结构体，实例化时可以省略 new 关键字，参数有默认的 getter 函数，整个 case class 有默认的 equals 和 hashCode 方法实现，通过这两个方式可实现根据值判断类的两个实例是否相等，而不是通过引用，条件类同样有默认的 toString 方法实现；后者可认为是一种特殊的 switch case ，只不过 case 的判定和执行是函数式的，case class 可直接参与 match case 的判定（判定是不是属于该类）。第 7 行中有个 type 关键字，可认为是定义了一种新的类型（不是数据类型），示例中是函数类型，通过这个 type ，可直接将字符串映射为整型，23 行中将这个 type 与 case 结合使用，定义多个字符串映射多个整型的变量。第 18 行中有个 <code>_</code> ，这是 scala 中的通配符，不同的语义下表示的含义不同，这里的含义是指，当上面的模式都不匹配时，将执行这个，相当于 switch case 中的 default。</p>
<h4 id="scala-中的-trait">Scala 中的 trait</h4>
<p>　　简单理解就是 Java 中的 Interface（接口），Scala 中没有 interface 关键字，但是 trait 比 Interface 的功能更多，其中可直接定义属性和方法的实现，Scala 中可通过 trait 来实现多重继承。下面的示例用 trait 简单实现了一个比较接口：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Ord</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">&lt;</span></span>(that: <span class="type">Any</span>): <span class="type">Boolean</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">&lt;=</span></span>(that: <span class="type">Any</span>): <span class="type">Boolean</span> = (<span class="keyword">this</span> &lt; that) || (<span class="keyword">this</span> == that)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">&gt;</span></span>(that: <span class="type">Any</span>): <span class="type">Boolean</span> = !(<span class="keyword">this</span> &lt;= that)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">&gt;=</span></span>(that: <span class="type">Any</span>): <span class="type">Boolean</span> = !(<span class="keyword">this</span> &lt; that)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Date</span>(<span class="params">y: <span class="type">Int</span>, m: <span class="type">Int</span>, d: <span class="type">Int</span></span>) <span class="keyword">extends</span> <span class="title">Ord</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">year</span> </span>= y</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">month</span> </span>= m</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">day</span> </span>= d</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">toString</span></span>(): <span class="type">String</span> = year + <span class="string">&quot;-&quot;</span> + month + <span class="string">&quot;-&quot;</span> + day</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">equals</span></span>(that: <span class="type">Any</span>): <span class="type">Boolean</span> = &#123;</span><br><span class="line">        that.isInstanceOf[<span class="type">Date</span>] &amp;&amp; &#123;</span><br><span class="line">            <span class="keyword">val</span> o = that.asInstanceOf[<span class="type">Date</span>]</span><br><span class="line">            o.day == day &amp;&amp; o.month == month &amp;&amp; o.year == year</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">&lt;</span></span>(that: <span class="type">Any</span>): <span class="type">Boolean</span> = &#123;</span><br><span class="line">        <span class="keyword">if</span> (!that.isInstanceOf[<span class="type">Date</span>]) &#123;</span><br><span class="line">            sys.error(<span class="string">&quot;cannot compare &quot;</span> + that + <span class="string">&quot; and a Date&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> o = that.asInstanceOf[<span class="type">Date</span>]</span><br><span class="line">        (year &lt; o.year) || (year == o.year &amp;&amp; (month &lt; o.month || (month == o.month &amp;&amp; day &lt; o.day)))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Comparable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">        <span class="keyword">val</span> d1 = <span class="keyword">new</span> <span class="type">Date</span>(<span class="number">2021</span>, <span class="number">1</span>, <span class="number">3</span>);</span><br><span class="line">        <span class="keyword">val</span> d2 = <span class="keyword">new</span> <span class="type">Date</span>(<span class="number">2021</span>, <span class="number">1</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">        println(d1 &lt; d2)</span><br><span class="line">        println(d1 &lt;= d2)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>　　比较关系一般只需要确定 小于 和 等于 关系即可，其它关系都可由这两关系推出来，由于等于方法默认存在于所有对象中，所以只需要重写小于即可， 其它的比较方法都可以在 trait 中定义好。在上面的示例中有两个函数 isInstanceOf 和 asInstanceOf，前者用来判断对象是否是指定类型，后者用来将对象转换为指定类型，一般用在将父类转为子类时，在使用 asInstanceOf 之前一般需要先使用 isInstanceOf。</p>
<h4 id="泛型">泛型</h4>
<p>　　这东西没啥好说的，基本有编程经验的或见过或用过，只是 Scala 的泛型语法确实有点奇怪就是了，可能也是为了函数式那些乱七八糟的操作符，具体示例代码如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Reference</span>[<span class="type">T</span>] </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> contents: <span class="type">T</span> = _</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set</span></span>(value: <span class="type">T</span>) &#123;</span><br><span class="line">        contents = value</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span></span>: <span class="type">T</span> = contents</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">IntegerReference</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">        <span class="keyword">val</span> cell = <span class="keyword">new</span> <span class="type">Reference</span>[<span class="type">Int</span>]</span><br><span class="line">        cell.set(<span class="number">13</span>)</span><br><span class="line">        println(<span class="string">&quot;Reference contains the half of &quot;</span> + (cell.get * <span class="number">2</span>))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>　　这里同样有个 <code>_</code>，这里表示的是默认值，对于数字类型来说是 0，对于 boolean 来说是 false，对于 Unit（函数签名）来说是()（无参数无返回），对于其他来说是 null。</p>
<p>简单的了解 Scala 就到这里了。</p>
<hr />
<h3 id="第二章快排">第二章：快排</h3>
<p>开场就是一个快排，示例代码如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">QuickSort</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">qSort</span></span>(xs: <span class="type">Array</span>[<span class="type">Int</span>]) &#123;</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">swap</span></span>(i: <span class="type">Int</span>, j: <span class="type">Int</span>) &#123;</span><br><span class="line">            <span class="keyword">val</span> t = xs(i); xs(i) = xs(j); xs(j) = t;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">sort</span></span>(l: <span class="type">Int</span>, r: <span class="type">Int</span>) &#123;</span><br><span class="line">            <span class="keyword">val</span> pivot = xs(l);</span><br><span class="line">            <span class="keyword">var</span> i = l+<span class="number">1</span>; <span class="keyword">var</span> j = r;</span><br><span class="line">            <span class="keyword">while</span> (i &lt; j) &#123;</span><br><span class="line">                <span class="keyword">while</span> (i &lt;= r &amp;&amp; xs(i) &lt; pivot) i += <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">while</span> (j &gt; l &amp;&amp; xs(j) &gt; pivot) j -= <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (i &lt; j) &#123;</span><br><span class="line">                    swap(i, j);</span><br><span class="line">                    i += <span class="number">1</span>;</span><br><span class="line">                    j -= <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (i &gt; j) &#123;</span><br><span class="line">                    i = j;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> (i &gt; l &amp;&amp; xs(i) &gt; pivot) &#123;</span><br><span class="line">                i -= <span class="number">1</span>; j -= <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            swap(i, l);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (l &lt; j<span class="number">-1</span>) sort(l, j<span class="number">-1</span>);</span><br><span class="line">            <span class="keyword">if</span> (j+<span class="number">1</span> &lt; r) sort(j+<span class="number">1</span>, r);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sort(<span class="number">0</span>, xs.length<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">        <span class="comment">// val xs = Array(4, 1, 2, 5, 6);</span></span><br><span class="line">        <span class="comment">// val xs = Array(1, 2, 4, 4, 55, 5, 6);</span></span><br><span class="line">        <span class="comment">// val xs = Array(55, 6, 6);</span></span><br><span class="line">        <span class="keyword">val</span> xs = <span class="type">Array</span>(<span class="number">4</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>, <span class="number">2</span>, <span class="number">6</span>);</span><br><span class="line">        qSort(xs);</span><br><span class="line">        println(xs.mkString(<span class="string">&quot; &quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>　　从这段快排代码可看出，Scala 支持函数嵌套和闭包，即在函数内部定义子函数，子函数可直接使用父函数的变量，同时，这里也简单说明一下 Scala 中数组的一些使用方法，用下标取数组元素时使用的是小括号 <code>()</code>，而不是其它语言常见的中括号 <code>[]</code>。当然 Scala 作为一种函数式语言，提供了非常多的函数式操作符，这篇也只会简单介绍。</p>
<h3 id="第三章actor">第三章：Actor</h3>
<p>　　Actor，Scala 中的多线程编程模型，下方的示例代码在 Scala 2.11 及之后的版本无法运行，因为 Actor 已从 Scala 库独立出来，见 <a href="https://stackoverflow.com/questions/29343770/object-actors-is-not-a-member-of-package-scala">object-actors-is-not-a-member-of-package-scala</a>。</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> scala.actors.<span class="type">Actor</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AuctionMessage</span></span></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Offer</span>(<span class="params">bin: <span class="type">Int</span>, client: <span class="type">Actor</span></span>) <span class="keyword">extends</span> <span class="title">AuctionMessage</span></span></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Inquire</span>(<span class="params">client: <span class="type">Actor</span></span>) <span class="keyword">extends</span> <span class="title">AuctionMessage</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AuctionReply</span></span></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Status</span>(<span class="params">asked: <span class="type">Int</span>, expire: <span class="type">Date</span></span>) <span class="keyword">extends</span> <span class="title">AuctionReply</span></span></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">object</span> <span class="title">BestOffer</span> <span class="keyword">extends</span> <span class="title">AuctionReply</span></span></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">BeatenOffer</span>(<span class="params">maxBid: <span class="type">Int</span></span>) <span class="keyword">extends</span> <span class="title">AuctionReply</span></span></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">AuctionConCluded</span>(<span class="params">seller: <span class="type">Actor</span>, client: <span class="type">Actor</span></span>) <span class="keyword">extends</span> <span class="title">AuctionReply</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">object</span> <span class="title">AuctionFailed</span> <span class="keyword">extends</span> <span class="title">AuctionReply</span></span></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">object</span> <span class="title">AuctionOver</span> <span class="keyword">extends</span> <span class="title">AuctionReply</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Auction</span>(<span class="params">seller: <span class="type">Actor</span>, minBid: <span class="type">Int</span>, closing: <span class="type">Date</span></span>) <span class="keyword">extends</span> <span class="title">Actor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">val</span> timeToShutdown = <span class="number">36000000</span> <span class="comment">// msec</span></span><br><span class="line">    <span class="keyword">val</span> bidIncrement = <span class="number">10</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">act</span></span>() &#123;</span><br><span class="line">        <span class="keyword">var</span> maxBid = minBid - bidIncrement</span><br><span class="line">        <span class="keyword">var</span> maxBidder: <span class="type">Actor</span> = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">var</span> running = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (running) &#123;</span><br><span class="line">            receiveWithin ((closing.getTime() - <span class="keyword">new</span> <span class="type">Date</span>().getTime())) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="type">Offer</span>(bid, client) =&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> (bid &gt;= maxBid + bidIncrement) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (maxBid &gt;= minBid)   maxBidder ! <span class="type">BeatenOffer</span>(bid)</span><br><span class="line">                        maxBid = bid; maxBidder = client; client ! <span class="type">BestOffer</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        client ! <span class="type">BeatenOffer</span>(maxBid)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> <span class="type">Inquire</span>(client) =&gt; &#123;</span><br><span class="line">                    client ! <span class="type">BeatenOffer</span>(maxBid)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> <span class="type">TIMEOUT</span> =&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> (maxBid &gt;= minBid) &#123;</span><br><span class="line">                        <span class="keyword">val</span> reply = <span class="type">AuctionConCluded</span>(seller, maxBidder)</span><br><span class="line">                        maxBidder ! reply; seller ! reply</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        seller ! <span class="type">AuctionFailed</span></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    receiveWithin(timeToShutdown) &#123;</span><br><span class="line">                        <span class="keyword">case</span> <span class="type">Offer</span>(_, client) =&gt; client ! <span class="type">AuctionOver</span></span><br><span class="line">                        <span class="keyword">case</span> <span class="type">TIMEOUT</span> =&gt; running = <span class="literal">false</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloActor</span> <span class="keyword">extends</span> <span class="title">Actor</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">act</span></span>() &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            receive &#123;</span><br><span class="line">                <span class="keyword">case</span> name: <span class="type">String</span> =&gt; println(<span class="string">&quot;Hello, &quot;</span> + name)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">AuctionService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">        <span class="keyword">val</span> seller: <span class="type">Actor</span> = <span class="keyword">new</span> <span class="type">HelloActor</span></span><br><span class="line">        <span class="keyword">val</span> client: <span class="type">Actor</span> = <span class="keyword">new</span> <span class="type">HelloActor</span></span><br><span class="line">        <span class="keyword">val</span> minBid = <span class="number">10</span></span><br><span class="line">        <span class="keyword">val</span> closing = <span class="keyword">new</span> <span class="type">Date</span>()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> helloActor = <span class="keyword">new</span> <span class="type">HelloActor</span></span><br><span class="line">        helloActor.start()</span><br><span class="line">        helloActor ! <span class="string">&quot;leo&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>　　通过重写 Actor 中的 <code>act</code> 方法即可简单的实现多线程编程，Actor 中有个特殊的标识符 <code>!</code>，该符号其实是是一种缩写，即可将 <code>helloActor.!("leo")</code> 缩写为 <code>helloActor ! "leo"</code>，代表将数据传递给 Actor，由 Actor 内部的 <code>receive case</code> 接受数据并处理，当然也可通过 <code>receiveWithin</code> 控制数据传递时间，若超时，则默认触发 <code>TIMEOUT</code> 处理模式。</p>
<h3 id="第四章表达式与简单函数">第四章：表达式与简单函数</h3>
<p>该章主要有两个例子：1、牛顿法求平方根；2、尾递归，具体如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Sqrt</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sqrt</span></span>(x: <span class="type">Double</span>): <span class="type">Double</span> = &#123;</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">sqrtIter</span></span>(guess: <span class="type">Double</span>, x: <span class="type">Double</span>): <span class="type">Double</span> = &#123;</span><br><span class="line">            <span class="keyword">if</span> (isGoodEnough(guess, x)) guess</span><br><span class="line">            <span class="keyword">else</span> sqrtIter(improve(guess, x), x)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">improve</span></span>(guess: <span class="type">Double</span>, x: <span class="type">Double</span>) = &#123;</span><br><span class="line">            (guess + x / guess) / <span class="number">2</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">isGoodEnough</span></span>(guess: <span class="type">Double</span>, x: <span class="type">Double</span>) = (guess * guess - x).abs &lt; <span class="number">0.001</span>    <span class="comment">// guess * guess == x</span></span><br><span class="line"></span><br><span class="line">        sqrtIter(<span class="number">1.0</span>, x)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">TailRecursion</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">gcd</span></span>(a: <span class="type">Int</span>, b: <span class="type">Int</span>): <span class="type">Int</span> = <span class="keyword">if</span> (b == <span class="number">0</span>) a <span class="keyword">else</span> gcd(b, a % b)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">facorial</span></span>(n: <span class="type">Int</span>): <span class="type">Int</span> = <span class="keyword">if</span> (n == <span class="number">0</span>) <span class="number">1</span> <span class="keyword">else</span> n * facorial(n<span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">facorialTail</span></span>(n: <span class="type">Int</span>): <span class="type">Int</span> = &#123;</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">facorialIter</span></span>(n: <span class="type">Int</span>, res: <span class="type">Int</span>): <span class="type">Int</span> = &#123;</span><br><span class="line">            <span class="keyword">if</span> (n == <span class="number">0</span>) res</span><br><span class="line">            <span class="keyword">else</span> facorialIter(n<span class="number">-1</span>, res * n)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        facorialIter(n, <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">SimpleFunc</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">        <span class="keyword">val</span> sqrtValue = <span class="type">Sqrt</span>.sqrt(<span class="number">0.01</span>)</span><br><span class="line">        println(sqrtValue)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> gcdValue = <span class="type">TailRecursion</span>.gcd(<span class="number">14</span>,<span class="number">21</span>)</span><br><span class="line">        println(gcdValue)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> facorialValue = <span class="type">TailRecursion</span>.facorial(<span class="number">5</span>)</span><br><span class="line">        println(facorialValue)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> facorialTailValue = <span class="type">TailRecursion</span>.facorialTail(<span class="number">5</span>)</span><br><span class="line">        println(facorialTailValue)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>　　由于并没有引入新的语法，就简单聊聊这两个例子吧。牛顿法求平方根主要在于构造一个特殊的二分函数 <span class="math inline">\(y_{i+1} = (y_i + x / y_i)/2, i=0,1,2,3,..., y_0=1\)</span> ，如此迭代，直到 <span class="math inline">\(|y_i^2-x| &lt; \epsilon\)</span> ，得到 <span class="math inline">\(y_i\)</span> 即为 x 的平方根，更朴素一点的求多次方根就是利用二分法，分 [0, 1] 和 [1, +∞] 两个区间即可，对应从 [x, 1] 和 [1, x] 开始二分取值。至于尾递归，以前简单的写过一点，即最后递归调用原函数时，原函数不会再参与任何计算表达式。尾递归的好处在于当编译器或解释器支持尾递归时，将不会产生普通递归时的压栈操作，即不用担心递归层次太深，尾递归将类似循环迭代处理。</p>
<h3 id="第五章高阶函数">第五章：高阶函数</h3>
<p>　　高阶函数（First-Class Functions），支持以函数作为参数或返回值，也可将函数赋值给其它变量，由此也可引出闭包和柯里化，闭包是指将内嵌函数作为返回值，而柯里化是指将多个参数分解为独立参数传递给函数，如：<span class="math inline">\(f(args_1,args_2,...,args_n)=f(args_1)(args_2)(...)(args_n)\)</span>。下面以求函数的不动点为例：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">FirstClassFunctions</span> </span>&#123;</span><br><span class="line">    <span class="keyword">val</span> tolerance = <span class="number">0.0001</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">isCloseEnough</span></span>(x: <span class="type">Double</span>, y: <span class="type">Double</span>) = ((x-y) / x).abs &lt; tolerance</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fixedPoint</span></span>(f: <span class="type">Double</span> =&gt; <span class="type">Double</span>)(firstGuess: <span class="type">Double</span>) = &#123;</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">iterate</span></span>(guess: <span class="type">Double</span>): <span class="type">Double</span> = &#123;</span><br><span class="line">            <span class="keyword">val</span> next = f(guess)</span><br><span class="line">            <span class="keyword">if</span> (isCloseEnough(guess, next)) next</span><br><span class="line">            <span class="keyword">else</span> iterate(next)</span><br><span class="line">        &#125;</span><br><span class="line">        iterate(firstGuess)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">averageDamp</span></span>(f: <span class="type">Double</span> =&gt; <span class="type">Double</span>)(x: <span class="type">Double</span>) = (x + f(x)) / <span class="number">2</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sqrt</span></span>(x: <span class="type">Double</span>) = fixedPoint(averageDamp(y =&gt; x/y))(<span class="number">1.0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">        println(sqrt(<span class="number">0.01</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>　　该示例简单明了的展示了 Scala 中匿名函数，函数柯里化以及闭包。</p>
<h3 id="第六章类和对象">第六章：类和对象</h3>
<p>直接看下面的有理数示例吧，</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 主构造函数</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rational</span>(<span class="params">n: <span class="type">Int</span>, d: <span class="type">Int</span></span>) <span class="keyword">extends</span> <span class="title">AnyRef</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">gcd</span></span>(x: <span class="type">Int</span>, y: <span class="type">Int</span>): <span class="type">Int</span> = &#123;</span><br><span class="line">        <span class="keyword">if</span> (x == <span class="number">0</span>) y</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (x &lt; <span class="number">0</span>) gcd(-x, y)</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (y &lt; <span class="number">0</span>) -gcd(x, -y)</span><br><span class="line">        <span class="keyword">else</span> gcd(y % x, x)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> g = gcd(n, d)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造函数重载（辅助构造函数）</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">this</span></span>() &#123;</span><br><span class="line">        <span class="keyword">this</span>(<span class="number">0</span>, <span class="number">0</span>)  <span class="comment">// 调用主构造函数</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> number: <span class="type">Int</span> = <span class="keyword">if</span> (g != <span class="number">0</span>) n / g <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">val</span> denom: <span class="type">Int</span> = <span class="keyword">if</span> (g != <span class="number">0</span>) d / g <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">+</span></span>(that: <span class="type">Rational</span>) = <span class="keyword">new</span> <span class="type">Rational</span>(number * that.denom + that.number * denom, denom * that.denom)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">-</span></span>(that: <span class="type">Rational</span>) = <span class="keyword">new</span> <span class="type">Rational</span>(number * that.denom - that.number * denom, denom * that.denom)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">*</span></span>(that: <span class="type">Rational</span>) = <span class="keyword">new</span> <span class="type">Rational</span>(number * that.number, denom * that.denom)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">/</span></span>(that: <span class="type">Rational</span>) = <span class="keyword">new</span> <span class="type">Rational</span>(number * that.denom, denom * that.number)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">toNumber</span></span>: <span class="type">Double</span> = <span class="keyword">if</span> (denom != <span class="number">0</span>) number.toDouble / denom <span class="keyword">else</span> <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">toString</span> </span>= <span class="string">&quot;&quot;</span> + number + <span class="string">&quot;/&quot;</span> + denom</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Rational</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">        <span class="keyword">val</span> rational = <span class="keyword">new</span> <span class="type">Rational</span>(<span class="number">2</span>,<span class="number">1</span>) / <span class="keyword">new</span> <span class="type">Rational</span>()</span><br><span class="line">        println(rational.toNumber);</span><br><span class="line">        println(rational.toString);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>　　从有理数这个示例可以看出，Scala 的类支持操作符重载，也支持构造函数重载，同样支持继承，多继承也是支持的，每个父类用 <code>with</code> 关键字分隔就行。</p>
<h3 id="第七章条件类和模式匹配">第七章：条件类和模式匹配</h3>
<p>大致和第一章内容差不多，就不重复写了。</p>
<h3 id="第八章泛型">第八章：泛型</h3>
<p>　　大致也和第一章内容差不多，<em>值得一提的书中实现的泛型栈本质是一个链表，实现方法挺有意思的</em>。通过 <code>&lt;:</code> 标识符可约束泛型的类型，如 <code>[T &lt;: P[T]]</code> 表明泛型 T 必须类型 P 的子类型。而标识符 <code>&lt;%</code> 比 <code>&lt;:</code> 约束性弱一点，只要 T 能够通过隐式类型变换为 P 即可。若想约束为父类型，则需使用 <code>&gt;:</code> 标识符。</p>
<p>　　Scala 中有一种特殊的泛型，就是变化型注解，<code>trait List[+T]</code> 代表协变，表示当 B 类型是 A 类型子类时，<code>List[B]</code> 也可认为是 <code>List[A]</code> 的子类；<code>trait List[-T]</code> 代表逆变，当 B 类型是 A 类型子类时，<code>List[B]</code> 可认为是 <code>List[A]</code> 的父类。</p>
<p>　　Scala 中同样有元组，使用时也很方便，简单使用直接用括号声明即可，如 <code>def divmod(x: Int, y: Int): (Int, Int) = (x / y, x % y)</code>，该函数即返回一个元组，也可声明一个元组 <code>case class Tuple2[A, B](_1: A, _2: B)</code>，若需要取元组的元素可通过 <code>_i</code> 的方式，如 <code>val xy = divmod(3, 4); xy._1; xy._2;</code>，也可通过 match-case 语句取，如 <code>xy match &#123; case (n, d) =&gt; println("quotient: " + n + ", rest: " + d) &#125;</code>。</p>
<h3 id="第九章list">第九章：List</h3>
<p>　　Scala 中的 List 其实是数组结构，并且是不可变的，可认为是 C++ 里的静态数组，不能往其中添加或删除元素，下面用数组排序示例下 List 的用法：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Sort</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">insertSort</span></span>(xsl: <span class="type">List</span>[<span class="type">Int</span>]): <span class="type">List</span>[<span class="type">Int</span>] = &#123;</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">insert</span></span>(x: <span class="type">Int</span>, xs: <span class="type">List</span>[<span class="type">Int</span>]): <span class="type">List</span>[<span class="type">Int</span>] = &#123;</span><br><span class="line">            xs <span class="keyword">match</span> &#123;</span><br><span class="line">                <span class="comment">// case Nil =&gt; List(x)</span></span><br><span class="line">                <span class="keyword">case</span> <span class="type">List</span>() =&gt; <span class="type">List</span>(x)</span><br><span class="line">                <span class="keyword">case</span> y :: ys =&gt; <span class="keyword">if</span> (x &lt;= y) x :: xs <span class="keyword">else</span> y :: insert(x, ys)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (xsl.isEmpty) <span class="type">Nil</span></span><br><span class="line">        <span class="keyword">else</span> insert(xsl.head, insertSort(xsl.tail))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mergeSort</span></span>[<span class="type">A</span>](less: (<span class="type">A</span>, <span class="type">A</span>) =&gt; <span class="type">Boolean</span>)(xs: <span class="type">List</span>[<span class="type">A</span>]): <span class="type">List</span>[<span class="type">A</span>] = &#123;</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">merge</span></span>(xs1: <span class="type">List</span>[<span class="type">A</span>], xs2: <span class="type">List</span>[<span class="type">A</span>]): <span class="type">List</span>[<span class="type">A</span>] = &#123;</span><br><span class="line">            <span class="keyword">if</span> (xs1.isEmpty) xs2</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (xs2.isEmpty) xs1</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (less(xs1.head, xs2.head)) xs1.head :: merge(xs1.tail, xs2)</span><br><span class="line">            <span class="keyword">else</span>  xs2.head :: merge(xs1, xs2.tail)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> n = xs.length / <span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> (n == <span class="number">0</span>) xs</span><br><span class="line">        <span class="keyword">else</span> merge(mergeSort(less)(xs take n), mergeSort(less)(xs drop n))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">        <span class="keyword">val</span> xs = <span class="type">List</span>(<span class="number">4</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>, <span class="number">2</span>, <span class="number">6</span>);</span><br><span class="line">        <span class="comment">// val xs = 3::2::1::1::Nil;</span></span><br><span class="line">        println(xs(<span class="number">0</span>), xs(<span class="number">1</span>), xs(xs.length<span class="number">-1</span>)) <span class="comment">// (4,1,6)</span></span><br><span class="line">        <span class="comment">// val ys = insertSort(xs);</span></span><br><span class="line">        <span class="keyword">val</span> ys = mergeSort((x: <span class="type">Int</span>, y: <span class="type">Int</span>) =&gt; x &gt; y)(xs);</span><br><span class="line">        println(ys.mkString(<span class="string">&quot; &quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>　　List 中有两个操作符非常类似，即 <code>::</code> 和 <code>:::</code>， 前者用于 List 中的元素和 List 连接，即创建一个新 List，新 List 为原 List 头插入元素后的 List，后者用于连接两个 List，即创建一个新 List ，新 List 为将第二个 List 的元素全部放入第一个 List 尾部的 List。字符 <code>Nil</code> 代表空 List 和 <code>List()</code> 等效，<code>head</code> 方法返回 List 的第一个元素，<code>tail</code> 方法返回除第一个元素之外的其它所有元素，还是一个 List，<code>isEmpty</code> 方法当 List 为空时返回 <code>true</code>。List 的 case-match 方法中，<code>case y :: ys</code> 其中 y 代表 xs.head，ys 代表 xs.tail。<code>(xs take n)</code> 表示取 List 前 n 个元素，<code>(xs drop n)</code> 表示取 List 前 n 个元素之外的元素，即与 (xs take n) 取得元素正好互补，而 <code>(xs split n)</code> 返回一个元组，元组中第一个元素为 (xs take n)，第二个元素为 (xs drop n)。关于 List 还有些更高阶得方法：filter，map, flatMap, reduceRight, foldRight 等方法就不继续写了。至于动态 List 可用 <code>ListBuffer</code> 结构，当然 Scala 中直接用 <code>Seq</code> 作为返回值和参数一般会更好些。</p>
<h3 id="第十章序列理解">第十章：序列理解</h3>
<p>　　Scala 中用来做序列理解的表达式是 <code>For-Comprehensions</code>，具体示例如下：<code>for (p &lt;persons if p.age &gt; 20) yield p.name</code> 相当于 <code>persons filter (p =&gt; p.age &gt; 20) map (p =&gt; p.name)</code>，可以简单认为 for-yield 方法是 filter 和 map 的集合体。下面具体用个 N-皇后（特例是 8 皇后）的示例来具体说明：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">NQueen</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">queens</span></span>(n: <span class="type">Int</span>): <span class="type">List</span>[<span class="type">List</span>[<span class="type">Int</span>]] = &#123;</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">isSafe</span></span>(col: <span class="type">Int</span>, queenList: <span class="type">List</span>[<span class="type">Int</span>], delta: <span class="type">Int</span>): <span class="type">Boolean</span> = &#123;</span><br><span class="line">            <span class="keyword">val</span> curRow = queenList.length<span class="number">-1</span> + delta</span><br><span class="line">            <span class="keyword">for</span> (row &lt;- <span class="type">List</span>.range(<span class="number">0</span>, queenList.length)) &#123;</span><br><span class="line">                <span class="keyword">val</span> queenCol = queenList(row)</span><br><span class="line">                <span class="keyword">val</span> queenRow = queenList.length<span class="number">-1</span> - row</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (queenCol == col) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">                <span class="keyword">if</span> (queenRow == curRow) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">                <span class="keyword">if</span> ((queenCol - col).abs == (queenRow - curRow).abs) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">placeQueens</span></span>(k: <span class="type">Int</span>): <span class="type">List</span>[<span class="type">List</span>[<span class="type">Int</span>]] = &#123;</span><br><span class="line">            <span class="keyword">if</span> (k == <span class="number">0</span>) <span class="type">List</span>(<span class="type">List</span>())</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">for</span> &#123; </span><br><span class="line">                queens &lt;- placeQueens(k<span class="number">-1</span>);</span><br><span class="line">                column &lt;- <span class="type">List</span>.range(<span class="number">0</span>, n);</span><br><span class="line">                <span class="keyword">if</span> isSafe(column, queens, <span class="number">1</span>) </span><br><span class="line">            &#125; <span class="keyword">yield</span> column :: queens</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        placeQueens(n)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">        <span class="keyword">val</span> queenList = queens(<span class="number">8</span>);</span><br><span class="line">        println(<span class="string">&quot;queenCount: &quot;</span> + queenList.length)  <span class="comment">// 92</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>for-yield 表达式中 for 中可以写多条语句，代表多重循环，第 5 行的 for 代表 for 循环，<code>&lt;-</code> 表示取 List 中的元素。</p>
<hr />
<p>　　剩下的几章就没啥特别要写的，重点就两个特性，一个是 Stream ，一个 Lazy，Stream 和 List 有点类似，主要区别在于 Stream 是即时返回的，算一个返回一个，而 List 一般是全部计算完再返回一个 List；Lazy 一般用作常量的修饰符，主要作用是只用该常量被用到时才赋值，否则一直为空，有点类似常见的先判空再取值的封装。</p>
<h2 id="后记">后记</h2>
<p>　　曾看到过通过刷题去学习新语言的方式，一直都以为很粗暴，但这次照着「Scala By Example」敲下来，感觉还挺有效的，同时也巩固了一下基本的算法知识，后续再把 twitter 的 「Effective Scala」再看一下应该就差不多了。</p>
]]></content>
      <categories>
        <category>Study</category>
      </categories>
      <tags>
        <tag>language</tag>
      </tags>
  </entry>
  <entry>
    <title>VNSWRR 算法浅解</title>
    <url>/posts/619020f7.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　最近偶然在公司内网看到一篇文章「负载均衡算法vnswrr改进——从指定位置生成调度序列」。正好 Shaun 一直觉得调度类算法很有意思，就认真看了下，顺便写下自己的一些理解。</p>
<span id="more"></span>
<h2 id="预备篇">预备篇</h2>
<p>　　通俗来讲负载均衡解决的是「在避免机器过载的前提下，多个请求如何分发到多台机器上」的问题，本质上是一个分布式任务调度的问题，在机器性能相同的情况下，最简单的策略就是轮询，多个机器依次轮流处理请求。Nginx 官方的 SWRR 算法解决的是「在机器性能不同的情况下，如何使请求分布更均匀，更平滑，避免短时间大量请求造成局部热点」的问题。</p>
<h2 id="swrr篇">SWRR篇</h2>
<p>　　在 SWRR 算法中，有两个权重，一个是初始实际权重（effective weight， ew），一个是算法迭代过程中的当前权重（current weight，cw），在负载均衡过程中，每次请求分发都选择当前权重最大的机器，同时更新每台机器的当前权重，当前权重更新策略如下：</p>
<ol start="0" type="1">
<li><p>若设定 n 台机器各自的初始权重为 <span class="math inline">\((ew_1,ew_2,...,ew_n)\)</span>，同时 <span class="math inline">\(ew_1 \le ew_2 \le ... \le ew_n\)</span> ，且 <span class="math inline">\(W_{total}=\sum_{i=1}^n ew_i\)</span> ；</p></li>
<li><p>第一个请求来时，n 台机器各自的当前权重 <span class="math inline">\(cw_i=ew_i,　1 \le i \le n\)</span> ，由于此时 <span class="math inline">\(cw_{max}=\max(cw_i)=cw_n\)</span> ，则请求分发给第 n 台机器处理，同时更新机器各自的当前权重 <span class="math inline">\(cw_1=cw_1+ew_1, cw_2=cw_2+ew_2,...,cw_{n-1}=cw_{n-1}+ew_{n-1},cw_n=cw_n+ew_n-W_{total}\)</span>，记为 <span class="math inline">\((2*ew_1,2*ew_2,...,2*ew_{n-1},2*ew_n-W_{total})\)</span> ；</p></li>
<li><p>第二个请求来时，此时 n 台机器的各自权重为 <span class="math inline">\((2*ew_1,2*ew_2,...,2*ew_{n-1},2*ew_n-W_{total})\)</span> ，选取权重值对应的机器进行处理，假设为第 n-1 台，则更新后权重为 <span class="math inline">\((3*ew_1,3*ew_2,...,3*ew_{n-1}-W_{total},3*ew_n-W_{total})\)</span> ；</p></li>
<li><p>第 <span class="math inline">\(W_{total}\)</span> 个请求来时，此时 n 台机器的各自权重应该为 <span class="math display">\[
(W_{total}*ew_1-m_1*W_{total},W_{total}*ew_2-m_2*W_{total},...,W_{total}*ew_{n-1}-m_{n-1}*W_{total},W_{total}*ew_n-m_n*W_{total}) \\
\text{s.t.} \quad \sum_{i=1}^n m_i=W_{total}-1 \\
\quad 0 &lt;= m_i &lt;= ew_i
\]</span> 由于每次调度都是权重最大值减权重和，重新分配权重后权重和无变化，所以理论上此时除第 k 台机器外，每台机器的权重都为 0，第 k 台机器的权重为 <span class="math inline">\(W_{total}\)</span> ，所以这次调度处理之后，每台机器的权重又会重新回到初始权重。</p></li>
</ol>
<h2 id="vnswrr-篇">VNSWRR 篇</h2>
<p>　　VNSWRR 算法是阿里针对 Nginx 官方的 SWRR 算法实际运行中对于部分场景下（瞬时流量大，权重更新等）均衡效果不太理想的改进算法，其最大的改进点在于预生成调度序列，以空间换时间减少调度时间，同时在权重更新后随机选取调度序列的起点，使初次请求就调度在不同的机器上，减少高权重机器的局部热点问题。具体流程如下：</p>
<ol type="1">
<li>首先使用 SWRR 算法生成前 n 个调度序列；</li>
<li>再随机选取一个位置作为调度起点，后续的请求依次从调度序列中选取；</li>
<li>若调度序列用完，则继续用 SWRR 算法生成后 n 个调度序列；</li>
<li>如此循环，直到调度序列的长度为 <span class="math inline">\(W_{total}\)</span>，即一个周期内的全部调度序列，用完后，从头开始调度即可；</li>
<li>若有权重更新，则从 1 开始重新生成调度序列；</li>
</ol>
<h2 id="正文">正文</h2>
<p>　　从上面的逻辑中，可看出 SWRR 算法调度序列是以 <span class="math inline">\(W_{total}\)</span> 为周期的一个循环序列，只需要知道一个周期内的调度序列，就可以推算出后续的调度机器（除非权重有变更或者有机器增删）。计算一个周期内的调度序列也比较简单，取当前调度权重中最大值对应机器，同时更新每台机器的当前权重，作为下次调度的权重，简而言之，就是从上次调度结果推出下次调度结果，是一个递推式。那有没有办法不从上次结果推下次结果，直接计算当前的调度结果，简化 VNSWRR 的第一步每次都从头开始预生成前 n 个调度序列，直接从任意位置开始生成调度序列，内网中这篇文章就给出了一个看似“可行的”解决方案，直接计算第 q 个请求的调度结果，具体方案如下：</p>
<p>在 SWRR 算法中，第 q 个请求时，全部机器的当前权重序列应该为 <span class="math display">\[
(q*ew_1-m_1*W_{total},q*ew_2-m_2*W_{total},...,q*ew_{n-1}-m_{n-1}*W_{total},q*ew_n-m_n*W_{total}) \\
\text{s.t.} \quad \sum_{i=1}^n m_i=q-1 \\
\quad 0 &lt;= m_i &lt;= ew_i
\]</span> 即权重序列中共减去了 <span class="math inline">\(q-1\)</span> 个 <span class="math inline">\(W_{total}\)</span> ，平均上 <span class="math inline">\(m_i=ew_i/W_{total}*(q-1)\)</span>，区分 <span class="math inline">\(m_i\)</span> 的整数部分 <span class="math inline">\(mz_i\)</span> 和小数部分 <span class="math inline">\(mx_i\)</span>，<span class="math inline">\(\sum_{i=1}^n m z_i\)</span> 代表减去的 <span class="math inline">\(W_{total}\)</span> 个数，计算差值 <span class="math inline">\(d=q-1-\sum_{i=1}^n mz_i\)</span>，即还剩 d 个 <span class="math inline">\(W_{total}\)</span> 待减，对小数部分 <span class="math inline">\(mx_i\)</span> 从大到小排序，取前 d 个对应的机器再减 <span class="math inline">\(W_{total}\)</span>，即可得到第 q 个请求时的当前权重序列，取最大权重对应的机器即为调度结果，后续调度结果可通过递推式得出。</p>
<hr />
<p>　　初次看到这个方案的时候，就想动手实现一下，因为思路也比较清晰简单，实现完之后，简单测试一下，也确实没啥问题，后面再深度测试了一下，就发现该方案确实有点小小的问题，在大部分情况下，该方案确实能得到很正确的结果，但还是存在一些错误结果，就因为有少量错误结果，所以<strong>该方案不要在生产环境下应用</strong>。该方案错在了将 <span class="math inline">\(q*ew_i\)</span> 看成最后一个整体进行处理排序，忽略了分步执行结果，导致小部分场景下的错误排序结果，进而生成错误调度权重，调度错误。</p>
<p>　　现在再回到初始问题「如何生成 SWRR 算法中指定轮次的调度结果？」，抽象来看，该问题是个数学问题「如何从数列的递推式计算数列求通项公式」， 但 SWRR 的递推式相对复杂，中间还有取最大值这个不稳定变量，实际很难得到通项公式，直接计算指定调度解果，Shaun 问了 ChatGPT，也自己想了很久，搜了很久，但都没有答案，内网中的这个方案算是最接近的一个答案。</p>
<h2 id="后记">后记</h2>
<p>　　在内网中看到这个方案的思路很有意思，将整数和小数部分拆开，再单独对小数部分排序，所以就自己测试了一下，顺便学习了下负载均衡 SWRR 算法，虽然问题依旧还在，但总归是有点收获。</p>
<h2 id="附录">附录</h2>
<p>　　附代码：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PYTHON"><div class="code-copy"></div><figure class="highlight hljs python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ouput_schedule</span>(<span class="params">rs_arr, schedule_num</span>):</span></span><br><span class="line">    all_rs_weight_str = <span class="string">&quot;;\t&quot;</span>.join([<span class="string">&quot;rs:%s,cw:%s&quot;</span> % (rs[<span class="string">&quot;rs_name&quot;</span>], rs[<span class="string">&quot;cw&quot;</span>]) <span class="keyword">for</span> rs <span class="keyword">in</span> rs_arr])</span><br><span class="line">    schedule_rs = <span class="built_in">max</span>(rs_arr, key=<span class="keyword">lambda</span> x:x[<span class="string">&quot;cw&quot;</span>])</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;%s:\t%s\t===&gt;\trs:%s,cw:%s&quot;</span> % (schedule_num, all_rs_weight_str, schedule_rs[<span class="string">&quot;rs_name&quot;</span>], schedule_rs[<span class="string">&quot;cw&quot;</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> schedule_rs</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">swrr</span>(<span class="params">rs_arr, weight_total</span>):</span></span><br><span class="line">    schedule_rs = rs_arr[<span class="number">0</span>]</span><br><span class="line">    max_weight = schedule_rs[<span class="string">&quot;cw&quot;</span>]</span><br><span class="line">    <span class="keyword">for</span> rs <span class="keyword">in</span> rs_arr:</span><br><span class="line">        <span class="keyword">if</span> rs[<span class="string">&quot;cw&quot;</span>] &gt; max_weight:</span><br><span class="line">            schedule_rs = rs</span><br><span class="line">            max_weight = rs[<span class="string">&quot;cw&quot;</span>]</span><br><span class="line"></span><br><span class="line">        rs[<span class="string">&quot;cw&quot;</span>] += rs[<span class="string">&quot;ew&quot;</span>]</span><br><span class="line">    </span><br><span class="line">    schedule_rs[<span class="string">&quot;cw&quot;</span>] -= weight_total</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> schedule_rs</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">swrr_test</span>():</span></span><br><span class="line">    real_servers = [&#123;<span class="string">&quot;rs_name&quot;</span>: <span class="built_in">chr</span>(i+<span class="number">64</span>), <span class="string">&quot;ew&quot;</span>: i, <span class="string">&quot;cw&quot;</span>: i&#125; <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">6</span>)]</span><br><span class="line">    weight_total = <span class="built_in">sum</span>([rs[<span class="string">&quot;ew&quot;</span>] <span class="keyword">for</span> rs <span class="keyword">in</span> real_servers])</span><br><span class="line">    schedule_count = weight_total</span><br><span class="line">    swrr_seq = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, schedule_count+<span class="number">1</span>):</span><br><span class="line">        ouput_schedule(real_servers, i)</span><br><span class="line">        schedule_rs = swrr(real_servers, weight_total)</span><br><span class="line"></span><br><span class="line">        swrr_seq.append(schedule_rs[<span class="string">&quot;rs_name&quot;</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(swrr_seq)</span><br><span class="line"></span><br><span class="line"><span class="comment"># swrr_test()</span></span><br><span class="line"><span class="comment"># print(&quot;---------&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">swrr_n</span>(<span class="params">rs_arr, weight_total, schedule_num</span>):</span></span><br><span class="line">    ms = [(rs[<span class="string">&quot;ew&quot;</span>] / <span class="built_in">float</span>(weight_total)) * (schedule_num-<span class="number">1</span>) <span class="keyword">for</span> rs <span class="keyword">in</span> rs_arr]</span><br><span class="line">    mzs = [<span class="built_in">int</span>(m) <span class="keyword">for</span> m <span class="keyword">in</span> ms]</span><br><span class="line">    mxs = [(i, m-<span class="built_in">int</span>(m)) <span class="keyword">for</span> i, m <span class="keyword">in</span> <span class="built_in">enumerate</span>(ms)]</span><br><span class="line">    mxs = <span class="built_in">sorted</span>(mxs, key=<span class="keyword">lambda</span> x:x[<span class="number">1</span>], reverse=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">for</span> i, rs <span class="keyword">in</span> <span class="built_in">enumerate</span>(rs_arr):</span><br><span class="line">        rs[<span class="string">&quot;cw&quot;</span>] = schedule_num * rs[<span class="string">&quot;ew&quot;</span>]</span><br><span class="line">        rs[<span class="string">&quot;cw&quot;</span>] -= mzs[i] * weight_total</span><br><span class="line"></span><br><span class="line">    d = (schedule_num-<span class="number">1</span>) - <span class="built_in">sum</span>(mzs)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(d):</span><br><span class="line">        rs_arr[mxs[i][<span class="number">0</span>]][<span class="string">&quot;cw&quot;</span>] -= weight_total</span><br><span class="line"></span><br><span class="line">    schedule_rs = ouput_schedule(rs_arr, schedule_num)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> schedule_rs</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">swrr_n_test</span>():</span></span><br><span class="line">    real_servers = [&#123;<span class="string">&quot;rs_name&quot;</span>: <span class="built_in">chr</span>(i+<span class="number">64</span>), <span class="string">&quot;ew&quot;</span>: i, <span class="string">&quot;cw&quot;</span>: i&#125; <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">6</span>)]</span><br><span class="line">    weight_total = <span class="built_in">sum</span>([rs[<span class="string">&quot;ew&quot;</span>] <span class="keyword">for</span> rs <span class="keyword">in</span> real_servers])</span><br><span class="line"></span><br><span class="line">    schedule_rs_seq = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, weight_total+<span class="number">1</span>):</span><br><span class="line">        schedule_rs = swrr_n(real_servers, weight_total, i)</span><br><span class="line"></span><br><span class="line">        schedule_rs_seq.append(schedule_rs[<span class="string">&quot;rs_name&quot;</span>])</span><br><span class="line">    <span class="comment"># swrr_n(real_servers, weight_total, 9) # err schedule rs</span></span><br><span class="line">    <span class="built_in">print</span>(schedule_rs_seq)</span><br><span class="line"></span><br><span class="line"><span class="comment"># swrr_n_test()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">vnswrr_preschedule</span>(<span class="params">rs_arr, weight_total, N, schedule_rs_seq</span>):</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, N+<span class="number">1</span>):</span><br><span class="line">        schedule_rs = swrr(rs_arr, weight_total)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(schedule_rs_seq) &gt;= weight_total:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        schedule_rs_seq.append(schedule_rs)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">vnswrr</span>(<span class="params">rs_arr, rs_count, weight_total, prev_schedule_idx, schedule_rs_seq</span>):</span></span><br><span class="line">    N = <span class="built_in">min</span>(rs_count, weight_total)</span><br><span class="line">    </span><br><span class="line">    schedule_idx = prev_schedule_idx + <span class="number">1</span></span><br><span class="line">    schedule_idx %= weight_total</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> schedule_idx &gt;= <span class="built_in">len</span>(schedule_rs_seq)-<span class="number">1</span>:</span><br><span class="line">        vnswrr_preschedule(rs_arr, weight_total, N, schedule_rs_seq)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> schedule_idx</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">vnswrr_test</span>():</span></span><br><span class="line">    all_schedule_rs_seq = []</span><br><span class="line">    real_servers = [&#123;<span class="string">&quot;rs_name&quot;</span>: <span class="built_in">chr</span>(i+<span class="number">64</span>), <span class="string">&quot;ew&quot;</span>: i, <span class="string">&quot;cw&quot;</span>: i&#125; <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">6</span>)]</span><br><span class="line">    rs_count = <span class="built_in">len</span>(real_servers)</span><br><span class="line">    weight_total = <span class="built_in">sum</span>([rs[<span class="string">&quot;ew&quot;</span>] <span class="keyword">for</span> rs <span class="keyword">in</span> real_servers])</span><br><span class="line"></span><br><span class="line">    N = <span class="built_in">min</span>(rs_count, weight_total)</span><br><span class="line">    schedule_rs_seq = []</span><br><span class="line">    <span class="comment"># 预生成调度序列</span></span><br><span class="line">    vnswrr_preschedule(real_servers, weight_total, N, schedule_rs_seq)</span><br><span class="line">    <span class="comment"># 随机取调度结果</span></span><br><span class="line">    prev_schedule_idx = random.randint(<span class="number">0</span>, N-<span class="number">1</span>)-<span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">2</span>*weight_total+<span class="number">1</span>):</span><br><span class="line">        schedule_idx = vnswrr(real_servers, rs_count, weight_total, prev_schedule_idx, schedule_rs_seq)</span><br><span class="line">        all_schedule_rs_seq.append(schedule_rs_seq[schedule_idx][<span class="string">&quot;rs_name&quot;</span>])</span><br><span class="line">        prev_schedule_idx = schedule_idx</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>([rs[<span class="string">&quot;rs_name&quot;</span>] <span class="keyword">for</span> rs <span class="keyword">in</span> schedule_rs_seq])</span><br><span class="line">    <span class="built_in">print</span>(all_schedule_rs_seq)</span><br><span class="line"></span><br><span class="line">vnswrr_test()</span><br></pre></td></tr></table></figure></div>
<h2 id="参考资料">参考资料</h2>
<p>1、<a href="https://developer.aliyun.com/article/708538">QPS 提升60%，揭秘阿里巴巴轻量级开源 Web 服务器 Tengine 负载均衡算法</a></p>
<p>2、<a href="https://claude-ray.com/2019/08/10/nginx-swrr/">Nginx SWRR 算法解读</a></p>
]]></content>
      <categories>
        <category>Mathematics</category>
      </categories>
      <tags>
        <tag>algorithm</tag>
      </tags>
  </entry>
  <entry>
    <title>Win10以树形结构显示文件目录结构</title>
    <url>/posts/c3f26b1.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　<del>本文其实可以算是标题党，Windows本身并不能以树形结构显示文件目录结构，一般需要借助第三方工具</del>（后面去网上搜索了一下，发现 Windows 居然也有一个 tree 命令 o(╯□╰)o），Windows 虽然能用命令行显示树形结构文件目录，但不像 Linux 那样可以输入一些参数控制其输出。Win10 有个特殊的功能，就是可以使用 Ubuntu 的 bash，只需要开启这个有趣的功能，就可以将 Win10 当 Ubuntu 使用，从而像 Linux 那样只输入相关命令即可显示树形结构文件目录。</p>
<p><font color=#FA8072>*注：值得注意的是 Win10 中的 bash 目前不支持中文输入，只能切换到英文输入才能正常输入。</font></p>
<span id="more"></span>
<h2 id="准备篇">准备篇</h2>
<p>首先需要在 Win10 下开启 bash 功能。具体开启方法为：</p>
<ol type="1">
<li>打开 <strong>Win图标</strong> ==》 <strong>设置</strong> ==》 <strong>更新和安全</strong> ==》 <strong>针对开发人员</strong>（左侧），选中<strong>开发人员模式</strong>，</li>
<li>打开 <strong>Win图标</strong> ==》 <strong>设置</strong> ==》 <strong>应用</strong> ==》 <strong>应用和功能</strong>（左侧） ==》 <strong>程序和功能</strong>（最下面的相关设置中） ==》 <strong>启用或关闭Windows功能</strong>（左侧），选中<strong>适用于Linux的Windows子系统(Beta)</strong>后点击确定。</li>
<li>重启计算机。打开 bash，打开 bash 的方法很多，这里列出三种：1、直接在微软小娜中输入关键字"<strong>bash</strong>"搜索 Bash on Ubuntu on Windows；2、<code>Win键+R</code>，输入 bash，点击确定即可打开 bash；3、<code>Win键+R</code>，输入 cmd，在 cmd 中输入 bash，回车即可打开 bash。打开 bash 后将会提示你是否下载安装 Ubuntu on Windows，输入 y 继续，稍等片刻即可完成下载安装。</li>
</ol>
<h2 id="设置篇">设置篇</h2>
<p>　　安装完成后系统将会提示你设置用户名和密码。（如果这一步设置成功可以直接跳过设置篇直接看使用篇）。不知道怎的，Shaun 这一步没有完成，每次系统都是直接以 root 用户登录，而且没有密码，为了安全考虑，也幸好登录时是 root 用户，可以自由对系统修改。所以 Shaun 需要对 root 密码进行修改，并创建新的用户。具体过程需执行以下命令：</p>
<p>root 用户下，修改用户密码：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line">passwd 用户名 (修改密码)</span><br></pre></td></tr></table></figure></div>
<p>　　由于 Shaun 需要修改 root 密码，所以该用户名即为 root，执行之后需要输入新密码（在 *nix 哲学中，密码是不会显示在输入屏幕中的，所以如果在输入密码时发现屏幕没有任何变化是没关系的，只管输入即可 ↖(^ω^)↗），两次输入完成后会显示密码更新成功。</p>
<p>接下来需要创建新的普通用户，在 root 用户下执行：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line">adduser xxx <span class="comment"># 这样的命令会在home目录下添加一个帐号</span></span><br></pre></td></tr></table></figure></div>
<p>或者</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line">useradd xxx <span class="comment">#仅仅是添加用户，不会在home目录添加帐号</span></span><br></pre></td></tr></table></figure></div>
<p>　　推荐使用前者，这样可以很明确已经成功创建新用户，而且如果用户需要存放一些文件也更安全和方便。</p>
<p>　　在 *nix 中，绝对不推荐直接使用root用户对系统执行各种命令，毕竟其权限太大，一旦误操作将造成无法挽回的后果。有些命令普通用户可能没有权限执行，这时需要提高其权限，普通用户临时获取 root 权限的方法为：在需要执行的命令前添加<code>sudo</code>，像上文中如果普通用户需要创建新用户 xxx 则需要执行<code>sudo adduser xxx</code>，执行以上命令后同样需要输入新用户的密码。</p>
<h2 id="使用篇">使用篇</h2>
<p>　　先切换至普通用户，执行<code>su xxx</code>切换用户，即可发现 shell 提示符由<code>#</code>变为<code>$</code>，前面的用户名由<code>root</code>变为<code>xxx</code>；执行<code>cd ~</code>切换至用户目录。由于 Ubuntu 系统中本身没有 tree 这个命令，需要执行以下命令安装 tree 命令工具：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line">sudo apt install tree</span><br></pre></td></tr></table></figure></div>
<p>　　直接输入<code>tree</code>命令，系统将会自动以树形结构列出当前目录中所有文件及文件夹；执行<code>tree -L N</code> 命令，以树形结构查看当前 N 级的目录和文件，eg：以树形结构查看当前目录二级文件结构，则执行<code>tree -L 2</code>。若想将输出的2级文件结构保存至上一层文件的tree.txt文件中，可执行<code>tree -L 2 &gt; ../tree.txt</code>，进入上一层目录<code>cd ..</code>，打开 tree.txt 即可发现该目录的文件结构。</p>
<h2 id="后记">后记</h2>
<p>　　遇事还是需要多查证一下啊，想当然果然是会出问题的，文章开头差点就犯错误了 ~\(≧▽≦)/~。本文其实是在写 <a href="https://cniter.github.io/posts/7df528b4.html">Win10＋VS2013＋CMake-gui编译和配置OpenCV-3.2.0</a> 时，为了方便显示输出文件结构而查找的相关资料。</p>
<h2 id="参考资料">参考资料</h2>
<p>[1]<a href="http://jingyan.baidu.com/article/acf728fd19c7eff8e510a3eb.html">linux tree命令以树形结构显示文件目录结构</a>（<a href="http://jingyan.baidu.com/tag?tagName=linux" class="uri">http://jingyan.baidu.com/tag?tagName=linux</a>）</p>
<p>[2] <a href="http://jingyan.baidu.com/article/b24f6c822acbbb86bee5da75.html">win tree命令 tree导出目录 tree显示树形结构</a>（<a href="http://jingyan.baidu.com/tag?tagName=%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F" class="uri">http://jingyan.baidu.com/tag?tagName=%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F</a>）</p>
<p>[3] <a href="http://jingyan.baidu.com/article/39810a23957df3b636fda6cb.html">win10下linux系统的安装（开启）和使用</a></p>
<p>[4] <a href="http://www.linuxidc.com/Linux/2012-06/62985.htm">Ubuntu建立和删除用户</a></p>
<p>[5] <a href="http://www.jb51.net/article/46429.htm">linux修改root密码和linux忘记root密码后找回密码的方法</a></p>
]]></content>
      <categories>
        <category>Study</category>
      </categories>
      <tags>
        <tag>unix-like</tag>
      </tags>
  </entry>
  <entry>
    <title>TensorFlow Object Detection API使用小结</title>
    <url>/posts/82d3b275.html</url>
    <content><![CDATA[<p><font color=#FA8072>本文所用的 Python 版本为 python-3.6.2，TensorFlow 版本为tensorflow-1.4.0，编程语言为 python3，系统环境为 Windows 10。</font></p>
<h2 id="前言">前言</h2>
<p>　　很久没写过东西了，主要原因是最近研究生课程开始陆续结课，Shaun 也要忙于应付各种结课时的考试、论文、project 等一堆麻烦事。这不深度学习结课时需要做个 project，Shaun 也顺便将做这个 project 的过程记录下来。</p>
<span id="more"></span>
<h2 id="准备篇">准备篇</h2>
<p>　　该 project 主要利用 TensorFlow 中的 Object Detection API 进行训练和检测。在开始使用该 API 之前需要安装配置 Python 环境。</p>
<p>　　既然是 Python 首先需要 <a href="https://www.python.org/downloads/">下载安装Python</a>，安装完之后，为了顺利使用 pip 需要配置环境变量，在 Windows 系统环境变量中 Path 末尾添加：</p>
<table>
<colgroup>
<col style="width: 9%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">变量名</th>
<th style="text-align: center;">变量值</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Path</td>
<td style="text-align: center;">;C:\Users\admin\AppData\Local\Programs\Python\Python36\; C:\Users\admin\AppData\Local\Programs\Python\Python36\Scripts\</td>
</tr>
</tbody>
</table>
<p>其中 <code>C:\Users\admin\AppData\Local\Programs\Python\Python36</code> 为 python-3.6.2 默认安装目录。</p>
<p>　　然后为了方便使用命令行工具，<a href="https://www.git-scm.com/download/">下载安装git</a>，安装方式一路默认即可。</p>
<p>　　接下来利用 pip 安装 TensorFlow，鼠标右键桌面空白处，点击“<strong>Git Bash Here</strong>”，打开 bash 命令行，输入 <code>pip install tensorflow</code>，其中一些依赖关系可能需要手动解决，手动解决的办法就是用 pip install 相关依赖库，这是 CPU 版的 TensorFlow，若要使用 GPU，则需要安装 GPU 版的 TensorFlow，安装命令为：<code>pip install tensorflow-gpu</code>，以同样方式解决依赖关系。由于 Shaun 电脑没 N 卡，所以没安装 GPU 版的 TensorFlow，所以如果想使用 GPU 版的 TensorFlow 请另行尝试。</p>
<p>　　然后安装 TensorFlow Object Detection API 依赖库，在命令行中输入：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line">pip install pillow</span><br><span class="line">pip install lxml</span><br><span class="line">pip install jupyter</span><br><span class="line">pip install matplotlib </span><br></pre></td></tr></table></figure></div>
<p>　　因为 tensorflow 并没有默认自带 Object Detection API，所以该 API 需要自行下载，下载地址为：https://github.com/tensorflow/models ，下载之后解压，Shaun 解压目录为：<code>D:\ProgramFiles\PythonLibs\tensorflow</code>，解压完之后需要配置环境目录，在系统环境目录中添加：</p>
<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 80%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">变量名</th>
<th style="text-align: center;">变量值</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">PYTHONPATH</td>
<td style="text-align: center;">D:\ProgramFiles\PythonLibs\tensorflow\models; D:\ProgramFiles\PythonLibs\tensorflow\models\research; D:\ProgramFiles\PythonLibs\tensorflow\models\research\slim;</td>
</tr>
</tbody>
</table>
<p>　　下载配置 Object Detection API 完之后需要安装 Protoc，进入 <a href="https://github.com/google/protobuf/releases">Protoc下载页</a>，下载 <a href="https://github.com/google/protobuf/releases/download/v3.4.0/protoc-3.4.0-win32.zip"><strong>protoc-3.4.0-win32.zip</strong></a>，解压之后将 <strong>bin</strong> 文件夹内的 <strong>protoc.exe</strong> 拷贝到 <code>C:\windows\system32</code> 目录下（用于将 protoc.exe 所在的目录配置到环境变量当中）,当然也可以在系统环境变量 Path 中添加该 <strong>bin</strong> 文件夹路径。</p>
<p>　　最后在命令行中切换目录至：<code>D:\ProgramFiles\PythonLibs\tensorflow\models\research</code> 文件夹，即 object_detection 文件夹所在目录，在命令行中输入：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line">protoc object_detection/protos/*.proto --python_out=.</span><br></pre></td></tr></table></figure></div>
<p>编译 <code>object_detection/protos</code> 文件夹下的 proto 文件，生成对应的 python 文件。</p>
<p>　　至此，Windows 下 TensorFlow中 的 Object Detection API 的使用配置全部完成，至于 Ubuntu 下的配置可参考其<a href="https://github.com/tensorflow/models/blob/master/research/object_detection/g3doc/installation.md">官方文档</a>。</p>
<p>　　至于如何验证，可以在命令行中切换目录至 <code>object_detection</code>，输入：<code>jupyter notebook</code>，稍等一会，浏览器将自动打开 <code>http://localhost:8888/tree</code> jupyter 界面，点击 <code>object_detection_tutorial.ipynb</code> 文件，进入打开的新标签，点击“<strong>Cell</strong>”中的“<strong>Run All</strong>”，耐心等待几 ~ 十几分钟（因为它需要下载相应的模型），将会在浏览器下方显示检测结果。</p>
<p>　　截止本文完成前，该API公开的有以下几个模型：</p>
<table>
<thead>
<tr class="header">
<th>Model name</th>
<th>Speed (ms)</th>
<th>COCO mAP<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></th>
<th>Outputs</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><a href="http://download.tensorflow.org/models/object_detection/ssd_mobilenet_v1_coco_2017_11_08.tar.gz">ssd_mobilenet_v1_coco</a></td>
<td>30</td>
<td>21</td>
<td>Boxes</td>
</tr>
<tr class="even">
<td><a href="http://download.tensorflow.org/models/object_detection/ssd_inception_v2_coco_2017_11_08.tar.gz">ssd_inception_v2_coco</a></td>
<td>42</td>
<td>24</td>
<td>Boxes</td>
</tr>
<tr class="odd">
<td><a href="http://download.tensorflow.org/models/object_detection/faster_rcnn_inception_v2_coco_2017_11_08.tar.gz">faster_rcnn_inception_v2_coco</a></td>
<td>58</td>
<td>28</td>
<td>Boxes</td>
</tr>
<tr class="even">
<td><a href="http://download.tensorflow.org/models/object_detection/faster_rcnn_resnet50_coco_2017_11_08.tar.gz">faster_rcnn_resnet50_coco</a></td>
<td>89</td>
<td>30</td>
<td>Boxes</td>
</tr>
<tr class="odd">
<td><a href="http://download.tensorflow.org/models/object_detection/faster_rcnn_resnet50_lowproposals_coco_2017_11_08.tar.gz">faster_rcnn_resnet50_lowproposals_coco</a></td>
<td>64</td>
<td></td>
<td>Boxes</td>
</tr>
<tr class="even">
<td><a href="http://download.tensorflow.org/models/object_detection/rfcn_resnet101_coco_2017_11_08.tar.gz">rfcn_resnet101_coco</a></td>
<td>92</td>
<td>30</td>
<td>Boxes</td>
</tr>
<tr class="odd">
<td><a href="http://download.tensorflow.org/models/object_detection/faster_rcnn_resnet101_coco_2017_11_08.tar.gz">faster_rcnn_resnet101_coco</a></td>
<td>106</td>
<td>32</td>
<td>Boxes</td>
</tr>
<tr class="even">
<td><a href="http://download.tensorflow.org/models/object_detection/faster_rcnn_resnet101_lowproposals_coco_2017_11_08.tar.gz">faster_rcnn_resnet101_lowproposals_coco</a></td>
<td>82</td>
<td></td>
<td>Boxes</td>
</tr>
<tr class="odd">
<td><a href="http://download.tensorflow.org/models/object_detection/faster_rcnn_inception_resnet_v2_atrous_coco_2017_11_08.tar.gz">faster_rcnn_inception_resnet_v2_atrous_coco</a></td>
<td>620</td>
<td>37</td>
<td>Boxes</td>
</tr>
<tr class="even">
<td><a href="http://download.tensorflow.org/models/object_detection/faster_rcnn_inception_resnet_v2_atrous_lowproposals_coco_2017_11_08.tar.gz">faster_rcnn_inception_resnet_v2_atrous_lowproposals_coco</a></td>
<td>241</td>
<td></td>
<td>Boxes</td>
</tr>
<tr class="odd">
<td><a href="http://download.tensorflow.org/models/object_detection/faster_rcnn_nas_lowproposals_coco_2017_11_08.tar.gz">faster_rcnn_nas</a></td>
<td>1833</td>
<td>43</td>
<td>Boxes</td>
</tr>
<tr class="even">
<td><a href="http://download.tensorflow.org/models/object_detection/faster_rcnn_nas_lowproposals_coco_2017_11_08.tar.gz">faster_rcnn_nas_lowproposals_coco</a></td>
<td>540</td>
<td></td>
<td>Boxes</td>
</tr>
</tbody>
</table>
<p>　　根据上述模型可推知，利用该 API 可能只能训练 Faster-RCNN、R-FCN 和 SSD 三种算法的模型。</p>
<p>接下来介绍如何使用该 API 来训练自己的模型进行物体检测。</p>
<h2 id="实践篇">实践篇</h2>
<h3 id="数据准备篇">数据准备篇</h3>
<p>　　既然要训练自己的模型，当然要准备相应的数据，而 TensorFlow 有其独特的输入数据格式 <a href="https://www.tensorflow.org/api_guides/python/python_io#tfrecords_format_details">TFRecord</a>，所以通常还要将自己的数据转换成 TFRecord 格式以输入 TensorFlow 中进行训练。以 <a href="https://github.com/datitran">datitran</a>/<a href="https://github.com/datitran/raccoon_dataset"><strong>raccoon_dataset</strong></a> 数据集为例，该作者在 Google image 上收集了 200 张 Raccoon 图片，用 <a href="https://github.com/tzutalin/labelImg">LabelImg</a> 对这些图片进行标记，并将标记以 PASCAL VOC 格式保存为 xml 文件。作者在文中也提到了另一个图片标记工具 <a href="https://github.com/christopher5106/FastAnnotationTool">FIAT (Fast Image Data Annotation Tool)</a> 。保存为 PASCAL VOC 格式的 xml 文件之后，可以使用 object_detection 文件夹中的 <a href="https://github.com/tensorflow/models/blob/master/research/object_detection/create_pascal_tf_record.py">create_pascal_tf_record.py</a> 文件将数据转化为 TFRecord 格式，用法为：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PYTHON"><div class="code-copy"></div><figure class="highlight hljs python"><table><tr><td class="code"><pre><span class="line">./create_pascal_tf_record --data_dir=/home/user/VOCdevkit \</span><br><span class="line">        --year=VOC2012 \</span><br><span class="line">        --output_path=/home/user/pascal.record</span><br></pre></td></tr></table></figure></div>
<p>当然也可以使用 datitran 作者提供的 <a href="https://github.com/datitran/raccoon_dataset/blob/master/xml_to_csv.py">xml_to_csv.py</a> 文件将 xml 文件先转化为 csv 文件，再利用 <a href="https://github.com/datitran/raccoon_dataset/blob/master/generate_tfrecord.py">generate_tfrecord.py</a> 文件将 csv 文件转化成 TFRecord 格式文件。</p>
<p>　　注意，使用 xml_to_csv.py 和 generate_tfrecord.py 其文件结构应该是这样的：</p>
<blockquote>
<p>.<br />
├── annotations<br />
├── generate_tfrecord.py<br />
├── images<br />
└── xml_to_csv.py</p>
<p>2 directories, 2 files</p>
</blockquote>
<p>其中 images 文件夹存的是 jpg 图片，annotations 文件夹存的是 xml 标签文件。generate_tfrecord.py 文件中的：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PYTHON"><div class="code-copy"></div><figure class="highlight hljs python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">class_text_to_int</span>(<span class="params">row_label</span>):</span></span><br><span class="line">    <span class="keyword">if</span> row_label == <span class="string">&#x27;raccoon&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line"><span class="literal">None</span></span><br></pre></td></tr></table></figure></div>
<p>其中的 <code>raccoon</code> 注意要改成自己的类别标签。如此，数据的问题就解决了。</p>
<h3 id="训练篇">训练篇</h3>
<p>　　然后就是正式开始训练了，以 Faster-RCNN 算法为例。首先准备相应的数据，Shaun 准备的数据文件结构如下：</p>
<blockquote>
<p>TensorFlowObjectDetectionAPITest<br />
├── data<br />
│ 　├── model.ckpt.data-00000-of-00001<br />
│ 　├── model.ckpt.index<br />
│ 　├── model.ckpt.meta<br />
│ 　├── object_label_map.pbtxt<br />
│ 　├── test.record<br />
│ 　└── train.record<br />
├── eval<br />
├── eval.py<br />
├── export_inference_graph.py<br />
├── faster_rcnn_resnet101_coco.config<br />
├── model<br />
├── train<br />
└── train.py</p>
<p>4 directories, 10 files</p>
</blockquote>
<p>其中，<strong>TensorFlowObjectDetectionAPITest</strong> 为项目文件夹，该 <em>project</em> 在此文件夹下运行；</p>
<p><strong>data</strong> 文件夹中三个 <strong>model.ckpt</strong> 文件：<strong>model.ckpt.data-00000-of-00001</strong>、<strong>model.ckpt.index</strong> 和 <strong>model.ckpt.meta</strong> 来自 <a href="http://download.tensorflow.org/models/object_detection/faster_rcnn_resnet101_coco_2017_11_08.tar.gz"><em>faster_rcnn_resnet101_coco</em></a> 模型，用来初始化网络参数；</p>
<p><strong>object_label_map.pbtxt</strong> 文件内容如下：</p>
<blockquote>
<p>item { ​ id: 1 ​ name: 'raccoon' }</p>
</blockquote>
<p>将其中的 <code>raccoon</code> 改成自己的类别标签，如果有多个类别标签则可以参考 <code>object_detection\data</code> 文件夹中的 <em><code>pascal_label_map.pbtxt</code></em> 文件格式；</p>
<p><strong>test.record</strong> 和 <strong>train.record</strong> 是生成的 TFRecord 数据，分别为待输入的测试数据和训练数据；</p>
<p><strong>eval </strong>文件夹为空文件夹用来输出测试结果；<strong>train</strong> 文件夹为空文件夹用来输出训练结果（包括checkpoint文件和最终的模型文件）；</p>
<p><strong>faster_rcnn_resnet101_coco.config</strong> 为配置文件，包括各种参数和输入输出数据的配置，其来自 <code>object_detection\samples\configs</code> 文件夹中 <em><code>faster_rcnn_resnet101_coco.config</code></em> 文件，在使用时需对其做如下修改：</p>
<ol type="1">
<li><p>首先是 <strong>num_classes</strong>，这是待检测的类别数目，如果只要检测一种，则将其值改为 1；</p></li>
<li><p><code>fine_tune_checkpoint: "PATH_TO_BE_CONFIGURED/model.ckpt"</code>，将 <code>PATH_TO_BE_CONFIGURED</code> 改为 <code>./data</code>；</p></li>
<li><p>``` train_input_reader: { tf_record_input_reader { input_path: "PATH_TO_BE_CONFIGURED/mscoco_train.record" } label_map_path: "PATH_TO_BE_CONFIGURED/mscoco_label_map.pbtxt" } <div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">   将其中的的 `PATH_TO_BE_CONFIGURED/mscoco_train.record` 改为 `./data/train.record`，将其中的 `PATH_TO_BE_CONFIGURED/mscoco_label_map.pbtxt` 改为 `./data/object_label_map.pbtxt`；</span><br><span class="line"></span><br><span class="line">4. ```</span><br><span class="line">   eval_input_reader: &#123;</span><br><span class="line">     tf_record_input_reader &#123;</span><br><span class="line">       input_path: &quot;PATH_TO_BE_CONFIGURED/mscoco_val.record&quot;</span><br><span class="line">     &#125;</span><br><span class="line">     label_map_path: &quot;PATH_TO_BE_CONFIGURED/mscoco_label_map.pbtxt&quot;</span><br><span class="line">     shuffle: false</span><br><span class="line">     num_readers: 1</span><br><span class="line">     num_epochs: 1</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></div></p>
<p>将其中的的 <code>PATH_TO_BE_CONFIGURED/mscoco_val.record</code> 改为 <code>./data/test.record</code>，将其中的 <code>PATH_TO_BE_CONFIGURED/mscoco_label_map.pbtxt</code> 改为 <code>./data/object_label_map.pbtxt</code>；</p></li>
</ol>
<p>至于其它的参数可以选择默认，不对其进行修改；</p>
<p><strong>train.py</strong> 为训练代码，其来自 <code>object_detection/</code> 文件夹中的 <em><code>train.py</code></em>，直接复制出来使用即可，具体用法为：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line">python train.py --logtostderr --train_dir=./train --pipeline_config_path=faster_rcnn_resnet101_coco.config</span><br></pre></td></tr></table></figure></div>
<p>其在运行过程中会在 <strong>train</strong> 文件夹生成一系列训练过程文件，比如 checkpoint、model.ckpt-{num}（{num} 代表训练过程保存的第几个网络模型，一般从 0 开始，包括 .index、.meta和 .data 三个文件）等文件。</p>
<p><strong>eval.py</strong> 为评估代码，其来自 <code>object_detection/</code> 文件夹中的 <em><code>eval.py</code></em>，直接复制出来使用即可，具体用法为：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line">python eval.py --logtostderr --checkpoint_dir=./train --eval_dir=./<span class="built_in">eval</span> --pipeline_config_path=./faster_rcnn_resnet101_coco.config</span><br></pre></td></tr></table></figure></div>
<p>其在运行过程中会在 <strong>eval</strong> 文件夹生成一系列评估文件，每个文件对应一个测试 image。</p>
<p><strong>export_inference_graph.py</strong> 为导出 pb 模型代码，其来自 <code>object_detection/</code> 文件夹中的 <em><code>export_inference_graph.py</code></em>，直接复制出来使用即可，具体用法为：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line">python export_inference_graph.py --input_type image_tensor --pipeline_config_path ./faster_rcnn_resnet101_coco.config --trained_checkpoint_prefix ./train/model.ckpt-18298 --output_directory ./model</span><br></pre></td></tr></table></figure></div>
<p>其中 <code>model.ckpt-18298</code> 表示使用第 18298 次保存的网络模型导出 pb 模型文件，导出的模型文件保存在 <strong>model</strong> 文件夹，主要有一下几个文件：</p>
<blockquote>
<p>- graph.pbtxt</p>
<p>- model.ckpt.data-00000-of-00001</p>
<p>- model.ckpt.info</p>
<p>- model.ckpt.meta</p>
<p>- frozen_inference_graph.pb</p>
</blockquote>
<p>其中 frozen_inference_graph.pb 就是训练成功用来检测目标的模型。</p>
<p>　　TensorFlow 训练时可以随时查看训练过程，如损失函数的值下降曲线等，所用命令为：在命令行中切换目录至 project 运行目录，即 train.py 所在文件夹，Shaun 这里即 <em>TensorFlowObjectDetectionAPITest</em> 文件夹，输入：<code>tensorboard --logdir=./</code>，等待片刻，在浏览器地址栏输入：<code>http://localhost:6006/</code>，即可看到训练过程曲线。</p>
<h3 id="检测篇">检测篇</h3>
<p>　　检测结果使用 opencv 窗口显示（至于 python 中 opencv 的使用详见下一篇（<a href="https://cniter.github.io/posts/5f54aa2c.html">PyQt5使用小结</a>）），具体调用自己训练的模型进行检测的 Python 代码（该代码为 eli 大佬参考 <code>object_detection</code> 文件夹中的 <em><code>object_detection_tutorial.ipynb</code></em>（该文件可在 jupyter 中查看）改的）为：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PYTHON"><div class="code-copy"></div><figure class="highlight hljs python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span> object_detection.utils <span class="keyword">import</span> label_map_util</span><br><span class="line"><span class="keyword">from</span> object_detection.utils <span class="keyword">import</span> visualization_utils <span class="keyword">as</span> vis_util</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Detector</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.PATH_TO_CKPT = <span class="string">r&#x27;./model/frozen_inference_graph.pb&#x27;</span>    <span class="comment"># 选择模型</span></span><br><span class="line">        self.PATH_TO_LABELS = <span class="string">r&#x27;./data/object_label_map.pbtxt&#x27;</span>      <span class="comment"># 选择类别标签文件</span></span><br><span class="line">        self.NUM_CLASSES = <span class="number">1</span></span><br><span class="line">        self.detection_graph = self._load_model()</span><br><span class="line">        self.category_index = self._load_label_map()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_load_model</span>(<span class="params">self</span>):</span></span><br><span class="line">        detection_graph = tf.Graph()</span><br><span class="line">        <span class="keyword">with</span> detection_graph.as_default():</span><br><span class="line">            od_graph_def = tf.GraphDef()</span><br><span class="line">            <span class="keyword">with</span> tf.gfile.GFile(self.PATH_TO_CKPT, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> fid:</span><br><span class="line">                serialized_graph = fid.read()</span><br><span class="line">                od_graph_def.ParseFromString(serialized_graph)</span><br><span class="line">                tf.import_graph_def(od_graph_def, name=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> detection_graph</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_load_label_map</span>(<span class="params">self</span>):</span></span><br><span class="line">        label_map = label_map_util.load_labelmap(self.PATH_TO_LABELS)</span><br><span class="line">        categories = label_map_util.convert_label_map_to_categories(label_map,</span><br><span class="line">                                                                    max_num_classes=self.NUM_CLASSES,</span><br><span class="line">                                                                    use_display_name=<span class="literal">True</span>)</span><br><span class="line">        category_index = label_map_util.create_category_index(categories)</span><br><span class="line">        <span class="keyword">return</span> category_index</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">detect</span>(<span class="params">self, image</span>):</span></span><br><span class="line">        <span class="keyword">with</span> self.detection_graph.as_default():</span><br><span class="line">            <span class="keyword">with</span> tf.Session(graph=self.detection_graph) <span class="keyword">as</span> sess:</span><br><span class="line">                <span class="comment"># Expand dimensions since the model expects images to have shape: [1, None, None, 3]</span></span><br><span class="line">                image_np_expanded = np.expand_dims(image, axis=<span class="number">0</span>)</span><br><span class="line">                image_tensor = self.detection_graph.get_tensor_by_name(<span class="string">&#x27;image_tensor:0&#x27;</span>)</span><br><span class="line">                boxes = self.detection_graph.get_tensor_by_name(<span class="string">&#x27;detection_boxes:0&#x27;</span>)</span><br><span class="line">                scores = self.detection_graph.get_tensor_by_name(<span class="string">&#x27;detection_scores:0&#x27;</span>)</span><br><span class="line">                classes = self.detection_graph.get_tensor_by_name(<span class="string">&#x27;detection_classes:0&#x27;</span>)</span><br><span class="line">                num_detections = self.detection_graph.get_tensor_by_name(<span class="string">&#x27;num_detections:0&#x27;</span>)</span><br><span class="line">                <span class="comment"># Actual detection.</span></span><br><span class="line">                (boxes, scores, classes, num_detections) = sess.run(</span><br><span class="line">                    [boxes, scores, classes, num_detections],</span><br><span class="line">                    feed_dict=&#123;image_tensor: image_np_expanded&#125;)</span><br><span class="line">                <span class="comment"># Visualization of the results of a detection.</span></span><br><span class="line">                vis_util.visualize_boxes_and_labels_on_image_array(</span><br><span class="line">                    image,</span><br><span class="line">                    np.squeeze(boxes),</span><br><span class="line">                    np.squeeze(classes).astype(np.int32),</span><br><span class="line">                    np.squeeze(scores),</span><br><span class="line">                    self.category_index,</span><br><span class="line">                    use_normalized_coordinates=<span class="literal">True</span>,</span><br><span class="line">                    line_thickness=<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">        cv2.namedWindow(<span class="string">&quot;detection&quot;</span>, cv2.WINDOW_NORMAL)</span><br><span class="line">        cv2.imshow(<span class="string">&quot;detection&quot;</span>, image)</span><br><span class="line">        cv2.waitKey(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    image = cv2.imread(<span class="string">&#x27;./test_img.jpg&#x27;</span>) <span class="comment"># 选择待检测的图片</span></span><br><span class="line">    detector = Detector()</span><br><span class="line">    detector.detect(image)</span><br></pre></td></tr></table></figure></div>
<h2 id="后记">后记</h2>
<p>　　经过这次 TensorFlow 训练，感觉深度学习 真tm 吃硬件，费时间，也难怪神经网络理论出来几十年之后才火，当年的硬件根本无法支持这么大的计算量。</p>
<h2 id="附录">附录</h2>
<p>最后附上 datitran 作者提供的 xml_to_csv.py 文件源码和 generate_tfrecord.py 文件源码：</p>
<p><strong>xml_to_csv.py 源码</strong>如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PYTHON"><div class="code-copy"></div><figure class="highlight hljs python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> glob</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> xml.etree.ElementTree <span class="keyword">as</span> ET</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xml_to_csv</span>(<span class="params">path</span>):</span></span><br><span class="line">    xml_list = []</span><br><span class="line">    <span class="keyword">for</span> xml_file <span class="keyword">in</span> glob.glob(path + <span class="string">&#x27;/*.xml&#x27;</span>):</span><br><span class="line">        tree = ET.parse(xml_file)</span><br><span class="line">        root = tree.getroot()</span><br><span class="line">        <span class="keyword">for</span> member <span class="keyword">in</span> root.findall(<span class="string">&#x27;object&#x27;</span>):</span><br><span class="line">            value = (root.find(<span class="string">&#x27;filename&#x27;</span>).text,</span><br><span class="line">                     <span class="built_in">int</span>(root.find(<span class="string">&#x27;size&#x27;</span>)[<span class="number">0</span>].text),</span><br><span class="line">                     <span class="built_in">int</span>(root.find(<span class="string">&#x27;size&#x27;</span>)[<span class="number">1</span>].text),</span><br><span class="line">                     member[<span class="number">0</span>].text,</span><br><span class="line">                     <span class="built_in">int</span>(member[<span class="number">4</span>][<span class="number">0</span>].text),</span><br><span class="line">                     <span class="built_in">int</span>(member[<span class="number">4</span>][<span class="number">1</span>].text),</span><br><span class="line">                     <span class="built_in">int</span>(member[<span class="number">4</span>][<span class="number">2</span>].text),</span><br><span class="line">                     <span class="built_in">int</span>(member[<span class="number">4</span>][<span class="number">3</span>].text)</span><br><span class="line">                     )</span><br><span class="line">            xml_list.append(value)</span><br><span class="line">    column_name = [<span class="string">&#x27;filename&#x27;</span>, <span class="string">&#x27;width&#x27;</span>, <span class="string">&#x27;height&#x27;</span>, <span class="string">&#x27;class&#x27;</span>, <span class="string">&#x27;xmin&#x27;</span>, <span class="string">&#x27;ymin&#x27;</span>, <span class="string">&#x27;xmax&#x27;</span>, <span class="string">&#x27;ymax&#x27;</span>]</span><br><span class="line">    xml_df = pd.DataFrame(xml_list, columns=column_name)</span><br><span class="line">    <span class="keyword">return</span> xml_df</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    image_path = os.path.join(os.getcwd(), <span class="string">&#x27;annotations&#x27;</span>)</span><br><span class="line">    xml_df = xml_to_csv(image_path)</span><br><span class="line">    xml_df.to_csv(<span class="string">&#x27;raccoon_labels.csv&#x27;</span>, index=<span class="literal">None</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Successfully converted xml to csv.&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">main()</span><br></pre></td></tr></table></figure></div>
<p><strong>generate_tfrecord.py 文件源码</strong> 如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PYTHON"><div class="code-copy"></div><figure class="highlight hljs python"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Usage:</span></span><br><span class="line"><span class="string">  # From tensorflow/models/</span></span><br><span class="line"><span class="string">  # Create train data:</span></span><br><span class="line"><span class="string">  python generate_tfrecord.py --csv_input=data/train_labels.csv  --output_path=train.record</span></span><br><span class="line"><span class="string">  # Create test data:</span></span><br><span class="line"><span class="string">  python generate_tfrecord.py --csv_input=data/test_labels.csv  --output_path=test.record</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> division</span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> object_detection.utils <span class="keyword">import</span> dataset_util</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> namedtuple, OrderedDict</span><br><span class="line"></span><br><span class="line">flags = tf.app.flags</span><br><span class="line">flags.DEFINE_string(<span class="string">&#x27;csv_input&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;Path to the CSV input&#x27;</span>)</span><br><span class="line">flags.DEFINE_string(<span class="string">&#x27;output_path&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;Path to output TFRecord&#x27;</span>)</span><br><span class="line">FLAGS = flags.FLAGS</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># TO-DO replace this with label map</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">class_text_to_int</span>(<span class="params">row_label</span>):</span></span><br><span class="line">    <span class="keyword">if</span> row_label == <span class="string">&#x27;raccoon&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">split</span>(<span class="params">df, group</span>):</span></span><br><span class="line">    data = namedtuple(<span class="string">&#x27;data&#x27;</span>, [<span class="string">&#x27;filename&#x27;</span>, <span class="string">&#x27;object&#x27;</span>])</span><br><span class="line">    gb = df.groupby(group)</span><br><span class="line">    <span class="keyword">return</span> [data(filename, gb.get_group(x)) <span class="keyword">for</span> filename, x <span class="keyword">in</span> <span class="built_in">zip</span>(gb.groups.keys(), gb.groups)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_tf_example</span>(<span class="params">group, path</span>):</span></span><br><span class="line">    <span class="keyword">with</span> tf.gfile.GFile(os.path.join(path, <span class="string">&#x27;&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(group.filename)), <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> fid:</span><br><span class="line">        encoded_jpg = fid.read()</span><br><span class="line">    encoded_jpg_io = io.BytesIO(encoded_jpg)</span><br><span class="line">    image = Image.<span class="built_in">open</span>(encoded_jpg_io)</span><br><span class="line">    width, height = image.size</span><br><span class="line"></span><br><span class="line">    filename = group.filename.encode(<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    image_format = <span class="string">b&#x27;jpg&#x27;</span></span><br><span class="line">    xmins = []</span><br><span class="line">    xmaxs = []</span><br><span class="line">    ymins = []</span><br><span class="line">    ymaxs = []</span><br><span class="line">    classes_text = []</span><br><span class="line">    classes = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> index, row <span class="keyword">in</span> group.<span class="built_in">object</span>.iterrows():</span><br><span class="line">        xmins.append(row[<span class="string">&#x27;xmin&#x27;</span>] / width)</span><br><span class="line">        xmaxs.append(row[<span class="string">&#x27;xmax&#x27;</span>] / width)</span><br><span class="line">        ymins.append(row[<span class="string">&#x27;ymin&#x27;</span>] / height)</span><br><span class="line">        ymaxs.append(row[<span class="string">&#x27;ymax&#x27;</span>] / height)</span><br><span class="line">        classes_text.append(row[<span class="string">&#x27;class&#x27;</span>].encode(<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line">        classes.append(class_text_to_int(row[<span class="string">&#x27;class&#x27;</span>]))</span><br><span class="line"></span><br><span class="line">    tf_example = tf.train.Example(features=tf.train.Features(feature=&#123;</span><br><span class="line">        <span class="string">&#x27;image/height&#x27;</span>: dataset_util.int64_feature(height),</span><br><span class="line">        <span class="string">&#x27;image/width&#x27;</span>: dataset_util.int64_feature(width),</span><br><span class="line">        <span class="string">&#x27;image/filename&#x27;</span>: dataset_util.bytes_feature(filename),</span><br><span class="line">        <span class="string">&#x27;image/source_id&#x27;</span>: dataset_util.bytes_feature(filename),</span><br><span class="line">        <span class="string">&#x27;image/encoded&#x27;</span>: dataset_util.bytes_feature(encoded_jpg),</span><br><span class="line">        <span class="string">&#x27;image/format&#x27;</span>: dataset_util.bytes_feature(image_format),</span><br><span class="line">        <span class="string">&#x27;image/object/bbox/xmin&#x27;</span>: dataset_util.float_list_feature(xmins),</span><br><span class="line">        <span class="string">&#x27;image/object/bbox/xmax&#x27;</span>: dataset_util.float_list_feature(xmaxs),</span><br><span class="line">        <span class="string">&#x27;image/object/bbox/ymin&#x27;</span>: dataset_util.float_list_feature(ymins),</span><br><span class="line">        <span class="string">&#x27;image/object/bbox/ymax&#x27;</span>: dataset_util.float_list_feature(ymaxs),</span><br><span class="line">        <span class="string">&#x27;image/object/class/text&#x27;</span>: dataset_util.bytes_list_feature(classes_text),</span><br><span class="line">        <span class="string">&#x27;image/object/class/label&#x27;</span>: dataset_util.int64_list_feature(classes),</span><br><span class="line">    &#125;))</span><br><span class="line">    <span class="keyword">return</span> tf_example</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">_</span>):</span></span><br><span class="line">    writer = tf.python_io.TFRecordWriter(FLAGS.output_path)</span><br><span class="line">    path = os.path.join(os.getcwd(), <span class="string">&#x27;images&#x27;</span>)</span><br><span class="line">    examples = pd.read_csv(FLAGS.csv_input)</span><br><span class="line">    grouped = split(examples, <span class="string">&#x27;filename&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> group <span class="keyword">in</span> grouped:</span><br><span class="line">        tf_example = create_tf_example(group, path)</span><br><span class="line">        writer.write(tf_example.SerializeToString())</span><br><span class="line"></span><br><span class="line">    writer.close()</span><br><span class="line">    output_path = os.path.join(os.getcwd(), FLAGS.output_path)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Successfully created the TFRecords: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(output_path))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    tf.app.run()</span><br></pre></td></tr></table></figure></div>
<h2 id="参考资料">参考资料</h2>
<p>[1] <a href="http://blog.csdn.net/xiaoxiao123jun/article/details/76605928">对于谷歌开源的TensorFlow Object Detection API视频物体识别系统实现教程</a></p>
<p>[2] <a href="http://blog.csdn.net/c20081052/article/details/77608954">TensorFlow学习——Tensorflow Object Detection API（win10，CPU）</a></p>
<p>[3] <a href="https://towardsdatascience.com/how-to-train-your-own-object-detector-with-tensorflows-object-detector-api-bec72ecfe1d9">How to train your own Object Detector with TensorFlow’s Object Detector API</a></p>
<p>[4] <a href="http://rensanning.iteye.com/blog/2381885">TensorFlow 之 物体检测</a>（<a href="http://rensanning.iteye.com/category/374992" class="uri">http://rensanning.iteye.com/category/374992</a>）</p>
<section class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>See <a href="http://cocodataset.org/#detections-eval">MSCOCO evaluation protocol</a>.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
]]></content>
      <categories>
        <category>Image&amp;Graphic</category>
      </categories>
      <tags>
        <tag>cv</tag>
        <tag>tensorflow</tag>
      </tags>
  </entry>
  <entry>
    <title>Win10＋VS2013＋CMake-gui编译和配置OpenCV-3.2.0</title>
    <url>/posts/7df528b4.html</url>
    <content><![CDATA[<p><font color=#FA8072>Shaun 的系统环境：Win10_x64 英文企业版；VS2013-update5 英文旗舰版；CMake-3.6.3-win64-x64 免安装版；Qt-opensource-windows-x86-msvc2013-5.6.2。</font></p>
<p>　　<strong>*注：</strong>Shaun 写的这篇文档主要用来编译 x86 版的动态 debug 库，想编译其它类型的库请自行参考其它资料，做相关改变。（ 其实如果想编译 x64 版的可以在用 VS2013 编译时将上方的 Win32 平台选择 x64 平台；想编译 release 版的可以在用 VS2013 编译时将上方的 Debug 模式选择 Release 模式；想编译静态库的可以在用 CMake 生成时取消勾选 <strong>BUILD_SHARED_LIBS</strong> 选项即可。:-P ）</p>
<h2 id="前言">前言</h2>
<p>　　因为 OpenCV-3.2 官方的 release 版只有支持 VS2015 的库，而且不包括扩展包（ opencv_contrib ）中的库，而由于某些历史原因，Shaun 目前使用的编译器还是 VS2013，又想用用扩展包中一些有趣的算法，在加上上个月 opencv-3.3 还没有正式 release，所以上个月 Shaun 就利用 VS2013 对 opencv-3.2 进行编译。具体编译过程如下：</p>
<span id="more"></span>
<h2 id="准备篇">准备篇</h2>
<p>　　先在 GitHub 上下载对应的 opencv 源码包：<a href="https://github.com/opencv/opencv/archive/3.2.0.zip">opencv-3.2.0</a> 和 <a href="https://github.com/opencv/opencv_contrib/archive/3.2.0.zip">opencv_contrib-3.2.0</a>（<a href="https://github.com/opencv" class="uri">https://github.com/opencv</a>），扩展包版本一定要和 opencv 版本相同。Shaun 为了添加 Qt 后端显示支持（为了好看和方便 :-P），所以还下载安装了支持 VS2013 的 <a href="http://download.qt.io/archive/qt/5.6/5.6.2/qt-opensource-windows-x86-msvc2013-5.6.2.exe">Qt-5.6.2</a>（<a href="http://download.qt.io/archive/qt/" class="uri">http://download.qt.io/archive/qt/</a>）。再<a href="https://cmake.org/files/v3.6/cmake-3.6.3-win64-x64.zip">下载 CMake-3.6.3-win64-x64 免安装版</a>（<a href="https://cmake.org/files/" class="uri">https://cmake.org/files/</a>）。至于微软的东西，推荐直接去 <a href="https://msdn.itellyou.cn/">MSDN 我告诉你</a>去下载。</p>
<p>　　由于网上有的资料（具体是哪篇文章 Shaun 忘记了 o(╯□╰)o）说编译时的文件结构可能会影响编译是否成功，再加上为了方便编译管理，Shaun 编译时的文件结构为：</p>
<blockquote>
<p>opencv-3.2.0_build<br />
├── build<br />
└── sources<br />
​ 　　├── opencv-3.2.0<br />
​ 　　└── opencv_contrib-3.2.0</p>
<p>4 directories, 0 files</p>
</blockquote>
<p>其中 opencv-3.2.0 用来装 opencv-3.2.0.zip 解压后的源码；opencv_contrib-3.2.0 用来装opencv_contrib-3.2.0.zip 解压后的源码；build 用来装 CMake 编译完成后的文件。</p>
<h2 id="编译篇">编译篇</h2>
<p>　　打开 /cmake-3.6.3-win64-x64/bin/cmake-gui.exe，在 <strong>Where is the source code</strong> 文本框中选择 /opencv-3.2.0_build/sources/opencv-3.2.0；在 <strong>Where to build the binaris</strong> 文本框中选择 /opencv-3.2.0_build/build，点击 <strong>Configure</strong>，在弹出的编译器选择框中选择 <strong>Visual Studio 12 2013</strong>，一直 <strong>Configure</strong> 直到红色的条变白。</p>
<p>　　网上有人在这一步可能会出现<code>ffmpeg not downloaded</code>和<code>“ippicv_windows_20151201.zip”not downloaded</code>这两个问题，Shaun 没出现这两个问题，所以没有机会验证 <a href="http://livezingy.com/compile-opencv-and-opencv_contrib/">cmake-gui和vs2013编译opencv和opencv_contrib源码</a> 中的解决办法是否正确。</p>
<p>　　接下来就是添加扩展包，在白色条中找到 <strong>OPENCV_EXTRA_MODULES_PATH</strong> 文本框，在其中选择 opencv_contrib 源码中 modeles 所在路径：/opencv-3.2.0_build/sources/opencv_contrib-3.2.0/modules。</p>
<p>　　至于想要支持 OpenGL 和 Qt 就需要勾选 <strong>WITH_OPENGL</strong> 和 <strong>WITH_QT</strong> 并 <strong>Configure</strong> 后选择好 Qt 的安装目录，如果配置好 Qt 的环境变量 Cmake 将会自动选择好 Qt 所在路径。</p>
<p>　　随后再次反复 <strong>Configure</strong> 直到界面不再出现红色背景，之后单击 <strong>Generate</strong>。不出意外的话，你会看到 <strong>Configure done</strong> 和 <strong>Generate done</strong>。</p>
<p>　　Shaun 在这一步出现了 <a href="http://livezingy.com/build_shared_libs/">VS2013_CMake_opencv3.1动态库与静态库的配置与编译</a> 中的问题，原因是同时勾选了同时勾选了 <strong>BUILD_opencv_world</strong> 和 <strong>BUILD_opencv_contirb_world</strong>，Shaun 的解决办法是将它们全部取消勾选，再次 <strong>Configure</strong> 和 <strong>Generate</strong>。</p>
<p>　　如果上面一切顺利的话就可以进行下一步了：使用 VS2013 编译 OpenCV。打开 /opencv-3.2.0_build/build 目录，将会看到一大堆文件和文件夹，双击 /opencv-3.2.0_build/build 目录下的 <strong>OpenCV.sln</strong>，用 VS2013 打开。找到 <strong>CMakeTargets</strong> 中的 <strong>INSTALL</strong> ，然后右键选择“Project Only”--&gt;“Build Only INSTALL”。</p>
<p>漫长的等待。。。。。。 (╯﹏╰)b</p>
<p>　　Shaun 在这一步出现了一个问题，具体问题和解决方法详见问题篇。</p>
<p>　　一切顺利的话，应该会比 Shaun 下面的库多两个，Shaun 最后生成的 Debug 库为：</p>
<blockquote>
<p>opencv_aruco320d.lib</p>
<p>opencv_bgsegm320d.lib</p>
<p>opencv_bioinspired320d.lib</p>
<p>opencv_calib3d320d.lib</p>
<p>opencv_ccalib320d.lib</p>
<p>opencv_core320d.lib</p>
<p>opencv_datasets320d.lib</p>
<p>opencv_dnn320d.lib</p>
<p>opencv_dpm320d.lib</p>
<p>opencv_face320d.lib</p>
<p>opencv_features2d320d.lib</p>
<p>opencv_flann320d.lib</p>
<p>opencv_fuzzy320d.lib</p>
<p>opencv_highgui320d.lib</p>
<p>opencv_imgcodecs320d.lib</p>
<p>opencv_imgproc320d.lib</p>
<p>opencv_line_descriptor320d.lib</p>
<p>opencv_ml320d.lib</p>
<p>opencv_objdetect320d.lib</p>
<p>opencv_optflow320d.lib</p>
<p>opencv_phase_unwrapping320d.lib</p>
<p>opencv_photo320d.lib</p>
<p>opencv_plot320d.lib</p>
<p>opencv_reg320d.lib</p>
<p>opencv_rgbd320d.lib</p>
<p>opencv_saliency320d.lib</p>
<p>opencv_shape320d.lib</p>
<p>opencv_stereo320d.lib</p>
<p>opencv_stitching320d.lib</p>
<p>opencv_structured_light320d.lib</p>
<p>opencv_superres320d.lib</p>
<p>opencv_surface_matching320d.lib</p>
<p>opencv_text320d.lib</p>
<p>opencv_tracking320d.lib</p>
<p>opencv_video320d.lib</p>
<p>opencv_videoio320d.lib</p>
<p>opencv_videostab320d.lib</p>
<p>opencv_xfeatures2d320d.lib</p>
<p>opencv_ximgproc320d.lib</p>
<p>opencv_xobjdetect320d.lib</p>
<p>opencv_xphoto320d.lib</p>
<p>共41个。</p>
</blockquote>
<h2 id="配置篇">配置篇</h2>
<p>　　因为 Shaun 只编译了 x86 版动态 debug 库，所以以下环境配置都只针对 x86 版动态 debug 库。（其实要配置 x64 的库就只需将 x86 换成 x64 即可；要配置 release 模式的库就只需在添加附加依赖项中的库文件选择 release 模式的库（即数字后没有 d的 lib）；若要配置静态库就需要选择静态库文件夹以及在附加依赖项中添加相应的静态库文件。:-P）</p>
<p>　　首先把 /opencv-3.2.0_build/build/install 中的文件都提取出来，这和 OpenCV 官方 release 的 opencv 文件结构差不多，具体两层结构如下</p>
<blockquote>
<p>.<br />
├── bin<br />
│　 └── opencv_waldboost_detectord.exe<br />
├── etc<br />
│　 ├── haarcascades<br />
│　 └── lbpcascades<br />
├── include<br />
│　 ├── opencv<br />
│　 └── opencv2<br />
├── LICENSE<br />
├── OpenCVConfig.cmake<br />
├── OpenCVConfig-version.cmake<br />
└── x86<br />
​ 　　└── vc12</p>
<p>9 directories, 4 files</p>
</blockquote>
<p>x86 文件夹就是 VS2013 生成的对应 VS 版本 32位 的各种库，include 文件夹就是 opencv 的各项模块。Shaun 将其中提取出的文件全部放入了 C:\Program Files\OpenCV\3.2.0\build 文件夹中。</p>
<p>　　首先配置环境变量，系统（或用户）环境变量如下：</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">变量名</th>
<th>变量值</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Path</td>
<td>C:\Program Files\OpenCV\3.2.0\build\x86\vc12\bin</td>
</tr>
<tr class="even">
<td style="text-align: center;">OPENCV</td>
<td>C:\Program Files\OpenCV\3.2.0\build</td>
</tr>
</tbody>
</table>
<p>不然可能会报错：<font color=#FA8072>程序“XXXXXX”已退出，返回值为 -1073741701 (0xc000007b)</font>。其中下面那行可以选择不要添加。</p>
<p>　　然后在 VS 中配置环境。新建工程，然后在“<strong>属性管理器</strong>”中对应项目下 <strong>Debug | Win32</strong> 文件夹右键“<strong>添加新项目属性表</strong>”。（方便一次配置，多次使用，以后再使用只要在相应项目下右键“<strong>添加现有属性表</strong>”即可），Shaun 新项目属性表取名为：opencv-3.2.0_msvc2013_x86d.props。</p>
<p>接下来就是真正的 VS 环境配置了：</p>
<p>　　双击打开刚才新建的属性表，选中“<strong>VC++目录</strong>”，<font color=#FA8072>注意在进行以下配置时建议都勾选左下角的“<strong>从父级或项目默认设置继承</strong>”</font></p>
<p>“<strong>可执行文件目录</strong>”中添加：</p>
<blockquote>
<p>C:\Program Files\OpenCV\3.2.0\build\x86\vc12\bin</p>
</blockquote>
<p>“<strong>包含目录</strong>”中添加：</p>
<blockquote>
<p>C:\Program Files\OpenCV\3.2.0\build\include</p>
<p>C:\Program Files\OpenCV\3.2.0\build\include\opencv</p>
<p>C:\Program Files\OpenCV\3.2.0\build\include\opencv2</p>
</blockquote>
<p>“<strong>库目录</strong>”中添加：</p>
<blockquote>
<p>C:\Program Files\OpenCV\3.2.0\build\x86\vc12\lib</p>
</blockquote>
<p>选中“<strong>链接器</strong>” –&gt; “<strong>常规</strong>”，“<strong>附加库目录</strong>”中添加：</p>
<blockquote>
<p>C:\Program Files\OpenCV\3.2.0\build\x86\vc12\lib</p>
</blockquote>
<p>“<strong>链接器</strong>” –&gt; “<strong>输入</strong>”，“<strong>附加依赖项</strong>”中添加 <code>C:\Program Files\OpenCV\3.2.0\build\x86\vc12\lib</code> 中数字后带 d 的库文件，即编译篇中 Shaun 最后生成的 41 个库文件。</p>
<p>　　<font color=#FA8072>配置完之后不要忘了右键该属性表进行保存处理</font>，以便下个项目直接使用，不需要再重复进行配置。</p>
<p>最后附示例程序：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/opencv.hpp&gt;</span>  </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	cv::Mat lena = cv::<span class="built_in">imread</span>(<span class="string">&quot;lena.jpg&quot;</span>); <span class="comment">//载入图像到Mat，jpg文件和该cpp在同一文件夹</span></span><br><span class="line">	cv::<span class="built_in">namedWindow</span>(<span class="string">&quot;lena&quot;</span>); <span class="comment">//创建一个名为 &quot;lean&quot;的窗口   </span></span><br><span class="line">	cv::<span class="built_in">imshow</span>(<span class="string">&quot;lena&quot;</span>, lena);    <span class="comment">//显示名为 &quot;lena&quot;的窗口</span></span><br><span class="line">	cv::<span class="built_in">waitKey</span>(<span class="number">5000</span>);  <span class="comment">// 只对窗口机制起作用（显示5000ms，随后返回-1，即窗口关闭），若在此期间有按键按下，则马上返回按键的ASCII码。</span></span><br><span class="line">	<span class="comment">//system(&quot;pause&quot;);</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>这里必须在 imshow 后加入 waitkey，因为 WaitKey 不止是 Wait Key 而已，它其实还涉及到消息响应，有这个函数 cv 内部的 WndProc 函数才能起作用，才会更新窗口。</p>
<p>　　最后程序运行成功并显示 lena 图，则说明编译和配置没问题。</p>
<h2 id="问题篇">问题篇</h2>
<p><font color=#FA8072>1、用 VS2013 编译 OpenCV 在漫长的等待阶段出现的问题。</font></p>
<p>　　<strong>问题描述：</strong>CVV 模块报错，TS 模块编译不出来，好在这两个模块都不是很重要，可以忽略，Shaun 强迫症也没到这种程度 O(∩_∩)O~。</p>
<p>　　<strong>解决办法：</strong> 在 CVV 模块报错后可在 CMake（不知道具体是 <strong>INSTALL</strong> 下的 <strong>CMake Rules</strong> 中的 <strong>INSTALL_force.rule</strong>，还是 <strong>ALL_BUILD</strong> 下的 <strong>CMakeLists.txt</strong>，忘记了 o(╯□╰)o）中添加 <code>-DBUILD_opencv_cvv=OFF</code> 忽略 CVV 模块，从而正常编译其它模块。参考 <a href="https://github.com/opencv/opencv_contrib/issues/577">errors on build opencv with cvv module and qt5 #577</a>。如果实在不行的话就在 CMake 生成的时候取消勾选出错模块，若是用 CMake 重新生成的话不要忘了先把 /opencv-3.2.0_build/build 目录下的文件全部删除干净。</p>
<h2 id="后记">后记</h2>
<p>　　这是以前写的两篇文档，现在再来整理成一篇。</p>
<h2 id="附录">附录</h2>
<p>　　既然能看到这里，说明是想在 VS 下使用 OpenCV，这里推荐一款 VS 下 OpenCV 开发调试神器：<a href="https://marketplace.visualstudio.com/items?itemName=WolfKienzle.ImageWatch">Image Watch</a>，效果谁用谁知道。Image Watch 是 VS 的一个插件，不过它只支持 VS2012 及以上版本。使用方法为先设置断点（ F9 ），随后在调试（ F5 ）模式下，鼠标指针悬停在 <code>cv::Mat</code> 类型变量上，即可出现 <img src="http://img.blog.csdn.net/20161115134305655" alt="插件调试标签" />，点击查看图标即可显示相应图像。</p>
<h2 id="参考资料">参考资料</h2>
<p>[1] <a href="http://livezingy.com/compile-opencv-and-opencv_contrib/">cmake-gui和vs2013编译opencv和opencv_contrib源码</a>（<a href="http://livezingy.com/category/opencv/" class="uri">http://livezingy.com/category/opencv/</a>）</p>
<p>[2] <a href="http://livezingy.com/build_shared_libs/">VS2013_CMake_opencv3.1动态库与静态库的配置与编译</a>（<a href="http://livezingy.com/category/opencv/" class="uri">http://livezingy.com/category/opencv/</a>）</p>
<p>[3] <a href="https://wenku.baidu.com/view/ef3081e3a5e9856a561260d1.html">使用VS2015编译以及静态编译opencv3记录</a></p>
<p>[4] <a href="https://github.com/opencv/opencv_contrib/issues/577">errors on build opencv with cvv module and qt5 #577</a></p>
<p>[5] <a href="http://blog.csdn.net/fengbingchun/article/details/46756373">VS2013中Image Watch插件的使用(OpenCV)</a>（<a href="http://blog.csdn.net/fengbingchun/article/category/721609" class="uri">http://blog.csdn.net/fengbingchun/article/category/721609</a>）</p>
]]></content>
      <categories>
        <category>Study</category>
      </categories>
      <tags>
        <tag>opencv</tag>
      </tags>
  </entry>
  <entry>
    <title>OpenGL坐标系统与渲染管线</title>
    <url>/posts/81321445.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　图形学中最基础的东西就是坐标系统，三维的东西如何在二维中显示，这中间经历了数次坐标变换，同时坐标变换也贯穿了整个计算机图形渲染管线。</p>
<span id="more"></span>
<h2 id="坐标篇">坐标篇</h2>
<figure>
<img src="https://learnopengl-cn.github.io/img/01/08/coordinate_systems.png" alt="coordinate_systems" /><figcaption aria-hidden="true">coordinate_systems</figcaption>
</figure>
<p>　　在计算机图形世界中，为更灵活的控制三维物体显示在二维中，将变换的过程大致分为 5 个空间：1、局部空间（Local Space，或者称为物体空间（Object Space））；2、世界空间（World Space）；3、观察空间（View Space，或者称为视觉空间（Eye Space））；4、裁剪空间（Clip Space）；5、屏幕空间（Screen Space）。局部空间中是物体相对于坐标原点的坐标，也是物体的固有坐标，在依次经历过缩放旋转平移，也即模型矩阵（Model Matrix）变换后，物体局部坐标变换为世界坐标，世界坐标中即定义了物体所在的位置，以及产生的旋转和缩放。在世界空间中加入相机，以相机的视角看世界中的物体，即通过观察矩阵（View Matrix，也称视图矩阵）变换后，将世界坐标转换为观察坐标，由于一张屏幕能显示的东西是有限的，而三维世界中的物体是无限，所以需要通过投影矩阵（Projection Matrix）对三维空间进行裁剪，以决定哪些物体能显示在屏幕上，为方便的计算机判断，处于裁剪空间内的坐标会被转换为 [-1, 1]，为顺利在屏幕上显示，又需要通过视窗变换（Viewport Transform）将 [-1, 1] 映射为 viewport 中的图元坐标，再通过渲染管线的其他流程输出为屏幕上的像素点。</p>
<h2 id="变换篇">变换篇</h2>
<p>　　矩阵相乘一般有左乘和右乘之分，左乘和右乘的区别在于坐标是按列还是按行排列（OpenGL 中是按列，所以是左乘，DX 中按行，所以是右乘，同一种变换，传入 DX 中的矩阵与传入 OpenGL 中的矩阵互为转置），坐标与矩阵相乘越靠近坐标的矩阵表示该坐标越先做相应矩阵变换。</p>
<p>　　模型矩阵，视图矩阵，投影矩阵，在简单的顶点着色器编程中，这三个矩阵一般会合并成一个 MVP 矩阵传入 GPU 中。</p>
<h3 id="模型矩阵">模型矩阵</h3>
<p>　　模型矩阵一般定义了物体的缩放旋转平移状态，缩放矩阵的构造很简单，若物体在 <span class="math inline">\((x,y,z)\)</span> 方向上缩放尺度分别为 <span class="math inline">\((S_x, S_y, S_z)\)</span>，则缩放矩阵为： <span class="math display">\[
M_{scaling} = \begin{bmatrix} S_x &amp; 0 &amp; 0 &amp; 0 \\ 0 &amp; S_y &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; S_z &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; 1 \end{bmatrix}
\]</span> 　　旋转矩阵就非常麻烦了，这里暂且不讨论其如何计算，只给出矩阵，物体绕任意轴 <span class="math inline">\((R_X, R_y, R_z)\)</span> 旋转 θ 角的矩阵为： <span class="math display">\[
M_{rotation} = \begin{bmatrix} cos\theta+R_x^2(1-cos\theta) &amp; R_xR_y(1-cos\theta)-R_zsin\theta &amp; R_xR_z(1-cos\theta)+R_ysin\theta &amp; 0 \\ R_yR_x(1-cos\theta)+R_zsin\theta &amp; cos\theta+R_y^2(1-cos\theta) &amp; R_yR_z(1-cos\theta)-R_xsin\theta &amp; 0 \\ R_zR_x(1-cos\theta)-R_ysin\theta &amp; R_zR_y(1-cos\theta)+R_xsin\theta &amp; cos\theta+R_z^2(1-cos\theta) &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; 1 \end{bmatrix}
\]</span> 　　当然，由于万向节锁的存在，一般不会直接使用欧拉角和旋转轴计算旋转矩阵，而是会通过四元数得到旋转矩阵，这样既高效又能避免万向节锁，详情可看「LearnOpenGL」译者的<a href="https://krasjet.github.io/quaternion/">教程</a>。</p>
<p>　　至于平移矩阵也非常简单，若物体在 <span class="math inline">\((x,y,z)\)</span> 方向上平移量分别为 <span class="math inline">\((T_x, T_y, T_z)\)</span>，则平移矩阵为： <span class="math display">\[
M_{translation} = \begin{bmatrix} 1 &amp; 0 &amp; 0 &amp; T_x \\ 0 &amp; 1 &amp; 0 &amp; T_y \\ 0 &amp; 0 &amp; 1 &amp; T_z \\ 0 &amp; 0 &amp; 0 &amp; 1 \end{bmatrix}
\]</span> 　　前面的缩放和旋转矩阵其实只需要用到 3×3 的矩阵，而之所以用 4×4 的表示也是因为平移矩阵，普通的 3 维坐标必须增加一维 <span class="math inline">\(w\)</span> 构成齐次坐标才能进行平移操作，<span class="math inline">\(w\)</span> 一般都是 1.0，而从齐次坐标<span class="math inline">\((x,y,z,w)\)</span> 变为普通的 3 维坐标需要每个分量除以 <span class="math inline">\(w\)</span>，即 <span class="math inline">\((x/w, y/w, z/w)\)</span> 。</p>
<p>则模型矩阵 <span class="math inline">\(M_{model} = M_{translation} \cdot M_{rotation} \cdot M_{scaling}\)</span>。</p>
<h3 id="视图矩阵">视图矩阵</h3>
<p>　　视图矩阵描述的是三维场景中模拟相机的状态，根据模拟相机的状态确定一套以相机为原点的相机坐标系，从而使用视图矩阵进行坐标变换，至于为啥是模拟相机，是因为 OpenGL 本身并没有相机的概念，通过模拟相机来实现在三维场景中的漫游。</p>
<figure>
<img src="https://learnopengl-cn.github.io/img/01/09/camera_axes.png" alt="camera_axes" /><figcaption aria-hidden="true">camera_axes</figcaption>
</figure>
<p>　　模拟相机有三个关键点，分别为相机位置（cameraPos），相机朝向点（cameraTarget），相机上向量（top），根据相机位置和相机朝向点可确定相机坐标系的 z 轴正向向量 <span class="math inline">\(cameraDirection = (cameraPos - cameraTarget).normalize\)</span>，叉乘相机上向量和相机 z 轴正向向量可得到相机坐标系 x 轴正向向量 <span class="math inline">\(cameraRight = top.cross(cameraDirection).normalize\)</span>，最后将相机 z 轴正向向量与 x 轴正向向量叉乘得到 y 轴正向向量 <span class="math inline">\(cameraUp = cameraDirection.cross(cameraRight)\)</span>，如此即可建立完整的相机坐标系，从而得到变换矩阵，即视图矩阵： <span class="math display">\[
M_{view} = \begin{bmatrix} R_x &amp; R_y &amp; R_z &amp; 0 \\ U_x &amp; U_y &amp; U_z &amp; 0 \\ D_x &amp; D_y &amp; D_z &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; 1 \end{bmatrix} \begin{bmatrix} 1 &amp; 0 &amp; 0 &amp; -P_x \\ 0 &amp; 1 &amp; 0 &amp; -P_y \\ 0 &amp; 0 &amp; 1 &amp; -P_z \\ 0 &amp; 0 &amp; 0 &amp; 1 \end{bmatrix}
\]</span> 其中 <span class="math inline">\(R\)</span> 是相机 x 轴正向向量，<span class="math inline">\(U\)</span> 是相机 y 轴正向向量，<span class="math inline">\(D\)</span> 是相机 z 轴正向向量， <span class="math inline">\(P\)</span> 是相机位置向量。</p>
<h3 id="投影矩阵">投影矩阵</h3>
<p>　　投影矩阵描述的是摄像机前的可视区域（Frustum），根据可视区域的形状可分为正射投影（Orthographic Projection）和透视投影（Perspective Projection）。</p>
<p><img src="https://learnopengl-cn.github.io/img/01/08/orthographic_frustum.png" alt="orthographic projection frustum" /> <img src="https://learnopengl-cn.github.io/img/01/08/perspective_frustum.png" alt="perspective_frustum" /></p>
<p>　　对于这两种投影，都有远（far）近（near）参数，不同的是，正射投影是个立方体，所以有左（left）右（right）上（top）下（bottom）四个参数，而透视投影是个类梯形台，所以还有垂直方向视野（Field of View，fov），以及一个宽高比（aspect）两个参数。远近两个参数决定摄像机能看到多近和多远的物体，太近和太远都会看不见，一般可设 near = 0.1，far = 1000；若渲染视窗（viewport）宽为 W，高为 H，则一般 <span class="math inline">\(left=-W/2, right=W/2, top=H/2, bottom=-H/2\)</span> ；透视投影的 fov 是角度，一般设为 45.0，而 <span class="math inline">\(aspect = W/H\)</span> 。这两种投影的矩阵分别为： <span class="math display">\[
M_{orth} = \begin{bmatrix} \frac{2}{right-left} &amp; 0 &amp; 0 &amp; -\frac{right+left}{right-left} \\ 0 &amp; \frac{2}{top-bottom} &amp; 0 &amp; -\frac{top+bottom}{top-bottom} \\ 0 &amp; 0 &amp; \frac{-2}{far-near} &amp; -\frac{far+near}{far-near} \\ 0 &amp; 0 &amp; 0 &amp; 1 \end{bmatrix} \\
M_{pers} = \begin{bmatrix} \frac{2near}{right-left} &amp; 0 &amp; \frac{right+left}{right-left} &amp; 0 \\ 0 &amp; \frac{2near}{top-bottom} &amp; \frac{top+bottom}{top-bottom} &amp; 0 \\ 0 &amp; 0 &amp; \frac{-(far+near)}{far-near} &amp; \frac{-2far*near}{far-near} \\ 0 &amp; 0 &amp; -1 &amp; 0 \end{bmatrix}
\]</span></p>
<p>　　在 three.js 中，对于透视投影矩阵中 left, right, top, bottom 计算方式为：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="JAVASCRIPT"><div class="code-copy"></div><figure class="highlight hljs javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> top = near * <span class="built_in">Math</span>.tan( _Math.DEG2RAD * <span class="number">0.5</span> * <span class="built_in">this</span>.fov ) / <span class="built_in">this</span>.zoom;</span><br><span class="line"><span class="keyword">let</span> height = <span class="number">2</span> * top;</span><br><span class="line"><span class="keyword">let</span> width = <span class="built_in">this</span>.aspect * height;</span><br><span class="line"><span class="keyword">let</span> left = - <span class="number">0.5</span> * width;</span><br><span class="line"><span class="keyword">let</span> right = left + width;</span><br><span class="line"><span class="keyword">let</span> bottom = top - height;</span><br></pre></td></tr></table></figure></div>
<p>　　对于透视投影，由于计算出的齐次坐标 w 分量显然不为 1.0，所以必须进行透视除法（x,y,z 各分量分别除以 w），得到真正的 3 维坐标。</p>
<p>　　正射投影一般用来模拟 2D 空间，透视投影用来模拟 3D 空间，当透视投影 near 和 far 设置的相差太大时，很容易引发 z-fighting 现象，原因是离近平面越远时，计算出的深度精度越低，three.js 中为解决这一问题，引入了一个 logarithmicDepthBuffer 参数来决定是否开启使用对数函数优化深度计算，具体可看源码中的 logdepthbuf_vertex.glsl.js 和 logdepthbuf_fragment.glsl.js 文件，开启该参数会造成渲染性能下降。</p>
<h3 id="小结">小结</h3>
<p>　　<span class="math inline">\(M_{mvp} = M_{projection}M_{view}M_{model}\)</span>，一个局部坐标 <span class="math inline">\(V_{local}\)</span> 在经过 MVP 矩阵变换之后可得到裁剪坐标 <span class="math inline">\(V_{clip} = M_{mvp}V_{local}\)</span> ，在 OpenGL 中，<span class="math inline">\(V_{clip}\)</span> 会被赋值到顶点着色器中的 <code>gl_Position</code>，并且 OpenGL 会自动进行透视除法和裁剪。</p>
<p>　　3 维中的相机一般可分为两种，第一人称相机（常规 FPS 游戏）和第三人称相机（常规 ARPG 游戏），第一人称相机的特点是灵活，相机往往可以任意改变位置和朝向，所以会对某些人造成一种 “晕 3D” 的现象，而第三人称相机虽然可以改变相机朝向点和位置，但当朝向点和到朝向点的距离一旦固定，则相机只能沿着以朝向点为球心，以到朝向点的距离为半径的球面上运动，这两种相机一般看具体业务需求进行选择。</p>
<p>　　缩放操作是很常规的一种操作，镜头拉近代表放大，拉远代表缩小。在使用透视投影的 3 维场景中，只需要改变相机到朝向点的距离即可简单实现缩放操作，而在使用正射投影的场景中，改变距离并不能实现缩放，而是需要改变 左右上下 四个参数，所以在相机中往往会在引入一个 zoom 的参数，用 左右上下 四个参数分别除以 zoom 得到真正的 左右上下，从而改变 zoom，就可以改变相机参数，进而实现正射投影的缩放。</p>
<h2 id="管线篇">管线篇</h2>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="processonSvg1000" viewBox="-14.0 -19.5 759.0 557.625" width="600" height="500">
<defs id="ProcessOnDefs1001"><marker id="ProcessOnMarker1009" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1010" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1017" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1018" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1025" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1026" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1038" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1039" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1047" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1048" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1055" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1056" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1063" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1064" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1071" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1072" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1083" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1084" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1089" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1090" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1105" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1106" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1116" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1117" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1122" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1123" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1138" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1139" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker></defs><g id="ProcessOnG1002"><path id="ProcessOnPath1003" d="M-14.0 -19.5H745.0V538.125H-14.0V-19.5Z" fill="none"></path><g id="ProcessOnG1004"><g id="ProcessOnG1005" transform="matrix(1.0,0.0,0.0,1.0,6.0,122.0)" opacity="1.0"><path id="ProcessOnPath1006" d="M0.0 39.5C0.0 -13.166666666666666 84.0 -13.166666666666666 84.0 39.5C84.0 92.16666666666667 0.0 92.16666666666667 0.0 39.5Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path></g><g id="ProcessOnG1007"><path id="ProcessOnPath1008" d="M90.0 161.5L137.3829796415478 161.5" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1009)"></path></g><g id="ProcessOnG1011" transform="matrix(1.0,0.0,0.0,1.0,152.6190476190476,126.5)" opacity="1.0"><path id="ProcessOnPath1012" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1013" transform="matrix(1.0,0.0,0.0,1.0,10.0,25.0)"><text id="ProcessOnText1014" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="16" x="39.0" y="16.4">顶点着色器</text></g></g><g id="ProcessOnG1015"><path id="ProcessOnPath1016" d="M252.6190476190476 161.5L263.7639320225002 161.5" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1017)"></path></g><g id="ProcessOnG1019" transform="matrix(1.0,0.0,0.0,1.0,279.0,126.5)" opacity="1.0"><path id="ProcessOnPath1020" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1021" transform="matrix(1.0,0.0,0.0,1.0,10.0,25.0)"><text id="ProcessOnText1022" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="16" x="39.0" y="16.4">图元装配</text></g></g><g id="ProcessOnG1023"><path id="ProcessOnPath1024" d="M379.0 161.5L413.7639320225002 161.5" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1025)"></path></g><g id="ProcessOnG1027" transform="matrix(1.0,0.0,0.0,1.0,429.0,126.5)" opacity="1.0"><path id="ProcessOnPath1028" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1029" transform="matrix(1.0,0.0,0.0,1.0,10.0,25.0)"><text id="ProcessOnText1030" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="16" x="39.0" y="16.4">光栅器</text></g></g><g id="ProcessOnG1031" transform="matrix(1.0,0.0,0.0,1.0,24.5,150.0)" opacity="1.0"><path id="ProcessOnPath1032" d="M0.0 0.0L47.0 0.0L47.0 23.0L0.0 23.0Z" stroke="#999" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1033" transform="matrix(1.0,0.0,0.0,1.0,0.0,-7.25)"><text id="ProcessOnText1034" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="22.5" y="15.375">顶点</text><text id="ProcessOnText1035" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="22.5" y="34.125">缓冲区</text></g></g><g id="ProcessOnG1036"><path id="ProcessOnPath1037" d="M529.0 161.5L548.5 161.5L548.5 161.5L552.7639320225002 161.5" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1038)"></path></g><g id="ProcessOnG1040" transform="matrix(1.0,0.0,0.0,1.0,568.0,126.5)" opacity="1.0"><path id="ProcessOnPath1041" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1042" transform="matrix(1.0,0.0,0.0,1.0,10.0,15.0)"><text id="ProcessOnText1043" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="微软雅黑" text-anchor="middle" font-size="16" x="39.0" y="16.4">片元着色</text><text id="ProcessOnText1044" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="微软雅黑" text-anchor="middle" font-size="16" x="39.0" y="36.4">器</text></g></g><g id="ProcessOnG1045"><path id="ProcessOnPath1046" d="M668.0 161.5L725.0 161.5L725.0 271.8354430379747L710.2360679774998 271.8354430379747" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1047)"></path></g><g id="ProcessOnG1049" transform="matrix(1.0,0.0,0.0,1.0,595.0,236.8354430379747)" opacity="1.0"><path id="ProcessOnPath1050" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1051" transform="matrix(1.0,0.0,0.0,1.0,10.0,25.0)"><text id="ProcessOnText1052" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="微软雅黑" text-anchor="middle" font-size="16" x="39.0" y="16.4">归属测试</text></g></g><g id="ProcessOnG1053"><path id="ProcessOnPath1054" d="M595.0 271.8354430379747L556.0 271.8354430379747L556.0 271.8354430379747L532.2360679774998 271.8354430379747" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1055)"></path></g><g id="ProcessOnG1057" transform="matrix(1.0,0.0,0.0,1.0,417.0,236.8354430379747)" opacity="1.0"><path id="ProcessOnPath1058" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1059" transform="matrix(1.0,0.0,0.0,1.0,10.0,25.0)"><text id="ProcessOnText1060" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="微软雅黑" text-anchor="middle" font-size="16" x="39.0" y="16.4">模板测试</text></g></g><g id="ProcessOnG1061"><path id="ProcessOnPath1062" d="M417.0 271.8354430379747L378.5 271.8354430379747L378.5 271.8354430379747L355.2360679774998 271.8354430379747" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1063)"></path></g><g id="ProcessOnG1065" transform="matrix(1.0,0.0,0.0,1.0,240.0,236.8354430379747)" opacity="1.0"><path id="ProcessOnPath1066" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1067" transform="matrix(1.0,0.0,0.0,1.0,10.0,25.0)"><text id="ProcessOnText1068" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="微软雅黑" text-anchor="middle" font-size="16" x="39.0" y="16.4">深度测试</text></g></g><g id="ProcessOnG1069"><path id="ProcessOnPath1070" d="M240.0 271.8354430379747L207.0 271.8354430379747L207.0 271.8354430379747L189.2360679774998 271.8354430379747" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1071)"></path></g><g id="ProcessOnG1073" transform="matrix(1.0,0.0,0.0,1.0,74.0,236.8354430379747)" opacity="1.0"><path id="ProcessOnPath1074" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1075" transform="matrix(1.0,0.0,0.0,1.0,10.0,25.0)"><text id="ProcessOnText1076" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="微软雅黑" text-anchor="middle" font-size="16" x="39.0" y="16.4">融合</text></g></g><g id="ProcessOnG1077" transform="matrix(1.0,0.0,0.0,1.0,74.0,444.25)" opacity="1.0"><path id="ProcessOnPath1078" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1079" transform="matrix(1.0,0.0,0.0,1.0,10.0,25.0)"><text id="ProcessOnText1080" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="微软雅黑" text-anchor="middle" font-size="16" x="39.0" y="16.4">抖动</text></g></g><g id="ProcessOnG1081"><path id="ProcessOnPath1082" d="M74.0 271.8354430379747L20.0 271.8354430379747L20.0 479.25L58.763932022500214 479.25" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1083)"></path></g><g id="ProcessOnG1085" transform="matrix(1.0,0.0,0.0,1.0,250.05952380952385,440.375)" opacity="1.0"><path id="ProcessOnPath1086" d="M0.0 38.875C0.0 -12.958333333333334 79.88095238095235 -12.958333333333334 79.88095238095235 38.875C79.88095238095235 90.70833333333333 0.0 90.70833333333333 0.0 38.875Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path></g><g id="ProcessOnG1087"><path id="ProcessOnPath1088" d="M174.0 479.25L212.02976190476193 479.25L212.02976190476193 479.25L234.82345583202405 479.25" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1089)"></path></g><g id="ProcessOnG1091" transform="matrix(1.0,0.0,0.0,1.0,268.73809523809524,467.75)" opacity="1.0"><path id="ProcessOnPath1092" d="M0.0 0.0L47.0 0.0L47.0 23.0L0.0 23.0Z" stroke="#999" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1093" transform="matrix(1.0,0.0,0.0,1.0,0.0,-7.25)"><text id="ProcessOnText1094" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="22.5" y="15.375">颜色</text><text id="ProcessOnText1095" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="22.5" y="34.125">缓冲区</text></g></g><g id="ProcessOnG1096" transform="matrix(1.0,0.0,0.0,1.0,624.0,3.500000000000014)" opacity="1.0"><path id="ProcessOnPath1097" d="M0.0 38.49999999999999C0.0 -12.83333333333333 82.0 -12.83333333333333 82.0 38.49999999999999C82.0 89.83333333333331 0.0 89.83333333333331 0.0 38.49999999999999Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path></g><g id="ProcessOnG1098" transform="matrix(1.0,0.0,0.0,1.0,639.2619047619048,30.16455696202533)" opacity="1.0"><path id="ProcessOnPath1099" d="M0.0 0.0L51.476190476190474 0.0L51.476190476190474 25.32911392405063L0.0 25.32911392405063Z" stroke="#999" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1100" transform="matrix(1.0,0.0,0.0,1.0,0.0,-6.085443037974684)"><text id="ProcessOnText1101" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="24.738095238095237" y="15.375">纹理</text><text id="ProcessOnText1102" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="24.738095238095237" y="34.125">缓冲区</text></g></g><g id="ProcessOnG1103"><path id="ProcessOnPath1104" d="M665.0 80.5L665.0 103.5L618.0 103.5L618.0 111.26393202250021" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1105)"></path></g><g id="ProcessOnG1107" transform="matrix(1.0,0.0,0.0,1.0,252.6190476190476,346.0)" opacity="1.0"><path id="ProcessOnPath1108" d="M0.0 37.0C0.0 -12.333333333333334 74.76190476190476 -12.333333333333334 74.76190476190476 37.0C74.76190476190476 86.33333333333333 0.0 86.33333333333333 0.0 37.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path></g><g id="ProcessOnG1109" transform="matrix(1.0,0.0,0.0,1.0,264.26190476190476,370.33544303797464)" opacity="1.0"><path id="ProcessOnPath1110" d="M0.0 0.0L51.476190476190474 0.0L51.476190476190474 25.32911392405063L0.0 25.32911392405063Z" stroke="#999" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1111" transform="matrix(1.0,0.0,0.0,1.0,0.0,-6.085443037974684)"><text id="ProcessOnText1112" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="24.738095238095237" y="15.375">深度</text><text id="ProcessOnText1113" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="24.738095238095237" y="34.125">缓冲区</text></g></g><g id="ProcessOnG1114"><path id="ProcessOnPath1115" d="M290.0 306.8354430379747L290.0 326.4177215189874L289.99999999999994 326.4177215189874L289.99999999999994 330.7639320225002" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1116)"></path></g><g id="ProcessOnG1118" transform="matrix(1.0,0.0,0.0,1.0,78.0,25.0)" opacity="1.0"><path id="ProcessOnPath1119" d="M0.0 39.5C0.0 -13.166666666666666 84.0 -13.166666666666666 84.0 39.5C84.0 92.16666666666667 0.0 92.16666666666667 0.0 39.5Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path></g><g id="ProcessOnG1120"><path id="ProcessOnPath1121" d="M120.0 104.0L120.0 161.5L137.3829796415478 161.5" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1122)"></path></g><g id="ProcessOnG1124" transform="matrix(1.0,0.0,0.0,1.0,78.75,48.5)" opacity="1.0"><path id="ProcessOnPath1125" d="M0.0 0.0L82.5 0.0L82.5 32.0L0.0 32.0Z" stroke="#999" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1126" transform="matrix(1.0,0.0,0.0,1.0,0.0,-2.75)"><text id="ProcessOnText1127" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="40.25" y="15.375">uniform</text><text id="ProcessOnText1128" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="40.25" y="34.125">数据</text></g></g><g id="ProcessOnG1129" transform="matrix(1.0,0.0,0.0,1.0,529.0,0.5)" opacity="1.0"><path id="ProcessOnPath1130" d="M0.0 40.0C0.0 -13.333333333333334 82.0 -13.333333333333334 82.0 40.0C82.0 93.33333333333333 0.0 93.33333333333333 0.0 40.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path></g><g id="ProcessOnG1131" transform="matrix(1.0,0.0,0.0,1.0,529.75,26.829113924050645)" opacity="1.0"><path id="ProcessOnPath1132" d="M0.0 0.0L82.5 0.0L82.5 32.0L0.0 32.0Z" stroke="#999" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1133" transform="matrix(1.0,0.0,0.0,1.0,0.0,-2.75)"><text id="ProcessOnText1134" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="40.25" y="15.375">uniform</text><text id="ProcessOnText1135" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="40.25" y="34.125">数据</text></g></g><g id="ProcessOnG1136"><path id="ProcessOnPath1137" d="M570.0 80.5L570.0 103.5L618.0 103.5L618.0 111.26393202250021" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1138)"></path></g></g></g>
</svg>
<p>　　渲染管线，图形学中最重要的概念之一，既然称之为管线，自然有像流水线一样的步骤，各个步骤具体做的事情如下：</p>
<ol type="1">
<li>顶点着色器：负责将顶点数据进行坐标变换，该着色器中一般存在 MVP 矩阵，负责将三维坐标变换为二维坐标，该阶段也可以优化每个点的深度值，以便管线后续进行深度测试，也可以利用光照简单优化每个顶点的颜色；</li>
<li>图元装配：将输入的顶点数据进行组装，形成图元，常见的图元包括：点(GL_POINTS)、线(GL_LINES)、线条(GL_LINE_STRIP)、三角面(GL_TRIANGLES)，在该过程中，一般 GPU 会做一些裁剪和背面剔除等操作，以减少图元的数量，同时完成透视除法以进行屏幕映射；</li>
<li>光栅化：负责计算每个图元到屏幕像素点的映射。光栅化会计算每个图元所覆盖的片元，同时利用顶点属性插值计算每个片元的属性，片元可认为是候选像素，经过后续管线阶段即可变为真正的像素。</li>
<li>片元着色器：将光栅化得到的片元进行颜色计算。图形学中几乎所有的高级特效都会在这一步完成，光照计算，阴影处理，纹理，材质，统统在这一步进行处理；</li>
<li>归属测试：即测试片元所在位置是否位于当前上下文视窗内，若一个显示帧缓冲区视窗被另一个视窗所遮蔽，则剔除该部分片元。</li>
<li>模板测试：即测试片元是否满足一定条件（可大于或小于某个值等），若测试不满足，则剔除该该片元， OpenGL 可自行选择开启或关闭模板测试。</li>
<li>深度测试：用来测试片元的远近，远的片元被遮挡。在深度测试，若两片元深度值接近，则可能会引起 Z-fighting 现象，即像素闪烁，这是因为此时 GPU 无法确定该剔除哪个片元，导致这一帧可能绘制这个片元，下一帧绘制另一个片元。若开启 Alpha 测试，即启用透明度，则会在下一阶段进行 Alpha 混合，从而达到透明效果。</li>
<li>混合：将新生成的片元颜色和帧缓冲区中对应位置的颜色进行混合，得到像素颜色。</li>
<li>抖动：一种以牺牲分辨率为代价来增加颜色表示范围技术，从视觉效果上来看就是颜色过度更平滑。</li>
</ol>
<p>　　以上这些阶段中，能完全被编程控制的也就顶点着色器和片元着色器两个阶段，其余阶段要么完全无法控制，要么只能通过已有的参数进行设置，当然也可以通过顶点着色器和片元着色器影响余下阶段，顶点着色器和片元着色器也统称 Shader 编程。</p>
<p>　　有时候为了做更好看的特效，需要进行多次渲染，将上一次渲染的结果作为下一次渲染的输入，此时可以将颜色缓冲区作为一张纹理，并构造新的帧缓冲区，将该纹理作为输入，重新放进渲染管线中，这种操作方式也叫后期处理（Post Processing），虽然好看，但对 GPU 的负载很大，需要合理使用。</p>
<p>　　对于渲染管线，Shaun 的理解也就到此为止了，非常粗浅，Shader 也只是刚入门的水平，Shaun 在图形学方面做的更多是降低 Draw-Call 和 CPU 层面的 Tessellation，以及 Geometry 上的事，对纹理材质颜色光照阴影等方面涉及的较少。</p>
<h2 id="后记">后记</h2>
<p>　　虽然目前 OpenGL 已停止更新，但学习图形学编程，OpenGL 总是绕不过去（至少暂时以及未来很长一段时间都会是这样），而且图形学基础知识本质都是相同的，不管是 DirectX 还是 Vulkan，变的只是写法形式而已，数学知识总是在那里，两种 shader 也同样需要，所以了解这些东西还是有必要的。</p>
<h2 id="附录">附录</h2>
<h3 id="二维图像的图像透视投影变换">二维图像的图像透视投影变换</h3>
<p>　　图像的透视投影变换常用于图像的矫正，OpenCV 中就有现成的 api（getPerspectiveTransform 和 warpPerspective），用于将不规整的四边形区域变换为规整的矩形区域。其基本的数学原理为，先构造一个投影变换等式： <span class="math display">\[
\begin{bmatrix} XW \\ YW \\ W \end{bmatrix} = \begin{bmatrix} a &amp; b &amp; c \\ d &amp; e &amp; f \\ g &amp; h &amp; 1 \end{bmatrix} \begin{bmatrix} x \\ y \\ 1 \end{bmatrix}
\]</span> 设四边形中四个点分别为 <span class="math inline">\((X_1, Y_1),(X_2, Y_2),(X_3, Y_3),(X_4, Y_4)\)</span> ，对应矩形中四个点为 <span class="math inline">\((x_1, y_1),(x_2, y_2),(x_3, y_3),(x_4, y_4)\)</span>。则可构造齐次线性方程组： <span class="math display">\[
\begin{bmatrix} x_1 &amp; y_1 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; -X_1x_1 &amp; -X_1y_1 \\ 0 &amp; 0 &amp; 0 &amp; x_1 &amp; y_1 &amp; 1 &amp; -Y_1x_1 &amp; -Y_1y_1 \\ x_2 &amp; y_2 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; -X_2x_2 &amp; -X_2y_2 \\ 0 &amp; 0 &amp; 0 &amp; x_2 &amp; y_2 &amp; 1 &amp; -Y_2x_2 &amp; -Y_2y_2 \\ \vdots &amp; \vdots &amp; \vdots &amp; \vdots &amp; \vdots &amp; \vdots &amp; \vdots &amp; \vdots \\ x_n &amp; y_n &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; -X_nx_n &amp; -X_ny_n \\ 0 &amp; 0 &amp; 0 &amp; x_n &amp; y_n &amp; 1 &amp; -Y_nx_n &amp; -Y_ny_n \end{bmatrix} \begin{bmatrix} a \\ b \\ c \\ d \\ e \\ f \\ g \\ h \end{bmatrix} = \begin{bmatrix} X_1 \\ Y_1 \\ X_2 \\ Y_2 \\ \vdots \\ X_n \\ Y_n \end{bmatrix}
\]</span> 解这个方程组得到 abcdefg ，使用上面的投影变换等式可计算 <span class="math inline">\(X = XW / W, Y = YW / W\)</span> ，从而使用插值得到规整矩形图形的各个像素值。</p>
<h3 id="shader-学习资料">Shader 学习资料</h3>
<p>shader 入门书：https://thebookofshaders.com，在线编写 shader ：https://thebookofshaders.com/edit.php</p>
<p>glslsandbox 网站：http://glslsandbox.com/</p>
<p>shadertoy 网站：https://www.shadertoy.com/</p>
<p>threejs shader 系列教程：https://www.cnblogs.com/heymar/category/2432299.html</p>
<h2 id="参考资料">参考资料</h2>
<p>[1] <a href="https://learnopengl-cn.github.io/01%20Getting%20started/08%20Coordinate%20Systems/">坐标系统</a>（https://learnopengl-cn.github.io）</p>
<p>[2] <a href="http://www.yanhuangxueyuan.com/webgl_course/hardware.html">WebGL图形系统、渲染管线_郭隆邦技术博客</a></p>
<p>[3] <a href="http://www.songho.ca/opengl/gl_projectionmatrix.html">OpenGL Projection Matrix</a></p>
<p>[4] <a href="https://www.cnblogs.com/dojo-lzz/p/11250327.html">WebGL着色器32位浮点数精度损失问题</a></p>
<p>[5] <a href="https://stackoverflow.com/questions/3190483/transform-quadrilateral-into-a-rectangle">Transform quadrilateral into a rectangle?</a></p>
]]></content>
      <categories>
        <category>Image&amp;Graphic</category>
      </categories>
      <tags>
        <tag>algorithm</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/posts/4a17b156.html</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="quick-start">Quick Start</h2>
<h3 id="create-a-new-post">Create a new post</h3>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure></div>
<p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="run-server">Run server</h3>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure></div>
<p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="generate-static-files">Generate static files</h3>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure></div>
<p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="deploy-to-remote-sites">Deploy to remote sites</h3>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure></div>
<p>More info: <a href="https://hexo.io/docs/deployment.html">Deployment</a></p>
]]></content>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>hexo-theme-chi主题更新小记</title>
    <url>/posts/26d437be.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　Chi 主题的大体结构功能算是写完了，但是还有一些个性化的东西需要添加，所以以后有关于 Chi 主题更新的部分就都写在这里吧。但是由于是 Shaun 个性化定制的一些东西，所以如果不是大 Bug 或大优化的更新，一般就不进 <a href="https://github.com/cniter/hexo-theme-chi">Chi 主题仓库</a> 中了。</p>
<span id="more"></span>
<h2 id="功能篇">功能篇</h2>
<h3 id="脚注提示功能">1. 脚注提示功能</h3>
<p><strong>功能描述：</strong> 鼠标悬停在脚注上即可显示对应脚注内容。 Shaun 的脚注由于是采用 pandoc 渲染的，所以也是属于个性化定制，就不将这个功能放进 Chi 主题仓库中了。</p>
<p><strong>解决方案：</strong> 还是利用 Bootstrap 的 tooltip 提示插件，具体实现代码如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="JAVASCRIPT"><div class="code-copy"></div><figure class="highlight hljs javascript"><table><tr><td class="code"><pre><span class="line">$(<span class="string">&#x27;a.footnote-ref&#x27;</span>).each(<span class="function"><span class="keyword">function</span> (<span class="params">index, elem</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> post_id = $(<span class="built_in">this</span>).parents(<span class="string">&#x27;article&#x27;</span>).attr(<span class="string">&#x27;id&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> fn_href = $(<span class="built_in">this</span>).attr(<span class="string">&#x27;href&#x27;</span>);</span><br><span class="line">    elem.setAttribute(<span class="string">&#x27;data-toggle&#x27;</span>, <span class="string">&#x27;tooltip&#x27;</span>);</span><br><span class="line">    elem.setAttribute(<span class="string">&#x27;data-html&#x27;</span>, <span class="string">&#x27;true&#x27;</span>);</span><br><span class="line">    elem.setAttribute(<span class="string">&#x27;title&#x27;</span>, $(<span class="string">&quot;#&quot;</span> + post_id + <span class="string">&quot; &quot;</span> + fn_href).html());</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></div>
<p>遍历脚注，先获取文章 id，再获取对应文章下的对应脚注内容，使用 tooltip 提示。</p>
<h2 id="bug-篇">Bug 篇</h2>
<h3 id="图片没居中">1. 图片没居中</h3>
<p><strong>问题描述：</strong> 上次那篇翻译的文章有几张图片，在放置的时候发现图片没有居中，查看代码后发现居中样式没写，但由于其图片标签 <code>&lt;img&gt;</code> 是放在一个 <code>&lt;figure&gt;</code> 标签中，由于不确定是不是 pandoc 渲染的问题，所以就没将这个修正放进 Chi 主题仓库中了。</p>
<p><strong>解决办法：</strong> 在 <code>style.styl</code> 文件中添加样式：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="CSS"><div class="code-copy"></div><figure class="highlight hljs css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">figure</span> &#123;</span><br><span class="line">	<span class="attribute">text-align</span>: center;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>即可让图片居中。</p>
<h2 id="动画篇">动画篇</h2>
<h3 id="鼠标跟随动画">1. 鼠标跟随动画</h3>
<p>　　其实一直都想把『奥日与黑暗森林』中的鼠标轨迹特效移植过来，但是苦于水平有限，一直没法做到，恰好 19 年 StackOverflow 的愚人节彩蛋中有个鼠标跟随动画很有意思，有好事者还专门将该彩蛋做了个脚本：<a href="https://meta.stackexchange.com/questions/326037/will-there-be-an-option-to-permanently-keep-this-years-april-fools-design-activ">Will there be an option to permanently keep this year's April Fools design active?</a> 。查看代码，知道实现原理后，发现用 jQuery 和 CSS3 实现一个类似的效果也不算很难，于是 Shaun 就尝试做了一下，并简单的美化了一下，感觉效果还行，就加到自己的个性化主题上了。至于在 Chrome 中的小尾巴和 Firefox 中的卡顿现象，是 Shaun 故意的，因为 Shaun 觉得这个小尾巴很有意思，从这个动画看，Chrome 确实比 Firefox 要流畅一点。最终实现代码如下：</p>
<p>css 代码：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="CSS"><div class="code-copy"></div><figure class="highlight hljs css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.cursor-trail--item</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: inline-block;</span><br><span class="line">    <span class="attribute">line-height</span>: <span class="number">1px</span>;</span><br><span class="line">    <span class="attribute">position</span>: fixed;</span><br><span class="line">    <span class="attribute">pointer-events</span>: none;</span><br><span class="line">    touch-action: none;</span><br><span class="line">    <span class="attribute">z-index</span>: <span class="number">9999999</span>;</span><br><span class="line">    will-change: transform;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">rgba</span>(<span class="number">186</span>, <span class="number">227</span>, <span class="number">240</span>, <span class="number">0.1</span>);</span><br><span class="line">    <span class="attribute">text-shadow</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">2px</span> <span class="number">#6CC2F8</span>;</span><br><span class="line">    -webkit-<span class="attribute">animation</span>: cursorTrail <span class="number">0.9s</span> ease;</span><br><span class="line">    <span class="attribute">animation</span>: cursorTrail <span class="number">0.9s</span> ease;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@keyframes</span> cursorTrail &#123;</span><br><span class="line">    <span class="number">0%</span> &#123;</span><br><span class="line">        <span class="attribute">opacity</span>: <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="number">20%</span> &#123;</span><br><span class="line">        <span class="attribute">opacity</span>: <span class="number">0.5</span>;</span><br><span class="line">        <span class="attribute">transform</span>: <span class="built_in">scale</span>(<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="number">100%</span> &#123;</span><br><span class="line">        <span class="attribute">opacity</span>: <span class="number">0</span>;</span><br><span class="line">        <span class="attribute">transform</span>: <span class="built_in">translate3D</span>(<span class="number">0</span>, -<span class="number">20px</span>, <span class="number">0</span>) <span class="built_in">scale</span>(<span class="number">1</span>) <span class="built_in">rotate</span>(<span class="number">90deg</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>js 代码如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="JAVASCRIPT"><div class="code-copy"></div><figure class="highlight hljs javascript"><table><tr><td class="code"><pre><span class="line">$(<span class="built_in">document</span>).on(<span class="string">&#x27;mousemove&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">    e.preventDefault();</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.time &amp;&amp; (<span class="built_in">Date</span>.now() - <span class="built_in">this</span>.time) &lt; <span class="number">16</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="built_in">this</span>.time = <span class="built_in">Date</span>.now();</span><br><span class="line">    <span class="keyword">let</span> trail_character = <span class="string">&#x27;•&#x27;</span>;</span><br><span class="line">    <span class="keyword">let</span> mouse_x = e.originalEvent.x || e.originalEvent.layerX || <span class="number">0</span>; </span><br><span class="line">    <span class="keyword">let</span> mouse_y = e.originalEvent.y || e.originalEvent.layerY || <span class="number">0</span>;</span><br><span class="line">    mouse_x = mouse_x + <span class="number">20</span>;</span><br><span class="line">    mouse_y = mouse_y + <span class="number">26</span>;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    $(<span class="string">&#x27;#cursor-trail&#x27;</span>).append(</span><br><span class="line">        <span class="string">&#x27;&lt;span class=&quot;cursor-trail--item&quot; style=&quot;left:&#x27;</span> </span><br><span class="line">        + mouse_x </span><br><span class="line">        + <span class="string">&#x27;px;top:&#x27;</span> </span><br><span class="line">        + mouse_y </span><br><span class="line">        + <span class="string">&#x27;px;&quot;&gt;&#x27;</span> </span><br><span class="line">        + trail_character </span><br><span class="line">        + <span class="string">&#x27;&lt;/span&gt;&#x27;</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    $(<span class="string">&#x27;.cursor-trail--item&#x27;</span>).each(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> item = $(<span class="built_in">this</span>);</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; </span><br><span class="line">            $(item).remove(); </span><br><span class="line">        &#125;, <span class="number">900</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></div>
<p>若不要小尾巴，则只需要将移除元素的时间改快一点就行了，除开上面的代码，还需要在 html 页面中添加一个元素 <code>&lt;span id="cursor-trail"&gt;&lt;/span&gt;</code> 。</p>
<h3 id="点击波纹">2. 点击波纹</h3>
<p>　　一次偶然的机会，看到一篇这样的文章：<a href="https://juejin.im/post/5ba5ab8ce51d450e7762cca5">还原一个 Windows 10 Metro 布局</a> 。感觉其中的点击波纹动画很有意思，Shaun 决定把这个动画也放进自己的个性化主题中。至于代码就不贴了，毕竟就是上面文章提供的代码，只是用这个动画的时候发现了 Chrome 的一个问题，就是在进行模糊动画的时候会出现正方形的右边框和下边框，单个模糊不进行动画，不会有边框，进行动画但没模糊也不会有边框，两个同时一起就会出现问题，Firefox 没有这个问题，但 Firefox 存在另一个问题，就是鼠标快速连点的时候，鼠标跟随动画可能会出现问题。浏览器的问题 Shaun 暂时没法解决了，就先这样吧 ╮(╯▽╰)╭。虽然对 Chrome 为啥会出现这样的问题有些猜想，但还是不说出来丢人了，万一不是 Shaun 想的这样就尴尬了 ,,ԾㅂԾ,, 。</p>
<h2 id="后记">后记</h2>
<p>有更新再继续更新吧。</p>
]]></content>
      <categories>
        <category>建站小记</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>hexo-theme-chi主题开发小记</title>
    <url>/posts/ac4679b5.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　2019 年 2 月 20 日，Shaun 的站点主题终于完成了，终于能用上自己的主题了，开心 ～(￣▽￣～)。</p>
<span id="more"></span>
<p>　　在网上看到的建议都是多写内容少整主题，但强迫症表示受不了，Shaun 就是想要一个自己的主题，自己怎么看着舒服就怎么来，即使没有一个访客，至少也要让自己看着舒服，自己想怎么设计就怎么设计，想用什么技术就用什么技术，想怎么排版就怎么排版，尽量少受写约束，总而言之，Shaun 喜欢自由。</p>
<h2 id="回顾篇">回顾篇</h2>
<p>　　自己写主题的想法由来已久，应该是从 17 年 12 月份开始的吧，当时就感觉自己魔改的 spfk_x 主题只能勉强符合自己的需求，但是因为已经用的是别人已经完成的框架，大体框架也不好做太多修改（如果要改的话还不如自己重新写一个），而且里面由于经手太多人的修改，里面的代码结构在 Shaun 看起来有点混乱，而且有很多冗余的代码，有些代码甚至完全没有用上，导致修改起来有点麻烦。</p>
<p>　　至于为什么不在 17 年寒假期间就开始写，而要拖到 18 年 12 月份才开始动手，一部分原因是 Shaun 的拖延症，一部分原因是还没具体想好该怎么布局，该用什么技术，还有一部分就是外在客观原因了。</p>
<p>　　18 年 12 月份开始动手写，是因为这段时间稍显空闲，虽然白天还是一样的忙，但至少没那么多心里负担了，而且此时 Shaun 对于自己想要的大体布局已经十分清楚了（虽然一些具体细节还没不是那么清楚），所以就趁着晚上有时间写写，有时候晚上高兴或没事干就写写，有时候没想法或还没想好具体怎么实现就不写，就这样断断续续的写，总算在 19 年 2 月完成了。</p>
<p>　　本来想在 19 年之前完成的，可是由于本人的拖延症和一些客观原因，还是超期了很久，侯世达定律总是存在的（ sigh~😔），不过总的开发时间也差不多是一个月吧。感觉花费这一个月的晚上时间还是挺值得的，虽然从中学到的东西不多，但总算也有点自己的东西了。</p>
<h2 id="实现篇">实现篇</h2>
<p>　　既然要开始写主题了，首先当然要想一个主题名字，本来最初是直接取原来主题的首尾字母作为名字，但后面想了想感觉有点不对劲，有点骂人的意味在里面 (´ ; ω ; `)，后面又想了想，就用尾字母 X 算了，反正站点图标也是那个，后面感觉还是不好，单字母太单一了，后面突然想到希腊字母，就以希腊字母的英语命名了。</p>
<p>　　名字想好之后，就要决定用什么技术了，由于 Shaun 只是一个前端小白，无论用什么技术对 Shaun 来说难度都差不多，Shaun 理想的主题是能够支持响应式的，所以为了尽可能简单的支持响应式，CSS 方面的库就采用 Bootstrap4，CSS 预处理器当然是用 Stylus 了， JS 方面最令 Shaun 纠结，到底是采用现代的 Vue 还是传统的 jQuery，最终从相对熟悉程度和相关资料广度方面考虑，Shaun 最终选择了 jQuery3（以后有机会再尝试一下 Vue 吧），接下来要选择的是 Node.js 模板引擎，候选的主要有三个 EJS、Swig 和 Jade（现已更名Pug），Shaun 原来的主题是用 EJS 的，著名的 NexT 主题用的 Swig，而 Pug 的语法目前有点接受不能，所以直接放弃了，而 Swig 早已停止更新，所以也放弃了，所以最终选择的还是相对熟悉的 EJS（而 EJS 最近的一次提交时间为 2018 年 11 月 28 日，看来应该也是要停止更新了，以后有机会试试 Pug 吧）。</p>
<p>　　技术决定之后，就要开始写了，最开始写的时候，由于不清楚 hexo 的工作机制，导致完全无法显示页面，后面查阅了几篇关于如何写 hexo 主题的文章，加上自己的慢慢摸索，终于弄懂了，hexo 的最初页面需要有一个 index 文件，在 index 中写入的东西，将会显示在 <code>http://localhost:4000/</code> 页面中，好了，终于能显示内容了，接下来要解决的是布局问题，hexo 的所有页面渲染都会通过一个叫 layout 的文件，layout 文件中必须存在一个 <code>&lt;%- body %&gt;</code> 语句，在渲染时，hexo 会用其它页面的内容替换 layout 中的 <code>&lt;%- body %&gt;</code> 语句，包括 index 中，所以在 layout 中写好 HTML 框架之后，其它页面只需要负责写内容就行。实现一个最简单的主题（只有纯文字版网页），只需要下面几步：</p>
<blockquote>
<blockquote>
<ol type="1">
<li>在 index.ejs 文件中写入 <code>&lt;%- include('_partial/archive', &#123;item: page, is_index: true&#125;) %&gt;</code>；</li>
<li>然后在 _partial 文件夹中 archive.ejs 文件中写入：</li>
</ol>
</blockquote>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="code"><pre><span class="line">&lt;% page.posts.each(function(item) &#123; %&gt;</span><br><span class="line">    &lt;%- include(&#x27;article&#x27;, &#123;item: item, is_index: true&#125;) %&gt;</span><br><span class="line">&lt;% &#125;) %&gt;</span><br><span class="line"></span><br><span class="line">&lt;% if (page.total &gt; 1)&#123; %&gt;</span><br><span class="line">    &lt;%- paginator(&#123;</span><br><span class="line">        prev_text: &#x27;&amp;laquo; Prev&#x27;,</span><br><span class="line">        next_text: &#x27;Next &amp;raquo;&#x27;</span><br><span class="line">    &#125;) %&gt;</span><br><span class="line">&lt;% &#125; %&gt;</span><br></pre></td></tr></table></figure></div>
<blockquote>
<ol start="3" type="1">
<li>在 _partial 文件夹中 article.ejs 文件中写入 <code>&lt;div&gt;&lt;%- item.content %&gt;&lt;/div&gt;</code>；</li>
<li>最后在 layout.ejs 文件中写入：</li>
</ol>
</blockquote>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">        &lt;%- body %&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></div>
<blockquote>
<p>即可将文章内容显示出来，前提是已有文章。当然也可把上面的1~3步合起来算作一步，直接在 index.ejs 文件中写入：</p>
</blockquote>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="code"><pre><span class="line">&lt;% page.posts.each(function(post) &#123; %&gt;</span><br><span class="line">    &lt;div&gt;&lt;%- post.content %&gt;&lt;/div&gt;</span><br><span class="line">&lt;% &#125;) %&gt;</span><br><span class="line"></span><br><span class="line">&lt;% if (page.total &gt; 1)&#123; %&gt;</span><br><span class="line">    &lt;%- paginator(&#123;</span><br><span class="line">        prev_text: &#x27;&amp;laquo; Prev&#x27;,</span><br><span class="line">        next_text: &#x27;Next &amp;raquo;&#x27;</span><br><span class="line">    &#125;) %&gt;</span><br><span class="line">&lt;% &#125; %&gt;</span><br></pre></td></tr></table></figure></div>
<p>这样就算是实现了一个最简单的主题，只是这个主题十分丑陋，文章也没有对应的标题。</p>
</blockquote>
<p><strong><em>※注：</em></strong> 在写这几步的时候，Shaun 在这里发现 hexo-browsersync 插件和 hexo s 命令有冲突，会造成一个bug：<a href="https://github.com/hexojs/hexo/issues/3180">hexo s 启动后，页面加载错误，大BUG</a>，具体表现为：当直接使用 <code>&lt;%- post.content %&gt;</code> 在首页显示文章时，index.html 将会无法加载完全，后面的一部分会加载错误。<strong>解决办法为：</strong>卸载 hexo-browsersync 插件。</p>
<p>　　完成上面几步，就算是写主题已经入门了，万事开头难，入门之后就相对简单了，只要按部就班的一步步走下去就行了，接下来就是慢慢进行排版布局问题，就这样，Shaun 一边参考其它一些主题的排版和写法，一边查阅网上资料实现自己的想法，一步一步的解决问题，直到完成该主题。</p>
<p><strong>PS：</strong> <em>主题配置文件 _config.yml 中的配置变量的命名和其它编程语言一样，不能以数字作为第一个字符</em>。</p>
<h2 id="文档篇">文档篇</h2>
<p>　　Chi 主题涉及到的技术主要为：Bootstrap4、jQuery3、Stylus、EJS、HTML5、CSS3、ES6 等；运行环境为：node-v8.11.1、Hexo-3（hexo-cli-1.1.0）等；测试浏览器为Firefox 60.5.0 esr 和 Chrome 72.0.3626.109，其它浏览器没测过，也不考虑测，有兴趣的童鞋可以自己测自己改。</p>
<p>　　Chi 主题的配色主要参考 Shaun 原来的主题 spfk_x，排版部分参考了 <a href="https://github.com/wzpan/hexo-theme-freemind"><strong>hexo-theme-freemind</strong></a>，部分代码也是来自这两个主题。Chi 主题的一些动画实现优先采用 CSS，除了那些无法用 CSS 实现或 Shaun 不知道如何用 CSS 实现的，所以 JS 代码部分不算很多，网页加载速度也勉强能够接受吧。</p>
<p>　　Chi 主题的代码高亮部分本来想参考 <a href="http://jumpbyte.cn/2016/07/02/use-and-install-prettify/">为hexo博客加入prettify高亮插件</a> 使用prettify替换默认的代码高亮，但使用了之后发现效果不是很好，就还是使用默认的样式了。</p>
<p>　　Chi 主题的使用文档暂时就不写了，毕竟这个主题只是 Shaun 个人使用（应该也不会有其他人使用了，万一真有人要用却不太会用，欢迎提 issue，以后酌情考虑添加使用文档 🙃），由于 Shaun 只是前端小白，这个主题也只是当学习练手开发，里面肯定会有各种各样的问题，欢迎提 issue 或 fork 或 clone 后自行修改，提 issue 的话，Shaun 不保证一定能解决，毕竟水平有限，当然如果有代码优化想法还望不吝赐教 (｡･ω･｡)ﾉ♡ （至于 px 换 em 或 rem 就不用提了，没什么原因，主要是 Shaun 懒，更深层的原因在于 Shaun 手头上还没有更高分辨率的显示器，不知道显示差距有多大，不好进行测试 😓）。</p>
<p><strong>PS：</strong> Shaun 使用了 <a href="https://blog.ihoey.com/posts/Hexo/2018-05-27-hexo-code-block.html">Hexo 博客美化代码块| 梦魇小栈</a> 中的脚本对 Markdown 代码部分进行了美化渲染，但是该脚本有时候渲染会出现一些问题，无法进行美化，可能是代码语法格式有错误，这时<em>需要自己手动调整一下 Markdown 代码格式</em>。</p>
<p>使用 Chi 主题推荐安装插件：</p>
<ul>
<li>hexo-renderer-pandoc # 使用pandoc渲染markdown，安装前需卸载默认渲染器hexo-renderer-marked</li>
<li>hexo-generator-feed # RSS订阅</li>
<li>hexo-generator-searchdb # 本地搜索</li>
<li>hexo-abbrlink # 文章唯一永久链接</li>
<li>hexo-all-minifier # 快速压缩优化代码</li>
</ul>
<p>好了，暂时就写到这里了。</p>
<h2 id="后记">后记</h2>
<p>　　当 Shaun 有一天使用其它 blog 框架时，这个主题可能就不再维护更新了，但其中的排版样式应该还会或保留或更新。下面要做的事就不立 Flag 了，因为立了多半会完不成，这就很尴尬了，但不立又没有动力，真是让人脑壳疼啊 (๑•ั็ω•็ั๑)，反正是一件长期要做的事了，长到可能接下来的业余时间可能都在做这件事，或开源或不开源，看以后的心情和完成程度了 （↖(^ ω ^)↗）。</p>
]]></content>
      <categories>
        <category>建站小记</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Windows Terminal 尝鲜小记</title>
    <url>/posts/a250bb21.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　Windows Terminal 正式版在两个月之前终于发布了，正好最近找了点时间尝尝鲜，感觉确实可以，Cmder 可以退休了。</p>
<span id="more"></span>
<h2 id="尝鲜篇">尝鲜篇</h2>
<p>　　直接在 <a href="https://aka.ms/terminal">Microsoft Store</a> 安装，顺便安装好 <a href="https://docs.microsoft.com/en-us/windows/terminal/tutorials/powerline-setup">Powerline</a>，执行以下三个命令：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="POWERSHELL"><div class="code-copy"></div><figure class="highlight hljs powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Install-Module</span> posh<span class="literal">-git</span> <span class="literal">-Scope</span> CurrentUser</span><br><span class="line"><span class="built_in">Install-Module</span> <span class="built_in">oh</span><span class="literal">-my</span><span class="literal">-posh</span> <span class="literal">-Scope</span> CurrentUser</span><br><span class="line"><span class="built_in">Install-Module</span> <span class="literal">-Name</span> PSReadLine <span class="literal">-Scope</span> CurrentUser <span class="literal">-Force</span> <span class="literal">-SkipPublisherCheck</span> // 使用 powershell core 则必选</span><br></pre></td></tr></table></figure></div>
<p>然后执行 <code>notepad $PROFILE</code> ，在弹出的记事本中添加：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="POWERSHELL"><div class="code-copy"></div><figure class="highlight hljs powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> posh<span class="literal">-git</span></span><br><span class="line"><span class="built_in">Import-Module</span> <span class="built_in">oh</span><span class="literal">-my</span><span class="literal">-posh</span></span><br><span class="line"><span class="built_in">Set-Theme</span> Paradox</span><br></pre></td></tr></table></figure></div>
<p>重启 terminal，若出现 “无法加载文件 ***.ps1, 因为此系统上禁止运行脚本”，则需要执行 <code>set-executionpolicy RemoteSigned</code>，使powershell 能顺利执行该脚本。</p>
<p>　　由于目前 Windows Terminal 不会自动注册右键快捷菜单，所以需要手动修改注册表，执行 <code>mkdir "%USERPROFILE%\AppData\Local\terminal"</code> 后，在网上找一个终端图标，命名为 wt_32.ico，将该图标复制到 <code>%USERPROFILE%\AppData\Local\terminal</code> 目录中， 新建 wt.reg 文件后直接双击执行，该注册表文件的内容如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="code"><pre><span class="line">Windows Registry Editor Version 5.00</span><br><span class="line"></span><br><span class="line">[HKEY_CLASSES_ROOT\Directory\Background\shell\wt]</span><br><span class="line">@=&quot;Windows terminal here&quot;</span><br><span class="line">&quot;Icon&quot;=&quot;%USERPROFILE%\\AppData\\Local\\terminal\\wt_32.ico&quot;</span><br><span class="line"></span><br><span class="line">[HKEY_CLASSES_ROOT\Directory\Background\shell\wt\command]</span><br><span class="line">@=&quot;C:\\Users\\[user_name]\\AppData\\Local\\Microsoft\\WindowsApps\\wt.exe&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
<p>其中 [user_name] 是使用者电脑的用户名，wt_32.ico 可以是随便找的一张缩略图，也可以直接用 <a href="https://github.com/yanglr/WindowsDevTools/tree/master/awosomeTerminal/icons">icons - yanglr</a> 中的 wt_32.ico。</p>
<p>　　为了简单美化一下 Windows Terminal 界面，需要安装 <a href="https://github.com/microsoft/cascadia-code/releases">Cascadia Code GitHub releases page</a> 中 Cascadia Code PL 或 Cascadia Mono PL 字体，Shaun 因为只是尝鲜所以就简单配置了一下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="code"><pre><span class="line">&quot;theme&quot;: &quot;dark&quot;,</span><br><span class="line">&quot;profiles&quot;:</span><br><span class="line">&#123;</span><br><span class="line">    &quot;defaults&quot;:</span><br><span class="line">    &#123;</span><br><span class="line">        // Put settings here that you want to apply to all profiles.</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;list&quot;:</span><br><span class="line">    [</span><br><span class="line">        &#123;</span><br><span class="line">            // Make changes here to the powershell.exe profile.</span><br><span class="line">            &quot;guid&quot;: &quot;&#123;61c54bbd-c2c6-5271-96e7-009a87ff44bf&#125;&quot;,</span><br><span class="line">            &quot;name&quot;: &quot;Windows PowerShell&quot;,</span><br><span class="line">            &quot;commandline&quot;: &quot;powershell.exe&quot;,</span><br><span class="line">            &quot;hidden&quot;: false,</span><br><span class="line">            &quot;startingDirectory&quot; : &quot;.&quot;,</span><br><span class="line">            &quot;acrylicOpacity&quot; : 0.00000001,</span><br><span class="line">            &quot;colorScheme&quot; : &quot;Campbell&quot;,</span><br><span class="line">            &quot;cursorColor&quot; : &quot;#00CCFF&quot;,</span><br><span class="line">            &quot;fontFace&quot; : &quot;Cascadia Mono PL&quot;,</span><br><span class="line">            &quot;useAcrylic&quot; : true</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            // Make changes here to the cmd.exe profile.</span><br><span class="line">            &quot;guid&quot;: &quot;&#123;0caa0dad-35be-5f56-a8ff-afceeeaa6101&#125;&quot;,</span><br><span class="line">            &quot;name&quot;: &quot;命令提示符&quot;,</span><br><span class="line">            &quot;commandline&quot;: &quot;cmd.exe&quot;,</span><br><span class="line">            &quot;hidden&quot;: false</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;guid&quot;: &quot;&#123;b453ae62-4e3d-5e58-b989-0a998ec441b8&#125;&quot;,</span><br><span class="line">            &quot;hidden&quot;: false,</span><br><span class="line">            &quot;name&quot;: &quot;Azure Cloud Shell&quot;,</span><br><span class="line">            &quot;source&quot;: &quot;Windows.Terminal.Azure&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></div>
<p>　　为了在 VSCode 中使用 Windows Terminal ，需要简单设置一下默认终端，首先将设置默认终端 <code>"terminal.integrated.shell.windows"</code> 注释掉或者直接不设置，添加设置：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="code"><pre><span class="line">&quot;terminal.external.windowsExec&quot;: &quot;C:\\Users\\[user_name]\\AppData\\Local\\Microsoft\\WindowsApps\\wt.exe&quot;,</span><br><span class="line">&quot;terminal.integrated.fontFamily&quot;: &quot;Cascadia Mono PL&quot;,</span><br></pre></td></tr></table></figure></div>
<p>如此可在 VSCode 中集成 Windows Terminal，并将其作为默认终端。</p>
<h2 id="后记">后记</h2>
<p>　　在这两三天的使用过程中，发现 Windows Terminal 和 Cmder 之间还是存在差距的（如在输入命令过快的时候，tab 键补全跟不上等问题），暂时就两者先并行使用一段时间吧，等后续更新巨硬修复这些问题，相信 Windows Terminal 是能代替 Cmder 成为 Windows 首选终端的。</p>
<h2 id="参考资料">参考资料</h2>
<p>[1] <a href="https://blog.csdn.net/qq_44831027/article/details/107068177">【避坑】PowerShell：因为在此系统上禁止运行脚本 附原因和解决办法</a></p>
<p>[2] <a href="https://www.zhihu.com/question/325948326">新发布的Windows Terminal如何添加到右键菜单？</a></p>
<p>[3] <a href="https://offering.solutions/blog/articles/2020/03/24/setting-windows-terminal-as-default-external-terminal-in-visual-studio-code/">Setting Windows Terminal as Default External Terminal in Visual Studio Code</a></p>
]]></content>
      <categories>
        <category>Share</category>
      </categories>
      <tags>
        <tag>record</tag>
      </tags>
  </entry>
  <entry>
    <title>Windows实用技巧</title>
    <url>/posts/27a4c8b6.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　本篇主要用来记录在 Windows 下使用命令行能做到的一些特殊技巧。</p>
<span id="more"></span>
<h2 id="windows-粉碎文件技巧">Windows 粉碎文件技巧</h2>
<p>　　有时候 Windows 下会莫名出现文件无法删除的现象，即使通过 Shift+Delete 组合键也还是无法删除，这时可能需要通过一种 “文件粉碎机” 的工具才能删除，但是为了偶尔出现的这种现象而安装一个这样的工具又略显麻烦，这时只需要新建一个 Windows 批处理文件，即新建一个 txt 文本文件，并将后缀改为 .bat 即可，文件内容输入：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BAT"><div class="code-copy"></div><figure class="highlight hljs bat"><table><tr><td class="code"><pre><span class="line"><span class="built_in">DEL</span> /F /A /Q \\?\%<span class="number">1</span></span><br><span class="line"><span class="built_in">RD</span> /S /Q \\?\%<span class="number">1</span></span><br></pre></td></tr></table></figure></div>
<p>其中</p>
<blockquote>
<p><strong>DEL 表示删除文件，命令参数为： del /?</strong></p>
<p>/F：表示强制刪除</p>
<p>/A：选择文件的属性</p>
<p>/Q：静默模式，在删除时不会弹出提示信息</p>
<p><strong>RD 表示刪除目录，命令参数为： rd /?</strong></p>
<p>/S：连带删除子目录下的文件</p>
<p>/Q：静默模式，在删除时不会弹出提示信息</p>
</blockquote>
<p>　　具体用法为将待删除的文件拖拽到该 .bat 文件图标上，用该 .bat 文件打开待删除的文件即可。</p>
<p>　　但有时候即使使用上面的方法，也无法删除文件，同时还会弹出“无法删除文件，文件或目录损坏且无法读取”这样的提示，这可能是文件存储时发生错误造成的，此时需要在 Windows 命令提示符界面中输入命令 <code>CHKDSK 盘符:/F</code>，盘符为需要删除的文件所在的磁盘或 U 盘，比如在 D 盘，则输入命令 <code>CHKDSK D:/F</code>，如出现无法锁定的提示信息，则输入 <code>Y</code> 强制卸载该卷，等待一段时间，等磁盘扫描和修复完成后即可删除待删除的文件。</p>
<h2 id="windows-校验文件技巧">Windows 校验文件技巧</h2>
<p>　　为确保从网络上下载的文件为原文件，一般需要对其进行 hash 校验（如 SHA1、SHA256、SHA384、SHA512、MACTripleDES、MD5、RIPEMD160 值等），一般随原文件一起释放的比较常见的 hash 值有 SHA1、SHA256 或 MD5 等，但是为了校验下载文件的 hash 值可能需要专门的第三方工具，但其实 Windows 、Linux 和 macOS 都自带了校验 hash 值的命令，通过这些命令可以直接对文件的 hash 值进行校验，而不需要使用额外的第三方工具，这里只介绍 Windows 的哈希值校验命令，其命令为 <code>Get-FileHash</code>，具体使用方法如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># []内为待校验的文件 和 所用的hash算法</span></span><br><span class="line">Get-FileHash [文件路径及名称] -Algorithm [校验的Hash值类型]| Format-List</span><br></pre></td></tr></table></figure></div>
<p>　　如果觉得每次这样输入比较麻烦，可以使用<strong>参考资料[2]</strong>提供的注册表文件（.reg 后缀），双击运行，即可在鼠标右键菜单添加「文件哈希校验」，如此可以通过鼠标右键直接对文件进行 hash 校验。附其中代码如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="code"><pre><span class="line">Windows Registry Editor Version 5.00</span><br><span class="line"></span><br><span class="line">[HKEY_CLASSES_ROOT\*\shell\文件哈希校验]</span><br><span class="line"></span><br><span class="line">&quot;SubCommands&quot;=&quot;MACTripleDES;MD5;RIPEMD160;SHA1;SHA256;SHA384;SHA512&quot;</span><br><span class="line"></span><br><span class="line">&quot;MUIVerb&quot;=&quot;文件哈希校验&quot;</span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\CommandStore\shell\MACTripleDES]</span><br><span class="line"></span><br><span class="line">@=&quot;MACTripleDES&quot;</span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\CommandStore\shell\MACTripleDES\command]</span><br><span class="line"></span><br><span class="line">@=&quot;PowerShell Get-FileHash -Algorithm MACTripleDES \\\&quot;%1\\\&quot; | format-list;“按任意键退出...”;[Console]::Readkey() | Out-Null;exit&quot;</span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\CommandStore\shell\MD5]</span><br><span class="line"></span><br><span class="line">@=&quot;MD5&quot;</span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\CommandStore\shell\MD5\command]</span><br><span class="line"></span><br><span class="line">@=&quot;PowerShell Get-FileHash -Algorithm MD5 \\\&quot;%1\\\&quot; | format-list;“按任意键退出...”;[Console]::Readkey() | Out-Null;exit&quot;</span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\CommandStore\shell\RIPEMD160]</span><br><span class="line"></span><br><span class="line">@=&quot;RIPEMD160&quot;</span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\CommandStore\shell\RIPEMD160\command]</span><br><span class="line"></span><br><span class="line">@=&quot;PowerShell Get-FileHash -Algorithm RIPEMD160 \\\&quot;%1\\\&quot; | format-list;“按任意键退出...”;[Console]::Readkey() | Out-Null;exit&quot;</span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\CommandStore\shell\SHA1]</span><br><span class="line"></span><br><span class="line">@=&quot;SHA1&quot;</span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\CommandStore\shell\SHA1\command]</span><br><span class="line"></span><br><span class="line">@=&quot;PowerShell Get-FileHash -Algorithm SHA1 \\\&quot;%1\\\&quot; | format-list;“按任意键退出...”;[Console]::Readkey() | Out-Null;exit&quot;</span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\CommandStore\shell\SHA256]</span><br><span class="line"></span><br><span class="line">@=&quot;SHA256&quot;</span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\CommandStore\shell\SHA256\command]</span><br><span class="line"></span><br><span class="line">@=&quot;PowerShell Get-FileHash -Algorithm SHA256 \\\&quot;%1\\\&quot; | format-list;“按任意键退出...”;[Console]::Readkey() | Out-Null;exit&quot;</span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\CommandStore\shell\SHA384]</span><br><span class="line"></span><br><span class="line">@=&quot;SHA384&quot;</span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\CommandStore\shell\SHA384\command]</span><br><span class="line"></span><br><span class="line">@=&quot;PowerShell Get-FileHash -Algorithm SHA384 \\\&quot;%1\\\&quot; | format-list;“按任意键退出...”;[Console]::Readkey() | Out-Null;exit&quot;</span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\CommandStore\shell\SHA512]</span><br><span class="line"></span><br><span class="line">@=&quot;SHA512&quot;</span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\CommandStore\shell\SHA512\command]</span><br><span class="line"></span><br><span class="line">@=&quot;PowerShell Get-FileHash -Algorithm SHA512 \\\&quot;%1\\\&quot; | format-list;“按任意键退出...”;[Console]::Readkey() | Out-Null;exit&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
<h2 id="windows-隐写文件技巧">Windows 隐写文件技巧</h2>
<p>　　在 Windows 下可以通过 <code>copy</code> 命令实现简单的文件合并，即隐写，例如：将压缩文件隐写入 jpg 文件中，将 txt 文件隐写入 jpg 文件中。这样在没改后缀名的情况下，该文件是以图片形式存在，若要恢复原有隐写文件信息，则只需要将 jpg 后缀名更改为相应文件后缀名，例如：若隐写的是 rar 文件，则只需将后缀名 .jpg 改为 .rar ，再用解压缩软件打开即可，也可以直接用解压缩软件打开相应 jpg 文件；若隐写的是 txt 文件，则需要用记事本打开该文件，通过 ctrl+end 组合键让光标定位到文件最末尾，即可看到隐写的 txt 文件内容。</p>
<p>具体命令如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 将 b.txt 隐写进 a.jpg 中，并输出为 c.jpg</span></span><br><span class="line">copy/b a.jpg+b.txt c.jpg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将当前目录下 2.rar 隐写进 1.jpg 中，并输出为 3.jpg</span></span><br><span class="line">copy /b ./1.jpg + ./2.rar ./3.jpg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 b.txt 隐写进 a.jpg 中，并输出为 c.jpg</span></span><br><span class="line">copy a.jpg /b + b.txt /a c.jpg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 b.rar 隐写进 a.jpg 中，并输出为 c.jpg</span></span><br><span class="line">copy a.jpg /b + b.rar c.jpg</span><br></pre></td></tr></table></figure></div>
<p><em>※注：图片文件要放在前面，需要隐写的信息放在后面，不然输出的图片无法正常查看和显示</em>。</p>
<p>　　其中参数 <code>/b</code> 表示以二进制格式复制、合并文件，在合成图片和压缩文件等二进制文件时必须使用该参数，不然会丢失信息，从而造成合成失败，当然合成 txt 文本文件时也可以使用该参数；参数 <code>/a</code> 表示以 ASCII 码格式复制、合并文件，参数 <code>/a</code> 只适用于 txt 文本文件合并。</p>
<p>　　至于其它需要注意的就是：<em>1、要合成的两个文件最好放在同一目录下，不然输入路径有点麻烦； 2、txt 文本文件前面最好空三行，这样它头部的内容就不会丢失</em>。</p>
<p>　　输出的图片 c.jpg 和原图片 a.jpg 显示是一样的，看起来就是同一张图片，因此达到隐写的目的。</p>
<h2 id="win10-开启休眠方法">Win10 开启休眠方法</h2>
<p>　　不知道巨硬是怎么肥事，居然 Win10 中默认电源选项中没有「休眠」选项，需要手动开启。虽然睡眠和休眠有重叠的地方，但是休眠是完全关机，再次开机时会恢复原有工作状态，更多的情况是必须要关机（因为需要考虑电量情况），相反如果有充足电力的情况下，还不如使用锁定代替睡眠，从这里的需求看还不如在默认电源选项中去掉「睡眠」选项。好了，抱怨吐槽的话就说这么多了，具体开启「休眠」的方法为：只需要在命令行（需要以管理员身份打开「命令提示符」）中输入一下命令：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BAT"><div class="code-copy"></div><figure class="highlight hljs bat"><table><tr><td class="code"><pre><span class="line">powercfg /H on</span><br></pre></td></tr></table></figure></div>
<p>回车 执行即可在电源选项中发现「休眠」选项。</p>
<h2 id="windows-新建用户命令">Windows 新建用户命令</h2>
<p>　　前一段时间电脑系统升级之后崩了，资源管理器损坏，没有任务栏，没有桌面，Win 键都无法使用，还好可以使用任务管理器，通过任务管理器调出 cmd，输入以下命令新建一个用户：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 添加用户tmp、密码123  </span></span><br><span class="line">net user tmp 123 /add  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 设置tmp为管理员  </span></span><br><span class="line">net localgroup administrators tmp /add  </span><br></pre></td></tr></table></figure></div>
<p>　　通过 tmp 用户可以正常使用电脑，因此猜测应该是原来的用户系统配置文件（例如注册表文件，系统设置文件等等）损坏。系统损坏之后捣鼓了两天，这没办法修复了，即使新建用户也还是有些软件没法使用，还不如直接重装系统（系统出现问题果然重装系统才是最快的解决方案），还好可以新建用户以备份原有系统盘文件，不然就是真 gg 了。既然新建命令记录了，也顺便记录一下删除命令吧，删除用户 tmp 命令为：<code>net user tmp /del</code> 。</p>
<h2 id="windows-解除-u盘或移动移动硬盘被占用技巧">Windows 解除 U盘或移动移动硬盘被占用技巧</h2>
<p>　　Windows 在弹出 U盘或移动硬盘时，有时会出现 “该设置正在使用中，请关闭可能使用该设备的所有程序或窗口，然后重试。” 的提示，导致 弹出 USB 大容量存储设备时出现问题，无法弹出。解决该问题需要知道是那个或哪些程序占用该存储设备，然后结束该进程即可。查看存储设备占用程序 Shaun 知道的有两种方法：</p>
<ol type="1">
<li>通过 “Windows 日志”。Windows 每次弹窗提示都会有相应的日志，右键计算机 ==》管理 ==》事件查看器 ==》Windows日志 ==》系统，然后在窗口左侧查找其中有黄色警告的日志信息，找到来源为 <em>Kernel-PnP</em> 的日志，双击该日志即可看到 “进程 ID 为 XXX 的应用程序 XXX 已停止删除或弹出设备 XXX。” 之类的信息，从而知道是哪个进程占用该存储设备，停止该进程即可正常弹出。停止进程一般通过 任务管理器 ==》详细信息，找到对应的 名称 和 PID，右键 ==》结束任务即可。</li>
<li>通过 “资源监视器”。右键计算机 ==》管理 ==》性能，打开资源监视器。然后在 “CPU” 栏中找到 “关联的句柄”，在后面的搜索栏中输入存储设备的盘符（D: 、E: 或 F: 等 ），即可显示占用程序的 名称 和 PID，随后在任务管理器中停止该进程即可。</li>
</ol>
<p>　　<strong><em>※注：</em></strong> 有时只有 System 进程阻止存储设备弹出，这时可以直接关机了 :），因为 System 进程是系统核心进程，不能结束，结束之后系统会崩溃，并自动关机。当然，如果是其他进程阻止，可以用上述方法正常弹出，一般阻止存储设备弹出的都是 explorer.exe，在停止该进程后，Windows 的任务栏将会消失，所以需要在任务管理器中重新运行该任务（任务管理器 ==》文件 ==》运行新任务， 输入 “explorer” 即可）。</p>
<h2 id="后记">后记</h2>
<p>　　如果以后碰到更多有意思的小技巧再继续和大家分享吧 ↖(^ω^)↗。</p>
<h2 id="参考资料">参考资料</h2>
<p>[1] <a href="https://www.jianshu.com/p/a86d89c78d33">windows文件夹删不掉怎么办</a></p>
<p>[2] <a href="https://www.windows10.pro/right-click-menu-verifying-hash-value/">巧在Win10右键菜单添加校验文件Hash值命令（MD5、SHA1/256等）</a></p>
<p>[3] <a href="https://jingyan.baidu.com/article/72ee561a865508e16138df05.html">【命令行copy命令】将txt文档与jpg图片合并</a></p>
<p>[4] <a href="https://answers.microsoft.com/zh-hant/windows/forum/windows_10-start-winpc/%E5%8D%87%E7%B4%9Awin10%E5%BE%8C%E7%82%BA%E4%BD%95/081e227d-a97e-4319-a726-1c1ded999d02">升級Win10後，為何筆電專有的休眠選項消失了</a></p>
<p>[5] <a href="https://blog.csdn.net/scimence/article/details/47803873">CMD命令（添加删除管理员账户）</a></p>
]]></content>
      <categories>
        <category>Share</category>
      </categories>
      <tags>
        <tag>record</tag>
      </tags>
  </entry>
  <entry>
    <title>一张纹理做天空盒</title>
    <url>/posts/39a3c99e.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　前段时间做了一件很有意思的事，使用一张普通纹理图片做成了一个天空盒（SkyBox），其实是半个，因为最终形成的天空盒是上下对称的，看起来有天空之境的感觉。</p>
<span id="more"></span>
<h2 id="天空盒篇">天空盒篇</h2>
<p>　　常见的天空盒一般采用立方体包围盒做 geometry，再使用 CubeMap 将 6 张纹理图贴到立方体包围盒上，但是如果只用一张纹理图片，要映射到立方体包围盒上，无论怎么展 UV，都会造成部分棱和顶点 UV 聚集或突变，从而在这样的地方造成贴图扭曲或错位的不协调现象。</p>
<p>　　既然立方体包围盒不可行，就只有采用另一种 geometry —— 球 了，但是直接用球作为 geometry 会造成两种问题：1、球的极点处会有扭曲现象，因为球极点处的 UV 是聚集的，同一个位置，V 都为 1 或 0，而 U 则为 [0, 1] 都有，即在该位置处一个 V 对应多个 U，自然会造成扭曲；2、由于球是一个圆周，所以 U 为 0 的位置和 U 为 1 的位置是同一个，对于一张普通纹理图，这就会造成错位，能看到非常明显的接缝线。所以需要重新展开球面的 UV，而常见的展 UV 方法主要有以下几种：</p>
<ol type="1">
<li>对于平面，uv 坐标自然通过线性归一化解决，取左下角坐标和右上角坐标，得到平面的宽度和长度，再用当前坐标减去左下角坐标，最后除以平面宽度和长度得到 uv 坐标。</li>
<li>对于球面，自然是取水平方位角 <span class="math inline">\(θ, \theta \in [-\pi, \pi]\)</span> 和 垂直仰角 <span class="math inline">\(φ, φ\in [0, \pi]\)</span> 作为 uv 坐标。对于 threejs 而言，方位角在 XZ 平面上，可计算 <span class="math inline">\(\theta = Math.atan2(z, x)\)</span>，仰角 <span class="math inline">\(φ = Math.acos(-y)\)</span>，其中 <span class="math inline">\(x,y,z\)</span> 为当前坐标归一化后的值，则 <span class="math inline">\(u = (θ +\pi)/(2*\pi)\)</span>，<span class="math inline">\(v=φ/\pi\)</span>。</li>
<li>对于一般的曲面，可能会依据当前顶点的法线计算 uv 坐标。对法线向量 x,y,z 三个分量的值进行排序，取最小的两个作为 uv，或者将最小的两个除以最大的一个作为 uv（CubeMap 中通常用这种进行 6 个面的纹理映射，最大的那个决定映射 6 个面中的哪一面），或者取固定的两个分量作为 uv ，或者得到最小的两个分量索引取对应顶点坐标的分量值作为 uv 等等，若 uv 取值为 [-1,1]，则还需要做 <span class="math inline">\(uv = uv *0.5+0.5\)</span> 。根据法线计算 uv 一般需要根据不同的使用情况选择不同的 uv 计算策略。</li>
</ol>
<p>　　Shaun 很快的解决了第二个问题，想要将一张普通纹理图片贴在整个球面上而不留下接缝线是不现实的，而铺在半个球面上，另一半球面做对称，这个是可行的，而且看起来的效果也不错，计算 uv 就很简单了，原始的 v 不需要改变，只需要将 u 从 [0, 0.5] 映射为 [0, 1]，从 [0.5, 1] 映射为 [1, 0]，即 <span class="math display">\[
f(u)=\begin{cases} 2*u,　0 \le u \le 0.5 \\ 2*(1-u),　0.5 \le u \le 1 \end{cases}
\]</span> ，接缝线问题使用对称性巧妙的解决了，但第一个问题，极点扭曲现象，还是没法解决，接下来才是真正的难点 ╯︿╰。</p>
<p>　　为了解决极点扭曲问题，首先需要知道极点扭曲的根本原因是同一个位置对应了多个 uv，所以要么将这些 uv 给散开，要么抛弃一部分 uv，散开 uv 的方式 Shaun 没想出来，抛弃一部分 uv 倒是有一种简单的方式，不过抛弃 uv 也意味着会损失一部分纹理，就这个天空盒而言，抛弃一部分 uv 是能接受的，不然平面到球面必然有形变。具体抛弃方法为，将球面铺平，变为一个大圆面，即忽略球面顶点坐标的 z 值，求出球的 AABB，将 AABB 铺平，即为大圆的外接正方形，用计算平面 uv 的方式重新球上各顶点的 uv 坐标，这种方式的确能解决极点扭曲的问题，但又带来了一个更为严重的问题。</p>
<p>　　这个问题就是，球面上半部分显示很正常，但是越靠近底部大圆的部分，纹理拉伸的越厉害，造成天空盒四周都出现很严重的纹理拉伸现象。出现纹理拉伸现象的原因也很好理解，那就是越靠近底部大圆的顶点，uv 坐标之间的间隔越小，即同样的 uv 间隔，顶点之间的距离变大了，在进行纹理插值时，自然会导致纹理拉伸现象。知道问题出现的原因了，那怎么解决了？这又是一个新问题 😔。</p>
<p>　　导致纹理拉伸现象的原因是线性映射，那能不能对计算好的 uv 进行非线性映射，从而抵消 OpenGL 线性纹理插值的影响，非线性映射最重要的是找到合适的非线性函数，常见非线性函数一般有幂函数（伽马变换就是一种幂函数变换，幂 &lt; 1 拉伸小值，幂 &gt; 1 拉伸大值），对数函数，指数等，对于 Shaun 这里的情况，常规的非线性函数肯定是不行的，只能自己想一个函数。</p>
<p>　　注意到，这是在球面上，要取一个非线性映射函数，自然需要从圆的弧长入手，先计算圆的弧长。计算弧长的本质是勾股定理 <span class="math inline">\(ds=\sqrt{(dx)^2 + (dy)^2} = \sqrt{1+(dy/dx)^2} * dx\)</span>，对于圆 <span class="math inline">\(x^2 + y^2 = r^2,　y \ge 0\)</span>，即 <span class="math inline">\(y=\sqrt{r^2-x^2}\)</span>，有 <span class="math inline">\(dy/dx = -x/ \sqrt{r^2-x^2}\)</span>，则对于圆的弧长 <span class="math inline">\(L=\int \sqrt{1+x^2/(r^2-x^2)}dx = r \int 1/ \sqrt{1-(x/r)^2}d(x/r) = r*arcsin(x/r)|\)</span>，即对于圆在第一象限的弧长可以为 <span class="math inline">\(L=r*arcsin(x/r),　0\le x \le r\)</span> 。</p>
<p>　　由于 v 是均匀的，所以只需要对 u 进行拉伸即可，离圆心越近的点，则越接近 0.5， 离圆心越远的点则越偏离 0.5，非线性拉伸公式为 $ u = α * (u-0.5) + 0.5$，其中 <span class="math inline">\(α = L / (\pi*r/2),　L中的x为点到圆心的距离\)</span>，使用这种拉伸后，天空盒四周的纹理拉伸现象确实不见了，但是又引入了新的问题，天空盒顶部出现了局部拉伸现象，出现微弱的纹理模糊，虽然区域不大，依靠一些手段可以让用户看不到这块区域，但是不能自欺欺人，这一块存在总让 Shaun 觉得很不舒服，于是，就有了下面的终极解决方案。</p>
<p>　　Shaun 最终想出解决方案是：既然单纯的拉伸不能完美解决问题，那还是只能从问题根源入手，完全重新计算 uv 坐标，这次计算 uv 坐标，还是需要借助上文的 <span class="math inline">\(α\)</span>。具体计算 uv 坐标的方式如下：</p>
<ol type="1">
<li>先计算球面上顶点相对大圆圆心的角度，即 <span class="math inline">\(angle = Math.atan2(y - center.y, x - center.x)\)</span>，其中 center 即为大圆圆心（0, 0）。</li>
<li>根据顶点到圆心的距离得到 <span class="math inline">\(\alpha\)</span>，计算 <span class="math inline">\(α_x = α * cos(angle)， α_y=α * sin(angle)\)</span> 。</li>
<li>计算 uv：<span class="math inline">\(u = α_x * 0.5 + 0.5， v=α_y*0.5+0.5\)</span> 。</li>
</ol>
<p>　　使用这个方式计算 uv，天空盒的全部问题都解决了，天空盒没有任何拉伸扭曲等令人看起来不协调的地方，至于对称也说的过去，Shaun 个人感觉挺漂亮的 (￣▽￣)"。自此天空盒的事就算是告一段落了。</p>
<h2 id="后记">后记</h2>
<p>　　做这个天空盒，确实花费了 Shaun 了不少力气，在做的那两天，满脑子都是为什么会拉伸扭曲，以及如何解决拉伸扭曲，最终想出了这套方案，简单优雅，最后的效果也是完美达到了 Shaun 的预期。不过一般人应该也用不到 Shaun 这套方案，这只是 Shaun 自己想做做而已，搞不出来没关系，搞出来当然是好的。</p>
]]></content>
      <categories>
        <category>Image&amp;Graphic</category>
      </categories>
      <tags>
        <tag>algorithm</tag>
      </tags>
  </entry>
  <entry>
    <title>个人游记</title>
    <url>/posts/abe58f8c.html</url>
    <content><![CDATA[<p>　　简单的记录一下个人游记吧。</p>
<span id="more"></span>
<h2 id="张家界两日游">张家界两日游</h2>
<h3 id="前言">前言</h3>
<p>　　端午节前一个星期，正好也做完了人生中的一件大事，遂和小伙伴们来了场说走就就走的旅行，也是 Shaun 人生中第一次正式旅行吧，直接定好晚上的火车票，睡一觉，到张家界的时候正好是中午。</p>
<h3 id="旅程篇">旅程篇</h3>
<h4 id="第一天下午">第一天下午</h4>
<p>　　在火车站附近简单的吃了个三下锅，就 Shaun 感觉是个大杂烩，里面就是些很常见的菜混合在一起，当然也可能吃的不正宗，然后决定先去天门山，在美团上看票，发现需要提前一天，于是决定直接去售票处买票，去的过程中差点被无良司机坑了，就几百米的路还要收 10 块钱，幸好问了饭店老板，知道直接去<strong>索道公司</strong>买票就行，地图搜索，买票点离火车站就几百米，遂一行人步行过去，到索道公司的时候发现这里的票价和美团上的价格是一样的，不亏，于是选了A线：索道上山，大巴下山，由于时间关系，只走了天门山的 3/4 吧，基本算是匆忙转了一圈，顺便花 5 块钱走了下西边的玻璃栈道，说实话对玻璃栈道还是挺失望的，由于走的人太多了，玻璃表面都磨花了，下面的景色看不清楚，刺激感也少了许多，5 点半左右，快下山的时候，突然下起了大雨，此时走步行的天梯下天门有点危险，不得已只能每人花 30 块钱坐电梯（这是在天门山游玩花的最不值的一笔钱 (╯‵□′)╯︵┻━┻），因为在下山到天门的那一段路就是一段很长很长的山内电梯，这种感觉已经体验到了，到时步行下天梯的感觉想尝试一下，奈何天公不作美。等到完全走完电梯的时候，开始上巴士，天门山的雨又停了，也是醉了 😓。接下来，就是 Shaun 坐得最爽的一次巴士了，秋名山和天门山的天路简直不是一个档次的，五连发卡弯和天路相比也不算什么，这里的盘山公路从索道上看起来非常漂亮，但真正坐巴士在盘山公路上走的时候，就会发现，巴士司机才是真正的车神，这车坐的可以说是非常刺激了。</p>
<h4 id="第一天晚上">第一天晚上</h4>
<p>　　走了一下午路，人都疲了，就在市区吃了个自助餐，也不好吃，随后讨论了下第二天的行程，由于时间关系，张家界大峡谷（有玻璃桥的那个景区）和张家界的武陵源（最大最有名的景区） 只能选择去一个了，考虑到张家界大峡谷离市区太远而且没去武陵源何谈到张家界玩，所以最终选择了武陵源，武陵源的门票有 3 天的有效期（可以游玩三天，后面进景区发现，若真要慢慢游玩，3 天还不一定能玩完），因为这景区非常大，所以还有年票卖 😂（一年的有效期）。于是当晚吃完饭就联系了个武陵源景区附近的一个客栈，顺便让客栈的老板叫辆车接我们过去，到客栈的时候都已经11点了，客栈老板问了下我们的时间安排，于是给我们安排了下游玩路线，老板顺便做起了导游的生意，由于我们人多，老板就没另收导游费了，因为当地人买索道票价格是半价的，所以这足以让老板赚上一笔，谈好生意后，就洗澡睡觉了。</p>
<h4 id="第二天全天">第二天全天</h4>
<p>　　因为和老板约好几点去买门票，所以就大早起床了，顺便买了些午餐，因为中午肯定还在山上，没记错的话，武陵源景区共有3个索道：黄石寨索道、杨家界索道和天子山索道。其中黄石寨索道可坐可不坐，如果准备一天的时间玩黄石寨可以不坐索道，徒步也行，但杨家界索道必须得坐，因为这是去杨家界的必经之路，徒步是到不了的，当然可以也可以在景区外包车去杨家界，因为徒步基本不可行，所以老板就推荐我们坐索道上去，然后包车下来，这样更划算一些（我们人多），车也是老板帮忙叫的，由于选择了包车下来，所以也就没坐天子山索道了，因为天子山索道比较特殊，它的索道下站是在景区外面，到时又要打车到客栈。老板让我们在景区门外一个地方买完门票之后（导游可以便宜几块购买门票），拿着门票就进进去了，第一个地方去的地方是黄石寨，由于赶时间所以买了双程票，索道上和索道下，大约玩了黄石寨 1/3 的地方，就下来了，又坐景区大巴赶往杨家界索道，坐索道去杨家界，主要看了个个天波府，然后坐景区大巴去袁家界，看了天下第一桥和阿凡达的取景地，最后坐大巴去了天子山，天子山上的天子阁我们刚到的时候正好关门 😔，没办法只好去贺龙公园下的观景台了，但是时机也不好，看不到云海，只能看看石柱山了，看完之后，天色也不晚了，老板也催着我们赶快坐车回去了，包车的那人在等了。虽然坐了索道，但还是走了一天，全员都乏了，不想去第三天的金鞭溪了，但是好不容易出来一趟，又硬着头皮上了。</p>
<h4 id="第三天上午">第三天上午</h4>
<p>　　本来老板说好的提前两小时带我们进景区，游完金鞭溪还能去看看十里画廊，但因为一些小插曲，我们最后还是只能准点进景区，搞得我们在外面冻了半个多小时（那天早上很冷），我们徒步金鞭溪，以为会有景区大巴回到起点，但是没想到，我们走了一上午走完金鞭溪，发现前头确实有个景区车站，但是不能直接到我们来的那个起点，可能要绕很长一段距离，基于这些不确定性，最终还是决定原路返回，加快速度也要走近两小时，本来就已经很累了，这非常难受了，但没办法，定的火车票就在下午，周一还要赶回去上班 /(ㄒoㄒ)/~~。最后还是比较顺利的坐上了景区到火车站的中巴车，顺利的赶上了火车。</p>
<h3 id="感想篇">感想篇</h3>
<p>　　这次游玩张家界，感觉天门山虽小，但是比武陵源好玩多了，主要是武陵源的山千遍一律，黄石寨就围绕一座山有几十个景点，也是绝了 🙄。杨家界的天波府虽然难上，但上去还是很值得的，袁家界的猴子很多，运气好的话，能看到猴子在树上跳来跳去的，就像杂耍一样，袁家界比杨家界要更值得一去。天子山其实就一个观景台够看，但也要好时机，如果有云海的话相信是武陵源最漂亮的一个景点之一。在袁家界有个比较坑的产品，叫 把你的名字用一幅画写出来，那个人在我们外行人眼里看来还是很厉害的，边画的时候还会说很多吉祥话，这幅画只卖 5 块，怎么样，还是很值得吧 🙃，但是等画完之后，那人会叫你去后面胶缝，不然就花了嘛，胶缝 20 多块，但是不胶缝，5 块钱就白花了，这要明说还好，毕竟这手艺应该也值这价，但这样暗地里搞事就很没意思了。还有一种晶莹剔透的粉色水果，看起来非常漂亮，说是张家界的特产，但是很贵，Shaun 就只能远远的看着，后面查了下发现这就是传说中的金西梅 (¬◡¬)✧。</p>
<h3 id="后记">后记</h3>
<p>　　总而言之，张家界还是挺值得一去的，就是要规划好路线和时间，一天半的时间，武陵源景区大概只玩了 1/2 不到，还是算走的快的了 ( ╯□╰ )。其实原来不去黄石寨的话，直接去杨家界，然后坐天子山索道下来，再坐景区大巴到金鞭溪和十里画廊的交界处感觉会更好些。</p>
<h2 id="桂林两日游">桂林两日游</h2>
<h3 id="前言-1">前言</h3>
<p>　　人生终于告一段落了，要开始新的阶段了，于是决定趁着退休前的最后一次真正意义上自由自在的长假出去玩一下，虽然想玩的想法早就有了，但一直没想好去什么地方，邻近放假前两天才想好去桂林，于是匆忙查了下桂林的景点以及买了火车票，简单的规划了一下路线，就出发了，剩下的到了桂林再说。</p>
<h3 id="旅程篇-1">旅程篇</h3>
<h4 id="第一天上午">第一天上午</h4>
<p>　　前一天晚上在上火车的时候就决定先去阳朔玩玩，于是就在 X团 上买了桂林到阳朔的船票，晚上的时候，旅游公司打来电话确定明天的接送大巴地点和时间，正好是早上的时候到桂林，也能赶上接送大巴，所以就决定坐他们的大巴去码头坐船了，在等大巴的时候，顺便花 5 块钱吃了正宗的桂林米粉以及在虞山公园里转了一圈。等到坐上大巴的时候，导游开始推荐特色食物了，先是试吃环节，可是 Shaun 就一个人去玩，导游就直接把 Shaun 忽略了，独游没人权吗？连个试吃的机会都不给 😥。送到码头之后，导游帮我们把船票取了，上了船之后，这船坐起来还行，比 Shaun 以前在宜昌去三峡坐的船确实要好很多，在没坐船之前，导游一直在推销升舱，即从一楼升到二楼，到了船上之后，发现一楼和二楼没什么两样，无非就是二楼更高一点，但要看到好点的景色还是要到三楼甲板上，当然二楼甲板也能看，游客能随便选择去哪，所以升舱的意义确实不大。经过近四个小时，船终于到了阳朔，这中间主要是看了下漓江周围的山，最有名的应该就是 20 元人民币的背景和九马画山了，至于漓江的水，由于去的时机不对，没法看。</p>
<h4 id="第一天下午和晚上">第一天下午和晚上</h4>
<p>　　本来第一天下午的行程没想好，后来坐大巴到码头的时候听到导游说，他们下午会去银子岩，于是 Shaun 也就到美团上买了阳朔到银子岩的票，于是下午中午到了阳朔时就坐大巴跟随另一个导游去银子岩，同样导游在车上也推荐了同样的食品，这次到没有忽略 Shaun，还是给试吃了下，味道也还行，就是太贵了，后来 Shaun 偷偷的在淘宝上搜了下，淘宝上的价格和导游给的价格一样。经过近一个小时到了银子岩，银子岩这个景点其实不归阳朔管，属于另一个县，本以为在山洞里会凉爽一些，但可能是由于人太多了，也可能是当天的天气原因，导致里面比外面还要闷热，幸好里面有很多台风扇，不然真有人可能会在里面中暑了，里面的景色确实还可以，灯光打的也不错 ๑乛◡乛๑。银子岩有着和张家界同样的套路：一样的金西梅，一样的名字作画，也是有意思。</p>
<p>　　从银子岩出来再坐原来的大巴到阳朔，在车上用飞猪定了个青年旅社，于是到阳朔的时候，就直奔那个青旅了，把背包放下，出去吃了个简单的晚餐，在回到青旅小睡了下，时间正好来到了晚上 8 点，可以去逛逛大名鼎鼎的阳朔西街了。来到西街，如果说白天的西街是死的，那么晚上的西街就是活的，这差距太大了，可能同样是时机不对，并没有出现人挤人的情况，但里面的人还是很多，歪果仁也不少，酒吧里的小姐姐也很可以。逛完阳朔西街给我留下最深印象的就是音乐喷泉的老板很有意思，很会招揽顾客，又不至于让顾客下不了台，就图个乐呵；比较后悔的就是没有拍一个陈文令的雕塑，主要原因是当时进西街的时候，就看到个小红人，以为就是个很普通的雕塑，根本没预料到这种雕塑遍布西街，是一个系列，所以就完全没有拍照的想法，又加上后面再看到的时候，感觉前面的都没拍，所以这个也就不拍了，导致一个都没拍，包括那些克苏鲁风格的也没拍。从西街回到青旅，已经快 11 点了，于是赶忙准备下明天的行程，在美团上看了下，就决定直接报个完整的跟团游，首先去十里画廊，再去遇龙河漂流，最后去世外桃源。下了单之后，就简单的洗了个澡睡觉了，毕竟逛了一天也累了。</p>
<h4 id="第二天白天">第二天白天</h4>
<p>　　跟随这次旅途中的第三个也是最后一个导游，先坐大巴来到了十里画廊，导游在大巴上告诉我们，吃啤酒鱼就要去西街上装饰最好的地方去吃，那样才能彰显自己的壕气 ๑乛◡乛๑，导游还告诉我们今天到十里画廊的朋友坐了全世界最贵的一趟的大巴，仅 20 分钟的路程就要 60 块，因为十里画廊是不要门票的，就只要花 20 块钱买张公交通票就行，哭唧唧 (ノへ￣、)，到了十里画廊，导游帮我们买好通票之后就带另一批人去往银子岩了。Shaun 就坐着十里画廊景区内的公交到处逛了，十里画廊景区还是很大的，远不止十里，那天的天气去十里画廊正好，阴雨朦胧，景区内的月亮山雨雾缭绕，十里画廊周边的景区都是要另外算钱的，而且由于时间关系，所以 Shaun 就也就没进去了，简单的坐车逛了下十里画廊，回到和导游约定地点的时候，已经中午12点，于是导游把我们拉到了一个饭馆吃饭，导游先征求了下我们的意见是吃团餐还是独自解决，因为 Shaun 就一个人，所以还是想跟着大家吃团餐的，但是由于队伍里有一家人共十几个，他们一投票，自然是独自解决了，于是 Shaun 只能和别人搭伙了，于是就吃了顿又贵又难吃的午餐，搭伙的人点菜品味太差劲了，尤其是点了个什么野菜，那还真是野菜啊，就是一个像蒲公英一样的植物，那在 Shaun 老家可是真正的猪食 🤮。</p>
<p>　　吃完饭就去遇龙河了，但由于当时的天气，导游就预测今天应该是不能漂流了，因为头天晚上下了很大的雨，由于一些原因，导游也不确定是否能漂流，所以他还是带我们先去遇龙河看一下到底能不能漂流，等到了遇龙河，发现果然漂不了，于是导游带着我们徒步了遇龙桥，幸好漂不了，不然 Shaun 还得找人一起搭伙去漂流，因为如果没有两个人一起漂，就得还补一张票，80 块，这 tm 什么鬼，第一次听说有这种情况，来旅个游还必须偶数个人，要是游乐场敢这么搞，早关门倒闭了了，在张家界坐索道的时候也没听说过要把缆车里的人全部坐满，要不然要补票的，这遇龙河真 tm 坑，真的是幸好不能漂。听导游说好像是由于遇龙河以前出过一些事，后面就由上头接管了，所以情况就是这么个情况了。</p>
<p>　　既然没法漂流了，徒步过遇龙桥之后，导游就带我们去世外桃源了，据导游说世外桃源是当年一个台湾人在这边玩想方便却没有厕所，于是这人就在这里方便一下，方便完之后发现这里景色不错，于是<del>为方便后来人，就在这修了个厕所，顺便</del>圈了块地作为景点 。世外桃源主要是坐船玩，岸上确实没什么好玩的，在坐船的过程中，有一处确实有桃花源记描述的那样，还在出口处搞了些塑料桃花，船上的导游小姐姐说这是四季桃花 ๑乛◡乛๑ 。游玩世外桃源之后，就开始返程了，导游给了两个选择，一个是返回阳朔，另一个是直接返回桂林，Shaun 感觉在阳朔这边也玩够了，于是就回到了桂林，正好游游两江四湖的夜景。</p>
<h4 id="第二天晚上">第二天晚上</h4>
<p>　　回到桂林，大巴正好带我们到象山公园附近，本以为在外面也能看到象山，但是周围都被封的严严实实的，就算没有树遮住的地方也会被人工挡住，或许越没有料就越要遮严实点，象山公园的门票又是老贵了，就为了看个象山实在是不值得，而且那天漓江的水还是浑的，所以就只在远处远远的望了下象山。两江四湖最有名的景点当属日月双塔，而这个景点在晚上看更合适一点，又是免费的，所以 Shaun 在远望象山之后就直接去了日月双塔，在晚上灯光的照耀下，日月双塔确实非常漂亮。看完日月双塔，也算是满足了，就决定真正返程了，买好火车票之后，在火车站旁定了个旅馆，简单的洗洗睡了。</p>
<h3 id="感想篇-1">感想篇</h3>
<p>　　桂林总的来说要比张家界好玩一点，毕竟有水，而张家界只有山，但是由于 Shaun 去的时机不对，前几桂林正下大雨，漓江的水位上涨，又很浑浊，所以没看到好水还是有点遗憾的。至于景点，银子岩就真是景如其名，景区里面的东西就和银子有关，什么都能牵扯到钱，这也太俗了，Shaun 就想玩玩，谁管赚钱还是花钱（主要是 Shaun 没钱，看到这些虚假的钱就有点烦 ╮(╯▽╰)╭）。十里画廊是免费的，可以随便游玩，里面的景色其实还算可以了，不过周边单独的小景点都是要收费的，而且价格不菲，有些就是度假村一样的地方。至于西街，说实话如果没有那么多酒吧，那么西街应该就是条比较普通的小吃街了，和普通的小吃街一样，里面的东西一般很贵而且不一定好吃。遇龙河，应该最可惜的了，本来 Shaun 已经找到了搭伙人，但是不能漂也是没办法了，算是一个遗憾了，里面公厕据说是收费的，连导游都不放过。如果在世外桃源里不坐船的话那还不如不进去，感觉整个世外桃源的看点都在燕子湖上了。再谈谈桂林市区吧，整个桂林市区给 Shaun 留下的影响极差，Shaun 再桂林市走的时候刚好下过一场大雨，这时桂林市区遍布雷区，下面的铺的地砖基本都是坏的，如果不小心踩到一块中空的地砖，那么恭喜你，该洗鞋洗裤子了，地砖里藏得的脏水会全部溅到裤脚上，那脏水也有很多时米粉店里倒出来的水，又臭又油又脏，城市路面基建也太差劲了，作为一个旅游城市这太不应该了。象山公园的主要一个看点就是象山，但为了尽量不让外地人看到，就圈了超大一个地方作为象山景区，景区内除了象山感觉就没什么好看的了，不过也正好多收点费，一举两得啊，能想出这个点子的人真是个人才啊，希望桂林市多出点这样的人才，努力创收。在最后一个导游那里得知市区里面有个叫 <em>小老弟</em> 的面馆，那里面的米粉非常好吃，但只有早上有，下午就卖其它的小吃了，Shaun 就要走了，所以就没有这个口福了。</p>
<h3 id="后记-1">后记</h3>
<p>　　桂林还是很值得去的，主要是一定要选择个好季节和好天气，Shaun 去的时候天气非常热，完全不想出去的那种，所以就只玩了两天，天气不好，出去太累了。桂林的景点非常分散，小景点太贵且又不值得去，所以 Shaun 这次就尽量选择了报团，因为交通出行确实很是个问题，其实如果第一天下午不去银子岩，而是先去十里画廊的话应该就比较完美了，十里画廊和西街挨得很近。<strong><em>切记：如果要去遇龙河漂流的话最好选择偶数个人去桂林</em></strong>。</p>
<h2 id="南通一日游">南通一日游</h2>
<h3 id="前言-2">前言</h3>
<p>　　堂哥在南通结婚，Shaun 这边离南通不远，所以去吃了酒席，第二天顺便在南通玩了一天。</p>
<h3 id="旅程篇-2">旅程篇</h3>
<p>　　这一天主要在濠河风景区逛了一天，看了看南通的老建筑和濠河，一天的时间把整个濠河风景区逛个七七八八也没问题。</p>
<h3 id="感想篇-2">感想篇</h3>
<p>　　南通的人不多，也不算是个旅游城市，所以在濠河风景区瞎逛很悠闲，散心很舒服，濠河里的乌龟很多，巴西龟和草龟都有，白天会跑到岸边芦苇丛晒太阳，然后就被抓了。濠河风景区的历史街区比北京的八大胡同要有味很多，有兴趣的推荐尽早去看看，不然改造后可能就没味了。</p>
<h3 id="后记-2">后记</h3>
<p>　　南通人很少，只要不去市中心的商业街，主要专门来旅游的人不多，所以有想出去看看，散心的人可以去南通，沿着濠河走，会感觉很舒服。</p>
<h2 id="杭州两日游">杭州两日游</h2>
<h3 id="前言-3">前言</h3>
<p>　　Shaun 出去玩一般是心血来潮，临时起意，不会刻意做很多安排，清明时感觉闲着也是闲着，遂萌发出去杭州的想法，于是开始买票，没想到好几十躺车都卖完了，最后还好抢到了一发站票。</p>
<h3 id="旅程篇-3">旅程篇</h3>
<h3 id="第一天下午-1">第一天下午</h3>
<p>　　从火车站出来，直接坐地铁到凤起路，此时已经下午两点了，从凤起路出来沿着西湖边走到断桥，经过断桥沿着孤山路走，又返回西湖边去苏堤，走完苏堤全程，天已经快黑了，于是订了个青旅，直接订了两天，100 块一天，相对来说较贵，想着反正不急去青旅，就还是在西湖边继续逛了，雷峰塔夜晚的灯光也还不错，晚上的西湖也只能看灯光了。</p>
<h3 id="第二天">第二天</h3>
<p>　　感觉好像今天就能回去，所以和青旅前台说要退一天，前台说要和 MT 联系（因为是在 MT 上订的），于是联系 MT 客服说要退一天，客服说要走下流程，四个小时内给回复，但后面四个小时过去了没有任何回复，查了查网上正好也有这样的事（MT 卡着不给处理，结果到下午 6 点，这一天不能退了，客服才回复），于是把网上别人的投诉信息直接发给了 MT 客服，客服这才开始处理，MT 真的垃圾，青旅都同意退了，结果卡在 MT 这里，以后应该都不会用 MT 订房间了。</p>
<p>　　由于住的青旅离钱塘江不远，于是决定沿着钱塘江走走，后发现一辆共享单车，遂骑着自行车一直到钱塘江大桥，沿着之江路到五云山，沿着进五云山这条路去龙井村，到九溪烟树就只能下车步行去龙井村，停车时需要注意，九溪路是禁停区（别问 Shaun 是怎么直到的，九溪烟树这个景点，在 Shaun 看来绝对是可以进西湖边全部景点前三的，从九溪烟树到龙井村就全是石子路了，这里的水非常清澈，人也不算是很多。之后从十里锒铛上山，看周围的茶园，爬天竺山，从十里锒铛去天竺山的路比较隐蔽，就是一条非常普通的山路，不是石板路，很难走，下山的时候也走了条户外拓展的路，非常陡，还摔了一跤，下来之后，腿都有点发抖，太久没爬山了。从山上下来，沿着天竺路一直走到三生石，原以为能直接上飞来峰，没想到路被封死了，查了下才直到需要门票，三生石那里有株藤曼很特殊，也很漂亮，乍一看还以为它身上的花是假的。从三生石出来后，已经是下午 3 点多了，想着西湖好像还有杨公堤，于是坐车去杨公堤，这段路如果能找到自行车，最好骑自行车过去，骑车绝对会比坐车快，这里的 1314 路车，绝对是 Shaun 坐过最挤的车，车内挤车外堵，这交通状况也是绝了。下车后沿着杨公堤两边走，走到尽头，这次的西湖之旅也到尽头了。于是把车票改签，坐公交去火车站，这又让 Shaun 见识到了杭州的整个公共交通运输系统有多烂，从西湖出来到火车站，最后预留地图软件上两倍的时间，不然很大概率会错过火车，最好是直接打车。</p>
<h3 id="感想篇-3">感想篇</h3>
<p>　　西湖的景色还是可以的，如果不考虑人那么多的情况，于 Shaun 而言，九溪烟树，龙井村十里锒铛都是远比西湖本身更值得玩的地方。西湖基本都是免费的，趁工作日的时候请假去散心算是个不错的选择，至于周末和节假日最好还是算了。最让 Shaun 觉得很不舒服的一点就是杭州的整个公共交通运输系统，可以说是稀烂也不为过，公交志愿者也是些垃圾，一座本身人口就上千万，又是个旅游城市，景区周围和市中心的交通系统在节假日和周末可以说是瘫痪的，在杭州有幸能见到比上海南京路步行街如外滩的人还挤的地方，近些年居然没出事也是奇怪，希望以后能针对性改善一下吧。Shaun 反正再也不会节假日去杭州了。</p>
<h3 id="后记-3">后记</h3>
<p>　　西湖还是比较值的去玩的，前提是工作日请假去，节假日和周末就最好不要去了，西湖周边两天差不多能逛完，Shaun 这次没去拱宸桥，不知道那边怎么样。</p>
<h2 id="北京凤凰岭一日游">北京凤凰岭一日游</h2>
<h3 id="前言-4">前言</h3>
<p>　　很久没爬稍微高点的山了，又想出去散一下心，于是问同事这附近有些啥山适合爬的，同事推荐了凤凰岭，马上就订了票。</p>
<h3 id="旅程篇-4">旅程篇</h3>
<p>　　当天早上 7 点半起床（都好久没这么早起床了，到公交站的时候已经是 8 点了，坐了两个多小时的公交（中间还倒了一趟车，终于到凤凰岭了，公交站离景区门口大约还有 1 公里，而且都是上坡路（没到景区门口就感觉有点难走了，验票完就直接进去了，可能是临近春节的关系，景区内的人很少，由于 Shaun 买的是冰雪乐园的套票，所以决定先去冰雪乐园看看，离景区门口很近，往上稍微走走就到了，同样验票进去，免费的都是小孩玩的东西，大孩子玩的需要额外收费，就是垫个轮胎从山坡上滑下来，也挺好玩了，就是上去的时候还得人力把轮胎又拖上去，项目确实比价少，有小孩的可以带进去玩玩，没小孩的就不是很推荐了。</p>
<p>　　从冰雪乐园出来，回到正常的上山道路，凤凰岭有三条游玩轨迹（南线，中线，北线，都可以上山，Shaun 这次选择的是从南线上，北线下，正好将凤凰岭绕了一圈，而且南线就是离景区门口最近的一条线，正好上山。</p>
<p>　　从南线上去，经过天梯去观景台，再到龙凤阁，最后再从飞来石塔下去，就是 Shaun 这 5 个小时的行程了。上山是真的难爬，尤其是从南线上去到观景台这段路，Shaun 起码休息了 5 次，有好几次都不想爬了，但想着下去更难，就只有硬着头皮上了。走过观景台，路就好走很多了，没那么陡，到后来从飞来石塔下来，都感觉没那么恐高了。</p>
<p>　　从龙凤阁到飞来石塔的路上碰到了一只很肥的猫，这种感觉就像看到一个本该骨瘦嶙峋的穷苦人孩子，却长得白白胖胖的，真令人唏嘘，也不知道有多少鸟儿遭了它的罪，Shaun 在吃干粮，它一直朝 Shaun 喵喵，Shaun 没理它，后面就自觉钻进树林了。在凤凰岭上，时不时会看到几只隼在飞来飞去，这种感觉挺好的，鹰隼类看一眼就少一眼了😢。凤凰岭北线上居然有一段路是大理石地砖，也不知道是哪个鬼才想出来的，估计是嫌百京人太多了，能摔死几个就几个。</p>
<p>　　从北线下来，腿都软了，回到景区门口，到公交车站，原路返回，都在公交上睡着了，还好醒的及时，没错过站。开心的是买的砂糖橘也正好到了，提回租房，尝了几个，还不错，砂糖橘自由还是没啥问题的 :) 。</p>
<h3 id="后记-4">后记</h3>
<p>　　这次爬山，是真的累，许是很久没爬这么陡的山了，天梯那段路坡度感觉都有 70 度了，爬那段路是真的难受，还好中途有休息的地方。上山费小腿，下山费大腿，下山的时候还好捡到一根棍子，能撑一下还是挺好的。总的来说，就爬山而言，凤凰岭还是可以一去的（虽然不知道春秋的景色怎么样，但是下雪天确实需要注意，山上还是很陡的。</p>
<h2 id="故宫一日游">故宫一日游</h2>
<h3 id="前言-5">前言</h3>
<p>　　故宫的大名，早就听过却从来没去过，上次来北京也只是绕护城河走了一圈，没进去看过。提前一周订了去故宫的票，看珍宝馆也不贵，就一起订了套票。</p>
<h3 id="旅程篇-5">旅程篇</h3>
<p>　　同样的早上 7 点半出发，坐了 1 个半小时的地铁，进天安门安检，这安检比较奇怪，除了正常的查，还要查纸张和水，刷身份证进去，过天安门去午门检故宫的票，同样是刷身份证验票，顺利放行。直接沿着中轴线过太和门，太和殿，保和殿，去珍宝馆。</p>
<p>　　逛了珍宝馆里常开的四个展厅，很直观的可以看到皇家的奢靡，工艺啥的 Shaun 不认识，但宝石和黄金还是知道的。从珍宝馆出来，进乾清门，去乾清宫，到坤宁宫，直到御花园，在御花园遛了一圈，只能看到一些几百年的松柏，这个季节的御花园实在没啥看的，水都没有，也不知道唯一现存的水法在其他季节会不会开。</p>
<p>　　从御花园出来，经西六宫，到慈宁宫，在慈宁宫蹭了一段导游在述说乾隆与其太后的历史，还挺有意思的，感觉这种就应该边听历史故事边游览。出慈宁宫到慈宁宫花园，比御花园还没意思。沿着红墙去陶瓷馆，没想到需要额外预约，再去家具馆，没想到去年 7 月停馆维修了 😮‍💨。后面又去箭亭看了下箭头和马鞭，就从东华门出来了。</p>
<p>　　回到租房，已经是下午六点了，正好做晚饭，吃些砂糖橘，爽歪歪。</p>
<h3 id="感想篇-4">感想篇</h3>
<p>　　故宫的门票只能在官网或微信公众号里预约，且不能当天预约，身份证检票就行。除了门票之外，故宫里有些展览同样是需要额外预约的，叫特展预约，所以在买门票之前最好先把特展预约都约了。</p>
<p>　　故宫的防滑措施做的确实比较到位，稍微光滑一点的地方都会贴上防滑条。故宫的乌鸦也是超大只，而且数量还不少。没去过故宫的还是值得去一下的，尤其是对明清这段时期的历史，文化，艺术比较感兴趣，推荐买年票（因为一次肯定逛不完，对历史不太感兴趣就去感受一下皇家的奢华就行了。</p>
<h3 id="后记-5">后记</h3>
<p>　　比起人文景观，Shaun 还是更喜欢自然景观，人文景观需要了解历史的厚重感看起来才更有意思，否则也就只能看看它的奢华大气。</p>
<h2 id="八达岭半日游">八达岭半日游</h2>
<h3 id="前言-6">前言</h3>
<p>　　不到长城非好汉，登长城者好汉乎？读书时就想着以后要来长城一次，趁着这次春节，就先订好票。</p>
<h3 id="旅程篇-6">旅程篇</h3>
<p>　　由于八达岭距北京市区比较远，所以起了个大早，6 点半就起床了，去八达岭有两条路线，一个是从德胜门坐公交，一个是从黄土店坐 S2 铁路线。Shaun 这次选择的是坐公交去，坐铁路回，其实坐公交要比坐铁路方便很多，并且要快一点，不过铁路要舒服一些，不同的路线有不同的风景，体会不同的交通工具也算是旅程中的一种乐趣。</p>
<p>　　坐了两个多小时的车，来到八达岭景区，缆车的票没买，因为觉得还是徒步上去更有意思。八达岭长城有两段路线，分为南线和北线，南线需要原路返回，北线算是一个环线，从熊乐园出来，就能直接坐公交返回市区。Shaun 这次选择的是爬北线，从正常的入口开始，爬到北十二楼，再从熊乐园出来。</p>
<p>　　爬完北线全程，花了大约两个小时。北线有些有些地方确实非常陡峭，感觉差不多都有 80 度的坡了，北八楼算是最高点，坐缆车就是直上北八楼。长城确实比一般的山要难爬一些，主要沿着山脊不断起伏。在不断起伏的山脊上修建这么一条绵延万里的的城墙，确实只能由高度中央集权的国家完成，这么一道墙，花费的人力物力财力时间都是难以想象的。</p>
<p>　　从北线下来，还可以看看熊乐园里的黑熊吃 jiojio，很有意思 :) 。</p>
<h3 id="感想篇-5">感想篇</h3>
<p>　　在寒风呼啸的时候去爬长城真是个艰难的决定，不过这也能体会当年戌边将士的辛苦。这次没爬南线，只爬了北线，算是一种遗憾，原因是当时爬的时候感觉可能只能爬完北线，后面可能时间不够或没力气了，但是当从北线上下来，感觉时间也很充分，好像爬南线也不会太吃力，但是已经出来了，也就没办法了。如果下次还有机会去，可能会从熊乐园那里进去，从北十二楼开始爬，直接爬到南七楼，爬完八达岭长城全程。</p>
<p>　　长城下景色其实没啥看的，最大的看点就是蜿蜒起伏的长城本城了，在寒冬腊月登长城远眺，尤其能感觉到一种雄伟。</p>
<h3 id="后记-6">后记</h3>
<p>　　爬过长城之后，其实感觉也就这样，但是没爬，就总有一种向往。单论游玩，长城确实不好玩，甚至没有爬一些名山好玩，但长城确实有它的魅力，就单它立在此起彼伏的山脊上，就值得一看，看看古人的一些成果，总有一些感慨。</p>
<h2 id="北京西山一日游">北京西山一日游</h2>
<h3 id="前言-7">前言</h3>
<p>　　前三个月工作太累了，需要散下心，但由于疫情原因，不能出去，只能在室内玩玩，听说西山有个鬼笑石可以俯瞰北京城，就买票了。</p>
<h3 id="旅程篇-7">旅程篇</h3>
<p>　　上午11点从租房出发，下午三点才到西山，整整坐了4个小时，算是认识到了北京堵车的离谱程度，这也是 Shaun 坐的最久的一次公交车了，下次节假日出游还是不坐公交了。</p>
<p>　　进西山的人很多，排队进去都花了十分钟。西山其实不大，最值得看的也就鬼笑石了，从东门出发到鬼笑石，无论走哪条路，2小时都绰绰有余了。Shaun 是奔着在西山上走一圈去的，于是决定从红叶大峡谷上鬼笑石，再从快活林下来。上鬼笑石确实是按计划走的，可从鬼笑石下来，就计划赶不上变化了，从靠近快活林的公共厕所出来之后，厕所旁边也正好有个马路通道（旁边也无人值守，感觉是可以从这里逃票进来的），于是从这里就出去，当时想着能从另外一边下山也不错，没想到走上了一条不归路，从这条路出去，最近的坐车点也是香山地铁站了，于是就硬走了十几公里的山路，虽说是全程水泥路，但上上下下的山坡总是要走的，有些还贼陡，等下完山，膝盖已经废了。最后又排了十分钟才进到地铁站，坐了一个半小时的地铁才终于回到租房。</p>
<h3 id="后记-7">后记</h3>
<p>　　这次去西山，本想着春天来了，应该会有些花开了，可以看看山，赏赏花，没想到，到山上是能赏花，不过就一种，满山遍野的桃花，虽然也不错，但感觉总少了些什么。西山和香山后面的山友道是贯通的，就单纯的散心确实是个好去处（也是个剪径的好地方🤪）人比较少，也能看看那片山，走到头就是鬼笑石，俯瞰京城夜景，好像也不错。</p>
<h2 id="北京香山半日游">北京香山半日游</h2>
<h3 id="前言-8">前言</h3>
<p>　　端午节前，夜观天象，宜出游，遂至香山。</p>
<h3 id="旅程篇-8">旅程篇</h3>
<p>　　香山与西山挨着，由于疫情的原因，公交有些线路不通，城里外出的人也很少，坐公交和地铁都需要绕很长一段路，决定骑车过去。上午下了会儿雨，等雨停已是12点1刻，骑车到香山花了1个半小时，路上的风是真的大，有时宁愿推着车走。及至香山，从东门入，拾级而上，经观景台，至香炉峰，始下山，踏两千级，出北门。</p>
<p>　　香山海拔就五百来米，算不得很高。在登山过程中，有个小插曲，上山时，就感觉肚子不舒服，有更衣之意，但后来又消失了，所以没当回事，直接沿着南侧的围墙向上走了，走到红叶区附近，感觉有点撑不住，找到最近的五谷轮回之所在双清别野那，于是不得不中途下山，再从中路上山。登山之前，谨记排毒。这次上山又下山的过程，也看到了一些趣事，所谓祸福相倚。下山途中看到红嘴蓝鹊和赤峰锦蛇干架，很有意思，蓝鹊只敢站在树上拼命的叫，同时鼓起翅膀，锦蛇完全无动于衷，信子都没吐。上山途中看到有人喂食松鼠，还是第一次近距离接近自然中的松鼠。香山上的小动物确实不少，还看到一种特殊的小鸟，麻雀般大小，不过是白头花身的，当然看到最多的可能还是千足虫了，密密麻麻的脚看起来确实比较难受。</p>
<p>　　从香山下来，已是6点半了，走了这么久，腿也是酸胀的不行，下山途中，站在阶梯上都有点发颤。到家之后，叫上一杯柠檬水，痛并快乐的一天就这样结束了。</p>
<h3 id="后记-8">后记</h3>
<p>　　香山比西山确实更值得去一点，由于其最高处海拔更高些，所以爬的难度也更大了，但是在观景台上可以真正意义上看到整个北京城全貌，这点就很值得了。</p>
<h2 id="北京蟒山半日游">北京蟒山半日游</h2>
<h3 id="前言-9">前言</h3>
<p>　　五月初六，端午节后，辰时雨停，气温略降，遂往蟒山。</p>
<h3 id="旅程篇-9">旅程篇</h3>
<p>　　看好路程，坐公交前往，没想到北京部分公交不认支付宝公交码，只能悻悻下车，坐其它线路，在转最后一趟公交时，由于疫情原因，无法直接到蟒山，只能中途下车，幸好有碰到同去的三个驴友，遂一起打车，中途要经过一个村子，没有对应通关文碟，只能绕路。路人曰：疫情之下，一村即一国。</p>
<p>　　从出发到蟒山门口，耗时两个半。从通天门进，观大佛，登二期木栈道，酷日当空，天气闷热，汗如雨下，及至观景亭，俯瞰十三陵水库，微风袭来，闷热缓解，空旷舒适，继续往上，走野路，至瞭望塔，看天池，缓下山，至龙门出。</p>
<p>　　蟒山和十三陵相邻，论可玩性，就是纯粹的爬山罢了，唯一的看点就是俯瞰十三陵水库了，从木栈道处可以更快的看到十三陵水库全貌，而从龙门进，需要走野路才能近距离看水库，不然就只能到瞭望塔处俯瞰水库。从观景亭往上走，到观景台，可以从龙泉处爬上去，到上面有条防火公路，可以去天池。听游客讲，天池是用来存储电力的，晚上用多余的电抽水进天池，之后可放水发电，感觉又回到了高中课本，就当趣事听了。</p>
<p>　　从蟒山下来，已是5点半了，正巧碰到之前的一个驴友，遂一起打车前往公交站，回到家，来杯冰淇淋，舒服😌。</p>
<h3 id="后记-9">后记</h3>
<p>　　蟒山比香山略高，可能是之前爬香山的时间间隔还短，感觉没香山那么累，趣味性没香山好，30 块的门票费和香山比感觉有点不值，不过和六环外的其它景区相比，也大差不差，也算是有山有水，差强人意。</p>
<h2 id="国家植物园一日游">国家植物园一日游</h2>
<h3 id="前言-10">前言</h3>
<p>　　百京的夏天难得有好天气，尤其正好碰上周末，所以得抓紧这天气去植物园，也正好调试一下迪卡侬 ST100。</p>
<h3 id="旅程篇-10">旅程篇</h3>
<p>　　植物园和香山/西山挨在一起，从租房这到植物园骑行 16 公里左右，1个小时多点，也还差不多。于是 9 点 40 吃完饭出发，路上边骑边调试（主要是坐垫和档位），11 点到植物园南园，由于正当夏天，能看的花也就是荷/莲花，紫薇，木槿了，当然还有月季，南园或者说整个植物园最值得看的就是那三个温室展厅了，也不需要额外的门票，有来自世界各地的一些植物，对于没看过的人还是比较稀奇的。</p>
<p>　　在南园逛了一圈，下午两点进北园，北园比南园要大很多，中间有条水系，衍生出3个小湖，种了些荷花，周边也长满了芦苇和野生杂草，感觉开发的不够。沿着水系一直往上走，就能走进和西山连着那一片山里，所以对熟悉那块的驴友来说，进北园应该不需要门票 ๑乛◡乛๑。北园的科普馆需要额外预约，所以最好在订票的时候同时把科普馆约了，不过科普馆里针对的人群更多是小孩。科普馆旁边就是北园的月季园了，这个园区超大，里面据说有 1000+ 种月季，可以说是月季爱好者的天堂了，可惜这个时候去的时机不对，赏月季最好就是在 4 5 月份，这个时候的月季是当年的第一次开花，营养足，开的花要大很多，也最好看。</p>
<p>　　从北园出来，已经是下午 5 点半了，回去的时候选了另一条路骑回去，可惜已经没时间向来的时候慢慢骑着，边看旁边的一些东西，这个时候，脚已经走的累的不行，只想快点骑到家，骑了一小时多点，回到家，来瓶冰饮料，还不错。</p>
<h3 id="后记-10">后记</h3>
<p>　　本来去植物园是想看些稀奇或者漂亮一些的植物的，但是除了温室展厅，感觉和野外看到的一些植物也差不多，不过就十块钱还要啥自行车，当然也可能是正当夏天去的时机不对，春天或着秋天去会要好很多。</p>
<p>　　有自己的车最大的好处就是不用将就共享单车，不用忍受垃圾数字围栏的定位不准，可以想去哪就去哪。迪卡侬的 ST100 作为入门级山地车，正常通勤使用是绝对够用了，百京的路也不是太平整，红路灯也多，而且 Shaun 也不需要太快的速度，不用追求公路车啥的，皮实耐操就行，这点这辆车是完全可以了，刹车是 V 刹，不过也能满足正常使用了，在 10 的速度上是完全能及时刹住的，但 20 的时候就不能直接刹死了，在 Shaun 的体重加持下，车是会直接往前漂的，不过 Shaun 一般不上 20，所以也还行。这辆车的坐垫是真的硬，在没练就铁臀的情况下，再买个坐垫套或者换个坐垫是完全有必要的。骑车的时候，最好还是带个防护眼镜，蚊虫和风沙真是要命，Shaun 都迷了好几次眼了 😣。</p>
<h2 id="西安六日游">西安六日游</h2>
<h3 id="前言-11">前言</h3>
<p>　　虽早有去西安的计划，但疫情三年，变数太多，出行甚烦，一直搁浅，这次正好有个去西安过年的活动，遂报名前往。</p>
<h3 id="第一日">第一日</h3>
<p>　　前一晚从北京坐卧铺到咸阳，正好早上到，和小伙伴们一起打车去租车点，由于太早，路边也没看到吃早餐的地方，于是直接开车去法门寺。虽说法门寺始建于东汉，不过历经战火与重修，早已不复当年，里面很大但很空，或许符合佛家四大皆空的意境，也或许是为了接纳更多的香客，但就游览而言，不是很友好，香火和师傅也都不是很多的样子。法门寺值得看的当属法门寺地宫，看佛祖舍利，法门寺博物馆，看秘色瓷，这两样是特有的。</p>
<p>　　从法门寺出来，下一个景点是乾陵，实在是有点饿了，也怕到乾陵的路上也没吃的，于是在附近先吃了个农家乐，菜食材不对劲还很贵，不过馍和臊子面也算是别具一格，不过景区附近的饭馆还是别吃的好。去乾陵的路上，没想到会经过一个集市，里面啥都有，都后悔吃了这顿饭，东西也不贵，买了些烟花准备去西安放，买了些水果在路上吃。虽说老家也会赶集，但很久没赶过了，异地赶集体验一下也不错。</p>
<p>　　乾陵的门票实际上包含三个景点：乾陵，懿德太子墓，乾陵博物馆，这三个点最好还是开车去，走路的话不算近。首先去了乾陵，由于乾陵没有正式挖掘，所以能看的东西确实也不多，基本只能爬爬山，看看乾陵的神道，看下历史书上的无字碑（<em>冷知识：现在的无字碑是有字的</em> :D），在下乾陵的路上树林里看到两只七彩山鸡，非常漂亮。懿德太子墓是有被挖开的，可以直接进墓道参观，乾陵博物馆实际也是永泰公主墓，也能参观墓道，这两个墓的部分陪葬品都放在乾陵博物馆的展厅里。总得来说，由于乾陵没有被挖开，能看的东西确实不多。</p>
<p>　　从乾陵出来，已经下午 4 点多，直接开车去西安，先去酒店办理入住，再开车出去找吃饭的地，除夕夜，大部分饭店都关门了，找了近一个小时，总算是找到了家涮羊肉，都饿坏了，大过年的，有口吃的也不容易啊 (ノдT) ，中途异地还了个车，吃饱喝足后，都晚上 9 点了。听还车的小伙伴说，永兴坊很热闹，于是又去永兴坊逛了一圈，发现这里面吃的东西也很多，又有点后悔吃涮羊肉了。从永兴坊出来，沿着护城河一边放烟花，一边躲城管，一边看烟花，其乐融融，西安的年味儿还真是足啊 🤣。看完烟花后，有两个小伙伴就直接回酒店了，看时间还好，其余人就又去看了钟楼，鼓楼，又沿着回民街走了一下，可能是太晚的缘故，回民街人不是很多，小吃也开始收摊了。</p>
<p>　　回到酒店，都已经是 12 点了，这天也确实是走累了，脚疼，洗澡时用热水冲冲，感觉舒服多了。</p>
<h3 id="第二日">第二日</h3>
<p>　　随便找了个便利店吃完早餐，出发去碑林博物馆，看看西安历朝历代出土的各种石碑。大年初一，得早上给亲戚家打电话拜年，所以这馆的展厅没逛几个，稍显可惜，加上由于打电话太多也通话时间不长，触发了电信的风控系统，直接给手机号码停机了，不得已只能先回酒店申请复机，手续办完后，正好小伙伴们逛完卧龙禅寺回来，准备去城墙上走走，借小伙伴的热点买完城墙年票，还好在徒步城墙的路上，电信客服开始远程办理复机了，很快复机申请就通过，不过停机这件事确实很搞人心情，得到的教训就是这手机也得灾备啊 (／‵Д′)／~ ╧╧ ，这里也十分感谢小伙伴的帮助。</p>
<p>　　从城墙下来，决定先去吃午饭，朝着回民街的方向走，发现路边有卖肉夹馍的店，点了份肉夹馍和羊肉泡馍，正宗的还是好吃啊，肉的分量十足。吃完馍出来，负责路径的小伙伴通知先去城隍庙，再去化学巷清真大寺。和其他小伙伴在城隍庙里逛了一圈，人是真的不少啊。去清真大寺的路上经过回民街，白天的回民街那叫一个人多，又回想起小时候集市上那种肩碰肩，脚连脚的感觉了。清真大寺，不像人们熟知的那种穹顶建筑，而是传统中式的庭院风格，古建筑很有韵味，确实很值回票价。</p>
<p>　　逛完清真寺，沿着回民街往鼓楼方向走，有小伙伴想上楼去瞧瞧，其余人觉得没啥好看的，就在下面麦当劳等，也顺便休息一下，等小伙伴逛完钟/鼓楼，已经下午 3 点多了，得在下午 5 点前赶着上城墙看灯会（<em>不然就得另外购买灯会票</em>），再顺着回民街去城墙，在回民街买了个烤羊蹄，就算是晚餐了，味道还可以。匆匆在 5 点前赶到城墙，在城墙上边走边玩，等着灯会开幕。城墙灯会确实非常漂亮，算是一场视觉盛宴，就是人非常多，回民街和灯会相比人算少的了，看灯会的人才叫一个人挤人，零几年春运的人和这应该相差无几，都完全是被推着走的。</p>
<p>　　逛完灯会下来，已经是晚 8 点半了，一些小伙伴累了就直接回酒店了，其余人又赶着去大唐不夜城。大雁塔就在大唐不夜城旁边，不太想近距离看大雁塔（<em>主要是没钱</em> o(︶︿︶)o），就在大慈恩寺外看了看，没啥太多的感觉。大唐不夜城是一段很长的步行街，灯光炫目，人潮涌动，走到一半实在是走不动了，灯光秀也产生了视觉疲劳，就找自行车骑回酒店了。</p>
<p>　　回到酒店，快 11 点了，脚已经感觉不是自己的了，膝盖也开始隐隐作痛，洗澡时照例拿热水冲冲，倒床就睡。</p>
<h3 id="第三日">第三日</h3>
<p>　　早上在酒店附近买了个牛肉饼，味道是真不错，赶着去西安博物院（小雁塔所在地），由于博物院严格按照预约时间放人，去早了，只得改道下一地，骑车去大兴善寺。大兴善寺确实很大，香火旺盛，寺院后的腊梅也正盛开，满树繁花，很好看。从大兴善寺出来，接着再去西安博物院，直奔小雁塔，可惜正在修整，不能进去，只能在外面看看，感觉小雁塔比大雁塔更有历史韵味。西安博物院很大，展厅也多是青铜器，唐三彩，金银玉器，没看到有非常特殊的，很多博物馆也都是这种，有点审美疲劳了，当然也可能是太匆忙，没逛完，也可能是不了解背后的故事，看起来有点乏味。</p>
<p>　　从博物院出来，打车去吃中饭，这回是正宗的陕菜，味道还真不错，价格也很实惠。由于这天接下来就没有特别具体的安排，所以就随便逛了逛，先去了饭馆附近的天坛遗址公园，主要是一个层叠的夯土堆。由于之前的酒店住宿涨价，太贵了，换了家酒店，回到之前的酒店拿回行李，去新酒店办理入住。出来后又去了八仙宫，附近全是算命的，由于主殿正在维修，所以也没啥看的。接着又去了城墙上走走，不过这天的风儿甚是喧嚣，太冷了，从中山门下去，去永兴坊。在永兴坊逛逛，顺便解决了晚餐，人也是不少的。</p>
<p>　　回到酒店，8 点多，脚也是有点痛，膝盖也不太行，照例冲冲。</p>
<h3 id="第四日">第四日</h3>
<p>　　早餐吃了个肉夹馍，这肉夹馍就没之前吃的好了。本来想坐大巴去兵马俑的，不过看了下打车费和大巴费差不多，于是就直接打车了，快到兵马俑的时候，有点堵车了，提前 500 米下车步行去兵马俑了。</p>
<p>　　到兵马俑之后，人山人海也就这样了，导游是不可能叫的，只能蹭蹭这样子，进去之后也发现了，叫导游也没太多意义，里面全是人，导游也很多，旁听也还不错。兵马俑展厅其实没咋挖掘，1 号坑复原了最多的兵马俑，2/3 号坑主要是保留了一些挖掘现场，稍微探了一下。陈列厅里也主要是挖掘历史，陪葬品也不在这展示，所以兵马俑其实更多的是听听故事。从兵马俑出来可免费坐摆渡车到丽山园，秦始皇陵就在这，这边主要展示特殊的一些俑，尤其值得一看的就是铜车马博物馆，有完整的铜车马背景故事，了解历史文化，再对照实物，就很有意思了。</p>
<p>　　逛完秦始皇帝陵博物院，直接打车去华山，先到酒店办理入住，出去找东西吃，没想到饭馆基本都不开门，还要有一家是下午开门了，运气还不错，吃了碗豆腐面和一个肉夹馍，就不用讲究啥了，在没吃的情况下，有口吃的就很可以了，况且这味道确实还行。去当地的超市买了点补给，准备第二天爬华山了。回到酒店，和小伙伴斗了会儿地主，很久没玩牌了，久到都忘记了大概时间，感觉还不错，玩了会就出门找晚餐了，晚餐就还有些其他的饭馆了，小伙伴找了个串串香店，大吃了一顿。</p>
<p>　　回到酒店，真是太冷了，空调不给力，只能靠电热毯活着了，热水可以忽略，匆匆冲了个澡，瑟瑟发抖，腿依旧没完全恢复，华山只能硬着头皮上了。</p>
<h3 id="第五日">第五日</h3>
<p>　　早餐继续吃了个肉夹馍和一碗豆腐面，背上行李，开始徒步登山。</p>
<p>　　登山沿途也有各种卖补给的商店，每上一个大坡之前，必有补给，水也是从十块三瓶到十块两瓶再到十块一瓶。从玉泉院到北峰顶大概花了三小时，中间有些坡实在爬不动了，只能手脚并用，减轻腿的压力。下北峰，到五云峰饭店，放下背包，出金锁关，过中峰，去长空栈道，人太多，改道南峰顶，越西峰顶，回饭店。徒步登华山的人确实不多，但华山顶上的人属实不少，有些台阶过的时候都得互相让路。还好这天天气也比较好，出太阳，虽然每个峰顶风都很大，但至少下了峰顶，就基本没风了。冬天登华山必备装备就是手套了，不然锁链没法握，帽子这个看情况，不过最好备上，虽然大部分时间可能用不上，因为登山走起来还是太热了，慢走甚至停下来就得注意保温了。</p>
<p>　　回到饭店床位休息，感觉膝盖是真的不行了，上下台阶能感觉到针刺般的疼痛，尤其是下台阶，只能一级一级的拖着走，当天感觉第二天只能直接坐索道下山了，虽然有点遗憾，但也没办法了，身体条件不允许。</p>
<h3 id="第六日">第六日</h3>
<p>　　早餐吃了个面包，原计划的东峰日出肯定是没戏了，不管是天气还是身体，都不允许看日出，东峰也自然不可能去。感觉腿脚好像恢复了一些，不去长空栈道，必定留大遗憾，况且同行的小伙伴也想去，就当相互照顾了，小伙伴借了对护膝，穿上就直接去了。原路去长空栈道，发现来早了，还得等 20 分钟，不过算是第一队，不用排队，等等就等等。走在长空栈道上，看着悬崖峭壁上的孔洞，更加能体会到古人修仙问道的决心，不过终究只是一场虚妄罢了。长空栈道折返区域，看到一只松鼠咻的一下从悬崖上下去了，小动物攀爬还是厉害。走过长空栈道，就感觉华山这一趟，甚至西安这一趟，完全没白来，这就是三年来最舒服的感觉，虽然天气冷，风很大，但还是很爽。</p>
<p>　　接着从西峰坐索道下山，20 分钟的索道体验也非常棒，华山的险峻非常直观。索道下站到景区门口还需要坐大巴，40 块的票价有点贵了，没有天门山天路的感觉。最后和小伙伴一起吃了顿午饭，打车去华山北候车，旅程结束，很开心 （￣▽￣）。</p>
<h3 id="后记-11">后记</h3>
<p>　　这次西安之行，虽有坎坷，亦得圆满。论历史文化底蕴，世界上没有哪座城池能比得上西安，而今繁华落幕，只能靠吃老本，沦为旅游城市。但西安总让人心驰神往，这或许就是文化的魅力，听听故事，吃吃馍，来一次，感觉人生都圆满了些，但应该不会想来第二次，没经历过的都想体验下，经历过的感觉也就这样，想象和现实总会有出入。</p>
<p>　　华山之行，算是强忍着腿脚不方便上去的，华山的台阶对于上山可能感觉没那么陡，但是下山确实更能体现华山的路，有时候都看不到前面的阶梯，可惜时间以及身体原因都不允许走下去，不然还真想体验一把。在身体条件允许的情况下，一天就能游览完整个华山（除长空栈道这种排队项目），并不需要在山顶上住，这次在山顶上住也是原计划想把日落和日出都看了，奈何天气不允许，一个都没看到 ╮(╯▽╰)╭。景区周边的东西还是少买甚至不买，尤其是一些从没见过东西，最好还是先询价。</p>
<h3 id="附录">附录</h3>
<h4 id="行程">行程</h4>
<p>除夕 1/21 第一天 法门寺 午饭吃农家乐 乾陵 晚餐吃涮羊肉 租车 住 布丁严选酒店(西安钟楼南门广场店)</p>
<p>初一 1/22 第二天 碑林博物馆 卧龙禅寺（没去） 城墙 中饭吃肉夹馍 羊肉泡馍 城隍庙 西安化学巷清真大寺 回民街 钟楼/鼓楼（前一晚走过） 回民街解决晚饭 城墙灯会 大雁塔/大唐不夜城 住 布丁严选酒店(西安钟楼南门广场店) 城墙年票69下午5点前随便上</p>
<p>初二 1/23 第三天 大兴善寺 西安博物院(小雁塔) 中饭吃奔跑吧陕菜(西安环球金辉广场店) 天坛遗址公园 敕建万寿八仙宫 城墙 住布丁酒店(西安火车站万达广场店)</p>
<p>初三 1/24 第四天 兵马俑 丽山园 打车去华山 住布丁酒店(华山游客中心店) 吃串串香</p>
<p>初四 1/25 第五天 华山徒步上山，过北中南西四峰 住五云峰饭店</p>
<p>初五 1/26 第六天 长空栈道 西峰索道 回京</p>
<h4 id="费用-3052.57">费用 3052.57</h4>
<p>报名费 199</p>
<p>交通费 1218.55 北京（天津）到咸阳 （280.5）华山北到北京西（532.5）第一天打车到租车点（3.75） 咸阳租车一天（126.6）第三天打车到中饭点（9.5）第四天打车费（去兵马俑/华山 80）西峰索道（120）下山大巴（40）打车去华山北（10）哈啰（1.8+1.5+1.5+3+7.9）</p>
<p>景区门票 525 法门寺（88）乾陵（75）城墙年票（69） 碑林博物馆（25）兵马俑（120）化学巷清真大寺（15）八仙宫（3）华山（100）长空栈道（30）</p>
<p>餐费 638.02 第一天中农家乐（50+14（橘子）） 第一天晚涮羊肉（111+3.5）第二天早（11）第二天中（40）第二天晚（10+5+20）第三天早（8）第三天中（6+56.6）第三天晚（10+18+18+10）第四天早（13）第四天中（20）第四天晚（39.25） 上山补给（11+19） 第五天早（19）第五天中（10）第五天晚（55.67）第六天中（60）</p>
<p>住宿费 472 第一天（68） 第二天（136）第三天（107）第四天（45）第五天（116）</p>
<h4 id="赋诗一首">赋诗一首</h4>
<p>长安城内灯烟绚，华山道上行人稀；盛世开幕又落幕，计划延期终有期。</p>
<h2 id="记碧霞山之旅">记碧霞山之旅</h2>
<h3 id="前言-12">前言</h3>
<p>　　本来一般的徒步活动 Shaun 是不记的，但这次发生了一些特殊事件，挺有意思的，遂记之</p>
<h3 id="旅程篇-11">旅程篇</h3>
<p>　　从北京出发2个半小时到景区，一切都十分稀疏平常，本来是想走正常景区道路的，可惜正值防火季，景区路不让进，只能发挥徒步人的老传统——走野路进山。刚上山，就下起了大雪，雪越下越大，下到最后，就是密密麻麻的鹅毛大雪，前人走过的痕迹很快就会被雪掩盖，虽然之前准备出发看过天气预报会下雪，但谁都没想到会下这么大的雪，又加上山上零下十几度的低温，路也不好走，基本上每个人都滑了几跤，甚至有些人后面看到坡都直接坐下蠕动前行了，反正雪厚，在山上转悠了五个多小时，雪也一直下，等我们下来的时候，雪也开始慢慢停了。中午 11 点来的时候，地面上零星的散步着一些雪块，到下来的时候，地面上的雪都有近 20cm 厚了，在山上的时候，衣服都已经结冰了，落在衣服的雪都变成冰碴子了，衣服被冻得邦邦硬，只想快点吹暖气，这十几年没怎么接触雪，一朝就玩够了。碧霞山的丹霞地貌和之前看到的很多岩溶地貌确实各有各的风格，最显著的区别就是碧霞山整个看起来是暗红色的，近距离看石头就像是卵石堆积而成，山体形状也很有意思，景区内确实可玩性十足，石缝里的蜥蜴种群和山中的麻雀也是很有意思，算是不虚此行。接下来就是真正的重头戏了，也是这篇记下来的原因。</p>
<p>　　由于下雪加上低温，地面已经结冰，所以高速直接封路了，而国道由于有个大坡，结冰之后大巴也爬不上去，所以只能先耗着，大巴司机将车停在一个小超市旁边，大家买了些补给，等到晚上 6 点半的时候，交警终于过来清理冰雪了。这时由于天气冷，加上在山上走了一天，对于部分人，可谓是身体和心理上都到极限了，所以车上已经吵成一锅粥了，摆在大家面前的是有两个选择：一个是先等等，看交警能不能把冰雪清完，另一个是直接找个休息的地方，在这睡一觉，第二天再走。领队的意思是想先等等，于是找了个当地的农家乐，其主人愿意接待大家，让大家现在那里休息，这可真算是碰上好人了。在农家乐等到晚 8 点半的时候，有消息过来国道也封闭了，这下就只有一个选择了，农家乐给大家联系了附近的酒店，就办理入住了，没想到又住进了一个热水稀缺的酒店，只能将就着快速洗完了，哎，悲催的一天总算是结束了。以为霉运也结束了，没想到第二天酒店早餐吃到后面就只剩主食了，酒店这降本增效的手段有点黑了 (╯‵□′)╯︵┻━┻，临近出发的时候，另一辆大巴又抛锚了，只能等着修，这一天天的，美好的周末完全没享受到。</p>
<h3 id="感想篇-6">感想篇</h3>
<p>　　这次报的这个户外团，在正常情况下，提供的服务是很周到了，基本可以认为是保姆式服务，但在应对突发状况时，确实略显不足，看起来就像是完全没有预案和备案，领队也明显有点慌了，在讨论解决方案的时候，人都联系不上了，导致车上的一些乌合之众就开始闹了，把司机师傅都给闹无语了，最后的两个选择，领队们是综合了一堆信息和讨论以及联系了农家乐之后，才定出了一个先等等的方案，但乌合之众是有点不想动了，想原地休息，第二天再走。但户外团的领队本质上都是很强势的，才不管这波从重降智后乌合之众的想法，爱等不等，自己掏钱自己回京随便。这户外团的做法和另一些组织也有点类似，同样是保姆式服务，提供一些他们想让下面人知道的信息，保证大部分个体的利益，同时维持自己的信息主导权，这种在正常情况下确实是个很不错的管理方式，但在应对一些集体性突发事故时，一旦应急处理流程不到位，就容易造成大面积恐慌，这时候，个体的思维模式完全转变，就像「乌合之众」里描述的那样，从众，降智就都来了，在加上一波有心人的推波助澜，事情就变得有意思起来了，这个时候，就只有少数人是清醒的，这时候的民主也早已变样，多数服从少数才是正途。在严苛的户外环境中，真正活下来的都是强者，凭借自己的经验，不用也不能听取弱者的建议，这或许也是户外团领队强势的根本原因。</p>
<p>　　另一件事就是，地方政府为了不出事，就直接封闭了出事的源头，也是有意思。小地方的懒政一刀切可真是太省事了，不是说不安全吗，那就别过了，直接封禁，省了一笔人力物力，也不用操心担忧，多好。为人民服务早忘了，纳税人的钱也不知道用哪了，当然，如果真是人力有时尽那也算了。但一般都是因为不敢担责，不干事就不会错误，不出错就是没事，反正人民群众也无法投诉，就算投诉也是堂下何人状告本官。不干是为干，平庸是为好，在其位不谋其政，头上的乌纱帽还是要紧啊，这也和在私企里做事一样，没有 kpi 的事情干好也是白干，干坏就等着背锅，所以公司里才会有这么多屎山，也只能留下一批平庸的人。</p>
<h3 id="后记-12">后记</h3>
<p>　　虽然总算是顺利回京了，本来是想出来散心的，也没想到会碰到这些事，更糟心了，这周也是身心俱疲。下次得自己也做点攻略了，天气不太好，就不要强求，行程直接取消得了，不差这一回。</p>
<h2 id="泰山夜爬记">泰山夜爬记</h2>
<h3 id="前言-13">前言</h3>
<p>　　对泰山一直慕名已久，正好有个从北京出发泰山夜爬的活动，而且泰山这段时间还免门票，于是就报了个名。</p>
<h3 id="旅程篇-12">旅程篇</h3>
<p>　　从北京坐大巴出发，晚 8 点发车，到泰山景区已经是凌晨 2 点多了，直接从红门开始夜爬，很快就到了红门检票口。泰山的前半程路，到中天门为止，人一直都很少，起初还以为网上那种人山人海的现象是假的，到十八盘的时候，人开始多起来了，有点堵路的感觉了，等穿过十八盘，到龙门，就可以真正见到网上图片的样貌了，水泄不通，上的上山，下的下山，都很难动一步，有些人不想这么挤着走，就从台阶路旁边的小路上去了，速度确实要快很多，也能一直走到去往南天门的分叉路（可以经过南天门再去玉皇顶，也可以直接去玉皇顶），这一片人流，得一直堵到玉皇顶和南天门，就这大概 1/4 的路程，得走两小时。最后到泰山顶的时候，已经是凌晨六点十分了，天也开始变亮了，等着看日出的人确实不少，这个时候一定得厚着脸皮挤进去，虽然天气预报是多云，前两天还下了雪，感觉是没有日出了，但是总得挤进去试试，等到凌晨六点二十五分的时候，没想到太阳居然出来了，虽然没有炫丽的朝霞，但圆圆的红彤彤的太阳总还是能见到了，也算是圆满了。即使 Shaun 对日出并没有多少执念（小时候已经见过太多次了），但辛苦爬了上来，能见一次总还是极好的。</p>
<p>　　之后，在山顶又晃悠了一个小时，就准备下山了，开始的时候，是决定从东门出来，可是下了一段距离，前面有人返回说，这条路不通，由于修路，前面被拦路，不让下山，只得选择原路返回，从红门出，就这样，整个泰山的上下山路就只有这一条（其实还有桃花峪那条路，不过这条路出口离市区太远），可想而知，又得穿越人山人海，刚开始想坐索道下上，但索道也得等 2 小时，还是决定步行下吧，等到了中天门，又是 2 个多小时过去了，腿脚也开始有点难受了，就决定在中天门坐大巴下去了，坐车比走路还是舒服多了 😌。</p>
<p>　　下山之后，打车去了泰安老街的 集杰尚品海鲜烤肉自助餐厅(泰安爱琴海购物公园店)，种类比较多，味道也还不错，价格也非常喜人，单人 80，团体 70，吃饱喝足后，还能在旁边的公园里遛遛腿。等到下午 3 点半就坐大巴回京了，到租房已是晚上 12 点，出去玩一次还是挺累的，洗洗睡了。</p>
<h3 id="感想篇-7">感想篇</h3>
<p>　　泰山总的来说，登山难度较低，景区的台阶路非常好走，也没有很陡的坡，大多都是平稳上行，算是真正的老少皆宜，也可能是来祭天的帝皇太多了，原本陡峭的路也都修整了。泰山的文化底蕴也确实很厚，到处都是崖壁石刻，虽然夜爬上山时没看到，但下山却看到了很多。</p>
<p>　　泰山的夜爬步行道并没有路灯，一定得带上<strong>手电/头灯</strong>，即便是冬天爬泰山也不需要穿很厚的衣服，一件速干衣打底，一件透气的抓绒衣套外面就行，当然到山顶，刮大风的时候，还需要件防风的冲锋衣，这次夜爬，风倒不是很大，一直到山顶，没走动的时候，才需要套件防风的外套。</p>
<p>　　景区的物价可以说是非常亲民了，山脚下拐杖 5 元一根，还能讲价，老冰棍一元一根，水还是正常价，上山之后，物价会逐渐提高，但就算到中天门进十八盘处 2 元一瓶的饮用水也还是有的，和其他景区比，泰山山顶的物价也还算能接受。</p>
<p>　　这次去泰山还带了个护膝和一根登山杖，做了个对比实验，护膝确实还是有用处的，但也有限，登山杖也确实可以减轻一下腿部压力，总得来说，这两样东西也可以算得上是锦上添花的东西了，但打铁还得靠自身硬。</p>
<h3 id="后记-13">后记</h3>
<p>　　泰山的景区物价确实值得称道，但管理确实还有待提高，垃圾随处可见，塑料瓶也到处乱扔。封路这么大的事，居然没在路口处就竖立警示牌或全部封闭，等游客到了修路处才知道被封了，又得原路返回，这样上上下下来来回回，人都累瘫了。</p>
<p>　　这次泰山之行，也还算是比较圆满，唯一可惜的是下去的有点早了，没有看到冰晕奇观，这还是下山之后在泰山公众号上看到，才发现这天上午还出现了冰晕奇观，人就是这样，不知道可能不会当回事，知道了，反而会郁闷，尤其是当事物唾手可得的时候 ¯\_(ツ)_/¯。</p>
<h2 id="黄山三日游">黄山三日游</h2>
<h3 id="前言-14">前言</h3>
<p>　　黄山归来不看岳，这次清明去黄山也算是圆梦之旅了，走的也是纯旅游风，能不走路就不走路，所以基本上一天就把黄山的主流景点逛完了。行程路线很常规，第一天 玉屏索道上山-&gt;迎客松-&gt;莲花峰-&gt;一线天-&gt;鳌鱼峰-&gt;光明顶-&gt;飞来石；第二天上午 光明顶-&gt;西海网红火车-&gt;西海大峡谷-&gt;排云亭-&gt;猴子观海-&gt;始信峰-&gt;云谷索道下山；第二天下午和晚上 宏村；第三天上午 木坑竹海。</p>
<h3 id="第一日-1">第一日</h3>
<p>　　前一晚从北京坐软卧到黄山，一路看过去，发现南方的春天来的还是更早些，山基本都绿了。早上 9 点钟到黄山站，出门就有中巴车，不过这不是固定车次的班车，所以最好还是第一时间赶着上车，不然可能就只能选择打车去黄山风景区了。坐了一个多小时中巴车，车上的售票员也推销了一路的酒店和门票，顺利到达景区南大门，进站买到慈光阁的换乘票，对号入座，开了大约二十分钟，终于算是到景区起点了，可以选择徒步登山，也可以坐索道，Shaun 这次是来旅游，当然是坐索道。一下车，一片大雾弥漫，能见度小于十米，硬着头皮坐上缆车，周围一片白茫茫的，啥都看不到，就这样白坐了索道十几分钟，迷糊下了缆车，掏出登山杖开始正式游览黄山之旅。</p>
<p>　　出了缆车，直奔迎客松，由于水汽太大，只好把雨衣也披上，烟雨朦胧的黄山，也别有一番味道。由于是工作日，黄山的游览的人数整体来看不多，但来看迎客松的人也不算少，厚着脸皮挤进去拍了个迎客松的全身照，就马上出来了，此时，天空中下起了小雨，雾气好像更浓了。来都来了，虽然什么都看不到，但莲花峰总还是要走一遭的，由于人多，莲花峰限流，需要排队进去，也没多久，就可以开始爬莲花峰了，路上还是挺陡峭的，有爬华山的那种感觉，不过周边都是白雾，所以爬上去也没啥险峻的感觉。快登顶的时候，拍照打卡的人还是太多了，常规等得要一个小时以上，Shaun 也没那么要面皮了，反正都是挤，跟着往光明顶下山的人就挤到前面去了，就这样，经过半小时左右，算是成功登顶了莲花峰，往下看，还是一片白雾，风又大，快速下山了，雨也下的更大了，在厕所旁边等了会，眼看雨有变小的趋势，就又继续下山了。</p>
<p>　　行至百步云梯上方约百米处，有一巨石，旁立一板，板上曰，请勿攀登，奈何一板难挡观景之人，走上巨石，俯瞰远方，疑似蓬莱仙岛，云海为地，山峰耸立，雾气缭绕，变幻莫测，叹曰，黄山不负我。及至百步云梯，远望云海，留连忘返，却也不得不走。过一线天，登鳌鱼峰，至白云宾馆，放下行囊。下午四时，待雨息，游光明顶，去飞来石，惜白雾遮日落，复返白云宾馆，与室友闲聊，晚九时息。</p>
<h3 id="第二日-1">第二日</h3>
<p>　　凌晨四点半，起床去光明顶占位置看日出，雾气依然很大，以为看不见日出了，没想到，五点五十分的时候，太阳出来冒头了，虽然没看到绚丽的朝霞，但明亮的日出还是照亮了地平线，这算是黄山对游人的最大褒奖了。看完日出下来，黄山松上挂着半成品的雾凇，虽不是很粗，但还是稍微有点。以为今天会有云海，毕竟昨天下雨，所以就先不急着去看，先回宾馆洗漱吃早餐。吃完早餐出来去西海大峡谷坐网红小火车，没想到八点才开始，等坐上小火车的时候，云海已经完全散了，可惜，应该第一时间先去看云海的。西海缆车很快，不到十分钟就到了谷底，沿着大峡谷往上走，初期没有人，可以慢慢欣赏大峡谷的壮丽，大峡谷的景色和张家界非常类似，栈道也非常险峻，到了一环的时候，旅游团的人也进来了，人就多起来了，一人行的栈道也只能硬挤着人流过去了，早十点，顺利到达排云亭。出发前往猴子观海，没有云海，只有石猴，略显扫兴。猴子观海需原路返回，到路口去往始信峰，中间远观梦笔生花，始信峰上，下面就是万丈深渊，远望河床如一匹白练，开阔中带着刺激。下始信峰，直往云谷索道，进缆车，眺望黄山，风吹缆车摇，顿感压力。出缆车，进黄山地质博物馆，紫水晶很漂亮。买票出黄山，到寨西汽车总站，附近吃完中饭，寨西站买票去往宏村，至此上午行程结束。</p>
<p>　　下午逛宏村，私以为整个宏村的精华还是在旁边的那条小河，沿着河的上游一直往前走，踏在长满绿草的河岸上，看着一大片的学生在这里写生，就很惬意。虽然宏村内部的南湖和月沼水质不很好，但微风袭来，徽派建筑在湖面上的倒影确实像一幅水墨画，白天有白天的感觉，晚上有晚上的感觉。和中途结识的小伙伴一起在宏村吃了个晚餐，继续逛到晚八点，去青旅办理入住，休息。顺便查找去木坑竹海的交通方式，还好看到网上说宏村西门右侧有哈啰小电驴，这下彻底放心，可以安心睡觉了。</p>
<h3 id="第三日-1">第三日</h3>
<p>　　早六点半，起床逛早上的宏村，来到南湖，水面很平静，太阳也刚升起，映射到湖面上的倒影尤为动人，水天一色，山水入画，好一副春日树影图。早餐吃过西门口的黄山烧饼和豆浆之后，骑上小电驴就出发了，半个小时后，经塔川景区，来到了木坑竹海，在隧道口处停车，走路进木坑竹海，在门口就能感受到竹子的气息。进入景区，肉眼可见之处，全是竹子，不愧为竹海。绕竹海一圈，需爬升约一百米，竹海中的木坑村，家家户户都晒着竹笋干。走步道，吹竹风，听叶声，好生悠然。中午十二点，打车复返宏村，中间发生了一件趣事，滴滴师傅问，木坑竹海怎么样，Shaun 答曰，符合预期，还行，师傅回，木坑竹海就是个坑，专坑旅行者，好实诚的师傅 :D，不过旅游就是如此，本地人习以为常的东西，在外地人看来就很稀奇，体验一把之后，就很难想再来一次。</p>
<p>　　宏村吃完中饭，看还有时间，就决定再绕宏村一大圈，偶然发现，后山存在免票路线。一个小时绕完后，就去西门售票处买票乘车去黄山北站了，候车室也就是买票的地方，提前十到十五分钟，工作人员会喊。顺利到北站，坐车回京，此次黄山之旅就圆满结束了。</p>
<h3 id="后记-14">后记</h3>
<p>　　黄山的门票预约虽然有时间段选择，但其实没强制要求指定时间到，山上的棕噪鹛叫声很好听。第一天下午看时间和体力情况也可以去步仙桥，领略一下西海大峡谷另一侧的风光。黄山看日出就在光明顶炼丹峰旁边的那个平台就行，需要提前去抢个护栏位。云海有多种，有的像昙花一样，太阳出来后一小时就散了，而有的像棉花一样，太阳出来了只会显得更亮眼，所以真碰到下雨，雨后最好还是第一时间去看云海。木坑竹海比较小，两个多小时基本能逛一遍，所以如果下黄山比较早的话，其实也可以先去木坑竹海，回来之后就可以尽情的游览宏村了。</p>
<p>　　黄山之行，膝盖的伤痛还没完全恢复，所以这次是纯花钱旅游，带着登山杖和护膝，登山杖的效果确实是显而易见的。Shaun 对吃的向来不怎么介意，有啥吃啥，所以这次也没去真正花钱体验黄山的美食，当然和小伙伴在一起的时候也算吃过几个，但总感觉味道差点儿，还不如以前在上海吃的徽菜。本次黄山游，虽然日落没看到，但日出和半成品的雾凇都看到了，云海也是有了，算是圆梦了，很完美。</p>
<h3 id="附录-1">附录</h3>
<h4 id="费用-2210.42">费用 2210.42</h4>
<p>交通费 1512 北京到黄山（497.5）黄山站到黄山风景区中巴车（30）南大门换乘站到慈光阁（19）玉屏索道上（90）西海观光缆车（100）云谷索道下（80）云谷寺换乘到寨西汽车总站（19）寨西汽车总站到宏村（25）宏村到木坑竹海哈啰小电驴（17）木坑竹海到宏村打车费（5）宏村到黄山北站（30）黄山北到北京（599.5）</p>
<p>景区门票 33 木坑竹海门票（33）</p>
<p>餐费 258 第一天（12+20+30）第二天中（38）第二天晚（68）第三天早（11，烧饼很推荐）第三天中（73）第三天晚（6）</p>
<p>住宿费 284.92 第一天黄山白云宾馆（251.92） 第二天宏村清和月国际青年旅舍（33）</p>
<p>冤枉钱 122.5 黄山北到北京退票（116.5）宏村到黄山北退票（3）电驴没电（3）</p>
<h4 id="冤枉钱复盘">冤枉钱复盘</h4>
<ol type="1">
<li>在买到票但不满意的时候，最好是手动控制候补时间到前八天，不能完全相信有时间冲突就一定候补不成功，毕竟不了解后面的冲突判定逻辑，还是不要太相信程序员，不然可能在最后一天给候补到就只能花巨额退票费退票了 😫，当然真碰上需要退票的情况，最好是先改签再退票。</li>
<li>哈啰的小电驴上车之前最好看看电量和预估的里程数是不是很充足，不然中途没电就只能推着走了，还必须用二分法找停车点，不能直接导航到停车点，要命的是没电还要收费，就很离谱。</li>
</ol>
<h4 id="赋诗一首-1">赋诗一首</h4>
<p>雨落云海涌，日升雾涛开；山水环古镇，竹坑卷绿波；可怜风光在，奔波不由人。</p>
<h2 id="嵩山游记">嵩山游记</h2>
<h3 id="前言-15">前言</h3>
<p>　　嵩山少林，一直都很想去亲眼看看。这次正好有个徒步团有活动，就报名参加一起去了，抱团最大的好处就是省心，住宿和行程也都安排好了，不用额外做攻略计划。这次的游玩路程也很简单，第一天逛少林景区：少林寺 -&gt; 武僧表演 -&gt; 达摩洞 -&gt; 少林寺斋饭 -&gt; 塔林 -&gt; 嵩山（嵩杨）索道往返；第二天逛嵩阳景区：夜爬嵩山（从近嵩阳书院入口进） -&gt; 盘古殿附近看日出 -&gt; 峻极峰看云海 -&gt; 卢崖瀑布出。</p>
<h3 id="旅程篇-13">旅程篇</h3>
<p>　　提前买了特种兵套票（包含少林景区和嵩阳景区门票，以及嵩杨索道往返票等），从北京坐卧铺出发，晚 8 点发车，到郑州已经是第二天早上近 6 点了，包了个车，十几个人从郑州火车站出发直接前往少林寺，路过少林武术馆（表演时间为10:30，11:30，14:00，15:00，16:00），离表演开始时间还有两小时，于是决定先去少林寺，在少林寺逛了一圈，发现少林寺里面同样有武术表演，10 点开始，不过是收费的，30 元/人，就直接出来了，原路返回少林武术馆，还是免费的好。看完武术表演之后，和在少林寺里面看的人交流了一下，发现表演差不多，发现白嫖的更香了 :P。</p>
<p>　　之后，出发直接前往达摩洞，爬了会山，走上达摩洞，在上面吹了会风，看了下巨大的达摩雕像，就原路下撤了。也正好中午到了，就去少林寺旁边的少林欢喜地吃了顿斋饭，很便宜，就 10 块钱，包吃饱，需要注意的是，斋饭只到下午 1 点半，里面的商店也很便宜，水是外面正常价格。吃饭斋饭，前往塔林，可惜现在都围起来了，没法近距离观看，就一个缺口可以离的近一点看。之后准备去三皇寨，可惜的是三皇寨由于下大雨冲垮了一些路，导致整个景区不让进了，算是这次行程中一个遗憾，毕竟三皇寨算是整个嵩山景区最壮观的景点了，只能退而求其次，坐一下套票中包含的嵩杨索道，从索道上站走半小时就到凤凰台，远眺嵩山最高峰——连天峰，只觉得可惜没有游客能上去的路。</p>
<p>　　从凤凰台下来，出少林景区，坐车去登封市水韵阁宾馆，随便找了家饭店吃完饭就马上休息了。第二天凌晨 1 点半起床，洗漱完毕，打车前往嵩阳景区入口（也没想到凌晨还能打到车 😂），2 点开始夜爬，还不算难，都是台阶路，比较好走，特意穿的跑鞋，大约 5 点的时候，就登顶了，这次运气不错，虽然没有成团的云海，但雾气很浓，笼罩山下，也有种云海日出的感觉，霞光万道。看完日出，往卢崖瀑布方向下山，下山全长 9 公里，花了 4 小时，下山的一线天那块走的还是比较有感觉，其他的也是一般了，瀑布的水也不够多，不够壮观。</p>
<h3 id="感想篇-8">感想篇</h3>
<p>　　嵩山毕竟算是成熟的景区了，基础设施也还比较完善，路相对很好走。少林景区没啥坑点，尤其是斋饭里面的商店，简直可以发个锦旗，不过后面听同行的游客说，有看到卖烤肠的掉地上，拿擦桌子的抹布擦了下烤肠就又放进去了，也不知道后面会是哪个倒霉孩子吃了。嵩阳景区毕竟是夜爬，周边的东西还是看不太到，夜爬最重要的还是带上手电，毕竟虽然大部分路段都有路灯，但还是有少部分漆黑一片的。秋天的嵩山还比较凉爽，穿个防晒衣夜爬就差不多了，不过到山顶休息的时候，还是得穿个厚点的衣服，风比较大，有雨衣挡一下风也还行。登山杖还是有一个会比较好，不过得正确使用，能省不少体力。</p>
<h3 id="后记-15">后记</h3>
<p>　　这次能看到云海日出，也算是最大的幸运了，虽然三皇寨和卢崖瀑布留下了一些遗憾，但日出也都能弥补了，毕竟三皇寨常在，云海不常有。况且出去玩，或许有点遗憾才是圆满。</p>
<p>　　七十二峰蕴绝技，天下武功出少林；白雾寒纱透霞彩，红日朝晕染层云。</p>
<h2 id="衡山游记">衡山游记</h2>
<h3 id="前言-16">前言</h3>
<p>　　衡山作为五岳中最矮的山，也没啥很特殊的景点和文化，爬这山也仅仅只是为了打卡五岳而已。</p>
<h3 id="旅程篇-14">旅程篇</h3>
<p>　　国庆买票确实不容易，从老家到衡阳再到衡山西的票都是候补到的。从衡阳西出来，正好碰到另外两个人也去衡山，遂一起打车过去，其中还闹了个乌龙，原来拉人的师傅也是香店的老板，主要是拉人去买香的，不是专门拉客的，后面到店里的时候发现我们不买香，脸色立马就变了，最后按 10 元/人的正常价格给了老板车费，出门的时候还听见老板在骂骂咧咧的。</p>
<p>　　出了香店门，直奔衡山，发现时间还有点早，就在路边和另两个人侃了会儿大山，Shaun 买的是第二天凌晨的门票，而另两位是当晚的票，于是 Shaun 把之前找到的轨迹发给了另两人，相约在路上碰面。另两人先一个小时出发，最后 Shaun 赶上的时候已经到半山亭派出所了，同时发现又多了一个小伙伴，正所谓，出门不约伴，路上全靠捡。</p>
<p>　　一路上走走停停，很快也就到了南天门，风雨也愈发的大了，加点衣服，穿上雨衣继续出发，看周围飘着的雾气，就感觉今天的日出是没有着落了，但来都来了，总得到山顶看看。在距山顶 500 米的地方有个补给点，老板已经在准备早餐了，看时间还早，于是在这休息了一小时，直到老板要做生意了开始赶人。到山顶的时候，天刚露出鱼肚白，雨小了些，风还是很大，雾气也很大，湿气特别重，气温也低，到「南岳衡山」碑打了卡，就找了个风小的地方躲着，等祝融殿开门。</p>
<p>　　由于爬了一晚上的山，没有睡觉，这时候就只想找个地方靠着睡一下，但地面都还是湿的，也只能强撑着睡意。好不容易等到祝融殿开了门，发现里面主要还是拜神的，没啥玩的，就马上出来了。</p>
<p>　　开始下山，这个时候袜子也是湿的，雨也还没完全停，从来没有这么讨厌这场雨，好好的衡山之行就毁在这雨了 😭。下山的时候，碰到一件事，有个游客从路边小贩手里拿过一串手串看了下，小贩说 10 元一串，游客立马就还回去了，小贩骂骂咧咧的说到「不买就不要拿，一点都不懂规矩」，求神拜佛的东西确实还是少理少碰。</p>
<p>　　沿着梵音古道下山，到胜利坊已经是上午 11 点了，走路到「南岳汽车站」，再花 6 元坐班车到「衡山西」，班车不定时发车，需要主动问，汽车站候车室发车的时候会有人喊，需要注意听，班车要近半小时到衡山西站。</p>
<h3 id="感想篇-9">感想篇</h3>
<p>　　衡山景区非常成熟，可能是因为不高的原因，公路直接修到了山顶，坐车也可以直接坐到南天门，再沿着马路走很快就能到顶。到衡山的目的大部分人还是来烧香许愿的，去有些寺庙香都是免费送的，来衡山却是要自己买，山脚下全部都是卖香的店，也不便宜，不过好在明码标价，大抵是衡山也确实没有其他的收入了。</p>
<p>　　衡山 110 块的门票值或不值看个人想法了，Shaun 个人觉得是不太值，除去五岳的名头，也就是个很普通的山，没有啥特殊的景点，也就梵音古道稍微值得走走。</p>
<h3 id="后记-16">后记</h3>
<p>　　这次去衡山，确实天公不作美，夜爬到一半就下下雨，一直下到早上 9 点，虽然带了雨衣，但鞋只是普通的运动鞋，不防水，还好多带了双换洗的袜子，不然穿着湿袜子下山就难受了。由于下雨，山上也全是雾，啥也看不到 😮‍💨，山上又冷，天一亮，到祝融殿里瞅了一眼就出来了，又在山顶转悠了一下，看周边的雾气完全没有散的迹象，只能无奈下撤了。下次如果有机会再走衡山，应该会选择一条免票路线。</p>
<h2 id="大同两日游">大同两日游</h2>
<h3 id="前言-17">前言</h3>
<p>　　五岳就差北岳了，总还是得去打个卡，正好这次有个大同的活动，还能顺便去趟云冈石窟和悬空寺（与其说是去爬北岳，更不如说是想看看悬空寺）。这次的路线也比较悠闲，纯景区路线，第一天去直接大巴出发，去云冈石窟-&gt;华严寺-&gt;紫泥369粗粮季（晚餐）-&gt;高渡精品酒店（大同古城华严寺店）-&gt;城墙，第二天先去悬空寺-&gt;北岳恒山。</p>
<h3 id="旅程篇-15">旅程篇</h3>
<p>　　这次因为是报了团，直接大巴出行，省去了买火车票的烦恼，周六早上出发，坐了 5 小时的大巴，将近1点才到云冈石窟，跟着导游走了一圈石窟，听着北魏的故事，看着风化的年代感，2 小时就过去，再坐 1 小时的大巴，去大同古城逛华严寺，看看辽金风格的建筑，登华严宝塔，商业化不重，法相庄严。</p>
<p>　　从华严寺出来，就到了吃晚饭的时候，直接去附近的「紫泥369粗粮季」，等了会儿小伙伴，凑齐了一桌，直接点餐，服务员很专业和周到，还及时提醒菜够了，主食的分量确实都很足，其他的菜味道也很不错，大家都吃的饱饱的。吃完后回「高渡精品酒店」放行李，不远，走一会就到了，办理了入住，在酒店内给人和手机都充了会儿电，出门逛逛大同古城的夜市，人不多，径直去城墙，扫码预约，免费上城墙，很赞，在城墙试了试新手机拍照的效果，夜景还是不太行。从城墙上下来，已经是晚上 8 点半了，街上的行人愈发的少了，回酒店休息，一夜无话。</p>
<p>　　第二天早早的吃了酒店的早餐，运气不好，看到了菜里的苍蝇，餐厅的服务人员态度也不太行。出发去悬空寺，又是 1 小时的大巴，在景区门口就能远看悬空寺，都有点不想进去的感觉，不过景区门票也才 15 块，可以说是很便宜了，出发的时候有点小雨，顶着雨逛景区，近看了下悬空寺，感觉都是现代重建的，于是不想再花 100 元登上去看，而且从下看，更能看到悬空寺的全貌，以及悬空的结构，不得不感叹古人的智慧和艰辛。</p>
<p>　　出悬空寺，再半小时的大巴才到恒山景区，可选择徒步/摆渡车/缆车上山，下车的时候，雨更大了，天气也更冷了，不得不穿上雨衣，看着脚上普通的运动鞋，也只能这样上了，恒山海拔两千米，但徒步起点海拔也有一千三，是以爬升不多。一路上，随着海拔的上升，雨水变成了冰豆子，冰豆子夹杂着小雪花，小雪花变成了大雪花，及至封顶，已是白茫茫的一片，还得顶着大风，拍照的手机都不想拿出了，也没想到今年这么早就能看到雪了，可惜准备不够充分，只想快点下山，下山的时候发现，已经在半途中拦住不让游客登顶了，暗自庆幸上去的早，很辛运看到了恒山今年的初雪，更好的是，虽然缆车停了，但摆渡车没停，花了 13 快，只想快点下山。摆渡车里还是舒服，顺利返回大巴上，准备回京，没想到的是，回京路上居然堵车了，还差点因为大雪，高速封路，不让回京了，幸好司机师傅好说歹说，最终还是放行了。</p>
<h3 id="感想篇-10">感想篇</h3>
<p>　　这次大同游，可以说是玩的好，吃的好，睡的好，不管是景区门票还是吃住费用，大同相对都很实惠，虽然因为准备不够充分，好好的恒山雪景变成了一种磨难，但还是感觉很辛运，没有事故，哪来的故事，一路的平淡，又哪来出游的美好。</p>
<h3 id="后记-17">后记</h3>
<p>　　五岳，始于雪中，也终于雪中，虽说两次都行程满满，但西安六日，是硬着头皮上华山的，大同两日，上恒山就很轻松了，毕竟也经历了一年的成长，拔仙台都上了，东部其他的山想想也没那么难，况且都是景区，还是很好走的。恒山很好，门票也不贵，摆渡车更不贵，对比对面的衡山，可好太多了。</p>
<p>　　古寺悬北岳，石窟定武州；教化传天地，缘分渡世人。</p>
]]></content>
      <categories>
        <category>Life</category>
      </categories>
      <tags>
        <tag>record</tag>
      </tags>
  </entry>
  <entry>
    <title>关于中学的学习方法</title>
    <url>/posts/6be57d7f.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　前些日子，小叔说堂弟的学习有点不太能跟上了，让 Shaun 和堂弟聊聊，回想十几年前， 父亲也是这样找堂哥的，仍记得那年的寒暑假，算是 Shaun 进步最快的一年，也是奠定 Shaun 后续学习方法的一年，现在轮到小叔来找 Shaun ，虽说不能当面聊，指导效果会大打折扣，而且当年堂哥教的具体方法也早已忘记，转化为自己的思想和方法，所以 Shaun 也只能把自己的东西说给堂弟，也算是某种意义上的传承。</p>
<span id="more"></span>
<h2 id="序篇">序篇</h2>
<p>　　 Shaun 一直认为学习是有天赋，这种天赋体现在学习某一方面的事特别长记性，看个几眼就能完全记在脑海里，还能灵活变通记得的东西。同时，学习也需要方法的，在天赋不够的情况下，有个好的学习方法也能事半功倍。最后，学习是需要积累的，所谓的积累，就是增长见识，多练习，就中学而言，积累就是多做不同的题，同一类但举一反三的变题，在积累的足够多的情况下，考场上同样的题至少都是见过的，没有太多的心理压力，自然会好解一些。</p>
<p>　　当然中学的学习毕竟是通过考试来验证结果的，而这个结果才是最重要的（也算是一种唯结果论，不过现实如此，社会如此，没人能逃过，只以成败论英雄，唯一需要注意的是英雄很多时候是有保质期的，扯远了 😅），所以应试技巧也很重要，考试是一个在一定时间内如何得分最多的任务，即使是所有的题都能解，但超时了也没用，更何况大部分人只能解一部分，所以对于这种任务，最好是先快速扫一下卷子，心里先有个数（大概都是些啥题），后面再按部就班的的做，性价比低（要花费大量时间，得分又低）的后面再解。当然在绝对的实力面前，所谓的应试技巧都是虚幻，打铁还是得自身硬，应试本质上是一个熟练的事，需要大量的练习，简而言之就是多刷题 🤪。</p>
<p>　　闲话说完了，下面就是正文了，由于 Shaun 是理科生，仅记录 Shaun 还能记得的当年理科六门学科的学习经验。</p>
<h2 id="正篇">正篇</h2>
<h3 id="语文">语文</h3>
<p>　　语文一直是 Shaun 的弱项，不过从 Shaun 现在的经验再回过头去看语文，感觉语文考验的更多是对人生和社会的一种感悟，这种感悟不仅仅只是对于自身的体验，也是对别人人生经历和当时社会的一种体会。在学生时代，大部分人受限于家庭和外部环境因素，自身体验很少有丰富的，只能多体会别人的人生，别人的人生只能依赖多看书（小说传记历史都可以），最重要的是在读的时候能有自己的一些思考，假如自己在别人的处境下会是一种什么心态，会有什么行动，一些好的文章，作者为什么会那样描写，遣词造句。当然语文也有直接需要记忆的，字词拼音，古诗文这种，就全靠记忆背诵了。</p>
<h3 id="数学">数学</h3>
<p>　　中学数学最重要的两个分支就是代数和几何，以及介于两者之间的解析几何，于是也有了数学中最重要的思想——数形结合，抽象的数字有了形状，就不再那么枯燥。熟练使用函数图像以及对应的特点，数学及格就没啥问题了，至于几何，立体空间想象力不够的情况下，也可以加坐标系当解析几何计算了，不过就是时间花的多些。</p>
<p>　　导数算是函数中最核心的概念（导数以及对应的微分也会在高等数学中贯穿始终），函数导数的几何意义就是对应点切线的斜率，当在实际的物理场景下，导数也有其实际意义，比如路程关于时间的导数就是速度，速度关于时间的导数就是加速度。</p>
<p>　　数列可以认为是一种纯数字游戏，虽然通项公式或者递推式可以认为是某种函数，但数列本质还是数字自身的规律，这种更多的是经验和一种直觉，发现不了就是不能发现，无从下手也无法计算。</p>
<p>　　集合和数理逻辑，不等式，极值，推理与证明，对应的反证法。概率与排列组合，这类问题熟记公式，太难的问题，不会就是不会了 🙃。</p>
<p>　　向量计算，数形结合完美的体现，中学物理的利器，三角函数，向量的内外积，单位向量的意义，这些东西还是只能在练习中画图理解。向量这个数学工具的美，也只能在实际应用中体会，角度，投影，面积，距离（点点/点线/点面距离），坐标变换（旋转/平移/缩放）等等。</p>
<h3 id="英语">英语</h3>
<p>　　英语也是 Shaun 不太在行的，尤其是现在回想 Shaun 整个中学，英语及格的次数都屈指可数，初中英语最后一次考试能及格还是靠初三下死命的记单词，而高中英语也是到高三才能稳定的及格，原因也是单词和语法记少了，更重要的原因是对死记硬背很是反感，甚至由于这个原因还和高二的英语老师对着干，一上英语课 Shaun 就直接出去了，后来还好高三换了个英语老师，给 Shaun 稍微开了一段时间的小灶，就是让 Shaun 每天写篇英语作文，然后针对这篇作文进行指导批改，这种方式很适合 Shaun ，从此也算是踏上了英语及格之路， Shaun 现在依然很感激高三的英语老师。至于英语听力，这个没办法，只能靠多听，以 Shaun 现在的经验看来，每天都有一定的时间处在英语环境下，确实能提高听力水平，多听的频率很重要，不然过一段时间就没那种感觉了。</p>
<h3 id="物理">物理</h3>
<p>　　尤记得高一的物理也有很多次没及格，后来在堂哥的指导下，物理好歹也算是入门了，每次考个 80 分都还算轻松。目前还能记得堂哥教的物理学习方式就是手推公式，当然手推公式同样能应用到数学和化学上。所谓的手推公式就是利用一些基础的公式推导出一个复杂的公式，或者是两个复杂的公司来回推导，能够熟练的手推公式，圆周运动和电磁场问题公式层面的问题就能比较清楚了。至于受力分析，支撑力与面垂直，摩擦力与面平行，杆提供支撑力或许也有拉力，绳只提供拉力，可以假设圆周运动的离心力真实存在，与向心力平衡。至于能量守恒和动量守恒，这个只能多刷题了。</p>
<p>　　物理是和数学强绑定的一门学科，数学不行，物理不可能会好的，所以要学好物理得先学好数学。</p>
<h3 id="化学">化学</h3>
<p>　　 Shaun 算是有一定天赋的，看几遍书上的内容，就基本上都能记住了，不管是无机还是有机化学实验也基本都很清晰会有啥现象，每个元素的性质当时也都能记得，以至于看到一些常见的物质大概就能知道会有啥反应。不过还记得当时对于化学方程式配平， Shaun 还只能靠眼睛看，没啥方法，后来堂哥教了个得失电子法，同时针对性的做了大量的题，让 Shaun 领先全班一个学期熟练使用这个方法，在配平这类问题上基本没怎么丢过分。在刷题的过程中，也可以活用一些书上没见过的公式，曾经有次看到一个理想气体状态方程的公式，发现用这个公式可以很轻松的解释一些化学平衡的移动问题。化学在 Shaun 这里没怎么太刷过题，感觉就靠多看书了，熟记元素和物质的物理化学性质。</p>
<h3 id="生物">生物</h3>
<p>　　生物感觉没太多好说的，就实验而言和化学有点像，但需要记忆的东西更多，最需要计算的题也就是染色体概率和群落数量估计问题了，不过就算不会算，丢分也不多。</p>
<h2 id="总结">总结</h2>
<p>　　刷题是一种很有效的应试技巧，国内的大部分考试都能通过刷题解决，如果解决不了，那就多刷几遍，针对性的刷题会更有效果。</p>
<p>　　死记硬背也是一种方式，但能活学活用更重要，在使用中记忆会更好，理科有个很重要的思想就是推理，大部分结论或公式都能通过一些简单前提或公式推导出来，可以试试自己推导一些常用的公式（关于推导，数学科普领域有本书叫「天才引导的历程」可以看看），注重平时的练习，不要怕麻烦，熟才能生巧。</p>
<p>　　至于错题本，得看收集错题的方式，最好是一类题收集在一起，每种解题方式各收集一个经典的题型，后续有时间就翻翻回顾下，就 Shaun 个人的经验，记得很杂的错题本，往往起不到应有的效果，针对性的学习很重要，需要注意的是错题集不要做成了难题/怪题集。</p>
<p>　　独立思考，本意是指不要人云亦云，需要有自己的思考和看法（这本应该是每个人的必备技能，但没有的人确实不少）。在学习领域，特指在寻求问题答案的过程中，一定先得有个自己的思考过程，苦思不得的问题会更深刻，同时思考的过程也是自己串通知识点的过程，更容易知道自己的盲区。</p>
<p>　　因材施教，同样也因人学习，每个人在不同的学习环境下学习效率是不同的，有些人需要被人催促，需要更有压力一点才能学的好，而有些人更主动一些，在宽松的环境下学习更有效果。而目前的学校都是填鸭式教育，一视同仁，虽说每个学校的教学风格不太一样，但不一定适合学校内的每个学生，所以需要找到适合自己的方式。</p>
<h2 id="后记">后记</h2>
<p>　　回顾整个高中生涯，对 Shaun 影响最大的其实还是堂哥和高三的英语老师，当时的班主任虽然对 Shaun 也很好，但对 Shaun 的学习和做事方式影响就没那么大，只记得当时班主任常说的一句话——读书是能改变命运的。对于大部分人，读书确实是最可行的出路，其他的路不确定性会更多，虽说读书需要一定的天赋，但国内应试教育的本质注定了努力刷题是能弥补这一部分天赋的，当然，如果有个人能在刷题的路上再稍微指导一下，会走很多弯路，也更容易找到适合自己的学习和思考方式。</p>
]]></content>
      <categories>
        <category>Life</category>
      </categories>
      <tags>
        <tag>record</tag>
      </tags>
  </entry>
  <entry>
    <title>利用回调函数计算函数运行时间</title>
    <url>/posts/b6fb6109.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　曾有一段时间在写一个小程序，由于其对运行时间有要求，所以每写一段代码就要测试一下运行时间，如果超出就需要优化一下代码或换一种方法和算法。但是每次都需要插在某两个位置插两段代码感觉有点烦，也有点浪费时间，毕竟浪费时间就是浪费生命，本着保尔柯察金关于生命的言论，Shaun 不愿虚度年华，所以只得寻找一个方便简洁的方法计算运行时间（说了这么多，说到底其实就是懒吧 */ω\*）。后面就想到了回调函数，将想要计算运行时间的代码段放入一个函数中，并将其作为回调函数，用事先写好的计算时间函数调用它，从而方便计算该代码段的运行时间。</p>
<span id="more"></span>
<h2 id="正文">正文</h2>
<p>Show u the code，具体 C++ 实现代码为：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctime&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _CALLED_ printf(<span class="meta-string">&quot;The function %s&quot;</span>, __FUNCTION__);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用回调函数计算一段代码执行时间</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">computeTotalTime</span><span class="params">(<span class="keyword">void</span>(*processingCallback)() = <span class="number">0</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">clock_t</span> start_time = <span class="built_in">clock</span>();</span><br><span class="line">	<span class="built_in">processingCallback</span>();</span><br><span class="line">	<span class="keyword">clock_t</span> end_time = <span class="built_in">clock</span>();</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot; takes: %fs.\n&quot;</span>, (<span class="keyword">double</span>)(end_time - start_time) / CLOCKS_PER_SEC);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Hello World!\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	_CALLED_;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">computeTotalTime</span>(test);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p><em>以上代码在 Win10 VS2013 中编译运行成功。</em></p>
<h2 id="后记">后记</h2>
<p>　　本来是想在网上找一个的，谁知道并没有找到，就只有自己动手实现一个了 ╮(╯_╰)╭。后面使用了一下该函数，发现好像并没有提高生产力 o(╯□╰)o，所以就没人放在网上？-_-!，不过确实从实现过程中学到了一些东西 ↖(^ω^)↗。</p>
<h2 id="参考资料">参考资料</h2>
<p>[1] <a href="http://www.cnblogs.com/danshui/archive/2012/01/02/2310114.html">C/C++之回调函数</a>（<a href="http://www.cnblogs.com/danshui/category/345046.html" class="uri">http://www.cnblogs.com/danshui/category/345046.html</a>）</p>
<p>[2] <a href="http://blog.csdn.net/coder_xia/article/details/6566708">c/c++在windows下获取时间和计算时间差的几种方法总结</a>（<a href="http://blog.csdn.net/coder_xia/article/category/837943" class="uri">http://blog.csdn.net/coder_xia/article/category/837943</a>）</p>
<p>[3] <a href="http://www.cnblogs.com/steady/archive/2011/03/08/1977029.html">(转)用宏获取函数名</a>（<a href="http://www.cnblogs.com/steady/category/264974.html" class="uri">http://www.cnblogs.com/steady/category/264974.html</a>）</p>
]]></content>
      <categories>
        <category>Study</category>
      </categories>
      <tags>
        <tag>c/cpp</tag>
      </tags>
  </entry>
  <entry>
    <title>别了，漆黑的象牙塔</title>
    <url>/posts/170c76cc.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　这是 Shaun 从朋友那里听来的一个故事。此真实事件根据故事改编，如有雷同，实属正常。</p>
<span id="more"></span>
<h2 id="序篇">序篇</h2>
<p>　　故事还得从朋友大四上学期说起。大四上学期在确定能保研之后，因为这个时代只要有保研资格就可以随便去哪所学校，本校并不会干涉，由于朋友本科所在的院校并不是非常好，所以朋友就查阅了一些更好的学校（毕竟人往高处走，水往低处流，这可以理解），可惜国内顶尖的学校都要求英语很好，而朋友的英语成绩一直不好，甚至可以说是最差的，所以朋友就直接放弃了那些顶尖院校（不过也是朋友当年见识太短浅，其实除开那些真正的顶尖院校，还是有些更好的机会的），既然顶尖的学校进不去，那就去看看一流的院校吧，其中发现一所学校的要求很简单，基本不要求什么英语能力，所以朋友就考虑一下，找了一下自己真正感兴趣的东西，然后就去发邮件联系了一下那所院校研究那个方面的一个老师，当时写邮件等消息的时候，朋友的心情还是很忐忑的，终于，那边的老师回了消息：欢迎报考。</p>
<p>　　后面在推免系统中填志愿的时候，朋友就直接填了那所院校，这其中发生了些小插曲，就是朋友当时很年轻，想着读个学硕试试，结果等了一天，没有消息，朋友的身边有个同学已经拿到了学硕录取通知，所以第二天一大早朋友就直接给那边招生的地方打了个电话，问那边是否学硕名额是否招满了，专硕还有没有招满，当听到学硕已经招满，但专硕还没招满时，朋友心里当时还是有点失落的，但没办法，只能将学硕的志愿改成专硕了，还好最后顺利的进入了那所学校。拿到录取通知后，朋友试着和那位老师接触了几次，在接触的过程中发现，这位老师应该不是朋友理想中的老师，甚至可以说有点差劲了，但朋友当时还是太年轻，脸皮薄，不好意思再去找其它的老师，因为这个时候老师还没有完全确定，其实还是可以换老师的。说到这里，朋友总结了几点教训，算是给后来者的参考吧，由于朋友没考过研，所以不知道考研是怎么回事，以下几点主要针对可能保研的童靴：</p>
<ol type="1">
<li>一般的学校可能要到大四上才能完全确定保研资格（有的学校大三下就完全确定了），而有些研究生机构在大三暑假期间可能就把录取名额基本确定了，所以如果在大三下觉得自己能保研并且有保研的想法，判断自己能不能保研很简单，拿着上一届保研的人数百分比，在计算一下自己在专业排名前百分之多少，再考虑一下排名后面的保研加分情况，就能判断自己能不能保研，毕竟不出意外的话，同一个专业的保研比率是基本变化不大的，朋友当年对自己很没自信，所以就丧失了一些机会，不过朋友在本科期间也确实没有什么能拿的出手的成绩，所以就算有这些机会也没用。在判断自己能保研之后，就可以去网上查阅资料，看哪些院校机构是在暑假或9月份就确定录取名额的，可以选择报名参加对方的夏令营或类似活动了，这里需要注意，有些院校机构保研录取对夏令营很看重，而有些夏令营活动则基本没用，报名之前多查查问问吧。</li>
<li>在选老师时，如果没有找好确切的目标，就不要去随意的联系一个老师，最好做好调查再去，因为没人会想把自己未来几年的生活赌在虚无缥缈的命运上吧，毕竟研究生的老师直接决定研究生生涯过的咋样，老师很差劲，可能一辈子都毁了，至于如何找一个相对理想的老师，以下两类老师不要优先考虑：1、<strong>50岁以上不在科研一线的老师</strong>，因为年纪大而又不在科研一线基本就和科研完全脱离了，而这个岁数的老师既要为父母孩子考虑还要为自己退休考虑，所以基本上会尽量去捞钱，而且由于他们在象牙塔里呆了一辈子，基本也和外面的社会脱节了，所以别想着他们会对学生有任何帮助，不阻碍学生的发展就是积阴德了，而且这个年纪的老师有一部分思想还停留在旧社会，认为学生即学徒，是师傅的奴隶，极其不尊重学生；2、<strong>女老师</strong>，这不是朋友性别歧视，而是以朋友这些年的见识来看，女老师的一堆屁事确实比男老师要多一点，要学生干着干那的，写文档写报告拿快递，甚至还有备课等等，当然并不是所有的女老师都是这样，甚至有些女老师比男老师还要好很多，这个不能一概而论，只是从朋友有限的见识来看，碰到一个好女老师的可能性有点低，不过如果能百分百确信该老师是个真正的好老师，就放心大胆的报吧。因为这两类老师能够非常直观的知道，当然还有一类相对来说也比较容易知道，那就是<strong>太闲的老师</strong>，一个很好的判定标准就是：经常呆在办公室的老师一般很闲。太闲的老师一般闲着没事干，没事干就会想着怎么给学生找点事做，顺便也充实下自己的工作生活，于是学生就不好过了。其它的可能就必须要亲身体会才能知道了，这就基本很难查到了，朋友就不谈了，反正只要知道一个，就是好老师都是相似的，而坏老师各有各的坏，好老师是能真正为学生考虑的，知道学生想要什么，而不是打着“为你好”的旗号行各种各样损人而又不一定利己的坏事。至于如何调查一个老师，首先当然是院校老师的主页，其次就是知网（可别问 Shaun 什么是知网），再次就是谷歌学术（也别和 Shaun 说不存在这个网站），最后是科学网等一些网站了，基本查完这些，就能对老师的学术水平有一定的认识，甚至对人品也会有一点了解，会不会抢学生的一作，至于老师真正的人品咋样，如果能联系上在 ta 手下读研且已经毕业的学长学姐是最好的，如果联系不上那就听天由命吧，毕竟人与人之间的相处是玄学，你与我相处不好，但和别人相处很好。还有就是老师作为一个人，一般就拥有人的一些特性，其对待同事一个样，对待朋友一个样，对待。。。。。。，对待学生一个样，所以作为一个学生最好的就是从老师的学生处打听，当然基于某些原因别人一般也不会如实说，更重要的是，随着老师的年纪和在学院的地位不断提升，简而言之，就是老师在其教学生涯的不同时期对学生的态度也是不同的，所以选择一个老师，其实还是挺看运气的。<strong>PS：</strong> <em>当一个实验室有很多个老师而实验室大老板控制欲很强时，慎选该实验室，要选也优先选大老板</em>。</li>
<li>如果在大三下学期没有认真准备保研的事，而是在拿到确切的保研名额之后才着手保研的事，那么就不要吝啬电话费了，碰到心仪的院校机构就去打电话一个一个的问吧，万一运气不错，还有在招的呢。其次就是对于已经填了志愿的人，一般院校机构会在第一天就把学硕的名额确定下来（也有特殊，可能第一天就把学硕专硕名额都确定下来，也有可能还没开始确定录取名额），所以如果第一天没有任何消息，第二天就最好打个电话去问一下，像朋友那样，还能马上改志愿，没记错的话，填一个志愿会锁定三天，除非填的志愿院校帮你主动解锁。录取之后就可以着手找老师了，毕竟录取之后和确定导师之间还是有一段时间的，当然如果着急的话，可以在拿到保研名额之后马上去找老师，如果找的老师能量比较大的话，说不定还会对录取有帮助，不过有些老师不太喜欢还没有被录取的人去找 ta，所以这个就看个人情况了，等到完全确定好老师之后，最好就不要去找老师了，好好在本校完成毕业设计，享受未来几十年里可能是最美好的半年吧，不过有一点就是如果在还没完全确定老师之前，如果发现自己之前选的老师有点差劲，尽快联系新的老师，最好不是同一个研究方向的，不是同一个研究团队的，然后想一个冠冕堂皇的理由说服两位老师，最好在找到之后才把你之前联系过一位老师的事和新老师说一下，不过一旦决定要找新老师，就一定要一条路走到黑，一定要找到一位新老师，不然还回到原来的老师手下可能不会很好过，虽说老师之间是同事，但还是有不同利益集团的，所以如果要找的话，还是能找到的，前提是打听清楚。其实，从朋友角度来说，什么叫兽砖家园长都是虚的，导师的为人才是最重要的，人好的话选个刚博士毕业的讲师都可以。</li>
<li>针对保研在本校的童靴，有些童靴不想去外校，关于这点，朋友也只能感叹人各有志，但是有一点想说，<strong><em>本科的教学老师和研究生导师是两副嘴脸</em></strong>，言尽于此，点到为止。</li>
</ol>
<p>　　好了，关于朋友总结的教训就写到这里了。上文说到朋友虽然觉得找的老师可能会很差劲但由于胆子小脸皮薄没有另找其它的老师，所以就确定是这个老师了，但后面大四下学期的时候，那个学校通知朋友去签约的时候却是另一位老师，朋友之前没经历过，觉得又忐忑又奇怪，最后签约的时候被告知，以后的研究生导师就是这位签约的导师了，朋友当时感觉其实挺莫名其妙的，但后面想了想，换个老师说不定也是个好事，就没去在意了，只是觉得原来的老师是真的不行，拿着手下的学生送人情，这玩的一手好牌啊，接不了这么多，就直接回绝或者另外推荐啊，后面读研究生的时候，对那位导师有了进一步的认识，发现还真是个坑逼，还好没真的进去，但朋友真正读研的这个实验室也并不是个什么好去处，差劲的老师各有各的差劲法。接下来就是朋友真正读研时的故事了。</p>
<h2 id="正篇">正篇</h2>
<p>　　本科快毕业的时候，朋友还满心以为自己还有一个暑假，谁知在刚毕业的时候就被导师叫去实验室了，由于此时还不是正式的研究生，所以学校也不安排住宿，只能去外面找房子住，两个月短租的房子确实不好找，导师叫朋友自行解决，住宿费也自行解决（叫学生过来住宿的地方不解决就算了，房租也不能报销 🤮），朋友好不容易找到了房子（最后租房到期的时候还被恶心的二房东坑了押金，还没正式步入社会就被上了一课），于是开始研究生的熟悉阶段，同时也开始了噩梦般的两年。</p>
<p>　　在暑假刚开始第一次例会时，朋友和同学做了下自我介绍，随后开始听师兄师姐们的汇报，只觉得师兄师姐们研究的东西都十分高大上，完全听不懂，平均每个人的例会时间在半个小时左右，先是师兄师姐们讲 ppt，然后导师提问题，然后指出不足的地方（是不是觉得很正常，接着看吧 ๑乛◡乛๑），整个实验室例会搞完之后，一个上午就过去了，导师就开始总结，说我们实验室是要求发论文的，朋友当时年轻，就想着发论文好啊，这实验室还可以啊，接着说像朋友这些刚进来的学生下周开始也要做 ppt，像师兄师姐一样汇报工作了，朋友一听这就懵了，做 ppt？怎么做？以前没搞过啊，只好去问问师兄师姐了，于是师兄师姐就给了些模板，至于内容，就下周再做吧。过了一周，第二次例会的时候，从开始的时候，朋友就感觉有点不对劲，由于师兄师姐的研究一直没有好的进展，导师就像吃了火药一般，疯狂的怼人，好好的一次例会，硬是开成了一场批斗会，于是有一部分同学顺利的推迟到下午汇报了。在中午吃饭的时候，朋友就问师兄师姐导师今天怎么了，师兄师姐就告诉朋友，这是经常发生的事，别太放在心上，ta 怼人完全只凭自己的喜怒，和你做的 ppt，和你上周的研究工作情况都关系不大，有时心情好就不怼，有时心情不好就使劲挑刺，你以后就知道了。到了下午的时候，导师又把全实验室的同学（包括上午汇报过的）叫去了会议室继续上午的例会，美其名曰让实验室同门多听听其它人的汇报，多交流交流，但朋友看师兄师姐们平时基本不交流科研，毕竟每个人搞的方向都不一样，甚至有些连大方向都不一定相同，这交流起来太困难了，师兄师姐们也基本上是各搞各的，于是汇报完自己的东西之后，都在底下玩手机了。于是朋友就这样在一周一周的例会当中度过了自己的暑假，熟悉了实验室，也对导师有了更深的认识，当然也还是漫无目的的看着论文，没有找到确切的研究方向，导师也只是在每次例会上说些套话，建设性的意见不多。</p>
<p>　　暑假就这样过完了，终于开学了，朋友也搬到了学校的宿舍住了，由于开学时，研二的师兄师姐们要找工作，研一的也要上课，所以就停了一个半月的例会（对，没错，导师只给了朋友师兄师姐们一个半月的找工作时间），朋友说研究生上课和本科生上课没什么两样，都是玩手机 ๑乛◡乛๑。一个半月之后，就又开始了正常的例会，包括研一还要上课的，导师会选择一个合适的时间，朋友又开始了新一轮的批斗大会。在这次例会中，很明显能看出导师开始催研二的论文了，甚至直接开口说，如果发不出论文，第二年就可以考虑延毕了，当然，到最后，师兄师姐们没有发出论文，导师最后还是让他们毕业了，只是这其中的过程实在是恶心，甚至有两位都被单独叫出去约谈说要延毕。</p>
<p>　　不过，师兄师姐们好歹是顺利毕业了，朋友能不能顺利毕业当时还未可知，师兄师姐们走了，朋友的保护伞也没了，只有自己硬着头皮迎接狂风暴雨了。在师兄师姐们走后的第一次例会，导师就说，你们不要学你们的师兄师姐，他们的论文一拖再拖，也是我不忍心，所以就让他们毕业了，但你们不同，你们必须要给我发出一篇论文来，下周就准备你们的开题报告，这个暑假有一部分人需要到外地做项目，因为接了个横向项目，也是为了实验室的经费。6 月底就准备开题报告，估计在朋友那学院里也是罕见的了，至于做项目这事，朋友到没啥抵触，做完项目不发论文能顺利毕业就行，于是在接下来的一次例会中，朋友及部分同学幸运的被选中去外地做项目了，但此时朋友高兴的太早了，虽然做项目不用例会，但导师要求还是比较严，甚至要求在空闲时间继续看论文，更重要的是朋友忽略了一件大事。</p>
<p>　　这件大事就是找工作，因为去外地做项目势必会影响找工作，做项目势必会影响找工作的准备阶段，准备的时间肯定会变少，因为白天要上班，虽然导师安排了住的酒店，但是在酒店里确实不好复习，虽然晚上在上班的地方能比较好的复习，但据朋友说，导师晚上也会在，这样就没法复习了。朋友原以为导师应该不会去多久，没想到，导师有大半的时间都在那边，监督朋友干活，真的只是监督，一些需求让朋友那些同学和甲方自己讨论，自己一般做甩手掌柜，不过有时为了表现自己，体现自己的存在感，会急功近利的提出一些不太明确的需求让朋友那些同学快点做完，最后可能又会推翻重做，有时甚至会提出一些和甲方不一样的需求，白白浪费朋友那些同学的时间。导师插手的需求，朋友那些同学一般做的十分痛苦，因为导师会催促朋友那些同学快点做完，每天来看个好几次，问一下进度怎么样了，有时甚至要求加班也要做完。甲方那边也有一个懂技术的小领导，ta 会看朋友那些同学的具体实现，让朋友那些同学完全照着 ta 的想法写，但是 ta 事先说明的又不清楚，因为 ta 自己也忘记了这个项目里的一些具体细节，导致朋友那些同学有些功能明明已经实现了，最后又要照着 ta 的想法重写。虽然朋友那些同学在外地做项目碰到这样那样的蛋疼事情，但总的来说还是比呆在实验室要开心一些的，每周一次批斗大会实在是太难受了，唯一不好的是确实是影响找工作，导师不在的时候还好，至少晚上和周末还能在上班的地方准备准备，但是也提心吊胆的，因为甲方有极小的可能性会来检查，导师在的话，就别想准备了，因为导师肯定会在旁边看着，酒店里又实在不方便准备。等到 8 月底，导师觉得朋友部分人应该要回去校招了，于是让他们把手上的事情快点做完，让甲方验收一下，然后就可以买票回学校了。</p>
<p>　　回学校的第二天，朋友就迎来了人生中第一场面试，因为在那边已经做过几场笔试了，不出意外，当然是挂了。当朋友听到面试官说，好了，今天的面试就到这里了，你可以先回去了，有消息我们会通知你的。还天真的以为真的会有消息通知，而不曾想到这是约定俗成的套话，表示你面试挂了。不得已，朋友只好一边面试一边预习相关的面试资料，顺便在网上找点面经突击一下，不得不说，找面经突击还是有用的，一般面试官都是直接从题库中选几道题出来问，同一个面试官问相同题目的概率也比较大，所以朋友说面经确实有用，而且面的的多了就会发现，一些基本的题面试官都会问，所以朋友从刚开始的只能回答一部分到后面的面试基本都能回答上，所以整个秋招还是拿了些 Offer，最终朋友挑选了个看好的。整个找工作过程中，朋友算是安稳的度过了近 2 月，但其中还是有件很操蛋的事，就是在找工作的高峰期，导师仍然朋友去外地干了一星期活，理由是甲方上头那段时间要检查，必须去甲方那把部分活快点搞完，这搞得朋友直接放弃了几场还算好的公司的面试，又耽误了朋友不少找工作的时间，要知道朋友那年校招就那两星期，基本大公司全在那两星期搞完，就这还浪费了一星期，朋友当时想死的心都有了，tmd 读个研不就是为了找个好工作，专硕搞个屁的科研，就为了导师的钱途可以直接忽略学生的前途，甚至耽误学生的下半辈子。</p>
<p>　　10 月底，导师就说，朋友这一届的不管找没找到工作，都必须到实验室来正常搞论文了。所以虽然朋友还在等一些公司的消息，但还是只能先停下找工作的事，乖乖的每天去实验室，开始正常的每周例会，一开就又要浪费半天甚至一天。开了一两周例会后，由于甲方那边又有事情要做了，所以导师就又叫朋友那些同学去外地接着干活了，没办法，论文的事只能又暂时放下了。就这样，又平静的度过了一个半月的做项目时间，同时也迎来了朋友学生生涯中的最后一个寒假。还好在寒假中，导师并没有打扰朋友，据朋友说，朋友见过有一个导师连两个多星期的寒假都不让学生好好过，每天都让学生汇报昨天做了啥。</p>
<p>　　如果说，前面一年半只是噩梦，那最后半年就是真正的地狱，朋友每周的定时批斗大会从不会落下，平均算下来，除了前面几分钟的 ppt 时间，至少要批斗半小时，又从来都没有提出任何有建设性的意见，全是些套话，不回话还好，一回话就各种花式怼，即使导师自己用来怼的话前后矛盾，纯粹的为怼而怼，从全方面否定学生的工作，这也不行，那也不行，就差没直接人身攻击了。朋友每周都承受着巨大的心理压力撰写论文，在临近提交论文的时候，朋友看了下别人的论文，心理只能苦笑，那样的论文在朋友实验室怕是要延毕了，但别人照样顺利毕业了，可见能不能顺利毕业和导师的关系更大一些，朋友在答辩后听过一个更荒诞的真实故事，就是一个学生因为没有帮导师做事，偷偷去外面实习了，最后论文完整的写完了，在答辩的时候，那位老师直接说，这位同学没做什么事，于是直接挂了，只能延毕了，而另一位同学十分仓促的把论文写完了，因为一直在外地帮导师干活，在答辩的时候，导师直接说，这位同学做了很多事的，于是拿了个大修，还是顺利毕业了。</p>
<p>　　总而言之，朋友最终还是顺利毕业了，也算是一大幸事，导师虽然对朋友的未来造成了一定的影响，但至少还没有完全毁掉，只是留下了两年刻骨铭心的心理阴影，可以说是至少击败了全国 10% 的研究生吧，以乐观派观点看待朋友导师，勉强还行吧。</p>
<h2 id="槽篇">槽篇</h2>
<p>　　槽篇，Shaun 纠结了很久到底要不要发出来，最终还是决定把它发出来罢。</p>
<p>　　据朋友吐槽，导师曾经在每周例会上直接 diss 人家的顶会论文，可是自己一辈子看的英文论文都没有学生两年看的多，至于自己发英文论文，那怕是个笑话了，就这样，还每次例会都要教学生怎么写，教学生怎么发 C 类论文 🤣。在每次例会上，导师干的最多的事就是毫无道理的杠学生，怼学生，钻牛角尖，举一些奇葩的例子杠学生，以表现自己的优越感，而为了维持自己在学生面前的这种优越感，总能够从某个刁钻的角度证明学生是错的，即使自己说话前后矛盾，上次例会为怼学生说的话，到了这次例会为怼学生而能说出完全相反的话，为怼学生真是可以不惜一切代价，即使说话像放屁一样。在李笑来的「韭菜的自我修养」中有这样一句话，把自己做过的错事合理化，对李这个人 Shaun 不做评价，但他关于<em>合理化愚蠢行为即为傻Ⅹ</em> 的说法 Shaun 还是认可的。</p>
<p>　　朋友导师有时会怀着恶意随意揣测学生的想法，自己听不懂手下学生的汇报，就直接开怼，说学生自己思路不清晰，没有想法，当学生没做出成果的时候，导师有时甚至会很开心的样子，因为这证明了学生的路子错了，而当学生有成果时，就会用奇葩的例子开怼学生了，直到学生说在这个情况下效果不好，如果学生说暂时还没试过这种情况，导师又会用严厉的语气说那你马上去试试啊，或者直接说，你考虑一点都不周到，没有搞科研的样子，反正要证明学生错了，导师就开心了。</p>
<p>　　最有意思的是，在朋友临近找工作时，导师竟然说，就瞄准一两个目标投就好了，别广撒网，挑挑拣拣的了，选择一个合适的就好，乍一听，这话挺有道理的，确实投太多的公司会分散一些精力，但仔细一想，这话没有一点道理，说的好像投了就能拿到 offer 一样，而且请注意，导师并没有给朋友找工作的准备时间，朋友是边找工作边看相关资料，最后才好不容易拿到几个 offer，如果真听导师的话，那朋友可以直接准备社招了。一个一辈子都呆在象牙塔里，从来不需要主动找工作的人居然教手下的学生如何找工作，真 tm 有意思 🙂。<strong>PS：</strong> <em>如果听到有哪位老师会主动帮学生找工作，那不用想了，99% 的可能性是坑逼</em> 。</p>
<p>　　在朋友临近毕业时，导师对朋友毕业论文的格式仍存有疑问，要知道朋友是直接在上一届师兄师姐们的论文格式上填充内容的，可以说在格式上和上届基本一模一样了，上届能顺利毕业，到了朋友这届就要被怼了，虽然朋友最后还是拿着这种格式毕业了，不过到毕业还要恶心人，朋友想必是十分难受了。朋友导师看了一辈子的毕业论文，到最后都没有个固定的论文模板，只知道让学生去官网上看，但官网上的文件已经快十年没更新了，还哪来的模板，这种情况下，上届的模板不就是最好的格式模板吗？</p>
<p>　　据朋友所说，导师也是看人行事的，对于极少部分手下的学生还是能够以正常的态度交流，对于大部分当然就是使劲的怼了，该导师会认为自己本校的学生很优秀，不会说什么，但对于外校的学生认为其很垃圾，写的东西也很垃圾，一无是处，但是碰到什么事又会让外校的学生做，很奇葩的思想。这样的导师挂名是烟酒僧的指导老师，但行事怎么看都是在阻碍自己手下烟酒僧的发展，绞尽脑汁的想着如何驱使自己手下的烟酒僧，为自己牟取更多的利益，从来不会想着自己做了多少事，对手下烟酒僧的影响如何，自己的晋升和项目收入 90% 以上都要依靠自己手下的烟酒僧，只要出一点微不足道的力就能拿到全部的功劳，真 tm 是好买卖。此类阻碍老师，吃着学生的人血馒头以肥自身，就算只是一点蝇头小利，若是需要牺牲自己手下烟酒僧的前途未来，估计也会在所不惜，毕竟手下的烟酒僧就这么两三年，不用白不用，管他死活。更有甚者，若是手下烟酒僧不能给自己带来一些利益，就会对其冷眼相待，甚至背地里穿小鞋。这种阻碍老师也就只能在自己手下的烟酒僧面前耀武扬威了，在外面的金主爸爸面前，就像条🐶一样，不过这或许就是人吧。</p>
<p>　　这样的环境和象牙塔之外的环境有何区别，甚至还不如，毕竟在外面的环境下，员工能拿到的东西远远要比学生拿到的要多，虽然对老板和导师来说，不能为自己创造价值的都是应该被丢弃的垃圾。不过这毕竟是象牙塔，难道就没有一丁点师者行为，只剩下赤裸裸的权利关系，这样的象牙塔，完全被这些阻碍老师给污染了，变成了漆黑的象牙塔。或许等这一代的那些阻碍老师全部退休之后，或许国内的整个教育环境会好一点，不过也或许是另一个勇者斗恶龙的故事，从 Shaun 目前的见识来看，由一个勇者成为恶龙的可能性更大一点，毕竟环境造就人材，很少有人能够跳脱环境的束缚。</p>
<p>　　虽然有这么多阻碍老师存在，但也有真正的好导师存在，就朋友的见识，有童靴读研究生比读本科还要轻松自在许多，这只能感叹人与人之间的差距真的可能比天堂和地狱之间的差距还要大。虽然朋友个人对于读研的累和轻松没有太多的看法，毕竟身体上的劳累和轻松是由自己决定自己感受的，朋友唯一在意的是心累，和一个阻碍老师交流一次真的是身心俱疲，尤其是还每周都要这样交流一次，一般上班都不会有这么累，朋友是真的心累。</p>
<p>　　有些看客可能会觉得朋友经历的事情并不怎么样，甚至会觉得这点小事就受不了了，还怎么成大事，这里 Shaun 只能说，有些事情只有自己亲身经历过才能体会，别人说啥都没用的，事情没有发生在自己头上，永远不会知道自己会有什么反应，而且就算是同一件事发生在不同人身上也会造成不同的后果，站着说话不腰疼的人希望您在学习工作生活中多碰到一些像朋友导师这样的老师上级长辈吧。吃瓜群众就当看个故事爽爽吧，信则有之，不信则无。</p>
<h2 id="后记">后记</h2>
<p>　　这算是 Shaun 目前为止写的最长的一篇了，主要是那天和朋友碰面后，出于好奇，就问了下朋友烟酒僧的情况，没想到朋友居然过的这么惨，于是 Shaun 根据当时的回忆就记录了一下，证明其存在过，朋友也经历过，也顺便提醒一下后来者，烟酒僧导师可是直接关乎整个研究僧阶段的学习生活等方方面面，所以在选的时候一定要慎重，差的导师甚至能直接毁掉学生的一辈子，当然 Shaun 在这里无论怎么说可能也没用，因为学生基本没有选择的权力，唯一的权力是选择不读，之所以还说是为了让后来者有个心理准备，当然好的导师也有不少，只能说朋友运气太差眼光也太差。</p>
<h2 id="附录">附录</h2>
<p>附朋友导师经典语录，括号里的是朋友的心声 ๑乛◡乛๑：</p>
<ol type="1">
<li>你这做的事情没什么价值，你这做的没有任何意义。（以前做这个的时候不是您同意的？）</li>
<li>你没花时间。（每天 8 点半上班工作到晚上 10 点，周末还来实验室了，您看不见啊？）</li>
<li>你们是来搞科研的，不是来学习的。（搞科研不用学习？搞科研不用看书？搞科研不能看经典知识，直接建空中楼阁。）</li>
<li>你的计划是什么？实验预期你觉得怎样？有没有理论支撑？效果不好怎么办？（搞科研哪有这么多计划，也不是什么基础研究，先来个理论推导，效果不好只能重新找方法再试呗，搞科研要真能有全面的计划并且能取得理想的效果，那科研也就没有难度了，科研本就是需要不断实验改进，当然理论推导也是有必要的，但结果终究才是最重要的）</li>
<li>这个不是难事，很简单。（别光说啊，您来做啊。）</li>
<li>你这全是别人的东西，没有一点自己的东西。（拿着他山之石，攻另一块璞玉，难道不是科研？难道只有凭空造一颗石头去攻玉才是您眼中的科研？）</li>
<li>就像爬山一样，别人早就从一条路上登上山顶了，你从另一条路登上山顶还有什么意义。（对，没有任何意义 🤣）</li>
<li>你们这些年轻人，周末也要一天干 21 个小时，不要混日子，没干 21 小时说明你们对计算机没兴趣，既然没兴趣，我劝你们早点转行，去做个公务员。（照这个说法，没人对计算机有兴趣，统统应该去做公务员，因为对计算机有兴趣的人应该都死了吧。）</li>
</ol>
]]></content>
      <categories>
        <category>Life</category>
      </categories>
      <tags>
        <tag>record</tag>
      </tags>
  </entry>
  <entry>
    <title>再也不见，18年</title>
    <url>/posts/37b89a23.html</url>
    <content><![CDATA[<p>　　转眼间，19 年也过去了两个月，迟来的 18 年小结还是得来。</p>
<span id="more"></span>
<p>　　18 年，感觉自己成长不大，该了解的在去年就了解的差不多，18 年了解的程度也并没有怎么加深，不了解的，18 年还是不了解。<strong>果然要想成长的更快些，了解的更多些，还是得去一个完全崭新的环境</strong>。</p>
<p>　　18 年，被老板派出去做事了，前前后后应该有三个多月，要说这三个多月完全没有成长，那也是不可能的，毕竟是一个完全崭新的环境，在那里面也做了一些粗浅的事（整整 Android，整整 C#， 整整 SQL Server 存储过程等等），也基本了解了一些在外面做事的一些规则，初步了解了全干工程师的痛苦，了解了被业务捆绑的码农的无奈，了解了有一个好领导是多么重要，……。</p>
<p>　　总之要说 Shaun 在 18 年哪段时间成长的最快，那无疑是这三个月了。在这三个月中，Shaun 从一个 Android 小白，成长为一个能解决 Android 各项问题的小白（好吧，还是小白 o(╯□╰)o，这里不得不插一句，Android 的各项兼容性真痛苦，简直比之 Web 前端兼容 IE 6 也不遑多让，同做 IOS 的那位童鞋就没这种烦恼了），从一个完全不会 C# 的到一个不怎么会 C# 的（好吧，确实在那里也没写过几行 C#，做最多的 C# 相关事情就是维护和重做几个零几年的水晶报表，照着前人写的代码实现并维护一些小功能），从一个完全不会存储过程的小白到熟练使用各种触发器各种游标各种联合查询语句的小白，……，鬼知道 Shaun 经历了什么 ⊙﹏⊙。</p>
<p>　　3 个多月的外包全栈（gan）工程师体验，总体来说还是学到了一些东西，见识到了外面的一些人，一些事，最深刻的体会就是大部分程序员的代码终究是为业务需求服务的，同时也体会到<strong><em>完全</em>被业务捆绑的悲哀</strong>，业务需求是咋样的，代码就是咋样的，只不过不同的思维方式，会造成实现的方式的不同，而考虑不全面的代码，在后续使用中就极有可能会出现一些问题，最有可能的一个问题，就是 SQL 执行缓慢导致的一系列问题。还有一个问题就是，<strong>健全的文档很重要</strong>，别和 Shaun 扯什么「代码即文档」，当代码一团混乱，又没有文档，开发人员一波接一波的来来走走，会有人完全知道这个项目的具体实现方式也怕是有鬼了，这样的项目维护起来实在是太困难了。以后再有人和 Shaun 说「不懂的去看代码啊，代码里面什么都有」，怕不是要被 Shaun 打出屎来 (￣ε(#￣)☆╰╮(￣▽￣///)。Shaun 相信，真能写出代码即文档的人，在正规的开发流程下，也是会留下文档的。</p>
<p>　　18 年，收获最大的应该是提前了解了一些人性的恶，也真正见识到了「人前笑嘻嘻，背后捅刀子」的事。一个看起来还算和蔼的人，却是如此的小心眼，背地里一肚子坏水，就因为一些技术上的问题讨论，驳了 ta 的意思，就玩些不上台面的小把戏，呵，有意思的人啊。技术上的问题，就算从来一次，Shaun 还是要问个为什么，虽然 Shaun 碍于目前的眼界学识，对业务的了解程度，无法给出一些非常有用的建议，但是业务的实现，实现方式的好坏，Shaun 还是有基本的判断能力的，总不能说什么就做什么吧。</p>
<p>　　18 年初发生的一些事基本已经忘记了，年中的一些事也快忘了，有些事情不出意外还是会重复发生的，毕竟人类的本质就是复读机 ๑乛◡乛๑，太阳底下也很少有新鲜事，不过还好「暴走·大事件·第六季· 05 总结2018感谢有你陪伴，2019我们再出发！」这一期盘点了 18 年发生的一些事，虽然还有些事没有说，因为如果说了可能大概率已经被和谐了，毕竟有些事不存在了就可以当没发生过嘛 ╮(￣▽￣")╭ 。不过反正这些事总还是会以某种形式再次发生的，只是看什么时候发生，发生在谁身上而已，Shaun 能做的，就是尽量避免这些事发生在自己身上，反正 Shaun 个人也无法改变什么，普罗大众也乐得逍遥自在。</p>
<p>　　算了，就写到这里了，18 年确实没有什么值得称道的事 o(︶︿︶)o 。</p>
<div style="text-align:center; font-family: Allura, Consolas, Helvetica, Tahoma, Arial, Microsoft YaHei, 微软雅黑, SimSun, 宋体, Heiti, 黑体, sans-serif; font-size:1.3em; color:#4094c3; font-weight:700; margin:.5em auto;">
18 年获得技能：<strong><em>废人一个</em></strong><br />18 年获得成就：<strong><em>毫无成就</em></strong>
</div>
]]></content>
      <categories>
        <category>Life</category>
      </categories>
      <tags>
        <tag>record</tag>
      </tags>
  </entry>
  <entry>
    <title>大数据环境搭建笔记</title>
    <url>/posts/af5e9ace.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　准备开始搞时空数据了，先简单搭一下环境。</p>
<span id="more"></span>
<p>准备搭的环境为：jdk-1.8.0，hadoop-3.2.1，hbase-2.2.6，geomesa-hbase_2.11-3.1.0，spark-3.0.1-bin-hadoop3.2，geoserver-2.16.5-bin，geomesa-hbase_2.11-3.2.0-SNAPSHOT，所用的包都已下好并解压到 /home 目录下。</p>
<p><strong><em>※注</em></strong>： <em>hbase-2.2.6 暂不支持最新的 hadoop-3.3.0</em>，Hadoop 也最好使用 jdk-1.8.0，java-11 会有问题。</p>
<h2 id="hadoop-环境">Hadoop 环境</h2>
<p>　　首先修改 /etc/hosts 文件中本机 ip 对应的名称为 master，若在容器中安装则需要在 run 开启容器就指定 <code>--hostname master</code>，否则改了也没用，下次启动容器时 hostname 又会回到初始状态，下面开启正式的配置。</p>
<p>修改 /home/hadoop-3.2.1/etc/hadoop/hadoop-env.sh 文件，添加</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> JAVA_HOME=<span class="variable">$JAVA_HOME</span></span><br></pre></td></tr></table></figure></div>
<p>修改 /home/hadoop-3.2.1/etc/hadoop/core-site.xml 文件，添加</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="XML"><div class="code-copy"></div><figure class="highlight hljs xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- master 前面配置的主机名称 --&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- &lt;property&gt;</span></span><br><span class="line"><span class="comment">    &lt;name&gt;fs.default.name&lt;/name&gt;</span></span><br><span class="line"><span class="comment">    &lt;value&gt;hdfs://master:9000&lt;/value&gt;</span></span><br><span class="line"><span class="comment">  &lt;/property&gt; --&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>fs.defaultFS<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://master:9000<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hadoop.tmp.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>/home/hadoop/data/tmp<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></div>
<p>修改 /home/hadoop-3.2.1/etc/hadoop/hdfs-site.xml 文件，添加</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="XML"><div class="code-copy"></div><figure class="highlight hljs xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--指定SecondaryNameNode位置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.secondary.http-address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>master:9001<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.replication<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></div>
<p>修改 /home/hadoop-3.2.1/etc/hadoop/yarn-site.xml 文件，添加</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="XML"><div class="code-copy"></div><figure class="highlight hljs xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Site specific YARN configuration properties --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.aux-services<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>mapreduce_shuffle<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></div>
<p>修改 /home/hadoop-3.2.1/etc/hadoop/mapred-site.xml 文件，添加</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="XML"><div class="code-copy"></div><figure class="highlight hljs xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.framework.name<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>yarn<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></div>
<p>在 /home/hadoop-3.2.1/sbin/start-dfs.sh 和 /home/hadoop-3.2.1/sbin/stop-dfs.sh 文件头添加</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line">HDFS_DATANODE_USER=root</span><br><span class="line">HDFS_DATANODE_SECURE_USER=hdfs</span><br><span class="line">HDFS_NAMENODE_USER=root</span><br><span class="line">HDFS_SECONDARYNAMENODE_USER=root</span><br></pre></td></tr></table></figure></div>
<p>在 /home/hadoop-3.2.1/sbin/start-yarn.sh 和 /home/hadoop-3.2.1/sbin/stop-yarn.sh 文件头添加</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line">YARN_RESOURCEMANAGER_USER=root</span><br><span class="line">HADOOP_SECURE_DN_USER=yarn</span><br><span class="line">YARN_NODEMANAGER_USER=root</span><br></pre></td></tr></table></figure></div>
<p>设置环境变量，在 /etc/profile 中添加</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">Hadoop Environment Setting</span></span><br><span class="line">export HADOOP_HOME=/home/hadoop-3.2.1</span><br><span class="line">export JAVA_LIBRARY_PATH=$HADOOP_HOME/lib/native</span><br><span class="line">export LD_LIBRARY_PATH=$JAVA_LIBRARY_PATH</span><br><span class="line">export PATH=$PATH:$HADOOP_HOME/bin:$HADOOP_HOME/sbin</span><br></pre></td></tr></table></figure></div>
<p>由于容器中默认为 root 用户，所以在 /root/.bashrc 文件末尾添加 <code>source /etc/profile</code>，以开机启用设置的环境变量。</p>
<p>在启动 Hadoop 之前需要执行 <code>hdfs namenode -format</code> 进行格式化，启动命令为 <code>/home/hadoop-3.2.1/sbin/start-all.sh</code>。<em>后续若需要清空并重新设置 Hadoop 时，必须先删除 /home/hadoop/ 目录，再重新进行格式化。</em></p>
<h2 id="hbase-环境">HBase 环境</h2>
<p>修改 /home/hbase-2.2.6/conf/hbase-env.sh 文件，添加</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> JAVA_HOME=<span class="variable">$JAVA_HOME</span></span><br><span class="line"><span class="comment"># 使用自带的ZooKeeper管理</span></span><br><span class="line"><span class="built_in">export</span> HBASE_MANAGES_ZK=<span class="literal">true</span></span><br></pre></td></tr></table></figure></div>
<p>修改 /home/hbase-2.2.6/conf/hbase-site.xml 文件，添加</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="XML"><div class="code-copy"></div><figure class="highlight hljs xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.rootdir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://master:9000/hbase<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.dynamic.jars.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://master:9000/hbase/lib<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.cluster.distributed<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.replication<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.master.maxclockskew<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>180000<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>Time difference of regionserver from master<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.zookeeper.quorum<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>localhost<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 修改默认8080 端口--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.rest.port<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>8088<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 2181 默认端口，尽量不要修改，geomesa-hbase 导入数据时默认连接端口为 2181--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.zookeeper.property.clientPort<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>2181<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.zookeeper.property.dataDir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>/home/hbase/data<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.unsafe.stream.capability.enforce<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- geomesa-hbase --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.coprocessor.user.region.classes<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>org.locationtech.geomesa.hbase.server.coprocessor.GeoMesaCoprocessor<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></div>
<p>修改 /home/hbase-2.2.6/conf/regionservers 文件，修改为（原来为 localhost）</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="code"><pre><span class="line">master</span><br></pre></td></tr></table></figure></div>
<p>设置环境变量，在 /etc/profile 中添加</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">HBase Environment Setting</span></span><br><span class="line">export HBASE_HOME=/home/hbase-2.2.6</span><br><span class="line">export PATH=$PATH:$HBASE_HOME/bin</span><br></pre></td></tr></table></figure></div>
<p>配置好之后，执行 <code>start-hbase.sh</code> 启动 HBase。</p>
<h2 id="spark-环境">Spark 环境</h2>
<p>修改 /home/spark-3.0.1-bin-hadoop3.2/conf/spark-env.sh 文件，在文件末尾添加</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 配置JAVA_HOME，一般来说，不配置也可以，但是可能会出现问题，还是配上吧</span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=<span class="variable">$JAVA_HOME</span></span><br><span class="line"><span class="comment"># 一般来说，spark任务有很大可能性需要去HDFS上读取文件，所以配置上</span></span><br><span class="line"><span class="comment"># 如果说你的spark就读取本地文件，也不需要yarn管理，不用配</span></span><br><span class="line"><span class="built_in">export</span> HADOOP_CONF_DIR=<span class="variable">$HADOOP_HOME</span>/etc/hadoop</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置Master的主机名</span></span><br><span class="line"><span class="built_in">export</span> SPARK_MASTER_HOST=master</span><br><span class="line"><span class="comment"># 提交Application的端口，默认就是这个，万一要改呢，改这里</span></span><br><span class="line"><span class="built_in">export</span> SPARK_MASTER_PORT=7077</span><br><span class="line"><span class="comment"># 每一个Worker最多可以使用的cpu core的个数，我虚拟机就一个...</span></span><br><span class="line"><span class="comment"># 真实服务器如果有32个，你可以设置为32个</span></span><br><span class="line"><span class="built_in">export</span> SPARK_WORKER_CORES=1</span><br><span class="line"><span class="comment"># 每一个Worker最多可以使用的内存，我的虚拟机就2g</span></span><br><span class="line"><span class="comment"># 真实服务器如果有128G，你可以设置为100G</span></span><br><span class="line"><span class="built_in">export</span> SPARK_WORKER_MEMORY=2g</span><br><span class="line"><span class="comment"># master web UI端口默认8080</span></span><br><span class="line"><span class="built_in">export</span> SPARK_MASTER_WEBUI_PORT=8090</span><br><span class="line"><span class="comment"># worker web UI端口默认8081</span></span><br><span class="line"><span class="built_in">export</span> SPARK_WORKER_WEBUI_PORT=8089</span><br></pre></td></tr></table></figure></div>
<p>复制 /home/spark-3.0.1-bin-hadoop3.2/conf/slaves.template 文件，并重命名为 slaves，将该文件尾修改为</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 里面的内容原来为localhost，改为master </span></span><br><span class="line">master</span><br></pre></td></tr></table></figure></div>
<p>设置环境变量，在 /etc/profile 中添加</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="code"><pre><span class="line">export SPARK_HOME=/home/spark-3.0.1-bin-hadoop3.2</span><br><span class="line">export PATH=$PATH:$SPARK_HOME/bin:$SPARK_HOME/sbin</span><br></pre></td></tr></table></figure></div>
<p>将 /home/spark-3.0.1-bin-hadoop3.2/sbin/start-all.sh 重命名为 start-spark-all.sh，将 /home/spark-3.0.1-bin-hadoop3.2/sbin/stop-all.sh 重命名为 stop-spark-all.sh，执行 <code>start-spark-all.sh</code> 启动 Spark。</p>
<h2 id="geomesa-hbase-环境">geomesa-hbase 环境</h2>
<h3 id="编译-geomesa">编译 geomesa</h3>
<p>克隆 <a href="https://gitee.com/mirrors/geomesa">LocationTech GeoMesa</a> ，<strong>修改 pom.xml</strong>，即修改对应依赖的 hadoop 和 hbase 以及 spark 版本（spark 最新的3.0.1版本由 Scala-2.12 编译，而 Geomesa 编译目前采用 Scala-2.11， 所以 Spark 不能使用最新的版本，只能用 2.4.7）。进入 geomesa 根目录，使用命令</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="code"><pre><span class="line">mvn clean install -DskipTests</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或仅编译 geomesa-hbase</span></span><br><span class="line">mvn clean install -pl geomesa-hbase -am -DskipTests</span><br></pre></td></tr></table></figure></div>
<p>编译 geomesa，中间可能会失败很多次，包下不来，可能需要挂代理或换源，重复使用命令多次即可。</p>
<h3 id="配置-geomesa-hbase">配置 geomesa-hbase</h3>
<p>将 /home/geomesa/geomesa-hbase/geomesa-hbase-dist/target/geomesa-hbase_2.11-3.2.0-SNAPSHOT-bin.tar.gz 解压为 /home/geomesa-hbase_2.11-3.2.0-SNAPSHOT，<strong>将 /home/geomesa-hbase_2.11-3.2.0-SNAPSHOT/dist/hbase/geomesa-hbase-distributed-runtime-hbase2_2.11-3.2.0-SNAPSHOT.jar 复制到 /home/hbase-2.2.6/lib/ 文件夹中</strong>，修改 /home/geomesa-hbase_2.11-3.2.0-SNAPSHOT/conf/dependencies.sh 文件，设置正确的Hadoop 和 hbase 版本，依次执行 /home/geomesa-hbase_2.11-3.2.0-SNAPSHOT/bin/install-dependencies.sh 和 /home/geomesa-hbase_2.11-3.2.0-SNAPSHOT/bin/install-shapefile-support.sh。设置环境变量，在 /etc/profile 中添加</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> GEOMESA_HBASE_HOME=/home/geomesa-hbase_2.11-3.2.0-SNAPSHOT</span><br><span class="line"><span class="built_in">export</span> GEOMESA_LIB=<span class="variable">$GEOMESA_HBASE_HOME</span>/lib</span><br><span class="line"><span class="built_in">export</span> GEOMESA_CONF_DIR=<span class="variable">$&#123;GEOMESA_HBASE_HOME&#125;</span>/conf</span><br><span class="line"><span class="built_in">export</span> CLASSPATH=<span class="variable">$CLASSPATH</span>:<span class="variable">$GEOMESA_LIB</span>:<span class="variable">$GEOMESA_CONF_DIR</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$GEOMESA_HBASE_HOME</span>/bin</span><br></pre></td></tr></table></figure></div>
<h3 id="测试-geomesa-hbase">测试 geomesa-hbase</h3>
<p>启动 Hadoop 和 HBase 之后，可直接使用命令</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="code"><pre><span class="line">geomesa-hbase ingest --catalog TestGeomesa --feature-name road --input-format shp <span class="string">&quot;/home/shpdata/road.shp&quot;</span></span><br></pre></td></tr></table></figure></div>
<p>导入 shp 数据，<strong>shp 不能有 id 字段</strong>，因为 Geomesa 在创建表时会默认生成一个 id 字段。</p>
<p>也可克隆 <a href="https://gitee.com/xfilove/geomesa-tutorials">geomesa-tutorials</a> ，同样修改其中的 pom.xml 文件，进入 geomesa-tutorials 根目录，使用命令</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="code"><pre><span class="line">mvn clean install -pl geomesa-tutorials-hbase/geomesa-tutorials-hbase-quickstart -am</span><br></pre></td></tr></table></figure></div>
<p>编译 geomesa-tutorials，编译完成后，使用命令</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="code"><pre><span class="line">java -cp geomesa-tutorials-hbase/geomesa-tutorials-hbase-quickstart/target/geomesa-tutorials-hbase-quickstart-3.2.0-SNAPSHOT.jar org.geomesa.example.hbase.HBaseQuickStart --hbase.zookeepers localhost --hbase.catalog geomesaTest</span><br></pre></td></tr></table></figure></div>
<p>导入数据进 Hbase，导入成功后可通过 <code>hbase shell</code> 进入 hbase，在 hbase shell 中通过 <code>list</code> 查看 hbase 现有的表。</p>
<h3 id="整合-geoserver">整合 geoserver</h3>
<p>导入依赖插件</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="code"><pre><span class="line">manage-geoserver-plugins.sh -l <span class="variable">$&#123;GEOSERVER_HOME&#125;</span>/webapps/geoserver/WEB-INF/lib/ -i</span><br></pre></td></tr></table></figure></div>
<p>修改 /home/geomesa-hbase_2.11-3.2.0-SNAPSHOT/bin/install-dependencies.sh 中第33行：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># install_dir=&quot;$&#123;GEOMESA_HBASE_HOME&#125;/lib&quot;</span></span><br><span class="line">install_dir=<span class="string">&quot;<span class="variable">$&#123;GEOSERVER_HOME&#125;</span>/webapps/geoserver/WEB-INF/classes&quot;</span></span><br></pre></td></tr></table></figure></div>
<p>执行 install-dependencies.sh 安装插件，安装完后将 classes 中的 lib 都移到 ${GEOSERVER_HOME}/webapps/geoserver/WEB-INF/lib中。</p>
<h2 id="后记">后记</h2>
<p>　　环境搞起来真麻烦，在编译和运行 Geomesa 时总能遇到一些莫名奇妙的问题，Java 系的这一套确实很麻烦，尤其是各种依赖关系，不过最后总算是搞好了，能直接在 geoserver 中看到 geomesa 存在 hbase 里的地图。</p>
<h2 id="参考资料">参考资料</h2>
<p><a href="https://www.cnblogs.com/Mr-lin66/p/13378248.html">Centos7系统 Hadoop+HBase+Spark环境搭建</a></p>
<p><a href="https://blog.csdn.net/weixin_41834634/article/details/89176473">GeoMesa-HBase操作篇——安装</a></p>
<p><a href="https://blog.csdn.net/hsg77/article/details/82221531">centos7安装geomesa2.0.2_hbase_geoserver2.13.2的方法</a></p>
<p><a href="https://www.cnblogs.com/heidsoft/p/8558419.html">hadoop fs 命令使用</a></p>
<p><a href="https://www.geomesa.org/documentation/stable/tutorials/geomesa-quickstart-hbase.html">GeoMesa HBase Quick Start</a></p>
<p><a href="https://www.geomesa.org/documentation/stable/user/hbase/install.html">Installing GeoMesa HBase</a></p>
<p><a href="https://www.cnblogs.com/yszd/p/10039249.html">Spark完全分布式集群搭建【Spark2.4.4+Hadoop3.2.1】</a></p>
<h2 id="附录">附录</h2>
<p>最后附上一些常用的端口及说明：</p>
<h3 id="hbase">Hbase</h3>
<table>
<thead>
<tr class="header">
<th>配置</th>
<th>端口</th>
<th>说明</th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>hbase.master.port</td>
<td>16000</td>
<td>HMaster绑定端口</td>
<td></td>
</tr>
<tr class="even">
<td><strong>hbase.master.info.port</strong></td>
<td><strong>16010</strong></td>
<td><strong>HBase Master的Web UI端口</strong></td>
<td></td>
</tr>
<tr class="odd">
<td>hbase.regionserver.port</td>
<td>16020</td>
<td>HBase RegionServer绑定的端口</td>
<td></td>
</tr>
<tr class="even">
<td><strong>hbase.regionserver.info.port</strong></td>
<td><strong>16030</strong></td>
<td><strong>HBase RegionServer的Web UI端口</strong></td>
<td></td>
</tr>
<tr class="odd">
<td>hbase.zookeeper.property.clientPort</td>
<td>2181</td>
<td>Zookeeper客户端连接端口</td>
<td></td>
</tr>
<tr class="even">
<td>hbase.zookeeper.peerport</td>
<td>2888</td>
<td>Zookeeper节点内部之间通信的端口</td>
<td></td>
</tr>
<tr class="odd">
<td>hbase.zookeeper.leaderport</td>
<td>3888</td>
<td>Zookeeper用来选举主节点的端口</td>
<td></td>
</tr>
<tr class="even">
<td>hbase.rest.port</td>
<td>8080</td>
<td>HBase REST server的端口</td>
<td></td>
</tr>
<tr class="odd">
<td>hbase.master.port</td>
<td>60000</td>
<td>HMaster的RPC端口</td>
<td></td>
</tr>
<tr class="even">
<td>hbase.master.info.port</td>
<td>60010</td>
<td>HMaster的http端口</td>
<td></td>
</tr>
<tr class="odd">
<td>hbase.regionserver.port</td>
<td>60020</td>
<td>HRegionServer的RPC端口</td>
<td></td>
</tr>
<tr class="even">
<td>hbase.regionserver.info.port</td>
<td>60030</td>
<td>HRegionServer的http端口</td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="hadoop">Hadoop</h3>
<table>
<thead>
<tr class="header">
<th>配置</th>
<th>端口</th>
<th>说明</th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>fs.defaultFS</td>
<td>9000</td>
<td>hdfs访问端口</td>
<td></td>
</tr>
<tr class="even">
<td>dfs.namenode.rpc-address</td>
<td>9001</td>
<td>DataNode会连接这个端口</td>
<td></td>
</tr>
<tr class="odd">
<td>dfs.datanode.address</td>
<td>9866</td>
<td>DataNode的数据传输端口</td>
<td></td>
</tr>
<tr class="even">
<td><strong>dfs.namenode.http-address</strong></td>
<td><strong>9870</strong></td>
<td><strong>namenode的web UI 端口</strong></td>
<td></td>
</tr>
<tr class="odd">
<td><strong>yarn.resourcemanager.webapp.address</strong></td>
<td><strong>8088</strong></td>
<td><strong>YARN的http端口</strong></td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="spark">Spark</h3>
<table>
<thead>
<tr class="header">
<th></th>
<th>端口</th>
<th>说明</th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td></td>
<td>8080</td>
<td>master的webUI，Tomcat的端口号（已修改为8090）</td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>8081</td>
<td>worker的webUI的端口号（已修改为8089）</td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>18080</td>
<td>historyServer的webUI的端口号</td>
<td></td>
</tr>
</tbody>
</table>
<p>需开放端口 22，2181，5432，8080，8088，8089，8090，9870，16010，16030。</p>
<p><code>docker run -dit --privileged=true --name STC2 --hostname master -v E:/Docker/ShareFile:/mnt/sharefile -p 22:22 -p 80:80 -p 2181:2181 -p 5432:5432 -p 8080-8090:8080-8090 -p 9870:9870 -p 16010:16010 -p 16030:16030 stc:2.0 init</code></p>
]]></content>
      <categories>
        <category>Study</category>
      </categories>
      <tags>
        <tag>note</tag>
        <tag>bigdata</tag>
      </tags>
  </entry>
  <entry>
    <title>图割算法之NCuts浅见</title>
    <url>/posts/fddd1e17.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　图割算法主要有两个发展方向，一个是 Shaun 上次写过的 <a href="http://cniter.github.io/posts/c42ff8d4.html"><strong>Graph Cuts</strong></a> ，通过边界项和区域项（有的可能还会添加一个约束项，或者叫标签项）之和建立能量方程，并利用一定程度的交互式构建一个 S/T 图，最后采用最大流/最小割（Max-flow/Min-cut ）算法寻找 S/T 图的最小“割”，从而对图像进行分割；而另一个方向就是 <strong>NCuts</strong>（Normalized Cuts），中文一般叫规范割、标准割等等，该方法主要出自：<em>Shi J, Malik J. Normalized cuts and image segmentation[J]. IEEE Transactions on pattern analysis and machine intelligence, 2000, 22(8): 888-905.</em> 。</p>
<span id="more"></span>
<p>提到 NCuts，就不得不提「谱聚类」，因为 NCuts 可以说是谱聚类的一个应用。</p>
<h2 id="谱聚类篇">谱聚类篇</h2>
<blockquote>
<p>谱聚类（Spectral Clustering， SC）是一种基于图论的聚类方法——将无向带权图划分为两个或两个以上的最优子图(sub-Graph)，使子图内部尽量相似，而子图间距离尽量远，以达到常见的聚类的目的。</p>
</blockquote>
<p>在了解谱聚类之前需要先了解两个概念：拉普拉斯矩阵（Laplace Matrix）和瑞利熵（Rayleigh quotient）。</p>
<h3 id="拉普拉斯矩阵">拉普拉斯矩阵</h3>
<p>拉普拉斯矩阵的定义如下：</p>
<blockquote>
<p>设 <span class="math inline">\(W\)</span> 为无向带权图 <span class="math inline">\(G=(V,E)\)</span> 的邻接矩阵，<span class="math inline">\(D\)</span> 为无向带权图 <span class="math inline">\(G\)</span> 的度矩阵，（所谓的度矩阵即为图中各顶点邻接的所有边权值之和构成的矩阵，是一个对角矩阵，若设顶点 <span class="math inline">\(i\)</span> 和顶点 <span class="math inline">\(j\)</span> 之间的权值为 <span class="math inline">\(w(i,j)\)</span>，则度矩阵对角线上的元素 <span class="math inline">\(d_{i,i}=\sum \limits_{j=1}^n w(i,j)\)</span> ），则拉普拉斯矩阵 <span class="math inline">\(L=D-W\)</span>。如下图：</p>
<blockquote>
<p>若图的邻接矩阵：<span class="math inline">\(\mathbf{W}=\begin{pmatrix} 0 &amp; 0.1 &amp; 0 &amp; 0 &amp; 0.2 &amp; 0 \\ 0.1 &amp; 0 &amp; 0 &amp; 0.5 &amp; 0.1 &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; 0.3 &amp; 0 &amp; 0.4 \\ 0 &amp; 0.5 &amp; 0.3 &amp; 0 &amp; 0 &amp; 0.1 \\ 0.2 &amp; 0.1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; 0.4 &amp; 0.1 &amp; 0 &amp; 0 \end{pmatrix}\)</span> ，其中图中不连通的顶点之间的权值为 0；</p>
<p>则对应的度矩阵为：<span class="math inline">\(\mathbf{Ｄ}=\begin{pmatrix} 0.3 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\ 0 &amp; 0.7 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; 0.7 &amp; 0 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; 0.9 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0.3 &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0.5 \end{pmatrix}\)</span></p>
<p>则拉普拉斯矩阵 <span class="math inline">\(L\)</span> 为：<span class="math inline">\(\mathbf{L}=\mathbf{D}-\mathbf{W}=\begin{pmatrix} 0.3 &amp; -0.1 &amp; 0 &amp; 0 &amp; -0.2 &amp; 0 \\ -0.1 &amp; 0.7 &amp; 0 &amp; -0.5 &amp; -0.1 &amp; 0 \\ 0 &amp; 0 &amp; 0.7 &amp; -0.3 &amp; 0 &amp; -0.4 \\ 0 &amp; -0.5 &amp; -0.3 &amp; 0.9 &amp; 0 &amp; -0.1 \\ -0.2 &amp; -0.1 &amp; 0 &amp; 0 &amp; 0.3 &amp; 0 \\ 0 &amp; 0 &amp; -0.4 &amp; -0.1 &amp; 0 &amp; 0.5 \end{pmatrix}\)</span></p>
<p>以上三个矩阵都为实对称矩阵。对于拉普拉斯矩阵，由 $L* [1,1,1,1,1,1]^T =0* [1,1,1,1,1,1]^T= $ 可知其一定存在一个特征值为 0，对应的特征向量为 <span class="math inline">\([1,1,1,1,1,1]^T\)</span> 。</p>
<p>拉普拉斯矩阵是半正定的，且对应的 n 个实数特征值都大于等于 0，即 <span class="math inline">\(0=λ_1≤λ_2≤\cdots≤λ_n\)</span>， 且最小的特征值为 0 。</p>
<p>至于拉普拉斯矩阵的更多性质，可参考：<a href="https://en.wikipedia.org/wiki/Laplacian_matrix"><strong>Laplacian matrix</strong></a> 。</p>
</blockquote>
</blockquote>
<h3 id="瑞利熵">瑞利熵</h3>
<p>　　瑞利熵的公式形如：<span class="math inline">\(R(M,x)=\frac{x^*Mx}{x^*x}\)</span> ，其中 M 是厄米特矩阵（Hermitian matrix），满足 <span class="math inline">\(M=M^H\)</span> ，即矩阵 <span class="math inline">\(M\)</span> 与其共轭转置矩阵相等，<span class="math inline">\(x\)</span> 为非 0 向量，<span class="math inline">\(x^*\)</span> 是指 <span class="math inline">\(x\)</span> 向量的共轭转置向量。对于实数而言，厄米特矩阵就是对称阵 <span class="math inline">\(M=M^T\)</span>，<span class="math inline">\(x^*\)</span> 就是 <span class="math inline">\(x\)</span> 向量的转置向量 <span class="math inline">\(x&#39;\)</span> 或 <span class="math inline">\(x^T\)</span>。</p>
<p>　　若设 <span class="math inline">\(x^*x=c\)</span>，其中 <span class="math inline">\(c\)</span> 为一个常数，则 <span class="math inline">\(R(M,x)=\frac{x^*Mx}{c}\)</span> ，则其极值问题可转化为：<span class="math inline">\(\min R(M,x) = \min x^*Mx \qquad s.t.\  x^*x=c\)</span> ，可利用拉格朗日乘数法求取 <span class="math inline">\(x^*Mx\)</span> 的极值。 具体求法如下： <span class="math display">\[
\mathcal{L}(x) = x^T M x  -\lambda \left (x^Tx - c \right) \\
\begin{align} 
&amp;\frac{d\mathcal{L}(x)}{dx} = 0 \\
&amp;\Rightarrow x^TM  - \lambda x^T = 0 \\
&amp;\Rightarrow Mx  - \lambda x = 0 \\
&amp;\Rightarrow M x = \lambda x
\end{align} \\
\therefore R(M,x) = \frac{x^T M x}{x^T x} = \lambda \frac{x^Tx}{x^T x} = \lambda.
\]</span></p>
<p>瑞利熵有如下几个性质：</p>
<blockquote>
<ul>
<li>R 的最大值就是 M 最大特征值，R 的最小值就是 M 最小特征值 ；</li>
<li>x 的解，就是 M 对应的特征向量。</li>
</ul>
<p>至于瑞利熵的更多性质，可参考：<a href="https://en.wikipedia.org/wiki/Rayleigh_quotient"><strong>Rayleigh quotient</strong></a> 。</p>
</blockquote>
<p>　　以上只是一般意义上的普通瑞利熵，还有一个广义瑞利熵（<strong>generalized Rayleigh quotient</strong> ），其定义为：<span class="math inline">\(R(M,D;x)=\frac{x^*Mx}{x^*Dx}\)</span> ，即在分母上添加一个 D 矩阵相乘，其中 D 为 <strong>Hermite 正定矩阵</strong> ，满足 <span class="math inline">\(D=D^*\)</span>，普通瑞利熵是广义瑞利熵中 D 矩阵为单位矩阵时的情况。广义瑞利熵可以通过以下变换转换为普通瑞利熵： <span class="math display">\[
\begin{equation} \begin{aligned}
R(M,D;x) &amp;= \frac{x^*Mx}{x^*Dx} \xlongequal{x=D^{-\frac{1}{2}}y} \frac{(D^{-\frac{1}{2}}y)^*M(D^{-\frac{1}{2}}y)}{(D^{-\frac{1}{2}}y)^*D(D^{-\frac{1}{2}}y)} \\
&amp;= \frac{y^*(D^{-\frac{1}{2}})^*M(D^{-\frac{1}{2}}y)}{y^*(D^{-\frac{1}{2}})^*D(D^{-\frac{1}{2}}y)}=\frac{y^*D^{-\frac{1}{2}}MD^{-\frac{1}{2}}y}{y^*D^{-\frac{1}{2}}DD^{-\frac{1}{2}}y} \\ 
&amp;= \frac{y^*(D^{-\frac{1}{2}}MD^{-\frac{1}{2}})y}{y^*y}
\end{aligned} \end{equation}
\]</span></p>
<p>只需要求出矩阵 <span class="math inline">\(D^{-\frac{1}{2}}MD^{-\frac{1}{2}}\)</span> 的特征值和特征向量即可。</p>
<hr />
<p><em>好了，这两个概念介绍完了，就可以真正介绍谱聚类了。</em></p>
<p>　　上面说了，谱聚类是一种基于图论的聚类方法，既然有图，则必有相应的邻接矩阵。设图 G 的顶点被聚类成两类，即将图 G 分割为子图 A 和 B，则所要断开的边的权值之和为代价函数（也叫损失函数），类似于“Graph Cuts”中的能量方程。割边 Cut(A,B) 的具体表示为：<span class="math inline">\(Cut(A,B)=\sum \limits_{i \in A,j \in B} w(i,j)\)</span> 。</p>
<p>　　设图 <span class="math inline">\(G\)</span> 中共有 <span class="math inline">\(n\)</span> 个顶点，则需要构建一个 <span class="math inline">\(n \times n\)</span> 的邻接矩阵 <span class="math inline">\(W\)</span>，其相应的度矩阵为 <span class="math inline">\(D\)</span>，对应的拉普拉斯矩阵为 <span class="math inline">\(L=D-W\)</span>，令 <span class="math inline">\(p_i = \begin{cases} l_1 &amp; i \in A \\ l_2 &amp; i \in B\end{cases}\)</span> ，则 <span class="math display">\[
Cut(A,B)=\sum \limits_{i \in A,j \in B} w(i,j) = \frac{\sum \limits_{i=1}^n \sum \limits_{j=i}^n w(i,j) (p_i-p_j)^2}{(l_1-l_2)^2}= \frac{\sum \limits_{i=1}^n \sum \limits_{j=1}^n w(i,j) (p_i-p_j)^2}{2(l_1-l_2)^2}
\]</span></p>
<p>当且仅当 <span class="math inline">\(i\)</span> 和 <span class="math inline">\(j\)</span> 不属于同一子图时，<span class="math inline">\((p_i-p_j)^2/(l_1-l_2)^2=1\)</span>，否则 <span class="math inline">\((p_i-p_j)^2/(l_1-l_2)^2=0\)</span>，（为什么采取这种计算方式，是因为在无法直接确定割边时，用这种计算方式能确保全部割边且只有割边会被加入权重之和），至于为什么等式最后还要除以 2 ，是因为等式最后的那种写法每条边会被遍历两次，每条割边权值会被计入两次，所以还要除以2。</p>
<p>而： <span class="math display">\[
\begin{equation} \begin{aligned}
&amp; \sum \limits_{i=1}^n \sum \limits_{j=1}^n w(i,j) (p_i-p_j)^2 = \sum \limits_{i=1}^n \sum \limits_{j=1}^n w(i,j) (p_i^2-2p_ip_j+p_j^2) \\
&amp;= \sum \limits_{i=1}^n \sum \limits_{j=1}^n w(i,j) (p_i^2) +  \sum \limits_{i=1}^n \sum \limits_{j=1}^n w(i,j) (p_j^2) - \sum \limits_{i=1}^n \sum \limits_{j=1}^n w(i,j) (2p_ip_j) \\ 
&amp;=  \sum \limits_{i=1}^n p_i^2 (\sum \limits_{j=1}^n w(i,j))  +  \sum \limits_{j=1}^n p_j^2 (\sum \limits_{i=1}^n w(i,j)) - 2\sum \limits_{i=1}^n \sum \limits_{j=1}^n p_iw(i,j) p_j \\
&amp;= p^TDp+p^TDp-2p^TWp = 2p^T(D-W)p = 2p^TLp
\end{aligned} \end{equation}
\]</span></p>
<p>则：<span class="math inline">\(Cut(A,B)=\frac{p^TLp}{(l_1-l_2)^2}\)</span> ，当 <span class="math inline">\(l_1=1,l_2=-1\)</span> 时， <span class="math inline">\(\min Cut(A,B) = \min p^TLp \qquad s.t.\  p^Tp=n\)</span> ，n 为图的顶点个数。由上可知，该最小割问题即是一个瑞利熵问题，只需求取 <span class="math inline">\(L\)</span> 的特征值和特征向量。</p>
<p>　　对 <span class="math inline">\(L\)</span> 的特征值进行从小到大排列（即<strong>取最小 k 个特征向量</strong>），若要分成 k 类，则需要取前 k 个特征值（除 0 以外）对应的特征向量，并归一化，将每一个特征向量按列排列构成一个 <span class="math inline">\(n \times k\)</span> 的特征矩阵，对特征矩阵的行向量使用 k-means 或其它聚类算法，将 n 个行向量聚成 k 类，每一行都属于某一类，根据聚类结果为每个顶点分配相应的类标签，从而完成谱聚类。所以利用谱聚类求的解相当于是一个近似解，它将连续的 n 维问题离散化为 k 维问题，p 是一个 n 维的标签向量，标签值为 <span class="math inline">\(\{1,2,\cdots,k\}\)</span> ，而 <span class="math inline">\(L\)</span> 的特征向量中的元素并不是离散化的 <span class="math inline">\(\{1,2,\cdots,k\}\)</span> ，无法直接用 <span class="math inline">\(L\)</span> 的特征向量作为标签向量，所以需要将其离散化，对特征矩阵的行向量进行聚类，从而近似的生成标签向量；由于只取前 k 个特征向量，所以在对特征矩阵进行聚类时被聚类的 n 条数据只有 k 维，而本来 <span class="math inline">\(L\)</span> 的特征向量至少有 n 个，即被聚类的 n 条数据至少有 n 维，所以从某种程度上，谱聚类同时也对数据进行了降维处理。</p>
<p><strong>※注：</strong> <em>推荐使用 <strong>SVD</strong> 代替特征值和特征向量的求取</em>。至于谱聚类的更多性质，可参考：<a href="https://en.wikipedia.org/wiki/Spectral_clustering"><strong>Spectral clustering</strong></a>。</p>
<p>　　因为有时候简单的全局最小割，可能并不是最优割，所以需要对割做一个归一化，即 <strong>Normalized Cuts</strong> ，简称 NCuts。</p>
<h2 id="图篇">图篇</h2>
<p>　　同样，Shaun 还从图的构造开始，NCuts 所需要构造的图就是最普通的无向带权图，<strong>图的顶点由图像中像素点构成，相邻的像素点之间互相连接构成图的边</strong>。边的权值计算公式为： <span class="math display">\[
w(i,j) = e^{\dfrac{-\|\mathbf{F}(i)-\mathbf{F}(j)\|_2^2}{\sigma_I}} * \begin{cases} e^{\dfrac{-\|\mathbf{X}(i)-\mathbf{X}(j)\|_2^2}{\sigma_X}} &amp; \text{if } \|\mathbf{X}(i)-\mathbf{X}(j)\|_2 &lt; r  \\ 0 &amp; \text{otherwise}. \end{cases}
\]</span> 　　其中 <span class="math inline">\(\mathbf{X}(·)\)</span> 是指该顶点的空间位置向量，即图像中像素点的坐标； <span class="math inline">\(\mathbf{F}(·)\)</span> 可指像素点的强度（灰度）值，颜色向量或纹理值；<span class="math inline">\(\|\mathbf{X}(i)-\mathbf{X}(j)\|_2\)</span> 表示向量的「2-范数」，即欧氏距离。当 <span class="math inline">\(\mathbf{F}(·)\)</span> 表示强度（灰度）值时，NCuts 分割的是灰度图；当 <span class="math inline">\(\mathbf{F}(·)\)</span> 表示颜色向量（一般在 HSV 颜色空间，有 <span class="math inline">\((h,s,v)\)</span> 三个颜色分量）时，NCuts 分割的是彩色图。对于这个权值的计算说人话就是：当两个像素点之间的距离大于一个人为指定的 <span class="math inline">\(r\)</span> 时（其实也就用这个 <span class="math inline">\(r\)</span> 判断到底是连接 4 邻域还是连接 8 邻域，一般不会连接 8 邻域之外的像素点），就不连接，此时权值设为 0 ；否则，则计算两像素点颜色向量的 RBF 核的值和两像素点坐标向量的 RBF 核的值，并取其乘积作为权值。</p>
<p>好了，Ncuts 的图的构成大致就是这样。接下来就是它的割法了。</p>
<h2 id="割篇">割篇</h2>
<p>　　NCuts 中定义割 <span class="math inline">\(Cut(A,B)=\sum \limits_{i \in A,j \in B} w(i,j)\)</span> ，定义 <span class="math inline">\(assoc(A,V)=\sum\limits_{i \in A,t \in V}w(i,t)\)</span> 为子图 A 内所有像素点连接的所有边权重之和，最终的 NCuts 目标函数如下： <span class="math display">\[
Ncut(A,B)= \frac{cut(A,B)}{assoc(A,V)}+\frac{cut(A,B)}{assoc(B,V)}
\]</span> 即通过除以两个子图内所有像素点连接的所有边权值之和对割做了个归一化处理。</p>
<p>　　令 <span class="math inline">\(\mathbf{W}\)</span> 为图的邻接矩阵， <span class="math inline">\(\mathbf{D}\)</span> 为其对应的度矩阵，<span class="math inline">\(L=D-W\)</span> 为其对应的拉普拉斯矩阵，令 <span class="math inline">\(S_1 = assoc(A,V) = \sum\limits_{i \in A}D_{ii}\)</span>，<span class="math inline">\(S_2 = assoc(B,V) = \sum\limits_{i \in B}D_{ii}\)</span>，则 <span class="math inline">\(S = S_1+S_2=\sum\limits_{i \in A}D_{ii}+\sum\limits_{i \in B}D_{ii}=\sum D_{ii}= \sum \limits_{i=1}^n\sum \limits_{j=1}^n w(i,j)\)</span> ，则：<span class="math inline">\(NCut(A,B)=\frac{p^TLp}{(l_1-l_2)^2}*(\frac{1}{S_1}+\frac{1}{S_2})\)</span> ，其中向量 <span class="math inline">\(p\)</span> 为 <span class="math inline">\(N=|V|\)</span> 维的标签向量， <span class="math inline">\(p_i = \begin{cases} l_1 &amp; i \in A \\ l_2 &amp; i \in B\end{cases}\)</span> ，令 <span class="math inline">\(l_1 = \sqrt{\frac{S_2}{S_1S}},l_2=-\sqrt{\frac{S_1}{S_2S}}\)</span> ，则 <span class="math inline">\(NCut(A,B)=p^TLp\)</span> ，此时 <span class="math inline">\(p^TDp=\sum p_i^2D_{ii}=\sum\limits_{i \in A}l_1^2D_{ii}+\sum\limits_{i \in B}l_2^2D_{ii}=l_1^2S_1+l_2^2S_2=1\)</span> ，则可化为 <span class="math inline">\(NCut(A,B)=\frac{p^TLp}{p^TDp}\)</span> ，即 <span class="math inline">\(\min NCut(A,B) = \min p^TLp \qquad s.t.\  p^TDp=1\)</span> ，该式即为一个广义瑞利熵，只需要求出矩阵 <span class="math inline">\(D^{-\frac{1}{2}}LD^{-\frac{1}{2}}\)</span> 的特征值和特征向量，按照谱聚类最后的聚类方式将顶点（像素点）聚成 k 类，从而完成图像的分割。而 NCuts 有个特殊的变换，具体如下： <span class="math display">\[
\begin{equation} \begin{aligned}
NCut(A,B) &amp;=\frac{p^TLp}{p^TDp}\xlongequal{p=D^{-\frac{1}{2}}x} \frac{x^T(D^{-\frac{1}{2}}LD^{-\frac{1}{2}})x}{x^Tx} \\
&amp;= \frac{x^T(D^{-\frac{1}{2}}(D-W)D^{-\frac{1}{2}})x}{x^Tx} \\
&amp;=  \frac{x^T(D^{-\frac{1}{2}}DD^{-\frac{1}{2}})x}{x^Tx} -  \frac{x^T(D^{-\frac{1}{2}}WD^{-\frac{1}{2}})x}{x^Tx} \\
&amp;= I -  \frac{x^T(D^{-\frac{1}{2}}WD^{-\frac{1}{2}})x}{x^Tx}
\end{aligned} \end{equation}
\]</span> 使用该变换可得出：<span class="math inline">\(\min NCut(A,B) = \max x^T(D^{-\frac{1}{2}}WD^{-\frac{1}{2}})x \qquad s.t.\  x^Tx=1\)</span> ，这样可不求出拉普拉斯矩阵，直接求出 <span class="math inline">\(D^{-\frac{1}{2}}WD^{-\frac{1}{2}}\)</span> 的特征值和特征矩阵即可，而此时在谱聚类最后聚类的时候要将其特征值从大到小排列（即<strong>取最大 k 个特征向量</strong>），取前 k 个特征值对应的特征向量构造特征矩阵进行聚类。</p>
<h2 id="附录">附录</h2>
<p>　　<strong>Ratio Cuts</strong>（RCuts） 和 NCuts 的目标函数差不多，两者间的差异就是：RCuts 是除以子图内<strong>顶点的个数</strong>；NCuts 是除以子图内所有顶点的<strong>边权值之和</strong>；最后变换完之后 RCuts 是个普通瑞利熵，而 NCuts 是个广义瑞利熵。具体的 RCuts 割法等以后有机会用到再写吧，毕竟子图顶点个数多不代表所占权重就大，而且在割时一般是基于权重的，所以一般而言 NCuts 的结果要比 RCuts 的结果要好。</p>
<h2 id="总结">总结</h2>
<p>　　由上文中应该可以看出 NCuts 与 Graph Cuts 需要构造的图是不一样，所使用的能量方程从形式上看也是完全不一样的（虽然本质上都是求“最小割”），其构成的图主要差别在于 Graph Cuts 多了 S 和 T 两个顶点，而这两个顶点由交互式获取，NCuts 不需要交互式，因此也没有这两个顶点，Ncuts 构造的图就相当于只由 Graph Cuts 的普通顶点和边界项 n-links 构成图，因此 Ncuts 没有 Graph Cuts 所谓的区域项 t-links ，也不需要求区域项 t-links 的权值。而这两种方法边界项 n-links 的权值求法都是差不多的，都是用 （高斯）RBF 核函数进行相似性度量，即 <span class="math inline">\(w_{\{i,j\}} \propto exp\left(-\frac{(I_i-I_j)^2}{2\sigma^2}\right)\)</span> 。</p>
<h2 id="后记">后记</h2>
<p>　　后面查阅资料发现图割其实还有好几个方向（井底之蛙了o(╯□╰)o），等有机会把用图割做超像素分割的那篇论文看一下吧 😜 。</p>
<p>　　5 月份的时候自己抽空实现了一下该算法，发现效果很糟糕，分割效果很不理想，当然不排除 Shaun 代码有 BUG 的原因，或者是还有一些步骤或 trick 漏掉了 ╮(╯▽╰)╭。而且不管是用 svds 还是 eigs 其分割结果都是随机的，只能保证邻域内像素点大概在一起，但具体谁和谁在一起这就是随机的了，这导致每次运行程序都可能有不同的分割结果 _(´ཀ`」 ∠)_ ，后面发现分割结果随机应该是 k-means 的锅（与 svd 和 eig 无关），原因是因为 k-means 每次初始化 k 个种子点时都是随机的，这自然会导致每次分割结果不完全一致 o(╯□╰)o。</p>
<h2 id="参考资料">参考资料</h2>
<p>[1] <a href="http://www.cnblogs.com/JiePro/p/Clustering_1.html">【聚类算法】谱聚类(Spectral Clustering)</a></p>
<p>[2] <a href="http://www.cnblogs.com/sparkwen/p/3155850.html">谱聚类算法(Spectral Clustering)</a></p>
<p>[3] <a href="http://www.cnblogs.com/xingshansi/p/6702188.html">拉普拉斯矩阵（Laplace Matrix）与瑞利熵（Rayleigh quotient）</a>（<a href="http://www.cnblogs.com/xingshansi/category/958994.html" class="uri">http://www.cnblogs.com/xingshansi/category/958994.html</a>）</p>
<p>[4] <a href="https://haoyu.love/blog344.html">Normalized cuts and image segmentation 简单实现</a></p>
<p>[5] <a href="http://www.cnblogs.com/pinard/p/6221564.html">谱聚类（spectral clustering）原理总结</a> （<a href="http://www.cnblogs.com/pinard/category/894692.html" class="uri">http://www.cnblogs.com/pinard/category/894692.html</a>）</p>
]]></content>
      <categories>
        <category>Image&amp;Graphic</category>
      </categories>
      <tags>
        <tag>note</tag>
        <tag>segmentation</tag>
        <tag>clustering</tag>
      </tags>
  </entry>
  <entry>
    <title>快速判断三角形与长方体相交</title>
    <url>/posts/ff29de94.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　一种快速判断空间中三角形与 box 相交的方法，出自论文：<em>Tomas Akenine-Moller. Fast 3D triangle-box overlap testing. A. K. Peters, Ltd. 2002.</em></p>
<span id="more"></span>
<h2 id="预备篇">预备篇</h2>
<p>　　该论文的理论基础来自分离轴理论（separating axis theorem， AST），AST 常用于检测两凸多边形是否相交。一句话描述 AST 即为：若两多边形能用一条直线分隔开，则两多边形不相交。如何判断该直线存在即为 AST 的关键。常用的判断方法为找出两多边形所有边向量（多边形相邻两点构成的向量，顺时针或逆时针都行）的法向量，使用向量点积分别计算两多边形在各法向量上的投影（一般以多边形上的点和原点构成一个向量与法向量做点积），从而得到两个投影集合，判断两集合是否相交（找出两个集合的最大值和最小值，若最小值大于最大值，则不相交），若不相交，则 AST 中的直线存在，即两多边形不相交，若相交，则继续判断在其它法向量上的投影，若所有法向量上的投影都相交，则两凸多边形相交。AST 常用于二维下判断两凸多边形的相交情况，三维下的情况比较复杂。</p>
<h2 id="正文篇">正文篇</h2>
<p>　　该论文给定 13 个向量，若 box 的边和三角形的边在这 13 个向量中的投影均相交，则认为 box 与三角形相交。为简化运算，box 直接假定为轴向包围盒（axis-aligned bounding box， AABB），坐标轴原点为 box 中心，由于可以将普通 box 通过旋转平移等一系列变换，变成以原点为中心的 AABB， 所以该假定是有效的。设三角形的顶点为 <span class="math inline">\(v_0, v_1, v_2\)</span> ，box 的<strong>一半</strong>长宽高为 <span class="math inline">\(h_x, h_y, h_z\)</span> ，则这 13 个向量分别为 <span class="math inline">\(e_0(1, 0, 0), e_1(0, 1, 0), e_2(0, 0, 1)\)</span> ，三角形的法向量 <span class="math inline">\(n\)</span> （通过三角形两边向量叉乘得到），剩下九个向量分别为 <span class="math inline">\(a_{ij} = e_i \times f_j , i,j \in \{0, 1, 2\}\)</span> ，其中 <span class="math inline">\(f\)</span> 为三角形的边向量 <span class="math inline">\(f_0 = v_1 - v_0, f_1 = v_2 - v_1, f_2 = v_0 - v_2\)</span> ， <span class="math inline">\(\times\)</span> 代表向量叉乘。若直接这样一个个的计算投影是否相交，虽然能达到目的，但快速就无法体现了，所以作者根据向量计算方法和一些策略将其中一些需要计算投影的地方极大的简化了，所以加快的计算速度。具体简化过程为：</p>
<ol type="1">
<li><p>首先来看最后九个向量，<span class="math inline">\(a_{00} = e_0 \times f_0 = (0, -f_{0z}, f_{0y})\)</span> ，三角形三个顶点在在该向量上的投影分别为：</p>
<p><span class="math inline">\(p_0 = a_{00} \cdot v_0 = (0, -f_{0z}, f_{0y}) \cdot v_0 = v_{0z}v_{1y} - v_{0y}v_{1z}\)</span></p>
<p><span class="math inline">\(p_1 = a_{00} \cdot v_1 = (0, -f_{0z}, f_{0y}) \cdot v_1 = v_{0z}v_{1y} - v_{0y}v_{1z} = p_0\)</span></p>
<p>$p_2 = a_{00} v_2 = (0, -f_{0z}, f_{0y}) v_2 = (v_{1y} - v_{0y})v_{2z} - (v_{1z} - v_{0z})v_{2y} $</p>
<p>由于 <span class="math inline">\(p_0 == p_1\)</span>， 所以在求最大最小值时只需要做一次比较，接着求 box 在该向量上的投影，box 中心在原点，所以投影半径 <span class="math inline">\(r\)</span> 可以以一种简单的方式求出：</p>
<p><span class="math inline">\(r = h_x|a_{00x}| + h_y|a_{00y}| + h_z|a_{00z}| = h_y|a_{00y}| + h_z|a_{00z}|\)</span></p>
<p>计算投影是否重合也很简单：</p>
<p><span class="math inline">\(if(min(p_0, p_2) &gt; r \  || \  max(p_0, p_2) &lt; -r) \quad return \ false\)</span> 否则两者投影相交，继续计算其它向量。</p></li>
<li><p>三个轴向单位向量 e 中的投影是否重合就更好判断了，完全不需要计算投影，只需要计算三角形的最小 AABB，判断两个 AABB 是否相交即可（取两个 AABB 最小的顶点和最大的顶点，从三维上判断最小是否的大于最大的即可，若任意一个维度上最小的比最大的大，则两者不相交），</p></li>
<li><p>至于判断最后一个向量——三角形的法向量上的投影是否重合，相当于判断三角形所在平面是否与 box 相交。判断 box 与平面相交有一种简单快速的方式，即通过公式 <span class="math inline">\(|d| &lt;= a_1 |n \cdot A^1| + a_2|n \cdot A^2| + a_3 |n \cdot A^3|\)</span> ，其中 <span class="math inline">\(d\)</span> 为 box 中心到平面的距离（中心点到平面上一点构成的向量与平面法向量做点积），<span class="math inline">\(n\)</span> 为平面法向量，<span class="math inline">\(A^1\)</span> 为 box 侧面法向量，对于 AABB 可为 <span class="math inline">\((1, 0, 0)\)</span>，<span class="math inline">\(a_1\)</span> 为 box 中心到侧面的距离，对于 AABB 可为 <span class="math inline">\(h_x\)</span>，同理 <span class="math inline">\(A^2\)</span> 为 box 顶面法向量，对于 AABB 可为 <span class="math inline">\((0, 1, 0)\)</span>，<span class="math inline">\(a_2\)</span> 为 box 中心到顶面距离，对于 AABB 可为 <span class="math inline">\(h_y\)</span>，<span class="math inline">\(A^3\)</span> 为 box 正面法向量，对于 AABB 可为 <span class="math inline">\((0, 0, 1)\)</span>，<span class="math inline">\(a_3\)</span> 为 box 中心到正面距离，对于 AABB 可为 <span class="math inline">\(h_z\)</span>，即在 AABB 中，该公式可简化为 <span class="math inline">\(|d| &lt;= h_x|n_x| + h_y|n_y| + h_z|n_z|\)</span> ，满足该公式，即可判定平面与 AABB 相交。</p></li>
</ol>
<p>　　如此 13 个向量全部判断完毕，如全都相交，则可认定三角形与长方体相交，若其中一个不相交，则三角形与长方体不相交。三维的都能判断，二维的三角形与矩形相交判断就更简单了，分成两类法向量后，利用向量运算先简化运算量，再计算投影是否相交即可。</p>
<h2 id="附录">附录</h2>
<p>　　还有一种根据距离判断两个 AABB 是否相交的办法，即先取两个 AABB 的中心 <span class="math inline">\((x_1, y_1, z_1)\)</span> 和 <span class="math inline">\((x_2, y_2, z_2)\)</span>，然后计算两个中心点之间的三个维度的距离，将 x 维度的距离与两个AABB 的 <span class="math inline">\(h_x\)</span> 之和比较，若中心点 x 维度的距离较大，则不相交。即：<span class="math inline">\(if (|x_1 - x_2| &gt; h_{x1} + h_{x2}) \quad return \ false\)</span> ，否则比较 y 维度， z 维度，若所有都小，则两 AABB 相交。这种方式是 Shaun 在一次面试中被问到没答出后在网上找到的答案，其实感觉和比较最小最大顶点也差不多，都是从不相交出发，因为直接判断相交基本不可能，而不相交很容易判断，把所有的不相交情况判断完，那就只剩相交了，可惜面试官只想要这种方案 ╮(╯▽╰)╭。</p>
<h2 id="参考资料">参考资料</h2>
<p>[1] <a href="http://fileadmin.cs.lth.se/cs/Personal/Tomas_Akenine-Moller/code/">Code by Tomas Akenine-Möller</a></p>
<p>[2] <a href="https://www.gamasutra.com/view/feature/131790/simple_intersection_tests_for_games.php?print=1">Simple Intersection Tests For Games</a></p>
]]></content>
      <categories>
        <category>Image&amp;Graphic</category>
      </categories>
      <tags>
        <tag>algorithm</tag>
        <tag>geometry</tag>
      </tags>
  </entry>
  <entry>
    <title>斐波那契数列的三种写法</title>
    <url>/posts/8fb9f004.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　本文预示着 Shaun 开始着手准备找工作的事了，初步计划是先把『剑指Offer』上的题先做一遍，对照着 <a href="https://www.nowcoder.com/ta/coding-interviews">牛客网</a> 上的题进行测试，尽量争取先把书上的题都能 AC 。一般定义的斐波那契数列数列为：0,1,1,2,3,5,8……（对应 <span class="math inline">\(F(0)=0, F(1)=1, F(2)=1, \cdots \cdots\)</span>），用数学公式表示即为：<span class="math inline">\(F(n)=F(n-1)+F(n-2)\)</span>。以下代码均用 C++ 实现，且均通过牛客的测试。</p>
<span id="more"></span>
<h2 id="循环写法">循环写法</h2>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fibonacci_loop</span><span class="params">(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> &amp;n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> fn = <span class="number">0</span>, f1 = <span class="number">0</span>, f2 = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		fn = f1 + f2;</span><br><span class="line">		f2 = f1;</span><br><span class="line">		f1 = fn;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> fn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h2 id="递归写法">递归写法</h2>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fibonacci_recursive</span><span class="params">(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> &amp;n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (n == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (n == <span class="number">1</span> || n == <span class="number">2</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125; </span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">fibonacci_recursive</span>(n - <span class="number">1</span>) + <span class="built_in">fibonacci_recursive</span>(n - <span class="number">2</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>　　<strong><em>※注：</em></strong>这里 Shaun 在牛客上进行测试的时候，如果把 <code>|| n == 2</code> 去掉的话，就没法通过，可见多递归一次花费的时间并不是线性增长的。</p>
<h2 id="尾递归写法">尾递归写法</h2>
<p>　　说来惭愧，这个概念还是在一个小学弟那里得知的，后面才逐渐了解并学会使用。</p>
<p>　　尾递归，简而言之就是最后会且仅会调用函数本身，递归调用函数之后没有其它的语句需要执行。就像上面的递归，它在递归调用之后还会执行加法运算，而尾递归在执行递归调用之后就没有其它的运算了。</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fibonacci_tailRecursive</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> n, <span class="keyword">unsigned</span> <span class="keyword">int</span> f1 = <span class="number">1</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span> fn = <span class="number">0</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (n == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> fn;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">fibonacci_tailRecursive</span>(n - <span class="number">1</span>, fn, fn + f1);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h2 id="总结">总结</h2>
<p>　　循环和尾递归花费的时间和空间都差不多，都要比普通的递归要小，普通的递归优势在于便于理解，代码好写，在不强调性能的前提下，用递归写法的代码可读性可能要好些。</p>
<h2 id="参考资料">参考资料</h2>
<p>[1] <a href="http://www.cnblogs.com/Anker/archive/2013/03/04/2943498.html">递归与尾递归总结</a>（<a href="http://www.cnblogs.com/Anker/category/436371.html" class="uri">http://www.cnblogs.com/Anker/category/436371.html</a>）</p>
]]></content>
      <categories>
        <category>Study</category>
      </categories>
      <tags>
        <tag>c/cpp</tag>
      </tags>
  </entry>
  <entry>
    <title>图割算法之Graph Cuts浅见</title>
    <url>/posts/c42ff8d4.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　以后可能需要用图割算法做一些事情，所以就简单阅读了一下图割算法中最基础的一篇论文，<em>Boykov Y Y, Jolly M P. Interactive graph cuts for optimal boundary &amp; region segmentation of objects in ND images. Computer Vision, 2001. ICCV 2001. Proceedings. Eighth IEEE International Conference on. IEEE, 2001, 1: 105-112.</em> 。</p>
<span id="more"></span>
<h2 id="图篇">图篇</h2>
<p>　　图割算法（Graph Cuts），顾名思义，是基于图的一种图像分割方法，这里的图既是指数据结构中的图结构也是指数学中的图论，毕竟数据结构中的图结构也来自于数学中图论。既然是图，必然离不开图的构建，论文中图的构建如下，可以简称为 S/T 图：</p>
<figure>
<img src="http://img.my.csdn.net/uploads/201301/23/1358872281_7151.jpg" alt="论文中图结构" /><figcaption aria-hidden="true">论文中图结构</figcaption>
</figure>
<p>和普通的无向图 <span class="math inline">\(G=(V,E)\)</span> 一样，该图也是由顶点集合 <span class="math inline">\(V\)</span> 和边集合 <span class="math inline">\(E\)</span> 构成，不一样的是，该图有两种顶点和两种边：</p>
<ol type="1">
<li>第一种顶点是普通顶点。由图像中各像素点组成，每个顶点对应于图像中每个像素点。每两个邻域顶点，对应于图像中每相邻两个像素点（对2维图像来说，是8邻域；对3维图像来说，是26邻域），的连接就是一条边，这种边叫做 n-links (neighborhood links)。</li>
<li>第二种顶点是两个终端顶点，代表目标（object）的 source terminal（简称 S）和代表背景（background）的 sink terminal（简称 T），每个终端顶点都与所有普通顶点相连，这种相连构成的边叫做 t-links (terminal links)。</li>
</ol>
<p>　　设图像 <span class="math inline">\(P\)</span> 中每个像素点为 <span class="math inline">\(p\)</span>，则 <span class="math inline">\(p \in P\)</span>，目标终端顶点 <span class="math inline">\(S\)</span>，背景终端顶点 <span class="math inline">\(T\)</span> ，则构建的图 <span class="math inline">\(G\)</span> 中顶点集合可表示为：<span class="math inline">\(V = P \cup \{S,T\}\)</span> ；每个 <span class="math inline">\(p\)</span> 都有两种 t-links 边，分别为 <span class="math inline">\(\{p,S\}\)</span> 和 <span class="math inline">\(\{p,T\}\)</span> ，每个 <span class="math inline">\(p\)</span> 与其邻域内像素 <span class="math inline">\(q\)</span> 构成的 n-links 边为 <span class="math inline">\(\{p,q\}\)</span> ，设 <span class="math inline">\(N\)</span> 代表 n-links 边集合，即邻域边集合，则 <span class="math inline">\(\{p,q\} \in N\)</span> ，则构建的图 <span class="math inline">\(G\)</span> 中边集合可表示为：<span class="math inline">\(E = N \bigcup\limits_{p \in P} \{\{p,S\},\{p,T\}\}\)</span> 。</p>
<p>因为这构建的是一个无向带权图，所以还需要设定边的权值，论文中边的权值设定如下：</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">边</th>
<th style="text-align: center;">权值（代价，能量）</th>
<th style="text-align: center;">区域</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math inline">\(\{p,q\}\)</span></td>
<td style="text-align: center;"><span class="math inline">\(B_{\{p,q\}}\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\{p,q\} \in N\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;"><span class="math inline">\(\{p,S\}\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\lambda \cdot R_p(&quot;bkg&quot;)\)</span></td>
<td style="text-align: center;"><span class="math inline">\(p \in P, p \notin O \cup B\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><span class="math inline">\(\{p,S\}\)</span></td>
<td style="text-align: center;"><span class="math inline">\(K\)</span></td>
<td style="text-align: center;"><span class="math inline">\(p \in O\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;"><span class="math inline">\(\{p,S\}\)</span></td>
<td style="text-align: center;">0</td>
<td style="text-align: center;"><span class="math inline">\(p \in B\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><span class="math inline">\(\{p,T\}\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\lambda \cdot R_p(&quot;obj&quot;)\)</span></td>
<td style="text-align: center;"><span class="math inline">\(p \in P, p \notin O \cup B\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;"><span class="math inline">\(\{p,T\}\)</span></td>
<td style="text-align: center;">0</td>
<td style="text-align: center;"><span class="math inline">\(p \in O\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><span class="math inline">\(\{p,T\}\)</span></td>
<td style="text-align: center;"><span class="math inline">\(K\)</span></td>
<td style="text-align: center;"><span class="math inline">\(p \in B\)</span></td>
</tr>
</tbody>
</table>
<ul>
<li>其中集合 <span class="math inline">\(O\)</span> 代表确定为目标的像素点的集合，即在交互时手动标注为目标的像素点；</li>
<li>集合 <span class="math inline">\(B\)</span> 代表确定为背景的像素点的集合，即在交互时手动标注为背景的像素点；</li>
<li><span class="math inline">\(B_{\{p,q\}}\)</span> 可以表示 {p,q} 不连续的惩罚因子，其正比于一个指数函数，具体为：<span class="math inline">\(B_{\{p,q\}} \propto exp\left(-\frac{(I_p-I_q)^2}{2\sigma^2}\right) \cdot \frac{1}{dist(p,q)}\)</span> ，其中 <span class="math inline">\(I_p\)</span> 和 <span class="math inline">\(I_q\)</span> 代表像素 <span class="math inline">\(p\)</span> 和像素 <span class="math inline">\(q\)</span> 的像素值，<span class="math inline">\(dist(p,q)\)</span> 代表其两像素点之间的距离。从 <span class="math inline">\(B_{\{p,q\}}\)</span> 对应的函数中可以看出当两像素点之间的差异越大时，其权值越小；两像素点之间距离越大时，权值越小（这里对于二维图像来说，一般只考虑周围 8 邻域内像素点，因此可以简单认为相邻两像素点之间距离为 1）。</li>
<li><span class="math inline">\(R_p(&quot;bkg&quot;)\)</span> 和 <span class="math inline">\(R_p(&quot;obj&quot;)\)</span> 分别是指像素 p 分配给背景和前景目标的惩罚因子，该惩罚因子与像素 p 属于前景目标的概率 <span class="math inline">\(Pr(I|O)\)</span> 和背景的概率 <span class="math inline">\(Pr(I|B)\)</span> 有关，一般取概率的负对数值，具体如下：<span class="math inline">\(R_p(“obj”) = −lnPr(I_p|O)\)</span> 和 <span class="math inline">\(R_p(“bkg”) = −lnPr(I_p|B)\)</span> 。至于概率的计算方法可以用简单的直方图概率模型，因为 <span class="math inline">\(O\)</span> 和 <span class="math inline">\(B\)</span> 为手动标注的确定的前景目标和背景的像素点集合，因此可以分别统计其灰度直方图，再对直方图频数进行归一化得到分布概率直方图，将像素 p 与 背景分布概率直方图和前景目标概率分布直方图进行对比，即可得到其属于背景的概率和属于前景目标的概率（当然更好的一种计算前景和背景概率的方法是用高斯混合模型）。</li>
<li><span class="math inline">\(K\)</span> 表示整个无向带权图中最大的权值，具体计算方法如下：<span class="math inline">\(K=1+\max\limits_{p \in P} \sum \limits_{q:\{p,q\} \in N} B_{\{p,q\}}\)</span> ，即取图像中像素点邻域边权值之和的最大值再加 1 （对于二维图像而言，邻域边权值之和是指 8 邻域边权值之和，图像中每个像素点都有其邻域边权值之和，取所有像素点中的最大值），至于为什么要令 K 为整个无向带权图中权值最大值？请详见下文。</li>
<li>至于其中的参数 <span class="math inline">\(\lambda\)</span> 和 <span class="math inline">\(\sigma\)</span> 论文中没有明确指定，在初始计算时可以将其置为 1，随后再慢慢调整。</li>
</ul>
<p>至此，整个 Graph Cuts 算法中关于图的构建已经完全确定，接下来就是割（cut）的算法了。</p>
<h2 id="割篇">割篇</h2>
<p>　　割（cut）是构建的无向带权图中边集合 <span class="math inline">\(E\)</span> 的一个子集 <span class="math inline">\(C\)</span>，即割 <span class="math inline">\(C \subset E\)</span> ，该 cut 的 代价（cost）可表示为：<span class="math inline">\(|C|=\sum \limits_{e \in C} W_e\)</span>，即该割边集合的所有边权值之和。</p>
<blockquote>
<p>如果一个割，其包含的所有边的权值之和最小，那么这个割就称为最小割，也就是图割的结果。在图分割里，是要求两个终端顶点被分离开的，即最小割把图的顶点划分为两个不相交的子集 <span class="math inline">\(S\)</span> 和 <span class="math inline">\(T\)</span> ，其中 <span class="math inline">\(s∈S\)</span>，<span class="math inline">\(t∈T\)</span>，<span class="math inline">\(T=V/S\)</span>。事实上，这两个子集对应于图像的前景像素集和背景像素集，也就相当于完成了图像分割。</p>
</blockquote>
<p>　　割相关的算法有很多，eg：Max-flow/Min-cut、GrabCut、One cut、 Normalized cut、Ratio cut 等等，但是其最关键的地方在于能量方程（或称 代价函数，损失函数）的优化，能量优化的目的在于最小化能量函数，而最小化能量函数时取得割就是最小割，即图割的结果。论文中能量方程的定义如下： <span class="math display">\[
E(A)= \lambda \cdot R(A)+B(A)
\]</span> 其中： <span class="math display">\[
R(A)= \sum_{p \in P} R_p(A_p)   \\
B(A)= \sum_{\{p,q\} \in N} B_{\{p,q\}} \cdot \delta(A_p,A_q)    \\
其中　\delta(A_p,A_q) = \begin{cases} 1 &amp; \text{if } A_p \neq A_q  \\ 0 &amp; \text{otherwise}. \end{cases}
\]</span></p>
<ul>
<li>其中令 <span class="math inline">\(A=(A_1,\cdots,A_p,\cdots,A_{|P|})\)</span> 为二值向量，每个 <span class="math inline">\(A_p\)</span> 可赋值为 “obj”（可用 1 表示前景） 或 “bkg”（可用 0 表示背景）；</li>
<li><span class="math inline">\(R(A)\)</span> 表示区域项，即上文中的两种 t-links 边相连的图像像素点权值，代表像素点分配给 “obj” 或 “bkg” 的惩罚项，对应于 <span class="math inline">\(R_p(&quot;obj&quot;)\)</span> 和 <span class="math inline">\(R_p(&quot;bkg&quot;)\)</span> ，求和后即可得到 <span class="math inline">\(R(A)\)</span> 。当像素点 p 属于前景目标的概率 <span class="math inline">\(Pr(I|O)\)</span> 大于背景的概率 <span class="math inline">\(Pr(I|B)\)</span> 时，由上文 <span class="math inline">\(R_p(A_p) = −lnPr(I_p|A_p)\)</span> 可知，此时 <span class="math inline">\(R_p(&quot;obj&quot;)\)</span> 小于 <span class="math inline">\(R_p(&quot;bkg&quot;)\)</span> ，即当像素 p 更有可能属于目标时，将 p 归类为目标就会使能量 <span class="math inline">\(R(A)\)</span> 小，也因此要取概率的负对数值，由此，如果所有像素点都能正确划分为前景和背景，则总能量会达到最小。当像素点 p 已经人为手动标注为确定的前景目标时，这时其与顶点 <span class="math inline">\(S\)</span> 相连的边的权值为 K，为整个无向带权图中最大的权值，即能量也最大，此时就不可能被分割，<em>这就是为什么要令 K 为整个无向带权图中权值最大值</em>，而其与顶点 <span class="math inline">\(T\)</span> 相连的权值为 0 ，能量也为 0，此时一定会被分割。</li>
<li><span class="math inline">\(B(A)\)</span> 表示边界项，即上文中 n-links 边的权值，代表邻域像素点 <span class="math inline">\({p,q}\)</span> 不连续的惩罚，当其差异越大时， <span class="math inline">\(B(A)\)</span> 越趋近于 0，即当邻域像素点差异越大时，由上文 <span class="math inline">\(B_{\{p,q\}} \propto exp\left(-\frac{(I_p-I_q)^2}{2\sigma^2}\right) \cdot \frac{1}{dist(p,q)}\)</span> 可知其权值越小，能量 <span class="math inline">\(B(A)\)</span> 也越小，则越应该被分割。</li>
<li>参数 <span class="math inline">\(\lambda\)</span> 用来表示区域项和边界项的重要性，初始计算时同样可以将其置为 1。</li>
<li>至于 <span class="math inline">\(\delta(A_p,A_q)\)</span> 的个人理解为：当邻域像素点 <span class="math inline">\(p,q\)</span> 被分配的二值变量不同时，即一个是前景另一个是背景，这时在进行能量计算时需要考虑连接亮点的边 <span class="math inline">\(\{p,q\}\)</span> 的权值，否则可以不考虑其权值。</li>
</ul>
<p>最后，本文割的具体实施是采用基于「最大流/最小割」算法进行的，而「最大流/最小割」算法针对的是有向图，所以需要把本文 S/T 图的每条无向边都转化为一去一回的两条有向边。</p>
<h2 id="附录">附录</h2>
<p>　　该论文还有一个有意思的地方就是其证明了能量函数 E(A) 的值只与割 <span class="math inline">\(C\)</span> 有关，最小割与最小化能量函数对应。证明过程如下：</p>
<blockquote>
<p>由上文可知，对于图像中每个像素点，割 <span class="math inline">\(C\)</span> 切断且仅切断一条 t-links 边，即要么切断 <span class="math inline">\(\{p,S\}\)</span> 边，要么切断 <span class="math inline">\(\{p,T\}\)</span> 边，毕竟一个像素点不可能同时属于前景和背景，也不可能既不属于前景也不属于背景；不属于同一终端顶点相连的 n-links 边也会被割 <span class="math inline">\(C\)</span> 切断，因为如果不断开，则整个图还是相连的，而如果属于同一终端顶点相连的 n-links 边不应该被割 <span class="math inline">\(C\)</span> 切断，否则，该割就不是最小割。</p>
<p>对于任意割 <span class="math inline">\(C\)</span> ，可定义其对应的图像分割结果向量 <span class="math inline">\(A(C)\)</span> ，如下： <span class="math display">\[
A_p(C) = \begin{cases} &quot;obj&quot; &amp; \text{if } \{p,T\} \in C  \\ &quot;bkg&quot; &amp; \text{if } \{p,S\} \in C \end{cases}
\]</span> 因此当 C 确定之后，分割结果 A 也就确定了。</p>
<p>利用上文给出的边的权值计算方法结合定义的 A 可得出割的代价（cost）： <span class="math display">\[
\begin{align}
|C| &amp;= \sum_{p \notin O \cup B} \lambda \cdot R_p(A_p(C)) + \sum_{p \in O} \lambda \cdot R_p(A_p(C)) + \sum_{p \in B} \lambda \cdot R_p(A_p(C)) + \sum_{\{p.q\} \in N} B_{\{p,q\}} \cdot \delta((A_p(C)),A_q(C))) \\ 
 &amp;= \sum_{p \notin O \cup B} \lambda \cdot R_p(A_p(C)) +0 + 0 + \sum_{\{p.q\} \in N} B_{\{p,q\}} \cdot \delta((A_p(C)),A_q(C)))
 \end{align}
\]</span> 这里是因为 <span class="math inline">\(O \cap B = \emptyset\)</span> ，而且如果确定像素点 p 属于前景或背景，则其割边的权值必为 0，相应的代价也为 0，eg：设 p 确定为前景，则必定断开 {p,T} 边，而 {p,T} 边的权值为 0。</p>
<p>又因为：<span class="math inline">\(E(A) = \lambda \cdot R(A) + B(A)\)</span> ，则： <span class="math display">\[
\begin{align}
E(A(C)) &amp;= \lambda \cdot R(A(C)) + B(A(C)) \\
&amp;=  \sum_{p \in P} \lambda \cdot R_p(A_p(C)) + \sum_{\{p.q\} \in N} B_{\{p,q\}} \cdot \delta((A_p(C)),A_q(C))) \\
&amp;= \sum_{p \notin O \cup B} \lambda \cdot R_p(A_p(C)) + \sum_{p \in O} \lambda \cdot R_p(&quot;obj&quot;) + \sum_{p \in B} \lambda \cdot R_p(&quot;bkg&quot;) + \sum_{\{p.q\} \in N} B_{\{p,q\}} \cdot \delta((A_p(C)),A_q(C)))
\end{align}
\]</span> 所以：<span class="math inline">\(|C| = E(A(C)) - \sum \limits_{p \in O} \lambda \cdot R_p(&quot;obj&quot;) - \sum \limits_{p \in B} \lambda \cdot R_p(&quot;bkg&quot;)\)</span></p>
<p>又因为对于标注确定的前景和背景，任意割 C 的 <span class="math inline">\(\sum \limits_{p \in O} \lambda \cdot R_p(&quot;obj&quot;)\)</span> 和 <span class="math inline">\(\sum \limits_{p \in B} \lambda \cdot R_p(&quot;bkg&quot;)\)</span> 都是完全确定不变的，可以令其为 const，则 <span class="math inline">\(E(A) = |C| + const\)</span> ，当 <span class="math inline">\(C\)</span> 取最小时，对应的 <span class="math inline">\(E(A)\)</span> 也最小，即当割最小时，能量函数也最小。</p>
</blockquote>
<h2 id="后记">后记</h2>
<p>　　虽说关于 Graph Cuts 网上已经有了无数篇博客对其进行描述，但其中或多或少感觉还是有些令人困惑的地方，于是写下本文将那些个人感觉有些困惑的地方重新梳理一下，再改变一下原论文的行文思路，个人感觉更好理解一点，不然一上来就是神马能量方程，简直一脸懵逼 (･ัω･ั) 。</p>
<h2 id="参考资料">参考资料</h2>
<p>[1] <a href="https://blog.csdn.net/lut609921895/article/details/56665368">Interactive Graph Cuts for Optimal Boundary and Region Segmentation of Objects in N-D ImageS</a></p>
<p>[2] <a href="https://blog.csdn.net/u014613043/article/details/51228355">Graph Cuts</a></p>
<p>[3] <a href="https://blog.csdn.net/zouxy09/article/details/8532111">图像分割之（二）Graph Cut（图割）</a></p>
<p>[4] <a href="https://blog.csdn.net/qq_22201697/article/details/72743891">图像分割算法——Graph Cuts</a></p>
<p>[5] <a href="https://zhuanlan.zhihu.com/p/29644464">Interactive Graph Cuts for Optimal Boundary &amp; Region Segmentation of Objects in N-D Images 阅读笔记</a></p>
]]></content>
      <categories>
        <category>Image&amp;Graphic</category>
      </categories>
      <tags>
        <tag>note</tag>
        <tag>segmentation</tag>
      </tags>
  </entry>
  <entry>
    <title>用OpenCV显示OpenGL图形</title>
    <url>/posts/302a6244.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　本文就是一个小实验，试验 OpenCV 到底能不能支持 OpenGL 图形显示。</p>
<span id="more"></span>
<h2 id="正文">正文</h2>
<p>　　如果在 OpenCV 用 CMake 编译时勾选 <strong>WITH_OPENGL</strong> 且编译一切顺利的话，编译和配置的具体步骤和情况可以看 Shaun 写的一篇文档：<a href="https://cniter.github.io/posts/7df528b4.html">Win10＋VS2013＋CMake-gui编译和配置OpenCV-3.2.0</a> ，那么就可以用 OpenCV 窗口显示 OpenGL 图形。</p>
<p>　　在 VS 下使用 Windows 原有的 OpenGL 函数需要包含以下头文件和库文件：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;GL/gl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;GL/glu.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">&quot;OpenGL32.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">&quot;glu32.lib&quot;</span>)</span></span><br></pre></td></tr></table></figure></div>
<p>　　在 OpenCV 中显示 OpenGL 图形需要 <code>cv::namedWindow(openGLWindowName, cv::WINDOW_OPENGL)</code>，在 namedWindow 函数中添加 cv::WINDOW_OPENGL 参数说明该窗口支持 OpenGL 图形。</p>
<p>附示例程序：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;GL/gl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;GL/glu.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">&quot;OpenGL32.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">&quot;glu32.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">float</span> vertex_list[][<span class="number">3</span>] =</span><br><span class="line">&#123;</span><br><span class="line">	<span class="number">-0.5f</span>, <span class="number">-0.5f</span>, <span class="number">-0.5f</span>,</span><br><span class="line">	<span class="number">0.5f</span>, <span class="number">-0.5f</span>, <span class="number">-0.5f</span>,</span><br><span class="line">	<span class="number">-0.5f</span>, <span class="number">0.5f</span>, <span class="number">-0.5f</span>,</span><br><span class="line">	<span class="number">0.5f</span>, <span class="number">0.5f</span>, <span class="number">-0.5f</span>,</span><br><span class="line">	<span class="number">-0.5f</span>, <span class="number">-0.5f</span>, <span class="number">0.5f</span>,</span><br><span class="line">	<span class="number">0.5f</span>, <span class="number">-0.5f</span>, <span class="number">0.5f</span>,</span><br><span class="line">	<span class="number">-0.5f</span>, <span class="number">0.5f</span>, <span class="number">0.5f</span>,</span><br><span class="line">	<span class="number">0.5f</span>, <span class="number">0.5f</span>, <span class="number">0.5f</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将要使用的顶点的序号保存到一个数组里面 </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> GLint index_list[][<span class="number">2</span>] =</span><br><span class="line">&#123;</span><br><span class="line">	&#123; <span class="number">0</span>, <span class="number">1</span> &#125;,</span><br><span class="line">	&#123; <span class="number">2</span>, <span class="number">3</span> &#125;,</span><br><span class="line">	&#123; <span class="number">4</span>, <span class="number">5</span> &#125;,</span><br><span class="line">	&#123; <span class="number">6</span>, <span class="number">7</span> &#125;,</span><br><span class="line">	&#123; <span class="number">0</span>, <span class="number">2</span> &#125;,</span><br><span class="line">	&#123; <span class="number">1</span>, <span class="number">3</span> &#125;,</span><br><span class="line">	&#123; <span class="number">4</span>, <span class="number">6</span> &#125;,</span><br><span class="line">	&#123; <span class="number">5</span>, <span class="number">7</span> &#125;,</span><br><span class="line">	&#123; <span class="number">0</span>, <span class="number">4</span> &#125;,</span><br><span class="line">	&#123; <span class="number">1</span>, <span class="number">5</span> &#125;,</span><br><span class="line">	&#123; <span class="number">7</span>, <span class="number">3</span> &#125;,</span><br><span class="line">	&#123; <span class="number">2</span>, <span class="number">6</span> &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">float</span> rotate = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> times = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">GLint windowWidth = <span class="number">800</span>;</span><br><span class="line">GLint windowHeight = <span class="number">800</span>;</span><br><span class="line"></span><br><span class="line">GLfloat xRotAngle = <span class="number">-75.0f</span>;</span><br><span class="line">GLfloat yRotAngle = <span class="number">0.0f</span>;</span><br><span class="line">GLfloat zRotAngle = <span class="number">-135.0f</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">float</span> MIN_X = <span class="number">-200</span>;</span><br><span class="line"><span class="keyword">float</span> MAX_X = <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">float</span> MIN_Y = <span class="number">-200</span>;</span><br><span class="line"><span class="keyword">float</span> MAX_Y = <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">float</span> MIN_Z = <span class="number">-200</span>;</span><br><span class="line"><span class="keyword">float</span> MAX_Z = <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line">GLfloat coordinatesize = <span class="number">200.0f</span>;</span><br><span class="line">GLfloat ratio = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">drawLine</span><span class="params">(<span class="keyword">float</span> x1, <span class="keyword">float</span> y1, <span class="keyword">float</span> z1, <span class="keyword">float</span> x2, <span class="keyword">float</span> y2, <span class="keyword">float</span> z2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">glBegin</span>(GL_LINES);</span><br><span class="line">	<span class="built_in">glVertex3f</span>(x1, y1, z1);</span><br><span class="line">	<span class="built_in">glVertex3f</span>(x2, y2, z2);</span><br><span class="line">	<span class="built_in">glEnd</span>();</span><br><span class="line">	<span class="built_in">glFlush</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 绘制立方体</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DrawCube</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i, j;</span><br><span class="line">	<span class="built_in">glBegin</span>(GL_LINES);</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">12</span>; ++i) <span class="comment">// 12 条线段</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">2</span>; ++j) <span class="comment">// 每条线段 2个顶点</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">glVertex3fv</span>(vertex_list[index_list[i][j]]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">glEnd</span>();</span><br><span class="line">	<span class="built_in">glFlush</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reshapeOperate</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">glMatrixMode</span>(GL_PROJECTION);</span><br><span class="line">	<span class="built_in">glLoadIdentity</span>();</span><br><span class="line">	<span class="keyword">if</span> (ratio &lt; <span class="number">1</span>)</span><br><span class="line">		<span class="built_in">glOrtho</span>(-coordinatesize, coordinatesize, -coordinatesize / ratio, coordinatesize / ratio, -coordinatesize, coordinatesize);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="built_in">glOrtho</span>(-coordinatesize*ratio, coordinatesize*ratio, -coordinatesize, coordinatesize, -coordinatesize, coordinatesize);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">glMatrixMode</span>(GL_MODELVIEW);</span><br><span class="line">	<span class="built_in">glLoadIdentity</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reshape</span><span class="params">(<span class="keyword">int</span> w, <span class="keyword">int</span> h)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ((w == <span class="number">0</span>) || (h == <span class="number">0</span>))</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">glViewport</span>(<span class="number">0</span>, <span class="number">0</span>, w, h);</span><br><span class="line"></span><br><span class="line">	ratio = (GLfloat)w / (GLfloat)h;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">reshapeOperate</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GLfloat AngleX = <span class="number">45.0f</span>;</span><br><span class="line">GLfloat AngleY = <span class="number">315.0f</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reshape1</span><span class="params">(<span class="keyword">int</span> w, <span class="keyword">int</span> h)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	GLfloat aspect = (GLfloat)w / (GLfloat)h;</span><br><span class="line">	GLfloat nRange = <span class="number">100.0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">glViewport</span>(<span class="number">0</span>, <span class="number">0</span>, w, h);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">glMatrixMode</span>(GL_PROJECTION); <span class="comment">//将当前矩阵指定为投影模式  </span></span><br><span class="line">	<span class="built_in">glLoadIdentity</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//设置三维投影区  </span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (w &lt;= h)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">glOrtho</span>(-nRange, nRange, -nRange * aspect, nRange * aspect, -nRange, nRange);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">glOrtho</span>(-nRange, nRange, -nRange / aspect, nRange / aspect, -nRange, nRange);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(<span class="keyword">void</span>*)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// Draw something using OpenGL here  </span></span><br><span class="line">	<span class="comment">//glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);	 //清除所有的像素</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//glMatrixMode(GL_MODELVIEW);</span></span><br><span class="line">	<span class="comment">//glLoadIdentity();</span></span><br><span class="line">	<span class="comment">//glPushMatrix();</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">////glTranslatef(-0.2, 0, 0); // 平移</span></span><br><span class="line">	<span class="comment">////glScalef(2, 1, 1);    // 缩放</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//glRotatef(xRotAngle, 1.0f, 0.0f, 0.0f);</span></span><br><span class="line">	<span class="comment">//glRotatef(yRotAngle, 0.0f, 1.0f, 0.0f);</span></span><br><span class="line">	<span class="comment">//glRotatef(zRotAngle, 0.0f, 0.0f, 1.0f);</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//glColor3f(1, 0, 0);</span></span><br><span class="line">	<span class="comment">//drawLine(0, 0, 0, MAX_X, 0, 0); //x轴</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//glColor3f(0, 1, 0);</span></span><br><span class="line">	<span class="comment">//drawLine(0, 0, 0, 0, MAX_Y, 0); //y轴</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//glColor3f(0, 0, 1);</span></span><br><span class="line">	<span class="comment">//drawLine(0, 0, 0, 0, 0, MAX_Z); //z轴</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//times++;</span></span><br><span class="line">	<span class="comment">//if (times &gt; 1)</span></span><br><span class="line">	<span class="comment">//&#123;</span></span><br><span class="line">	<span class="comment">//	times = 0;</span></span><br><span class="line">	<span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//if (times % 1 == 0)</span></span><br><span class="line">	<span class="comment">//&#123;</span></span><br><span class="line">	<span class="comment">//	rotate += 0.3;</span></span><br><span class="line">	<span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//glRotatef(rotate, 0, 1, 0);</span></span><br><span class="line">	<span class="comment">//glRotatef(rotate, 1, 0, 0);</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//glColor3f(0, 1, 1);</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//DrawCube();</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//glPopMatrix();</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">reshape1</span>(windowWidth, windowHeight);</span><br><span class="line">	<span class="built_in">glClear</span>(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);</span><br><span class="line">	<span class="built_in">glMatrixMode</span>(GL_MODELVIEW);</span><br><span class="line">	<span class="built_in">glLoadIdentity</span>();</span><br><span class="line">	AngleX++;</span><br><span class="line">	AngleY++;</span><br><span class="line">	<span class="built_in">glPushMatrix</span>();</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">glRotatef</span>(AngleX, <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>);</span><br><span class="line">		<span class="built_in">glRotatef</span>(AngleY, <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glBegin</span>(GL_POLYGON); <span class="comment">//前表面  </span></span><br><span class="line">		<span class="built_in">glColor3ub</span>((GLubyte)<span class="number">255</span>, (GLubyte)<span class="number">255</span>, (GLubyte)<span class="number">255</span>);<span class="comment">//颜色设置为白色  </span></span><br><span class="line">		<span class="built_in">glVertex3f</span>(<span class="number">50.0f</span>, <span class="number">50.0f</span>, <span class="number">50.0f</span>);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glColor3ub</span>((GLubyte)<span class="number">255</span>, (GLubyte)<span class="number">255</span>, (GLubyte)<span class="number">0</span>);<span class="comment">//颜色设置为黄色  </span></span><br><span class="line">		<span class="built_in">glVertex3f</span>(<span class="number">50.0f</span>, <span class="number">-50.0f</span>, <span class="number">50.0f</span>);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glColor3ub</span>((GLubyte)<span class="number">255</span>, (GLubyte)<span class="number">0</span>, (GLubyte)<span class="number">0</span>);<span class="comment">//颜色设置为红色  </span></span><br><span class="line">		<span class="built_in">glVertex3f</span>(<span class="number">-50.0f</span>, <span class="number">-50.0f</span>, <span class="number">50.0f</span>);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glColor3ub</span>((GLubyte)<span class="number">255</span>, (GLubyte)<span class="number">0</span>, (GLubyte)<span class="number">255</span>);<span class="comment">//颜色设置为白色  </span></span><br><span class="line">		<span class="built_in">glVertex3f</span>(<span class="number">-50.0f</span>, <span class="number">50.0f</span>, <span class="number">50.0f</span>);</span><br><span class="line">		<span class="built_in">glEnd</span>();</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glBegin</span>(GL_POLYGON); <span class="comment">//后表面  </span></span><br><span class="line">		<span class="built_in">glColor3f</span>(<span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span>);<span class="comment">//颜色设置为青色  </span></span><br><span class="line">		<span class="built_in">glVertex3f</span>(<span class="number">50.0f</span>, <span class="number">50.0f</span>, <span class="number">-50.0f</span>);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glColor3f</span>(<span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>);<span class="comment">//颜色设置为绿色  </span></span><br><span class="line">		<span class="built_in">glVertex3f</span>(<span class="number">50.0f</span>, <span class="number">-50.0f</span>, <span class="number">-50.0f</span>);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glColor3f</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>);<span class="comment">//颜色设置为黑色  </span></span><br><span class="line">		<span class="built_in">glVertex3f</span>(<span class="number">-50.0f</span>, <span class="number">-50.0f</span>, <span class="number">-50.0f</span>);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glColor3f</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>);<span class="comment">//颜色设置为蓝色  </span></span><br><span class="line">		<span class="built_in">glVertex3f</span>(<span class="number">-50.0f</span>, <span class="number">50.0f</span>, <span class="number">-50.0f</span>);</span><br><span class="line">		<span class="built_in">glEnd</span>();</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glBegin</span>(GL_POLYGON); <span class="comment">//上表面  </span></span><br><span class="line">		<span class="built_in">glColor3d</span>(<span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>);<span class="comment">//颜色设置为青色  </span></span><br><span class="line">		<span class="built_in">glVertex3f</span>(<span class="number">50.0f</span>, <span class="number">50.0f</span>, <span class="number">-50.0f</span>);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glColor3d</span>(<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>);<span class="comment">//颜色设置为白色  </span></span><br><span class="line">		<span class="built_in">glVertex3f</span>(<span class="number">50.0f</span>, <span class="number">50.0f</span>, <span class="number">50.0f</span>);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glColor3d</span>(<span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>);<span class="comment">//颜色设置为品红色  </span></span><br><span class="line">		<span class="built_in">glVertex3f</span>(<span class="number">-50.0f</span>, <span class="number">50.0f</span>, <span class="number">50.0f</span>);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glColor3d</span>(<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>);<span class="comment">//颜色设置为蓝色  </span></span><br><span class="line">		<span class="built_in">glVertex3f</span>(<span class="number">-50.0f</span>, <span class="number">50.0f</span>, <span class="number">-50.0f</span>);</span><br><span class="line">		<span class="built_in">glEnd</span>();</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glBegin</span>(GL_POLYGON); <span class="comment">//下表面  </span></span><br><span class="line">		<span class="built_in">glColor3ub</span>(<span class="number">0u</span>, <span class="number">255u</span>, <span class="number">0u</span>);<span class="comment">//颜色设置为绿色  </span></span><br><span class="line">		<span class="built_in">glVertex3f</span>(<span class="number">50.0f</span>, <span class="number">-50.0f</span>, <span class="number">-50.0f</span>);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glColor3ub</span>(<span class="number">255u</span>, <span class="number">255u</span>, <span class="number">0u</span>);<span class="comment">//颜色设置为黄色  </span></span><br><span class="line">		<span class="built_in">glVertex3f</span>(<span class="number">50.0f</span>, <span class="number">-50.0f</span>, <span class="number">50.0f</span>);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glColor3ub</span>(<span class="number">255u</span>, <span class="number">0u</span>, <span class="number">0u</span>);<span class="comment">//颜色设置为红色  </span></span><br><span class="line">		<span class="built_in">glVertex3f</span>(<span class="number">-50.0f</span>, <span class="number">-50.0f</span>, <span class="number">50.0f</span>);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glColor3ub</span>(<span class="number">0u</span>, <span class="number">0u</span>, <span class="number">0u</span>);<span class="comment">//颜色设置为黑色  </span></span><br><span class="line">		<span class="built_in">glVertex3f</span>(<span class="number">-50.0f</span>, <span class="number">-50.0f</span>, <span class="number">-50.0f</span>);</span><br><span class="line">		<span class="built_in">glEnd</span>();</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glBegin</span>(GL_POLYGON); <span class="comment">//左表面  </span></span><br><span class="line">		<span class="built_in">glColor3ub</span>((GLubyte)<span class="number">255</span>, (GLubyte)<span class="number">255</span>, (GLubyte)<span class="number">255</span>);<span class="comment">//颜色设置为白色  </span></span><br><span class="line">		<span class="built_in">glVertex3f</span>(<span class="number">50.0f</span>, <span class="number">50.0f</span>, <span class="number">50.0f</span>);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glColor3ub</span>((GLubyte)<span class="number">0</span>, (GLubyte)<span class="number">255</span>, (GLubyte)<span class="number">255</span>);<span class="comment">//颜色设置为青色  </span></span><br><span class="line">		<span class="built_in">glVertex3f</span>(<span class="number">50.0f</span>, <span class="number">50.0f</span>, <span class="number">-50.0f</span>);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glColor3ub</span>((GLubyte)<span class="number">0</span>, (GLubyte)<span class="number">255</span>, (GLubyte)<span class="number">0</span>);<span class="comment">//颜色设置为绿色  </span></span><br><span class="line">		<span class="built_in">glVertex3f</span>(<span class="number">50.0f</span>, <span class="number">-50.0f</span>, <span class="number">-50.0f</span>);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glColor3ub</span>((GLubyte)<span class="number">255</span>, (GLubyte)<span class="number">255</span>, (GLubyte)<span class="number">0</span>);<span class="comment">//颜色设置为黄色  </span></span><br><span class="line">		<span class="built_in">glVertex3f</span>(<span class="number">50.0f</span>, <span class="number">-50.0f</span>, <span class="number">50.0f</span>);</span><br><span class="line">		<span class="built_in">glEnd</span>();</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glBegin</span>(GL_POLYGON); <span class="comment">//右表面  </span></span><br><span class="line">		<span class="built_in">glColor3f</span>(<span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>);<span class="comment">//颜色设置为品红色  </span></span><br><span class="line">		<span class="built_in">glVertex3f</span>(<span class="number">-50.0f</span>, <span class="number">50.0f</span>, <span class="number">50.0f</span>);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glColor3f</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>);<span class="comment">//颜色设置为蓝色  </span></span><br><span class="line">		<span class="built_in">glVertex3f</span>(<span class="number">-50.0f</span>, <span class="number">50.0f</span>, <span class="number">-50.0f</span>);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glColor3f</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>);<span class="comment">//颜色设置为黑色  </span></span><br><span class="line">		<span class="built_in">glVertex3f</span>(<span class="number">-50.0f</span>, <span class="number">-50.0f</span>, <span class="number">-50.0f</span>);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">glColor3f</span>(<span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>);<span class="comment">//颜色设置为红色  </span></span><br><span class="line">		<span class="built_in">glVertex3f</span>(<span class="number">-50.0f</span>, <span class="number">-50.0f</span>, <span class="number">50.0f</span>);</span><br><span class="line">		<span class="built_in">glEnd</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">glPopMatrix</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">opencvWithOpenGLTest</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	std::string openGLWindowName = <span class="string">&quot;OpenGL Test&quot;</span>;</span><br><span class="line">	cv::<span class="built_in">namedWindow</span>(openGLWindowName, cv::WINDOW_OPENGL);</span><br><span class="line">	cv::<span class="built_in">resizeWindow</span>(openGLWindowName, windowWidth, windowHeight);</span><br><span class="line">	cv::<span class="built_in">setOpenGlContext</span>(openGLWindowName);</span><br><span class="line">	cv::<span class="built_in">setOpenGlDrawCallback</span>(openGLWindowName, onDraw, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (cv::<span class="built_in">waitKey</span>(<span class="number">30</span>) != <span class="number">27</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		cv::<span class="built_in">updateWindow</span>(openGLWindowName);	<span class="comment">// when needed  </span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">opencvWithOpenGLTest</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>运行成功后可看到一个旋转的彩色立方体。</p>
<h2 id="结论">结论</h2>
<p>　　从实验结果来看，OpenCV 确实能支持 OpenGL 图形的显示，但其不足之处也很明显：没有提供鼠标和键盘的交互操作（可能是 Shaun 还没发现，毕竟只是尝试一下看它能不能显示），仅仅只是提供一个显示窗口。如果真想用 OpenGL 做一些好玩的东西，还是用 glut 和 glew 吧，不过 glut 已经停止更新许久，glew 在调试时可能会出现一些莫名其妙的错误，所以网上有人用 freeglut 代替 glut，glee 代替 glew，具体的东西 Shaun 也没试过，Shaun 目前还没做过 OpenGL 相关的事，这次用 OpenCV 显示 OpenGL 图形纯粹是为了好玩 (*^__^ *) 嘻嘻……。</p>
<h2 id="后记">后记</h2>
<p>　　本篇文档也是上次编译配置完 OpenCV-3.2 后做的一次小实验，但当时并没有记录，所以还有一些参考资料也已经不知道了 :-(。</p>
<h2 id="参考资料">参考资料</h2>
<p>[1] <a href="http://blog.csdn.net/yang_xian521/article/details/8531058">OpenCV学习笔记（六十一）——建立支持OpenGL的OpenCV工程“Master OpenCV”chp.3</a>（<a href="http://blog.csdn.net/yang_xian521/article/category/910716" class="uri">http://blog.csdn.net/yang_xian521/article/category/910716</a>）</p>
<p>[2] <a href="http://blog.csdn.net/bcbobo21cn/article/details/51058836">几个opengl立方体绘制案例</a>（<a href="http://blog.csdn.net/bcbobo21cn/article/category/3104565" class="uri">http://blog.csdn.net/bcbobo21cn/article/category/3104565</a>）</p>
]]></content>
      <categories>
        <category>Image&amp;Graphic</category>
      </categories>
      <tags>
        <tag>opencv</tag>
        <tag>cv</tag>
        <tag>opengl</tag>
        <tag>gl</tag>
      </tags>
  </entry>
  <entry>
    <title>搜索技巧</title>
    <url>/posts/982ff584.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　Shaun 一直以为自己的搜索能力还可以，基本上自己想要的东西都能搜到，但是自从接触到这个世界，才知道自己大概只是个入门的水平（或者说连入门都说不上 /つ∇T)），和网上的一些大神相比还有比较大的差距，此文只是网上一些资料的整理，方便 Shaun 熟练使用，提高驾驶技巧，毕竟信息检索能力还是很重要的。</p>
<span id="more"></span>
<h2 id="搜索篇">搜索篇</h2>
<p>Google 可以通过添加一些字符优化搜索结果，如：</p>
<table>
<colgroup>
<col style="width: 43%" />
<col style="width: 56%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">搜索需求</th>
<th style="text-align: center;">对应字符</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><strong>搜索社交媒体</strong></td>
<td style="text-align: center;">在用于搜索社交媒体的字词前加上 <code>@</code>。例如：<code>@twitter</code>。</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>从搜索结果中排除特定字词</strong></td>
<td style="text-align: center;">在您要排除的字词前加上 <code>-</code>。例如：<code>jaguar speed -car</code></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>搜索完全匹配的结果</strong></td>
<td style="text-align: center;">为字词或短语加上引号。例如：<code>"tallest building"</code>。</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>搜索通配符或未知字词</strong></td>
<td style="text-align: center;">在字词或短语中您要放置占位符的地方加上 <code>*</code>。例如：<code>"largest * in the world"</code>。</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>在某个数字范围内执行搜索</strong></td>
<td style="text-align: center;">在两个数字之间加上 <code>..</code>。例如：<code>camera $50..$100</code></td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>组合搜索</strong></td>
<td style="text-align: center;">在各个搜索查询之间加上“<code>OR</code>”。例如：<code>marathon OR race</code></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>搜索特定网站</strong></td>
<td style="text-align: center;">在相应网站或域名前加上“<code>site:</code>”。例如：<code>site:youtube.com</code>或 <code>site:.gov</code></td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>搜索相关网站</strong></td>
<td style="text-align: center;">在已知网址前加上“<code>related:</code>”。例如：<code>related:time.com</code></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>查找链接到某个特定网页的网页</strong></td>
<td style="text-align: center;">在已知网址前加上“<code>link:</code>”。例如：<code>link:chongbuluo.com</code>，就能查到哪些网页中包含链接<code>chongbuluo.com</code></td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>查找在URL地址里有搜索关键词的页面</strong></td>
<td style="text-align: center;">在已知网址前加上“<code>inurl:</code>”。例如：<code>inurl:chongbuluo</code>，就能查到哪些网页 url 中包含链接<code>chongbuluo</code></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>查找在网页标题里有搜索关键词的页面</strong></td>
<td style="text-align: center;">在已知网址前加上“<code>intitle:</code>”。例如：<code>intitle:chongbuluo</code>，就能查到哪些网页标题中包含链接<code>chongbuluo</code></td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>查找在网页正文里有搜索关键词的页面</strong></td>
<td style="text-align: center;">在已知网址前加上“<code>intext:</code>”。例如：<code>intext:chongbuluo</code>，就能查到哪些网页正文中包含链接<code>chongbuluo</code></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>查找pdf,xml,xls,txt,doc,csv等特定格式的结果</strong></td>
<td style="text-align: center;">在特定文件格式前加上<code>filetype:</code>。例如 <code>filetype:pdf</code></td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>查找关键词的定义</strong></td>
<td style="text-align: center;">在关键词前加上<code>define:</code>。例如 <code>define:搜索</code></td>
</tr>
</tbody>
</table>
<p>　　经 Shaun 实测，以上大部分字符对百度搜索引擎同样适用。当然，最好的搜索方式是使用高级搜索，高级搜索可以进行一系列设置，比如时间范围，从而使搜索结果更精确，更容易得到想要的结果，不过在不十分确定的时候，不要做太多限制，不然可能会过滤掉关键信息。</p>
<p>　　Google 和百度对英文字符大小写都不敏感，搜索 <strong>QQ</strong> 与 <strong>qq</strong> 所得到的结果是一样的。搜索是否成功最关键的地方还是在于关键词的选取，关键词的选取这没什么好说的，只能提高搜索熟练度及对问题的把握程度了。</p>
<p>　　哦，还有一点忘记说了，就是在 Google 中如果要搜索那个的话，必须要在搜索设置里面关闭安全搜索功能，如果简体中文不能关闭安全搜索功能的话，就在搜索设置里将语言更换到繁体中文或英语应该就能关闭安全搜索功能。</p>
<h2 id="技巧篇">技巧篇</h2>
<p>　　有时候第一个页面没有想要的结果，于是需要看第二个、第三个页面的结果，是不是觉得翻页很麻烦？（如果不觉得麻烦可以直接跳过🙄），但是设置增加搜索结果条目又会提高显示延迟，这时可以使用 <a href="https://greasyfork.org/zh-CN/scripts/10433-super-preloaderplus-one">Super_preloaderPlus_one</a> 脚本（Chrome 中可以使用 <a href="https://chrome.google.com/webstore/detail/autopagerize/igiofjhpmpihnifddepnpngfjhkfenbp?utm_source=chrome-app-launcher-info-dialog">AutoPagerize</a> 插件），只需鼠标继续往下滚轮就会自动加载下页搜索结果，无需点击翻页。</p>
<p>　　当点击网页链接却出现404错误或无法显示页面的错误时，这个时候可以使用搜索引擎的「网页快照」功能，Google的这个功能点击搜索结果页面标题下的 绿色小三角 即可看到，百度的这个叫 百度快照，在搜索结果 url 地址的末端，即结果最后面。快照功能最强大的是 <a href="https://archive.org/">互联网档案馆</a>（<strong>Internet Archive</strong>），又叫『网站时光倒流机器』（<strong>Wayback Machine</strong>），在知道链接的情况下，将链接输入到 <strong>Internet Archive</strong> 点击搜索就能查看历史快照了。</p>
<p>　　如果要查找某个网页出现的关键词，可以利用 Chrome 和 Firefox 的网页搜索功能，一般可以通过 <strong><code>Ctrl + F</code></strong> 去检索。也可以通过 <strong><code>F12</code></strong> 或「鼠标右键」（Firefox 点击「查看元素」，Chrome 点击「检查」，都是右键弹框最后一个选项）进入浏览器控制台开发工具，Chrome 中还要通过 <strong><code>Ctrl + F</code></strong> 才能检索元素，而 Firefox 可以直接搜索 HTML，输入要查找的关键词，回车即可。</p>
<h2 id="专项篇">专项篇</h2>
<p>　　<strong>图像搜索：</strong>这个一般用 Google 和百度的以图搜图就可以了，不过也有些特殊的图像搜索引擎，如 <a href="https://www.tineye.com/">TinEye</a> 等，当然，图像搜索最好还是安装相应的插件，在 Chrome 中可以安装一个叫 <a href="https://chrome.google.com/webstore/detail/noobox/kidibbfcblfbbafhnlanccjjdehoahep?utm_source=chrome-app-launcher-info-dialog">二箱</a> 的插件，在 Firefox 中可以安装一个叫 <a href="https://addons.mozilla.org/zh-CN/firefox/addon/search_by_image/?src=userprofile">Search by Image</a> 的插件。</p>
<p>　　<strong>音乐搜索：</strong>这个如果能听出歌词的话就直接去搜索引擎上搜听到的歌词，如果无法听出歌词的话，可以尝试各大音乐软件的「听歌识曲」功能。</p>
<p>　　当然更精确的专项搜索一般只存在于特定的网站，这就要看对整个互联网的了解程度了，这里强推「<a href="http://search.chongbuluo.com/">虫部落-快搜</a>」，不管是日常搜索需求还是特殊搜索需求基本都能满足。</p>
<h2 id="后记">后记</h2>
<p>　　尽量优先使用 Google，百度或许能找到自己想要的，但太浪费时间了，浪费时间就是浪费生命，不过能看到本文的看官，应该也是能熟练使用 Google 的了。</p>
<h2 id="参考资料">参考资料</h2>
<p>[1] <a href="https://support.google.com/websearch/answer/134479">如何在 Google 中进行搜索</a>(<a href="https://support.google.com/websearch/#topic=3081620" class="uri">https://support.google.com/websearch/#topic=3081620</a>)</p>
<p>[2] <a href="https://support.google.com/websearch/answer/2466433">优化网页搜索</a></p>
<p>[3] <a href="http://www.chongbuluo.com/forum.php?mod=viewthread&amp;tid=3041">提高搜索能力的关键技巧（如何查找可靠出处）</a></p>
<p>[4] <a href="http://www.chongbuluo.com/forum.php?mod=viewthread&amp;tid=1796">谷歌搜索技巧：搜索语法+隐藏彩蛋+高级设置</a></p>
]]></content>
      <categories>
        <category>Study</category>
      </categories>
      <tags>
        <tag>search</tag>
      </tags>
  </entry>
  <entry>
    <title>矩阵的应用之图像仿射变换</title>
    <url>/posts/e124baa1.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　好像很久没写新的东西了，主要是最近期末有一大堆事情要做，忙着写各种结课论文和复习数学，又加上最近忙着把《奥日与黑暗森林：终极版》剧情通关，这游戏不管是画面还是音乐都特别棒，但是对键盘用户太不友好了，不能改键位，需要一只手控制键盘，一只手控制鼠标，如果只是普通的键位就算了，它还要万恶的 shift 键配合，手残党完全吃不消 (´･ω･`)。最终死亡 658 次好歹剧情通关了，最后悔的是没把三段跳点出来 /つ∇T)。这些事情一搞完，Shaun 这不就又开始写了嘛（ 说什么也摆脱不了你拖延症晚期的事实 (￣ε(#￣)☆╰╮(￣▽￣///) ）。 选修的《数字图像处理》是也早结课了，虽然教的东西大都事前已经了解了，但是好像还没写过图像处理相关的 blog，所以谨以此篇最基础的 blog 来表示一下。</p>
<span id="more"></span>
<h2 id="预备篇">预备篇</h2>
<p>　　首先需要了解的是图像中坐标系和数学课本中常用的坐标系略有不同，图像中坐标系是以左上角为原点，水平向右为 X 轴，垂直向下为 Y 轴；而数学课本中常见的坐标系是以图像中心为原点，水平向右为 X 轴，垂直向上为 Y 轴。所以由图像中坐标 <span class="math inline">\((x,y)\)</span> 转数学课本中常见的坐标 <span class="math inline">\((x&#39;,y&#39;)\)</span> 的公式为 $x' = x - C/2; y' = -y + R/2; $ 其中 <span class="math inline">\(C\)</span> 表示原图像总列数，即原图像宽度，<span class="math inline">\(R\)</span> 表示原图像总行数，即原图像高度。</p>
<div style="text-align:center;font-weight:700;margin:.5em auto">
<svg width="346px" height="160px">
<defs><marker id="arrow" markerWidth="9" markerHeight="6" refx="0" refy="3" orient="auto" markerUnits="strokeWidth"><path d="M0,0 L0,6 L9,3 z" fill="#000" /></marker></defs><line x1="25" y1="62" x2="125" y2="62" stroke="#000" stroke-width="1" marker-end="url(#arrow)" /><line x1="75" y1="100" x2="75" y2="25" stroke="#000" stroke-width="1" marker-end="url(#arrow)" /><text x="126" y="56" fill="blue">X 轴</text><text x="75" y="20" fill="blue">Y 轴</text><line x1="210" y1="25" x2="310" y2="25" stroke="#000" stroke-width="1" marker-end="url(#arrow)" /><line x1="210" y1="25" x2="210" y2="100" stroke="#000" stroke-width="1" marker-end="url(#arrow)" /><text x="310" y="42" fill="blue">X 轴</text><text x="215" y="110" fill="blue">Y 轴</text><text x="40" y="150" fill="blue">数学坐标系</text><text x="240" y="150" fill="blue">图像坐标系</text>
</svg>
</div>
<p>　　<font color=#FA8072><strong>※注：</strong>值得注意的是因为 MATLAB 和 OpenCV 的像素索引坐标形式为 <strong><em>(行坐标，列坐标)</em></strong> ，所以若以本文这样定的图像坐标，则图像中坐标 <span class="math inline">\((x,y)\)</span> 对应的像素值为 <span class="math inline">\(f(y,x)\)</span>。</font></p>
<h2 id="变换篇">变换篇</h2>
<p>据 OpenCV 文档所说：</p>
<blockquote>
<ol type="1">
<li><p>一个任意的仿射变换都能表示为 <em>乘以一个矩阵</em> (线性变换) 接着再 <em>加上一个向量</em> (平移).</p></li>
<li><p>综上所述, 我们能够用仿射变换来表示:</p>
<ol type="1">
<li>旋转 (线性变换)</li>
<li>平移 (向量加)</li>
<li>缩放操作 (线性变换)</li>
</ol>
<p>你现在可以知道, 事实上, 仿射变换代表的是两幅图之间的 <strong>关系</strong> .</p></li>
<li><p>我们通常使用 <img src="http://www.opencv.org.cn/opencvdoc/2.3.2/html/_images/math/a832b76c4f4a4ec13ac1b557da4fed6006e64d00.png" alt="2 " /> 矩阵来表示仿射变换.</p>
<p><img src="http://www.opencv.org.cn/opencvdoc/2.3.2/html/_images/math/c3fdaa7031379552454b333ff916cd1987107b5c.png" alt="A = \begin{bmatrix}     a_{00} &amp; a_{01} \\     a_{10} &amp; a_{11}     \end{bmatrix}_{2 \times 2} B = \begin{bmatrix}     b_{00} \\     b_{10}     \end{bmatrix}_{2 \times 1} M = \begin{bmatrix}     A &amp; B     \end{bmatrix} =\begin{bmatrix}     a_{00} &amp; a_{01} &amp; b_{00} \\     a_{10} &amp; a_{11} &amp; b_{10}\end{bmatrix}_{2 \times 3}" />　　</p>
<p>考虑到我们要使用矩阵 <img src="http://www.opencv.org.cn/opencvdoc/2.3.2/html/_images/math/019e9892786e493964e145e7c5cf7b700314e53b.png" alt="A" /> 和 <img src="http://www.opencv.org.cn/opencvdoc/2.3.2/html/_images/math/ff5fb3d775862e2123b007eb4373ff6cc1a34d4e.png" alt="B" /> 对二维向量 <img src="http://www.opencv.org.cn/opencvdoc/2.3.2/html/_images/math/22671b2dfac15c46b634f068e4ccd644551abd8a.png" alt="X = \begin-{bmatrix}x \ y\end-{bmatrix}" /> 做变换, 所以也能表示为下列形式:</p>
<p><img src="http://www.opencv.org.cn/opencvdoc/2.3.2/html/_images/math/7b0b4b830b85f222266aa9c8fc76e1a7ce998c42.png" alt="T = A \begin-{bmatrix}x \ y\end-{bmatrix} + B" /> or <img src="http://www.opencv.org.cn/opencvdoc/2.3.2/html/_images/math/f44f98e19b4ee0613633b70414a47259846b2d27.png" alt="T = M ^{T}" /></p>
<p><img src="http://www.opencv.org.cn/opencvdoc/2.3.2/html/_images/math/3295a3e90f963d7a35c1cd910b9258cd92761a8f.png" alt="T=\begin-{bmatrix}a_{00}x + a_{01}y + b_{00} \ a_{10}x + a_{11}y + b_{10}\end-{bmatrix}" />　　</p></li>
</ol>
</blockquote>
<p>而在冈萨雷斯的《数字图像处理_第三版》里有：</p>
<blockquote>
<p>最常用的空间坐标变换之一是仿射变换，其一般形式如下： <span class="math display">\[ \begin{bmatrix} x &amp; y &amp; 1 \end{bmatrix} = \begin{bmatrix}  v &amp; w &amp; 1 \end{bmatrix} \textbf{T} = \begin{bmatrix}  v &amp; w &amp; 1 \end{bmatrix} \begin{bmatrix}   t_{11} &amp; t_{12} &amp; 0 \\  t_{21} &amp; t_{22} &amp; 0 \\  t_{31} &amp; t_{32} &amp; 1 \end{bmatrix} \]</span> 其中 <span class="math inline">\((v,w)\)</span> 为原坐标，<span class="math inline">\((x,y)\)</span> 为变换后的坐标，可根据变换矩阵 <span class="math inline">\(\textbf{T}\)</span> 中的元素选择的值，对一组坐标点做尺度、旋转、平移或偏移变换。一些常见的变换矩阵及作用如下表：</p>
<table>
<colgroup>
<col style="width: 16%" />
<col style="width: 41%" />
<col style="width: 41%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">变换名称</th>
<th style="text-align: center;">仿射变换矩阵<span class="math inline">\(\textbf{T}\)</span></th>
<th style="text-align: center;">坐标公式</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><strong>恒等变换</strong></td>
<td style="text-align: center;"><span class="math inline">\(\begin{bmatrix} 1 &amp; 0 &amp; 0 \\ 0 &amp; 1 &amp; 0 \\ 0 &amp; 0 &amp; 1 \end{bmatrix}\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\begin{cases} x=v , \\ y=w \end{cases}\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>尺度变换</strong></td>
<td style="text-align: center;"><span class="math inline">\(\begin{bmatrix} c_x &amp; 0 &amp; 0 \\ 0 &amp; c_y &amp; 0 \\ 0 &amp; 0 &amp; 1 \end{bmatrix}\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\begin{cases} x=vc_x , \\ y=wc_y \end{cases}\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>旋转变换</strong>（以逆时针为正）</td>
<td style="text-align: center;"><span class="math inline">\(\begin{bmatrix} cos(\theta) &amp; sin(\theta) &amp; 0 \\ -sin(\theta) &amp; cos(\theta) &amp; 0 \\ 0 &amp; 0 &amp; 1 \end{bmatrix}\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\begin{cases} x=vcos(\theta)-wsin(\theta) , \\ y=vsin(\theta)+wcos(\theta) \end{cases}\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>旋转变换</strong>（以顺时针为正）</td>
<td style="text-align: center;"><span class="math inline">\(\begin{bmatrix} cos(\theta) &amp; -sin(\theta) &amp; 0 \\ sin(\theta) &amp; cos(\theta) &amp; 0 \\ 0 &amp; 0 &amp; 1 \end{bmatrix}\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\begin{cases} x=vcos(\theta)+wsin(\theta) , \\ y=-vsin(\theta)+wcos(\theta) \end{cases}\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>平移变换</strong></td>
<td style="text-align: center;"><span class="math inline">\(\begin{bmatrix} 1 &amp; 0 &amp; 0 \\ 0 &amp; 1 &amp; 0 \\ t_x &amp; t_y &amp; 1 \end{bmatrix}\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\begin{cases} x=v+t_x , \\ y=w+t_y \end{cases}\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>偏移变换</strong>（水平）</td>
<td style="text-align: center;"><span class="math inline">\(\begin{bmatrix} 1 &amp; 0 &amp; 0 \\ s_h &amp; 1 &amp; 0 \\ 0 &amp; 0 &amp; 1 \end{bmatrix}\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\begin{cases} x=v+ws_h , \\ y=w \end{cases}\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>偏移变换</strong>（垂直）</td>
<td style="text-align: center;"><span class="math inline">\(\begin{bmatrix} 1 &amp; s_v &amp; 0 \\\ 0 &amp; 1 &amp; 0 \\ 0 &amp; 0 &amp; 1 \end{bmatrix}\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\begin{cases} x=v , \\ y=vs_v+w \end{cases}\)</span></td>
</tr>
</tbody>
</table>
<p>仿射变换的实现由两种方式：一种是 <strong><em>前向映射（Forward Mapping）</em></strong>：直接采用利用原图像坐标 <span class="math inline">\((v,w)\)</span> 通过 <span class="math inline">\(\begin{bmatrix} x &amp; y &amp; 1\end{bmatrix}=\begin{bmatrix} v &amp; w &amp; 1\end{bmatrix} \textbf{T}\)</span> 得到变换后的坐标 <span class="math inline">\((x,y)\)</span>，使用前向映射会导致一些问题：可能会有多个像素坐标映射到输出图像的同一位置，也可能输出图像的某些位置完全没有相应的输入图像像素与它匹配，也就是没有被映射到，造成有规律的空洞（黑色的花纹状）；更好的一种方式是采用 <strong><em>反向映射（Inverse Mapping）</em></strong>：扫描输出图像的位置 <span class="math inline">\((x,y)\)</span>，通过 <span class="math inline">\(\begin{bmatrix} v &amp; w &amp; 1\end{bmatrix}= \begin{bmatrix} x &amp; y &amp; 1\end{bmatrix}\textbf{T}^{-1}\)</span>（其中 <span class="math inline">\(\textbf{T}^{-1}\)</span> 为 <span class="math inline">\(\textbf{T}\)</span> 的逆矩阵）计算输入图像对应的位置 <span class="math inline">\((v,w)\)</span>，通过插值方法决定输出图像该位置的灰度值。</p>
</blockquote>
<p>　　<strong>本文这里采取冈萨雷斯的《数字图像处理_第三版》的变换矩阵方式</strong>，毕竟所学的矩阵论也是将变换矩阵放在后面作为第二个因子。虽然仿射变换都有现成的 API 可以调用，而且速度一般要比自己写的要快，但是知其然终究也要知其所以然。</p>
<p>　　<strong>下面就以旋转变换为例了</strong>，因为尺度变换和平移变换只需要相应的缩放图像即可，而旋转变换不仅需要更改图像大小，还要确定旋转中心，而旋转中心一般以图像中心为标准。</p>
<h3 id="旋转变换">旋转变换</h3>
<p>　　旋转变换首先需要确定旋转中心，若以图像左上角为旋转中心，则只需要像做尺度变换和平移变换那样通过 <span class="math inline">\(\begin{bmatrix} v &amp; w &amp; 1\end{bmatrix}= \begin{bmatrix} x &amp; y &amp; 1\end{bmatrix}\textbf{T}^{-1}\)</span> 做普通的变换即可。而以图像中心为旋转中心，首先需要做坐标变换，将以左上角为原点，水平向右为 X 轴，垂直向下为 Y 轴的图像坐标系转换为以图像中心为原点，水平向右为 X 轴，垂直向下为 Y 轴的数学坐标系；再做正常的旋转变换；随后再将数学坐标系转换为图像坐标系，所以图像中心为旋转中心的旋转变换总共需要做三次变换。这里就以图像中心为旋转中心为例，由于有三次变换，所以应该有三个变换矩阵相乘，设 图像坐标系==》数学坐标系的变换矩阵为 T1，旋转变换矩阵为 T2，数学坐标系==》图像坐标系的变换矩阵为 T3，设顺时针旋转角度为 <span class="math inline">\(\theta\)</span> ，原图像宽度为 <span class="math inline">\(C\)</span>，高度为 <span class="math inline">\(R\)</span>，旋转后图像宽度为 <span class="math inline">\(W\)</span>，高度为 <span class="math inline">\(H\)</span>，则： <span class="math display">\[
T1=\begin{bmatrix} 1 &amp; 0 &amp; 0 \\ 0 &amp; -1 &amp; 0 \\ -0.5C &amp; 0.5R &amp; 1 \end{bmatrix}　　
T2=\begin{bmatrix} cos(\theta) &amp; -sin(\theta) &amp; 0 \\ sin(\theta) &amp; cos(\theta) &amp; 0 \\ 0 &amp; 0 &amp; 1 \end{bmatrix}　　
T3=\begin{bmatrix} 1 &amp; 0 &amp; 0 \\ 0 &amp; -1 &amp; 0 \\ 0.5W &amp; 0.5H &amp; 1 \end{bmatrix}
\]</span> 则旋转变换最终形式为：<span class="math inline">\(\begin{bmatrix} x &amp; y &amp; 1 \end{bmatrix}=\begin{bmatrix} v &amp; w &amp; 1\end{bmatrix} \textbf{T}=\begin{bmatrix} v &amp; w &amp; 1 \end{bmatrix}T1*T2*T3\)</span>。</p>
<p><strong><em>※BTW：</em></strong>旋转变换中，旋转后图像宽度 <span class="math inline">\(W\)</span>，高度 <span class="math inline">\(H\)</span> 与 原图像宽度 <span class="math inline">\(C\)</span>，高度 <span class="math inline">\(R\)</span> 的关系为： <span class="math display">\[
\begin{cases} 
H = |R*cos(\theta)| + |C*sin(\theta)| , \\
W = |C*cos(\theta)| + |R*sin(\theta)| 
\end{cases}
\]</span></p>
<h2 id="插值篇">插值篇</h2>
<p>　　因为经过采用<strong>反向映射</strong><font color=#00f><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></font>方式的仿射变换之后，得到的原图像坐标 <span class="math inline">\((v,w)\)</span> 往往不是整数值，所以无法知道其对应的像素值 <span class="math inline">\(f(w,v)\)</span>，这时需要采取插值的方式近似估计该坐标位置的像素值。</p>
<p>　　常用的插值方法有最近邻插值（nearest neighbor interpolation）、双线性插值（bilinear interpolation）和双三次插值（bicubic interpolation），其中双三次插值在保持图像细节方面最好，但花费时间也最多，PS 中的消除锯齿和羽化效果好像就采用了双三次插值。</p>
<p>　　最近邻插值只考虑相邻最近的像素，双线性插值考虑相邻的 4 个像素点，双三次插值则考虑相邻的 16 个像素点。</p>
<h3 id="最近邻插值">最近邻插值</h3>
<p>　　最近邻插值最简单，将变换后图像的坐标 <span class="math inline">\((x,y)\)</span> 通过反向映射得到原图像坐标 <span class="math inline">\((v,w)\)</span> ，直接对 <span class="math inline">\((v,w)\)</span> 进行四舍五入得到相应的整数坐标 <span class="math inline">\((⌊v+0.5⌋,⌊w+0.5⌋)\)</span><font color=#00f><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></font>，用该整数坐标的像素值近似估计 <span class="math inline">\((v,w)\)</span> 的像素值，令 <span class="math inline">\(f(y,x)=f(⌊w+0.5⌋,⌊v+0.5⌋)\)</span> ，从而得到变换后图像每个像素点的像素值。</p>
<h3 id="双线性插值">双线性插值</h3>
<p>　　双线性插值是线性插值方法的一种扩展，它是 X 和 Y 两个方向上线性插值的组合。</p>
<div style="text-align:center;font-weight:700;margin:.5em auto">
<svg width="270px" height="230px">
<defs> <marker id="arrow" markerWidth="9" markerHeight="6" refx="0" refy="3" orient="auto" markerUnits="strokeWidth"> <path d="M0,0 L0,6 L9,3 z" fill="#000" /> </marker></defs><line x1="25" y1="25" x2="225" y2="25" stroke="#000" stroke-width="1" marker-end="url(#arrow)" /><line x1="25" y1="25" x2="25" y2="200" stroke="#000" stroke-width="1" marker-end="url(#arrow)" /><text x="230" y="42" fill="blue">X 轴</text><text x="30" y="210" fill="blue">Y 轴</text><circle cx="60" cy="60" r="3" stroke="black" stroke-width="1" fill="red" /><circle cx="160" cy="60" r="3" stroke="black" stroke-width="1" fill="red" /><circle cx="160" cy="160" r="3" stroke="black" stroke-width="1" fill="red" /><circle cx="60" cy="160" r="3" stroke="black" stroke-width="1" fill="red" /><text x="36" y="70" fill="blue">P1</text><text x="170" y="70" fill="blue">P2</text><text x="170" y="170" fill="blue">P3</text><text x="36" y="170" fill="blue">P4</text><circle cx="100" cy="60" r="3" stroke="black" stroke-width="1" fill="blue" /><circle cx="100" cy="160" r="3" stroke="black" stroke-width="1" fill="blue" /><text x="110" y="70" fill="blue">Z1</text><text x="110" y="170" fill="blue">Z2</text><circle cx="100" cy="100" r="3" stroke="black" stroke-width="1" fill="green" /><text x="110" y="110" fill="blue">P(v,w)</text><line x1="100" y1="25" x2="100" y2="160" style="stroke:rgb(0,0,0);stroke-width:1;stroke-dasharray:3;"/><line x1="25" y1="100" x2="100" y2="100" style="stroke:rgb(0,0,0);stroke-width:1;stroke-dasharray:3;"/><line x1="60" y1="25" x2="60" y2="160" style="stroke:rgb(0,0,0);stroke-width:1;stroke-dasharray:3;"/><line x1="160" y1="25" x2="160" y2="160" style="stroke:rgb(0,0,0);stroke-width:1;stroke-dasharray:3;"/><line x1="25" y1="60" x2="160" y2="60" style="stroke:rgb(0,0,0);stroke-width:1;stroke-dasharray:3;"/><line x1="25" y1="160" x2="160" y2="160" style="stroke:rgb(0,0,0);stroke-width:1;stroke-dasharray:3;"/>
</svg>
</div>
<p>如上图，设变换后图像的坐标 <span class="math inline">\((x,y)\)</span> 通过反向映射得到原图像坐标 <span class="math inline">\((v,w)\)</span> ，即点 <span class="math inline">\(P\)</span> 正好处于四个像素点 <span class="math inline">\(P1(v_0, w_0)\)</span>、<span class="math inline">\(P2(v_0+1, w_0)\)</span>、<span class="math inline">\(P3(v_0+1, w_0+1)\)</span>、<span class="math inline">\(P4(v_0, w_0+1)\)</span> 的中间，其中 <span class="math inline">\(v_0=⌊v⌋\)</span>，<span class="math inline">\(w_0=⌊w⌋\)</span> ，点 <span class="math inline">\(P\)</span> 对应的像素值为 <span class="math inline">\(f(P)\)</span> 因为双线性插值即在 <span class="math inline">\(X\)</span> 和 <span class="math inline">\(Y\)</span> 两个方向进行线性插值，首先计算 <span class="math inline">\(X\)</span> 方向的插值： <span class="math display">\[
\begin{cases} 
\frac{f(P2)-f(P1)}{P2.x-P1.x}=\frac{f(Z1)-f(P1)}{Z1.x-P1.x} , \\ 
\frac{f(P3)-f(P4)}{P3.x-P4.x}=\frac{f(Z2)-f(P4)}{Z2.x-P4.x}
\end{cases}
\]</span> 即： <span class="math display">\[
\begin{cases} 
f(Z1)=\frac{Z1.x-P1.x}{P2.x-P1.x}f(P2)+\frac{P2.x-Z1.x}{P2.x-P1.x}f(P1) =(v-v_0)f(P2)+(v_0+1-v)f(P1), \\ 
f(Z2)=\frac{Z2.x-P4.x}{P3.x-P4.x}f(P3)+\frac{P3.x-Z2.x}{P3.x-P4.x}f(P4) =(v-v_0)f(P3)+(v_0+1-v)f(P4)
\end{cases}\tag{1}
\]</span> 然后计算 <span class="math inline">\(Y\)</span> 方向的插值： <span class="math display">\[
\begin{equation} 
\frac{f(Z2)-f(Z1)}{Z2.y-Z1.y}=\frac{f(P)-f(Z1)}{P.y-Z1.y} 
\end{equation}
\]</span> 即： <span class="math display">\[
\begin{equation} 
f(P)=\frac{P.y-Z1.y}{Z2.y-Z1.y}f(Z2)+\frac{Z2.y-P.y}{Z2.y-Z1.y}f(Z1) =(w-w_0)f(Z2)+(w_0+1-w)f(Z1)
\end{equation}\tag{2}
\]</span> 结合式（1）和式（2）可得： <span class="math display">\[
\begin{equation} 
f(P)=(v_0+1-v)(w_0+1-w)f(P1)+(v-v_0)(w_0+1-w)f(P2)+(v-v_0)(w-w_0)f(P3)+(v_0+1-v)(w-w_0)f(P4)
\end{equation}
\]</span> 用矩阵形式可表示为： <span class="math display">\[
f(P)=\begin{bmatrix} v_0+1-v &amp; v-v_0 \end{bmatrix} 
\begin{bmatrix} f(P1) &amp; f(P4)  \\ f(P2)  &amp; f(P3)  \end{bmatrix} 
\begin{bmatrix} (w_0+1-w) \\ (w-w_0) \end{bmatrix}
\]</span> 即： <span class="math display">\[
f(y,x)=f(w,v)=\begin{bmatrix} ⌊v⌋+1-v &amp; v-⌊v⌋ \end{bmatrix} 
\begin{bmatrix} f(⌊w⌋,⌊v⌋) &amp; f(⌊w⌋+1,⌊v⌋)  \\ f(⌊w⌋,⌊v⌋+1)  &amp; f(⌊w⌋+1,⌊v⌋+1)  \end{bmatrix} 
\begin{bmatrix} (⌊w⌋+1-w) \\ (w-⌊w⌋) \end{bmatrix}
\]</span></p>
<h3 id="双三次插值">双三次插值</h3>
<div style="text-align:center;font-weight:700;margin:.5em auto">
<svg width="270px" height="230px">
<defs> <marker id="arrow" markerWidth="9" markerHeight="6" refx="0" refy="3" orient="auto" markerUnits="strokeWidth"> <path d="M0,0 L0,6 L9,3 z" fill="#000" /> </marker></defs><line x1="25" y1="25" x2="225" y2="25" stroke="#000" stroke-width="1" marker-end="url(#arrow)" /><line x1="25" y1="25" x2="25" y2="200" stroke="#000" stroke-width="1" marker-end="url(#arrow)" /><text x="230" y="42" fill="blue">X 轴</text><text x="30" y="210" fill="blue">Y 轴</text><line x1="55" y1="25" x2="55" y2="175" style="stroke:rgb(0,0,0);stroke-width:1;stroke-dasharray:3;"/><line x1="85" y1="25" x2="85" y2="175" style="stroke:rgb(0,0,0);stroke-width:1;stroke-dasharray:3;"/><line x1="115" y1="25" x2="115" y2="175" style="stroke:rgb(0,0,0);stroke-width:1;stroke-dasharray:3;"/><line x1="145" y1="25" x2="145" y2="175" style="stroke:rgb(0,0,0);stroke-width:1;stroke-dasharray:3;"/><line x1="175" y1="25" x2="175" y2="176" style="stroke:rgb(0,0,0);stroke-width:1;stroke-dasharray:3;"/><line x1="25" y1="55" x2="175" y2="55" style="stroke:rgb(0,0,0);stroke-width:1;stroke-dasharray:3;"/><line x1="25" y1="85" x2="175" y2="85" style="stroke:rgb(0,0,0);stroke-width:1;stroke-dasharray:3;"/><line x1="25" y1="115" x2="175" y2="115" style="stroke:rgb(0,0,0);stroke-width:1;stroke-dasharray:3;"/><line x1="25" y1="145" x2="175" y2="145" style="stroke:rgb(0,0,0);stroke-width:1;stroke-dasharray:3;"/><line x1="25" y1="175" x2="176" y2="175" style="stroke:rgb(0,0,0);stroke-width:1;stroke-dasharray:3;"/><circle cx="55" cy="55" r="3" stroke="black" stroke-width="1" fill="red" /><circle cx="85" cy="55" r="3" stroke="black" stroke-width="1" fill="red" /><circle cx="115" cy="55" r="3" stroke="black" stroke-width="1" fill="red" /><circle cx="145" cy="55" r="3" stroke="black" stroke-width="1" fill="red" /><circle cx="55" cy="85" r="3" stroke="black" stroke-width="1" fill="red" /><circle cx="85" cy="85" r="3" stroke="black" stroke-width="1" fill="red" /><circle cx="115" cy="85" r="3" stroke="black" stroke-width="1" fill="red" /><circle cx="145" cy="85" r="3" stroke="black" stroke-width="1" fill="red" /><circle cx="55" cy="115" r="3" stroke="black" stroke-width="1" fill="red" /><circle cx="85" cy="115" r="3" stroke="black" stroke-width="1" fill="red" /><circle cx="115" cy="115" r="3" stroke="black" stroke-width="1" fill="red" /><circle cx="145" cy="115" r="3" stroke="black" stroke-width="1" fill="red" /><circle cx="55" cy="145" r="3" stroke="black" stroke-width="1" fill="red" /><circle cx="85" cy="145" r="3" stroke="black" stroke-width="1" fill="red" /><circle cx="115" cy="145" r="3" stroke="black" stroke-width="1" fill="red" /><circle cx="145" cy="145" r="3" stroke="black" stroke-width="1" fill="red" /><text x="77" y="85" fill="blue">P11</text><circle cx="100" cy="100" r="3" stroke="black" stroke-width="1" fill="green" /><text x="110" y="110" fill="blue">P(v,w)</text>
</svg>
</div>
<p>　　如上图，双三次插值需要考虑相邻16个像素（4×4），用双三次插值重采样的图像更平滑并且更能保留图像细节，在这三种插值算法中，双三次插值效果最好，但处理速度最慢。同样设变换后图像的坐标 <span class="math inline">\((x,y)​\)</span> 通过反向映射得到原图像坐标 <span class="math inline">\((v,w)​\)</span> ，与其左上角相邻最近的 点P11 坐标则为 <span class="math inline">\((⌊v⌋,⌊w⌋)​\)</span> ，该插值方法需要选取一个合适的插值基函数，参照维基百科 <strong>Bicubic interpolation</strong> 的一般为： <span class="math display">\[
W(x) = 
\begin{cases}
 (a+2)|x|^3-(a+3)|x|^2+1 &amp; \text{for } |x| \leq 1, \\
 a|x|^3-5a|x|^2+8a|x|-4a &amp; \text{for } 1 &lt; |x| &lt; 2, \\
 0                       &amp; \text{otherwise},
\end{cases}
\]</span> 其中 <span class="math inline">\(a\)</span> 一般取 -0.5 、-0.75 或 -1；则：<span class="math inline">\(f(y,x)=f(w,v)=A*B*C\)</span> ，其中： <span class="math display">\[
A=\begin{bmatrix} W( v-(⌊v⌋-1) ) &amp; W(v-⌊v⌋) &amp; W( (⌊v⌋+1)-v ) &amp; W( (⌊v⌋+2)-v ) \end{bmatrix} \\
B=\begin{bmatrix} 
f(⌊w⌋-1,⌊v⌋-1) &amp; f(⌊w⌋,⌊v⌋-1) &amp; f(⌊w⌋+1,⌊v⌋-1) &amp; f(⌊w⌋+2,⌊v⌋-1) \\ 
f(⌊w⌋-1,⌊v⌋) &amp; f(⌊w⌋,⌊v⌋) &amp; f(⌊w⌋+1,⌊v⌋) &amp; f(⌊w⌋+2,⌊v⌋) \\ 
f(⌊w⌋-1,⌊v⌋+1) &amp; f(⌊w⌋,⌊v⌋+1) &amp; f(⌊w⌋+1,⌊v⌋+1) &amp; f(⌊w⌋+2,⌊v⌋+1) \\ 
f(⌊w⌋-1,⌊v⌋+2) &amp; f(⌊w⌋,⌊v⌋+2) &amp; f(⌊w⌋+1,⌊v⌋+2) &amp; f(⌊w⌋+2,⌊v⌋+2)
\end{bmatrix} \\
C=\begin{bmatrix} W( w-(⌊w⌋-1) ) \\ W(w-⌊w⌋) \\ W( (⌊w⌋+1)-w ) \\ W( (⌊w⌋+2)-w ) \end{bmatrix}
\]</span></p>
<p>即： <span class="math display">\[
f(y,x)=f(w,v)= \sum\limits_{row=-1}^2\sum\limits_{col=-1}^2f(⌊w⌋+row,⌊v⌋+col)W(row-(w-⌊w⌋))W(col-(v-⌊v⌋))
\]</span> <strong>另附：</strong>网上也有人中间那个矩阵 <span class="math inline">\(B\)</span> 是本文中间矩阵 <span class="math inline">\(B\)</span> 的转置，经过下文实践，感觉效果差不多，但从理论上来说，应该本文这样写才是对的吧🤔。</p>
<h3 id="lanczos-插值">Lanczos 插值</h3>
<p>　　Lanczos 插值和双三次插值本质上差不多，不同的是插值权重基函数不一样，Lanczos 插值算法的基函数为： <span class="math display">\[
L(x) = 
\begin{cases}
1 &amp; \text{for } x = 0, \\
a*sin(\pi x)sin(\pi x/a)/(\pi x)^2 &amp; \text{for } 0 &lt; |x| \leq a, \\
 0                       &amp; \text{otherwise},
\end{cases}
\]</span> 其中 a 代表插值窗口半径，若 a = 2，则代表取周围 4×4 邻域像素点进行插值，和双三次插值除权重不一样外其它都一样，此时适用于对图像下采样（缩小），若 a = 3，则代表取周围 9×9 邻域像素点进行插值，此时适用于对图像上采样（放大），OpenCV 的 <code>INTER_LANCZOS4</code> 插值参数就代表取周围 8×8 邻域的像素点进行插值。</p>
<h2 id="实践篇">实践篇</h2>
<p>　　本次实践采用 Matlab R2016b，具体 matlab 实现代码为：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="MATLAB"><div class="code-copy"></div><figure class="highlight hljs matlab"><table><tr><td class="code"><pre><span class="line">clc;clear;close all;</span><br><span class="line"></span><br><span class="line">img = imread(<span class="string">&#x27;lena_gray.jpg&#x27;</span>); <span class="comment">% 读取图像</span></span><br><span class="line">[R, C] = <span class="built_in">size</span>(img); <span class="comment">% 获取图像大小</span></span><br><span class="line"></span><br><span class="line">theta = <span class="number">45</span> * <span class="built_in">pi</span> / <span class="number">180.0</span>; <span class="comment">% 旋转角度</span></span><br><span class="line">H = <span class="built_in">ceil</span>(<span class="built_in">abs</span>(R*<span class="built_in">cos</span>(theta)) + <span class="built_in">abs</span>(C*<span class="built_in">sin</span>(theta)));    <span class="comment">% 变换后图像的高度</span></span><br><span class="line">W = <span class="built_in">ceil</span>(<span class="built_in">abs</span>(C*<span class="built_in">cos</span>(theta)) + <span class="built_in">abs</span>(R*<span class="built_in">sin</span>(theta)));    <span class="comment">% 变换后图像的宽度</span></span><br><span class="line">res = <span class="built_in">zeros</span>(H, W);   <span class="comment">% 构造结果矩阵。每个像素点默认初始化为0（黑色）</span></span><br><span class="line"></span><br><span class="line">T1 = [<span class="number">1</span> <span class="number">0</span> <span class="number">0</span>; <span class="number">0</span> <span class="number">-1</span> <span class="number">0</span>; <span class="number">-0.5</span>*C <span class="number">0.5</span>*R <span class="number">1</span>];   <span class="comment">% 将原图像坐标映射到数学笛卡尔坐标</span></span><br><span class="line">T2 = [<span class="built_in">cos</span>(theta) -<span class="built_in">sin</span>(theta) <span class="number">0</span>; <span class="built_in">sin</span>(theta) <span class="built_in">cos</span>(theta) <span class="number">0</span>; <span class="number">0</span> <span class="number">0</span> <span class="number">1</span>];    <span class="comment">% 数学笛卡尔坐标下顺时针旋转的变换矩阵</span></span><br><span class="line">T3 = [<span class="number">1</span> <span class="number">0</span> <span class="number">0</span>; <span class="number">0</span> <span class="number">-1</span> <span class="number">0</span>; <span class="number">0.5</span>*W <span class="number">0.5</span>*H <span class="number">1</span>];    <span class="comment">% 将数学笛卡尔坐标映射到旋转后的图像坐标</span></span><br><span class="line">T = T1*T2*T3;</span><br><span class="line">inv_T = inv(T);    <span class="comment">% 求逆矩阵</span></span><br><span class="line"><span class="comment">% inv_T = [cos(theta) -sin(theta) 0; sin(theta) cos(theta) 0; -0.5*W*cos(theta)-0.5*H*sin(theta)+0.5*C 0.5*W*sin(theta)-0.5*H*cos(theta)+0.5*R 1];</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> y = <span class="number">1</span> : H   <span class="comment">% 变换后图像的纵坐标，行，高</span></span><br><span class="line">    <span class="keyword">for</span> x = <span class="number">1</span> : W   <span class="comment">% 变换后图像的横坐标，列，宽</span></span><br><span class="line">        original_coordinate = [x y <span class="number">1</span>] * inv_T; <span class="comment">% 矩阵乘法</span></span><br><span class="line">        v = original_coordinate(<span class="number">1</span>);    <span class="comment">% 原图像的横坐标，列，宽</span></span><br><span class="line">        w = original_coordinate(<span class="number">2</span>);    <span class="comment">% 原图像的纵坐标，行，高</span></span><br><span class="line">        <span class="comment">% 变换后的位置判断是否越界</span></span><br><span class="line">        <span class="keyword">if</span> v&gt;=<span class="number">1</span> &amp;&amp; w&gt;=<span class="number">1</span> &amp;&amp; v&lt;=C &amp;&amp; w&lt;=R</span><br><span class="line">            res(y, x) = img(<span class="built_in">round</span>(w), <span class="built_in">round</span>(v));  <span class="comment">% 用原图像对应坐标的像素值填充变换后的图像（最邻近插值）</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">% ------------- 双线性插值（bilinear interpolation）-----------------</span></span><br><span class="line">            left = <span class="built_in">floor</span>(v); right = <span class="built_in">ceil</span>(v); top = <span class="built_in">floor</span>(w); bottom = <span class="built_in">ceil</span>(w);</span><br><span class="line">            dC = v-left;   <span class="comment">% 列偏差</span></span><br><span class="line">            dR = w-top;    <span class="comment">% 行偏差</span></span><br><span class="line">            res(y, x) = (<span class="number">1</span>-dC)*(<span class="number">1</span>-dR)*img(top, left) + dC*(<span class="number">1</span>-dR)*img(top,right) + (<span class="number">1</span>-dC)*dR*img(bottom, left) + dC*dR*img(bottom, right); </span><br><span class="line">            </span><br><span class="line">            <span class="comment">% ------------- 双三次插值（bicubic interpolation） -------------------------</span></span><br><span class="line">        <span class="keyword">if</span> left&gt;=<span class="number">2</span> &amp;&amp; top&gt;=<span class="number">2</span> &amp;&amp; left&lt;=(C<span class="number">-2</span>) &amp;&amp; top&lt;=(R<span class="number">-2</span>)</span><br><span class="line">            img = double(img);</span><br><span class="line">            MA = [bicubic(<span class="number">1</span>+dC) bicubic(dC) bicubic(<span class="number">1</span>-dC) bicubic(<span class="number">2</span>-dC)];</span><br><span class="line">            MB = [img(top<span class="number">-1</span>,left<span class="number">-1</span>) img(top,left<span class="number">-1</span>) img(top+<span class="number">1</span>,left<span class="number">-1</span>) img(top+<span class="number">2</span>,left<span class="number">-1</span>);</span><br><span class="line">                 img(top<span class="number">-1</span>,left) img(top,left) img(top+<span class="number">1</span>,left) img(top+<span class="number">2</span>,left);</span><br><span class="line">                 img(top<span class="number">-1</span>,left+<span class="number">1</span>) img(top,left+<span class="number">1</span>) img(top+<span class="number">1</span>,left+<span class="number">1</span>) img(top+<span class="number">2</span>,left+<span class="number">1</span>);</span><br><span class="line">                 img(top<span class="number">-1</span>,left+<span class="number">2</span>) img(top,left+<span class="number">2</span>) img(top+<span class="number">1</span>,left+<span class="number">2</span>) img(top+<span class="number">2</span>,left+<span class="number">2</span>)];</span><br><span class="line">            <span class="comment">% MB = MB&#x27;;    % 求转置矩阵</span></span><br><span class="line">            MC = [bicubic(<span class="number">1</span>+dR); bicubic(dR); bicubic(<span class="number">1</span>-dR); bicubic(<span class="number">2</span>-dR)];</span><br><span class="line">            res(y, x) = MA*MB*MC;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">figure</span>, imshow(uint8(res)); <span class="comment">% 显示图像</span></span><br></pre></td></tr></table></figure></div>
<p>BiCubic 基函数 Matlab 代码为：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="MATLAB"><div class="code-copy"></div><figure class="highlight hljs matlab"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">W</span> = <span class="title">bicubic</span><span class="params">(x)</span></span></span><br><span class="line"><span class="comment">%bicubic 双三次插值基函数</span></span><br><span class="line">a = <span class="number">-1</span>; <span class="comment">% 默认取a为-1</span></span><br><span class="line">x1 = <span class="built_in">abs</span>(x);</span><br><span class="line">x2 = x1*x1;</span><br><span class="line">x3 = x1*x2; </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> x1 &lt;= <span class="number">1</span></span><br><span class="line">   W = <span class="number">1</span> - (a+<span class="number">3</span>)*x2 + (a+<span class="number">2</span>)*x3;</span><br><span class="line"><span class="keyword">elseif</span> x1&gt;<span class="number">1</span> &amp;&amp; x1&lt;=<span class="number">2</span></span><br><span class="line">   W = <span class="number">-4</span>*a + <span class="number">8</span>*a*x1 - <span class="number">5</span>*a*x2 + a*x3;</span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line">   W = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></div>
<p>　　旋转变换中感觉插值的作用没体现出来，以肉眼来看感觉三种插值方法的效果差不多，可能是 Shaun 选取的示例不好，为了体现插值效果，应该采用尺度变换（缩放变换）的。以上代码改为尺度变换也简单，自定义图像缩放后的宽高，以两倍为例，<code>H = R * 2; W = C * 2;</code>，再将旋转变换矩阵改为尺度变换矩阵，尺度变换矩阵中 <span class="math inline">\(c_x=W/C；c_y=H/R\)</span>。</p>
<p>为了便于理解，Shaun 对代码就不进行优化了（其实是你懒吧 _(:з」∠)_）。</p>
<h2 id="后记">后记</h2>
<p>　　本文算是数字图像处理中最基础的知识了，但 Shaun 在写时还是查阅了大量相关的资料，有些地方理解的还不是很透彻，行文思路有点混乱 ╮(╯▽╰)╭。本来是不想使用图片的，但本文不用图片很难理解清楚，又为了不使用外部图，最后只得参考 <a href="http://www.runoob.com/svg/svg-tutorial.html">SVG 教程</a> 和 <a href="https://www.w3cplus.com/svg/svg-markers.html">如何创建SVG箭头和polymarker——<code>marker</code>元素</a> 采用 SVG 绘制相应图片了。等有时间再把用 OpenCV 实现的 C++ 代码也贴上吧。最后再感叹一下 Matlab 确实是做科研的好工具（°Д°）Ъ，<del>吐槽一下 <em>MathJax</em> 排版好痛苦啊，太多需要转义符<code>\</code>的地方了吧。</del>，搞错了 Σ(ﾟдﾟ;)，这主要和 markdown 渲染有关，hexo 默认的 markdown 渲染插件 hexo-renderer-marked 太普通了，有些东西根本没办法渲染或者渲染有问题 （╯‵□′）╯︵┴─┴，Shaun 最后决定使用 hexo-renderer-pandoc 插件渲染 markdown，这样就完美了 (๑•̀ㅂ•́)و✧ 。</p>
<p>　　至于具体怎么使用 hexo-renderer-pandoc 替换默认的渲染器可参考：<a href="https://www.v2ex.com/t/410080">如何禁止 hexo 在 html 代码里插入&lt;br&gt;标签?</a>。具体如下：</p>
<blockquote>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1、安装 Pandoc，可以不顺带安装 MiKTex</span></span><br><span class="line"><span class="comment"># 2、卸载默认渲染器</span></span><br><span class="line">npm uninstall hexo-renderer-marked --save</span><br><span class="line"><span class="comment"># 3、安装 hexo-renderer-pandoc</span></span><br><span class="line">npm install hexo-renderer-pandoc --save</span><br></pre></td></tr></table></figure></div>
</blockquote>
<h2 id="附录">附录</h2>
<p>　　挖的坑总是要填的，呐，这就是用 OpenCV 实现的旋转变换，实现语言为 C++ ：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/opencv.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> M_PI       3.14159265358979323846</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">bicubic</span><span class="params">(<span class="keyword">double</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// bicubic 双三次插值基函数</span></span><br><span class="line">	<span class="keyword">int</span> a = <span class="number">-1</span>;	<span class="comment">// 默认取a为 - 1</span></span><br><span class="line">	<span class="keyword">double</span> x1 = <span class="built_in">fabs</span>(x);</span><br><span class="line">	<span class="keyword">double</span> x2 = x1*x1;</span><br><span class="line">	<span class="keyword">double</span> x3 = x1*x2;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (x1 &lt;= <span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span> - (a + <span class="number">3</span>)*x2 + (a + <span class="number">2</span>)*x3;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (x1 &gt; <span class="number">1</span> &amp;&amp; x1 &lt;= <span class="number">2</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-4</span> * a + <span class="number">8</span> * a*x1 - <span class="number">5</span> * a*x2 + a*x3;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	cv::Mat img = cv::<span class="built_in">imread</span>(<span class="string">&quot;../Data/lena_gray.jpg&quot;</span>, <span class="number">0</span>);	<span class="comment">// 以灰度模式读取图片</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> R = img.rows;	<span class="comment">// 获取原图像高度</span></span><br><span class="line">	<span class="keyword">int</span> C = img.cols;	<span class="comment">// 获取原图像宽度</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">double</span> theta = <span class="number">45</span> * M_PI / <span class="number">180.0</span>;	<span class="comment">// 旋转角度</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> H = <span class="built_in">ceil</span>(<span class="built_in">fabs</span>(R*<span class="built_in">cos</span>(theta)) + <span class="built_in">fabs</span>(C*<span class="built_in">sin</span>(theta)));	<span class="comment">// 变换后图像的高度</span></span><br><span class="line">	<span class="keyword">int</span> W = <span class="built_in">ceil</span>(<span class="built_in">fabs</span>(C*<span class="built_in">cos</span>(theta)) + <span class="built_in">fabs</span>(R*<span class="built_in">sin</span>(theta)));	<span class="comment">// 变换后图像的宽度</span></span><br><span class="line"></span><br><span class="line">	cv::Mat res = cv::Mat::<span class="built_in">zeros</span>(H, W, CV_8UC1);	<span class="comment">// 构造结果矩阵。每个像素点默认初始化为0（黑色）	</span></span><br><span class="line"></span><br><span class="line">	cv::Mat T1 = (cv::Mat_&lt;<span class="keyword">double</span>&gt;(<span class="number">3</span>, <span class="number">3</span>) &lt;&lt; <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">-1</span>, <span class="number">0</span>, <span class="number">-0.5</span>*C, <span class="number">0.5</span>*R, <span class="number">1</span>);	<span class="comment">// 将原图像坐标映射到数学笛卡尔坐标</span></span><br><span class="line">	cv::Mat T2 = (cv::Mat_&lt;<span class="keyword">double</span>&gt;(<span class="number">3</span>, <span class="number">3</span>) &lt;&lt; <span class="built_in">cos</span>(theta), -<span class="built_in">sin</span>(theta), <span class="number">0</span>, <span class="built_in">sin</span>(theta), <span class="built_in">cos</span>(theta), <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>);	<span class="comment">// 数学笛卡尔坐标下顺时针旋转的变换矩阵</span></span><br><span class="line">	<span class="keyword">double</span> t3[<span class="number">3</span>][<span class="number">3</span>] = &#123; &#123; <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span> &#125;, &#123; <span class="number">0</span>, <span class="number">-1</span>, <span class="number">0</span> &#125;, &#123; <span class="number">0.5</span>*W, <span class="number">0.5</span>*H, <span class="number">1</span> &#125; &#125;;	<span class="comment">// 将数学笛卡尔坐标映射到旋转后的图像坐标</span></span><br><span class="line">	cv::Mat T3 = cv::<span class="built_in">Mat</span>(<span class="number">3</span>, <span class="number">3</span>, CV_64FC1, t3);</span><br><span class="line">	cv::Mat T = T1*T2*T3;</span><br><span class="line">	cv::Mat inv_T = T.<span class="built_in">inv</span>();	<span class="comment">// 求逆矩阵</span></span><br><span class="line">	<span class="comment">//cv::Mat inv_T = (cv::Mat_&lt;double&gt;(3, 3) &lt;&lt; cos(theta), -sin(theta), 0, sin(theta), cos(theta), 0, -0.5*W*cos(theta) - 0.5*H*sin(theta) + 0.5*C, 0.5*W*sin(theta) - 0.5*H*cos(theta) + 0.5*R, 1);</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; H; y++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; W; x++)</span><br><span class="line">		&#123;</span><br><span class="line">			cv::Mat point = (cv::Mat_&lt;<span class="keyword">double</span>&gt;(<span class="number">1</span>, <span class="number">3</span>) &lt;&lt; x, y, <span class="number">1</span>);</span><br><span class="line">			cv::Mat original_coordinate = point * inv_T;	<span class="comment">// 矩阵乘法</span></span><br><span class="line">			<span class="keyword">double</span> v = original_coordinate.at&lt;<span class="keyword">double</span>&gt;(<span class="number">0</span>, <span class="number">0</span>);	<span class="comment">// 原图像的横坐标，列，宽</span></span><br><span class="line">			<span class="keyword">double</span> w = original_coordinate.at&lt;<span class="keyword">double</span>&gt;(<span class="number">0</span>, <span class="number">1</span>);	<span class="comment">// 原图像的纵坐标，行，高</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">// 变换后的位置判断是否越界</span></span><br><span class="line">			<span class="keyword">if</span> (v &gt;= <span class="number">0</span> &amp;&amp; w &gt;= <span class="number">0</span> &amp;&amp; v &lt;= C - <span class="number">1</span> &amp;&amp; w &lt;= R - <span class="number">1</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				res.at&lt;uchar&gt;(y, x) = img.at&lt;uchar&gt;(<span class="built_in">round</span>(w), <span class="built_in">round</span>(v));	<span class="comment">// 用原图像对应坐标的像素值填充变换后的图像（最邻近插值）</span></span><br><span class="line">				</span><br><span class="line">				<span class="comment">// ------------ - 双线性插值（bilinear interpolation）---------------- -</span></span><br><span class="line">				<span class="keyword">int</span> left = <span class="built_in">floor</span>(v), right = <span class="built_in">ceil</span>(v), top = <span class="built_in">floor</span>(w), bottom = <span class="built_in">ceil</span>(w);</span><br><span class="line">				<span class="keyword">double</span> dC = v - left;	<span class="comment">// 列偏差</span></span><br><span class="line">				<span class="keyword">double</span> dR = w - top;	<span class="comment">// 行偏差</span></span><br><span class="line">				res.at&lt;uchar&gt;(y, x) = (<span class="number">1</span> - dC)*(<span class="number">1</span> - dR)*img.at&lt;uchar&gt;(top, left) + dC*(<span class="number">1</span> - dR)*img.at&lt;uchar&gt;(top, right) + (<span class="number">1</span> - dC)*dR*img.at&lt;uchar&gt;(bottom, left) + dC*dR*img.at&lt;uchar&gt;(bottom, right);</span><br><span class="line">			</span><br><span class="line">				<span class="comment">// ------------ - 双三次插值（bicubic interpolation）------------------------ -</span></span><br><span class="line">				<span class="keyword">if</span> (left &gt;= <span class="number">1</span> &amp;&amp; top &gt;= <span class="number">1</span> &amp;&amp; left &lt;= (C - <span class="number">3</span>) &amp;&amp; top &lt;= (R - <span class="number">3</span>))</span><br><span class="line">				&#123;</span><br><span class="line">					cv::Mat MA = (cv::Mat_&lt;<span class="keyword">double</span>&gt;(<span class="number">1</span>, <span class="number">4</span>) &lt;&lt; <span class="built_in">bicubic</span>(<span class="number">1</span> + dC), <span class="built_in">bicubic</span>(dC), <span class="built_in">bicubic</span>(<span class="number">1</span> - dC), <span class="built_in">bicubic</span>(<span class="number">2</span> - dC));</span><br><span class="line">					cv::Mat MB = <span class="built_in">img</span>(cv::<span class="built_in">Rect</span>(left - <span class="number">1</span>, top - <span class="number">1</span>, <span class="number">4</span>, <span class="number">4</span>));	<span class="comment">// 提取当前相邻区域16个像素点做插值</span></span><br><span class="line">					MB.<span class="built_in">convertTo</span>(MB, CV_64FC1);	<span class="comment">// 变换为浮点型数据</span></span><br><span class="line">					MB = MB.<span class="built_in">t</span>();	<span class="comment">// 求转置矩阵</span></span><br><span class="line">					cv::Mat MC = (cv::Mat_&lt;<span class="keyword">double</span>&gt;(<span class="number">4</span>, <span class="number">1</span>) &lt;&lt; <span class="built_in">bicubic</span>(<span class="number">1</span> + dR), <span class="built_in">bicubic</span>(dR), <span class="built_in">bicubic</span>(<span class="number">1</span> - dR), <span class="built_in">bicubic</span>(<span class="number">2</span> - dR));</span><br><span class="line">					cv::Mat result = MA*MB*MC;</span><br><span class="line">					res.at&lt;uchar&gt;(y, x) = <span class="keyword">static_cast</span>&lt;uchar&gt;(result.at&lt;<span class="keyword">double</span>&gt;(<span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	cv::<span class="built_in">imshow</span>(<span class="string">&quot;result&quot;</span>, res);	<span class="comment">// 显示变换后图像</span></span><br><span class="line">	cv::<span class="built_in">waitKey</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>　　以上 C++ 代码在 VS2013 下能完美运行，不管是用 OpenCV-2.4.11 还是 OpenCV-3.2.0。其实完全理解的话，不管用什么工具都能实现，只是看哪个工具方便一点而已，就这个而言，感觉 Matlab 要方便很多，Shaun 就不继续挖 Python 的坑了，毕竟如果要用 Python 实现其实还是用 OpenCV，只是用 OpenCV Python 版的接口而已。</p>
<h2 id="参考资料">参考资料</h2>
<p>[１] <a href="https://wenku.baidu.com/view/e94cfa2d336c1eb91a375dab.html">第4章 图像几何变换</a></p>
<p>[２] <a href="http://blog.csdn.net/lkj345/article/details/50555870">图像旋转原理及实现</a></p>
<p>[３] <a href="http://www.opencv.org.cn/opencvdoc/2.3.2/html/doc/tutorials/imgproc/imgtrans/warp_affine/warp_affine.html#warp-affine">仿射变换</a>（<a href="http://www.opencv.org.cn/opencvdoc/2.3.2/html/doc/tutorials/tutorials.html" class="uri">http://www.opencv.org.cn/opencvdoc/2.3.2/html/doc/tutorials/tutorials.html</a>）</p>
<p>[４] <a href="http://blog.csdn.net/augusdi/article/details/9028365">图像处理常用插值方法总结</a></p>
<p>[５] <a href="https://en.wikipedia.org/wiki/Bilinear_interpolation"><strong>Wikipedia Bilinear interpolation</strong></a></p>
<p>[６] <a href="http://blog.csdn.net/xjz18298268521/article/details/51220576">双线性插值算法的详细总结</a></p>
<p>[７] <a href="https://en.wikipedia.org/wiki/Bicubic_interpolation"><strong>Wikipedia Bicubic interpolation</strong></a></p>
<p>[８] <a href="https://wenku.baidu.com/view/34dea625192e45361166f504.html?qq-pf-to=pcqq.c2c">双三次插值(bicubic interpolation)原理及MATLAB源码实现</a></p>
<p>[９] <a href="https://dailc.github.io/2017/11/01/imageprocess_bicubicinterpolation.html">图像缩放】双立方（三次）卷积插值</a>（<a href="https://dailc.github.io/blog/tags.html#%E6%8F%92%E5%80%BC%E7%AE%97%E6%B3%95" class="uri">https://dailc.github.io/blog/tags.html#%E6%8F%92%E5%80%BC%E7%AE%97%E6%B3%95</a>）</p>
<section class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p><font color=#FA8072>为啥不说前向映射呢？这是因为若原图像坐标 <span class="math inline">\((v,w)\)</span> 通过前向映射方式得到变换后图像的坐标 <span class="math inline">\((x,y)\)</span> ，而且这个坐标为小数的话，一般采用四舍五入的方式得到变换后图像对应的整数坐标 <span class="math inline">\((⌊x+0.5⌋,⌊y+0.5⌋)\)</span>，令 <span class="math inline">\(f(⌊y+0.5⌋,⌊x+0.5⌋)=f(w,v)\)</span> 。</font><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p><font color=#FA8072><span class="math inline">\(⌊x⌋\)</span> 表示向下取整，称为 Floor，指的是小于或等于 <span class="math inline">\(x\)</span> 的最大整数；<span class="math inline">\(⌈x⌉\)</span> 表示向上取整，称为 Ceil，指的是大于或等于 <span class="math inline">\(x\)</span> 的最小整数，<span class="math inline">\(eg：⌊5.6⌋ = 5，⌊-5.6⌋ = -6；⌈5.6⌉ = 6，⌈-5.6⌉ = -5。\)</span></font><a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
]]></content>
      <categories>
        <category>Image&amp;Graphic</category>
      </categories>
      <tags>
        <tag>algorithm</tag>
        <tag>matlab</tag>
        <tag>opencv</tag>
      </tags>
  </entry>
  <entry>
    <title>社畜三年，风雨兼程</title>
    <url>/posts/dbbe01e5.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　财富和幸福算是绝大部分人的毕生追求，所以在读这本书时，更容易让人有一种思想上的共鸣，但一个人的成功总是独一无二的，需要依靠天时地利人和，正所谓，学我者生，似我者死，可以学习借鉴成功者的一些思想，但不要想着沿着成功者的路继续走下去就能成功。 ——读『纳瓦尔宝典』</p>
<span id="more"></span>
<h2 id="感想篇">感想篇</h2>
<p>　　财富并不代表金钱或者地位，而是某种可以自然增长的东西，是一种追求共赢的东西，是一种可以长期存在的东西。最好的投资总是学习，成本低且有效，但接受新知识总是需要消耗更多的能量，而人总是想尽量减少能量的消耗，所以很多人都沉迷于快餐文化中，不需要过多的思考，又消磨了时光，一举两得 (￣ε(#￣)☆╰╮(￣▽￣///)。</p>
<p>　　人生总有选择，也总要承担选择所带来的后果。选择永远比努力重要，光凭运气去选择，或许能瞎猫碰上死耗子，但狗屎运总归会用完，下一次就不好说了。如何选择是需要去学习的，有从自身过去的经验去学习，有从别人身上去学习，更多的是依靠平时积累的各种信息，这就是努力了，努力或许有结果，也或许没有，但不努力，一定没结果。努力的目的是为了有更多的选择，在有更好的选择时能及时判断，不要单纯的为了结果而努力，很有可能得不偿失。付出和回报看对人对事吧，对自己的付出当然总是会有回报的，对事情付出同样会有，但对其他人付出，就别太指望一定要有啥回报，可以设个底线，在没有任何回报的情况下，能付出多少。</p>
<p>　　选择也从来不是一竿子买卖，局部最优也不代表全局最优，人生的选择更是如此，十年前的当时最优放在现在看可能选错了，放在十年后再看可能又选对了，时代在发展，当然倘若十年前真选对了，可能就不需要十年后再回过头来看了 :P。绝对最优这个词在人生道路上就不存在，只能说是相对更优，这个更优不是选项之间的对比，而是选项与自身的对比，哪个选项最能提升自己就选哪个就行，长远来看，投资自己不一定能飞黄腾达，但总能有口饭吃。投机是选择，稳扎稳打也是选择，本身无优劣，回报和风险总是共存的，能承受的起就行，别光见贼吃肉，不见贼挨打。</p>
<p>　　获取金钱的方式有很多，最快的方式都写在刑法里 ๑乛◡乛๑，而创造财富的方式也有很多，最直接的是去资本市场做投资，也可以想方设法积累自己的名气（不管是好是坏），然后走流量变现。创造财富都有其风险，就算是大航海时代，不也一大批人沉在海底，打工人虽然是在给别人创造财富，但对自身而言，也算是一种资本的原始积累，而且是相对最稳定的一种，对于技术人来说，技术经验也算是一种时间杠杆，所以边打工，边在资本市场中学习，也不失为一种创造财富的方式。</p>
<p>　　至于幸福，「哈佛大学公开课:幸福课」中指出幸福是不可持续的，永远幸福是不可能的。幸福的人都是相似的，不幸的人各有各的不幸，穷人的不幸比富人更不幸，借用一句伪科学的话：所有的不幸的都是对现状的一种不满足感，满足是一种幸福，适应也是一种幸福，总而言之就是看开，释放。「银河系漫游指南」中宇宙终极问题的答案是 42，或许本身就是无意义的事，为啥一定要有意义，无聊或许才是人生的常态主题。当欲望得到满足，或许能得到短暂的幸福，但随之而来的空虚感也得忍受，更关键的在于去选择下一件事，绝大部分人总还是要为了生计奔波，吃饱了撑得就容易胡思乱想，忙点啥，哪怕随便干啥，都能体会到闲暇时的幸福 :P。</p>
<p>　　曾经在 TED 上看到不要把梦想告诉别人，告诉了就很难实现，因为能得到的只有嘲笑，以 Shaun 个人经验来说是没错的，梦想还是放在心里比较好，或许等哪天实现了再放出来会更加畅快，有且仅有自己做的梦才是真正的梦想，这才是人最珍爱的东西，就像「来自深渊:烈日的黄金乡」中真正的挚爱是不会让任何人知道的，哪怕是自己最后的传承者。「把时间当作朋友」中有这样一句话，“来自外部的恐惧在于过分在意外界的评价”，Shaun 本身不是个太在意别人看法的人，在意别人的评价，无疑会让自己活得更累，尤其是大部分人的评价没有丁点儿建设性，只是一种优越感作祟，当然，自己真有问题而不自知也是不行的。很喜欢暗杠「童话镇plus」里唱的“很多人一辈子忙忙碌碌不会懂得：有个被嘲笑的梦想万一有天实现了呢？”，人活着，总得有个念想。奔波一世，虽说是为了这一日三餐，但能留下点脚印，哪怕是些许痕迹，好像也还不错。</p>
<p>　　老子云：知人者智，自知者明；邓宁-克鲁格效应也指出认知有四大境界：不知道自己不知道，知道自己不知道，知道自己知道，不知道自己知道；人贵有自知，可惜不知为知者有之，过而不改者有之，好为人师者有之。人之患在好为人师，道不可轻传，薪尽火传在很多时候也只是妄想，自以为是，人以为非，自以为厉害不算厉害，别人认为厉害才是真厉害。自知，知道自己几斤几两，自尊自爱，力所能及，道阻且长，持续学习，徐徐图之。</p>
<p>　　常言道：种一棵树最好的时机是十年前，其次是现在。做事情从来不嫌晚，就怕不行动，人人都会做梦，有些梦不切实际，有些梦有迹可循，空想无用，再周密的计划也比不过实际执行，计划赶不上变化，诚然，试错有成本，但这成本也同样是经验，按部就班的迭代执行，总会走向通往梦想之路，不过大部分人可能在路上就迷失了，甚至有些人走不上路，能真正到达终点的人，终究只是少数。</p>
<h2 id="工作篇">工作篇</h2>
<p>　　一位长者曾经说过：一个人的命运啊，当然要靠自我奋斗，但是也要考虑到历史的进程。工作不是事业，对于大部分的人目标都只是简单的钱而已。三年期的目标算是达成了，五年期的目标的应该是完不成了，不过总归要尽力，大环境如此，个人的努力显得格外苍白。在时代的洪流之下，众人皆是蝼蚁，按部就班，做好自己该做的就行，至于回报，还是得看外面的环境调整预期。</p>
<p>　　Shaun 这三年来，从小公司跳到大公司，体会最深的就是，就单纯的论做事而言，大公司和小公司没啥区别，能接触到的人也就是自己组内和上下游的几十个人而已，唯一的区别可能也就是履历背景了，但这个也只能在跳槽时才能体现其作用，当然或许有人说人的能力强弱不同，但就 Shaun 的感觉来看，不是不同，而是术业有专攻，不同的公司对人的侧重点要求不同，大公司小公司都有工作能力很强的，不过都跑路了 ¯\_(ツ)_/¯，不过有一点是真的有区别的，就是数据量，这是实打实的区别，不过这更多的是对经验的要求，对人做事的本质能力并没有更高的要求，还是用原来的思维方式尝试新的方案和实验，真正难的问题还是交给学术界去解决吧。</p>
<p>　　无论大小公司，拥抱变化或许才是永恒的话题。这种变化，不只是裁员（<em>只要是补偿没问题的裁员，若被裁，那便被裁，找个吃饭的地方，总还是不难的</em>），更多的是体现在做事方面。打工人常听人说，事情是做不完的，没必要这么加班加点的干，没必要加班干是真的，但事情是会做完的，只是做完了又会有新的事过来，事情做完又两层含义：一层是事情可以告一段落了，做到这到此为止了，不要再投入大量人力做这个事，只是日常维护；另一层是这个事情不做了，现有人力要么换岗要么走人。对于公司上层来说，更关心的事是做完这个事之后下一个事做什么，如果没有下一个事，那留下这么多人就没必要了，体现到下层大头兵上，就是要么被裁，要么换个事情做，至于换个的事情可能是类似的事，也可能是全新的事，这就对人的学习能力或知识迁移能力有一定的要求。从上层的角度来说基本上很难让一个大头兵一直持续深入的干某件事，浪费人力，投入和产出完全不成比例，所以持续学习，拥抱变化才是真理。就 Shaun 个人的经验而言，基本上每半年换个新的活儿，有的活能照之前的经验完全迁移，有的活完全没接触过，得重新开始学，不过好在大多数的事都还能胜任，差强人意。</p>
<p>　　换活，有的是开辟新业务，有的是填坑，开辟新业务一般都算是好活，从 0 到 1，事情不一定轻松，但收益可是实打实的，而且越前期的收益越容易拿，除非新业务黄了，不然光啃老都能啃几年，这是真好活。至于填坑，就看坑是什么样的了，若是核心的坑，那当然是极好的，怕就怕是陈年老坑，还需要不断维护更新，经受无数人的东西还有去维护，也是个烂坑；另一种坑是，前人写了系统原型，需要沿着这个原型继续开发，可惜原型一般只是实现核心功能，更可怕的是还是个初版，代码也是一团糟的那种，这样的坑接收恐怕是只能重写了，但收益一般也就不好说了。</p>
<p>　　收益，是企业最核心的两个字，没有收益，一切都是免谈，收益有显而易见的，比如节省成本，开拓市场，也有不明显的，比如为以后节省人力，为将来快速解决问题。显式的收益很容易感知，也很好评估，隐式的收益就基本无法感知，将来的事谁能说的清，况且将来还有没有这事都很难说，员工的人力成本也容易忽视，这些收益就很难评估，也就基本不可能定为上下一心的 kpi，当下面的 kpi 不是上面的 kpi，那下面做的一切工作都是白干，虽然对自身可能有益，但也只能面试时体现了。每离职一个核心人员，至少需要调派 3 个人来填补空缺，为啥企业宁愿后面补充，而不是提前安排一个人来分担工作，主要原因在于企业在赌核心人员不会轻易离职，也不会安排太多人手干维护性质的工作，但当熟手离职，再要去维护的代价就很大了，后来者一边填坑，一边在心里骂街，就这样一轮一轮的后来者，一轮一轮的骂街，屎山也就这样炼成了，直到推倒重来，形成上下一心的 kpi，又开始新一轮的屎山炼成。</p>
<p>　　提问从来不是件丢人的事，只要自己尝试过解决且保持应有的礼貌，毕竟人非生而知之者，不知道才是常态。很多人喜欢闷头干活，遇到问题只会冥思苦想，独立思考固然是一种品质，但思考也需要讲究基本法，思考也分交流前中后，当完全没有交流，就开始想解决方案，这是呆子，没有任何背景，能想出好的方案，那可能是真正的天才，那也没必要和打工人混在一起了。软件系统的问题更多的可能是人的问题，遇到问题，最好的是先了解背景原因后果，了解一下来龙去脉，再和有经验的人交流讨论一下，可以怎么解决，最后再决定具体做法，怎么执行，真梳理完了之后，执行一般是一件比较简单的事了。遇事多沟通，想开点，对人愚钝，对事精明。</p>
<p>　　如无必要，勿增实体，漂亮话人人都会说，可真在具体实施中，一般都是怎么快怎么来，优先增加一个实体再说，而不是去想有没有必要；当然也有的会过度放大这个事，明明增加这个实体能给各方都便利很多，从成本考虑就是不增，孰不知在另一方面反而是增加了成本。软件开发行业中，有很多定律法则，但人是活的，定律是死的，每个人有每个人的理解，在不同的业务场景下，定律的体现都有不同，一般情况下，围绕定律走不会出太大的问题，但有时也需要灵活变通，就像设计模式一样，不是完全一层不变的，有那层意思在就行，Shaun 认为唯一恒定的定律就是「简单」，不管是设计还是开发，越简约，越直观，就越稳定，越正确。</p>
<p>　　年龄歧视在职场中是确实存在的，国内职场普遍认为，当到一定年龄的时候，就应该到一定的职级，到一定的职级就不会再在一线干活了，这就导致了在招干活的人，就不会招年龄大的，这真的就很畸形，职级高就不会也不需要在一线干活，就目前国内职场的环境，技术从来不是主流的上升手段，所谓的技术路线是不存在的，不需要真正的架构师，文档架构师更受欢迎，说的好才能活的好。做完和做好从来都是两回事，但相比较而言，做完更重要些，毕竟做的好与不好，很难量化评估，所以更多的要求是能不能做出来，不关心好与坏，有东西出来这更重要，而一般都能做出来，所以不重视技术人员，而更重视管理人员，这就是互联网 35 岁失业的本质，就算 35 岁以上的技术人员能做的更好，但 ROI 不成正比。管理者掌握是组织技能，执行者掌握的是生存技能，当经济环境下行时，生存技能有优势，当经济环境上行时，组织技能更有优势。</p>
<p>　　跟对人，做对事，简简单单六个字，做起来可太难了，首先怎么定义对，在合适的时间做合适的事，这个合适怎么把握。曾以为只要努力做事，就能得到应有的回报，可在人类世界，老实做事有回报的都上新闻了。做好事不如做对事，但不知道事情做的对不对的时候，也只能选择做好，至少这是对个人能力的要求，少留点骂名。当然，善战者无赫赫之功，做的好了，也没法突出个人的重要性，甚至给上面的感觉是有你没你没区别，只要还在这个位置上，能力就体现不了，相反，经常出问题的人，得一堆人围着转，这看起来就很重要 ๑乛◡乛๑，如果上面再分配不公，能力强的人自然就加速走了，某种程度上的死海效应，劣币驱逐良币。</p>
<p>　　工作也是讲方法论的，做事的出发点和方向错了，即使能解决一部分问题，但解不干净，最后还得推到重来，所以项目启动前的分析非常重要，一定得先抓头部问题，当然穿插一些能快速解决的问题也行，其次就是明确哪些问题一定要解，哪些问题可以不解，最后就是一定要留下文档纪要，这是工作量的体现，也是未来追溯问题的依据。汇报也一般可分为五步：背景，需求和目标，解决方案和排期，进展和依赖项，问题和风险。</p>
<p>　　工作自由，有两种境界，一种是选择做什么的自由，另一种是选择不做什么的自由。大部分或许能选择做什么，但却无法拒绝一些事，有些事情只能被动接受，但有些却是可选的，不要一直被牵着走，事有轻重缓急，要有自己的认知，学会拒绝，哪怕是上级的需求，现如今找个养家糊口的工作还是不难的，此处不留爷自有留爷处。了解并学习职场中一些常用的话术，分辨并挑出真正对自身有益的，别把别人太当回事，别把自己不当回事，事实是事实，话术是话术，主人翁意识是每个领导都希望下属有的，但解释权归领导所有，越上层就越不可能落到实处。尽心做事，尽力做好每一件接手的活，无论喜欢与否，真不想做，就不要接，既然做了，就尽职尽责，算是在工作中积德了，败人品的事还是尽量不要做。放宽心态，大方待人，不要把工作当生活，可以享受工作，但更应该享受生活。勇于分享，分享讨论可能不见得是件好事，但绝不是坏事，分享同样也是一种总结。灵感是易逝的，当有灵感时，就尽快行动起来，优秀的产品需要时间来打磨，对结果需要有更多的耐心。</p>
<p>　　在 22 年一片开源节流的浪潮中，人人自危。「浪潮之巅」中，科技的发展史就是一批企业的兴亡史，或因为自身的原因，尾大不掉，或因为更上层的力量，没有哪家企业能一直辉煌下去，打工人能做的，只有选条赛道，厚积薄发，尽量少换或不换行业，剩下的也就只有听天由命了，毕竟将来的事谁也说不好，潮起潮落，又有谁能一直屹立浪潮之巅 ╮(╯▽╰)╭。</p>
<h2 id="生活篇">生活篇</h2>
<p>　　这三年，最大的主题就是“新冠”，新冠时代，每个人都是历史的见证者，这次疫情，足以在人类历史上留下浓墨重彩的一笔。这期间，也能真正在现实里体会一把魔幻现实主义，有大规模封城的，有叫嚣着他的软肋是儿子的，也有恶意返乡有家不能回的。天赋🧑权，疫赋🐶权，肉食者的政策总是不食人间疾苦。又或许是上面的政策出发点是好的，但奈何下面的执行者大部分是一帮饭桶蛀虫，能站在布衣角度去落实政策的又有多少。解封之后，对 Shaun 而言，最大快人心的就是不用再看看门大爷的嘴脸。黑色的眼睛可能是黑夜给的，也可能是白天给的，有人用它寻找光明，也有人用它寻找黑暗，西游记里描述的狮驼国从历史角度看，也不是什么神话传说，虽说如今的时代论惨烈规模没那么大，但苦难并没有完全消失，太阳底下也没有新鲜事。</p>
<p>　　「动物庄园」里有句话，“所有动物生来平等，但有些动物比其他动物更平等”，疫情三年，对这句话体会更加深刻，有的人生在罗马，也有的人生来就是骡马，人人平等的乌托邦世界或许只是个伪命题。连科学也只是为政治服务的工具而已，社会的科技发展也从不依赖于上层阶级的想法，往往只是下层某个灵光一现的思路，人类社会有个很奇怪的现象就是，本来一个人在下层成果迭出，当跃迁到上层时，思维就好像僵化了，深层原因可能有很多，但至少表面现象是这样。普罗大宗也很容易受到各种言论的影响，尤其是某些专业人士的公开发言，所以完全的言论自由也意味着完全混乱，需要管控，但也有知情权，不然就像一氧化二氢实验一样，隐瞒一面，重点宣传另一面，就很容易受到别有用心的一些误导。</p>
<p>　　未经他人苦，莫劝他人善，这三年，在网上见过太多的牛鬼蛇神，一把键盘走天下，自以为站在大义之上，实际上只是些吃着人血馒头既蠢又坏的看客，以自己幸福的生活站在道德制高点上去肆意抨击他人，并因此而洋洋得意。诚然无能是最大的罪恶，哀其不幸，怒其不争，但匹夫之怒，也能血溅五步，自救者天救，自助者天助，自弃者天弃。当感叹世事无常的时候，都可以去看看「活着」，有的人觉得蝼蚁尚且偷生，好死不如赖活着，也有的人觉得宁为玉碎不为瓦全，读书毕竟是个很私人的事，一千个人心中有一千个哈姆雷特。</p>
<p>　　生存还是生活，这是一个永恒的话题。苏轼曾感叹道，寄蜉蝣于天地，渺沧海之一粟，人这一辈子，说长也长，年轻的时候往前看，感叹还要这样过几十年，说短也短，回首往事，转瞬即逝。也曾踌躇满志，誓要走出山村，而今跨长江越黄河，问一句，有必要吗？行路难！行路难！多歧路，今安在？生活的方式有很多种，或许平淡才是真，人活一世，顺心而已。22 年，偶然发现北京有很多的户外徒步组织，Shaun 也参加了好几次活动，感觉确实很有意思。有的人把徒步当成一种极限运动，挑战自我，也有的人把徒步作为一种休闲运动，纯纯放松心情，每个人徒步的目的都各不相同，重点在于量力而行，对大自然有敬畏之心。周末去外面走走，听风观景阅人看故事，虽然身体上并不轻松，但能极大的消除一周心理上的劳累感。寄情于山水，逍遥于世间，打工人花点小钱，就能有心灵上的放松，整挺好。</p>
<p>　　至于对象，就感觉自己一直很佛系，或许得等到真正成为大魔法师的那一天，才会转变心态。爱情，Shaun 是从来不奢望的，爱情是咋样，相信一千个人心中有一千个哈姆雷特，古今中外有无数的作品的描述了作者心中认为的模样，共同点在于都有风花雪月，嘻嘻哈哈，哭哭啼啼，而生活，好像优秀的作品不多，一个可能的原因是爱情短暂，更有戏剧性，作品也能更有张力，而生活一般时间跨度较长，再惊天动地的事在时间的长河里或许也只是一朵小水花，看起来很平淡，贾科长或许是个很善于观察生活的人，22 年的「隐入尘烟」或许也描绘了生活的一部分，平平淡淡才是真，哪有那么多跌宕起伏，哪有那么多真善美。</p>
<p>　　『紫阳』中有句话，「男女之情并不深奥，感情的发生有两种诱因，一是源于阴阳交合本能的驱使，以阴阳交合为目的。还有一种是喜欢对方身上的优良本格，愿意与之长相厮守。这两种诱因都可以引发情感，没有高下清浊之分，两种诱因也往往彼此掺杂，很难明确区分。这两者唯一的不同就是后者更容易被世人传颂赞美，但后人传颂和赞美的其实也并不是情感本身，而是少数人身上的优良品格」。爱情或许值得被赞美，但更多的是恋爱过程中经历的事，爱情或许从来都是想象中的产物。「三体」中有描述，大部分人的爱情对象也只是存在于自己的想象之中。他们所爱的并不是现实中的 ta，而只是想象中的 ta，现实中的 ta 只是他们创造梦中情人的一个模板，他们迟早会发现梦中情人与模板之间的差异，如果适应这种差异他们就会走到一起，无法适应就分开，就这么简单。两个人真正在一起的时候，往往只看到对方坏的一面，分开的时候，回忆时却想着好的一面，人生就是这么反复无常。「疑犯追踪」有这样一句台词：有一天你嫁给了自己的灵魂伴侣，然后眼睁睁看着他们变为另一个人，一旦深爱这人曾经的样子，便无法接受他们改变后的样子。最爱的人或许只存在于想象中，毕竟，随环境变化最大的也是人。</p>
<p>　　有人说，两个人在一起就是为了分担风险，当一个人能够足够承担风险的时候，或许就不需要两个人。「在云端」中有讨论过结婚的意义：可以有依靠的人？但能真白头偕老的人又有多少，计划永远赶不上变化，就算能碰到自己的理想型，但你大概率不会是 ta 的理想型，况且人都是善变的；不会孤独终老？如今的时代养儿防老风险也不小，比父母更有能力的孩子基本不可能待在父母身边；或许正如男主后期的思想转变，结婚的意义或许就是找个能分享倾听理解陪伴的人。Shaun 理想的两人关系应该是一种战友之上的关系，相互信任理解尊重，虽有小分歧，但大目标一致。人与人之间的相处哪要那么多心思，顺其自然，求同存异，自尊自爱，人待以诚，待人以诚。庸人为了忘却烦恼，一般以智者不入爱河来自我安慰。人啊，简单又复杂，简单在合心意，复杂在人心难测，所以不需要强求，顺心不香吗？</p>
<p>　　回想起以前高中的时候，就有同学对 Shaun 说：“你这看样子以后就是要靠相亲找对象的”，现在想来，那同学看人真准。有人说相亲是让一个不懂人的去搞定一个难懂的人，其实哪有什么不懂或难懂，有的只是一群彷徨的可怜人罢了，很少有人能确切的明白自己真正想要的是什么。数学中有个最优停止理论，得出了一个 1/e 的数值。通俗来说就是在苏格拉底的麦穗故事里前 1/3 的路程，什么都不摘，只是用来估计自己的预期，在后 2/3 的路程里，一旦有接近甚至超越的预期的麦穗出现，立即摘下。满足 1/e 概率的前提之下是麦穗大小均匀分布，可惜现实世界很少有均匀分布，所以这个东西对于相亲虽说有一定的借鉴作用，但还是不要太盲从。相亲本来就带着强烈的不信任感，而信任的建立一般又是个长期过程，在不信任甚至有些防备的状态下进行交流，自然很难发现别人的闪光点，更多的是在不经意间暴露出的缺点（相对而言是缺点，毕竟善于发现美的人不多，挑刺的人会更多些），从这点而言，相亲和面试差不多了，更重要的是遇上对的人，幸运值很重要。</p>
<p>　　相亲的交流无非就两种方式，一种是直截了当，开始就问对方想找个啥样的；另一种迂回战术，从工作学习生活爱好方面按流程开始话题，虽然很平淡，但是一般也没太大的问题。交流是相互的，就光一个人问，这不是聊天，而是面试。当然如果感觉聊不到一块儿，确实话不投机半句多，就尽早结束；当犹豫要不要开启话题的时候，就可以长痛不如短痛了，当断不断，反受其乱。出来相亲的人都抱着不同的目的，有的人是被迫的，有的人只是想接触一下外人，有的人是想给别人一个机会，也有的人确实很实诚的想找个相守一生的对象。不同的目的造就了不同的人，有的人就是想出来玩玩，享受那种若即若离的朦胧感，Shaun 一贯的态度是抱着一颗平常心，观其行而知其心，得之我幸，失之我命，求而不得，何必强求，弃得失心，方可自在，若不成，那便不成，也不需要刨根问底，在没有结果的事情面前，真相都显得没有任何意义。</p>
<p>　　很多人对别人的看法在第一次交流的时候，就基本已经确定了，先入为主的思想根深蒂固，孰不知交流本身可以算是一件很随意的事，不同的交流方式，不同的语言文字，在不同的人生背景下，都有不同的含义，除非带着很强的目的性，非常明确的知道这次交流的主题是啥，不过这就和工作中开会没啥区别了。生活中的交流还是随意些比较好，一般都是想到啥就说啥，不用费脑子，巴适。</p>
<h2 id="理财篇">理财篇</h2>
<p>　　关于理财的言论有很多，在经济上行的时候，网络上流传的话是，你不理财财不理你，经济下行的时候，说的更多的就是，你一理财财离开你。理财，其实是一个很私人的事，分享交流可以，但安利就算了，赚钱的时候只会觉得自己眼光不错，亏钱发泄情绪的时候就正好能找到一个出气口。理财的手段也有很多，最稳妥的当然是不理财，直接把现金都放家里，毕竟在这个银行都会爆雷的时代，钱放银行都不太保险。有人说，乱世买黄金，盛世买古董，灾荒屯余粮，这话说的也有一定的道理，毕竟黄金是整个人类文明的硬通货，钱或许不一定是钱，但黄金总还能代表钱，古董更多的是一种精神文明象征，当衣食无忧的时候，自然也会想有点更高层次的追求，当衣不蔽体食不果腹的时候，自然填饱肚子才是最高优先级。对应到国内市场，当银行爆雷的消息传来，黄金大涨，这三年疫情，食品消费行业涨，其他都跌，市场总是跟随人的需求变化而变化，不管是看衰还是看好，总有人能从中发现商机，毕竟资本总是会从一个地方转移到另一个地方，除非整个市场崩了。</p>
<p>　　理财本质上是一个买与卖的哲学，就算是存银行，为方便取用，就用活期，暂时不用，就用定期，这也是存款收益的一种买卖权衡，至于市场里的交易，就是更直接的买卖了。每个人都想从这种买卖中获益，不管是买方还是卖方，但是这种买卖不是简单的零和，有可能是正和，有时甚至会是负和，主要看买卖的东西的是啥。有些人一次两次的交易都获利了，就想着下次能不能获利更多，但随着等待的时间拉长，收益都变成亏损了，最后只能忍痛割肉。不管是盈利还是亏损，都有其背后的逻辑，不长记性，迟早哪天会栽沟里。在「赌城风云中」有类似这样一句台词：让人去赌场，并一直待在赌场，堵的越多总会输的越多，赌场总是赢家。赌场赢的关键在于如何让赌徒一直待在赌场，就算出去，也依然会回到赌场，股票投资市场虽然和赌场差别很大，但本质上有些地方是相通的，对于普通人，一直待在股市中，却不去学习证券金融市场运转规则，不去了解国家政策导向，迟早有翻车的一天，虽然对于整个市场来说不一定有赢家，但赌徒肯定会是输家。</p>
<p>　　有人说，人只能赚到自己认知范围内的钱，但没人说，会亏损到什么程度。所有的亏损都来自于赚钱的欲望，越想赚钱可能亏损就越大，对于理财，止损线和止盈线同等重要，这两条线每个人心里都应该有自己的尺子，当然也得根据当前的市场环境和自我认知进行动态调整。见好就收，见衰则退，说起来容易，但做起来何其艰难，早早退出的懊恼，越陷越深的后悔，这些事情只有亲身体验过，痛过之后长了记性，才能有自己的认知，光凭运气挣的钱，指不定哪天就会连本带息的还回去。亏损是个无底线的事情，短时间大亏，很多人可能就直接退场不玩了，怕就怕在钝刀子割肉，割几天又喂点好的养几天，亏麻了又还有点希望，碰到这种情况更加需要慎重，需要费心费力收集更多的信息做决策，所以与其在后期劳心劳力，不如前期就先做好各项调查准备工作，而且做事的心态也不一样，每一笔投资都应该有充分的理由，不然不投会更好。</p>
<p>　　在这个人人都想赚快钱的时代，国内市场都是很浮躁的，都堵的是自己不是最后一批入场的。很多人也知道快和慢都是相对的，投机倒把拼运气是快，但总归不能长久，除非完成资本的原始积累之后立即转型，不然总是要还回去的。在股市里遨游，不亏就是赚，能保住不亏，稳扎稳打，从长时间维度上来讲，不一定就会比“快”方法慢。Shaun 这三年的投资收益不能说一点没有，只能说和存银行差不多，相当于是玩了三年，也还算能接受，就当是白嫖了些股市经验吧 :P。这三年可以说是入市即巅峰了，经历过连续几个月的万亿交易量，也经历过上证 2800 以下，算是过了一波小牛熊，不说掌握了多少金融相关的专业知识，但一些常识性的经验还是积累了一些。Shaun 总结的经验主要有：1、万亿成交量的市场，需要慎入；2、当不确定甚至不知道买啥的时候，就不要动；3、当一个热点被广泛讨论的时候，可以考虑退出了；4、尽量不要去买大股东在减持的股票，买家不如卖家精；5、两会前一个月的市场，慎入，两会期间可以酌情考虑入场；6、10 月份可以考虑一波白酒，年后卖掉；7、最重要的是，拿来投资的钱一定得是可预见的未来三年内不会动的钱。</p>
<h2 id="后记">后记</h2>
<p>　　难得写万字长篇，这次看完『纳瓦尔宝典』，又兼之正好工作三年（拖延症拖到快四年了 😅），算是跨过了人生的一道小槛，所以难免会有些想记下来的一些东西，也算是总结一下这三年来的工作生活思考。或许下一篇万字长文是十年回顾，也或许没有，毕竟自古苦难多诗文，天降大任于人，天不降大任于人，经历一样，唯一的区别在于是不是天命人。道阻且长，且行且顾。</p>
<div style="text-align:center; font-family: Allura, Consolas, Helvetica, Tahoma, Arial, Microsoft YaHei, 微软雅黑, SimSun, 宋体, Heiti, 黑体, sans-serif; font-size:1.3em; color:#4094c3; font-weight:700; margin:.5em auto;">
22 年获得技能：<strong><em>接活达人</em></strong><br />22 年获得成就：<strong><em>三年已到</em></strong>
</div>
]]></content>
      <categories>
        <category>Life</category>
      </categories>
      <tags>
        <tag>record</tag>
      </tags>
  </entry>
  <entry>
    <title>时空查询之ECQL</title>
    <url>/posts/489fa7b3.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　ECQL 是 CQL 的扩展，CQL 是 OGC 标准查询语言，而 ECQL 是 GeoTools 为更好的方便查询，在编程实现时扩展了 CQL，主要扩展在于其移除了 CQL 的一些限制（属性必须在比较运算符的左边，不能创建 Id Filter 进行查询等限制），也和 SQL 更相似。所以可简单认为 CQL 是书面上的标准，而 ECQL 是事实上的标准。</p>
<span id="more"></span>
<h2 id="谓词篇">谓词篇</h2>
<p>时间查询主要有以下几个查询谓词：</p>
<table>
<colgroup>
<col style="width: 36%" />
<col style="width: 63%" />
</colgroup>
<thead>
<tr class="header">
<th>谓词</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>T <strong>TEQUALS</strong> Time</td>
<td>测试 T 和给定时间相等，相当于 T == Time。</td>
</tr>
<tr class="even">
<td>T <strong>BEFORE</strong> Time</td>
<td>测试 T 在给定时间之前，相当于 T &lt; Time。</td>
</tr>
<tr class="odd">
<td>T <strong>BEFORE OR DURING</strong> Time Period</td>
<td>测试 T 在给定时间段之前或其中，相当于 T &lt;= TimePeriod[1]。</td>
</tr>
<tr class="even">
<td>T <strong>DURING</strong> Time Period</td>
<td>测试 T 在给定时间段其中，相当于 TimePeriod[0] &lt;= T &lt;= TimePeriod[1]。</td>
</tr>
<tr class="odd">
<td>T <strong>DURING OR AFTER</strong> Time Period</td>
<td>测试 T 在给定时间段其中或之后，相当于 TimePeriod[0] &lt;= T。</td>
</tr>
<tr class="even">
<td>T <strong>AFTER</strong> Time</td>
<td>测试 T 在给定时间之后，相当于 T &gt; Time。</td>
</tr>
</tbody>
</table>
<p>时间段以 <code>/</code> 分隔符区分前后两个时间，时间格式一般为 yyyy-MM-dd'T'HH:mm:ss.SSS'Z'。</p>
<p>空间查询主要有以下几个查询谓词：</p>
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th>谓词</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>INTERSECTS</strong>(A: Geometry, B: Geometry)</td>
<td>测试 A 与 B 相交，与 DISJOINT 相反。</td>
</tr>
<tr class="even">
<td><strong>DISJOINT</strong>(A: Geometry, B: Geometry)</td>
<td>测试 A 与 B 不相交，与 INTERSECTS 相反。</td>
</tr>
<tr class="odd">
<td><strong>CONTAINS</strong>(A: Geometry, B: Geometry)</td>
<td>测试 A 包含 B，与 WITHIN 相反。</td>
</tr>
<tr class="even">
<td><strong>WITHIN</strong>(A: Geometry, B: Geometry)</td>
<td>测试 B 包含 A，即 A 在 B 中，与 CONTAINS 相反。</td>
</tr>
<tr class="odd">
<td><strong>TOUCHES</strong>(A: Geometry, B: Geometry)</td>
<td>测试 A 的边界是否与 B 的边界接触，但内部不相交。</td>
</tr>
<tr class="even">
<td><strong>CROSSES</strong>(A: Geometry, B: Geometry)</td>
<td>测试 A 与 B 是否相交，但不存在包含关系。</td>
</tr>
<tr class="odd">
<td><strong>OVERLAPS</strong>(A: Geometry, B: Geometry)</td>
<td>测试 A 与 B 是否重叠，需满足 A 与 B 是同一类型（如都是 POLYGON），并且相交区域同样是 A 和 B 的类型（只能是 POLYGON，不能是 POINT）。</td>
</tr>
<tr class="even">
<td><strong>EQUALS</strong>(A: Geometry, B: Geometry)</td>
<td>测试 A 与 B 完全相等。</td>
</tr>
<tr class="odd">
<td><strong>RELATE</strong>(A: Geometry, B: Geometry, nineIntersectionModel: String)</td>
<td>测试 A 与 B 是否满足 <strong>DE-9IM</strong> 模型，该模型可模拟上述所有情况。</td>
</tr>
<tr class="even">
<td><strong>DWITHIN</strong>(A: Geometry, B: Geometry, distance: double, units: String)</td>
<td>测试 A 与 B 的最短距离是否不超过多少距离，单位有（<code>feet</code>, <code>meters</code>, <code>statute miles</code>, <code>nautical miles</code>, <code>kilometers</code>）。</td>
</tr>
<tr class="odd">
<td><strong>BEYOND</strong>(A: Geometry, B: Geometry, distance: Double, units: String)</td>
<td>测试 A 与 B 的最短距离是否超过多少距离。</td>
</tr>
<tr class="even">
<td><strong>BBOX</strong>(A: Geometry, leftBottomLng: Double, leftBottomLat: Double, rightTopLng: Double, rightTopLat: Double, crs="EPSG:4326")</td>
<td>测试 A 是否与给定 box 相交。</td>
</tr>
</tbody>
</table>
<p>Geometry 是指 WKT 格式的数据，主要有以下几种：</p>
<table>
<colgroup>
<col style="width: 26%" />
<col style="width: 73%" />
</colgroup>
<thead>
<tr class="header">
<th>类型</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>POINT</strong></td>
<td>POINT(6 10)</td>
</tr>
<tr class="even">
<td><strong>LINESTRING</strong></td>
<td>LINESTRING(3 4,10 50,20 25)</td>
</tr>
<tr class="odd">
<td><strong>POLYGON</strong></td>
<td>POLYGON((1 1,5 1,5 5,1 5,1 1),(2 2,2 3,3 3,3 2,2 2))</td>
</tr>
<tr class="even">
<td><strong>MULTIPOINT</strong></td>
<td>MULTIPOINT(3.5 5.6, 4.8 10.5)</td>
</tr>
<tr class="odd">
<td><strong>MULTILINESTRING</strong></td>
<td>MULTILINESTRING((3 4,10 50,20 25),(-5 -8,-10 -8,-15 -4))</td>
</tr>
<tr class="even">
<td><strong>MULTIPOLYGON</strong></td>
<td>MULTIPOLYGON(((1 1,5 1,5 5,1 5,1 1),(2 2,2 3,3 3,3 2,2 2)),((6 3,9 2,9 4,6 3)))</td>
</tr>
<tr class="odd">
<td><strong>GEOMETRYCOLLECTION</strong></td>
<td>GEOMETRYCOLLECTION(POINT(4 6),LINESTRING(4 6,7 10))</td>
</tr>
</tbody>
</table>
<p><strong><em>※注：</em></strong> POLYGON 中的边界点必须闭合，即首尾点相同，若存在多个边界，则需要遵循 逆时针,顺时针,逆时针,顺时针... 的点排列顺序，逆时针封闭，顺时针开孔，以形成具有岛和洞的复杂多边形。</p>
<p>　　由于 WKT 标准只支持二维的坐标，为支持三维坐标以及齐次线性计算，所以在 PostGIS 中又有 EWKT 标准实现，EWKT 扩展了 WKT，带 <code>Z</code> 结尾用来支持三维坐标，带 <code>M</code> 结尾用来支持齐次线性计算，如 <code>POINTZ(6 10 3)</code>，<code>POINTM(6 10 1)</code>，<code>POINTZM(6 10 3 1)</code>，同时还支持坐标内嵌空间参考系，如 <code>SRID=4326;LINESTRING(-134.921387 58.687767, -135.303391 59.092838)</code>。GeoTools 19.0 之后也默认以 EWKT 进行解析和编码。</p>
<h2 id="查询篇">查询篇</h2>
<h3 id="属性字段查询">属性字段查询</h3>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="code"><pre><span class="line">// 查询属性 ATTR1 小于 7 的数据</span><br><span class="line">Filter filter = ECQL.toFilter(&quot;ATTR1 &lt; (1 + ((3 / 2) * 4))&quot; );</span><br><span class="line"></span><br><span class="line">// 查询属性 ATTR1 小于属性 ATTR2 绝对值的数据</span><br><span class="line">Filter filter = ECQL.toFilter(&quot;ATTR1 &lt; abs(ATTR2)&quot; );</span><br><span class="line"></span><br><span class="line">// 查询属性 ATTR1 为 test 字符串的数据</span><br><span class="line">Filter filter = ECQL.toFilter(&quot;ATTR1 == &#x27;test&#x27;&quot; );</span><br><span class="line"></span><br><span class="line">// 查询属性 ATTR1 在 10 和 20 之间的数据</span><br><span class="line">Filter filter = ECQL.toFilter( &quot;ATTR1 BETWEEN 10 AND 20&quot; );</span><br><span class="line">Filter filter = ECQL.toFilter( &quot;ATTR1 &gt;= 10 AND ATTR1 &lt;= 20&quot; );</span><br><span class="line"></span><br><span class="line">// 多条件查询</span><br><span class="line">Filter filter = ECQL.toFilter(&quot;ATTR1 &lt; 10 AND ATTR2 &lt; 2 OR ATTR3 &gt; 10&quot; );</span><br><span class="line"></span><br><span class="line">// 查询属性 ATTR1 为 silver 或 oil 或 gold 的数据</span><br><span class="line">Filter filter = ECQL.toFilter(&quot;ATTR1 IN (&#x27;silver&#x27;,&#x27;oil&#x27;, &#x27;gold&#x27; )&quot;);</span><br><span class="line"></span><br><span class="line">// 以 ID 主键进行查询</span><br><span class="line">Filter filter = ECQL.toFilter(&quot;IN (&#x27;river.1&#x27;, &#x27;river.2&#x27;)&quot;);</span><br><span class="line">Filter filter = ECQL.toFilter(&quot;IN (300, 301)&quot;);</span><br></pre></td></tr></table></figure></div>
<h3 id="模糊查询">模糊查询</h3>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="code"><pre><span class="line">// 查询属性 ATTR1 包含 abc 字符串的数据</span><br><span class="line">Filter filter = ECQL.toFilter( &quot;ATTR1 LIKE &#x27;%abc%&#x27;&quot; );</span><br><span class="line"></span><br><span class="line">// 查询属性 ATTR1 开头不为 abc 字符串的数据</span><br><span class="line">Filter filter = ECQL.toFilter( &quot;ATTR1 NOT LIKE &#x27;abc%&#x27;&quot; );</span><br><span class="line"></span><br><span class="line">// 查询属性 cityName 开头为 new 的数据，忽略 new 的大小写</span><br><span class="line">Filter filter = ECQL.toFilter(&quot;cityName ILIKE &#x27;new%&#x27;&quot;);</span><br><span class="line"></span><br><span class="line">// 测试字符串是否包含</span><br><span class="line">Filter filter = ECQL.toFilter(&quot;&#x27;aabbcc&#x27; LIKE &#x27;%bb%&#x27;&quot;);</span><br></pre></td></tr></table></figure></div>
<h3 id="空属性查询">空属性查询</h3>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="code"><pre><span class="line">// 查询有属性 ATTR1 存在的数据</span><br><span class="line">Filter filter = ECQL.toFilter( &quot;ATTR1 EXISTS&quot; );</span><br><span class="line"></span><br><span class="line">// 查询属性 ATTR1 不存在的数据</span><br><span class="line">Filter filter = ECQL.toFilter( &quot;ATTR1 DOES-NOT-EXIST&quot; );</span><br><span class="line"></span><br><span class="line">// 查询 Name 为 NULL 的数据</span><br><span class="line">Filter filter = ECQL.toFilter(&quot;Name IS NULL&quot;);</span><br></pre></td></tr></table></figure></div>
<h3 id="时间查询">时间查询</h3>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="code"><pre><span class="line">// 查询时间属性 dtg 等于的数据</span><br><span class="line">Filter filter = ECQL.toFilter( &quot;dtg TEQUALS 2006-11-30T01:30:00Z&quot; );</span><br><span class="line"></span><br><span class="line">// 查询时间属性 dtg 在之后的数据</span><br><span class="line">Filter filter = ECQL.toFilter(&quot;dtg AFTER 2006-11-30T01:30:00Z&quot;);</span><br><span class="line"></span><br><span class="line">// 查询时间属性 dtg 在之前的数据</span><br><span class="line">Filter filter = ECQL.toFilter(&quot;dtg BEFORE 2006-11-30T01:30:00Z&quot;);</span><br><span class="line"></span><br><span class="line">// 查询时间属性 dtg 在之间的数据，+3:00 代表 GMT 时间 +3 小时，以 Z 结尾的时间就是 GMT 时间</span><br><span class="line">Filter filter = ECQL.toFilter( &quot;dtg DURING 2006-11-30T00:30:00+03:00/2006-11-30T01:30:00+03:00 &quot;);</span><br><span class="line"></span><br><span class="line">// 查询时间属性 dtg 等于的数据</span><br><span class="line">Filter filter = ECQL.toFilter(&quot;dtg = 1981-06-20&quot;);</span><br><span class="line"></span><br><span class="line">// 查询时间属性 dtg 小于等于的数据</span><br><span class="line">Filter filter = ECQL.toFilter(&quot;dtg &lt;= 1981-06-20T12:30:01Z&quot;);</span><br></pre></td></tr></table></figure></div>
<h3 id="空间查询">空间查询</h3>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="code"><pre><span class="line">// 查询空间属性 geom 包含点的数据</span><br><span class="line">Filter filter = ECQL.toFilter( &quot;CONTAINS(geom, POINT(1 2))&quot; );</span><br><span class="line"></span><br><span class="line">// 查询空间属性 geom 与 box 相交的数据</span><br><span class="line">Filter filter = ECQL.toFilter( &quot;BBOX(geom, 10,20,30,40)&quot; );</span><br><span class="line"></span><br><span class="line">// 查询空间属性 geom 与点最短距离不超过 10 千米的数据</span><br><span class="line">Filter filter = ECQL.toFilter( &quot;DWITHIN(geom, POINT(1 2), 10, kilometers)&quot; );</span><br><span class="line"></span><br><span class="line">// 查询空间属性 geom 与线相交的数据（geom 也必须是线）</span><br><span class="line">Filter filter = ECQL.toFilter( &quot;CROSS(geom, LINESTRING(1 2, 10 15))&quot; );</span><br><span class="line"></span><br><span class="line">// 查询空间属性 geom 与 GEOMETRYCOLLECTION 相交的数据（geom 也必须是 GEOMETRYCOLLECTION）</span><br><span class="line">Filter filter = ECQL.toFilter( &quot;INTERSECT(geom, GEOMETRYCOLLECTION (POINT (10 10),POINT (30 30),LINESTRING (15 15, 20 20)) )&quot; );</span><br><span class="line"></span><br><span class="line">// 查询空间属性 geom 与线相交的数据</span><br><span class="line">Filter filter = ECQL.toFilter( &quot;CROSSES(geom, LINESTRING(1 2, 10 15))&quot; );</span><br><span class="line"></span><br><span class="line">// 查询空间属性 geom 与 GEOMETRYCOLLECTION 相交的数据</span><br><span class="line">Filter filter = ECQL.toFilter( &quot;INTERSECTS(geom, GEOMETRYCOLLECTION (POINT (10 10),POINT (30 30),LINESTRING (15 15, 20 20)) )&quot; );</span><br><span class="line"></span><br><span class="line">// 查询空间属性 geom 与包含线的数据</span><br><span class="line">Filter filter = ECQL.toFilter(&quot;RELATE(geom, LINESTRING (-134.921387 58.687767, -135.303391 59.092838), T*****FF*)&quot;);</span><br></pre></td></tr></table></figure></div>
<hr />
<p>　　在 GeoTools 中，可通过 FilterFactory 来构造 Filter，而不是直接写字符串，具体示例如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="JAVA"><div class="code-copy"></div><figure class="highlight hljs java"><table><tr><td class="code"><pre><span class="line">FilterFactory2 ff = CommonFactoryFinder.getFilterFactory2();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 相当于 Filter filter1 = ECQL.toFilter(&quot;ATTR1 = 1 AND ATTR2 &lt; 4&quot; );</span></span><br><span class="line">List&lt;Filter&gt; filterList = ECQL.toFilterList(<span class="string">&quot;ATTR1=1; ATTR2&lt;4&quot;</span>);</span><br><span class="line">Filter filter1 = ff.and(filterList);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 相当于 Filter filter2 = ECQL.toFilter( &quot;BBOX(geom, 10,20,30,40)&quot; );</span></span><br><span class="line">Filter filter2 = ff.bbox(<span class="string">&quot;geom&quot;</span>, <span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>, <span class="string">&quot;EPSG:4326&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 相当于 Filter filter3 = ECQL.toFilter( &quot;dtg DURING 2006-11-29T00:30:00Z/2006-11-30T00:30:00Z&quot;);</span></span><br><span class="line">Date startTime = ZonedDateTime.of(<span class="number">2006</span>, <span class="number">11</span>, <span class="number">29</span>, <span class="number">0</span>, <span class="number">30</span>, <span class="number">0</span>, <span class="number">0</span>, ZoneOffset.UTC);</span><br><span class="line">Date endTime = Date.from(startTime.plusDays(<span class="number">1</span>).toInstant());</span><br><span class="line">Filter filter3 = ff.between(ff.property(<span class="string">&quot;dtg&quot;</span>), ff.literal(startTime), ff.literal(endTime));</span><br></pre></td></tr></table></figure></div>
<h2 id="后记">后记</h2>
<p>　　基本可认为 CQL 和 SQL 中查询条件差不多，虽然不支持分组查询等复杂 SQL 特性，但对于一般的时空查询基本够用，CQL 中还有些空间操作函数就不继续写了，如取面积，取缓冲区，取交集，取长度等等，有需要的可自行查询 <a href="http://udig.github.io/docs/user/concepts/Constraint%20Query%20Language.html">uDig Common Query Language</a>。</p>
<h2 id="参考资料">参考资料</h2>
<p><a href="http://docs.geotools.org/latest/userguide/library/cql/cql.html">GeoTools CQL</a></p>
<p><a href="http://docs.geotools.org/stable/userguide/library/cql/ecql.html">GeoTools ECQL</a></p>
<p><a href="https://docs.geoserver.org/latest/en/user/filter/ecql_reference.html#ecql-reference">GeoServer ECQL Reference</a> / <a href="https://blog.csdn.net/neimeng0/article/details/79914880">GeoServer 属性查询和空间查询支持 CQL / ECQL过滤器语言</a></p>
<p><a href="https://blog.csdn.net/ucs426/article/details/99780891">WKT解读</a></p>
<p><a href="https://www.cnblogs.com/denny402/p/4968201.html">GEOS库学习之三：空间关系、DE-9IM和谓词</a></p>
]]></content>
      <categories>
        <category>Study</category>
      </categories>
      <tags>
        <tag>language</tag>
      </tags>
  </entry>
  <entry>
    <title>本人常用小工具安利</title>
    <url>/posts/aef52be2.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　由于 Shaun 目前使用最多的是 Windows 系统，所以以下推荐的软件基本都是 Windows 下的软件，全凭 Shaun 主观感觉推荐，也算是个人备份吧。</p>
<p>　　首先推荐的自然是装机软件 <a href="https://www.ezbsystems.com/ultraiso/download.htm"><strong>ULTRAISO</strong></a>，下个绿色版就好，只有 1M 多一点 或者 <a href="https://github.com/pbatard/rufus"><strong>Rufus</strong></a> 好像也不错。下载 Windows 镜像的地方推荐为：<a href="https://msdn.itellyou.cn/"><strong>MSDN，I Tell You</strong></a>。接下来就是正式的软件推荐篇了：</p>
<span id="more"></span>
<h2 id="大众篇">大众篇</h2>
<p>　　首先推荐浏览器：首选的自然是 <a href="https://www.google.com/chrome/browser/thankyou.html?standalone=1&amp;statcb=1&amp;installdataindex=defaultbrowser"><strong>Chrome</strong></a> 和 <a href="https://www.mozilla.org/zh-CN/firefox/organizations/all/"><strong>Firefox</strong></a>，还有一个比较偏门的是 <a href="https://www.torproject.org/projects/torbrowser.html.en"><strong>Tor Browser</strong></a>（如果在一些特殊时段，各种番（fang）茄（qiang）工具都失效的情况下，这个可以临时用用）。推荐完浏览器，自然也要玩浏览器，</p>
<p>这里极为推荐的是脚本管理插件：<a href="http://tampermonkey.net/"><strong>Tampermonkey</strong></a>（支持多种浏览器），有 Tampermonkey 和没 Tampermonkey 是两种浏览体验，会用 Tampermonkey 和没用 Tampermonkey 的是两个世界的人（ᖗ乛◡乛ᖘ），Tampermonkey 是通过 Javascript 改变浏览器的，顺便推荐几个常用的脚本：1、<a href="https://greasyfork.org/zh-CN/scripts/14716-%E6%8A%A4%E7%9C%BC%E8%84%9A%E6%9C%AC">护眼脚本</a>；2、<a href="https://greasyfork.org/zh-CN/scripts/10433-super-preloaderplus-one/code">Super_preloaderPlus_one</a>；3、<a href="https://greasyfork.org/zh-CN/scripts/17800-%E8%A7%A3%E5%86%B3%E7%99%BE%E5%BA%A6%E4%BA%91%E5%A4%A7%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E9%99%90%E5%88%B6">解除百度云大文件下载限制</a>（这个配合 IDM 食用效果最佳）；4、<a href="https://greasyfork.org/zh-CN/scripts/26992-%E8%B4%B4%E5%90%A7%E5%85%A8%E8%83%BD%E5%8A%A9%E6%89%8B">贴吧全能助手</a>；5、<a href="https://greasyfork.org/zh-CN/scripts/36384-%E7%A0%B4%E8%A7%A3vip%E4%BC%9A%E5%91%98%E8%A7%86%E9%A2%91%E9%9B%86%E5%90%88">破解VIP会员视频集合</a>；6、<a href="https://greasyfork.org/zh-CN/scripts/27116-cat-mouse-translation">Cat Mouse Translation</a>；7、<a href="https://greasyfork.org/zh-CN/scripts/25718-%E8%A7%A3%E9%99%A4b%E7%AB%99%E5%8C%BA%E5%9F%9F%E9%99%90%E5%88%B6">解除B站区域限制</a>；8、<a href="https://greasyfork.org/zh-CN/scripts/30879-bye-flash-hello-html5-%E5%86%8D%E8%A7%81flash-%E4%BD%A0%E5%A5%BDhtml5">bye-flash-hello-html5 | 再见flash 你好html5</a>；９、<a href="https://greasyfork.org/zh-CN/scripts/28497-remove-web-limits">网页限制解除(改)</a>。再顺便说一下这两个浏览器中一些比较好用的插件和好看的主题吧。</p>
<p>Firefox 最新版的插件 Shaun 目前还没发现几个好用的，但是 <a href="https://adblockplus.org/">Adblock Plus</a> 绝对是必须要装的，Firefox 的主题 Shaun 目前在用为 <a href="https://addons.mozilla.org/zh-CN/firefox/addon/blue-space-2/">Blue space 2</a> ；</p>
<p>而 Chrome 中好用的插件就有很多了，首先自然也是 Adblock Plus，有一个 <a href="http://autopagerize.net/">AutoPagerize</a> 插件可以替代 Super_preloaderPlus_one 脚本，还有一个 <a href="https://chrome.google.com/webstore/detail/%E5%88%92%E8%AF%8D%E7%BF%BB%E8%AF%91/ikhdkkncnoglghljlkmcimlnlhkeamad?hl=zh-CN">划词翻译</a> 可以替换 Cat Mouse Translation 脚本，由于 Chrome 没有撤销关闭的标签按钮，只能通过快捷键 Crtl+Shift+T 操作，对于 Shaun 这种习惯用 Firefox 恢复按钮的人来说这很不人性化，所以只能使用 <a href="https://chrome.google.com/webstore/detail/simpleundoclose/emhohdghchmjepmigjojkehidlielknj?hl=zh-CN">SimpleUndoClose</a> 插件来代替了，当然番茄之所以推荐使用 Chrome 有很大一部分原因在于 Chrome 中有一代理神器 <a href="https://chrome.google.com/webstore/detail/proxy-switchyomega/padekgcemlokbadohgkifijomclgjgif?hl=zh-CN">Proxy SwitchyOmega</a>，好像也正在开发 Firefox 版的 Proxy SwitchyOmega，已经在 Firefox 测试版上使用了，Chrome 的主题 Shaun 目前在用的为 <a href="https://chrome.google.com/webstore/detail/blue-space-sunset-chrome/nndfdjfoclbidmgpmbelcieibgjjfdog">Blue Space Sunset Chrome Theme</a> ，浏览器相关的东西就推荐到这里了，接下来推荐下载工具吧。</p>
<p>附浏览器使用小技巧，有时点击链接不会新建标签页，只是在原标签页刷新，这不符合国人的使用习惯，这时可按住 Crtl 键再点击链接，这时会强制使用新标签页打开链接。</p>
<p>　　下载工具首推的自然是 <a href="https://www.internetdownloadmanager.com/download.html"><strong>IDM</strong></a>，全称是：Internet Download Manager；种子和磁力链接的下载工具推荐 <a href="http://www.utorrent.com/intl/zh/"><strong>μtorrent</strong></a> 或者 <a href="http://www.bittorrent.com/bittorrent-free"><strong>BitTorrent</strong></a>，好像还有一个 <a href="https://www.qbittorrent.org/download.php"><strong>qBittorrent</strong></a> ；至于迅雷，勉强推荐个极速版吧，最后一版为 ThunderSpeed1.0.35.366。还有一款免费的下载工具 <a href="https://www.freedownloadmanager.org/">Free Download Manager</a> 也还不错，可以一定程度上替代 IDM。</p>
<p>　　解压缩工具首推的是 <a href="https://www.bandisoft.com/bandizip/cn/"><strong>Bandizip</strong></a>（ta家的图片浏览器 <a href="https://www.bandisoft.com/honeyview/"><strong>Honeyview</strong></a> 也还不错），其次 <a href="http://www.7-zip.org/"><strong>7-Zip</strong></a>，最后是 <a href="https://www.win-rar.com/download.html"><strong>WinRAR</strong></a>（主要是最近版本的广告太恼火，好像 5.2 版本没广告），BTW：IDM 下载百度云的大文件可能会造成部分文件损坏，这时可能需要 WinRAR 的修复工具去修复受损的压缩文件（具体操作为用 WinRAR 打开损坏的压缩文件，选中菜单栏的“<strong>工具</strong>”==》“<strong>修复压缩文件</strong>”），才能解压出正常文件。※附：</p>
<blockquote>
<p>其实 WinRAR 官方也有无广告版的，只是下载链接被隐藏，这位大佬：<a href="http://blog.sina.com.cn/cuibin903"><strong>武文隹山</strong></a>发现了，具体可参考：</p>
<ol type="1">
<li><p><a href="http://blog.sina.com.cn/s/blog_4155bb1d0102x5dh.html">WinRAR官方不带弹窗广告的简体中文版</a>，其隐藏的链接为：</p>
<blockquote>
<p>WinRAR5.4官方无广告简体中文版64位 <a href="http://www.win-rar.com/fileadmin/winrar-versions/sc20160819/wrr/winrar-x64-540sc.exe">下载链接</a>：</p>
<p><a href="http://www.win-rar.com/fileadmin/winrar-versions/sc20160819/wrr/winrar-x64-540sc.exe" class="uri">http://www.win-rar.com/fileadmin/winrar-versions/sc20160819/wrr/winrar-x64-540sc.exe</a></p>
<p>WinRAR5.4官方无广告简体中文版32位 <a href="http://www.win-rar.com/fileadmin/winrar-versions/sc20160819/wrr/winrar-x32-540sc.exe">下载链接</a>：</p>
<p><a href="http://www.win-rar.com/fileadmin/winrar-versions/sc20160819/wrr/winrar-x32-540sc.exe" class="uri">http://www.win-rar.com/fileadmin/winrar-versions/sc20160819/wrr/winrar-x32-540sc.exe</a></p>
</blockquote></li>
<li><p><a href="http://blog.sina.com.cn/s/blog_4155bb1d0102xxmr.html">WinRAR5.5官方不带弹窗广告的简体中文版</a>，具体链接为：</p>
<blockquote>
<p>WinRAR v5.50 简体中文官方版（试用版，注册后没有广告弹窗！）</p>
<p>32位：<a href="http://www.win-rar.com/fileadmin/winrar-versions/sc20170830/wrr/wrar550sc.exe" class="uri">http://www.win-rar.com/fileadmin/winrar-versions/sc20170830/wrr/wrar550sc.exe</a></p>
<p>64位：<a href="http://www.win-rar.com/fileadmin/winrar-versions/sc20170830/wrr/winrar-x64-550sc.exe" class="uri">http://www.win-rar.com/fileadmin/winrar-versions/sc20170830/wrr/winrar-x64-550sc.exe</a></p>
</blockquote>
<p>列位看官应该从下载链接中发现了其中的规律（๑乛◡乛๑）。</p></li>
</ol>
</blockquote>
<p>　　拼音输入法，Shaun 使用的是 <a href="https://pinyin.sogou.com/zhihui/"><strong>搜狗拼音智慧版</strong></a>，搜狗拼音的皮肤 Shaun 选择 <a href="https://pinyin.sogou.com/skins/detail/view/info/418138">雨后莲色</a>，不过有人说 Win10 自带的微软拼音也还行。</p>
<p>　　至于清理垃圾的可以用 <a href="https://www.iobit.com/en/advancedsystemcarefree.php"><strong>Advanced SystemCare</strong></a>（ASC），也可以用 <a href="https://www.piriform.com/ccleaner/download"><strong>CCleaner</strong></a> ，至于 Win10 不需要装杀毒软件，国内的的什么 360 全家桶、百度全家桶、腾讯全家桶（诶，好像就差阿里全家桶了，什么时候阿里再来一个，就装个 BAT 全家桶 （๑乛◡乛๑））可以丢了 （(╯°□°）╯︵ ┻━┻）。</p>
<p>　　QQ 还是用 <a href="https://tim.qq.com/"><strong>TIM</strong></a> 版吧。</p>
<p>　　播放器推荐的是 <a href="https://potplayer.daum.net/"><strong>Potplayer</strong></a>。不过有一款解码工具叫 <a href="https://tieba.baidu.com/f?kw=%E7%BB%88%E6%9E%81%E8%A7%A3%E7%A0%81&amp;ie=utf-8"><strong>终极解码</strong></a>，可以充当播放器（很多人确实把它当播放器用，比如 Shaun （๑乛◡乛๑））。</p>
<p>　　音乐软件 Shaun 用 <a href="https://music.163.com/">网易云音乐</a>（等升到 10 级就把它卸了，只听本地音乐）。</p>
<p>　　PDF 阅读器还是推荐 <a href="https://acrobat.adobe.com/cn/zh-Hans/free-trial-download.html"><strong>Adobe Acrobat_DC</strong></a>，毕竟能和 Office 联合使用，有时 Word 转 PDF 需要加密就靠它了。</p>
<p>　　截图工具推荐 <a href="http://www.faststone.org/download.htm"><strong>FastStone Capture</strong></a>（<em>FSCapture</em>），国人的 <a href="https://zh.snipaste.com/index.html">Snipaste</a> 也非常不错。</p>
<h2 id="小众篇">小众篇</h2>
<p>　　远程控制工具当然推荐 <a href="https://www.teamviewer.com/zhCN/"><strong>TeamViewer</strong></a>。</p>
<p>　　文件管理相关强推 搜索工具 <a href="https://www.voidtools.com/downloads/"><strong>Everything</strong></a> 和文件资源管理器（即 Windows 快捷键「<strong>Win+E</strong>」打开的「<strong>我的电脑</strong>」）增强工具 <a href="http://www.listary.com/"><strong>Listary</strong></a> （有个开源实现的同类产品 <a href="http://www.wox.one/"><strong>Wox</strong></a> ，还有国产的 <a href="http://www.huoying666.com/"><strong>火萤酱</strong></a> 也很不错，而且功能更全且附带一些实用小工具），这两个工具有重叠的地方，如果硬要只装一个的话推荐后者。还有一个文件管理器增强工具 <a href="http://qttabbar.wikidot.com/"><strong>QTTabBar</strong></a> ，可以为文件管理器增加标签页，类似于浏览器标签页那种，当然还有其它一些功能。当然 Windows 下最强的文件管理器当属 <a href="http://www.ghisler.com/"><strong>Total Commander</strong></a>，只是学习成本略高。</p>
<p>　　快捷键程序快速启动工具 <a href="https://github.com/hui-Zz/RunAny"><strong>RunAny</strong></a> ，修改配置文件可以通过快捷键快速启动任意程序，以任意程序打开文件，该工具集成 Everything 和支持 <a href="https://autohotkey.com/"><strong>AutoHotkey</strong></a> 热键格式。</p>
<p>　　<a href="http://www.office-tabs.com/"><strong>Office Tabs</strong></a> 给 Microsoft Office 添加标签页界面，类似于浏览器标签页那种，以实现文档快速切换。</p>
<p>　　<a href="https://www.moo0.com/software/SystemMonitor/"><strong>Moo0 System Monitor</strong></a> 系统监视器，可视化监控内存 / 磁盘 / 网络 / CPU 等运行状态。</p>
<p><strong><em>再推荐一些程序员的工具吧。</em></strong></p>
<p>　　首先当然是编辑器（可别和编译器搞混了），Shaun 就不加入 Vim 和 Emacs 的党争了，就直接推荐 <a href="https://code.visualstudio.com/"><strong>VS Code</strong></a>吧（巨硬出品，必属精品（^_^））。</p>
<p>　　Windows 下的命令行没一个好用的，要真矮子里面挑高个的话，只能推荐 <a href="https://git-scm.com/downloads"><strong>Git Bash</strong></a> 了，其实以前有个 Babun 也挺好用的，可惜早已停止更新。但是 Git Bash 有时输出中文会乱码，Windows 下真正的命令行神器是 <a href="http://cmder.net/"><strong>Cmder</strong></a>，完整包直接集成 Git for Windows，也就是包含 Git Bash，mini 包只包含基本命令行工具，关于 Cmder 的一些设置和用法可参考 <a href="https://jeffjade.com/2016/01/13/2016-01-13-windows-software-cmder/">Win下必备神器之Cmder</a>，解压之后为了方便通过右键菜单使用 Cmder，需要在配置好之后以管理员方式执行 <code>Cmder.exe /REGISTER ALL</code> 命令。</p>
<p>　　Markdown 编辑器推荐的是 <a href="https://typora.io/#download"><strong>Typora</strong></a>，不过现在还是 Beta 版，也还能使用，期待正式版，希望到时即使收费的话也能继续推出一个免费版。（推出正式版看看效果怎么样吧，如果真的很不错就去支持一下，如果改进不大的话我还是老老实实继续用 beta 版吧）。</p>
<p>　　在 VS 下写 C++ 自然少不了 <a href="https://www.wholetomato.com/"><strong>Visual Assist X</strong></a> 这款插件，用 OpenCV 的自然少不了 <a href="https://marketplace.visualstudio.com/items?itemName=WolfKienzle.ImageWatch"><strong>ImageWatch</strong></a>（ <a href="https://marketplace.visualstudio.com/items?itemName=VisualCPPTeam.ImageWatch2017">VS2017版ImageWatch</a> ）这款神器。</p>
<p>　　编程的字体 Shaun 目前在用是 <a href="http://www.vimer.cn/wp-content/uploads/2009/11/arimonnew.ttf"><strong>Arial monospaced for SAP(优化版)</strong></a>（<a href="http://www.vimer.cn/archives/396.html/comment-page-1" class="uri">http://www.vimer.cn/archives/396.html/comment-page-1</a>），背景颜色使用护眼色：R: 204，G: 232，B: 207。</p>
<p>　　代理工具：Shaun 使用的是 <a href="https://github.com/XX-net/XX-Net"><strong>XX-Net</strong></a> 和 <a href="https://getlantern.org/zh_CN/"><strong>Lantern</strong></a>，非特殊情况还是很好用的，还有比较推荐的是 <a href="https://psiphon3.com/zh/download.html"><strong>赛风</strong></a>。</p>
<h2 id="偏门篇">偏门篇</h2>
<p>　　鼠标手势软件 <a href="http://www.yingdev.com/projects/wgestures"><strong>WGestures</strong></a>，可以利用鼠标手势做一些前进后退，复制粘贴搜索等简单操作。</p>
<p>　　<a href="http://www.yingdev.com/projects/tickeys"><strong>Tickeys</strong></a>，让打字发出音效。</p>
<p>　　Windows 系统优（mei）化工具 <a href="http://www.chuyu.me/zh-Hans/index.html"><strong>Dism++</strong></a> ，桌面美化工具可以用雨滴桌面 <a href="https://www.rainmeter.net/"><strong>Rainmeter</strong></a>，或<a href="http://mofang.ruanmei.com/">软媒魔方<strong><em>绿色版</em></strong></a>（<strong>※注：</strong>软媒魔方一定要是绿色版），桌面美化工具需要占用一定的配置，配置不高的老电脑还是别用比较好。</p>
<h2 id="后记">后记</h2>
<p>如果以后碰到更多有意思的小东西再和大家分享吧 ↖(^ω^)↗。</p>
]]></content>
      <categories>
        <category>Share</category>
      </categories>
      <tags>
        <tag>record</tag>
      </tags>
  </entry>
  <entry>
    <title>网页菜单纯 css 实现</title>
    <url>/posts/70a807da.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　最近搞了些前端的工作，本来做菜单栏的时候想直接用 bootstrap 的，但是感觉 bootstrap 太大了，而且依赖有点多，在 webpack 中也不是很好打包（虽然可以绕过去），所以就索性自己在网上找了一些实现方式，改改感觉也还可以。这次主要实现了两种菜单栏，具体如下。</p>
<span id="more"></span>
<h2 id="鼠标悬停下拉菜单">鼠标悬停下拉菜单</h2>
<p>　　鼠标悬停下拉菜单应该是最常见的一种菜单栏了，当鼠标悬停在菜单栏上时，子菜单缓缓下拉，看起来就很舒服，用 flex 布局结合列表也很好实现（不用像以前那种 <code>float</code> 了，舒服）。具体实现方式如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="HTML"><div class="code-copy"></div><figure class="highlight hljs html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="css"></span></span><br><span class="line"><span class="css">    <span class="selector-class">.flex-body</span> &#123;</span></span><br><span class="line"><span class="css">        <span class="attribute">display</span>: flex;</span></span><br><span class="line"><span class="css">        <span class="attribute">flex-direction</span>: column;</span></span><br><span class="line"><span class="css">    &#125;</span></span><br><span class="line"><span class="css"></span></span><br><span class="line"><span class="css">    <span class="selector-tag">header</span> &#123;</span></span><br><span class="line"><span class="css">        <span class="attribute">z-index</span>: <span class="number">1</span>;</span></span><br><span class="line"><span class="css">    &#125;</span></span><br><span class="line"><span class="css"></span></span><br><span class="line"><span class="css">    <span class="selector-tag">ul</span>,</span></span><br><span class="line"><span class="css">    <span class="selector-tag">ul</span> <span class="selector-tag">li</span> &#123;</span></span><br><span class="line"><span class="css">        <span class="attribute">list-style</span>: none;</span></span><br><span class="line"><span class="css">        <span class="attribute">margin</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">padding</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="css">    &#125;</span></span><br><span class="line"><span class="css"></span></span><br><span class="line"><span class="css">    <span class="selector-class">.menu</span> &#123;</span></span><br><span class="line"><span class="css">        <span class="attribute">display</span>: flex;</span></span><br><span class="line"><span class="css">        <span class="attribute">justify-content</span>: start;</span></span><br><span class="line"><span class="css">    &#125;</span></span><br><span class="line"><span class="css"></span></span><br><span class="line"><span class="css">    <span class="selector-tag">ul</span> <span class="selector-tag">li</span> &#123;</span></span><br><span class="line"><span class="css">        <span class="attribute">width</span>: <span class="number">100px</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">height</span>: <span class="number">50px</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">line-height</span>: <span class="number">50px</span>;</span></span><br><span class="line"><span class="css">    &#125;</span></span><br><span class="line"><span class="css"></span></span><br><span class="line"><span class="css">    <span class="selector-class">.menu</span> <span class="selector-tag">li</span> <span class="selector-class">.submenu</span> &#123;</span></span><br><span class="line"><span class="css">        <span class="comment">/* display: none; */</span></span></span><br><span class="line"><span class="css">        <span class="attribute">background-color</span>: aqua;</span></span><br><span class="line"><span class="css">    &#125;</span></span><br><span class="line"><span class="css"></span></span><br><span class="line"><span class="css">    <span class="selector-class">.submenu</span> <span class="selector-tag">li</span> &#123;</span></span><br><span class="line"><span class="css">        <span class="attribute">height</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">line-height</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">opacity</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">visibility</span>: hidden;</span></span><br><span class="line"><span class="css">    &#125;</span></span><br><span class="line"><span class="css"></span></span><br><span class="line"><span class="css">    <span class="selector-class">.menu</span> <span class="selector-tag">li</span><span class="selector-pseudo">:hover</span> <span class="selector-class">.submenu</span> <span class="selector-tag">li</span> &#123;</span></span><br><span class="line"><span class="css">        <span class="comment">/* display: block; */</span></span></span><br><span class="line"><span class="css">        <span class="attribute">height</span>: <span class="number">50px</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">line-height</span>: <span class="number">50px</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">opacity</span>: <span class="number">1</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">visibility</span>: visible;</span></span><br><span class="line"><span class="css">        <span class="attribute">transition</span>: all <span class="number">1s</span>;</span></span><br><span class="line"><span class="css">    &#125;</span></span><br><span class="line"><span class="css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;flex-body&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">header</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;menu&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span>&gt;</span>menu1<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;submenu&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span>&gt;</span>submenu1<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span>&gt;</span>submenu1<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span>&gt;</span>submenu1<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span>&gt;</span>menu2<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;submenu&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span>&gt;</span>submenu1<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span>&gt;</span>submenu1<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span>&gt;</span>submenu1<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span>&gt;</span>menu3<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;submenu&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span>&gt;</span>submenu1<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span>&gt;</span>submenu1<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span>&gt;</span>submenu1<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">main</span>&gt;</span>mainmainmainmainmainmainmainmainmainmain<span class="tag">&lt;/<span class="name">main</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure></div>
<p>　　<strong><em>※注：</em></strong> 实现该菜单栏有两个需要注意的点：1、不能用 <code>display: none</code> 和 <code>block</code> 来使子菜单消失或出现，因为这样会造成缓缓下拉的动画失效，<code>transition</code> 并不支持 <code>display</code>，所以只能用 <code>visibility</code> 和 <code>height</code> 来共同实现，以达到下拉动画效果；2、因为使用了 <code>flex</code> 布局，所以 <code>z-index</code> 只对同级 <code>flex-item</code> 有效，所以为防止菜单栏下面的内容出现在子菜单之上，即将子菜单栏位于最上层，需要将整个页面的布局都设置为 <code>flex</code>，并使 <code>header</code> 的 <code>z-index</code> 最大，如此才能保证子菜单的菜单覆盖 <code>main</code> 中的内容，不然就会有重叠干扰现象。</p>
<h2 id="鼠标点击手风琴菜单">鼠标点击手风琴菜单</h2>
<p>　　手风琴特效也算是非常常见的了，一般的手风琴是鼠标悬停展开，这种比较好实现，难的是如何保持这种展开状态，<code>focus</code> 可以短暂保持展开状态，但是不能点击其他地方，局限性太大。所以需要引入其它的东西来记录这种展开状态，可以用 <code>checkbox</code> 或 <code>radio</code> 的 <code>checked</code> 来记录这种状态，从而只用 css 即可实现该菜单，具体实现如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="HTML"><div class="code-copy"></div><figure class="highlight hljs html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="css"></span></span><br><span class="line"><span class="css">    <span class="selector-tag">input</span><span class="selector-attr">[data-prop=<span class="string">&quot;menu-recorder&quot;</span>]</span> &#123;</span></span><br><span class="line"><span class="css">        <span class="attribute">display</span>: none;</span></span><br><span class="line"><span class="css">    &#125;</span></span><br><span class="line"><span class="css"></span></span><br><span class="line"><span class="css">    <span class="selector-class">.menu-title</span> &#123;</span></span><br><span class="line"><span class="css">        <span class="attribute">display</span>: block;</span></span><br><span class="line"><span class="css">        <span class="attribute">width</span>: <span class="number">500px</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">height</span>: <span class="number">50px</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">line-height</span>: <span class="number">50px</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">border</span>: <span class="number">1px</span> solid black;</span></span><br><span class="line"><span class="css">    &#125;</span></span><br><span class="line"><span class="css"></span></span><br><span class="line"><span class="css">    <span class="selector-class">.menu-content</span> &#123;</span></span><br><span class="line"><span class="css">        <span class="attribute">width</span>: <span class="number">500px</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">max-height</span>: <span class="number">100px</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">overflow-y</span>: auto;</span></span><br><span class="line"><span class="css">    &#125;</span></span><br><span class="line"><span class="css"></span></span><br><span class="line"><span class="css">    <span class="selector-class">.menu-content</span>&gt;<span class="selector-tag">li</span> &#123;</span></span><br><span class="line"><span class="css">        <span class="attribute">height</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">line-height</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">overflow</span>: auto;</span></span><br><span class="line"><span class="css">        <span class="attribute">opacity</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">visibility</span>: hidden;</span></span><br><span class="line"><span class="css">        <span class="attribute">transition</span>: all <span class="number">1s</span>;</span></span><br><span class="line"><span class="css">    &#125;</span></span><br><span class="line"><span class="css"></span></span><br><span class="line"><span class="css">    <span class="selector-tag">input</span><span class="selector-attr">[data-prop=<span class="string">&quot;menu-recorder&quot;</span>]</span><span class="selector-pseudo">:checked</span>+<span class="selector-class">.menu-content</span>&gt;<span class="selector-tag">li</span> &#123;</span></span><br><span class="line"><span class="css">        <span class="attribute">height</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">line-height</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">opacity</span>: <span class="number">1</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">visibility</span>: visible;</span></span><br><span class="line"><span class="css">        <span class="attribute">transition</span>: all <span class="number">1s</span>;</span></span><br><span class="line"><span class="css">    &#125;</span></span><br><span class="line"><span class="css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;accordion-menu&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;menu-item&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">&quot;menu-title&quot;</span> <span class="attr">for</span>=<span class="string">&quot;menu1&quot;</span>&gt;</span>menu1<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;menu1&quot;</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">data-prop</span>=<span class="string">&quot;menu-recorder&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;menu-content&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;menu-item&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">&quot;menu-title&quot;</span> <span class="attr">for</span>=<span class="string">&quot;menu2&quot;</span>&gt;</span>menu2<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;menu2&quot;</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">data-prop</span>=<span class="string">&quot;menu-recorder&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;menu-content&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;menu-item&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">&quot;menu-title&quot;</span> <span class="attr">for</span>=<span class="string">&quot;menu3&quot;</span>&gt;</span>menu3<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;menu3&quot;</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">data-prop</span>=<span class="string">&quot;menu-recorder&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;menu-content&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;menu-item&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">&quot;menu-title&quot;</span> <span class="attr">for</span>=<span class="string">&quot;menu4&quot;</span>&gt;</span>menu4<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;menu4&quot;</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">data-prop</span>=<span class="string">&quot;menu-recorder&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;menu-content&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure></div>
<p>　　这里需要注意一点的就是 height 从 0 到 100% 并不会触发 transition 渐变动画，而是需要确切的高度值变化才能触发，所以上文这里添加了个 <code>&lt;li&gt;</code> 标签，直接在该标签上添加动画，还有一种就是在 <code>.menu-content</code> 上设定确定的 <code>max-height</code>，也能触发动画，但是有个缺点就是前后 <code>max-height</code> 的差距太大时，动画效果就很不理想了，这时可能只能依靠 js 了。上文中 <code>checkbox</code> 也可用 <code>radio</code> 替换，效果略有差异，一个是能全部展开或收起，而另一个则是能且仅能展开一个。</p>
<h2 id="tab-标签页切换菜单">Tab 标签页切换菜单</h2>
<p>　　这个菜单和上面那个菜单的实现非常相似，先上代码：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="HTML"><div class="code-copy"></div><figure class="highlight hljs html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="css"></span></span><br><span class="line"><span class="css">    <span class="selector-class">.tab-menu</span> &#123;</span></span><br><span class="line"><span class="css">        <span class="attribute">display</span>: flex;</span></span><br><span class="line"><span class="css">        <span class="attribute">position</span>: relative;</span></span><br><span class="line"><span class="css">        <span class="attribute">width</span>: <span class="number">500px</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">height</span>: <span class="number">300px</span>;</span></span><br><span class="line"><span class="css">    &#125;</span></span><br><span class="line"><span class="css"></span></span><br><span class="line"><span class="css">    <span class="selector-tag">input</span><span class="selector-attr">[data-prop=<span class="string">&quot;menu-recorder&quot;</span>]</span> &#123;</span></span><br><span class="line"><span class="css">        <span class="attribute">display</span>: none;</span></span><br><span class="line"><span class="css">    &#125;</span></span><br><span class="line"><span class="css"></span></span><br><span class="line"><span class="css">    <span class="selector-class">.menu-title</span> &#123;</span></span><br><span class="line"><span class="css">        <span class="attribute">display</span>: block;</span></span><br><span class="line"><span class="css">        <span class="attribute">width</span>: <span class="number">100px</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">line-height</span>: <span class="number">50px</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">text-align</span>: center;</span></span><br><span class="line"><span class="css">        <span class="attribute">border</span>: <span class="number">1px</span> solid black;</span></span><br><span class="line"><span class="css">        <span class="attribute">border-right</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">box-sizing</span>: border-box;</span></span><br><span class="line"><span class="css">        <span class="attribute">transition</span>: all <span class="number">1s</span>;</span></span><br><span class="line"><span class="css">    &#125;</span></span><br><span class="line"><span class="css"></span></span><br><span class="line"><span class="css">    <span class="selector-class">.tab-menu</span> <span class="selector-class">.menu-item</span><span class="selector-pseudo">:last-child</span> <span class="selector-class">.menu-title</span> &#123;</span></span><br><span class="line"><span class="css">        <span class="attribute">border-right</span>: <span class="number">1px</span> solid black;</span></span><br><span class="line"><span class="css">    &#125;</span></span><br><span class="line"><span class="css"></span></span><br><span class="line"><span class="css">    <span class="selector-class">.menu-content</span> &#123;</span></span><br><span class="line"><span class="css">        <span class="attribute">position</span>: absolute;</span></span><br><span class="line"><span class="css">        <span class="attribute">left</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">top</span>: <span class="number">51px</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">height</span>: <span class="built_in">calc</span>(<span class="number">100%</span> - <span class="number">50px</span>);</span></span><br><span class="line"><span class="css">        <span class="attribute">overflow-y</span>: auto;</span></span><br><span class="line"><span class="css">        <span class="attribute">width</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#000</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">box-sizing</span>: border-box;</span></span><br><span class="line"><span class="css">        <span class="attribute">font-size</span>: <span class="number">24px</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">text-align</span>: center;</span></span><br><span class="line"><span class="css">        <span class="attribute">opacity</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">visibility</span>: hidden;</span></span><br><span class="line"><span class="css">        <span class="attribute">transition</span>: all <span class="number">1s</span>;</span></span><br><span class="line"><span class="css"></span></span><br><span class="line"><span class="css">    &#125;</span></span><br><span class="line"><span class="css"></span></span><br><span class="line"><span class="css">    <span class="selector-tag">input</span><span class="selector-attr">[data-prop=<span class="string">&quot;menu-recorder&quot;</span>]</span><span class="selector-pseudo">:checked</span>+<span class="selector-class">.menu-content</span> &#123;</span></span><br><span class="line"><span class="css">        <span class="attribute">opacity</span>: <span class="number">1</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">visibility</span>: visible;</span></span><br><span class="line"><span class="css">        <span class="attribute">transition</span>: all <span class="number">1s</span>;</span></span><br><span class="line"><span class="css">    &#125;</span></span><br><span class="line"><span class="css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;tab-menu&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;menu-item&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">&quot;menu-title&quot;</span> <span class="attr">for</span>=<span class="string">&quot;menu1&quot;</span>&gt;</span>menu1<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;menu1&quot;</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;tab-control&quot;</span> <span class="attr">data-prop</span>=<span class="string">&quot;menu-recorder&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;menu-content&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;menu-item&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">&quot;menu-title&quot;</span> <span class="attr">for</span>=<span class="string">&quot;menu2&quot;</span>&gt;</span>menu2<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;menu2&quot;</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;tab-control&quot;</span> <span class="attr">data-prop</span>=<span class="string">&quot;menu-recorder&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;menu-content&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;menu-item&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">&quot;menu-title&quot;</span> <span class="attr">for</span>=<span class="string">&quot;menu3&quot;</span>&gt;</span>menu3<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;menu3&quot;</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;tab-control&quot;</span> <span class="attr">data-prop</span>=<span class="string">&quot;menu-recorder&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;menu-content&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;menu-item&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">&quot;menu-title&quot;</span> <span class="attr">for</span>=<span class="string">&quot;menu4&quot;</span>&gt;</span>menu4<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;menu4&quot;</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;tab-control&quot;</span> <span class="attr">data-prop</span>=<span class="string">&quot;menu-recorder&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;menu-content&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>test<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure></div>
<p>　　从代码上看关键点就是 <code>.menu-content</code> 的定位方式了，采用了绝对定位，并将整个菜单栏设置为相对定位，以保证所有 tab 标签页内容位置和大小保持一致。当然 tab 标签页肯定是唯一的，所以只能用 <code>radio</code> 记录显示标签页了。其中为了保证 <code>.menu-title</code> 和 <code>.menu-content</code> 的边框不重叠，所以在 <code>.menu-title</code> 中只设置 <code>line-height</code>，而 <code>.menu-content</code> 的 <code>top</code> 比其多一个像素。</p>
<h2 id="后记">后记</h2>
<p>　　这三种菜单应该是最常见也是用的最多的了，纯 css 实现的方式也比较类似，无非就是 flex 布局以及借助 css3 强大的选择器功能（父类选择器不知要到猴年马月了，比较遗憾 😥），就能相对简单的实现了，当然借助一些 js 库或框架可能会更简单一些 ，但能用 css 为何不用呢 😄。</p>
<h2 id="参考资料">参考资料</h2>
<p>[1] <a href="https://blog.csdn.net/colorfulqq/article/details/79886331">利用flex实现的二级导航栏</a></p>
<p>[2] <a href="https://blog.csdn.net/touchingt/article/details/48630291">CSS3动画下拉菜单（当transition遇到display的坑）</a></p>
<p>[3] <a href="https://www.jqhtml.com/962.html">CSS3手风琴下拉菜单</a></p>
<p>[4] <a href="https://www.jianshu.com/p/cc0ac7845ded">教你两招用纯CSS写Tab切换</a></p>
]]></content>
      <categories>
        <category>Study</category>
      </categories>
      <tags>
        <tag>css</tag>
      </tags>
  </entry>
  <entry>
    <title>解决OpenCV-2.4.11调用摄像头显示拍摄视频出错问题</title>
    <url>/posts/509ee93b.html</url>
    <content><![CDATA[<p><font color=#FA8072>本文所用的 OpenCV 版本为 opencv-2.4.11，编程语言为 C++。</font></p>
<h2 id="前言">前言</h2>
<p>　　本文其实是以前在刚学 OpenCV 时遇到的一个问题，当时我的环境还是：Win7，VS2010，opencv-2.4.11。当初就记录了下来，现在再来重新梳理一下。</p>
<span id="more"></span>
<h2 id="问题篇">问题篇</h2>
<p><strong>问题描述：</strong>使用 OpenCV-2.4.11 调用摄像头显示拍摄视频时报 <font color=#FA8072>runtime error</font>，控制台窗口出现 <font color=#FA8072>OpenCV Error: Assertion failed (size.width&gt;0 &amp;&amp; size.height&gt;0) in cv::imshow, file ……...cpp, line 261</font>。</p>
<p><strong>解决办法：</strong>在显示图片时先判断是否有图像数据，如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!image.<span class="built_in">empty</span>()) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">imshow</span>(<span class="string">&quot;window&quot;</span>, image);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>或</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (image.data) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">imshow</span>(<span class="string">&quot;window&quot;</span>, image);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p><strong>原因可能是：</strong>用 imshow() 显示图像时，其 image 必须有数据，如果它为空则程序会报错，而一般打开摄像头会有一定时间的延迟，这时程序已经启动，而摄像头由于启动延迟，不一定能及时获取图像，造成要显示的 image 为空，因此报错。个人粗浅理解，板砖轻拍 ⊙﹏⊙b。</p>
<p>而网上有人也认为：</p>
<blockquote>
<ol type="1">
<li>我也是遇到这个问题，不过看到一个帖子写得不错（英文的），里面给出了一个可能的理由，就是我们用 opencv 打开视频的时候，会自动先监测摄像头有没有读到帧，如果没有，就会报错，然后再执行你的程序，加一个if判断就是跳过系统自己的判断，直接执行我们的程序。来自：<a href="https://zhidao.baidu.com/question/1831122325089024420.html" class="uri">https://zhidao.baidu.com/question/1831122325089024420.html</a></li>
<li>有人说的原因是在 VideoCapture 刚开始获取摄像头视频流的过程不返回信号，所以判断 Mat 是否为空，并不断循环去获取 Mat。来自：<a href="http://www.cnblogs.com/tiny656/p/3538115.html" class="uri">http://www.cnblogs.com/tiny656/p/3538115.html</a></li>
</ol>
</blockquote>
<p>附最终完整示例程序：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/core/core.hpp&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/imgproc/imgproc.hpp&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/highgui/highgui.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用摄像头</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">videoCaptureTest</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//cv::VideoCapture cap(0);  // 打开默认摄像头，参数0代表默认摄像头的ID</span></span><br><span class="line">    cv::VideoCapture cap;</span><br><span class="line">    cap.<span class="built_in">open</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 设置摄像头</span></span><br><span class="line">    cap.<span class="built_in">set</span>(CV_CAP_PROP_FRAME_WIDTH,<span class="number">640</span>);</span><br><span class="line">    cap.<span class="built_in">set</span>(CV_CAP_PROP_FRAME_HEIGHT,<span class="number">480</span>);</span><br><span class="line">    <span class="comment">// 确认是否成功打开摄像头</span></span><br><span class="line">    <span class="keyword">if</span> (!cap.<span class="built_in">isOpened</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;打开摄像头失败，退出！\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    cv::<span class="built_in">namedWindow</span>(<span class="string">&quot;Capture&quot;</span>, CV_WINDOW_AUTOSIZE|CV_WINDOW_FREERATIO);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cv::Mat frame;</span><br><span class="line">        cap &gt;&gt; frame;   <span class="comment">// 获取帧</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对摄像头获取的帧进行各种处理</span></span><br><span class="line">        <span class="keyword">if</span> (!frame.<span class="built_in">empty</span>()) <span class="comment">// 最好加上该判断，并在该判断中对帧进行处理</span></span><br><span class="line">        &#123;</span><br><span class="line">            cv::<span class="built_in">imshow</span>(<span class="string">&quot;Capture&quot;</span>, frame);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(cv::<span class="built_in">waitKey</span>(<span class="number">30</span>) &gt;= <span class="number">0</span>) <span class="keyword">break</span>; <span class="comment">// 每30ms取一帧</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">videoCaptureTest</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>　　其实也可以通过在获取帧时，反复获取帧，直到取到的帧有数据为止，这样就不需要判断语句了，直接显示即可，具体代码如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">    cap &gt;&gt; frame;</span><br><span class="line">&#125;<span class="keyword">while</span>(frame.<span class="built_in">empty</span>());</span><br><span class="line"></span><br><span class="line">cv::<span class="built_in">imshow</span>(<span class="string">&quot;Capture&quot;</span>, frame);</span><br></pre></td></tr></table></figure></div>
<p>参考自：<a href="https://stackoverflow.com/a/9285151" class="uri">https://stackoverflow.com/a/9285151</a> 。</p>
<h2 id="后记">后记</h2>
<p>　　本文还是当初在国内某平台写博客时写的，但现在再回头看，又稍微有了点新的思路，温故确实能知新 (*^__^*) 嘻嘻……。</p>
<h2 id="参考资料">参考资料</h2>
<p>[1] <a href="http://blog.sina.com.cn/s/blog_a3e7ccd6010105yn.html">OpenCV2.3使用摄像头和视频</a>（<a href="http://blog.sina.com.cn/s/articlelist_2749877462_3_1.html" class="uri">http://blog.sina.com.cn/s/articlelist_2749877462_3_1.html</a>）</p>
<p>[2] <a href="http://zhidao.baidu.com/link?url=pIM9Hr0-Yalk-uj8cm5ml0y91X92jJmPAXMKQ-1h7FXSPsrwTiD6_9Ngfq72hmxbVDjNE0aYTOmXCCVEryZvhNBJGW6FbsqjO6dbjVLEZt3">OpenCV Error: Assertion failed (size.width&gt;0 &amp;&amp; size.height&gt;0) in cv::imshow, fi 这个问题怎么办？</a></p>
<p>[3] <a href="http://blog.csdn.net/czl389/article/details/51031100">OpenCV打开摄像头出现运行错误OpenCV Error：Assertion failed (size.width&gt;0&amp;&amp;size.height&gt;0)in cv::imshow，……</a>（<a href="http://blog.csdn.net/czl389/article/category/6381887" class="uri">http://blog.csdn.net/czl389/article/category/6381887</a>）</p>
<p>[4] <a href="http://www.cnblogs.com/tiny656/p/3538115.html">[OpenCV]获取摄像头视频</a>（<a href="http://www.cnblogs.com/tiny656/category/550972.html" class="uri">http://www.cnblogs.com/tiny656/category/550972.html</a>）</p>
]]></content>
      <categories>
        <category>Problems</category>
      </categories>
      <tags>
        <tag>opencv</tag>
      </tags>
  </entry>
  <entry>
    <title>解决Qt中Qlabel显示OpenCV的Mat数据图像产生扭曲现象问题</title>
    <url>/posts/22c3daf1.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　曾写过一个程序，需要有一个界面，但 Shaun 不想使用 MFC，因缘巧合，在网上看到 Qt，就尝试用了一下，遂有此文。Shaun 的 Qt 版本为 qt-opensource-windows-x86-msvc2013-5.6.2，看其名字就知道该版本的 Qt 可以通过 Visual Studio 2013 开发 Qt 程序（各位看官猜的没错，Shaun 并没有直接使用 Qt Creator 开发 Qt 程序，而是通过 VS 开发 Qt 程序的 \(^o^)/），一来是熟悉 VS 开发，对 Qt Creator 完全没用过；二来是已经在 VS 配好全套的开发环境了（画外音：说白了就是懒嘛 ╭(╯^╰)╮）。但是在 VS 中开发 Qt 程序还需要一些其它的配置。</p>
<span id="more"></span>
<h2 id="准备篇">准备篇</h2>
<p>　　在 VS 中开发 Qt 程序首先需要安装一个 addin 外接程序，下载并安装 <a href="http://download.qt.io/archive/vsaddin/qt-vs-addin-1.2.5.exe">qt-vs-addin-1.2.5.exe</a>（<a href="http://download.qt.io/archive/vsaddin/" class="uri">http://download.qt.io/archive/vsaddin/</a>），（网上说该程序已不支持 VS2013 及以上版本的 VS，原因是 VS2013 及其以上版本的 VS 都不支持该种类型的插件，新版本的 VS 需要安装新型插件 <a href="http://download.qt.io/archive/vsaddin/qt-vs-tools-msvc2013-2.1.1.vsix">qt-vs-tools-msvc2013-2.1.1.vsix</a> 或 <a href="http://download.qt.io/archive/vsaddin/qt-vs-tools-msvc2015-2.1.1.vsix">qt-vs-tools-msvc2015-2.1.1.vsix</a>），但是经 Shaun 实测，Shaun 的 VS2013-update5 英文旗舰版通过 qt-vs-addin-1.2.5 编写 Qt 程序完全没问题，不过 VS2015 就不知道了，可能真需要安装新型插件。下载安装好相应的软件之后需要在 VS 中配置 Qt 环境，虽然不配置也能正常编译，但是会在 Qt 相关的语句下面出现红色波浪线，Shaun 轻微强迫症表示不能忍 ╭(╯^╰)╮。具体配置如下：</p>
<p>选中“<strong>VC++目录</strong>”，在“<strong>包含目录</strong>”中添加：</p>
<blockquote>
<p>C:\Qt\Qt5.6.2\5.6\msvc2013\include</p>
</blockquote>
<p>在“<strong>库目录</strong>”中添加：</p>
<blockquote>
<p>C:\Qt\Qt5.6.2\5.6\msvc2013\lib</p>
</blockquote>
<p>配置完成之后即可发现红色波浪线已消失。</p>
<h2 id="使用篇">使用篇</h2>
<p>　　VS 中如何开发 Qt 程序请详见参考资料，懒癌发作，不想写了 =_=（其实是因为要写的话只能贴图了，Shaun 表示不想使用图片 (╯﹏╰) ）。</p>
<h2 id="问题篇">问题篇</h2>
<p><strong>问题描述：</strong>Shaun 在用 Qt 显示 OpenCV 的 Mat 数据图像时，有时会发生扭曲现象（图像从对角线分开，两边颠倒，扭曲），有时却不会，为了撤了解决问题，查阅了相关资料，终于发现症结所在，原来是图片数据格式不符合 Qt 的图片数据格式。</p>
<p><strong>解决办法：</strong>正文来喽 ~\(≧▽≦)/~，就不说废话了，“Talk is cheap. Show you the code”，具体完整正确显示C++代码为：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">showMatWithQtQlabel</span><span class="params">(<span class="keyword">const</span> cv::Mat &amp;img, QLabel *label)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// [Qt中用QLabel显示OpenCV中Mat图像数据出现扭曲现象的解决](http://lovelittlebean.blog.163.com/blog/static/11658218620125208212189/)</span></span><br><span class="line">	QImage q_img;  </span><br><span class="line">	<span class="keyword">if</span>(img.<span class="built_in">channels</span>() == <span class="number">3</span>)    <span class="comment">// RGB image  </span></span><br><span class="line">	&#123;  </span><br><span class="line">		q_img = <span class="built_in">QImage</span>((<span class="keyword">const</span> uchar*)(img.data), img.cols, img.rows, img.cols*img.<span class="built_in">channels</span>(), QImage::Format_RGB888).<span class="built_in">rgbSwapped</span>();  </span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span> (img.<span class="built_in">channels</span>() == <span class="number">4</span>)	<span class="comment">// RGBA image  </span></span><br><span class="line">	&#123;</span><br><span class="line">		q_img = <span class="built_in">QImage</span>((<span class="keyword">const</span> uchar*)(img.data), img.cols, img.rows, img.cols*img.<span class="built_in">channels</span>(), QImage::Format_RGB32);  </span><br><span class="line">	&#125;<span class="keyword">else</span>              <span class="comment">// gray image  </span></span><br><span class="line">	&#123;  </span><br><span class="line">		q_img = <span class="built_in">QImage</span>((<span class="keyword">const</span> uchar*)(img.data), img.cols, img.rows, img.cols*img.<span class="built_in">channels</span>(), QImage::Format_Indexed8);  </span><br><span class="line">	&#125;  </span><br><span class="line"></span><br><span class="line">	<span class="comment">// -------------- 图片自适应label -------------------</span></span><br><span class="line">	QImage q_label_img = q_img.<span class="built_in">scaled</span>(label-&gt;<span class="built_in">size</span>(), Qt::IgnoreAspectRatio, Qt::SmoothTransformation); <span class="comment">// 图片自适应label大小	</span></span><br><span class="line">	label-&gt;<span class="built_in">setPixmap</span>(QPixmap::<span class="built_in">fromImage</span>(q_label_img));  <span class="comment">// 将图片显示到label上 </span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// -------------- label自适应图片 -------------------</span></span><br><span class="line">	<span class="comment">/*label-&gt;setPixmap(QPixmap::fromImage(q_img));  // 显示在label中</span></span><br><span class="line"><span class="comment">	label-&gt;resize(label-&gt;pixmap()-&gt;size());  // 改变label的尺寸以自适应图像</span></span><br><span class="line"><span class="comment">	label-&gt;show();  */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>　　rgbSwapped() 函数是为了使 Qt 中显示图形颜色更自然，因为 OpenCV 的 Mat 数据 RGB 图像是以 BGR 的顺序排列，而 Qt 中是以 RGB 的顺序排列，所以需要 rgbSwapped() 交换一下颜色通道排列顺序。</p>
<h2 id="附录">附录</h2>
<h3 id="摄像头数据采集问题">1、摄像头数据采集问题</h3>
<p>注意：如果是从摄像头实时采集显示图像，在显示时需先判断图像有没有数据</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (image.data)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// 执行显示操作</span></span><br><span class="line">  <span class="built_in">showMatWithQtQlabel</span>(mat, ui.label);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 执行其它操作...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>或</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!image.<span class="built_in">empty</span>())</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// 执行显示操作</span></span><br><span class="line">  <span class="built_in">showMatWithQtQlabel</span>(mat, ui.label);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 执行其它操作...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>具体原因可参考 Shaun 的一篇文章 <a href="https://cniter.github.io/posts/509ee93b.html">解决OpenCV-2.4.11调用摄像头显示拍摄视频出错问题</a> 。</p>
<h3 id="信号与槽的连接函数问题">2、信号与槽的连接函数问题</h3>
<p>Qt4 中信号与槽的连接函数语法为：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="built_in">connect</span>(&amp;theTimer,<span class="built_in">SIGNAL</span>(<span class="built_in">timeout</span>()),<span class="keyword">this</span>,<span class="built_in">SLOT</span>(<span class="built_in">getFrame</span>()));	<span class="comment">// 超时就去取下一帧</span></span><br></pre></td></tr></table></figure></div>
<p>而 Qt5 中信号与槽的连接函数新语法为：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="code"><pre><span class="line"><span class="built_in">connect</span>(&amp;theTimer, &amp;QTimer::timeout, <span class="keyword">this</span>, &amp;QtTest::getFrame);	<span class="comment">//超时就去取下一帧 </span></span><br></pre></td></tr></table></figure></div>
<p>推荐使用 Qt5 新语法，具体原因可参考 <a href="http://www.cnblogs.com/mushroom/p/5701330.html">qt5中信号和槽的新语法</a> 。</p>
<p><strong>个人粗浅理解：</strong>信号函数一般是 Qt 中控件的库函数，比如按钮控件 QButton 的 <code>QButton::clicked ()</code> 函数，定时器 QTimer 的 <code>QTimer::timeout ()</code> 等函数；而槽函数是响应函数，一般由用户自己编写，也可以使用 Qt 中库函数。</p>
<p>　　使用 Qt 中可能会遇到的一些错误请参考 <a href="http://www.cnblogs.com/csuftzzk/p/VS_Qt_Experience.html">使用VS2010开发Qt程序的一点经验</a>（<a href="http://www.cnblogs.com/csuftzzk/category/445772.html" class="uri">http://www.cnblogs.com/csuftzzk/category/445772.html</a>）。</p>
<h2 id="后记">后记</h2>
<p>　　本来其实就想把问题篇写出来的，毕竟主要就是想记录一下那个显示函数，但是感觉有点没头没尾，就把 VS 集成 Qt 开发环境也稍微写了一下，而使用篇确实是因为参考资料已经写的很详细了，所以就直接一笔带过了。</p>
<h2 id="参考资料">参考资料</h2>
<p>[1] <a href="http://blog.csdn.net/llh318724/article/details/7007661">QT +openCV 实现摄像头采集以及拍照功能</a>（<a href="http://blog.csdn.net/llh318724/article/category/930663" class="uri">http://blog.csdn.net/llh318724/article/category/930663</a>）</p>
<p>[2] <a href="http://blog.csdn.net/qqmindyourwill/article/details/50280233">VS2010 + QT5.2+ QT-VS-Addin1.2.2开发环境配置</a>（<a href="http://blog.csdn.net/qqmindyourwill/article/category/5990841" class="uri">http://blog.csdn.net/qqmindyourwill/article/category/5990841</a>）</p>
<p>[3] <a href="http://blog.csdn.net/fm0517/article/details/7476430">Qt+OpenCV界面</a>（<a href="http://blog.csdn.net/fm0517/article/category/1110960" class="uri">http://blog.csdn.net/fm0517/article/category/1110960</a>）</p>
<p>[4] <a href="http://blog.csdn.net/loveaborn/article/details/7680834">Qt中用QLabel显示OpenCV中Mat图像数据出现扭曲现象的解决</a>（<a href="http://blog.csdn.net/loveaborn/article/category/1164072" class="uri">http://blog.csdn.net/loveaborn/article/category/1164072</a>）</p>
]]></content>
      <categories>
        <category>Problems</category>
      </categories>
      <tags>
        <tag>opencv</tag>
        <tag>qt</tag>
      </tags>
  </entry>
  <entry>
    <title>解决无法打开某个网页问题</title>
    <url>/posts/376168c6.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　Shaun 最近在某台 Win10 的电脑中打开网页 <a href="https://www.typora.io/" class="uri">https://www.typora.io/</a> 时出现了问题，一直出现无法连接现象。</p>
<span id="more"></span>
<h2 id="问题篇">问题篇</h2>
<p>Chrome 中出现：</p>
<blockquote>
<p><strong>未连接到互联网</strong></p>
<p>请试试以下办法：</p>
<ul>
<li>检查网线、调制解调器和路由器</li>
<li>重新连接到 Wi-Fi 网络</li>
<li><a href="javascript:diagnoseErrors()">运行 Windows 网络诊断</a></li>
</ul>
<p>DNS_PROBE_FINISHED_NO_INTERNET</p>
</blockquote>
<p>Firefox 中出现：</p>
<blockquote>
<p>我们无法连接至 www.typora.io 的服务器。 如果确定此网址正确，您可以尝试：</p>
<ul>
<li>过会儿再重试。</li>
<li>检查您的网络连接是否正常。</li>
<li>如果您部署有网络防火墙，请检查 Firefox 是否已被授权访问网络。</li>
</ul>
</blockquote>
<p>手机和其它设备在同一网络下能正常连接，打开 host 文件也没发现域名被劫持的情况，挂代理也能连接上。</p>
<h2 id="解决方案篇">解决方案篇</h2>
<p>Shaun 尝试过的方法：</p>
<ol type="1">
<li><p>刷新 DNS 缓存：在命令行界面中输入 <code>ipconfig /flushdns</code>，无效；</p></li>
<li><p>改 DNS 服务器：把电脑的 dns 修改为首选 8.8.8.8，备用 114.114.114.114，和将首选改成 8.8.4.4 均无效；</p></li>
<li><p>Disable Path MTU discovery，具体操作方法为：</p>
<blockquote>
<p>单击“开始”，单击“运行”，键入 regedit，然后单击“确定”。</p>
<p>在注册表中找到下面的项： <code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters</code></p>
<p>找到<code>EnablePMTUDiscovery</code>，将其值改为 0，如果没找到，则在“编辑”菜单上，指向“新建”，然后单击“DWORD 值”，键入 EnablePMTUDiscovery，然后按 Enter，在“编辑”菜单上，单击“修改”，在“数值数据”框中，键入 0，然后单击“确定”。</p>
<p>退出注册表编辑器，然后重新启动计算机。</p>
</blockquote></li>
<li><p>设置 MTU 值，将其调小，完美解决。具体操作方法为：以管理员身份运行命令提示符，在命令行界面输入 <code>netsh interface ipv4 show subinterfaces</code>，查看传入字节和传出字节的接口，修改对应接口的 MTU 的值，具体命令为：<code>netsh interface ipv4 set subinterface "对应接口名" mtu=值 store=persistent</code>，其中 <strong>对应接口名</strong> 和 <strong>值</strong> 需要替换成相应修改的东西。</p></li>
</ol>
<h2 id="后记">后记</h2>
<p>　　将 MTU 值调小，可能会造成网速变慢，但 Shaun 又无法去改变其它的东西，既然不能改变其它，只能改变自己喽 ╮(╯﹏╰)╭。但 Shaun 这里觉得奇怪的是：别人的电脑设置默认 MTU 的值为 1500 也能访问啊，无奈 （╯‵□′）╯︵┴─┴。</p>
<h2 id="参考资料">参考资料</h2>
<p>[1] <a href="https://www.zhihu.com/question/23627621">电脑上部分网页打不开，但是手机可以，如何解决？</a></p>
<p>[2] <a href="https://jingyan.baidu.com/article/ad310e80ff9bf81849f49ea9.html">mtu值怎样设置才网速最快</a></p>
]]></content>
      <categories>
        <category>Problems</category>
      </categories>
      <tags>
        <tag>network</tag>
      </tags>
  </entry>
  <entry>
    <title>解决VSCode使用Cmder作为默认终端问题</title>
    <url>/posts/fd823bf9.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　Shaun 最近想换换新口味，想尝试用 Cmder 作为 VSCode 下的默认终端，不想再继续使用 git-bash 了，因为 git-bash 有时会出现一些乱码问题。但是在用 VSCode 集成 Cmder 时出现了几个问题。</p>
<span id="more"></span>
<h2 id="问题篇">问题篇</h2>
<p>　　如果在 VSCode 用户设置文件中直接添加 Cmder.exe 及其路径，那么在使用 VSCode 终端时会重新打开一个 Cmder 窗口，而不是直接显示在 VSCode 的「终端」里。Shaun 想要的是 Cmder 就是 VSCode 的终端，就在 VSCode 里，就和原有cmd 终端一样，在 VSCode 下的终端可以直接输入相关命令，而不是另外弹出一个命令行窗口。</p>
<h2 id="解决方案篇">解决方案篇</h2>
<h3 id="方法一">方法一</h3>
<p>将 Cmder 放进一个文件夹中，文件夹名不带空格，比如 Shaun 所有的绿色软件全部放在 <code>D:\ProgramFiles</code> 下，在 VSCode 用户设置文件中添加：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="JSON"><div class="code-copy"></div><figure class="highlight hljs json"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;terminal.integrated.shell.windows&quot;</span>: <span class="string">&quot;C:\\Windows\\Sysnative\\cmd.exe&quot;</span>,</span><br><span class="line"><span class="string">&quot;terminal.integrated.shellArgs.windows&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;/k D:\\ProgramFiles\\Cmder\\vendor\\init.bat&quot;</span></span><br><span class="line">],</span><br></pre></td></tr></table></figure></div>
<h3 id="方法二">方法二</h3>
<p>一部分用户可能有点强迫症 ๑乛◡乛๑，硬是要把绿色软件还放入系统盘中的 <code>Program Files</code> 文件夹里，这样在 VSCode 里配置 Cmder 作为默认终端时就会出现问题。主要是因为 <code>Program Files</code> 文件夹名中有空格（这里吐槽一下带空格的文件名真鸡儿坑爹，命令行中根本无法访问，这应该是巨硬的历史遗留问题了， 特立独行的支持带空格的路径名，想显摆一下自己，但以目前的情况看，这种支持简直无力吐槽，造成了一堆问题，和 Windows 路径名中的 <code>\</code> 有的一拼，都是逼死现代程序员的设计 _(´ཀ`」 ∠)_）。好了，吐槽的话也就说到这里了，如果配置路径里无法避免 Program Files 文件夹，这里有三种解决方案：</p>
<ol type="1">
<li><p>Windows 在支持带空格的长文件名的同时，也会分配一个短名称，可以称为该文件夹的别名，通过这个别名就可以在命令行中访问该文件夹，获取这个别名的方法有：在命令行中输入 <code>dir /X</code> ，即可在文件夹名之前的一列的看到该别名，若没有别名则为空白，若要添加别名则需要加入 <code>/N</code> 参数。Shaun 这里显示别名如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="BASH"><div class="code-copy"></div><figure class="highlight hljs bash"><table><tr><td class="code"><pre><span class="line">$ dir /X</span><br><span class="line"> 驱动器 C 中的卷是 System</span><br><span class="line"> 卷的序列号是 XXXX-XXXX</span><br><span class="line"></span><br><span class="line"> C:\ 的目录</span><br><span class="line"></span><br><span class="line">.........</span><br><span class="line"></span><br><span class="line">2018/05/16  19:21    &lt;DIR&gt;          PROGRA~1     Program Files</span><br><span class="line">2018/05/17  15:14    &lt;DIR&gt;          PROGRA~2     Program Files (x86)</span><br><span class="line"></span><br><span class="line">..........</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
<p>由上面可知 <code>Program Files</code> 文件夹的别名为 <code>PROGRA~1</code>，而 <code>Program Files (x86)</code> 文件夹的别名为 <code>PROGRA~2</code>，在配置路径时只需要用别名替换相应的文件夹名即可，如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="JSON"><div class="code-copy"></div><figure class="highlight hljs json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;terminal.integrated.shell.windows&quot;</span>: <span class="string">&quot;C:\\Windows\\Sysnative\\cmd.exe&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;terminal.integrated.shellArgs.windows&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;/k C:\\PROGRA~1\\Cmder\\vendor\\init.bat&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li>
<li><p>通过转义符添加 <code>" "</code> 使 <code>Program Files</code> 作为一个整体，如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="JSON"><div class="code-copy"></div><figure class="highlight hljs json"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;terminal.integrated.shell.windows&quot;</span>: <span class="string">&quot;cmd.exe&quot;</span>,</span><br><span class="line"><span class="string">&quot;terminal.integrated.shellArgs.windows&quot;</span>: [<span class="string">&quot;/k&quot;</span>, <span class="string">&quot;C:\\\&quot;Program Files\&quot;\\Cmder\\vendor\\init.bat&quot;</span>],</span><br></pre></td></tr></table></figure></div></li>
<li><p>直接在系统环境变量中新建一个变量，将 Cmder 的根目录加进去，如下：</p>
<table>
<thead>
<tr class="header">
<th>变量名</th>
<th>变量值</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>CMDER_ROOT</td>
<td>C:\Program Files</td>
</tr>
</tbody>
</table>
<p>再在 VSCode 用户设置文件中添加：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="JSON"><div class="code-copy"></div><figure class="highlight hljs json"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;terminal.integrated.shell.windows&quot;</span>: <span class="string">&quot;C:\\Windows\\system32\\cmd.exe&quot;</span>,</span><br><span class="line"><span class="string">&quot;terminal.integrated.shellArgs.windows&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;/k %CMDER_ROOT%\\vendor\\init.bat&quot;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure></div></li>
</ol>
<p>通过以上几种方法（<strong><em>推荐直接使用方法一</em></strong>），就能成功在 VSCode 中集成 Cmder，可以直接在 VSCode 的终端里享受 Cmder 了。</p>
<h2 id="后记">后记</h2>
<p>　　没有什么好说的了，该吐槽也已经吐槽完了。<strong>方法二</strong> Shaun <strong>没</strong>试过，只是感觉应该可行，有问题的小伙伴可以在下方留言（这是不可能的，这辈子都不会有人留言的，反正也没人会看到的 ╮(╯▽╰)╭）。以上解决方案全部来自网络，Shaun 只是做个总结记录，万一以后碰到类似问题至少有多种方案可以尝试。</p>
<h2 id="参考资料">参考资料</h2>
<p>[1] <a href="https://stackoverflow.com/questions/45765853/how-to-use-cmder-in-visual-studio-code">How to use Cmder in Visual Studio Code?</a></p>
<p>[2] <a href="https://github.com/Microsoft/vscode/issues/12006">Setting Cmder.exe as integrated shell still opens in separate window</a></p>
<p>[3] <a href="http://www.cnblogs.com/eastegg/p/8532266.html">IntelliJ idea webstrom Visual Studio Code vscode 设置cmder为默认终端 Terminal</a></p>
]]></content>
      <categories>
        <category>Problems</category>
      </categories>
      <tags>
        <tag>vscode</tag>
      </tags>
  </entry>
  <entry>
    <title>空间中三角形与三角形相交</title>
    <url>/posts/6694a214.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　一种快速判断空间中三角形与三角形相交的方法，出自论文：<em>Tomas Moller. A Fast Triangle-Triangle Intersection Test. Journal of Graphics Tools, 1997, 2(2):25-30.</em> ，与「快速判断三角形与长方体相交」中那篇论文的作者是同一个人。</p>
<span id="more"></span>
<h2 id="相交篇">相交篇</h2>
<p>　　该论文的理论基础部分来自分离轴理论，论文中三角形与三角形的相交测试主要可分为 3 类：1、沿三角形所在平面法线方向的相交测试；2、沿三角形所在两平面交线方向的相交测试；3、共面时的相交测试。下面来逐步分析这些相交测试。</p>
<h3 id="沿法线方向相交">沿法线方向相交</h3>
<p>　　沿法线相交很简单，直接使用分离轴理论分别判断两三角形在对应两条法线上的投影是否相交，若存在一条法线使投影不相交，则可直接判定两三角形不相交，若投影都相交，则存在两种情况，一种是两三角形共面，一种是两三角形相互跨立，判断这两种情况的依据为计算两段投影之间的距离，具体计算方法为：计算三角形 B 上三个点到三角形 A 所在平面的距离，距离计算的方法可参考「<a href="https://cniter.github.io/posts/5315fcfd.html#%E7%82%B9%E5%88%B0%E5%B9%B3%E9%9D%A2%E7%9A%84%E8%B7%9D%E7%A6%BB">计算几何基础—点到平面的距离</a>」，此距离同时需要保留方向，若三个点的距离都为 0，则两三角形共面；若三个距离都同号，则说明投影不相交，即两三角形不相交；若三个距离存在异号现象，则 B 跨立 A。</p>
<h3 id="沿交线方向相交">沿交线方向相交</h3>
<p>　　若两三角形相互跨立，则需要判断两三角形是否在两三角形所在平面交线上存在相交。由于两三角形相互跨立，则两三角形必然都与交线相交，则需要分别计算两三角形与交线的交点，根据交点判断两交线段是否相交，若相交，则可直接判定两三角形相交，若不相交，则同样可直接判定两三角形不相交。</p>
<p>　　问题的关键现在在于求取两交线段，比较粗暴的方式为：先求出两平面的交线，交线的方向向量为两三角形所在平面法向量的的叉积，交线上的一点通过联立两平面方程进行求取，由于是两个方程求 3 个未知数（x，y，z），所以理论上有无数个解，令交线方向向量绝对值最大的分量对应的未知数为 0，消除一个未知数，还剩两个，可得唯一解，即可求出交线上一点，亦可得到直线参数方程，求两交线段相当于求四个交点，根据直线与线段相交可得到交点，进而得到交线段。</p>
<p>论文中的方法为：求出交线的方向向量 D 后，设 O 为交线上任意一点（<em>不需要求</em>），则交线方程为 <span class="math inline">\(L= O+tD\)</span>，此时求交线段只需要求出 4 个 t。先求交线与三角形 A 的交线段，设三角形 A（V0，V1，V2）三个顶点到三角形 B 所在平面的距离分别为 <span class="math inline">\(d_0,d_1,d_2\)</span>，设 <span class="math inline">\(d_1\)</span> 与其它两个距离异号，则交线分别与 V0V1 和 V2V1 相交，先求与 V0V1 相交时的 t1，设三角形 B 所在的平面为平面 B，V0 和 V1 在平面 B 上的投影分别为为 K0 和 K1，V0 和 V1 在交线上的投影分别为为 P0 和 P1，交线与 V0V1 的交点为 C1，设 <span class="math inline">\(P0=O+p_0D,P1=O+p_1D,C1=O+t_1D\)</span>，则 <span class="math inline">\(p_0=(V0-O)·D,p_1=(V1-O)·D\)</span>，由论文中图二可知，有两组三角形相似，分别为 V0C1K0和V1C1K1 相似，以及 V0C1P0和V1C1P1 相似，所以 <span class="math display">\[
\frac{V0K0}{V1K1} = \frac{V0C1}{V1C1} = \frac{C1P0}{C1P1} \Rightarrow \frac{d_0}{d_1} = \frac{p_0-t_1}{p1-t_1} \Rightarrow t_1 = \frac{d_0p_1-d_1p_0}{d_0-d_1}
\]</span> 若点 O 为原点在交线上的投影，则 <span class="math inline">\((V0-O)·D=V0·D=p_0, 　p_1=V1·D\)</span>，若将交线投影到交线方向向量绝对值最大的分量对应的坐标轴上，在该投影交线上进行相交测试与在原交线上进行相交测试是等效的，所以此时 <span class="math inline">\(p_0,p_1\)</span> 即为 V0 和 V1 上对应坐标轴的分量。同理可求出 t2，t3 ，t4，两交线段为 t1t2 和 t3t4。</p>
<h3 id="共面相交">共面相交</h3>
<p>　　判断共面相交，相当于判断 2 维中两三角形是否相交，先将三角形投影到 XOY，XOZ，YOZ 平面中投影面积最大的平面（为避免计算面积，可直接令三角形顶点坐标中对应法向向量中绝对值最大的分量为 0，即若法向向量中绝对值最大的分量为 y，则将三角形投影到 XOZ 平面），判断投影后的两三角形是否相交即可，因为此时的两三角形相交，当且仅当其投影三角形相交。2 维中两三角形是否相交，论文中方法是先判断两三角形的边是否相交，即相当于判断 9 组线段是否相交，若存在一组相交，则两三角形相交，若都不相交，则需要判断其中一个三角形是否被另一个三角形包含，具体判断方式取三角形 A 中一顶点，若该顶点在三角形 B 内（判断 2 维中点在多边形内的方法同样可参考「计算几何基础」），则说明三角形 A 在 B 内，同样也需要判断 B 是否在 A 内，若都不在，则两三角形不相交，否则两三角形相交。当然，也可以直接通过分离轴理论来判断两三角形是否相交，毕竟，这就是在 2 维中，而且三角形算是天然的凸多边形。</p>
<h2 id="后记">后记</h2>
<p>　　三角形是图形学中组成面的基本单元，图形学中面与面的碰撞检测都可以很粗暴的用三角形相交来实现，只不过直接一个个判断效率有点低就是了，所以一般会借助一些基于的树和包围盒空间加速结构，或者针对某种形状的特殊方法，这又是新的方法系列了。</p>
]]></content>
      <categories>
        <category>Image&amp;Graphic</category>
      </categories>
      <tags>
        <tag>algorithm</tag>
        <tag>geometry</tag>
      </tags>
  </entry>
  <entry>
    <title>解决写上篇文档“Hexo+GitHub搭建个人博客”遇到的问题</title>
    <url>/posts/7d5bc07b.html</url>
    <content><![CDATA[<h2 id="超链接网址问题">超链接网址问题</h2>
<p>　　<strong>问题描述：</strong>使用正常的 markdown 超链接格式<code>[]()</code>没问题，然而当直接将一个网址链接放入该文档时，它会将该链接后面的文字也当成是该链接的一部分，直接点击链接时，会将后面的文字也放入浏览器地址栏，从而出现网页 404 错误：<em>404: Page could not be found</em>。</p>
<p>　　<strong>解决办法：</strong>在网址链接后输入一个空格以隔开网址链接和后面的文字或用<code>&lt;url&gt;</code>将网址括起来。</p>
<span id="more"></span>
<h2 id="超链接样式问题">超链接样式问题</h2>
<p>　　<strong>问题描述：</strong>Shaun 使用的 hexo 主题是基于 spfk 主题稍微修改过的，spfk 主题能自动修改超链接原有的样式，挺好看的 :D，但是当 Shaun 在 markdown 中数字编号列表，即有序列表中添加超链接时，其样式并没有修改，还是普通的超链接样式。</p>
<p>　　<strong>解决办法：</strong>没有解决。最后只是跳过了这个问题，就用中文的序号表示列表。</p>
<h2 id="文本段落问题">文本段落问题</h2>
<p>　　<strong>问题描述：</strong>为了使文本有段落感，一般都会在段落首字前空两格，但是在 markdown 中空两格，用 hexo 发布后并没有空两格，这使得文档没有段落感，阅读体验有点差。</p>
<p>　　<strong>解决办法：</strong>将中文输入法由半角切换至全角，在段落首字前输入两个空格即可。</p>
<h2 id="显示英文尖括号问题">显示英文尖括号问题</h2>
<p>　　<strong>问题描述：</strong>由于上篇文档需要在文档中显示<code>&lt;youname&gt;</code>，但由于 Hexo 可能将其当做一个 xml 标签处理了，所以发布之后的文档没有显示该文字。</p>
<p>　　<strong>解决办法：</strong>首先 Shaun 尝试了转义字符<code>\</code>，谁曾想它只出现了一个转义字符，该文字还是没显示，Shaun 差点又要跳过这个问题，将其用另一种表示法了。后来 Shaun 想到这最后不是会转为 html 吗，Shaun 就直接用 html 中尖括号的表示法不就行啦 :p，于是参考<a href="http://liuxufei.com/weblog/jishu/71.html">HTML语言中括号(尖括号)的字符编码</a>，用<code>&amp;lt;</code>代替<code>&lt;</code>，用<code>&amp;gt;</code>代替<code>&gt;</code>，最后该文字终于出来了。</p>
<h2 id="给文字添加颜色问题">给文字添加颜色问题</h2>
<p>　　<strong>问题描述：</strong>Shaun 想给注意事项上的需要注意的问题添加醒目的颜色，但 markdown 本身不支持给文字添加颜色。</p>
<p>　　<strong>解决办法：</strong>由于 Hexo 最后会将 markdown 文档转换为 html 文档发布，所以直接将 html 标签写进 markdown 文档，最后自然会出现 html 样式，Shaun 这里参考<a href="http://blog.csdn.net/testcs_dn/article/details/45719357/">CSDN-markdown编辑器语法——字体、字号与颜色</a>，给想要变色的文字添加<code>&lt;font color=#FA8072&gt;&lt;/font&gt;</code>标签。</p>
<h2 id="参考资料">参考资料</h2>
<p>[1] <a href="http://liuxufei.com/weblog/jishu/71.html">HTML语言中括号(尖括号)的字符编码</a>（<a href="http://liuxufei.com/weblog/jishu" class="uri">http://liuxufei.com/weblog/jishu</a>）</p>
<p>[2] <a href="http://blog.csdn.net/testcs_dn/article/details/45719357/">CSDN-markdown编辑器语法——字体、字号与颜色</a>（<a href="http://blog.csdn.net/testcs_dn" class="uri">http://blog.csdn.net/testcs_dn</a>）</p>
]]></content>
      <categories>
        <category>Problems</category>
      </categories>
      <tags>
        <tag>hexo</tag>
        <tag>markdown</tag>
      </tags>
  </entry>
  <entry>
    <title>积分计算</title>
    <url>/posts/eee1c041.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　最近需要计算一下曲线长度，无法直接得到被积函数的原函数，常规的积分解法牛顿莱布尼茨公式没法使用，所以只能使用数值积分计算积分。</p>
<span id="more"></span>
<p>　　下面主要介绍两种数值积分方法：龙贝格积分（Romberg Quadrature） 和 高斯-克朗罗德积分（Gauss-kronrod Quadrature）。 <em>下面附带的代码只做简单测试，不保证正确性，语言使用 Typescript。</em></p>
<h2 id="romberg-篇">Romberg 篇</h2>
<p>　　计算积分最简单的当然是使用复化梯形公式，即 <span class="math inline">\(I=\int_a^b{f(x)dx}=\frac{b-a}{2n}[f(a)+f(b)+2\sum\limits_{i=1}^{n-1}f(x_i)]= T_n,　x_i=a+i*h, h=(b-a)/n\)</span> ，若将 n 段每段一分为 2，可得到 <span class="math inline">\(T_{2n}=T_n/2+\frac{b-a}{2n}\sum\limits_{i=0}^{n-1}f(x_{i+1/2})\)</span> 。考虑数列 <span class="math inline">\(T=\{T_1,T_2,T_{2^2},...,T_{2^k}\}\)</span>，显然该数列必收敛，最后收敛为对应积分，当 <span class="math inline">\(|T_{2^k}-T_{2^{k-1}}| &lt; ε\)</span> （<span class="math inline">\(ε\)</span> 为精度）时，可取 <span class="math inline">\(T_{2^k}\)</span> 作为最后的积分结果。但是，直接利用梯形公司求解，收敛很慢，导致计算效率很差，所以需要使用理查德森（Richardson）外推法加速收敛，设 <span class="math inline">\(T_{2^k}^{(m)}\)</span> 为 m 次加速值，当 m 为 0 时，表示没加速，为原梯形公司，则 <span class="math inline">\(T_{2^k}^{(m)} = \frac{4^m}{4^m-1}T_{2^{k+1}}^{(m-1)}-\frac{1}{4^m-1}T_{2^k}^{(m-1)}\)</span>，当 <span class="math inline">\(|T_{2^{k+1}}^{(m)}-T_{2^k}^{(m)}| &lt; ε\)</span> 时，则收敛，并取其中一值作为最终的积分值。未经修饰的代码如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="TYPESCRIPT"><div class="code-copy"></div><figure class="highlight hljs typescript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rombergIntegrator</span>(<span class="params">f: (x: <span class="built_in">number</span>) =&gt; <span class="built_in">number</span>, a: <span class="built_in">number</span>, b: <span class="built_in">number</span>, tolerance = <span class="number">1e-8</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> h = b - a;</span><br><span class="line">    <span class="keyword">let</span> n = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">let</span> preTK = ((f(a) + f(b)) * h) / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> tkmArray = [];</span><br><span class="line">    <span class="keyword">let</span> m = <span class="number">0</span>;</span><br><span class="line">    tkmArray[m] = preTK;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        m += <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">console</span>.log(m, tkmArray[m - <span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> tk = getTK(f, preTK, n, a, h);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">Math</span>.abs(tk - preTK) &lt; tolerance) <span class="keyword">return</span> tk;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> preTKM = tkmArray[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">let</span> preTK1M = tk;</span><br><span class="line">        tkmArray[<span class="number">0</span>] = tk;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt;= m; i++) &#123;</span><br><span class="line">            <span class="keyword">let</span> newTKM = getTKM(preTK1M, preTKM, i);</span><br><span class="line">            preTKM = tkmArray[i];</span><br><span class="line">            preTK1M = newTKM;</span><br><span class="line">            tkmArray[i] = newTKM;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (preTKM !== <span class="literal">undefined</span> &amp;&amp; <span class="built_in">Math</span>.abs(preTK1M - preTKM) &lt; tolerance) <span class="keyword">return</span> preTK1M;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        preTK = tk;</span><br><span class="line">        n *= <span class="number">2</span>;</span><br><span class="line">        h /= <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getTK</span>(<span class="params">f: (x: <span class="built_in">number</span>) =&gt; <span class="built_in">number</span>, preTK: <span class="built_in">number</span>, n: <span class="built_in">number</span>, a: <span class="built_in">number</span>, h: <span class="built_in">number</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> sum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">let</span> x = a + (i + <span class="number">0.5</span>) * h;</span><br><span class="line">            sum += f(x);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (preTK + h * sum) / <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getTKM</span>(<span class="params">preTK1M: <span class="built_in">number</span>, preTKM: <span class="built_in">number</span>, m = <span class="number">0</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> m4 = <span class="number">1</span> &lt;&lt; (<span class="number">2</span> * m); <span class="comment">// 4 ** m;</span></span><br><span class="line">        <span class="keyword">return</span> (m4 * preTK1M - preTKM) / (m4 - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>　　由于采用闭型积分规则（积分上下限值参与积分计算），所以以上代码不适合计算两端点值被积函数值无限大的情况（如 1/4 圆弧积分等）。而且该方法不合适求取被积函数在积分区间内导数值变化较大（如被积函数在积分下限附近剧烈波动，在积分上限附近不变化等）的积分，因为该方法是均匀分段，这种情况将导致计算量剧增，这时就需要用到下面的自适应积分。</p>
<h2 id="自适应篇">自适应篇</h2>
<p>　　自适应积分主要包括两类：全局自适应积分和局部自适应积分，通常情况下全局自适应积分的会比局部自适应积分的表现要好，全局自适应积分一般通过二分递归实现，当满足一定条件时，递归终止，即通过二分分别计算两边的积分，若一边满足一定条件，则不继续划分，从而减少计算量。全局自适应积分中比较经典的有基于辛普森（Simpson）公式的自适应算法，普通辛普森积分公式为：<span class="math inline">\(I=\int_a^b{f(x)dx}=\frac{b-a}{6}[f(a)+4f(m)+f(b)]= S(a,b),　m=(a+b)/2\)</span>，复化辛普森公式为 <span class="math inline">\(I=\int_a^b{f(x)dx}=\frac{h}{3}[f(a)+4\sum\limits_{i=1}^{n}f(x_{2i-1})+2\sum\limits_{i=1}^{n-1}f(x_{2i})+f(b)]= S(a,b)\)</span>，其中 <span class="math inline">\(x_i=a+i*h　(i=1,2,3,...,2n),h=\frac{b-a}{2n}\)</span>，基于辛普森公式的自适应基本原理如下：令 <span class="math inline">\(S_2(a,b) = S(a,m)+S(m,b)\)</span>，m 为 a,b 中值，若 <span class="math inline">\(|S(a,b) - S_2(a,b)| &lt; 15ε\)</span>，则取 <span class="math inline">\(S_2(a,b)\)</span> 或 <span class="math inline">\(S_2(a,b)+(S(a,b)-S_2(a,b))/15\)</span> 作为该区间的积分值，否则，将区间二分递归，同时因为误差会累积，所以每次递归都需要将精度提高两倍，即 <span class="math inline">\(ε = ε/2\)</span>，如此最后的精度才能达到最初的精度。具体 ts 代码如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="TYPESCRIPT"><div class="code-copy"></div><figure class="highlight hljs typescript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">adaptiveSimpsonIntegrator</span>(<span class="params">f: (x: <span class="built_in">number</span>) =&gt; <span class="built_in">number</span>, a: <span class="built_in">number</span>, b: <span class="built_in">number</span>, epsilon = <span class="number">1e-8</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> S = complexSimpson(f, a, b);</span><br><span class="line">    <span class="keyword">return</span> adsimp(f, a, b, epsilon, S);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">adsimp</span>(<span class="params">f: (x: <span class="built_in">number</span>) =&gt; <span class="built_in">number</span>, a: <span class="built_in">number</span>, b: <span class="built_in">number</span>, epsilon = <span class="number">1e-8</span>, S = <span class="number">0</span></span>): <span class="title">number</span> </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> m = a + (b - a) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">let</span> LS = complexSimpson(f, a, m);</span><br><span class="line">        <span class="keyword">let</span> RS = complexSimpson(f, m, b);</span><br><span class="line">        <span class="keyword">const</span> S2 = LS + RS;</span><br><span class="line">        <span class="keyword">const</span> tolerance = <span class="number">15</span> * epsilon;</span><br><span class="line">        <span class="keyword">let</span> delta = S - S2;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">Math</span>.abs(delta) &lt; tolerance) <span class="keyword">return</span> S2 + delta / <span class="number">15</span>;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> doubleEPS = epsilon / <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">return</span> adsimp(f, a, m, doubleEPS, LS) + adsimp(f, m, b, doubleEPS, RS);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">complexSimpson</span>(<span class="params">f: (x: <span class="built_in">number</span>) =&gt; <span class="built_in">number</span>, a: <span class="built_in">number</span>, b: <span class="built_in">number</span>, n = <span class="number">1</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> n2 = n * <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">const</span> h = (b - a) / n2;</span><br><span class="line">        <span class="keyword">let</span> sum = f(a) + f(b);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt; n2; i += <span class="number">2</span>) &#123;</span><br><span class="line">            sum += <span class="number">4</span> * f(a + i * h);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">2</span>; i &lt; n2 - <span class="number">1</span>; i += <span class="number">2</span>) &#123;</span><br><span class="line">            sum += <span class="number">2</span> * f(a + i * h);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (sum * h) / <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>　　在 D.V. Fedorov 写的「Introduction to Numerical Methods with examples in Javascript」一书中介绍了一种全局自适应方法，即分别使用高阶和低阶的权值分别计算积分，两者之间的差值 <span class="math inline">\(E\)</span> 作为误差估计，设绝对精度为 <span class="math inline">\(\delta\)</span> ，相对精度为 <span class="math inline">\(\epsilon\)</span> ，若 <span class="math inline">\(|E|&lt;\delta+\epsilon*Q\)</span>，Q 为高阶权值计算的积分，则取 Q 作为积分值，否则将积分区间二分，同时使 <span class="math inline">\(\delta/\sqrt{2}\)</span>，<span class="math inline">\(\epsilon\)</span> 保持不变。具体 ts 代码如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="TYPESCRIPT"><div class="code-copy"></div><figure class="highlight hljs typescript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">recursiveAdaptiveIntegrator</span>(<span class="params">f: (x: <span class="built_in">number</span>) =&gt; <span class="built_in">number</span>, a: <span class="built_in">number</span>, b: <span class="built_in">number</span>, accuracy = <span class="number">1e-15</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> recursiveAdaptiveIntegrate(f, a, b, accuracy);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">recursiveAdaptiveIntegrate</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        f: (x: <span class="built_in">number</span>) =&gt; <span class="built_in">number</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        a: <span class="built_in">number</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        b: <span class="built_in">number</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        accuracy = <span class="number">1e-15</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        epsilon = <span class="built_in">Number</span>.EPSILON,</span></span></span><br><span class="line"><span class="params"><span class="function">        preFValue?: <span class="built_in">number</span>[],</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>): <span class="title">number</span> </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> abscissae = [<span class="number">1</span> / <span class="number">6</span>, <span class="number">2</span> / <span class="number">6</span>, <span class="number">4</span> / <span class="number">6</span>, <span class="number">5</span> / <span class="number">6</span>];</span><br><span class="line">        <span class="keyword">const</span> highOrderWeights = [<span class="number">2</span> / <span class="number">6</span>, <span class="number">1</span> / <span class="number">6</span>, <span class="number">1</span> / <span class="number">6</span>, <span class="number">2</span> / <span class="number">6</span>];</span><br><span class="line">        <span class="keyword">const</span> lowOrderWeights = [<span class="number">1</span> / <span class="number">4</span>, <span class="number">1</span> / <span class="number">4</span>, <span class="number">1</span> / <span class="number">4</span>, <span class="number">1</span> / <span class="number">4</span>];</span><br><span class="line">        <span class="keyword">const</span> isRecompute = [<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">const</span> h = b - a;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> fValue: <span class="built_in">number</span>[] = [];</span><br><span class="line">        <span class="keyword">if</span> (preFValue === <span class="literal">undefined</span>) &#123;</span><br><span class="line">            abscissae.forEach(<span class="function">(<span class="params">abscissa</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> x = a + abscissa * h;</span><br><span class="line">                fValue.push(f(x));</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> k = <span class="number">0</span>, i = <span class="number">0</span>; i &lt; abscissae.length; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isRecompute[i]) fValue.push(f(a + abscissae[i] * h));</span><br><span class="line">                <span class="keyword">else</span> fValue.push(preFValue[k++]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> highResult = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">let</span> lowResult = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; highOrderWeights.length; i++) &#123;</span><br><span class="line">            highResult += highOrderWeights[i] * fValue[i];</span><br><span class="line">            lowResult += lowOrderWeights[i] * fValue[i];</span><br><span class="line">        &#125;</span><br><span class="line">        highResult *= h;</span><br><span class="line">        lowResult *= h;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> tolerance = accuracy + epsilon * <span class="built_in">Math</span>.abs(highResult);</span><br><span class="line">        <span class="keyword">let</span> errorEstimate = <span class="built_in">Math</span>.abs(highResult - lowResult) / <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">if</span> (errorEstimate &lt; tolerance) &#123;</span><br><span class="line">            <span class="keyword">return</span> highResult;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            accuracy /= <span class="built_in">Math</span>.sqrt(<span class="number">2</span>);</span><br><span class="line">            <span class="keyword">let</span> m = a + h / <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">let</span> midIndex = <span class="built_in">Math</span>.trunc(abscissae.length / <span class="number">2</span>);</span><br><span class="line">            <span class="keyword">let</span> leftFValue = fValue.slice(<span class="number">0</span>, midIndex);</span><br><span class="line">            <span class="keyword">let</span> rightFValue = fValue.slice(midIndex);</span><br><span class="line">            <span class="keyword">return</span> (</span><br><span class="line">                recursiveAdaptiveIntegrate(f, a, m, accuracy, epsilon, leftFValue) +</span><br><span class="line">                recursiveAdaptiveIntegrate(f, m, b, accuracy, epsilon, rightFValue)</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>　　该方法很巧妙的设计了一组插值点，使得当前计算的函数值正好可以被下次迭代所使用，从而提高性能，同时该方法可以得到 1/4 圆弧长，虽然精度只能到小数点后 8 位，至于 Shaun 写的其它测试函数，都能得到理想精度。</p>
<h2 id="gauss-篇">Gauss 篇</h2>
<p>　　高斯求积法是一种多项式插值积分法，同时由于不计算被积函数在区间两个端点处的值，所以高斯积分法采用的开型积分规则，高斯积分法的衍生方法有很多种，下面主要介绍高斯-勒让德（Gauss-Legendre Quadrature）以及其迭代改良的高斯-克朗罗德法。高斯-勒让德积分法的公式为积分的原始形态，即 <span class="math inline">\(\int_a^bf(x)dx=\sum\limits_{i=1}^{∞}w_if(x_{i})\approx\sum\limits_{i=1}^{n}w_if(x_{i})\)</span> ，只不过 <span class="math inline">\(x_i \in [-1,1]\)</span>，并且 <span class="math inline">\(x_i\)</span> 和 <span class="math inline">\(w_i\)</span> 都通过勒让德多项式求出，所以其原则上只能用在积分区间为 [-1, 1] 上的积分，但是可以将积分从任意区间通过简单的变形变换到 [-1, 1] 上，即 <span class="math inline">\(\int_a^b{f(x)dx} = \frac{b-a}{2}\int_{-1}^1{f(\frac{b-a}{2}t+\frac{b+a}{2})dt}\)</span> ，从而可以将高斯-勒让德方法扩展到任意积分上。由于每个 n 对应的 <span class="math inline">\(x_i\)</span> 和 <span class="math inline">\(w_i\)</span> 都可以查表可得，所以具体代码方面就很简单了，以 n = 4，即插值点个数为 4 为例，ts 代码如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="TYPESCRIPT"><div class="code-copy"></div><figure class="highlight hljs typescript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gaussLegendreIntegrate</span>(<span class="params">f: (x: <span class="built_in">number</span>) =&gt; <span class="built_in">number</span>, a: <span class="built_in">number</span>, b: <span class="built_in">number</span>, n: <span class="number">4</span> | <span class="number">8</span> = <span class="number">4</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> weightsAndAbscissae = getWeightsAndAbscissae(n);</span><br><span class="line">    <span class="keyword">const</span> weights = weightsAndAbscissae.weights;</span><br><span class="line">    <span class="keyword">const</span> abscissae = weightsAndAbscissae.abscissae;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> halfH = (b - a) / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; abscissae.length; i++) &#123;</span><br><span class="line">        <span class="keyword">let</span> xi = halfH * abscissae[i] + a + halfH;</span><br><span class="line">        sum += weights[i] * f(xi);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sum * halfH;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getWeightsAndAbscissae</span>(<span class="params">n: <span class="number">4</span> | <span class="number">8</span> = <span class="number">4</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (n) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    <span class="attr">weights</span>: [</span><br><span class="line">                        <span class="number">0.362683783378362</span>,</span><br><span class="line">                        <span class="number">0.362683783378362</span>,</span><br><span class="line">                        <span class="number">0.3137066458778873</span>,</span><br><span class="line">                        <span class="number">0.3137066458778873</span>,</span><br><span class="line">                        <span class="number">0.2223810344533745</span>,</span><br><span class="line">                        <span class="number">0.2223810344533745</span>,</span><br><span class="line">                        <span class="number">0.1012285362903763</span>,</span><br><span class="line">                        <span class="number">0.1012285362903763</span>,</span><br><span class="line">                    ],</span><br><span class="line">                    <span class="attr">abscissae</span>: [</span><br><span class="line">                        -<span class="number">0.1834346424956498</span>,</span><br><span class="line">                        <span class="number">0.1834346424956498</span>,</span><br><span class="line">                        -<span class="number">0.525532409916329</span>,</span><br><span class="line">                        <span class="number">0.525532409916329</span>,</span><br><span class="line">                        -<span class="number">0.7966664774136267</span>,</span><br><span class="line">                        <span class="number">0.7966664774136267</span>,</span><br><span class="line">                        -<span class="number">0.9602898564975363</span>,</span><br><span class="line">                        <span class="number">0.9602898564975363</span>,</span><br><span class="line">                    ],</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    <span class="attr">weights</span>: [<span class="number">0.6521451548625461</span>, <span class="number">0.6521451548625461</span>, <span class="number">0.3478548451374538</span>, <span class="number">0.3478548451374538</span>],</span><br><span class="line">                    <span class="attr">abscissae</span>: [-<span class="number">0.3399810435848563</span>, <span class="number">0.3399810435848563</span>, -<span class="number">0.8611363115940526</span>, <span class="number">0.8611363115940526</span>],</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>　　若要提高高斯-勒让德积分法的精度，可通过增加插值点或分多个区间进行积分来实现，但是由于没有误差估计，所以还是没法精确控制精度，对与某些被积函数积分精度高，但对于其它被积函数，积分精度却有限，当然可以简单的引入一些常用的误差估计法，但一般需要重新计算积分，导致效率很低，而高斯-克朗罗德法为其引入了一种基于 Kronrod 点的误差估计法，可充分利用现有计算值，从而达到有效控制精度的同时，性能没有太大的损失。设 <span class="math inline">\(G(f,n)=\sum\limits_{i=1}^{n}w_if(x_{i})\)</span> 为具有 n 个插值点的高斯-勒让德法计算结果，<span class="math inline">\(GK(f,n) = \sum\limits_{i=1}^{n}w&#39;_if(x_{i})+\sum\limits_{k=n+1}^{2n+1}w&#39;_kf(x_{k})\)</span> 为高斯-克朗罗德法的计算结果，则 <span class="math inline">\(|GK(f,n)-G(f,n)|\)</span> 可作为误差估计，有了误差估计，最后再使用全局自适应策略，即可得到精度可控的高斯积分结果。具体 ts 代码如下，以 n = 7 为例：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="TYPESCRIPT"><div class="code-copy"></div><figure class="highlight hljs typescript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gaussKronrodIntegrator</span>(<span class="params">f: (x: <span class="built_in">number</span>) =&gt; <span class="built_in">number</span>, a: <span class="built_in">number</span>, b: <span class="built_in">number</span>, accuracy = <span class="number">1e-15</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> recursiveAdaptiveIntegrate(f, a, b, accuracy);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">recursiveAdaptiveIntegrate</span>(<span class="params">f: (x: <span class="built_in">number</span>) =&gt; <span class="built_in">number</span>, a: <span class="built_in">number</span>, b: <span class="built_in">number</span>, accuracy = <span class="number">1e-12</span></span>): <span class="title">number</span> </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> gaussAbscissae = [</span><br><span class="line">            <span class="number">0.0</span>,</span><br><span class="line">            -<span class="number">4.058451513773971669066064120769615e-1</span>,</span><br><span class="line">            <span class="number">4.058451513773971669066064120769615e-1</span>,</span><br><span class="line">            -<span class="number">7.415311855993944398638647732807884e-1</span>,</span><br><span class="line">            <span class="number">7.415311855993944398638647732807884e-1</span>,</span><br><span class="line">            -<span class="number">9.491079123427585245261896840478513e-1</span>,</span><br><span class="line">            <span class="number">9.491079123427585245261896840478513e-1</span>,</span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">const</span> gaussWeights = [</span><br><span class="line">            <span class="number">4.179591836734693877551020408163265e-1</span>,</span><br><span class="line">            <span class="number">3.818300505051189449503697754889751e-1</span>,</span><br><span class="line">            <span class="number">3.818300505051189449503697754889751e-1</span>,</span><br><span class="line">            <span class="number">2.797053914892766679014677714237796e-1</span>,</span><br><span class="line">            <span class="number">2.797053914892766679014677714237796e-1</span>,</span><br><span class="line">            <span class="number">1.29484966168869693270611432679082e-1</span>,</span><br><span class="line">            <span class="number">1.29484966168869693270611432679082e-1</span>,</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> kronrodAbscissae = gaussAbscissae.concat([</span><br><span class="line">            -<span class="number">2.077849550078984676006894037732449e-1</span>,</span><br><span class="line">            <span class="number">2.077849550078984676006894037732449e-1</span>,</span><br><span class="line">            -<span class="number">5.860872354676911302941448382587296e-1</span>,</span><br><span class="line">            <span class="number">5.860872354676911302941448382587296e-1</span>,</span><br><span class="line">            -<span class="number">8.648644233597690727897127886409262e-1</span>,</span><br><span class="line">            <span class="number">8.648644233597690727897127886409262e-1</span>,</span><br><span class="line">            -<span class="number">9.914553711208126392068546975263285e-1</span>,</span><br><span class="line">            <span class="number">9.914553711208126392068546975263285e-1</span>,</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> kronrodWeights = [</span><br><span class="line">            <span class="number">2.094821410847278280129991748917143e-1</span>,</span><br><span class="line">            <span class="number">1.903505780647854099132564024210137e-1</span>,</span><br><span class="line">            <span class="number">1.903505780647854099132564024210137e-1</span>,</span><br><span class="line">            <span class="number">1.406532597155259187451895905102379e-1</span>,</span><br><span class="line">            <span class="number">1.406532597155259187451895905102379e-1</span>,</span><br><span class="line">            <span class="number">6.309209262997855329070066318920429e-2</span>,</span><br><span class="line">            <span class="number">6.309209262997855329070066318920429e-2</span>,</span><br><span class="line">            <span class="number">2.044329400752988924141619992346491e-1</span>,</span><br><span class="line">            <span class="number">2.044329400752988924141619992346491e-1</span>,</span><br><span class="line">            <span class="number">1.690047266392679028265834265985503e-1</span>,</span><br><span class="line">            <span class="number">1.690047266392679028265834265985503e-1</span>,</span><br><span class="line">            <span class="number">1.04790010322250183839876322541518e-1</span>,</span><br><span class="line">            <span class="number">1.04790010322250183839876322541518e-1</span>,</span><br><span class="line">            <span class="number">2.293532201052922496373200805896959e-2</span>,</span><br><span class="line">            <span class="number">2.293532201052922496373200805896959e-2</span>,</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> halfH = (b - a) / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> guassResult = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">let</span> kronrodResult = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; gaussAbscissae.length; i++) &#123;</span><br><span class="line">            <span class="keyword">let</span> xi = halfH * gaussAbscissae[i] + a + halfH;</span><br><span class="line">            <span class="keyword">let</span> yi = f(xi);</span><br><span class="line">            guassResult += gaussWeights[i] * yi;</span><br><span class="line">            kronrodResult += kronrodWeights[i] * yi;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = gaussAbscissae.length; i &lt; kronrodAbscissae.length; i++) &#123;</span><br><span class="line">            <span class="keyword">let</span> xi = halfH * kronrodAbscissae[i] + a + halfH;</span><br><span class="line">            <span class="keyword">let</span> yi = f(xi);</span><br><span class="line">            kronrodResult += kronrodWeights[i] * yi;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">Math</span>.abs(kronrodResult - guassResult) &lt; accuracy / halfH) <span class="keyword">return</span> kronrodResult * halfH;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> m = a + (b - a) / <span class="number">2</span>;</span><br><span class="line">            accuracy /= <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">return</span> recursiveAdaptiveIntegrate(f, a, m, accuracy) + recursiveAdaptiveIntegrate(f, m, b, accuracy);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>　　简单测试了一下，Shaun 这里写的 gaussKronrodIntegrator 方法最大精度只能到 1e-15，到 16 位就报错递归深度太大了，圆的 1/4 弧长也没法算出来，当然这些问题可通过设置最大递归深度以及处理异常值来解决，Shaun 这里就不继续写了。</p>
<h2 id="后记">后记</h2>
<p>　　数值积分策略非常多，尤其是针对一些特殊的函数，可能只能使用一些特殊的策略才能计算，Shaun 这里只是介绍了一些比较基础常用的积分方法，能解决大部分积分问题，唯一需要注意一点的就是如何追求性能与精度之间的平衡，因为积分常常涉及到迭代求值，通常而言精度越高，迭代越多，求积时，同时也需要注意被积函数的异常值（如无穷大等），这时可能需要拆分或变换积分区间，并且使用开型积分规则的积分方法进行重新计算。</p>
<h2 id="附录">附录</h2>
<h3 id="一些常见的积分变换">一些常见的积分变换</h3>
<p><span class="math display">\[
\int_a^bf(x) = \int_0^{b-a}f(a+t)dt \\
\int_a^b{f(x)dx} = \frac{b-a}{2}\int_{-1}^1{f(\frac{b-a}{2}t+\frac{b+a}{2})dt} \\
\int_{-∞}^{+∞}{f(x)dx} = \int_{-1}^1{f(\frac{t}{1-t^2})\frac{1+t^2}{(1-t^2)^2}dt} \\
\int_{a}^{+∞}{f(x)dx} = \int_{0}^1{f(a + \frac{t}{1-t})\frac{1}{(1-t)^2}dt} \\
\int_{-∞}^{a}{f(x)dx} = \int_{-1}^0{f(a + \frac{t}{1+t})\frac{-1}{(1+t)^2}dt}
\]</span></p>
<h2 id="参考资料">参考资料</h2>
<p>[1] <a href="https://reference.wolfram.com/language/tutorial/NIntegrateIntegrationStrategies.html#155948475">积分策略</a></p>
<p>[2] <a href="https://pomax.github.io/bezierinfo/legendre-gauss.html">Gaussian Quadrature Weights and Abscissae</a></p>
<p>[3] <a href="https://www.boost.org/doc/libs/release/libs/math/doc/html/math_toolkit/gauss_kronrod.html">Gauss-Kronrod Quadrature</a></p>
<p>[4] <a href="https://www.advanpix.com/2011/11/07/gauss-kronrod-quadrature-nodes-weights/">Gauss-Kronrod Quadrature Nodes and Weights</a></p>
]]></content>
      <categories>
        <category>Mathematics</category>
      </categories>
      <tags>
        <tag>numerical</tag>
        <tag>integration</tag>
      </tags>
  </entry>
  <entry>
    <title>计算几何基础</title>
    <url>/posts/5315fcfd.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　由于本篇主要是谈谈基础，所以一些快速运算方法一般不在本篇探讨范围之内，一些特殊的快速手法等后续专门独立开篇再谈。</p>
<span id="more"></span>
<h2 id="基础篇">基础篇</h2>
<p><strong>解线性方程组：</strong>令 <span class="math inline">\(A\)</span> 为 <span class="math inline">\(n×n\)</span> 的矩阵，<span class="math inline">\(α\)</span> 和 <span class="math inline">\(β\)</span> 为 n 维的列向量，设 <span class="math inline">\(A = \begin{bmatrix} \alpha_1 &amp; \alpha_2 &amp; \alpha_3 &amp; ... &amp; \alpha_n \end{bmatrix}\)</span>，对于线性方程组 <span class="math inline">\(Ax = β\)</span>，初等数学中最常规的就是消元法了，但在线性代数中，有两种解法，一种是等式两边同乘 <span class="math inline">\(A\)</span> 的逆阵，得到 <span class="math inline">\(x = A^{-1}β\)</span>；另一种是克莱姆法则，可得 <span class="math inline">\(x_i = |A_i| / |A|\)</span>，其中 <span class="math inline">\(|A|\)</span> 为 矩阵 <span class="math inline">\(A\)</span> 对应的行列式， <span class="math inline">\(|A_i|\)</span> 为将矩阵 <span class="math inline">\(A\)</span> 中第 <span class="math inline">\(i\)</span> 列换成 <span class="math inline">\(β\)</span> 后对应的行列式，如 <span class="math inline">\(x_3 = \left| \begin{array}{cccc} \alpha_1 &amp; \alpha_2 &amp; \beta &amp; ... &amp; \alpha_n \end{array} \right| / |A|\)</span>。</p>
<p><strong>向量内积：</strong>又称向量点积，向量点乘。设 a，b 为空间中两个 n 维向量 <span class="math inline">\(a=(x_1,x_2,x_3,...,x_n)\)</span>，<span class="math inline">\(b=(y_1,y_2,y_3,...,y_n)\)</span>，则 <span class="math inline">\(a·b=|a|*|b|*cos(α)=\sum\limits_{i=1}^{n}x_iy_i\)</span>，其中<span class="math inline">\(|a|= \sqrt{(x_1)^2+(x_2)^2+(x_3)^2+...+(x_n)^2},\alpha\)</span> 为两向量之间夹角。向量内积一般用来计算投影（令 <span class="math inline">\(|b|=1\)</span>，则 <span class="math inline">\(a \cdot b=|a|cos(α)\)</span>，即为向量 a 在 b 上的投影），和两向量之间角度。</p>
<p><strong>向量外积：</strong>又称向量叉积，向量叉乘，<span class="math inline">\(|a×b|=||a|*|b|*sin(\alpha)|\)</span>。向量外积一般只针对二维向量和三维向量，对于二维向量，<span class="math inline">\(a×b=a.x*b.y-b.x*a.y\)</span>，可以认为是一个值（其实也是一个向量），对于三维向量 <span class="math inline">\(a×b=(a.y*b.z-b.y*a.z, a.x*b.z-b.x*a.z, a.x*b.y-b.x*a.y)\)</span>，是一个向量，且该向量一定垂直于 a，b 两向量构成的平面，所以三维向量的外积一般可以用来计算平面的法向量。向量外积的几何意义为两向量构成平行四边形的面积，二维向量外积直接取绝对值即为面积，不取绝对值则可以用来判断两向量构成三角形的点是以顺时针排列（小于 0）的还是逆时针排列（大于 0）的，三维向量外积取所得向量的模即为面积。</p>
<p><strong>向量混合积：</strong> 设 <span class="math inline">\(a\)</span>，<span class="math inline">\(b\)</span>，<span class="math inline">\(c\)</span> 为空间中三个向量，则其混合积 <span class="math inline">\((a,b,c)= (a×b)·c = -(c×b)·a = -(a×c)·b\)</span>，<span class="math inline">\((a,b,c) = (b,c,a) = (c,a,b)\)</span>。若 <span class="math inline">\(a\)</span>，<span class="math inline">\(b\)</span>，<span class="math inline">\(c\)</span> 都为 3 维的向量，矩阵 <span class="math inline">\(A = [a, b, c]\)</span>，则 <span class="math inline">\(|A| = (a, b, c)\)</span> ，其中 <span class="math inline">\(a,b,c\)</span> 是列向量或行向量都可以，因为 <span class="math inline">\(|A| = |A^T|\)</span>，该混合积的几何意义为这三个向量组成的平行六面体的体积。</p>
<p><strong>直线参数方程：</strong>设 P 为直线上任意一点，若 P1 和 P2 为直线上已知两点，则 <span class="math inline">\(P=P1 + (P2-P1)*t, t\in[-∞,+∞]\)</span>。当然直线的参数方程有很多种形式，之所以用两点式，是因为两点式除了能表示直线，同样能表示射线（<span class="math inline">\(t\ge 0\)</span>），也能表示线段（<span class="math inline">\(0\le t\le 1\)</span>）。</p>
<p><strong>平面方程：</strong>设 P 为平面上任意一点，O 为平面上已知一点，n 为平面法向量，则平面方程为：<span class="math inline">\((P-O)·n=0\)</span> 。</p>
<p><strong>三角形内的点：</strong>设 P0，P1，P2 为三角形 3 个顶点，若 P 为三角形内一点，同时可认为 (P1-P0) 和 (P2-P0) 为一组基向量，则 P 满足 <span class="math inline">\(P=P0+u*(P1-P0)+v*(P2-P0),u \in [0,1],v \in [0,1],u+v\le 1\)</span>。</p>
<h2 id="距离篇">距离篇</h2>
<p>　　一般的距离计算都是向量计算，要么点乘，要么叉乘。</p>
<h3 id="点到直线的距离">点到直线的距离</h3>
<p>　　计算点到直线的距离通用的解法是使用向量叉乘，设 P 为直线外一点，Q1 和 Q2 为直线上两点，则可得到两向量 <span class="math inline">\(a=P-Q1, b=Q2-Q1\)</span>，则 P 到直线的距离为 <span class="math inline">\(d=|a×b|/|b|\)</span>，叉乘是面积，而面积又等于底乘高，<span class="math inline">\(|b|\)</span> 为底，<span class="math inline">\(d\)</span> 为高。当然点到直线的距离还有其他的一些方法，如 利用公式，利用点积再使用勾股定理，直接利用点积计算直线法向量上的投影等，这些方法都有一定的局限性。</p>
<h3 id="点到线段的距离">点到线段的距离</h3>
<p>　　设 d 为点 P 到线段的距离，表示为点 P 到线段上最近点的距离，设 P1，P2 分别为线段两端点，计算 <span class="math inline">\(a=(P-P1)·(P2-P1) / |P2-P1|\)</span>，若 <span class="math inline">\(0≤a≤1\)</span>，则 d 为点 P 到线段所在直线的距离，若 <span class="math inline">\(a&lt;0\)</span>，则 d 为点 P 到点 P1 的距离，若 <span class="math inline">\(a&gt;1\)</span>，则 d 为点 P 到点 P2 的距离。</p>
<h3 id="三维中点到三角形的距离">三维中点到三角形的距离</h3>
<p>　　先计算点 P 到三角形所在平面的投影点 <span class="math inline">\(P&#39;\)</span>，若 <span class="math inline">\(P&#39;\)</span> 在三角形内，则只需要求点 P 到三角形所在平面的距离，否则需要分别求点 P 到三角形三条边的距离（点到线段的距离），取三个距离中最小值即为点到三角形的距离。</p>
<h3 id="点到平面的距离">点到平面的距离</h3>
<p>　　直接利用点乘计算，平面外一点与平面内一点构成的向量到平面法向量上的投影，即为点到平面的距离。设 P 为平面外一点，O 为平面内一点，n 为平面法向量，则点 P 到平面的距离为 <span class="math inline">\(d=(P-O) \cdot n\)</span>。</p>
<h3 id="直线到直线的距离">直线到直线的距离</h3>
<p>　　设 P1 和 P2 为直线 1 上两点，Q1 和 Q2 为直线 2 上两点，则直线 1 与直线 2 之间的距离计算流程为：</p>
<ol type="1">
<li>先判断两直线是否平行，即 <span class="math inline">\((P2-P1) = k*(Q2-Q1), k \neq 0\)</span> 有解。若平行，则相当于计算点到直线的距离；若不平行，则进行下一步。</li>
<li>再判断两直线是否共面，即 P1，P2，Q1，Q2 四点共面，先计算 <span class="math inline">\(n=(P2-P1)×(Q2-Q1)\)</span>，再分别计算 <span class="math inline">\(n·(Q1-P1), n·(Q2-P1), n·(Q1-P2), n·(Q2-P2)\)</span>，若这四个值都为 0 ，则两直线共面（之所以需要判断 4 个值，是为防出现 3 点共线情况，当然也可以先判断 3 点共线，再取不共线的一点构成向量与 n 做点积进行判断），若两直线共面，则两直线必然相交；若两直线不共面，则两直线间距离为 <span class="math inline">\(d=(Q1-P1) \cdot n\)</span>。</li>
</ol>
<h3 id="直线到平面的距离">直线到平面的距离</h3>
<p>　　设 P1 和 P2 为直线上两点，n 为平面法向量，则直线与平面之间的距离计算流程为：</p>
<ol type="1">
<li>先判断直线与平面是否平行，即若 <span class="math inline">\((P2-P1) \cdot n = 0\)</span> ，则直线与平面平行，则直线到平面的距离为 点 P1 到平面的距离；</li>
<li>若直线与平面不平行，则直线与平面必相交。</li>
</ol>
<h2 id="相交篇">相交篇</h2>
<p>　　一般的相交求交点都是联立方程组，但有些只需要做相交测试的，可以利用一些特殊方法快速求出来。有些相交直接求很麻烦或很难，可以反向求不相交的情况，而在实际编程中，一般都有很多条件语句，以便快速返回提高效率。</p>
<h3 id="直线与直线相交">直线与直线相交</h3>
<p>　　设直线 1 方程为 <span class="math inline">\(P=P1 + (P2-P1)*t\)</span>，直线 2 方程为 <span class="math inline">\(P=Q1 + (Q2-Q1)*u\)</span>，联立两方程得 <span class="math inline">\(P1 + (P2-P1)*t = Q1 + (Q2-Q1)*u\)</span>，即 <span class="math inline">\(P1-Q1 = (Q2-Q1)*u - (P2-P1)*t\)</span>，设 <span class="math inline">\(v_0=Q2-Q1,v_1=P1-P2,v_2=P1-Q1\)</span>，即 <span class="math inline">\(v_0*u+v_1*t=v_2\)</span>，现在的问题就是解这个方程了，一种是直接把向量分解成单一维度，列方程组；一种是等式两边分别同时点乘 <span class="math inline">\(v_0\)</span> 和 <span class="math inline">\(v_1\)</span>，可得 <span class="math display">\[
\begin{cases} 
    (v_0 \cdot v_0)*u+(v1 \cdot v_0)*t=v_2 \cdot v_0 , 
    \\  (v_0 \cdot v_1)*u+(v1 \cdot v_1)*t=v_2 \cdot v_1
\end{cases}
\]</span> 解得： <span class="math display">\[
\begin{cases} 
    u=((v1·v1)(v2·v0)-(v1·v0)(v2·v1)) / ((v0·v0)(v1·v1) - (v0·v1)(v1·v0)) , 
    \\  t = ((v0·v0)(v2·v1)-(v0·v1)(v2·v0)) / ((v0·v0)(v1·v1) - (v0·v1)(v1·v0))
\end{cases}
\]</span> 若方程有解，则两直线相交，由于两点式方程可以很简单的转换为线段和射线，所以该方法同样可以判断两线段相交，两射线相交，射线与直线与线段相交等。针对二维直线，还有一种解法是将原方程写成矩阵形式，利用克莱姆法则进行求解，不过总的来说，最终的解都是一种形式。</p>
<h3 id="直线与平面相交">直线与平面相交</h3>
<p>　　求直线与平面相交，直接联立直线方程和平面方程即可，得 <span class="math inline">\((P1-O+(P2-P1)*t)·n=0\)</span> ，即 <span class="math inline">\(t=(P1-O)·n/((P1-P2)·n)\)</span>。若 t 有解，则直线与平面相交。同样也可以用该方法判断线段或射线与平面相交。</p>
<h3 id="直线与三角形相交">直线与三角形相交</h3>
<p>　　二维中判断直线和三角形相交相当于判断直线和线段相交，而在三维中则同样需要联立直线和三角形方程，设直线方程为 <span class="math inline">\(P=P1+(P2-P1)*t\)</span>，三角形方程为 <span class="math inline">\(P=Q1+(Q2-Q1)*u+(Q3-Q1)*v\)</span>， 则联立后方程为 <span class="math inline">\(P1-Q1=(P1-P2)*t+(Q2-Q1)*u+(Q3-Q1)*v\)</span>，令 <span class="math inline">\(V_0=P1-Q1,V_1=P1-P2,V_2=Q2-Q1,V_3=Q3-Q1\)</span>，则 <span class="math inline">\(V_0=V_1*t+V_2*u+V_3*v\)</span>，可以分解向量求解，也可以使用克莱姆法则得： <span class="math display">\[
t = \frac{\begin{vmatrix} V_0 &amp; V_2 &amp; V_3 \end{vmatrix}}{\begin{vmatrix} V_1 &amp; V_2 &amp; V_3 \end{vmatrix}}
\qquad
u = \frac{\begin{vmatrix} V_1 &amp; V_0 &amp; V_3 \end{vmatrix}}{\begin{vmatrix} V_1 &amp; V_2 &amp; V_3 \end{vmatrix}}
\qquad
v = \frac{\begin{vmatrix} V_1 &amp; V_2 &amp; V_0 \end{vmatrix}}{\begin{vmatrix} V_1 &amp; V_2 &amp; V_3 \end{vmatrix}}
\qquad
\]</span> 由于三阶行列式也可以用向量混合积来求值，所以 <span class="math display">\[
t = \frac{-V_0 × V_3 · V_2 }{V_1 × V_2 · V_3}
\qquad
u = \frac{V_0 × V_3 · V_1 }{V_1 × V_2 · V_3}
\qquad
v = \frac{V_1 × V_2 · V_0 }{V_1 × V_2 · V_3}
\qquad
\]</span> 若方程有解，且满足三角形条件，则相交。</p>
<h3 id="二维中凸多边形与凸多边形相交">二维中凸多边形与凸多边形相交</h3>
<p>　　曾在「<a href="https://cniter.github.io/posts/ff29de94.html">快速判断三角形与长方体相交</a>」中写过判断两凸多边形是否相交直接使用分离轴理论（separating axis theorem， AST）即可，简而言之就是，取两多边形任意一条边，计算两多边形在该边法向量上的投影是否相交，若存在一条边，使投影不相交，则两凸多边形不相交。</p>
<h3 id="二维中点在多边形内">二维中点在多边形内</h3>
<p>　　判断点在多边形内有很多种方法，利用叉乘，面积等方法虽然思想简单粗暴但一般计算量较大，且有一定的局限性，仅限凸多边形，但有一种相对快速且能应对各种简单多边形的方法——射线法，射线法的本质是判断射线与线段相交，即从已知点处引一条沿 X 轴正向的射线，若射线与多边形边的相交条数为奇数，则该点在多边形内，该法的缺陷在于若点在边上则需要单独判断。判断该射线与多边形的边是否相交也比较简单，设射线起点为 P0，多边形边的两个端点分别为 P1 和 P2，则射线与边相交需满足的条件为：1、<span class="math inline">\(min(P1.y, P2.y)&lt;=P0.y&lt;=max(P1.y, P2.y)\)</span>；2、<span class="math inline">\(P0.x &lt;= (P2.x-P1.x)*(P0.y-P1.y)/(P2.y-P1.y)+P1.x\)</span>。</p>
<h3 id="圆与三角形相交">圆与三角形相交</h3>
<p>　　判断圆与三角形相交，即判断圆心到三角形各边的距离是否小于圆的半径，若存在一条边，使圆心到其的距离小于半径，则圆与三角形相交，<em>该距离计算不是点到直线的距离，而是点到线段的距离</em>。</p>
<h3 id="直线与长方体相交">直线与长方体相交</h3>
<p>　　判断直线与长方体相交，首先需要将坐标原点平移至长方体中心，再计算过原点且垂直于直线的法向量 n ，随后计算原点到直线的距离 d，若满足 <span class="math inline">\(|d| &lt;= h_x|n_x| + h_y|n_y| + h_z|n_z|\)</span> ，则 直线与长方体相交。法向量 n 的求法为：设 P 为直线上一点，l 为直线方向向量，则 <span class="math inline">\(n=-(P·l)*l+P\)</span>。</p>
<h3 id="球与-aabb-相交">球与 AABB 相交</h3>
<p>判断球与 AABB 相交，首先需要将坐标原点平移至球心，设平移后的 AABB 最小顶点为 V1，最大顶点为 V2，球半径为 r。最简单粗暴的当然是若原点不在 AABB 内，则直接求原点到 8 个面的距离，取最小值，若最小值比半径大，则不相交。另一种方法是将这个问题转化为求解不等式，若存在一点 <span class="math inline">\(P(x, y, z)\)</span>，使 P 在球内，同时 P 在 AABB 中，即： <span class="math display">\[
\begin{cases} 
    x^2+y^2+z^2 ≤ r^2 , 
    \\  V1.x ≤ x ≤ V2.x ,
    \\  V1.y ≤ y ≤ V2.y ,
    \\  V1.z ≤ z ≤ V2.z 
\end{cases}
\]</span> 若该不等式有解，则球与 AABB 相交，否则不相交。解该不等式也简单，由于是存在而不是任意，所以只需要求 <span class="math inline">\(min(x^2+y^2+z^2)≤r^2 \Rightarrow min(x^2) + min(y^2)+ min(z^2)≤r^2\)</span>，则若 xyz 分量可以取 0，则对应分量取 0，否则取 <span class="math inline">\(x = min(|V1.x|, |V2.x|), y = min(|V1.y|, |V2.y|),z = min(|V1.z|, |V2.z|)\)</span>，若满足不等式，则相交。</p>
<p>该方法同样可用来求 OBB 与球相交，只需要先利用坐标系变换将 OBB 转成 AABB。</p>
<h2 id="反射篇">反射篇</h2>
<p>　　令入射向量为 <span class="math inline">\(I\)</span>，法向量为 <span class="math inline">\(N\)</span>，反射向量为 <span class="math inline">\(R\)</span>，入射向量与反射向量构成的平面与镜面交线的方向向量为 <span class="math inline">\(T\)</span>，这四个向量都为单位向量。首先以 <span class="math inline">\(I\)</span> 和 <span class="math inline">\(R\)</span> 组成一个菱形，则 <span class="math inline">\(N\)</span> 和 <span class="math inline">\(T\)</span> 则为该菱形对角线的方向向量，若已知 <span class="math inline">\(I\)</span> 和 <span class="math inline">\(R\)</span>，则 <span class="math inline">\(N = (R - I).normalize()\)</span>，<span class="math inline">\(T = (I + R).normalize()\)</span> ，<span class="math inline">\(normalize()\)</span> 指向量归一化；若已知 <span class="math inline">\(I\)</span> 和 <span class="math inline">\(N\)</span>，则 <span class="math inline">\(R = I + 2*|I \cdot N|*N\)</span>，<span class="math inline">\(2*|I \cdot N|*N\)</span> 为菱形 <span class="math inline">\(N\)</span> 方向的对角线向量。</p>
<p>　　镜面反射公式为 <span class="math inline">\((r&#39;,g&#39;,b&#39;) = (r,g,b) + (1-r,1-g,1-b)*t\)</span>，当 <span class="math inline">\(t\)</span> 越大则越接近白色，表现为越亮；漫反射公式为 <span class="math inline">\((r&#39;,g&#39;,b&#39;) = (r,g,b)*t\)</span>，当 <span class="math inline">\(t\)</span> 越小，则越接近黑色，表现为越暗。 其中 <span class="math inline">\(t\in[0,1]\)</span>，<span class="math inline">\(t\)</span> 为入射向量到平面法向量上的投影，即点积。</p>
<h2 id="后记">后记</h2>
<p>　　该篇不出意外的话也会是一个长期支持篇，等以后有碰到其他的一些计算几何知识再持续更新吧。</p>
]]></content>
      <categories>
        <category>Image&amp;Graphic</category>
      </categories>
      <tags>
        <tag>algorithm</tag>
        <tag>geometry</tag>
      </tags>
  </entry>
  <entry>
    <title>论如何科学的上网</title>
    <url>/posts/df943c4f.html</url>
    <content><![CDATA[<p>科学式上网推荐组合：Chrome，Proxy SwitchyOmega，Lantern 等代理工具。</p>
<h2 id="前言">前言</h2>
<p>　　所谓的科学式上网，懂的自然懂，Shaun 也就不做过多解释了。本来一直在用别人免费提供的 pac 代理，但最近可能别人关掉了，上不了 google 了，就只能另寻他路了。所谓的另寻他路也就是尝试云端框架网站站长 <strong><em>枂下</em></strong> 提供的另外几种科学式上网攻略。本文只是对 <strong><em>枂下</em></strong> 站长的攻略做一下试验记录，若想看原滋原味的攻略，还请移步 <a href="https://cloudfra.com/">云端框架</a>。</p>
<span id="more"></span>
<h2 id="科学的上网方法">科学的上网方法</h2>
<p>　　尽量使用 Chrome 进行科学式上网，因为其有一个代理管理插件 Proxy SwitchyOmega，该插件称之为代理切换神器也不为过，网上大量的教程和配置文件也是基于该神器做的。使用 Proxy SwitchyOmega 需要进行配置，这对初学者有一定的难度，这里 Shaun 推荐直接使用站长 <strong><em>枂下</em></strong> 提供的配置文件，至于 SwitchyOmega 的配置文件可以去站长的 <a href="https://cloudfra.com/">云端框架</a> 网站上去下，也可以联系 Shaun 。至于代理工具请看下文，Shaun 目前也只尝试过使用以下几种工具。</p>
<h3 id="lantern">lantern</h3>
<p>　　其实 Shaun 最先尝试的工具是 XX-NET，但是其配置起来稍显繁琐，而且在第一步的时候必须处在科学式上网环境，而 Lantern 就比较简单了，只要装上之后再稍微动动手脚就可以了，所以就把 lantern 写在第一位了。从站长 <strong><em>枂下</em></strong> 那下载【蓝】灯电脑破解版压缩包，不过 Shaun 觉得应该随便在哪里下载个原版 lantern-2.2.5 安装都可以，只要后续的破解方法一样即可。</p>
<p>　　具体破解方法为：主要是令 lantern 一直保持在 2.2.5 版本不变。但是一般来说 lantern 在安装之后会自动更新到最新版（Shaun 在两台电脑上都安装过 lantern，其中一台安装完之后打开 lantern 安装文件夹发现其已更新，而另一台却没有更新，这就有点玄学了 -_-!），至于判断 lantern 有没有更新的办法是：首先进入 lantern 的安装文件夹：<code>C:\Users\XXX\AppData\Roaming\Lantern</code>（将XXX改成自己的用户名），1、看 lantern.exe 文件的修改日期，如果还是 2016 年的，就说明其还没更新；2、显示隐藏文件，看有没有 .lantern.exe.old 文件，如果没有，则也还没更新。如果已经更新了，参考站长 <strong><em>枂下</em></strong> 的说法：</p>
<blockquote>
<p>删除lantern.exe文件，修改.lantern.exe.old为lantern.exe</p>
</blockquote>
<p>这样就又可以回退至 lantern-2.2.5 版。如果没更新的话就不用进行删除回退这一步，直接进行下一步。</p>
<p>　　下一步为修改 lantern-2.2.5.yaml 文件中的更新路径 <code>updateserverurl</code>，使 lantern 永远不再更新，一直维持在 2.2.5 版本不变。具体更改方式为：</p>
<blockquote>
<p>将其中的</p>
<p><code>updateserverurl: https://update.getlantern.org</code></p>
<p>修改为</p>
<p><code>updateserverurl: https://pic.black1ce.com</code></p>
</blockquote>
<p>修改完之后保存退出。这里 Shaun 觉得可以随便将其修改成其它路径即可，毕竟只是让其不更新而已，这个路径应该除了更新就没有其它作用了，这纯属 Shaun 拙劣的猜测，有（ai）兴（gao）趣（shi）的童靴可以试试 :-P。</p>
<p>　　原本以为到这一步就完成了，但是 <strong><em>枂下</em></strong> 站长后来又补发了一步，就是上面几步只是让 lantern 不再更新，而 500M 流量之后限速的问题仍然存在（Shaun 目前还没超过 500M，所以不知道这个问题，但抱着有备无患的心态先把 <strong><em>枂下</em></strong> 站长的攻略记一下 O(∩_∩)O~），所以接下来才是上正菜，破解“限制500M流量”问题的具体方法为：当使用 lantern 流量超过 500M 时，打开 lantern 的安装目录，打开 lantern-2.2.5.yaml 文件，</p>
<blockquote>
<p>修改其中第九行的设备号，随意更换一个数字或者字母即可。</p>
</blockquote>
<p>按 <strong><em>枂下</em></strong> 站长的说法是 8 位随机字母数字大小写均可，只是为方便起见推荐只改动某位即可。</p>
<p>eg：Shaun 目前第 9 行为：<code>deviceid: Gu25Sfoz</code>，一旦 500M 流量用完了，Shaun 就只需要将其修改为 <code>deviceid: Gu25Sfoa</code> 即可。</p>
<p>到这一步 lantern 的破解算是基本完成了吧，如果 <strong><em>枂下</em></strong> 站长有新的更新且被 Shaun 看到的话再进行实验更新吧。</p>
<hr />
<h3 id="xx-net">XX-NET</h3>
<p>　　该工具应该是 Shaun 尝试配置的首款代理工具，不得不说其配置和 lantern 相比实在是太复杂了，而且其中有一步还必须处在科学式网络环境中，Shaun 还是借助别人的 VPN 上的（当时还没用 lantern，所以没用其 500M 免费不限速的流量 ~~o(&gt;_&lt;)o~~）。Shaun 经过实测 XX-NET 无法在 Firefox 中用 google 搜索，一用 google 搜就会报错：</p>
<blockquote>
<p><font size=7 face="黑体"><strong>您的连接并不安全</strong></font></p>
<p>www.google.com 的网站管理员未正确配置网站。为避免您的信息被窃，Firefox 没有与该网站建立连接。</p>
<p>此网站采用了 HTTP 严格传输安全（HSTS）机制，要求 Firefox 只能与其建立安全连接。正因如此，您也不能将此证书加入例外列表。</p>
<blockquote>
<p>www.google.com 使用了无效的安全证书。 该证书因为其颁发者证书未知而不被信任。 该服务器可能未发送相应的中间证书。 可能需要导入一个额外的根证书。 错误代码: SEC_ERROR_UNKNOWN_ISSUER</p>
<blockquote>
<p>https://www.google.com/search?q=test&amp;ie=utf-8&amp;oe=utf-8</p>
<p>对等端的证书颁发者不受认可。</p>
<p>HTTP 严格传输安全（HSTS）：false HTTP 公钥钉扎：true</p>
<p>证书链：</p>
<p>-----BEGIN CERTIFICATE----- MIIDkzCCAnugAwIBAgIQSu4RvcIwnqiEQE6Z68FlaDANBgkqhkiG9w0BAQsFADBz MQswCQYDVQQGEwJDTjERMA8GA1UECAwISW50ZXJuZXQxDzANBgNVBAcMBkNlcm5l dDEQMA4GA1UECgwHR29BZ2VudDEVMBMGA1UECwwMR29BZ2VudCBSb290MRcwFQYD VQQDDA5Hb0FnZW50IFhYLU5ldDAeFw0xNzA5MTYxNDIzMjRaFw0yNzA5MTQxNDMz MjRaMHgxCzAJBgNVBAYTAkNOMREwDwYDVQQIDAhJbnRlcm5ldDEPMA0GA1UEBwwG Q2VybmV0MRcwFQYDVQQLDA5Hb0FnZW50IEJyYW5jaDEVMBMGA1UEAwwMKi5nb29n bGUuY29tMRUwEwYDVQQKDAwqLmdvb2dsZS5jb20wggEiMA0GCSqGSIb3DQEBAQUA A4IBDwAwggEKAoIBAQDL3K1OgwalKOJPtO4urpAiu+lioGNax/EIaYR1D2kH66AJ lpal0pYFhXF6MOYCUNfpZIqP5qAQs7JGuRmFdo7rWaLHZ+3S+TlIHdZkoLvyYBcX ENVBcLQvZ7IL7DDUZObK/R7OOKz82dEoITQnT+q/lecR9wQ7QNdNVNqn0xS0NPt7 bS76irMxkJcO2q7Lu4R56ImCox/G7dUEepjL0Po516l6fLKG3qi5org2z6ap0yl2 Etu8cRfqiqaqhO0HI1Twz+Rbp/8KUdUBgnNkjcod83HE+jJKxIUDmn18+l7J8sBi a0JvWSIYy2ccFXoR8L4lfvIa8PhTuMmpxyDkwDdPAgMBAAGjHjAcMBoGA1UdEQEB /wQQMA6CDCouZ29vZ2xlLmNvbTANBgkqhkiG9w0BAQsFAAOCAQEADiM6yWCaGNLn ggirjN0b34j5JmjgYYx3bRaKDe4We2emjlLsdskBo2ztkd/tPBfUa7DWExgFPvVq B2FeEf85Zj72kMmc2JikJBtPF1qK9fa4O1gST4VE0xIF99zGrgkDhGaYd1ocElWS qfBNQfzwsO+nl2OQf99ATMqMSCGacN7z+LJBLn65de+ODzYUkIHzhU5/xJMian3y fQzNFCAgK8OMf16excqRUcX8zfGPfvtAafDrdOYEXcGayLIvt4tGr8T+tii+MtCR O5hXK8/ABMLGI74zgLYloVFjJv21VsLrNCvvD43T5E3c+8d1MENozdEnsyzWkTkp knP4aEiLOQ== -----END CERTIFICATE-----</p>
</blockquote>
</blockquote>
</blockquote>
<p>Shaun 不知道为什么 (+﹏+)~。所以为了能正常使用科学式网络，还是老老实实的用 Chrome 吧，何况其还有 Switchyomega 神器，并且建议把 Chrome 设置为默认浏览器。具体配置流程如下：</p>
<p>　　从 <strong><em>枂下</em></strong> 站长那下载 XX-NET（Shaun 其实最先是直接在 GitHub 上下载最新的 XX-NET，但 Shaun 由于在 Firefox 上尝试失败了，当时也没在 Chrome 上尝试，以为最新版 XX-NET 有问题，后来用上 <strong><em>枂下</em></strong> 站长那下的 XX-NET 在 Chrome 上试了下可以，而 Firefox 不行，就知道可能是 Firefox 的问题，而既然已经能用了，Shaun 也没用最新的 XX-NET 在 Chrome 上尝试了），直接解压到某个文件夹，然后将 XX-Net-3.3.6 文件夹重命名为 XX-Net，即去掉末尾的版本号，据 <strong><em>枂下</em></strong> 站长说法是为了减少后续 XX-NET 出错（Shaun 这里老老实实的照 <strong><em>枂下</em></strong> 站长说的做了，所以也不知道如果没去掉版本号会有什么后果）。接着以管理员身份运行 XX-Net 目录下的 start.vbs 文件（这里右键是没有“<strong>以管理员身份运行</strong>”选项的，要想以管理员身份运行就只有使用 Windows 命令行了，具体做法就是以管理员身份运行“<strong>命令提示符</strong>”，再在其中运行 start.vbs 文件即可），运行成功后将弹出</p>
<blockquote>
<p>已经导入GoAgent证书,请重启浏览器.</p>
</blockquote>
<p>点击确定即可。再次启动默认（Chrome）浏览器，将打开 127.0.0.1:8085 页面，即为 XX-NET 的配置界面。将看到 GAEProxy 状态信息（可能是由于 google 取消了公共 APPID，所以 Shaun 看到的不是“<strong>您正在使用公共APPID，....</strong>”这条消息，而是另外一条消息（具体什么消息 Shaun 忘记了 o(╯□╰)o）），打开显示详细信息（其实也没用，Shaun 并看不懂这么多 -_-|||），先放这里吧，部分信息以后再说，先进入正式配置步骤。</p>
<ol type="1">
<li>首先点击左边的“<strong>高级</strong>”选项，据<strong><em>枂下</em></strong>站长说，将自动调整扫描线程数关掉，最大扫描线程数设为 200，点击提交（可能这样连接速度更快一些）。Shaun 这里这里没有照做，而是保持默认设置，Shaun 只是要求能上就可以了，对速度要求可以稍微放松一点（或许以后会调成站长推荐的配置）。</li>
<li>接下来点击“<strong>部署服务端</strong>”选项，填写 AppID，点击“<strong>开始部署</strong>”。但是这一步，Shaun 并没有 AppID，所以只能上 google 申请，这样最麻烦的一步就来了。照着 <strong><em>枂下</em></strong> 站长的指引，Shaun 一步步的申请了 AppID。具体申请步骤如下（这一步需要登录 google 账号，必须处于科学式网络环境）：
<ol type="1">
<li>点击 <a href="https://appengine.google.com">打开Appid申请页面</a>，登录 google 账号，创建项目，并在新建项目中修改项目 ID（这就是第一个 AppID ），为方便，建议直接以“项目名-00”的方式按顺序命名 AppID，创建成功后继续点击“<strong>Google Cloud Platform</strong>”旁的一个小三角，点击弹框的“<strong>+</strong>”，按上述方式进行创建新的 AppID，如此重复，Shaun 总共创建 10 个 AppID，10 个之后会提示配额已用完，硬是要创建只会覆盖掉第一个 AppID。</li>
<li>接下来就是需要选择语言和地区，只有为每个 AppID 选择语言和地区之后，该 AppID 才会生效。语言和地区的选择界面可以从“<strong>App Engine</strong>”界面中进入，也可以直接在添加 AppID 界面的那个弹框中点击相应的 AppID 进入，当然如果是第一个 AppID 选择语言可以直接点击界面上的“<strong>选择一种语言</strong>” 。语言选择 Python，地区选择亚洲（asia-northeast1），选错了后果自负（当然可以覆盖掉该 AppID 重新设置）。其实可以照 <strong><em>枂下</em></strong> 站长那样设置完第一个 AppID 的语言和地区之后直接修改浏览器的地址栏的 url 以快速设置 AppID 的语言和地区。具体修改方法为：将 url 地址末尾的 project 参数的值改为你想要设置的下一个 AppID，eg: Shaun 当前 AppID 为 test-00，对应的浏览器 url 地址末尾的参数为 <code>lang=python&amp;project=test-00</code>，Shaun 想设置的下一个 AppID 为 test-01，则只需将其修改为 <code>lang=python&amp;project=test-01</code> 回车即可快速设置 test-01 的语言和地区。如此重复，就可以设置完全部的 AppID 语言和地区。设置完之后，这些 AppID 就能进行部署了（据说每个 AppID 每天有 1G 的流量可以使用，并于每天下午三点更新，也就是 Shaun 每天有 10G 流量，一般是够用了 :-D）。</li>
</ol></li>
<li>将上文申请并设置完成的 AppID 放入“<strong>GAE AppID</strong>”文本框中，多个 AppID 可以按这样的格式放入：<code>test-01|test-02|test-03</code>，两个 AppID 以<code>|</code>分隔即可。点击“<strong>开始部署</strong>”，会弹出一个登录 google 账号的标签页，登录并允许即可，等待 2~5 分钟，可发现日志页面出现 <code>Done!</code>和<code>Deploy 10 appid successed.</code> 等字样即表示服务端部署成功。</li>
<li>点击“<strong>部署</strong>”选项，将上面部署服务端的 AppID 以相同格式输入“<strong>GAE AppID</strong>”文本框中，点击“<strong>保存</strong>”即可。保存完之后，即可在状态信息界面显示详细信息中 Appid 发现当前工作 AppID 就是部署的 AppID ，至于那个配置下的监听代理就是设置代理的地址和端口。</li>
</ol>
<p>这样 XX-NET 就算是配置完成了，至于 <strong><em>枂下</em></strong> 站长说的扫描 ip，Shaun 就没做实验了，因为这样配置完就可以科学式上网了。</p>
<hr />
<p>　　以上代理工具配置完成后，即可在 Chrome 中畅游 Internet 了，但是正确的科学式上网姿势应该是：国内的网站走本地连接，而国外被屏蔽的网站才走代理。这就需要 Proxy SwitchyOmega 这款插件了，它能按照一定的规则自动选择走本地还是走代理，这样既不会浪费流量，也能使国内的网站联网速度不受影响。导入前文推荐的配置文件后，就可选择对应的代理方式。这里当然是选择自动切换，至于虚拟切换是选择 <strong>Lantern for 8787</strong> 还是 <strong>XXNET for GAE</strong> 就随便个人的喜好了（在走代理的时候别忘了把相应的代理工具开启）；如果直接选择其中一种代理方式就相当于全局代理，这也就失去这款插件的作用，只有自动切换加上虚拟切换才能充分发挥这款神器的真正作用。</p>
<h2 id="匿名网络">匿名网络</h2>
<p>　　要想使用匿名网络，当然少不了专用的浏览器：<a href="https://www.torproject.org/">Tor Browser</a>，下载并安装（下载时需要身处科学式网络环境，安装时最好改变一下目录，而且路径中最好不要有中文）。接下来就是配置了 Tor 网络了。具体配置流程如下：</p>
<p>　　首先，它问直接连接 Tor 网络还是配置网桥或代理，这里当然是选择<strong>配置</strong>；其次它问互联网服务提供商( ISP )是否对 Tor 网络连接进行了封锁或审查，这里选<strong>否</strong>，据<strong><em>枂下</em></strong>站长所说因为国内网桥大部分已失效，连接网桥没有意义还会拖慢速度；然后它问是否本地代理访问互联网，这里当然选择<strong>是</strong>；最后填写本地代理配置，这里需要注意，<strong><em>枂下</em></strong>站长提供的部分代理配置是：</p>
<blockquote>
<p>SSR/SS Socks5//127.0.0.1 : 1080</p>
<p>Seed HTTP//127.0.0.1 : 1080</p>
<p>Lantern Socks5//127.0.0.1 : 8287（2系列），三系列的在Lantern设置页面查看</p>
<p>Psiphon 可以在配置页面自定义</p>
</blockquote>
<p>　　其中经 Shaun 实测，上面 Lantern 的代理配置是连接不上的，Shaun 后来参考 SwitchyOmega 配置文件中 Lantern 的代理为 HTTP//127.0.0.1 : 8787，经尝试如此配置可以连接 Tor 网络，所以 Lantern 的正确配置应为：</p>
<blockquote>
<p>Lantern HTTP//127.0.0.1 : 8787（2系列），三系列的在Lantern设置页面查看</p>
</blockquote>
<p>设置完成后等待片刻就能连上 Tor 网络了，最好就保持原来的 <em>DuckDuckGo</em> 搜索引擎，不要更改，接下来就可随心所欲的畅游 Internet 了。</p>
<p>　　至于想访问暗网，可以参考<a href="https://github.com/ckjbug/Hacking/blob/master/%E6%95%B4%E7%90%86%E7%9A%84%E6%9A%97%E7%BD%91%E7%BD%91%E5%9D%80Tor.txt">Hacking/整理的暗网网址Tor.txt</a>和<a href="https://sites.google.com/site/howtoaccessthedeepnet/working-links-to-the-deep-web">Working Links to the Deep Web</a>或者直接用站长<strong><em>枂下</em></strong>给的网址：<code>torlinkbgs6aabns.onion</code>和<code>xmh57jrzrnw6insl.onion</code>。</p>
<p>据<strong><em>枂下</em></strong>站长回答：</p>
<blockquote>
<p>XX-Net可以作tor的前置代理吗？不行的，xx-net是假http协议</p>
</blockquote>
<p>所以 XX-NET 不能用作 Tor 的代理配置。</p>
<p>　　最后再简要记录一下 Chrome 调用 Tor Browser 的代理吧。Shaun 没有像 <strong><em>枂下</em></strong> 站长那样用命令行去实验，只是享受了一下 ta 的试验成果（O(∩_∩)O谢谢）。总而言之，还是利用 SwitchyOmega，代理方式选择 <strong>Tor for 9150</strong>，就可以在 Chrome 中调用 Tor Browser 的代理，畅游 Internet 了。</p>
<hr />
<p><strong><em>更新于：2017-11-27</em></strong></p>
<p>　　时久达期间及之后，lantern 的那种破解方式从时灵时不灵，到完全失效，而 XX-NET 则一开始就失效了，这见证了 Google 和 GFW 的斗智斗勇（๑乛◡乛๑），但很明显，google 失败了，事实证明没有 GFW 封不了的，只是看它想不想封 (๑•ั็ω•็ั๑)。至于 lantern 和 XX-Net 的复活方式请移步 <strong><em>枂下</em></strong> 站长的网站，Shaun 这里就不再赘述了。<strong>这里需要更新的一点是：</strong>Tor 的网桥配置采用“<strong>meet-amazon</strong>”（亚马逊的云计算平台）或者“<strong>meet-azure</strong>”（微软的云计算平台）传输也能实现科学式上网，但速度很慢，仅能浏览网页而已，可以当做备选临时用用。</p>
<hr />
<p><strong><em>更新于 2017-12-24：</em></strong>今天使用了下 <a href="https://psiphon.ca/zh/index.html">赛风（Psiphon）</a>，其操作完全傻瓜式，简直不要太好用，而且为单个绿色文件，携带也方便，用的时候只要设置一下端口就行。不出意外的话，妈妈再也不用担心 Shaun 搞科研了（؏؏☝ᖗ乛◡乛ᖘ☝؏؏）。</p>
<hr />
<p><strong><em>更新于 2018-03-14：</em></strong>现在最新版的 Firefox 59.0 也有 <a href="https://addons.mozilla.org/zh-CN/firefox/addon/switchyomega/">Proxy SwitchyOmega</a> 插件了，虽然还是测试版，但还是能够正常使用，既然 Firefox 有了这款神器，Shaun 也就有动力将 Firefox 使用 XX-Net 连接 Google 搜索出现的问题解决了，首先进入 Firefox 的 「选项」或设置 ==》「隐私安全」，下滑到最下面的「证书」，点击「查看证书」，在弹框中选中「证书机构」，点击「导入」，添加 <code>XX-Net\data\gae_proxy</code>目录下的 <strong>CA.crt</strong> 证书，在导入中出现的弹框全部选中信任，将会在上方的证书栏中出现 GoAgent XX-Net 证书，这样就能解决上文出现的问题，参考自：<a href="https://www.crifan.com/firefox_can_not_open_https_use_invalid_security_certificate_error_code_sec_error_unknown_issuer/">【已解决】Firefox报错：github.com 使用了无效的安全证书。 证书因为未提供证书发行链信而不被信任。 （错误码： sec_error_unknown_issuer）</a></p>
<hr />
<h2 id="后记">后记</h2>
<p>　　最后的匿名网络是 Shaun 弄着好玩的，像暗网这种东西 Shaun 这种遵纪守法的好公民才不会访问呢 (ಡωಡ)。等以后时机到了再去买个国外 VPS 自己搭建一个科学式上网环境吧。最后感谢 <strong><em>枂下</em></strong> 站长的无私分享。</p>
<h2 id="附录">附录</h2>
<p>　　原本还以为 Shaun 搭建的 Hexo+GitHub 个人博客站点还是个深网，没想到搞完科学式上网后用 google 搜索竟然能搜到，虽然 Shaun 没做什么，但 google 仍然能搜到，google 的蜘蛛还挺厉害的，不过如果百度的蜘蛛没被 GitHub 屏蔽的话百度可能也能搜到（从某些原因上来说，GitHub 把百度屏蔽掉也好 O(∩_∩)O~）。既然已经被 google 收录了，Shaun 也就不去搞那个站点地图了，等以后想搞 SEO 了再去做吧。</p>
<h2 id="参考资料">参考资料</h2>
<p>[1] <a href="https://cloudfra.com/switchyomega-chrome-firefox.html">Switchyomega超详细教程之Chrome与Firefox版本</a></p>
<p>[2] <a href="https://cloudfra.com/lantern-windows.html">【蓝】灯电脑破解版之2系列禁止自动升级最终办法</a></p>
<p>[3] <a href="https://cloudfra.com/xx-net-important.html">XX-NET史上最详细完整教程</a></p>
<p>[4] <a href="https://cloudfra.com/xx-net-appid-1.html">XX-NET史上最详细完整教程之第一部分：Appid创建部分</a></p>
<p>[5] <a href="https://cloudfra.com/tor-browser-windows.html">Tor Browser在国内Windows平台下的超详细教程</a></p>
<p>[6] <a href="https://cloudfra.com/tor-browser-chrome.html">Chrome等其他程序如何完美调用Tor Browser的代理来上网</a></p>
<p>[7] <a href="https://program-think.blogspot.com/2014/10/gfw-tor-meek.html">“如何翻墙”系列：TOR 已复活——meek 流量混淆插件的安装、优化、原理</a>（<a href="https://program-think.blogspot.com/search/label/IT" class="uri">https://program-think.blogspot.com/search/label/IT</a>）</p>
<p>[8] <a href="https://program-think.blogspot.com/2009/05/how-to-break-through-gfw.html">如何翻墙？——写在 BlogSpot 被封之后 {2015-08-28}</a></p>
]]></content>
      <categories>
        <category>Study</category>
      </categories>
      <tags>
        <tag>gfw</tag>
      </tags>
  </entry>
  <entry>
    <title>设计模式浅谈</title>
    <url>/posts/ae780057.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　进入职场一年半以来，Shaun 完全独立从 0 到 1 开发了 1.5 个项目（当然也有参与其它项目，但不是 Shaun 独立从 0 到 1 开发的，没多少控制权，就不谈了），一个网页版的高精地图编辑器，半个地图可视化系统，这里面 Shaun 用了不少设计模式，这篇就谈谈 Shaun 用过的和没用过的一些设计模式。</p>
<span id="more"></span>
<p>　　以「Head First 设计模式」为参考，Shaun 用 C++ 实现了一遍书中的例子（代理模式及其后面的模式除外），下面进入正文。</p>
<h2 id="模式篇">模式篇</h2>
<h3 id="策略模式">策略模式</h3>
<p>　　Shaun 个人认为最能体现面向对象编程思想（抽象封装继承多态）的一种模式，换句话说，只要真正理解和运用面向对象编程，一定会自然而然的用到策略模式。Shaun 在做高精地图编辑器时，需要设计一个渲染模块，渲染模块会包含高亮行为，高亮有两种，一种是直接改变颜色，一种是使用后期处理（OutlinePass 或 UnrealBloomPass 等）进行高亮，这时就需要在渲染类中组合高亮行为。</p>
<p>　　策略模式中涉及到的原则有：1、封装变化；2、多用组合，少用继承；3、针对接口编程，不针对实现编程。封装变化这点很考验程序员的经验水平，在写代码之初，往往预料不到变化，所以这一点一般是在编码过程中逐渐完善的，不断进行抽象，从而生成比较合理的基类；第二点一般也是对的，但有时在编码过程中难免会碰到到底是用继承还是组合的问题，这时候可以多想想，组合并不是万能的，有时继承更合适，这时可以请教身边更有经验的程序员，组合的优势在于当子类不想要这个对象时，可以随时丢弃，而继承的优势在于，当子类不想实现这个行为时，可以有默认的行为，而且有些时候只能用继承；针对接口编程没啥好说的，就是抽象。</p>
<h3 id="观察者模式">观察者模式</h3>
<p>　　这个模式如果在分布式系统中又叫发布订阅模式，该模式常用于消息通知。前端有个 RxJS 的库将这一模式玩出花来了，Shaun 在高精地图编辑器的事件流管理中就使用了该库。在 threejs 中所有渲染对象的都有一个统一的基类 EventDispatcher，该类中就实现了一个简单的观察者模式，用来处理事件监听触发和通知，和真正的观察者相比，区别在于观察者只是一个函数，而不是一个类，其实浏览器的事件监听机制实现方式也和这个类差不多。</p>
<p>　　观察者模式中涉及到原则有：松耦合。这里的松耦合是指主题和观察者之间是隔离的，观察者可自行实现自己的更新行为，而主题同样可实现自己的通知机制，两者虽有关联但互不影响。松耦合原则说起来人人会说，但真正能实现松耦合的却不多，实现松耦合的关键在于怎样分离两个系统，两个系统的连接点在哪，这有时很难理清，从而造成逻辑混乱，bug 丛生。</p>
<h3 id="装饰者模式">装饰者模式</h3>
<p>　　利用该模式可以很方便的扩展一些方法和属性，尤其是遇到主体和配件这样的关系时，可以很轻松的添加配件到主体上。Shaun 没用过这个模式，本来在扩展 threejs 一个类时想用，但确实没找到非常明确的主体和配件这样的关系，最后还是简单的使用继承了。</p>
<p>　　装饰者模式涉及到的原则有：开放——封闭原则。设计一个类需要考虑对扩展开放，对修改关闭。修改和扩展看似矛盾，但实则可以独立存在，装饰者的配件可以无限加，这是扩展，是开放，而在加配件时无需修改现有代码，这是封闭。当然这一原则并不独属于装饰者模式，应该说是只要用到面向对象的思想开发程序，就一定会用到该原则，否则也就失去了面向对象的意义。但有时这个原则又没必要贯彻彻底，因为对于有些需求可能很难弄清修改和扩展的界限，这时就达到能尽量重用父类的方法就好。</p>
<h3 id="工厂模式">工厂模式</h3>
<p>　　该模式在稍微大一点的系统中应该都会用到，根据不同的输入，生成不同的对象，这就是工厂模式的本质。至于工厂模式的实现方式一般会根据需求的复杂度来决定：1、只有一个工厂，一类产品，只是为了集中一层 if-else，可用简单工厂模式，甚至一个 builder 函数即可；2、有多个工厂，还是只有一类产品，用工厂模式，多个工厂继承一个工厂父类即可，相当于多个简单工厂组合；3、有多个工厂，多类产品，哪个工厂生产什么产品可能有变化，这时需要用到抽象工厂模式，除正常的继承之外，还需使用组合，组合组成产品的父类，相当于再组合一个工厂。Shaun 在高精地图编辑器中当然是大量使用的工厂模式和简单工厂模式，主要是为了集中 if-else 的处理，比如根据不同的数据类型创建不同的属性栏界面（枚举用下拉框，字符串用文本框，数字用数字栏等），根据不同的路网元素创建对应的渲染器对象以及对应的属性界面等。</p>
<p>　　工厂模式涉及到的原则有：依赖倒置原则。尽量依赖抽象，而不是具体类。这其实也是抽象一种作用或好处，即在使用过程中尽量使用最上层的父类，具体类只在创建实例时使用。</p>
<h3 id="单例模式">单例模式</h3>
<p>　　写程序的基本都会用到该模式，主要用来创建全局唯一对象，可用来存储和处理系统中常用的各个模块都会用到的一些数据。Shaun 在编辑器中单例模式用了好几个，比如全局唯一的 viewport，用力绘制 3d 图形；全局唯一的路网数据；当然系统中存在太多的单例模式也不好，最好是只有一个，如 Shaun 的编辑器中最好的模式就是创建一个单例的 Editor 类，需要做单例的对象都可以放在该类中，如此保证系统中只有一个单例类，以进行统一管理。</p>
<p>　　该模式与面向对象倒是没多大关系了，可以认为是全局变量的优化版，毕竟大的系统中全局变量基本不可避免，这时就可以使用单例模式。</p>
<h3 id="命令模式">命令模式</h3>
<p>　　该模式主要用来将函数方法封装成类，这样做的好处就是可以更灵活的执行该方法（将方法放进队列中依次执行，将方法持久化以便系统启动执行），同时也可以保存该方法的一些中间状态，以便撤销操作，回到系统执行该方法前的状态。Shaun 在编辑器中主要用命令模式做撤销重做功能，这基本也是编辑器的必备功能了，可以说没有撤销重做功能的编辑器是不完整的，要实现撤销重做功能除了基本的命令模式之外，还要提供撤销和重做两个栈以保存操作命令。</p>
<p>　　该模式与面向对象也没很大关系，只是提供了一个实现一些特殊功能的标准或通用方案。</p>
<h3 id="适配器模式">适配器模式</h3>
<p>　　该模式正如其名，主要用来转换接口，将一个类的方法用其它类封装一下，以达到兼容其它类接口的目的，同时对外可接口保持不变，该模式通过对象组合实现。Shaun 没使用过该模式，就 Shaun 感觉这个模式应该可以用在维护了好几年的系统上，当新作的东西需要兼容老接口时，可以用适配器模式将新街口封装一下。</p>
<p>　　该模式同样只是提供了一种新接口兼容老接口的一种优良方案，当然实际使用过程中可能很难这么完美，但算是一种思路。</p>
<h3 id="外观模式">外观模式</h3>
<p>　　该模式算是封装的一种体现。当一个功能需要经过多次函数调用才能完成时，这时可以用另一个方法将这些函数都封装起来，从而简化调用方式。Shaun 用该模式处理整个渲染模块的初始化和资源释放，因为初始化时需要分配好很多东西（光照，viewport，固定图层，地面，天空盒等），而释放时同样需要释放这些东西。该模式同样只能算是提供了一种好的编程实践，实际使用过程可能每个函数都有很多参数，调用顺序可能有变，这时简化调用反而没有必要，让用户自己决定怎样调用更好。</p>
<p>　　外观模式涉及到的原则有：最少知识原则。该原则主要用来减少对象依赖，即尽量不将类中组合的对象直接暴露出去，而应该将组合对象的方法再简单封装一下，再将封装后的方法暴露出去，以减少另外的类又依赖类中组合对象的现象。该原则可以适当遵守，因为有时直接使用更方便一点，多次封装之后反而显得逻辑混乱，增加系统的复杂度。</p>
<h3 id="模板方法模式">模板方法模式</h3>
<p>　　该模式是抽象的一种体现。首先抽象出一套固定化的流程，流程中每个步骤的具体行为并一致，有些默认，有些可以重写，父类固定流程，子类负责重写流程中每个步骤，这就时模板方法模式。Shaun 没写过完全符合该模式的代码，只是写了个类似该模式的模块，该模块有三个功能（编辑道路节点，编辑车道节点，编辑车道线），做完前两个功能后，发现这里有一套逻辑是通用的，那就是滑过节点高亮，选择节点，出现 gizmo，拖动 gizmo，完成编辑（当然还有选择节点后不拖动 gizmo 等一套 if-else 中间处理状态），于是 Shaun 把这一套流程抽象出来，固化方法，这三个功能都继承该类，方法该重写的重写，不仅减少了代码量，同时整个流程也更清晰了，很快完成了第三个功能。</p>
<p>　　模板方法涉及到的原则有：好莱坞原则。即由父类负责函数调用，而子类负责重写被调用的函数，不用管父类的调用逻辑，也最好不要调用父类的函数。该原则用来理清流程很方便，只需要看父类即可，但实际编程过程中可能也会遇到子类不可避免的会调用父类的一些公共函数的情况，Shaun 觉得只要流程没问题的话，调用父类函数也能接受，并不需要严格遵守模式。</p>
<h3 id="迭代器模式">迭代器模式</h3>
<p>　　迭代器，即对遍历进行封装，一般只能顺序执行，提供 next() 方法获取下一个元素，集合容器的遍历方式一般都会用迭代器进行封装。Shaun 在这一个半项目里没写过迭代器，毕竟这是非常底层的一个模式，语言库本身有的数据结构大多自己实现了迭代器，除非需要设计一个新的集合或容器数据结构，才需要提供相应的迭代器。因为 js 没有 SortedMap 数据结构，为了高效分配路网元素 id，Shaun 利用 object 简单实现了一个，提供了相应的 forEach 方法。</p>
<p>　　迭代器模式涉及到的原则有：单一责任原则。即一类只做一件事，这个原则对于涉及最最底层的接口很实用，而大多具体类很难只做一件事。迭代器模式对于顺序访问来说还是非常有用的，毕竟使用迭代器的人不需要管底层到底用的什么数据结构，反正可以顺序遍历即可。</p>
<h3 id="组合模式">组合模式</h3>
<p>　　组合模式与其说是一种模式，更不如说就是一颗树，只是树的节点都是可供继承的类。在标准的组合模式中，父类中一定会有全部子类的全部函数，即所有子类的函数要么是继承自父类，要么是重写父类函数的，这其实是违背上面单一责任原则的，因为这必然会造成有些子类不需要这么多函数。而从组合模式会存储孩子节点这点来看，和装饰者模式有点类似，只不过装饰者只会存一个孩子，而组合模式可能会存多个，当然两者做的事是不一样，只是实现手法类似而已。Shaun 没写过标准的组合模式，如果只要符合树形模式都可认为是组合模式，那在高精地图编辑器中，所有路网元素都会继承一个父类，而道路中又包含车道簇，车道簇中包含车道，这也算组合模式。在 threejs 中有个 Object3D 的基类，所有渲染对象都会继承该类，该类中又包含若干孩子，threejs 计算 Model 矩阵时就是一层层孩子的 Model 矩阵乘下去，直到最后的孩子，结果就是最后 Shader 中的 Model 矩阵。</p>
<h3 id="状态模式">状态模式</h3>
<p>　　状态机的状态转移可以说是程序设计中最麻烦的部分之一了，这部分如果写不好的话，根本没法修改维护，同时会造成 bug 频发。在高精地图编辑器中鼠标操作有两类模式，一种是选择模式，另一种是编辑模式，选择模式又分为点选和框选，而编辑模式就非常多了，针对路网的不同元素，编辑模式的具体实现都不会一样，Shaun 首先使用 RxJS 封装了一个鼠标操作类（左键右键中键移动等），后续的鼠标操作都继承自该类，可以算是状态模式的父类，后续的鼠标操作就针对相应的需求实现相应的方法即可，当然其中鼠标操作自身也存在状态转移（左键到右键，左键到鼠标移动等），这些一般都是针对特定需求来的，所以这些小的状态转移一般在鼠标操作内部实现，但需要支持随时从编辑模式到选择模式，这意味着编辑模式编辑到一半的东西都需要支持随时释放，恢复编辑前的样子，这算是一个麻烦的地方，有时忘了释放就会出现问题。</p>
<p>　　状态模式算是为解决状态转移问题提供一种理想的方案，但其具体实现并不一定要和书上一样，Shaun 在用 C++ 实现时就采用另一套方案，状态类是独立的，控制状态转移的代码都在状态机内，而不是书中这种直接在状态类中控制状态机。好处坏处都有，看具体需求，Shaun 的方式就是状态类和状态机是分离的，状态类不需要管状态机怎么实现的，只需要管当前状态的情况，但需要在状态机中管理状态转移，而书中实现方式状态机的状态转移放到状态类中了，也因此状态类需要依赖状态机。</p>
<hr />
<p><em>剩下的模式，Shaun 就没直接写代码实践了，因为大多都需要跨模块实现，有的甚至就是个小项目了，所以就简要谈谈 Shaun 的个人理解</em>。</p>
<h3 id="代理模式">代理模式</h3>
<p>　　主要可以用来做权限控制，在模块与模块之间的调用过程中，有时不想要一个模块可以访问另一个模块的全部内容，这时可以使用代理模式，创建一个中间模块，避免两个模块直接调用，同时进行访问控制。代理模式在如今的互联网时代不可避免的会用到，或直接或间接，往最小的说，对象组合也可用来实现代理模式。</p>
<h3 id="复合模式">复合模式</h3>
<p>　　将多种模式组合在一起使用，比如 MVC 模式，这种模式与其说是模式，更不如说就是一种架构，一种开发包含客户端系统的通用架构，当然每一层都会有很多模式进行组合，从而造成具体实现差异非常大。</p>
<h3 id="反模式">反模式</h3>
<p>　　反模式指的是用“不好的解决方案”去解决一个问题，Shaun 主要想谈谈开发反模式，因为这非常常见。有时候一个解决方案好不好要从多个角度进行衡量，比如现有技术，长期短期，上手难度，开发效率，维护难度等角度，当出现一个新问题时，往往意味着就有解决方案有缺陷，这种缺陷可能很容易弥补，更可能很难，当很难解决时，往往要采用全新的解决方案，这时团队对新解决方案可能都不熟，也没有魄力去采用新解决方案，只能去老解决方案继续强行打补丁，直到最后没法维护，白白浪费了大量的人力和时间，这是非常典型的一种反模式。</p>
<h3 id="桥接模式">桥接模式</h3>
<p>　　将抽象接口和实现分开，并独立派生，以支持抽象和实现的同时改变，并相互独立，可适用在需要跨平台跨不同设备的系统上。</p>
<h3 id="生成器模式">生成器模式</h3>
<p>　　有点像是模板方法模式和工厂模式的结合版，使用多个步骤创建一个对象，但步骤没有固定顺序，可适用于流程复杂的规划系统中。</p>
<h3 id="责任链模式">责任链模式</h3>
<p>　　可以认为是模板方法模式的进阶版，只是模板的步骤方法变成了一个个对象，并且支持步骤的增加和删除，以及更换顺序，一旦某个步骤成功执行，则整个链条终止，可适用于消除显式的 if-else，处理键盘或鼠标事件时，需要针对不同按键触发不同操作，这时可以采用该模式，缺点是链条很长时，要写很多类，导致执行啥很不直观。</p>
<h3 id="蝇量模式">蝇量模式</h3>
<p>　　这个模式算是一种优化内存占用的方案，通过牺牲类的独立性来减少内存，更彻底一点就是不创建类，直接用函数调用来处理就行。</p>
<h3 id="解释器模式">解释器模式</h3>
<p>　　可用来实现简单语法规则语言的解释器或编译器，每个语法规则都由一个类进行解析，然后组合。</p>
<h3 id="中介者模式">中介者模式</h3>
<p>　　可认为是状态模式和代理模式的结合版，不过各个状态可以是不同类，由中介者控制系统流转，集中控制逻辑，使被控制对象解耦，但可能会造成中介者本身非常复杂。</p>
<h3 id="备忘录模式">备忘录模式</h3>
<p>　　可用于系统（游戏）存档，存储系统中关键对象的运行状态，通常实现的方案一般是序列化/持久化，为了效率考虑，难的是有时需要增量存档。</p>
<h3 id="原型模式">原型模式</h3>
<p>　　js 的原型链应该是原型模式的典型，不仅实现了动态扩展实例，更实现了动态扩展对象，即继承。在高精地图编辑器中，由于需要做自动保存，所以在做序列化和反序列化的同时也简单实现了对象的 clone()，即从当前实例中创建一个完全一样的实例，可认为是 C++ 中的深拷贝。</p>
<h3 id="访问者模式">访问者模式</h3>
<p>　　相当于加个中间层，从而以最小的代价修改现有系统（一般是增加一个方法），达到外部可以取得系统内部信息的目的。</p>
<h2 id="后记">后记</h2>
<p>　　曾看过这样一句话：抽象能力决定编程能力，Shaun 个人认为，所谓抽象即提炼事物的共同点，这也是设计模式中反复使用接口的原因，接口即一组具体类的共同点，接口中的函数和变量即为这些具体类共有的，虽然具体行为可以不一样，但行为本身总是存在的。而又有这样一句话：程序等于数据结构加算法，Shaun 的理解是，狭义上的程序确实是这样，一段代码解决一个问题，这是程序，多段代码解决一个问题，这也是程序，多段代码解决多个问题，这亦是程序，一个软件，一个系统，一个平台，都是程序，但显然这些程序不是简单的数据结构和算法就能概括的，其内部必然有一套合理的逻辑进行组织，这套逻辑可以称之为“设计模式”，但这个“设计模式”不仅仅是上面谈的这些模式概念。Shaun 认为好的数据结构和算法确实能使程序达到当前最优，但对于一个大型系统或平台来说，这种最优只能是一种局部最优，这对整个系统的全局最优来说可能是微不足道的，而“设计模式”要解决的是怎样使一个系统达到全局最优，怎么合理组织局部最优。面对现代的超大型系统或平台，传统意义上的设计模式也只能达到局部最优，全局最优基本很少有人能驾驭，都是针对特定的业务需要，不断的试错改进优化，逐渐趋于稳定，但这种稳定可能很难抽象，放进其它的业务中，又得花费大量的人力物力去修改。</p>
<p>　　Shaun 个人对现代大型系统架构的理解就是分层分模块，功能太多分模块，模块太多就分层，一层不够分两层，两层不够分三层，三层不够继续分，根据数据流的处理分层，根据功能的不同分模块，模块内部依靠设计模式进行组织，设计模式调度的就是数据结构与算法。Shaun 目前的设计原则就是：每层一个独立的服务控制模块，每个模块一个对外服务功能（或事件或 socket ），同层的各模块之间尽量保持独立，不相互依赖，若各模块存在共同点，则将共同点抽出来，将其作为公共模块或独立为小层，层与层之间通过服务控制模块进行数据流的传输，除服务控制模块之外，模块之间尽量避免相互通信，即每个模块的对外服务功能一般只对本层服务控制模块提供服务，最好是只负责接收数据。如果系统实在太大，就只能保持纵向分层，横向保证各模块间数据流依次传输，并在特定模块节点上进行上下层的数据传输。</p>
<p>　　数据结构与算法重不重要？当然重要，数据结构与算法不过关，面试都过不去 ( ╯□╰ )，工作都没有，还何谈什么设计模式，什么架构。设计模式重不重要？当然也重要，不会合理使用设计模式，写出一堆别人没法维护的垃圾代码（当然，这或许是好事 :p ），改个需求要半天，加个功能要半个月，效率太低，这样即使有好的数据结构与算法作用也不大。但是设计模式也不是万能的，针对不同的需求，同一种设计模式有不同的实现方式，所以书中的设计模式也仅供参考而已，与其说设计模式重要，还不如说书中那几个设计原则更重要些。同时一味的追求设计模式也不见得是件好事，设计模式可以参考，但不能生搬硬套，毕竟人是活的，需求也是活的，固定的模式也需要有所改变，总而言之，能以最小的代价解决问题完成需求的模式就是好模式。</p>
]]></content>
      <categories>
        <category>Study</category>
      </categories>
      <tags>
        <tag>thought</tag>
      </tags>
  </entry>
  <entry>
    <title>读大学</title>
    <url>/posts/ae5f9dce.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>知识的积累如同滚雪球一般，越滚越大，越滚越快。</p>
<p>　　人类简史中，人类花了几万年的时间完成采集文明到农耕文明的过度，花了几千年的时间从农耕文明到工业文明，而工业文明短短几百年就过渡到现代信息化文明。而如今的时代，短短几年就会产生一些新的行业，有些能产生巨大的社会价值，而有些则会被人所遗忘，亦或过些年又卷土重来，潮起潮落，社会总是以一种加速递增的趋势在发展。</p>
<span id="more"></span>
<h2 id="志愿篇">志愿篇</h2>
<p>　　大学就是普通人进入社会的一块敲门砖，一块垫脚石，进入社会多年之后，这块敲门砖还有多大的重要性，这就看个人的际遇了，但总的来说，这块敲门砖越厚重，进入社会的机会和选择就越多，相对来说越容易成功。虽说取得一定的成就之后，也就可以不在使用这块敲门砖，但对于普通人来说，这块敲门砖还是挺重要的，毕竟这块敲门砖将会陪伴绝大多数的普通人一辈子。</p>
<p>　　对一般人来说，进入大学唯一的途径就是高考，而高考完之后需要走填志愿……录取等一系列流程才决定是否能进入大学。高考志愿最重要的一个指标即是所在省的排名，全国各个大学在每个省的指标基本是不变的，所以排名直接决定能上什么样的大学，当然，因为各种各样的原因，每年总会有一批人上不了自己该上的大学，甚至落榜，也有一批人上了自己本上不了的大学，但对于一般人，排名是绝对的指标，只看这一个就可以直接在这一档挑选自己能上的大学了，剩下的就是专业了，一个学校的王牌专业一般会远远高出录取线，所以这就需要选择，是去好一档学校的“差”专业，还是去差一档学校的“好”专业（这个差和好并不是绝对的，都是相对该校的王牌专业来说），Shaun 的看法是如果是同一个专业，当然是去好学校的差专业，不同的专业则仁者见仁智者见智，没有可比性。之所以这么选择，是根据 Shaun 这几年在社会上的摸爬滚打，好的学校还是要香一点，而专业这种东西反正都是靠自己学的，大学上课的那些东西一般都只是入门课程，有的甚至连入门都够不上。当然，专业选择这种东西还有个小技巧，就是可以选择类似的专业，当自己想上的专业是好专业，自己的分数够不上，这时可以采用这种技巧，捡漏，因为有些人对专业不是特别了解，只死盯着那个专业，但其实两者上的课程差不多，一般来说，同一个学院的专业会存在类似的情况，而一个大的专业，类似的专业就更多了，像计算机专业，无论是搞硬件的搞软件的搞自动化的都能搞计算机。</p>
<p>　　专业重不重要？对于 90% 以上的人来说，专业还是重要的，确实也有一小部分人也可以完全抛弃大学时的专业，照样也能混的风生水起，这样的人当然是极少的。但对于一般人来说，专业相当于 4 年的积累，为步入社会打下基础，多年后或许会完全抛弃自己的专业，但那也是在社会上有了一定的积累之后，刚开始就抛弃这份积累，从事一份完全无关的工作，对一般人来说何其艰难。</p>
<p>　　至于专业选择重不重要，这就看个人了，在 Shaun 眼中，专业选择同样重要，因为专业基本就确定了职业和所在的行业，而行业是有贵贱之分的，虽说三百六十行行行出状元，但有些行业的状元就是比另外行业的状元强，甚至踏上这个行业就比有些行业的状元还要强，而且就算出状元，也轮不到一般人头上。像老师和医生这样的职业，天然的就比别的职业社会地位要高，在这娱乐至死的时代，像电影游戏直播偶像行业，90% 以上的资源就掌握在 1% 的人手上，极度不平衡，成不了这 1% ，都是炮灰。</p>
<p>　　在特殊情况下，行业这东西又显得不是那么重要，而运气和眼光相对来说更重要些，有句话叫：站在风口上，猪都能飞起来。09 年，智能机开始兴起，12年，随着 3G 的普及，移动互联网时代开始逐步走向高潮，而三年后，4G 的到来，真正将移动互联网推向高潮，这股高潮一直持续到现在，当然，由于这块蛋糕基本被瓜分完了，现在进场也吃不到什么肉了，除非有新点子或市场。这十年间，有多少企业只靠一个 APP 就做大做强的，又有多少企业因为没搭上这趟车而逐渐走向衰落甚至倒闭的。当然，Shaun 是有点反感移动互联网的，但奈何市场喜欢，资本喜欢。移动互联网的本质在于各家的资源掌握在自己手里，绝不分享，这对于互联网的发展并不是一个好的现象，也就直接导致了如今的中文互联网像一滩狗屎。遥想 09 年之前，中文互联网是何等的辉煌，各种想要的资源应有尽有，高质量的内容产出也层出不穷，是真正的我为人人，人人为我。现如今内容资源都掌握在各家平台手上，还无法直接在浏览器上通过网页获取，必须使用各家的 APP，APP 就算是一滩屎，用户也只能跪舔，不过这各种流氓行为，说到底也都是用户自己惯的。现如今，中文互联网高质量的产出不多了，大多都存在于非常专业创立时间长且不太知名人数不多的社区和论坛中。不得不说，中文互联网变成如今这个样子，百度有很大一部分责任，贴吧可以说是一个跨时代的产品，被搞得乌烟瘴气，以前的百度空间确实也有些高质量的内容，直接关闭。</p>
<p>　　扯远了扯远了 (￣ε(#￣)。热门行业从来都不是一层不变的，大学的专业也是如此（Shaun 本科读的那个专业已经换了个名字），甚至大学本身也是如此，分拆合并，过去二三十年时有发生。时代在变化，行业在变化，大学也在变化，唯一不变的是变化本身，为适应变化，学习思维才是个人的立身之本。学习思维这种东西，确实无法明说，只能说是为自己量身定制的一种学习感觉（Shaun 刚入大学时，还停留在小初高的那种学习思维，认为多看书，多做题多想就能学好，这样的思维学习像高数这种基础课程，确实没问题，但像编程这样的专业课，这一套思维则完全走不通，Shaun 觉得编程更重要的是一种手感和思维方式，多抄多<strong>改</strong>，多模仿好代码，手感自然而来，不会的，网上也一般都有直接或近似的解决方案，拿过直接<strong>改改</strong>使用，在改的过程中就锻炼了编程手感和思维方式，这种方式虽然原始粗暴，但却是一种通用的编程学习方法，使用好这种方法，本科的专业课一般也比较轻松，甚至以后在工作中，就算网上没有任何解决方案，也能凭自己的感觉和思考将代码写好，至于代码的组织能力，就又需要另一种学习方法了，总之编程这门手艺，实践才是王道）。Shaun 觉得国内小初高的教育锻炼的是做题和狭小的思考能力，而大学的工科更注重的是动手和广泛的思考能力（当然基础课程还是小初高那一套），这两种学习思维是存在差异的，并且可以说差异很大。大学时期的建立的学习思维将直接影响个人的一生，拿大学的那套学习思维虽然不一定能在社会上混得开，但一定能让人把本职工作做好。</p>
<h2 id="大学篇">大学篇</h2>
<p>　　真正进入大学后，就有很多可以选择的事了，可以天天划水摸鱼，东游西逛，也可以比高三还要辛苦，这都是个人的选择，都看个人的追求，没有纯粹的对错。</p>
<p>　　Shaun 的四年本科一直很平庸，没干过什么大事，也没干过真正的蠢事，只是干过一些糗事（刚进大学的时候以为还要去某个教室集合，但其实只要在寝室等通知就好，军训是可以装病休息的，没人会在意，就大一上学期有过一些，后面摸清大学的套路就没了），也没伸手要过啥 🙃，虽被人有说愤青，但没真正做过网络喷子（在网络事件中，事和人需要分开讨论，事可能是好事，但人不一定是好人，同样，事是坏事，但人可能是好人，况且，网络上，事可能事假的，人可能也是假的，只要有自己的见解和判断，就不会人云亦云）。四年本科，唯一让 Shaun 觉得有价值的东西并不是学校提供的什么环境，也不是老师朋友的教导和帮助，而是这段时间逐渐形成在网络上求知的那种思维，这种思维在 Shaun 的读研和工作生涯中给予了极大的帮助。除真正的科研问题之外，工作中碰到的其他问题总能按部就班的解决，剩下的无非就是熟练度而已。</p>
<p>　　一般人在大学中待得最久的一个地方可能就是宿舍了，所以和室友之间的关系尽量不要搞得太僵，自身最应该做的就是不卑不亢，当然，每个学校总是会存在一部分蠢货的，运气不好，宿舍正好被分到，此时更加不能卑，只要有理就可以随便说放手做。</p>
<h2 id="后记">后记</h2>
<p>　　志愿篇是写给别人的，而大学篇是 Shaun 顺带回忆的，毕竟硕士的回忆篇早写了，大学篇也来凑个数吧，但正如『头脑特工队』中痛苦的记忆更容易被回忆起来，而平淡的记忆将逐渐灰飞烟灭，所以大学篇就只能简单写写了。</p>
]]></content>
      <categories>
        <category>Life</category>
      </categories>
      <tags>
        <tag>record</tag>
      </tags>
  </entry>
  <entry>
    <title>［译］为什么深度学习没有取代传统的计算机视觉</title>
    <url>/posts/3578e309.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　这是一篇<strong>译文</strong>，译自：<a href="http://zbigatron.com/has-deep-learning-superseded-traditional-computer-vision-techniques/?spm=a2c4e.11153940.blogcont543029.21.3ec3c1c3DsQmF2">Why Deep Learning Has Not Superseded Traditional Computer Vision</a>，原作者为：<a href="http://zbigatron.com/author/zbigatron/">Zbigatron</a> 。Shaun 水平有限，仅供参考学习，更多内容还请自行查看原文。</p>
<p>至于为什么要翻译这篇文章，算是回答别人的一个问题吧。</p>
<span id="more"></span>
<h2 id="为什么深度学习还没有取代传统的计算机视觉">为什么深度学习还没有取代传统的计算机视觉？</h2>
<figure>
<img src="http://zbigatron.com/wp-content/uploads/2018/01/scale-done_small.jpg" alt="scale-cv-dl" /><figcaption aria-hidden="true">scale-cv-dl</figcaption>
</figure>
<p>　　编写这篇文章的原因是在论坛中经常有人问：深度学习是否取代了传统的计算机视觉？或者类似的问题：深度学习效果这么好，还有继续研究传统计算机视觉的必要？</p>
<p>　　这是个好问题，深度学习（DL）确实彻底改变了计算机视觉（CV）和人工智能，许多曾经看起来不可能解决的问题都解决了，甚至达到了 <a href="https://www.theguardian.com/global/2015/may/13/baidu-minwa-supercomputer-better-than-humans-recognising-images">机器的结果比人类更好</a> 的程度，比如图像分类。正如 <a href="http://zbigatron.com/the-reasons-behind-the-recent-growth-of-computer-vision/">我之前讨论的</a>，<strong>深度学习确实为计算机视觉做了很大的贡献</strong>。</p>
<p>　　但是深度学习只是计算机视觉的一个工具，并不是解决所有问题的万能药，所以，在这篇文章中，<strong>我想详细说明一下为什么传统的计算机视觉仍然非常有用</strong>，并且应该继续学习。</p>
<p>这篇文章主要有一下几个观点：</p>
<ul>
<li>深度学习需要大量数据；</li>
<li>深度学习有时大材小用了；</li>
<li>传统的计算机视觉可以辅助深度学习。</li>
</ul>
<p>　　但是在我开始讨论这些观点之前，需要先解释一下什么是传统的计算机视觉，什么是深度学习，以及深度学习为何这么 dio。</p>
<h3 id="背景知识">背景知识</h3>
<p>　　在深度学习之前，如果要实现图像分类这样的功能，需要首先进行 <a href="https://en.wikipedia.org/wiki/Feature_extraction">特征提取</a>。特征即为图像中的信息块，能代表图像的部分信息，可以通过 <a href="https://en.wikipedia.org/wiki/Edge_detection">边缘检测</a>，<a href="https://en.wikipedia.org/wiki/Corner_detection">角点检测</a>，<a href="https://en.wikipedia.org/wiki/Object_detection">物体检测</a> 等技术来提取特征。</p>
<p>　　在进行特征提取和图像分类之类的工作时，一个想法是从一类对象（例如椅子，马等）的图像中提取尽可能多的特征，并将这些特征视为对象的一种定义（比如 <a href="https://en.wikipedia.org/wiki/Bag-of-words_model_in_computer_vision">词袋模型</a>），然后在其他图像中查找这些定义，若另一个图像中的特征和定义的特征很相似，则该图像可能包含该特定的对象（如椅子，马等）。</p>
<p>　　在图像分类中，这种特征提取的难点在于<strong>每个图像都必须选择哪些特征进行查找</strong>，当需要分类的类别开始增加时，比如 10 或 20 种类别，这种方式将变得很麻烦以至于不可能实现。当然也可以考虑角点、边缘和纹理信息，使用不同的特征可以更好的描述不同类别的对象，但是如果选择使用很多特征，则必须处理大量参数，所有这些参数都必须微调。</p>
<p>　　深度学习中有一个<strong>端到端学习</strong>的概念，其含义为告诉机器要针对每个特定类别对象<strong>学习</strong>需要查找的特征，它为每个对象设计了最具描述性和显著性的特征，换言之，<strong>告诉神经网络要发现图像中每个类别的基本模式</strong>。</p>
<p>　　因此，通过端到端学习，不需要再决定使用哪种传统的计算机视觉技术来描述特征，机器自动选择好了，<a href="https://www.wired.com/2016/05/the-end-of-code/">Wired magazine</a> 说过：</p>
<blockquote>
<p>如果想教一个神经网络识别一只猫，不需要让它寻找胡须、耳朵、皮毛和眼睛，只需要给它大量猫的图像，它就会自动识别猫，若它将狐狸错认成猫，不需要重写代码，只需要继续训练即可。</p>
</blockquote>
<p>下图表示了特征提取（使用传统计算机视觉）和端到端学习之间的差异：</p>
<figure>
<img src="http://zbigatron.com/wp-content/uploads/2018/03/Screen-Shot-2018-03-16-at-3.06.48-PM.png" alt="traditional-cv-and-dl" /><figcaption aria-hidden="true">traditional-cv-and-dl</figcaption>
</figure>
<p>　　以上就是需要的背景知识，下面开始深入探讨为什么传统的计算机视觉仍然有存在的必要。</p>
<h3 id="深度学习需要大量数据">深度学习需要大量数据</h3>
<p>　　首先，深度学习需要大量的数据，那些著名的图像分类模型就是在海量数据集上训练的，训练数据集中最大的三个是：</p>
<ul>
<li><a href="http://www.image-net.org/">ImageNet</a> – <strong>150 万张图片</strong>，包含有 1000 个对象类别；</li>
<li><a href="http://cocodataset.org/">Microsoft Common Objects in Context</a> (COCO) – <strong>250 万张图片</strong>，91 个对象类别；</li>
<li><a href="http://host.robots.ox.ac.uk/pascal/VOC/">PASCAL VOC Dataset</a> – <strong>50 万张图片</strong>，20 个对象类别。</li>
</ul>
<p>　　一般的图像分类任务不需要这么多图片，但仍然需要很多，如果没办法获得这么多图片怎么办？我们还是得训练我们所有的数据（有些方法可以增多我们的训练数据，但这些都是人工方法）。但是，没有足够的数据支持，训练出来的模型可能会在训练集之外表现不好，因为机器没有洞察能力，无法对没有的数据进行分类。而且无法直观查看训练好的模型并手动调整里面的数据，因为<strong>深度学习模型里面有数百万个参数</strong>，并且这些参数在训练时会自动微调，某种程度上，深度学习模型就是一个黑盒子。</p>
<p>　　传统的计算机视觉完全透明，可以很清楚的判断自己的解决方案在训练数据之外是否可行，而且<strong>可以深入了解算法中存在的问题</strong>。如果有没法解决的问题，也可以更容易的找出原因并调整。</p>
<h3 id="深度学习有时大材小用了">深度学习有时大材小用了</h3>
<p>　　这可能是我支持传统计算机视觉技术研究的最佳理由。</p>
<p>　　训练深度神经网络需要很长时间，而且需要专门的硬件（高性能 GPU），如果想在普通的笔记本上训练最先进的图像分类模型，可以去外面玩一个星期，回来之后应该还没训练完 ：) 。而且，如果训练好的模型表现不好怎么办？必须调整训练参数并重新开始训练，这个过程有时会重复数百次。</p>
<p>　　但有时候使用深度学习是完全没有必要的，因为<strong>有时传统的计算机视觉技术可以比深度学习更有效的解决问题并且代码更少</strong>。比如，我曾经做过一个项目来检测传送带上每个罐头是否都有红色的勺子，解决这个问题可以训练深度神经网络来检测勺子，也可以针对红色编写一个简单的阈值分割算法（红色的某个范围内的像素点为白色，其它像素点为黑色），然后计算有多少个白色像素点，后者明显简单的多，一个小时就完成了。</p>
<p>　　<strong>了解传统的计算机视觉有时会节省大量时间和避免不必要的麻烦</strong>。</p>
<h3 id="传统计算机视觉提高改进深度学习技能">传统计算机视觉提高改进深度学习技能</h3>
<p>　　了解传统的计算机视觉可以帮助我们更好地进行深度学习。</p>
<p>　　例如，计算机视觉中使用的最常见的神经网络是卷积神经网络。但什么是卷积？它实际上是一种广泛使用的图像处理技术（例如 <a href="https://en.wikipedia.org/wiki/Sobel_operator">Sobel边缘检测</a>）。了解这一点可以帮助我们了解神经网络正在做什么，并因此可以更好的设计和调整神经网络来解决问题。</p>
<p>　　深度学习中还可以对图像进行<strong>预处理</strong>，所谓的预处理是指对训练的数据进行一定的处理（Shaun 注：比如图像增强，图像去噪等），这些预处理操作一般由传统的计算机视觉技术完成，比如：当没有足够的训练数据时，可以使用一种叫<strong>数据增强</strong>的技术，使用数据增强让图像进行旋转，平移，裁剪等操作，从而增加“新”图像，通过执行这些操作，可以成倍的增加训练数据集。</p>
<h3 id="总结">总结</h3>
<p>　　在这篇文章中，我解释了为什么深度学习还没有取代传统的计算机视觉技术，因此还需要研究后者。首先我发现了深度学习要想表现的足够好需要大量数据的问题，有时候没法获得大量数据，这时只能用传统计算机视觉技术代替；其次，对于特定的任务，使用深度学习可能大材小用了，传统计算机视觉有时比深度学习更有效且代码量也更少；最后了解传统的计算机视觉可以更好的学习深度学习，因为这可以使我们更好的了解深度学习的内部机制，并且可以使用某些预处理操作来改善深度学习结果。</p>
<p>　　简而言之，深度学习只是计算机视觉的一个工具，不是万能药，不要只是因为它现在很流行所以使用它，传统的计算机视觉技术仍然十分有用，了解它可以节省时间和避免许多麻烦。</p>
<h2 id="后记">后记</h2>
<p>　　翻译这篇文章的原因在于，因为某些原因，Shaun 不得不回答一个 “为什么不用深度学习？” 的问题，虽然这里面有极大的因素是客观原因（设备不够 ╮(╯▽╰)╭），但 Shaun 不能明说，正好在网上看到这篇文章，加上也看到过一个问题（类似于 “既然已经能用深度学习做高层次的工作，为何还要用深度学习做底层的工作？”，比如深度学习能做全景分割（可以说是基本完成了图像理解），为何还要做目标检测，图像分割），预计以后有很大的概率也会被问到，所以就需要借用文中的一些观点来进行回答。至于为啥还要用深度学习做底层的工作，可以这样认为，如果用深度学习做底层工作效果不错的话，应该可以对上层工作进行一些辅助，并且可以为上层工作的做法提供一些新的思路。</p>
]]></content>
      <categories>
        <category>Share</category>
      </categories>
      <tags>
        <tag>cv</tag>
      </tags>
  </entry>
  <entry>
    <title>记一次资源不释放的问题</title>
    <url>/posts/2eb69b33.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　最近发现一个 GoFrame 服务即使空载 CPU 使用率也很高，每次接受请求后资源没有被释放，一直累积，直到达到报警阈值，人工介入重启服务，于是压测排查了一下。</p>
<span id="more"></span>
<h2 id="问题篇">问题篇</h2>
<p>　　先新增代码启动 go 自带的 pprof 服务器：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="GO"><div class="code-copy"></div><figure class="highlight hljs go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	_ <span class="string">&quot;net/http/pprof&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Pprof</span><span class="params">(pprof_port <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(pprof_port <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">		http.ListenAndServe(<span class="string">&quot;0.0.0.0:&quot;</span>+pprof_port, <span class="literal">nil</span>)</span><br><span class="line">	&#125;(pprof_port)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>压测以及 profile 命令：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 压测命令</span></span><br><span class="line">wrk -t8 -c1000 -d60s --latency --timeout 10s -s post_script.lua http://host:[srv_port]/post</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> profile 整体分析</span></span><br><span class="line">go tool pprof -http=:8081 http://host:[pprof_port]/debug/pprof/profile?seconds=30</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看函数堆栈调用</span></span><br><span class="line">curl http://host:[pprof_port]/debug/pprof/trace?seconds=30 &gt; ./pprof/trace01</span><br><span class="line">go tool trace -http=:8081 ./pprof/trace01</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看内存堆栈</span></span><br><span class="line">go tool pprof -http=:8081 http://host:[pprof_port]/debug/pprof/heap?seconds=30</span><br></pre></td></tr></table></figure></div>
<p>　　在压测 30 次后，即使服务空载 CPU 也被打满了，查看服务此时的 profile，发现 goroutine 的数目到了百万级别，查看 cpu 堆栈发现集中调用在 gtimer 上，但遍寻服务代码，没有直接用到 GoFrame 的定时器，问题出在哪也还是没想太明白。吃完饭后偶然灵光一现，既然 CPU 看不出啥，那再看看内存，查看内存发现，内存对象最多的是 glog.Logger，看代码也正好有对应的对象，可算是找到问题真正的元凶了。</p>
<p>　　log 对象一般都是全生命周期的，不主动销毁就会一直伴随着服务运行，所以 log 对象一般都是程序启动时初始化一次，后续调用，都是用这一个对象实例。而这次这个问题就是因为在代码中用 glog 记录了数据库执行日志，每次请求都会重新生成一个 glog 对象，又没有主动释放造成的。</p>
<p>　　知道问题的真正所在，解决问题就相对很简单了，只在程序启动时初始化一个 glog 对象，后续打印日志就用这一个实例，其实更好的方式是生产环境不打印数据库日志，毕竟影响性能。</p>
<h2 id="后记">后记</h2>
<p>　　CPU 资源的占用往往伴随着内存资源的占用，当从调用堆栈以及线程资源上看不出问题的时候，可以转过头来看看内存堆栈，毕竟内存堆栈更能指示有问题的对象出在哪，知道内存对象是谁，也相当于提供了排查问题代码的方向。</p>
<h2 id="附录">附录</h2>
<p>　　在排查过程中发现 goroutine 数目异常的高，于是想限制一下 goroutine 数目，在网上搜索的时候发现当用容器部署 go 服务时，go 默认最大的 goroutine 数目为宿主机 cpu 核数，而不是容器的 cpu 核数，从而并发时 goroutine 数目可能比容器 cpu 核数高很多，造成资源争抢，导致并发性能下降，可以通过设置环境变量 <code>GOMAXPROCS</code> 指定 goroutine 最大数目，也可以使用 <code>go.uber.org/automaxprocs</code> 库自动修正最大核数为容器 cpu 核数。</p>
<p>自适应设置 GOMAXPROCS 上下限代码：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="GO"><div class="code-copy"></div><figure class="highlight hljs go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	_ <span class="string">&quot;go.uber.org/automaxprocs&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;runtime&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	procsNum := runtime.GOMAXPROCS(<span class="number">-1</span>)</span><br><span class="line">	<span class="keyword">if</span> procsNum &lt; <span class="number">4</span> &#123;</span><br><span class="line">		procsNum = <span class="number">4</span></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> procsNum &gt; <span class="number">16</span> &#123;</span><br><span class="line">		procsNum = <span class="number">16</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	runtime.GOMAXPROCS(procsNum)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// todo something...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h3 id="python-内存泄漏排查">python 内存泄漏排查</h3>
<p><strong><em>※注：python 的默认参数是全局变量，若默认参数为一个引用类型（eg：字典对象），且函数中会对该参数进行写操作，就极有可能发生内存泄漏，所以 python 默认参数最好是值类型。</em></strong></p>
<p>方法一是线上程序直接排查，通过 pyrasite 和 guppy 直接对应 python 程序：</p>
<blockquote>
<p>step1：绑定 python 程序 pid，开启 pyrasite shell 窗口，执行 <code>pyrasite-shell &lt;pid&gt;</code>；</p>
<p>step2：使用 guppy 查看 python 程序内存情况，</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PYTHON"><div class="code-copy"></div><figure class="highlight hljs python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> guppy <span class="keyword">import</span> hpy</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>h = hpy()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>h.heap()</span><br></pre></td></tr></table></figure></div>
<p>step3：间隔一定时间后，再次使用 <code>h.heap()</code>，对比两次内存变化</p>
</blockquote>
<p>该方法一般只能粗略查看内存泄露的数据对象，可能无法精确定位到指定位置，这时需要用方法二，手动插入代码查看程序运行日志：</p>
<blockquote>
<p>Python标准库的gc、sys模块提供了检测的能力</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PYTHON"><div class="code-copy"></div><figure class="highlight hljs python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> gc</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">gc.get_objects() <span class="comment"># 返回一个收集器所跟踪的所有对象的列表</span></span><br><span class="line">gc.get_referrers(*objs) <span class="comment"># 返回直接引用任意一个 ojbs 的对象列表</span></span><br><span class="line">sys.getsizeof() <span class="comment"># 返回对象的大小（以字节为单位）。只计算直接分配给对象的内存消耗，不计算它所引用的对象的内存消耗。</span></span><br></pre></td></tr></table></figure></div>
<p>基于这些函数，先把进程中所有的对象引用拿到，得到对象大小，然后从大到小排序，打印出来，代码如下：</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false"data-lang="PYTHON"><div class="code-copy"></div><figure class="highlight hljs python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> gc</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_memory</span>():</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;*&quot;</span> * <span class="number">60</span>)</span><br><span class="line">    objects_list = []</span><br><span class="line">    <span class="keyword">for</span> obj <span class="keyword">in</span> gc.get_objects():</span><br><span class="line">        size = sys.getsizeof(obj)</span><br><span class="line">        objects_list.append((obj, size))</span><br><span class="line">    <span class="keyword">for</span> obj, size <span class="keyword">in</span> <span class="built_in">sorted</span>(objects_list, key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>)[:<span class="number">10</span>]:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;OBJ: <span class="subst">&#123;<span class="built_in">id</span>(obj)&#125;</span>, TYPE: <span class="subst">&#123;<span class="built_in">type</span>(obj)&#125;</span> SIZE: <span class="subst">&#123;size/<span class="number">1024</span>/<span class="number">1024</span>:<span class="number">.2</span>f&#125;</span>MB <span class="subst">&#123;<span class="built_in">str</span>(obj)[:<span class="number">100</span>]&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure></div>
<p>找到内存占用稳定增长的对象，调用 <code>gc.get_referrers(*objs)</code>，查看该对象的引用信息，即可快速定位泄漏位置</p>
</blockquote>
<p>该方法更加灵活精确，不好的地方是有侵入性，需要修改代码后重新上线，同时获取这些信息并打印，对性能有一定的影响，排查完之后，需要将该段代码下线。</p>
<h4 id="参考资料">参考资料</h4>
<p>1、<a href="https://blog.csdn.net/lonevenn/article/details/120075646">python内存泄露问题定位：附带解决pyrasite timed out</a></p>
<p>2、<a href="https://blog.qminghe.com/post/2022/01/17/python-memory-leak-oom-resolve">技术 · 一次Python程序内存泄露故障的排查过程</a></p>
]]></content>
      <categories>
        <category>Problems</category>
      </categories>
      <tags>
        <tag>golang</tag>
      </tags>
  </entry>
  <entry>
    <title>LLM 本地部署运行初体验</title>
    <url>/posts/49bd1c83.html</url>
    <content><![CDATA[<h2 id="前言">前言</h2>
<p>　　最近看到这么一个工具——<strong><a href="https://github.com/dwqs/ollama-ocr">ollama-ocr</a></strong>，利用本地大模型直接进行 OCR，试用了一下，感觉效果还不错，联想之前看到的一个项目——<strong><a href="https://github.com/Byaidu/PDFMathTranslate">PDFMathTranslate</a></strong>，感觉本地大模型已经非常成熟了，部署使用也越来越简单了。</p>
<span id="more"></span>
<h2 id="配置篇">配置篇</h2>
<p>　　硬件：M3 MBP，10 核 GPU（Metal 3），16G 内存</p>
<p>　　系统&amp;软件：<a href="https://ipsw.me/download/Mac15,10/23F79">macOS Sonoma 14.5</a>，<a href="https://ollama.com/download">Ollama</a> 0.5.4，<a href="https://anythingllm.com/desktop">AnythingLLM</a> 1.7.2；</p>
<h2 id="体验篇">体验篇</h2>
<h3 id="ollama-篇">ollama 篇</h3>
<p>　　第一次启动 Ollama 时，会出现安装「command line」的引导界面，输入电脑用户密码安装即可，安装命令行之后，可以直接点击「Finish」，之后通过终端命令 <code>ollama</code> 操作 Ollama，毕竟 Ollama 没有提供 UI 界面，当然也有很多<a href="https://ollama.readthedocs.io/quickstart/#web">三方的界面</a>。</p>
<p>　　之后在终端中直接运行 <code>ollama run llama3.2:3b</code>，等待模型拉取完成后，即可直接与模型对话。之后可以在 <a href="https://ollama.com/search">Ollama 官网 Models</a> 搜索尝试更多模型。</p>
<p>命令解析：</p>
<ul>
<li>ollama pull [model:tag]：拉取模型；</li>
<li>ollama run [model:tag]：运行拉取的模型，若没有，会自动拉取之后运行；</li>
<li>ollama list：查看全部已拉取的模型；</li>
<li>ollama show [model:tag]：显示模型信息；</li>
<li>ollama rm [model:tag]：删除已拉取的模型；</li>
<li>ollama ps：查看正在运行的模型；</li>
<li>ollama stop [model:tag]：停止正在运行的模型；</li>
</ul>
<p>　　Mac 中 ollama 拉取的模型文件默认放在 <code>~/.ollama/models</code> 目录中。</p>
<p>　　Ollama 默认服务地址端口是：<code>127.0.0.1:11434</code>，Mac 中查看进程监听的端口号命令为 <code>lsof -nP -p &lt;pid&gt;</code>。</p>
<p>　　默认情况下，运行模型后，如果 5 分钟未与模型进行交互，将会自动停止该模型。</p>
<p>　　Mac 启动 Ollama 后，会在菜单栏上出现一个羊驼图标，但有时这个图标会被“刘海”挡住，导致无法退出 Ollama，这时可以使用 <code>osascript -e 'tell app "Ollama" to quit'</code> 命令退出 Ollama。</p>
<p>　　对于开发者，若需要更改默认端口，需修改环境变量：<code>export OLLAMA_HOST=0.0.0.0:6006</code>（如此可将 ollama 的默认端口修改为 6006），之后通过 <code>ollama serve</code> 命令启动 Ollama，通过该命令启动的不会在菜单栏上出现羊驼图标。若出现跨域问题，同样需要修改环境变量：<code>export OLLAMA_ORIGINS="*"</code>。</p>
<h3 id="anythingllm-篇">AnythingLLM 篇</h3>
<p>　　AnythingLLM 有两种安装模式，一种是桌面版，一种是 Docker 版，桌面版只能本地使用，Docker 版相当于是服务版，支持多用户云端使用。本次选用的桌面版，基本的 RAG 功能也都有。<a href="https://docs.anythingllm.com/installation-desktop/overview#docker-vs-desktop-version">Docker vs Desktop Version</a></p>
<p>　　第一次启动 AnythingLLM 时，有一些设置引导，设置「LLM 偏好」时选择 Ollama，其他的都默认即可。创建工作空间之后就可以上传本地文件，建立自己的知识库。</p>
<p>　　Shaun 在使用中感觉，AnythingLLM 响应还是比较慢，分析/提炼/归纳/总结本地文档的速度有限。可能是机器配置还是有点低了。</p>
<h2 id="后记">后记</h2>
<p>　　本地部署 LLM 的好处在于无数据泄漏问题，对于个人使用而言，轻量级的模型也差不多够用了，但即使已经轻量化了，本地运行大模型还是有点吃力，在 Shaun 的电脑上运行 <a href="https://ollama.com/library/phi4:14b">phi4:14b</a> 略显勉强（8 tok/s）。Mac 的内存和显存是共享的，后续如果买新的，有部署 LLM 的需求，最好把内存拉满，由于模型文件也相对较大，有条件的可以把 SSD 也拉满。希望后续大模型的推理能够进一步轻量化，效果也更好，真正实现人人都能使用。</p>
<p>　　自 GPT-3 出现以来，也就短短 4 年不到，从大规模的高性能 GPU 集群到单机部署，从胡言乱语到精准命中，各行各业都迎来了 LLM 的冲击，在可预见的未来，LLM 将深刻影响到每一个人，这种影响无关好坏，单纯只是时代的浪潮，就 Shaun 而言，能做的也就是利用现有的机器资源，尽量多享受一下 LLM 带来的便利。</p>
<h2 id="参考资料">参考资料</h2>
<p>1、<a href="https://blog.csdn.net/sheex2012/article/details/138339166">基于Ollama+AnythingLLM搭建本地私有知识库系统</a></p>
<p>2、<a href="http://xiaodongq.github.io/2024/06/20/ollama-ai-models/">ollama搭建本地个人知识库</a></p>
]]></content>
      <categories>
        <category>Study</category>
      </categories>
      <tags>
        <tag>llm</tag>
      </tags>
  </entry>
</search>
