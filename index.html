<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="Shaun之所见所学所想所得"><meta name="keywords" content="algorithm,android,bigdata,c/cpp,clustering,container,css,cv,devtool,ffmpeg,geomesa,geometry,gfw,github,gl,golang,hexo,http,integration,java,k8s,language,latex,mapbox,markdown,matlab,network,note,numerical,opencv,opendrive,opengl,python,qt,record,search,segmentation,tensorflow,thought,unix-like,vscode"><meta property="og:type" content="article"><meta property="og:site_name" content="Shaun&#39;s Space"><title>Shaun&#39;s Space</title><link rel="icon" href="/img/favicon.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha256-eSi1q2PG6J7g7ib17yAaWMcrr5GrtohYChqibrV7PBE=" crossorigin="anonymous"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fork-awesome/1.1.5/css/fork-awesome.min.css" integrity="sha256-P64qV9gULPHiZTdrS1nM59toStkgjM0dsf5mK/UwBV4=" crossorigin="anonymous"><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><script src="//cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha256-ZvOgfh+ptkpoa2Y4HkRY28ir89u/+VRyDE7sB7hEEcI=" crossorigin="anonymous"></script><script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha256-VsEqElsCHSGmnmHXGQzvoWjWwoznFSZc6hs7ARLRacQ=" crossorigin="anonymous"></script><script src="//cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js" integrity="sha256-EPrkNjGEmCWyazb3A/Epj+W7Qm2pB9vnfXw+X6LImPM=" crossorigin="anonymous"></script><script src="//cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/gitalk/1.7.2/gitalk.min.css" integrity="sha512-0hsIlRjJbiUWaKMhXXNDmjWI2qPvUlhNBLHMhqeF5jIma+bedec27N5FoT2JEeHz5TUmOGCsm1Y89EsX/P0wOg==" crossorigin="anonymous" referrerpolicy="no-referrer"><script src="//cdnjs.cloudflare.com/ajax/libs/gitalk/1.7.2/gitalk.min.js" integrity="sha512-EcTCcXV46teiNwe0VcnM5A038tcY+BaQYO4nW6Gh2i7v4/HjBVg7xx3+JBLl9WofDds//INJAiEGAtdgr8PWyA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><link rel="stylesheet" href="/css/style.css"><style>body{cursor:url(/img/cursor/normal.cur),auto}#navbar-toggler--btn,.code-copy,.copy-path,a,button{cursor:url(/img/cursor/link.cur),auto}#site-bg{position:fixed;left:0;top:0;width:100%;height:100%;z-index:-1;background-image:url(/img/site-bg/bg-6.jpg);background-repeat:no-repeat;background-size:100% 100%;opacity:.2;transition:background-image 3s}</style><script>const bdshareURL="/plugins/baidushare/"</script><script async type="text/javascript" src="/js/live2d/autoload.js"></script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Shaun's Space" type="application/atom+xml">
</head><body><!--[if lt IE 9]>
        <link rel="stylesheet" href="/css/ie9.css">
        <div class="alert alert-danger topframe" role="alert">
            嘿，朋友！您的浏览器已<strong>过期</strong>，不建议继续食用。
            <a target="_blank" class="alert-link" href="http://browsehappy.com">这里</a> 有些新玩意儿，何不试试？
        </div>
    <![endif]--><header id="header"><nav id="navbar" class="navbar navbar-expand-md"><div class="container"><h1 id="site-title"><a href="/" class="navbar-brand"><img src="/img/favicon.png"> <span>Shaun&#39;s Space</span></a></h1><button id="navbar-toggler--btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsibleNavbar"><span><i class="fa fa-list-ul" aria-hidden="true"></i></span></button><div class="collapse navbar-collapse" id="collapsibleNavbar"><ul class="navbar-nav"><li class="nav-item"><a class="nav-link" href="/" title="首页" data-toggle="tooltip" data-placement="bottom"><i class="nav-icon fa fa-home"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives" title="所有文章" data-toggle="tooltip" data-placement="bottom"><i class="nav-icon fa fa-archive"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories" title="全部分类" data-toggle="tooltip" data-placement="bottom"><i class="nav-icon fa fa-folder"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags" title="全部标签" data-toggle="tooltip" data-placement="bottom"><i class="nav-icon fa fa-tags"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/about" title="关于本站" data-toggle="tooltip" data-placement="bottom"><i class="nav-icon fa fa-user"></i> 关于</a></li><li class="nav-item"><a class="nav-link" href="/guide" title="Treasure Guide" data-toggle="tooltip" data-placement="bottom"><i class="nav-icon fa fa-university"></i> 导航</a></li></ul></div></div></nav></header><div class="container"><div class="row"><aside id="left-col" class="col-md-1"></aside><main class="col-lg-8 col-sm-12"><div id="site-bg"></div><article id="post-HTTP-超时浅见" class="article div-border"><header class="article-header"><span class="article-date article-title--index"><i class="fa fa-calendar" aria-hidden="true"></i> <a href="/posts/36b343ff.html"><time datetime="2024-05-12T02:26:32.000Z">2024-05-12</time></a></span><section class="article-title article-title--index"><a href="/posts/36b343ff.html">HTTP 超时浅见</a></section><div class="article-label"><div class="article-category label"><i class="fa fa-book" aria-hidden="true"></i> <a class="color4 article-category-link" href="/categories/Problems/">Problems</a></div><div class="article-tag label"><i class="fa fa-bookmark" aria-hidden="true"></i> <a class="color3 article-tag-none-link" href="/tags/golang/" rel="tag">golang</a><a class="color3 article-tag-none-link" href="/tags/http/" rel="tag">http</a></div></div></header><section class="article-content"><div class="article-content--excerpt"><h2 id="前言">前言</h2><p>　　最近业务调用方反馈接收到服务连接中断的错误（python requests 请求抛出异常 <code>raise ConnectionError(err, request=request) \n ConnectionError: ('Connection aborted.', BadStatusLine("''",))</code>），但从 golang 服务日志中看，服务应该是正常处理完成并返回了，且抛出异常的时间也基本和服务返回数据的时间一致，即表明在服务响应返回数据的那一刻，请求方同时抛出异常。</p><p>　　这个问题很奇怪，起初拿到一个 case 还无法稳定复现，最初怀疑是网络抖动问题，但后续一直会偶发性出现，直到拿到了一个能稳定复现的 case，深入跟踪排查后才发现与网络问题无关，是服务端框架应用设置不合理的问题。</p></div><div class="article-content--all"><h2 id="前言">前言</h2><p>　　最近业务调用方反馈接收到服务连接中断的错误（python requests 请求抛出异常 <code>raise ConnectionError(err, request=request) \n ConnectionError: ('Connection aborted.', BadStatusLine("''",))</code>），但从 golang 服务日志中看，服务应该是正常处理完成并返回了，且抛出异常的时间也基本和服务返回数据的时间一致，即表明在服务响应返回数据的那一刻，请求方同时抛出异常。</p><p>　　这个问题很奇怪，起初拿到一个 case 还无法稳定复现，最初怀疑是网络抖动问题，但后续一直会偶发性出现，直到拿到了一个能稳定复现的 case，深入跟踪排查后才发现与网络问题无关，是服务端框架应用设置不合理的问题。</p><span id="more"></span><h2 id="问题篇">问题篇</h2><p>　　从网上搜索 <code>python ConnectionError: ('Connection aborted.')</code>，错误种类非常多，有网络问题，服务端问题（关闭连接，拒绝服务，响应错误等），客户端关闭连接，超时设置不合理，请求参数/协议错误等等，但若带上 <code>BadStatusLine("''",)</code> ，错误就相对比较明确了（<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/47196100/badstatusline-error-in-using-python-requests">BadStatusLine Error in using Python, Requests</a>，<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/33174804/python-requests-getting-connection-aborted-badstatusline-error">Python Requests getting ('Connection aborted.', BadStatusLine("''",)) error</a>），主要是由于收到了一个空响应（header/body），空响应可以明确是服务端返回的问题，一般可能有以下几个原因：1. 服务端反爬；2. 服务端超时（比如 nginx 默认 60s 超时）；3. 网络错误。</p><p>　　由于是内部服务，所以反爬策略是没有的，而反馈的 case 都带有明显的特征（请求数据量大，处理耗时长），没有网络抖动那种随机性，所以应该也不是网络问题，剩下的只能是超时问题，由于业务方在前置策略上已经识别该 case 数据量大，所以不经过 nginx 网关，直连服务请求，所以也不会有 nginx 超时问题，只能是服务端自己超时。于是直接在代码中查找 timeout 关键字，发现在服务启动时设置了 ReadTimeout 和 WriteTimeout，进一步深挖之后，才对 go 服务的超时有了浅显的认识。</p><h2 id="超时篇">超时篇</h2><p>参考资料：1. <a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1836274">你真的了解 timeout 吗？</a>，2. <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzkxNTU5MjE0MQ==&amp;mid=2247492773&amp;idx=1&amp;sn=972e67c2536225e6f01b70c52a08aee6&amp;source=41#wechat_redirect">i/o timeout ， 希望你不要踩到这个net/http包的坑</a>，3. <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/551557249">net/http完全超时手册</a>。</p><p>　　由于 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTTP">HTTP</a> 协议规范并未提及超时标准，而为保证服务稳定性，一般的 HTTP 服务请求都会设置超时时间，各 HTTP 服务端/客户端对于超时的理解大同小异，而这次的问题又起源与 go 服务，所以以 go 为例，分析一下超时。</p><h3 id="客户端超时">客户端超时</h3><figure><img src="https://pic4.zhimg.com/80/v2-a66e1905b916028ef5aa2ee41cc9a673_1440w.webp" alt="http.Client.Timeout"><figcaption aria-hidden="true">http.Client.Timeout</figcaption></figure><p>　　客户端超时，即 GET/POST 请求超时，这个很好理解，就是客户端发送请求到客户端接收到服务器返回数据的时间，算是开发的一般性常识，控制参数一般也特别简单，就是一个 timeout，当然 go 服务客户端支持设置更精细化的超时时间，一般也没啥必要。当客户端感知到超时时，会正常发起 TCP 断开连接的“四次挥手”过程。</p><h3 id="服务端超时">服务端超时</h3><figure><img src="https://pic2.zhimg.com/80/v2-8e520795ca5a552fba7ebffd301f6b95_1440w.png" alt="http.Server Timeouts"><figcaption aria-hidden="true">http.Server Timeouts</figcaption></figure><p>　　服务端超时，这才是引发问题的根本原因，go 服务端的超时，主要有两个参数，ReadTimeout 和 WriteTimeout，从上图可以看出，ReadTimeout 主要是设置服务端接收请求到读取客户端请求数据的时间（读请求的时间），WriteTimeout 是服务端处理请求数据以及返回数据的时间（写响应的时间）。GoFrame 框架的 ReadTimeout 默认值是 60s，在请求数据正常的情况下 ReadTimeout 也不可能超时，这次的问题主要出在 WriteTimeout，GoFrame 的默认值是 0s，代表不控制超时，但之前的开发者也同样设置为了 60s，导致服务端在处理大量数据时，发生了超时现象。</p><p>　　更深挖之后，才发现 WriteTimeout 的诡异之处，当 WriteTimeout 发生之后，服务端不会即时返回超时消息，而是需要等服务端真正处理完之后，返回数据时，才会返回一个空数据，即使服务端正常写入返回数据，但都会强制为空数据返回，导致请求客户端报错。这种表现，看起来就像是 WriteTimeout 不仅没有起到应有的作用，在错误设置的情况下，还会起到反作用，使服务响应错误。WriteTimeout 无法即时生效的问题，也同样有其他人反馈了：1. <a target="_blank" rel="noopener" href="https://adam-p.ca/blog/2022/01/golang-http-server-timeouts/">Diving into Go's HTTP server timeouts</a>；2. <a target="_blank" rel="noopener" href="https://github.com/golang/go/issues/59602">net/http: Request context is not canceled when <code>Server.WriteTimeout</code> is reached</a>。可能是网上反馈的人多了，go 官方推出了一个 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/master/src/net/http/server.go#L3571">TimeoutHandler</a>，通过这个设置服务端超时，即可即时返回超时消息。仿照官方的 TimeoutHandler ，即可在 GoFrame 框架中也实现自己的超时中间件。</p><p>　　至于 WriteTimeout 为啥不起作用，个人猜测主要原因在于 go 服务每接收到一个请求，都是另开一个协程进行处理，而 <a target="_blank" rel="noopener" href="https://geektutu.com/post/hpg-timeout-goroutine.html#3-%E5%BC%BA%E5%88%B6-kill-goroutine-%E5%8F%AF%E8%83%BD%E5%90%97%EF%BC%9F">goroutine 无法被强制 kill，只能自己退出</a>，通常是要等到 goroutine 正常处理完之后才能返回数据，WriteTimeout 只是先强制写一个空数据占位，返回还是得等 goroutine 正常处理完。</p><p>　　所以正常的 go 服务，在使用类似于 TimeoutHandler 中间件的时候，也最好让 goroutine 尽可能快的退出，一种简单的方法是：1. 设置请求的 context 为 context.WithTimeout；2. 分步处理数据，每一步开始前都先检查请求传入的 context 是否已经超时；3. 若已经超时，则直接 return，不进行下一步处理，快速退出 goroutine。</p><h2 id="后记">后记</h2><p>　　这次问题排查，碰到的最大障碍在于，前几次反馈的 case 难以复现，客户端请求报错和服务器返回的时间一致也不会让人往超时的角度去想，在拿到一个能稳定复现的 case 之后，才死马当活马医，先调一下超时参数试试。</p><p>　　关于 go 服务超时的文章，其实之前也看过，但没碰到具体问题，名词也就仅仅只是名词，很难理解背后的含义和其中的坑点，实践才能出真知 ╮(~▽~)╭。</p><h2 id="附录">附录</h2><p>　　关于超时问题，也曾看到过有人碰到一个长链接服务的问题，现象是这样的：后端服务宕机之后，客户端可能需要很久才会感知到，原因在于 tcp 的超时重传机制，在 linux 中，默认会重传 tcp_retries2=15 次（即 16 次才会断开连接），而 TCP 最大超时时间为 TCP_RTO_MAX=2min，最小超时时间为 TCP_RTO_MIN=200ms。即在 linux 中，一个典型的 TCP 超时重传表现为：</p><table><thead><tr class="header"><th>重传次数</th><th>发送时间</th><th>超时时间</th></tr></thead><tbody><tr class="odd"><td>-1（原始数据发送）</td><td>0s</td><td>0.2s</td></tr><tr class="even"><td>0 （第 0 次重传）</td><td>0.2s</td><td>0.2s</td></tr><tr class="odd"><td>1</td><td>0.4s</td><td>0.4s</td></tr><tr class="even"><td>2</td><td>0.8s</td><td>0.8s</td></tr><tr class="odd"><td>3</td><td>1.6s</td><td>1.6s</td></tr><tr class="even"><td>4</td><td>3.2s</td><td>3.2s</td></tr><tr class="odd"><td>5</td><td>6.4s</td><td>6.4s</td></tr><tr class="even"><td>6</td><td>12.8s</td><td>12.8s</td></tr><tr class="odd"><td>7</td><td>25.6s</td><td>25.6s</td></tr><tr class="even"><td>8</td><td>51.2s</td><td>51.2s</td></tr><tr class="odd"><td>9</td><td>102.4s</td><td>102.4s</td></tr><tr class="even"><td>10</td><td>204.8s</td><td>120s</td></tr><tr class="odd"><td>11</td><td>324.8s</td><td>120s</td></tr><tr class="even"><td>12</td><td>444.8s</td><td>120s</td></tr><tr class="odd"><td>13</td><td>564.8s</td><td>120s</td></tr><tr class="even"><td>14</td><td>684.8s</td><td>120s</td></tr><tr class="odd"><td>15</td><td>804.8s</td><td>120s</td></tr><tr class="even"><td>断开连接</td><td>924.8s（≈15min）</td><td></td></tr></tbody></table><p>所以客户端需要在 15 分钟之后才能感知到服务端不可用，如此，仅靠 TCP 自身的超时机制，很难发现服务端是否宕机/不可用，长链接不释放，进而可能导致客户端不可用且无感知，所以在长链接服务中，需要有其他的手段来保障服务稳定/可用性（eg：心跳探活）。</p></div><div class="article-content-more"><button type="button" class="article-more--link"><i class="fa fa-angle-double-down fa-3x" aria-hidden="true"></i></button></div></section></article><article id="post-记一次资源不释放的问题" class="article div-border"><header class="article-header"><span class="article-date article-title--index"><i class="fa fa-calendar" aria-hidden="true"></i> <a href="/posts/2eb69b33.html"><time datetime="2023-05-01T14:16:58.000Z">2023-05-01</time></a></span><section class="article-title article-title--index"><a href="/posts/2eb69b33.html">记一次资源不释放的问题</a></section><div class="article-label"><div class="article-category label"><i class="fa fa-book" aria-hidden="true"></i> <a class="color3 article-category-link" href="/categories/Problems/">Problems</a></div><div class="article-tag label"><i class="fa fa-bookmark" aria-hidden="true"></i> <a class="color5 article-tag-none-link" href="/tags/golang/" rel="tag">golang</a></div></div></header><section class="article-content"><div class="article-content--excerpt"><h2 id="前言">前言</h2><p>　　最近发现一个 GoFrame 服务即使空载 CPU 使用率也很高，每次接受请求后资源没有被释放，一直累积，直到达到报警阈值，人工介入重启服务，于是压测排查了一下。</p></div><div class="article-content--all"><h2 id="前言">前言</h2><p>　　最近发现一个 GoFrame 服务即使空载 CPU 使用率也很高，每次接受请求后资源没有被释放，一直累积，直到达到报警阈值，人工介入重启服务，于是压测排查了一下。</p><span id="more"></span><h2 id="问题篇">问题篇</h2><p>　　先新增代码启动 go 自带的 pprof 服务器：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="GO"><div class="code-copy"></div><figure class="highlight hljs go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	_ <span class="string">&quot;net/http/pprof&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Pprof</span><span class="params">(pprof_port <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(pprof_port <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">		http.ListenAndServe(<span class="string">&quot;0.0.0.0:&quot;</span>+pprof_port, <span class="literal">nil</span>)</span><br><span class="line">	&#125;(pprof_port)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>压测以及 profile 命令：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 压测命令</span></span><br><span class="line">wrk -t8 -c1000 -d60s --latency --timeout 10s -s post_script.lua http://host:[srv_port]/post</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> profile 整体分析</span></span><br><span class="line">go tool pprof -http=:8081 http://host:[pprof_port]/debug/pprof/profile?seconds=30</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看函数堆栈调用</span></span><br><span class="line">curl http://host:[pprof_port]/debug/pprof/trace?seconds=30 &gt; ./pprof/trace01</span><br><span class="line">go tool trace -http=:8081 ./pprof/trace01</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看内存堆栈</span></span><br><span class="line">go tool pprof -http=:8081 http://host:[pprof_port]/debug/pprof/heap?seconds=30</span><br></pre></td></tr></table></figure></div><p>　　在压测 30 次后，即使服务空载 CPU 也被打满了，查看服务此时的 profile，发现 goroutine 的数目到了百万级别，查看 cpu 堆栈发现集中调用在 gtimer 上，但遍寻服务代码，没有直接用到 GoFrame 的定时器，问题出在哪也还是没想太明白。吃完饭后偶然灵光一现，既然 CPU 看不出啥，那再看看内存，查看内存发现，内存对象最多的是 glog.Logger，看代码也正好有对应的对象，可算是找到问题真正的元凶了。</p><p>　　log 对象一般都是全生命周期的，不主动销毁就会一直伴随着服务运行，所以 log 对象一般都是程序启动时初始化一次，后续调用，都是用这一个对象实例。而这次这个问题就是因为在代码中用 glog 记录了数据库执行日志，每次请求都会重新生成一个 glog 对象，又没有主动释放造成的。</p><p>　　知道问题的真正所在，解决问题就相对很简单了，只在程序启动时初始化一个 glog 对象，后续打印日志就用这一个实例，其实更好的方式是生产环境不打印数据库日志，毕竟影响性能。</p><h2 id="后记">后记</h2><p>　　CPU 资源的占用往往伴随着内存资源的占用，当从调用堆栈以及线程资源上看不出问题的时候，可以转过头来看看内存堆栈，毕竟内存堆栈更能指示有问题的对象出在哪，知道内存对象是谁，也相当于提供了排查问题代码的方向。</p><h2 id="附录">附录</h2><p>　　在排查过程中发现 goroutine 数目异常的高，于是想限制一下 goroutine 数目，在网上搜索的时候发现当用容器部署 go 服务时，go 默认最大的 goroutine 数目为宿主机 cpu 核数，而不是容器的 cpu 核数，从而并发时 goroutine 数目可能比容器 cpu 核数高很多，造成资源争抢，导致并发性能下降，可以通过设置环境变量 <code>GOMAXPROCS</code> 指定 goroutine 最大数目，也可以使用 <code>go.uber.org/automaxprocs</code> 库自动修正最大核数为容器 cpu 核数。</p><p>自适应设置 GOMAXPROCS 上下限代码：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="GO"><div class="code-copy"></div><figure class="highlight hljs go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	_ <span class="string">&quot;go.uber.org/automaxprocs&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;runtime&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	procsNum := runtime.GOMAXPROCS(<span class="number">-1</span>)</span><br><span class="line">	<span class="keyword">if</span> procsNum &lt; <span class="number">4</span> &#123;</span><br><span class="line">		procsNum = <span class="number">4</span></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> procsNum &gt; <span class="number">16</span> &#123;</span><br><span class="line">		procsNum = <span class="number">16</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	runtime.GOMAXPROCS(procsNum)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// todo something...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h3 id="python-内存泄漏排查">python 内存泄漏排查</h3><p>方法一是线上程序直接排查，通过 pyrasite 和 guppy 直接对应 python 程序：</p><blockquote><p>step1：绑定 python 程序 pid，开启 pyrasite shell 窗口，执行 <code>pyrasite-shell &lt;pid&gt;</code>；</p><p>step2：使用 guppy 查看 python 程序内存情况，</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="PYTHON"><div class="code-copy"></div><figure class="highlight hljs python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> guppy <span class="keyword">import</span> hpy</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>h = hpy()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>h.heap()</span><br></pre></td></tr></table></figure></div><p>step3：间隔一定时间后，再次使用 <code>h.heap()</code>，对比两次内存变化</p></blockquote><p>该方法一般只能粗略查看内存泄露的数据对象，可能无法精确定位到指定位置，这时需要用方法二，手动插入代码查看程序运行日志：</p><blockquote><p>Python标准库的gc、sys模块提供了检测的能力</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="PYTHON"><div class="code-copy"></div><figure class="highlight hljs python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gc</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">gc.get_objects() <span class="comment"># 返回一个收集器所跟踪的所有对象的列表</span></span><br><span class="line">gc.get_referrers(*objs) <span class="comment"># 返回直接引用任意一个 ojbs 的对象列表</span></span><br><span class="line">sys.getsizeof() <span class="comment"># 返回对象的大小（以字节为单位）。只计算直接分配给对象的内存消耗，不计算它所引用的对象的内存消耗。</span></span><br></pre></td></tr></table></figure></div><p>基于这些函数，先把进程中所有的对象引用拿到，得到对象大小，然后从大到小排序，打印出来，代码如下：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="PYTHON"><div class="code-copy"></div><figure class="highlight hljs python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gc</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_memory</span>():</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;*&quot;</span> * <span class="number">60</span>)</span><br><span class="line">    objects_list = []</span><br><span class="line">    <span class="keyword">for</span> obj <span class="keyword">in</span> gc.get_objects():</span><br><span class="line">        size = sys.getsizeof(obj)</span><br><span class="line">        objects_list.append((obj, size))</span><br><span class="line">    <span class="keyword">for</span> obj, size <span class="keyword">in</span> <span class="built_in">sorted</span>(objects_list, key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>)[:<span class="number">10</span>]:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;OBJ: <span class="subst">&#123;<span class="built_in">id</span>(obj)&#125;</span>, TYPE: <span class="subst">&#123;<span class="built_in">type</span>(obj)&#125;</span> SIZE: <span class="subst">&#123;size/<span class="number">1024</span>/<span class="number">1024</span>:<span class="number">.2</span>f&#125;</span>MB <span class="subst">&#123;<span class="built_in">str</span>(obj)[:<span class="number">100</span>]&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure></div><p>找到内存占用稳定增长的对象，调用 <code>gc.get_referrers(*objs)</code>，查看该对象的引用信息，即可快速定位泄漏位置</p></blockquote><p>该方法更加灵活精确，不好的地方是有侵入性，需要修改代码后重新上线，同时获取这些信息并打印，对性能有一定的影响，排查完之后，需要将该段代码下线。</p><h4 id="参考资料">参考资料</h4><p>1、<a target="_blank" rel="noopener" href="https://blog.csdn.net/lonevenn/article/details/120075646">python内存泄露问题定位：附带解决pyrasite timed out</a></p><p>2、<a target="_blank" rel="noopener" href="https://blog.qminghe.com/post/2022/01/17/python-memory-leak-oom-resolve">技术 · 一次Python程序内存泄露故障的排查过程</a></p></div><div class="article-content-more"><button type="button" class="article-more--link"><i class="fa fa-angle-double-down fa-3x" aria-hidden="true"></i></button></div></section></article><article id="post-M1-个人配置" class="article div-border"><header class="article-header"><span class="article-date article-title--index"><i class="fa fa-calendar" aria-hidden="true"></i> <a href="/posts/4b1f50ff.html"><time datetime="2022-02-06T02:21:28.000Z">2022-02-06</time></a></span><section class="article-title article-title--index"><a href="/posts/4b1f50ff.html">M1 个人配置</a></section><div class="article-label"><div class="article-category label"><i class="fa fa-book" aria-hidden="true"></i> <a class="color3 article-category-link" href="/categories/Share/">Share</a></div><div class="article-tag label"><i class="fa fa-bookmark" aria-hidden="true"></i> <a class="color4 article-tag-none-link" href="/tags/record/" rel="tag">record</a></div></div></header><section class="article-content"><div class="article-content--excerpt"><h2 id="前言">前言</h2><p>　　记录一下 Shaun 个人的 Mac 装机配置。</p></div><div class="article-content--all"><h2 id="前言">前言</h2><p>　　记录一下 Shaun 个人的 Mac 装机配置。</p><span id="more"></span><h2 id="必备">必备</h2><p><strong><a target="_blank" rel="noopener" href="https://github.com/davidwernhart/AlDente-Charge-Limiter">AlDente</a></strong>：Mac 电池健康保护神器，默认 80% 就行，想充满就设置为 100%，需要<em>禁掉自带的优化电池充电</em>。</p><p><strong><a target="_blank" rel="noopener" href="https://github.com/objective-see/LuLu">LuLu</a></strong>：防火墙，控制应用联网权限。</p><hr><h2 id="iterm2">iTerm2</h2><p>　　下载安装 <a target="_blank" rel="noopener" href="https://iterm2.com/">iTerm2</a>，默认 shell 就是 zsh，所以不需要安装。</p><p>　　安装 <a target="_blank" rel="noopener" href="https://github.com/ohmyzsh/ohmyzsh#basic-installation">Oh My Zsh</a>，github 上的命令在国内可能无法顺利执行，先 clone 下来，手动执行 <code>sh tools/install.sh</code>。</p><p>　　安装 <a target="_blank" rel="noopener" href="https://github.com/romkatv/powerlevel10k/#oh-my-zsh">Powerlevel10k</a> 之前，先安装 <a target="_blank" rel="noopener" href="https://www.nerdfonts.com/font-downloads">nerd font 字体</a>，Shaun 个人还是比价喜欢 Fira Code 字体，所以就选择下载 Fira Code Nerd Font 字体，只需要安装 <code>Fira Code Retina Nerd Font Complete.ttf</code> 即可。设置 iTerm2 字体为 FiraCode Nerd Font。</p><p>　　随后开始安装 Powerlevel10k，安装完之后重启 iTerm2，会有 Powerlevel10k 的配置提问，依次回答（有推荐按推荐）完成即可配置好 Powerlevel10k，若后续想修改配置，可直接编辑 <code>~/.p10k.zsh</code> 文件或使用 <code>p10k configure</code> 命令重新回答配置提问。最后在 zsh 的配置文件 <code>~/.zshrc</code> 中设置 <code>ZSH_THEME=powerlevel10k/powerlevel10k</code>。</p><p>　　推荐安装 zsh 插件 <a target="_blank" rel="noopener" href="https://github.com/zsh-users/zsh-syntax-highlighting">zsh-syntax-highlighting</a> 和 <a target="_blank" rel="noopener" href="https://github.com/zsh-users/zsh-autosuggestions">zsh-autosuggestions</a>，在执行完</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/zsh-users/zsh-syntax-highlighting.git $&#123;ZSH_CUSTOM:-~/.oh-my-zsh/custom&#125;/plugins/zsh-syntax-highlighting</span><br><span class="line"></span><br><span class="line">git clone https://github.com/zsh-users/zsh-autosuggestions $&#123;ZSH_CUSTOM:-~/.oh-my-zsh/custom&#125;/plugins/zsh-autosuggestions</span><br></pre></td></tr></table></figure></div><p>后修改 ~/.zshrc 的 plugins 值，</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">plugins=( </span><br><span class="line">    git</span><br><span class="line">    zsh-syntax-highlighting</span><br><span class="line">    zsh-autosuggestions</span><br><span class="line">    # other plugins...</span><br><span class="line">)</span><br></pre></td></tr></table></figure></div><h2 id="vscode">VSCode</h2><p>　　VSCode 同样需要设置终端字体为 <code>FiraCode Nerd Font</code>，在终端中进入 Downloads 目录执行 <code>mv Visual\ Studio\ Code.app /Applications</code> 命令，将 VSCode 放进 应用程序 中，再执行 <code>sudo ln -s "/Applications/Visual Studio Code.app/Contents/Resources/app/bin/code" /usr/local/bin/code</code>，之后可在终端使用命令（<code>code .</code>）直接打开 VSCode。若无法自动更新，需执行：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo chown -R $USER ~/Library/Caches/com.microsoft.VSCode.ShipIt</span><br><span class="line">xattr -dr com.apple.quarantine /Applications/Visual\ Studio\ Code.app</span><br></pre></td></tr></table></figure></div><h2 id="homebrew">Homebrew</h2><p>　　直接执行：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/bin/bash -c &quot;$(curl -fsSL https://cdn.jsdelivr.net/gh/ineo6/homebrew-install/install.sh)&quot;</span><br><span class="line"></span><br><span class="line">echo &#x27;eval &quot;$(/opt/homebrew/bin/brew shellenv)&quot;&#x27; &gt;&gt; ~/.zprofile</span><br><span class="line">eval &quot;$(/opt/homebrew/bin/brew shellenv)&quot;</span><br></pre></td></tr></table></figure></div><p>安装完成后先检查目录 <code>/opt/homebrew/Library/Taps/homebrew/homebrew-cask</code> 是否存在，若不存在，则执行：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/homebrew/Library/Taps/homebrew/</span><br><span class="line">git clone https://mirrors.ustc.edu.cn/homebrew-cask.git</span><br></pre></td></tr></table></figure></div><p>　　最后设置中科大源：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git -C &quot;$(brew --repo)&quot; remote set-url origin https://mirrors.ustc.edu.cn/brew.git</span><br><span class="line">git -C &quot;$(brew --repo homebrew/core)&quot; remote set-url origin https://mirrors.ustc.edu.cn/homebrew-core.git</span><br><span class="line">git -C &quot;$(brew --repo homebrew/cask)&quot; remote set-url origin https://mirrors.ustc.edu.cn/homebrew-cask.git</span><br><span class="line">brew update</span><br><span class="line"></span><br><span class="line">echo &#x27;export HOMEBREW_BOTTLE_DOMAIN=https://mirrors.ustc.edu.cn/homebrew-bottles/bottles&#x27; &gt;&gt; ~/.zprofile</span><br><span class="line">source ~/.zprofile</span><br></pre></td></tr></table></figure></div><h2 id="aria2">Aria2</h2><p>　　直接使用命令 <code>brew install aria2</code> 安装，生成配置文件：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd ~</span><br><span class="line">mkdir .aria2</span><br><span class="line">cd .aria2</span><br><span class="line">touch aria2.conf</span><br></pre></td></tr></table></figure></div><p>　　打开 Finder，通过 Shift+Cmd+G 进入路径：~/.aria2/，编辑文件 <code>aria2.conf</code>，添加以下内容：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="PLAINTEXT"><div class="code-copy"></div><figure class="highlight hljs plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">#用户名</span><br><span class="line">#rpc-user=user</span><br><span class="line">#密码</span><br><span class="line">#rpc-passwd=passwd</span><br><span class="line">#上面的认证方式不建议使用,建议使用下面的token方式</span><br><span class="line">#设置加密的密钥</span><br><span class="line">#rpc-secret=token</span><br><span class="line">#允许rpc</span><br><span class="line">enable-rpc=true</span><br><span class="line">#允许所有来源, web界面跨域权限需要</span><br><span class="line">rpc-allow-origin-all=true</span><br><span class="line">#允许外部访问，false的话只监听本地端口</span><br><span class="line">rpc-listen-all=true</span><br><span class="line">#RPC端口, 仅当默认端口被占用时修改</span><br><span class="line">#rpc-listen-port=6800</span><br><span class="line">#最大同时下载数(任务数), 路由建议值: 3</span><br><span class="line">max-concurrent-downloads=5</span><br><span class="line">#断点续传</span><br><span class="line">continue=true</span><br><span class="line">#同服务器连接数</span><br><span class="line">max-connection-per-server=5</span><br><span class="line">#最小文件分片大小, 下载线程数上限取决于能分出多少片, 对于小文件重要</span><br><span class="line">min-split-size=10M</span><br><span class="line">#单文件最大线程数, 路由建议值: 5</span><br><span class="line">split=10</span><br><span class="line">#下载速度限制</span><br><span class="line">max-overall-download-limit=0</span><br><span class="line">#单文件速度限制</span><br><span class="line">max-download-limit=0</span><br><span class="line">#上传速度限制</span><br><span class="line">max-overall-upload-limit=0</span><br><span class="line">#单文件速度限制</span><br><span class="line">max-upload-limit=0</span><br><span class="line">#断开速度过慢的连接</span><br><span class="line">#lowest-speed-limit=0</span><br><span class="line">#验证用，需要1.16.1之后的release版本</span><br><span class="line">#referer=*</span><br><span class="line">#文件保存路径, 默认为当前启动位置</span><br><span class="line">dir=/Users/yuanxu/Downloads</span><br><span class="line">#文件缓存, 使用内置的文件缓存, 如果你不相信Linux内核文件缓存和磁盘内置缓存时使用, 需要1.16及以上版本</span><br><span class="line">#disk-cache=0</span><br><span class="line">#另一种Linux文件缓存方式, 使用前确保您使用的内核支持此选项, 需要1.15及以上版本(?)</span><br><span class="line">#enable-mmap=true</span><br><span class="line">#文件预分配, 能有效降低文件碎片, 提高磁盘性能. 缺点是预分配时间较长</span><br><span class="line">#所需时间 none &lt; falloc ? trunc &lt;&lt; prealloc, falloc和trunc需要文件系统和内核支持</span><br><span class="line">file-allocation=prealloc</span><br><span class="line">bt-tracker=udp://tracker.opentrackr.org:1337/announce,udp://open.tracker.cl:1337/announce,udp://9.rarbg.com:2810/announce,udp://tracker.openbittorrent.com:6969/announce,udp://exodus.desync.com:6969/announce,udp://www.torrent.eu.org:451/announce,udp://vibe.sleepyinternetfun.xyz:1738/announce,udp://tracker1.bt.moack.co.kr:80/announce,udp://tracker.zerobytes.xyz:1337/announce,udp://tracker.torrent.eu.org:451/announce,udp://tracker.theoks.net:6969/announce,udp://tracker.srv00.com:6969/announce,udp://tracker.pomf.se:80/announce,udp://tracker.ololosh.space:6969/announce,udp://tracker.monitorit4.me:6969/announce,udp://tracker.moeking.me:6969/announce,udp://tracker.lelux.fi:6969/announce,udp://tracker.leech.ie:1337/announce,udp://tracker.jordan.im:6969/announce,udp://tracker.blacksparrowmedia.net:6969/announce</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><p>最后的 bt-tracker 可以从 <a target="_blank" rel="noopener" href="https://github.com/ngosang/trackerslist">trackerslist</a> 获取，只用最好的 20 个即可（trackers_best (20 trackers) =&gt; <a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/ngosang/trackerslist/master/trackers_best.txt">link</a> / <a target="_blank" rel="noopener" href="https://ngosang.github.io/trackerslist/trackers_best.txt">mirror</a> / <a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/ngosang/trackerslist@master/trackers_best.txt">mirror 2</a>）。</p><p>　　接着启动 aria2：<code>aria2c --conf-path="/Users/xxx/.aria2/aria2.conf" -D</code> （xxx 为电脑用户名），在 ~/.zshrc 中加入</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">alias start-aria2=&#x27;aria2c --conf-path=&quot;/Users/xxx/.aria2/aria2.conf&quot; -D&#x27;</span><br><span class="line">start-aria2</span><br></pre></td></tr></table></figure></div><p>将 start-aria2c 作为启动 aria2 的命令别名，顺便开机自启。</p><p>　　最后从 <a target="_blank" rel="noopener" href="http://aria2.baisheng999.com/">Aria2中文网</a> 安装 Chrome 插件，打开 aria2 的 WebUI 界面。</p><h2 id="expect">expect</h2><p>　　经常需要使用 ssh 远程登陆堡垒机再到远程服务器，输密码选机器都很麻烦，可以用 expect 写些脚本，自动填充密码和机器，一键直接进到远程服务器。首先安装 expect：<code>brew install expect</code>。在 /usr/local/bin 目录中新建脚本：<code>sudo vi mysl.sh</code>，填充相应内容：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/expect -f</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> USER [用户名]</span><br><span class="line"><span class="built_in">set</span> PWD [密码]</span><br><span class="line"><span class="built_in">set</span> TERMSERVIP [堡垒机服务器ip]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 全部的远程服务器（[remote_server_name] 需要修改为对应的服务器名</span></span><br><span class="line"><span class="built_in">set</span> RS1 [remote_server_name]</span><br><span class="line"><span class="built_in">set</span> RS2 [remote_server_name]</span><br><span class="line"></span><br><span class="line"><span class="comment"># help 命令，查看所有需要登录的远程服务器</span></span><br><span class="line"><span class="keyword">if</span> &#123;[lindex <span class="variable">$argv</span> 0] == <span class="string">&quot;help&quot;</span>&#125; &#123;</span><br><span class="line">    puts <span class="string">&quot;1: <span class="variable">$RS1</span> [说明]&quot;</span></span><br><span class="line">    puts <span class="string">&quot;2: <span class="variable">$RS2</span> [说明]&quot;</span></span><br><span class="line">    send <span class="string">&quot;exit\r&quot;</span></span><br><span class="line">    <span class="built_in">exit</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#  ===== 脚本正文 =====</span></span><br><span class="line"><span class="comment"># 默认登陆远程服务器1</span></span><br><span class="line"><span class="built_in">set</span> RS <span class="variable">$RS1</span></span><br><span class="line"><span class="built_in">set</span> timeout 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输入命令 1，则登陆第一台服务器</span></span><br><span class="line"><span class="keyword">if</span> &#123;[lindex <span class="variable">$argv</span> 0] == <span class="string">&quot;1&quot;</span>&#125; &#123;</span><br><span class="line">    <span class="built_in">set</span> RS <span class="variable">$RS1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> &#123;[lindex <span class="variable">$argv</span> 0] == <span class="string">&quot;2&quot;</span>&#125; &#123;</span><br><span class="line">    <span class="built_in">set</span> RS <span class="variable">$RS2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">spawn ssh <span class="variable">$&#123;USER&#125;</span>@<span class="variable">$&#123;TERMSERVIP&#125;</span> -p 22</span><br><span class="line">expect &#123;</span><br><span class="line">    <span class="string">&quot;yes/no&quot;</span> &#123; send <span class="string">&quot;yes\r&quot;</span>; exp_continue; &#125;</span><br><span class="line">    <span class="string">&quot;*assword*&quot;</span> &#123; send <span class="string">&quot;<span class="variable">$PWD</span>\n&quot;</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 选择几号跳板机</span></span><br><span class="line">expect <span class="string">&quot;*num*&quot;</span> &#123; send <span class="string">&quot;0\n&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登陆远程服务器</span></span><br><span class="line">expect <span class="string">&quot;<span class="variable">$&#123;USER&#125;</span>@&quot;</span> &#123; send <span class="string">&quot;ssh <span class="variable">$RS</span>\n&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 退出 expect（保持在远程服务器终端</span></span><br><span class="line">interact</span><br><span class="line"></span><br><span class="line"><span class="comment"># 退出 expect（回到本地终端</span></span><br><span class="line"><span class="comment"># expect eof  </span></span><br></pre></td></tr></table></figure></div><p>为新建的脚本增加可执行权限：<code>sudo chmod 777 mysl.sh</code>，之后可直接使用 <code>mysl.sh 1</code> 登录到对应的远程服务器。</p><h2 id="lrzsz">lrzsz</h2><p>　　与 FTP 和 NFS 相比，使用 lrzsz 与远程 linux 服务器做文件上传和下载是最简单的，在 iTerm2 中使用 <code>rz</code> 和 <code>sz</code> 命令进行上传和下载文件需要一定的配置。<strong><em>※注</em></strong>： <em>使用 expect 自动登录的远程环境可能无法使用 sz rz 命令</em>。</p><p>　　首先安装 lrzsz：<code>brew install lrzsz</code>。再跳转目录：<code>cd /usr/local/bin</code>，新建文件：<code>sudo vi iterm2-recv-zmodem.sh</code>，添加内容：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Author: Matt Mastracci (matthew@mastracci.com)</span></span><br><span class="line"><span class="comment"># AppleScript from http://stackoverflow.com/questions/4309087/cancel-button-on-osascript-in-a-bash-script</span></span><br><span class="line"><span class="comment"># licensed under cc-wiki with attribution required </span></span><br><span class="line"><span class="comment"># Remainder of script public domain</span></span><br><span class="line"></span><br><span class="line">osascript -e <span class="string">&#x27;tell application &quot;iTerm2&quot; to version&#x27;</span> &gt; /dev/null 2&gt;&amp;1 &amp;&amp; NAME=iTerm2 || NAME=iTerm</span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$NAME</span> = <span class="string">&quot;iTerm&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    FILE=`osascript -e <span class="string">&#x27;tell application &quot;iTerm&quot; to activate&#x27;</span> -e <span class="string">&#x27;tell application &quot;iTerm&quot; to set thefile to choose folder with prompt &quot;Choose a folder to place received files in&quot;&#x27;</span> -e <span class="string">&quot;do shell script (\&quot;echo \&quot;&amp;(quoted form of POSIX path of thefile as Unicode text)&amp;\&quot;\&quot;)&quot;</span>`</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    FILE=`osascript -e <span class="string">&#x27;tell application &quot;iTerm2&quot; to activate&#x27;</span> -e <span class="string">&#x27;tell application &quot;iTerm2&quot; to set thefile to choose folder with prompt &quot;Choose a folder to place received files in&quot;&#x27;</span> -e <span class="string">&quot;do shell script (\&quot;echo \&quot;&amp;(quoted form of POSIX path of thefile as Unicode text)&amp;\&quot;\&quot;)&quot;</span>`</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$FILE</span> = <span class="string">&quot;&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> Cancelled.</span><br><span class="line">    <span class="comment"># Send ZModem cancel</span></span><br><span class="line">    <span class="built_in">echo</span> -e \\x18\\x18\\x18\\x18\\x18</span><br><span class="line">    sleep 1</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    <span class="built_in">echo</span> \<span class="comment"># Cancelled transfer</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">cd</span> <span class="string">&quot;<span class="variable">$FILE</span>&quot;</span></span><br><span class="line">    /usr/<span class="built_in">local</span>/bin/rz -E -e -b</span><br><span class="line">    sleep 1</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    <span class="built_in">echo</span> \<span class="comment"># Sent \-\&gt; $FILE</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></div><p>再新建文件：<code>sudo vi iterm2-send-zmodem.sh</code>，添加内容：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Author: Matt Mastracci (matthew@mastracci.com)</span></span><br><span class="line"><span class="comment"># AppleScript from http://stackoverflow.com/questions/4309087/cancel-button-on-osascript-in-a-bash-script</span></span><br><span class="line"><span class="comment"># licensed under cc-wiki with attribution required </span></span><br><span class="line"><span class="comment"># Remainder of script public domain</span></span><br><span class="line"></span><br><span class="line">osascript -e <span class="string">&#x27;tell application &quot;iTerm2&quot; to version&#x27;</span> &gt; /dev/null 2&gt;&amp;1 &amp;&amp; NAME=iTerm2 || NAME=iTerm</span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$NAME</span> = <span class="string">&quot;iTerm&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    FILE=`osascript -e <span class="string">&#x27;tell application &quot;iTerm&quot; to activate&#x27;</span> -e <span class="string">&#x27;tell application &quot;iTerm&quot; to set thefile to choose file with prompt &quot;Choose a file to send&quot;&#x27;</span> -e <span class="string">&quot;do shell script (\&quot;echo \&quot;&amp;(quoted form of POSIX path of thefile as Unicode text)&amp;\&quot;\&quot;)&quot;</span>`</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    FILE=`osascript -e <span class="string">&#x27;tell application &quot;iTerm2&quot; to activate&#x27;</span> -e <span class="string">&#x27;tell application &quot;iTerm2&quot; to set thefile to choose file with prompt &quot;Choose a file to send&quot;&#x27;</span> -e <span class="string">&quot;do shell script (\&quot;echo \&quot;&amp;(quoted form of POSIX path of thefile as Unicode text)&amp;\&quot;\&quot;)&quot;</span>`</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$FILE</span> = <span class="string">&quot;&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> Cancelled.</span><br><span class="line">    <span class="comment"># Send ZModem cancel</span></span><br><span class="line">    <span class="built_in">echo</span> -e \\x18\\x18\\x18\\x18\\x18</span><br><span class="line">    sleep 1</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    <span class="built_in">echo</span> \<span class="comment"># Cancelled transfer</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    /usr/<span class="built_in">local</span>/bin/sz <span class="string">&quot;<span class="variable">$FILE</span>&quot;</span> -e -b</span><br><span class="line">    sleep 1</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    <span class="built_in">echo</span> \<span class="comment"># Received $FILE</span></span><br><span class="line"><span class="keyword">fi</span> </span><br></pre></td></tr></table></figure></div><p>　　为新建的两文件添加可执行权限：<code>sudo chmod 777 iterm2-*</code>。之后添加 rz sz 命令的软连接：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SHELL"><div class="code-copy"></div><figure class="highlight hljs shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo ln -s /opt/homebrew/bin/rz /usr/local/bin/rz</span><br><span class="line">sudo ln -s /opt/homebrew/bin/sz /usr/local/bin/sz</span><br></pre></td></tr></table></figure></div><p>　　最后配置 iTerm2，选择 Preference... -&gt; Profiles -&gt; Default -&gt; Advanced -&gt; Edit （in Triggers），添加下载触发器：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. Regular expression 中填写</span></span><br><span class="line">rz waiting to receive.\*\*B0100</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Action 选择</span></span><br><span class="line">Run Silent Coprocess...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. Parameters 中填写</span></span><br><span class="line">/usr/<span class="built_in">local</span>/bin/iterm2-send-zmodem.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. Instant 不勾选</span></span><br><span class="line"><span class="comment"># 5. Enabled 勾选</span></span><br></pre></td></tr></table></figure></div><p>再添加上传触发器：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SH"><div class="code-copy"></div><figure class="highlight hljs sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. Regular expression 中填写</span></span><br><span class="line">\*\*B00000000000000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Action 选择</span></span><br><span class="line">Run Silent Coprocess...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. Parameters 中填写</span></span><br><span class="line">/usr/<span class="built_in">local</span>/bin/iterm2-recv-zmodem.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. Instant 不勾选</span></span><br><span class="line"><span class="comment"># 5. Enabled 勾选</span></span><br></pre></td></tr></table></figure></div><p>　　至此 M1 中 iTerm2 rz sz 命令配置完成。</p><h2 id="参考资料">参考资料</h2><p><a target="_blank" rel="noopener" href="https://suixinblog.cn/2019/09/beautify-terminal.html">iTerm2 + zsh + Oh My Zsh + Powerlevel10k 打造 Mac 下最强终端</a></p><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/341831809">M1芯片Mac上Homebrew安装教程</a></p><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/6f344a1fd2e8">Mac M1 iTerm2 配置rz sz 上传下载文件</a></p></div><div class="article-content-more"><button type="button" class="article-more--link"><i class="fa fa-angle-double-down fa-3x" aria-hidden="true"></i></button></div></section></article><article id="post-Scala-多线程编程小结" class="article div-border"><header class="article-header"><span class="article-date article-title--index"><i class="fa fa-calendar" aria-hidden="true"></i> <a href="/posts/9c9b4035.html"><time datetime="2021-10-10T01:56:42.000Z">2021-10-10</time></a></span><section class="article-title article-title--index"><a href="/posts/9c9b4035.html">Scala 多线程编程小结</a></section><div class="article-label"><div class="article-category label"><i class="fa fa-book" aria-hidden="true"></i> <a class="color3 article-category-link" href="/categories/Study/">Study</a></div><div class="article-tag label"><i class="fa fa-bookmark" aria-hidden="true"></i> <a class="color3 article-tag-none-link" href="/tags/language/" rel="tag">language</a></div></div></header><section class="article-content"><div class="article-content--excerpt"><h2 id="前言">前言</h2><p>　　多线程的执行方式有两种：并发（Concurrent）和并行（Parallel），简单来说，并发就是两个线程轮流在一个 CPU 核上执行，而并行则是两个线程分别在两个 CPU 核上运行。一般而言，程序员无法直接控制线程是并发执行还是并行执行，线程的执行一般由操作系统直接控制，当然程序运行时也可以做简单调度。所以对于一般程序员来说，只需要熟练使用相关语言的多线程编程库即可，至于是并发执行还是并行执行，可能并不是那么重要，只要能达到预期效果就行。</p></div><div class="article-content--all"><h2 id="前言">前言</h2><p>　　多线程的执行方式有两种：并发（Concurrent）和并行（Parallel），简单来说，并发就是两个线程轮流在一个 CPU 核上执行，而并行则是两个线程分别在两个 CPU 核上运行。一般而言，程序员无法直接控制线程是并发执行还是并行执行，线程的执行一般由操作系统直接控制，当然程序运行时也可以做简单调度。所以对于一般程序员来说，只需要熟练使用相关语言的多线程编程库即可，至于是并发执行还是并行执行，可能并不是那么重要，只要能达到预期效果就行。</p><span id="more"></span><p>　　Shaun 目前接触的 Scala 原生多线程编程语法就两个：Future 和 Parallel Collections。其中 Future 用的的最多，并且 Parallel Collections 语法非常简单，所以主要介绍 Future，附带提一下 Parallel Collections。</p><h2 id="executioncontext-篇">ExecutionContext 篇</h2><p>　　ExecutionContext 是 Future 的执行上下文，相当于是 Java 的线程池，Java 的线程池主要有以下两类：</p><ul><li>ThreadPool：所有线程共用一个任务队列，当线程空闲时，从队列中取一个任务执行。</li><li>ForkJoinPool：每个线程各有一个任务队列，当线程空闲时，从其他线程的任务队列中取一批任务放进自己的队列中执行。</li></ul><p>　　对于少量任务，这两个池子没啥区别，只是 ThreadPool 在某些情况下会死锁，比如在一个并行度为 2 （最多两个线程）的 ThreadPool 中执行两个线程，两个线程又分别提交一个子任务，并等到子任务执行完才退出，这时会触发相互等待的死锁条件，因为没有多余的空闲线程来执行子任务，而 ForkJoinPool 中每个线程产生的子任务会放在自己的任务队列中，ForkJoinPool 可以在线程耗尽时额外创建线程，也可以挂起当前任务，执行子任务，从而防止死锁。对于大量任务，ForkJoinPool 中的空闲线程会从其他线程的任务队列中一批一批的取任务执行，所以一般会更快，当然若各个任务执行时间比较均衡，则 ThreadPool 会更快。</p><p>　　根据线程池创建的参数不同，Executors 中提供了 5 种线程池：newSingleThreadExecutor（单线程线程池，可保证任务执行顺序），newFixedThreadPool（固定大小线程池，限制并行度），newCachedThreadPool（无限大小线程池，任务执行时间小采用），newScheduledThreadPool（同样无限大小，用来处理延时或定时任务），newWorkStealingPool（ForkJoinPool 线程池）。前四种都属于 ThreadPool，根据阿里的 Java 的编程规范，不推荐直接使用 Executors 创建线程池，不过对于计算密集型任务，一般使用 newFixedThreadPool 或 newWorkStealingPool 即可，线程数设置当前 CPU 数即可（Runtime.getRuntime.availableProcessors()），多了反而增加线程上下文切换次数，对CPU 的利用率不增反减。</p><p>　　Scala 提供了一个默认的 ExecutionContext：<code>scala.concurrent.ExecutionContext.Implicits.global</code>，其本质也是一个 ForkJoinPool，并行度默认设置为当前可用 CPU 数，当然也会根据需要（比如当前全部线程被阻塞）额外创建更多线程。一般做计算密集型任务就用默认线程池即可，特殊情况也可以自己创建 <code>ExecutionContext.fromExecutor(Executors.newFixedThreadPool(8))</code>，下面的代码就可以创建一个同步阻塞的 ExecutionContext：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> currentThreadExecutionContext = <span class="type">ExecutionContext</span>.fromExecutor(</span><br><span class="line">  <span class="keyword">new</span> <span class="type">Executor</span> &#123;</span><br><span class="line">    <span class="comment">// Do not do this!</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">execute</span></span>(runnable: <span class="type">Runnable</span>) &#123; runnable.run() &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></div><p>原因是 <code>runnable.run()</code> 并不会新开一个线程，而是直接在主线程上执行，和调用普通函数一样。</p><h2 id="future-篇">Future 篇</h2><p>　　先上一个简单的 Future 并发编程 Demo：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////import scala.concurrent.ExecutionContext.Implicits.global</span></span><br><span class="line"><span class="comment">//val pool = Executors.newFixedThreadPool(Runtime.getRuntime.availableProcessors())</span></span><br><span class="line"><span class="keyword">val</span> pool = <span class="type">Executors</span>.newWorkStealingPool()</span><br><span class="line"><span class="keyword">implicit</span> <span class="keyword">val</span> ec = <span class="type">ExecutionContext</span>.fromExecutorService(pool)</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> futures = <span class="type">Array</span>.range(<span class="number">0</span>, <span class="number">10000</span>).map(i =&gt; <span class="type">Future</span> &#123;</span><br><span class="line">  println(i)</span><br><span class="line">  <span class="type">Thread</span>.sleep(<span class="number">100</span>)</span><br><span class="line">  i</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> futureSequence = <span class="type">Future</span>.sequence(futures)</span><br><span class="line">futureSequence.onComplete(&#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="type">Success</span>(results) =&gt; &#123;</span><br><span class="line">    println(results.mkString(<span class="string">&quot;Array(&quot;</span>, <span class="string">&quot;, &quot;</span>, <span class="string">&quot;)&quot;</span>))</span><br><span class="line">    println(<span class="string">s&quot;Success&quot;</span>)</span><br><span class="line"></span><br><span class="line">    ec.shutdown()</span><br><span class="line">    pool.shutdownNow()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">case</span> <span class="type">Failure</span>(e) =&gt; println(<span class="string">s&quot;Error processing future operations, error = <span class="subst">$&#123;e.getMessage&#125;</span>&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="type">Await</span>.result(futureSequence, <span class="type">Duration</span>.<span class="type">Inf</span>)</span><br></pre></td></tr></table></figure></div><p>　　如果计算机 CPU 核数为 8 核，则程序运行成功后将会从 VisualVM 中看到有 8 个线程数在运行，控制台中会每次打印 8 条记录，最后打印出完整数组。</p><p>　　onComplete 是 Future 的回调函数，可对 Success 和 Failure 分别处理，Await 是为了阻塞主线程，当 futureSequence 执行完成后，才继续执行下面的任务。当然，主线程的阻塞也可以使用 Java 中的 CountDownLatch 来实现，只需要在每个 Future 执行完成后调用一次 countDown() 即可，或者直接在 onComplete 的回调函数中调用一次也行。（<em>题外话：CountDownLatch 和 Golang 中的 sync.WaitGroup 感觉区别不大</em>）。</p><p>　　如果不想让程序并发执行，则将 <code>Future.sequence(futures)</code> 改为 <code>Future.traverse(futures)(x =&gt; x)</code> 即可，此时就会一条条打印，但不保证打印顺序与数组一致。</p><p>　　如果使用 <code>ExecutionContext.Implicits.global</code>，并将上面创建 futures 的代码改为：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> futures = <span class="type">Array</span>.range(<span class="number">0</span>, <span class="number">10000</span>).map(i =&gt; <span class="type">Future</span> &#123;</span><br><span class="line">  blocking &#123;</span><br><span class="line">    println(i)</span><br><span class="line">    <span class="type">Thread</span>.sleep(<span class="number">100</span>)</span><br><span class="line">    i</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></div><p>　　则控制台会马上将数组全部打印出来，从 VisualVM 中看会有非常多的线程在运行，远远超过 8 个，这是因为 ForkJoinPool 检测到当前线程以全部阻塞，所以需要另开线程继续执行，如果将线程池改为 <code>Executors.newFixedThreadPool(8)</code>，则不会马上将数组全部打印，而是恢复原样，每次打印 8 条。<code>blocking</code> 需要慎用，如果 ForkJoinPool 中线程数太多，同样会 OOM，一般在大量运行时间短内存小的并发任务中使用。</p><hr><p>　　Parallel Collections 并发编程就很简单了，demo 如下：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Array</span>.range(<span class="number">0</span>, <span class="number">10000</span>).par.foreach(i =&gt; &#123;</span><br><span class="line">  println(i)</span><br><span class="line">  <span class="type">Thread</span>.sleep(<span class="number">100</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></div><p>　　关键字为 <code>par</code>，调用该方法即可轻松进行并发计算，不过需要注意的是并发操作的副作用（side-effects）和“乱序”（out of order）语义，副作用就是去写函数外的变量，不仅仅只读写并发操作函数内部声明的变量，乱序语义是指并发操作不会严格按照数组顺序执行，所以如果并发操作会同时操作两个数组元素（eg：reduce），则需要慎重使用，有的操作结果不变，而有的操作会导致结果不唯一。</p><h2 id="经验篇">经验篇</h2><p>　　Shaun 目前使用 Scala 进行多线程编程主要碰到过以下几个问题：</p><ul><li>数据竞争问题</li><li>任务拆分问题</li><li>内存占用问题</li></ul><p>　　数据竞争问题算是多线程编程中最常见的问题，简单来说就是两个线程同时写同一个变量，导致变量值不确定，引发后续问题，解决该问题有很多方法，性能由高到底有：Atomic，volatile，线程安全数据结构（eg：ConcurrentHashMap），Lock，synchronized，前两个方法性能最高，但局限性也很大，如果有现成的线程安全对象使用是最好的，没有的只能用 Lock 和 synchronized，这两种各有优缺点，synchronized 用法简单，能应付绝大部分问题，但对读也会加锁并且无法中断等待线程，Lock 是个接口，有比较多的派生对象（ReentrantLock，ReadWriteLock，ReentrantReadWriteLock 等），能更灵活的控制锁，不过使用起来相对复杂，需要显式地加锁解锁。</p><p>　　任务拆分问题，这个问题发生在任务量非常多（千万级以上）的时候，当需要对千万级数据进行并发处理时，单纯的生成相应的千万级 Future 在默认的 ExecutionContext 中执行会比较慢，甚至出现程序运行一段时间卡一段时间的现象（可能是内存不足，GC 卡了），此时需要人为对千万级任务进行合并。Shaun 这里有两种方案：一种是使用 grouped 将千万级任务划分为 16 组，从而降级为 16 个任务，生成 16 个Future，这时执行速度会快很多，且不会有卡的现象出现；另一种方案就是，每次只生成 10 万个 Future 放进 ExecutionContext 中执行，如此将千万级任务拆分成每次 10 万并发执行，同样能解决问题。</p><p>　　内存占用问题，这个问题发生在单个任务需要占用大量内存（1G 以上）的时候，当单个任务需要 1G 以上内存，8 个任务并行则需要 8G 以上内存，内存占用过高，提高 JVM 的内存，但也只是治标不治本。Shaun 的解决方案是对单个任务进行进一步拆分，将单个任务继续拆分为 16 个子任务，再将 16 个子任务的结果进行合并，作为单个大任务的结果，8 个大任务串行执行，如此内存占用极大减少，只需要单个任务的内存即可完成全部任务，且 CPU 利用率不变，执行速度甚至会更快（Full GC 次数变少）。</p><hr><p>　　Shaun 在写大文件的时候会用到 newSingleThreadExecutor 和 Future.traverse，将写文件的操作放在 Future 里面，每次只写一个大文件（不用多线程写是因为机械硬盘的顺序读写肯定比随机读写快），而生产大文件内容的操作由默认的 ExecutionContext 执行，从而使生产与消费互不干扰，写大文件操作不会阻塞生产操作。</p><p>　　一个用 Future 实现的生产者消费者 demo：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><div class="code-copy"></div><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> poolProducer = <span class="type">Executors</span>.newWorkStealingPool()</span><br><span class="line"><span class="keyword">implicit</span> <span class="keyword">val</span> ecProducer = <span class="type">ExecutionContext</span>.fromExecutorService(poolProducer)</span><br><span class="line"><span class="keyword">val</span> poolConsumer = <span class="type">Executors</span>.newSingleThreadExecutor()</span><br><span class="line"><span class="keyword">val</span> ecConsumer = <span class="type">ExecutionContext</span>.fromExecutorService(poolConsumer)</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> futures = <span class="type">Array</span>.range(<span class="number">0</span>, <span class="number">1000</span>).map(i =&gt; <span class="type">Future</span> &#123;</span><br><span class="line">  <span class="keyword">val</span> x = produce(i) <span class="comment">// produce something...</span></span><br><span class="line">  x</span><br><span class="line">&#125;(ecProducer).andThen &#123; <span class="keyword">case</span> <span class="type">Success</span>(x) =&gt;</span><br><span class="line">  consume(x) <span class="comment">// consume something...</span></span><br><span class="line">&#125;(ecConsumer))</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> futureSequence = <span class="type">Future</span>.sequence(futures)</span><br><span class="line">futureSequence.onComplete(&#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="type">Success</span>(results) =&gt; &#123;</span><br><span class="line">    println(<span class="string">&quot;Success.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    ecProducer.shutdown()</span><br><span class="line">    poolProducer.shutdownNow()</span><br><span class="line">    ecConsumer.shutdown()</span><br><span class="line">    poolConsumer.shutdownNow()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">case</span> <span class="type">Failure</span>(e) =&gt; println(<span class="string">s&quot;Error processing future operations, error = <span class="subst">$&#123;e.getMessage&#125;</span>&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="type">Await</span>.result(futureSequence, <span class="type">Duration</span>.<span class="type">Inf</span>)</span><br></pre></td></tr></table></figure></div><h2 id="后记">后记</h2><p>　　Shaun 这里写的 Scala 多线程编程主要是针对计算密集型任务，而 IO 密集型任务一般会用专门的一些框架，计算密集型考虑的是如何最大化利用 CPU，加快任务执行速度，线程数一般比较固定。Scala 的 Future 多线程编程相比 Java 的多线程编程要简洁了很多，唯一需要控制的就是并行度和任务拆分，Shaun 自己在用时也对 Future 做了简单封装，进一步简化了 Scala 的多线程编程，对 Iterable 的并发计算会更方便。</p><h2 id="参考资料">参考资料</h2><p>[1] <a target="_blank" rel="noopener" href="https://docs.scala-lang.org/overviews/core/futures.html">Futures and Promises</a></p><p>[2] <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/29068064/scala-concurrent-blocking-what-does-it-actually-do">scala.concurrent.blocking - what does it actually do?</a></p><p>[3] <a target="_blank" rel="noopener" href="https://docs.scala-lang.org/overviews/parallel-collections/overview.html">Parallel Collections</a></p><p>[4] <a target="_blank" rel="noopener" href="https://www.cnblogs.com/dolphin0520/p/3923167.html">Java并发编程：Lock</a></p></div><div class="article-content-more"><button type="button" class="article-more--link"><i class="fa fa-angle-double-down fa-3x" aria-hidden="true"></i></button></div></section></article><article id="post-Google-S2-Geometry-浅解" class="article div-border"><header class="article-header"><span class="article-date article-title--index"><i class="fa fa-calendar" aria-hidden="true"></i> <a href="/posts/720275bd.html"><time datetime="2021-09-19T08:21:58.000Z">2021-09-19</time></a></span><section class="article-title article-title--index"><a href="/posts/720275bd.html">Google S2 Geometry 浅解</a></section><div class="article-label"><div class="article-category label"><i class="fa fa-book" aria-hidden="true"></i> <a class="color2 article-category-link" href="/categories/Mathematics/">Mathematics</a></div><div class="article-tag label"><i class="fa fa-bookmark" aria-hidden="true"></i> <a class="color5 article-tag-none-link" href="/tags/geometry/" rel="tag">geometry</a></div></div></header><section class="article-content"><div class="article-content--excerpt"><h2 id="前言">前言</h2><p>　　Google S2 Geometry（以下简称 S2） 是 Google 发明的基于单位球的一种地图投影和空间索引算法，该算法可快速进行覆盖以及邻域计算。更多详见 <a target="_blank" rel="noopener" href="https://s2geometry.io/">S2Geometry</a>，<a target="_blank" rel="noopener" href="https://blog.christianperone.com/2015/08/googles-s2-geometry-on-the-sphere-cells-and-hilbert-curve/">Google’s S2, geometry on the sphere, cells and Hilbert curve</a>，<a target="_blank" rel="noopener" href="https://halfrost.com/go_s2_regioncoverer/">halfrost 的空间索引系列文章</a>。虽然使用 S2 已有一年的时间，但确实没有比较系统的看过其源码，这次借着这段空闲时间，将 Shaun 常用的功能系统的看看其具体实现，下文将结合 S2 的 C++，Java，Go 的版本一起看，由于 Java 和 Go 的都算是 C++ 的衍生版，所以以 C++ 为主，捎带写写这三种语言实现上的一些区别，Java 版本时隔 10 年更新了 2.0 版本，喜大普奔。</p></div><div class="article-content--all"><h2 id="前言">前言</h2><p>　　Google S2 Geometry（以下简称 S2） 是 Google 发明的基于单位球的一种地图投影和空间索引算法，该算法可快速进行覆盖以及邻域计算。更多详见 <a target="_blank" rel="noopener" href="https://s2geometry.io/">S2Geometry</a>，<a target="_blank" rel="noopener" href="https://blog.christianperone.com/2015/08/googles-s2-geometry-on-the-sphere-cells-and-hilbert-curve/">Google’s S2, geometry on the sphere, cells and Hilbert curve</a>，<a target="_blank" rel="noopener" href="https://halfrost.com/go_s2_regioncoverer/">halfrost 的空间索引系列文章</a>。虽然使用 S2 已有一年的时间，但确实没有比较系统的看过其源码，这次借着这段空闲时间，将 Shaun 常用的功能系统的看看其具体实现，下文将结合 S2 的 C++，Java，Go 的版本一起看，由于 Java 和 Go 的都算是 C++ 的衍生版，所以以 C++ 为主，捎带写写这三种语言实现上的一些区别，Java 版本时隔 10 年更新了 2.0 版本，喜大普奔。</p><span id="more"></span><h2 id="坐标篇">坐标篇</h2><figure><img src="https://s2geometry.io/devguide/img/s2cell_global.jpg" alt="s2 projection"><figcaption aria-hidden="true">s2 projection</figcaption></figure><p>　　S2 的投影方式可简单想象为一个单位球外接一个立方体，从球心发出一条射线得到球面上的点到立方体上 6 个面的投影，即将球面投影为立方体，当然中间为了使面积分布更为均匀，还做了些其他坐标变换。</p><h3 id="s2latlng-坐标">S2LatLng 坐标</h3><p>　　首先是经纬度坐标，默认用弧度（Radians）构造，取值范围为经度 [-π，+π]，纬度 [-π/2，+π/2]，当然也可使用 S1Angle 将角度（Degrees）转成弧度来构造。</p><h3 id="s2point-坐标">S2Point 坐标</h3><p>　　然后球面笛卡尔坐标，这是个三维坐标，由 S2LatLng 到 S2Point 相当于将单位球的极坐标表示法转换为笛卡尔坐标表示法，具体公式为 <span class="math inline">\(x=\cos(lat)cos(lng);　y=cos(lat)sin(lng);　z=sin(lat)\)</span>。</p><h3 id="faceuv-坐标">FaceUV 坐标</h3><p>　　这个坐标并没实际的类与其对应，face 指的是立方体的面，值域为 [0,5]，而 uv 坐标是指面上的点，值域为 [-1,1]。首先需要知道 S2Point 会投影到哪个面上，可以知道 S2 的笛卡尔坐标 X 轴正向指向 0 面，Y 轴正向指向 1 面，Z 轴正向指向 2 面，X 轴负向指向 3 面，Y 轴负向指向 4 面，Z 轴负向指向 5 面，所以 S2Point xyz 哪个分量的绝对值最大，就会投影到哪个轴指向的面，若该分量为正值，则取正向指的面，若该分量为负值，则取负向指的面。至于 uv 的计算方式就是直线与平面的交点了，之前的一篇「计算几何基础」中写过，但这里的平面和直线都比较特殊，所以有快速算法，就直接贴 Go 的代码吧：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="GO"><div class="code-copy"></div><figure class="highlight hljs go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// validFaceXYZToUV given a valid face for the given point r (meaning that</span></span><br><span class="line"><span class="comment">// dot product of r with the face normal is positive), returns</span></span><br><span class="line"><span class="comment">// the corresponding u and v values, which may lie outside the range [-1,1].</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">validFaceXYZToUV</span><span class="params">(face <span class="keyword">int</span>, r r3.Vector)</span> <span class="params">(<span class="keyword">float64</span>, <span class="keyword">float64</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">switch</span> face &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">		<span class="keyword">return</span> r.Y / r.X, r.Z / r.X</span><br><span class="line">	<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">		<span class="keyword">return</span> -r.X / r.Y, r.Z / r.Y</span><br><span class="line">	<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">		<span class="keyword">return</span> -r.X / r.Z, -r.Y / r.Z</span><br><span class="line">	<span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">		<span class="keyword">return</span> r.Z / r.X, r.Y / r.X</span><br><span class="line">	<span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">		<span class="keyword">return</span> r.Z / r.Y, -r.X / r.Y</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> -r.Y / r.Z, -r.X / r.Z</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>　　这里需要注意的是 S2Point xyz 三分量构成的向量与平面法向量的点积必须是正数时 uv 才算正确有效，Go 在计算时没做校验，C++ 和 Java 都有校验，使用时需要注意。</p><h3 id="facest-坐标">FaceST 坐标</h3><p>　　之所以引入 ST 坐标是因为同样的球面面积映射到 UV 坐标面积大小不一，大小差距比较大（离坐标轴越近越小，越远越大），所以再做一次 ST 变换，将面积大的变小，小的变大，使面积更均匀，利于后面在立方体面上取均匀格网（cell）时，每个 cell 对应球面面积差距不大。S2 的 ST 变换有三种：1、线性变换，基本没做任何变形，只是简单将 ST 坐标的值域变换为 [0, 1]，cell 对应面积最大与最小比大约为 5.2；2、二次变换，一种非线性变换，能起到使 ST 空间面积更均匀的作用，cell 对应面积最大与最小比大约为 2.1；3、正切变换，同样能使 ST 空间面积更均匀，且 cell 对应面积最大与最小比大约为 1.4，不过其计算速度相较于二次变换要慢 3 倍，所以 S2 权衡考虑，最终采用了二次变换作为默认的 UV 到 ST 之间的变换。二次变换公式为：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="JAVA"><div class="code-copy"></div><figure class="highlight hljs java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">stToUV</span><span class="params">(<span class="keyword">double</span> s)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (s &gt;= <span class="number">0.5</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="number">1</span> / <span class="number">3.</span>) * (<span class="number">4</span> * s * s - <span class="number">1</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="number">1</span> / <span class="number">3.</span>) * (<span class="number">1</span> - <span class="number">4</span> * (<span class="number">1</span> - s) * (<span class="number">1</span> - s));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">uvToST</span><span class="params">(<span class="keyword">double</span> u)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (u &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0.5</span> * Math.sqrt(<span class="number">1</span> + <span class="number">3</span> * u);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> - <span class="number">0.5</span> * Math.sqrt(<span class="number">1</span> - <span class="number">3</span> * u);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h3 id="faceij-坐标">FaceIJ 坐标</h3><p>　　IJ 坐标是离散化后的 ST 坐标，将 ST 空间的平面划分为 <span class="math inline">\(2^{30}×2^{30}\)</span> 个网格，取网格所在的横纵坐标得到 IJ 坐标，所以由 ST 到 IJ 坐标的变换就比较简单了：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="JAVA"><div class="code-copy"></div><figure class="highlight hljs java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">stToIj</span><span class="params">(<span class="keyword">double</span> s)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> Math.max(</span><br><span class="line">    <span class="number">0</span>, Math.min(<span class="number">1073741824</span> - <span class="number">1</span>, (<span class="keyword">int</span>) Math.round(<span class="number">1073741824</span> * s - <span class="number">0.5</span>))</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h3 id="s2cellid">S2CellId</h3><p>　　这个 id 其实是个一维坐标，而是利用希尔伯特空间填充曲线将 IJ 坐标从二维变换为一维，该 id 用一个 64 位整型表示，高 3 位用来表示 face（0~5），后面 61 位来保存不同的 level（0~30） 对应的希尔伯特曲线位置，每增加一个 level 增加两位，后面紧跟一个 1，最后的位数都补 0。<em>注：Java 版本的 id 是有符号 64 位整型，而 C++ 和 Go 的是无符号 64 位整型，所以在跨语言传递 id 的时候，在南极洲所属的最后一个面（即 face = 5）需要小心处理。</em></p><h4 id="hilbertcurve">HilbertCurve</h4><figure><img src="https://upload.wikimedia.org/wikipedia/commons/a/a7/Hilbert_curve_production_rules%21.svg" alt="hilbert_curve_subdivision_rules"><figcaption aria-hidden="true">hilbert_curve_subdivision_rules</figcaption></figure><figure><img src="https://upload.wikimedia.org/wikipedia/commons/3/35/Hilbert_curve_3_Orient%21.svg" alt="hilbert_curve"><figcaption aria-hidden="true">hilbert_curve</figcaption></figure><p>　　上面两张图很明了的展示了希尔伯特曲线的构造过程，该曲线的构造基本元素由 ABCD 4 种“U”形构成，而 BCD 又可由 A 依次逆时针旋转 90 度得到，所以也可以认为只有一种“U”形，每个 U 占 4 个格子，以特定方式进行 1 分 4 得到下一阶曲线形状。</p><p>每个 U 坐标与希尔伯特位置（用二进制表示）对应关系如下：</p><ul><li>A：<code>00 -&gt; (0,0); 01 -&gt; (0,1); 10 -&gt; (1,1); 11 -&gt; (1,0);</code></li><li>B：<code>00 -&gt; (1,1); 01 -&gt; (0,1); 10 -&gt; (0,0); 11 -&gt; (1,0);</code></li><li>C：<code>00 -&gt; (1,1); 01 -&gt; (1,0); 10 -&gt; (0,0); 11 -&gt; (0,1);</code></li><li>D：<code>00 -&gt; (0,0); 01 -&gt; (1,0); 10 -&gt; (1,1); 11 -&gt; (0,1);</code></li></ul><p>每个 U 一分四对应关系如下：</p><ul><li>A：<code>D -&gt; A -&gt; A -&gt; B</code></li><li>B：<code>C -&gt; B -&gt; B -&gt; A</code></li><li>C：<code>B -&gt; C -&gt; C -&gt; D</code></li><li>D：<code>A -&gt; D -&gt; D -&gt; C</code></li></ul><p>　　根据以上两个对应关系就能找到右手坐标系任意阶数的希尔伯特位置及坐标对应关系。以初始 1 阶曲线 A 为例，占据四个格子，然后进行一分四操作，四个格子分成 16 个格子，A 分为 DAAB 四个“U”形，连接起来即为 2 阶曲线，位置与坐标对应关系为（都用二进制表示）：</p><p><code>0000 -&gt; (00, 00); 0001 -&gt; (01, 00); 0010 -&gt; (01, 01); 0011 -&gt; (00, 01)</code>；</p><p><code>0100 -&gt; (00, 10); 0101 -&gt; (00, 11); 0110 -&gt; (01, 11); 0111 -&gt; (01, 10)</code>；</p><p><code>1000 -&gt; (10, 10); 1001 -&gt; (10, 11); 1010 -&gt; (11, 11); 1011 -&gt; (11, 10)</code>；</p><p><code>1100 -&gt; (11, 01); 1101 -&gt; (10, 01); 1110 -&gt; (10, 00); 1111 -&gt; (11, 00)</code>；</p><p>　　从二进制中很容易看出随着阶数的增加，位置与坐标的对应关系：每增加一阶，位置往后增加两位，坐标分量各增加一位，位置增加的两位根据一分四对应关系拼接，坐标各分量增加的一位需先找到一分四对应关系，再找对应位置与坐标对应关系，将得到的坐标分量对应拼接。以一阶的 <code>01 -&gt; (0,1)</code> 到二阶的 <code>0110 -&gt; (01, 11)</code> 为例，首先根据 01 得到当前所属一阶第二块，查找一分四对应关系知道，下一阶这块还是 A，根据 0110 后两位 10 可知这块属于 A 的第三个位置，查找坐标得到是 <code>(1,1)</code>，结合一阶的 <code>(0,1)</code>，对应分量拼接得到坐标 <code>(01,11)</code>，即 <code>(1, 3)</code>，同理可根据第二阶的坐标反查第二阶的位置。有了这些关系，就能生成希尔伯特曲线了，下面就看看 S2 是怎么生成 id 的。</p><h4 id="s2id">S2Id</h4><p>　　首先 S2 中用了两个二维数组分别保存位置到坐标以及坐标到位置的对应的关系：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kIJtoPos[orientation][ij] -&gt; pos</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> kIJtoPos[<span class="number">4</span>][<span class="number">4</span>] = &#123;</span><br><span class="line">  <span class="comment">// (0,0) (0,1) (1,0) (1,1)</span></span><br><span class="line">  &#123;     <span class="number">0</span>,    <span class="number">1</span>,    <span class="number">3</span>,    <span class="number">2</span>  &#125;,  <span class="comment">// canonical order</span></span><br><span class="line">  &#123;     <span class="number">0</span>,    <span class="number">3</span>,    <span class="number">1</span>,    <span class="number">2</span>  &#125;,  <span class="comment">// axes swapped</span></span><br><span class="line">  &#123;     <span class="number">2</span>,    <span class="number">3</span>,    <span class="number">1</span>,    <span class="number">0</span>  &#125;,  <span class="comment">// bits inverted</span></span><br><span class="line">  &#123;     <span class="number">2</span>,    <span class="number">1</span>,    <span class="number">3</span>,    <span class="number">0</span>  &#125;,  <span class="comment">// swapped &amp; inverted</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// kPosToIJ[orientation][pos] -&gt; ij</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> kPosToIJ[<span class="number">4</span>][<span class="number">4</span>] = &#123;</span><br><span class="line">  <span class="comment">// 0  1  2  3</span></span><br><span class="line">  &#123;  <span class="number">0</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">2</span> &#125;,    <span class="comment">// canonical order:    (0,0), (0,1), (1,1), (1,0)</span></span><br><span class="line">  &#123;  <span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span> &#125;,    <span class="comment">// axes swapped:       (0,0), (1,0), (1,1), (0,1)</span></span><br><span class="line">  &#123;  <span class="number">3</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span> &#125;,    <span class="comment">// bits inverted:      (1,1), (1,0), (0,0), (0,1)</span></span><br><span class="line">  &#123;  <span class="number">3</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span> &#125;,    <span class="comment">// swapped &amp; inverted: (1,1), (0,1), (0,0), (1,0)</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// kPosToOrientation[pos] -&gt; orientation_modifier</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> kPosToOrientation[<span class="number">4</span>] = &#123;<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">3</span>&#125;;</span><br></pre></td></tr></table></figure></div><p>　　方向 0（canonical order）相当于上文中 A，方向 1（axes swapped）相当于上文中 D，方向 2（bits inverted）相当于上文中 C，方向 3（swapped &amp; inverted）相当于上文中 B，kPosToOrientation 代表 S2 中方向 0 一分四的对应关系，而 方向 1，2，3 的对应关系可由该值推出，计算公式为 <code>orientation ^ kPosToOrientation</code>，eg：<code>1 -&gt; 1^kPosToOrientation=[0, 1, 1, 2]; 3 -&gt; 3^kPosToOrientation=[2, 3, 3, 0]</code>，与上文中一分四对应关系一致。</p><p>　　随后 S2 初始化了一个 4 阶希尔伯特曲线位置与坐标的对应关系查找表，见 C++ 版的 <code>MaybeInit()</code> 方法，</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> ij = (i &lt;&lt; <span class="number">4</span>) + j;</span><br><span class="line">lookup_pos[(ij &lt;&lt; <span class="number">2</span>) + orig_orientation] = (pos &lt;&lt; <span class="number">2</span>) + orientation;</span><br><span class="line">lookup_ij[(pos &lt;&lt; <span class="number">2</span>) + orig_orientation] = (ij &lt;&lt; <span class="number">2</span>) + orientation;</span><br></pre></td></tr></table></figure></div><p>　　orig_orientation 代表 4 个初始方向，orientation 代表该位置或坐标下一阶一分四的方向，数组中每个元素是 16 位数，2 个字节，一个四阶希尔伯特曲线是 <span class="math inline">\(2^4×2^4=256\)</span> 个位置，一个初始方向对应一个四阶希尔伯特曲线，所以一个查找表共占内存 <span class="math inline">\(2×256×4=2048=2KB\)</span>，正好一级缓存能放下，再大的话，一级缓存可能放不下，反而会降低查找速度。这两个查找表就相当于 4 个超“U”形的位置与坐标对应关系，同时一分四对应关系保持不变，以超“U”作为基本元素做下一阶希尔伯特曲线，每增加一阶位置往后增加 8 位，IJ 坐标各往后增加 4 位，如此，以更快的速度迭代到 S2 想要的 30 阶希尔伯特曲线。C++ 的这份代码就很精妙了：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">S2CellId <span class="title">S2CellId::FromFaceIJ</span><span class="params">(<span class="keyword">int</span> face, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 初始化超“U”形查找表</span></span><br><span class="line">  <span class="built_in">MaybeInit</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// face 向左移 60 位</span></span><br><span class="line">  uint64 n = absl::implicit_cast&lt;uint64&gt;(face) &lt;&lt; (kPosBits - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 确定每个面的初始“U”形方向，使每个面都保持相同的右手坐标系，6 个面生成的希尔伯特曲线可以依次相连</span></span><br><span class="line">  uint64 bits = (face &amp; kSwapMask);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 基于超“U”形得到 30 阶希尔伯特曲线 IJ 坐标对应位置</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GET_BITS(k) do &#123; \</span></span><br><span class="line"><span class="meta">    const int mask = (1 &lt;&lt; kLookupBits) - 1; \</span></span><br><span class="line"><span class="meta">    bits += ((i &gt;&gt; (k * kLookupBits)) &amp; mask) &lt;&lt; (kLookupBits + 2); \</span></span><br><span class="line"><span class="meta">    bits += ((j &gt;&gt; (k * kLookupBits)) &amp; mask) &lt;&lt; 2; \</span></span><br><span class="line"><span class="meta">    bits = lookup_pos[bits]; \</span></span><br><span class="line"><span class="meta">    n |= (bits &gt;&gt; 2) &lt;&lt; (k * 2 * kLookupBits); \</span></span><br><span class="line"><span class="meta">    bits &amp;= (kSwapMask | kInvertMask); \</span></span><br><span class="line"><span class="meta">  &#125; while (0)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// IJ 只有 30 位，7 这个调用只会导致位置移 4 位，后续调用都移 8 位，得到 4 + 8 * 7 = 60 位</span></span><br><span class="line">  <span class="built_in">GET_BITS</span>(<span class="number">7</span>); </span><br><span class="line">  <span class="built_in">GET_BITS</span>(<span class="number">6</span>);</span><br><span class="line">  <span class="built_in">GET_BITS</span>(<span class="number">5</span>);</span><br><span class="line">  <span class="built_in">GET_BITS</span>(<span class="number">4</span>);</span><br><span class="line">  <span class="built_in">GET_BITS</span>(<span class="number">3</span>);</span><br><span class="line">  <span class="built_in">GET_BITS</span>(<span class="number">2</span>);</span><br><span class="line">  <span class="built_in">GET_BITS</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="built_in">GET_BITS</span>(<span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> GET_BITS</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 整个 n 向右移一位，再以 1 结尾</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">S2CellId</span>(n * <span class="number">2</span> + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>再来看看根据 id 反算 IJ 坐标：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">S2CellId::ToFaceIJOrientation</span><span class="params">(<span class="keyword">int</span>* pi, <span class="keyword">int</span>* pj, <span class="keyword">int</span>* orientation)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 与上面一样</span></span><br><span class="line">  <span class="built_in">MaybeInit</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> face = <span class="keyword">this</span>-&gt;<span class="built_in">face</span>();</span><br><span class="line">  <span class="keyword">int</span> bits = (face &amp; kSwapMask);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 反算 IJ 坐标，k == 7 时，取希尔伯特曲线位置高 4 位，IJ 各前 2 位，其余依次取位置 8 位， IJ 各 4 位</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GET_BITS(k) do &#123; \</span></span><br><span class="line"><span class="meta">    const int nbits = (k == 7) ? (kMaxLevel - 7 * kLookupBits) : kLookupBits; \</span></span><br><span class="line"><span class="meta">    bits += (static_cast<span class="meta-string">&lt;int&gt;</span>(id_ &gt;&gt; (k * 2 * kLookupBits + 1)) \</span></span><br><span class="line"><span class="meta">             &amp; ((1 &lt;&lt; (2 * nbits)) - 1)) &lt;&lt; 2; \</span></span><br><span class="line"><span class="meta">    bits = lookup_ij[bits]; \</span></span><br><span class="line"><span class="meta">    i += (bits &gt;&gt; (kLookupBits + 2)) &lt;&lt; (k * kLookupBits); \</span></span><br><span class="line"><span class="meta">    j += ((bits &gt;&gt; 2) &amp; ((1 &lt;&lt; kLookupBits) - 1)) &lt;&lt; (k * kLookupBits); \</span></span><br><span class="line"><span class="meta">    bits &amp;= (kSwapMask | kInvertMask); \</span></span><br><span class="line"><span class="meta">  &#125; while (0)</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">GET_BITS</span>(<span class="number">7</span>);</span><br><span class="line">  <span class="built_in">GET_BITS</span>(<span class="number">6</span>);</span><br><span class="line">  <span class="built_in">GET_BITS</span>(<span class="number">5</span>);</span><br><span class="line">  <span class="built_in">GET_BITS</span>(<span class="number">4</span>);</span><br><span class="line">  <span class="built_in">GET_BITS</span>(<span class="number">3</span>);</span><br><span class="line">  <span class="built_in">GET_BITS</span>(<span class="number">2</span>);</span><br><span class="line">  <span class="built_in">GET_BITS</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="built_in">GET_BITS</span>(<span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> GET_BITS</span></span><br><span class="line"></span><br><span class="line">  *pi = i;</span><br><span class="line">  *pj = j;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (orientation != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="built_in">S2_DCHECK_EQ</span>(<span class="number">0</span>, kPosToOrientation[<span class="number">2</span>]);</span><br><span class="line">    <span class="built_in">S2_DCHECK_EQ</span>(kSwapMask, kPosToOrientation[<span class="number">0</span>]);</span><br><span class="line">    <span class="comment">// 0x1111111111111111ULL may be better?</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">lsb</span>() &amp; <span class="number">0x1111111111111110</span>ULL) &#123;</span><br><span class="line">      bits ^= kSwapMask;</span><br><span class="line">    &#125;</span><br><span class="line">    *orientation = bits;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> face;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>　　这里的 orientation 实际是指当前位置的方向，即其周围必有 3 个位置与其方向相同，最后一行注释 Shaun 之所以认为应该是 0x1111111111111111ULL，是因为第 30 阶希尔伯特曲线位置（leaf cell）按理说同样需要做异或操作得到方向，不过整个 S2 库都没有需要用到 leaf cell 的方向，所以这就倒无关紧要了。之所以需要做异或操作，是因为 bits 是该位置下一阶一分四的方向，而对于同一个希尔伯特曲线位置，奇数阶与奇数阶下一阶一分四方向相同，偶数阶与偶数阶下一阶一分四方向相同，lsb() 表示二进制 id 从右往左数第一个 1 所代表的数， 所以有 0x1111111111111110ULL 这一魔术数，而异或操作正好能将下一阶一分四方向调整为当前阶方向。</p><p>　　如此 S2 的坐标以及 id 的生成以及反算就很明了了，下面就是 S2 如何使用 id 做计算了。</p><hr><h3 id="facesiti-坐标">FaceSiTi 坐标</h3><p>　　这个是 S2 内部计算使用的坐标，一般用来计算 cell 的中心坐标，以及根据当前 s 和 t 坐标的精度（小数点后几位）判断对应的级别（level）。由于 S2 本身并不显式存储 ST 坐标（有存 UV 坐标），所以 ST 坐标只能计算出来，每个 cell 的中心点同样如此。计算公式为 <span class="math inline">\(Si=s*2^{31};Ti=t*2^{31}\)</span>。至于为啥是 <span class="math inline">\(2^{31}\)</span>，是因为该坐标是用来描述从 0~ 31 阶希尔伯特曲线网格的中心坐标，0 阶中心以 <span class="math inline">\(1/2^1\)</span> 递增，1 阶中心以 <span class="math inline">\(1/2^2\)</span> 递增，2 阶中心以 <span class="math inline">\(1/2^3\)</span> 递增，……，30 阶中心以 <span class="math inline">\(1/2^{31}\)</span> 递增。S2 计算 id 对应的格子中心坐标，首先就会计算 SiTi 坐标，再将 SiTi 转成 ST 坐标。</p><h2 id="算法篇">算法篇</h2><h3 id="邻域算法">邻域算法</h3><p>　　S2 计算邻域，最关键的是计算不同面相邻的 leaf cell id，即：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">S2CellId <span class="title">S2CellId::FromFaceIJWrap</span><span class="params">(<span class="keyword">int</span> face, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 限制 IJ 最大最小取值为 -1~2^30, 刚好能超出 IJ 正常表示范围 0~2^30-1</span></span><br><span class="line">  i = <span class="built_in">max</span>(<span class="number">-1</span>, <span class="built_in">min</span>(kMaxSize, i));</span><br><span class="line">  j = <span class="built_in">max</span>(<span class="number">-1</span>, <span class="built_in">min</span>(kMaxSize, j));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">double</span> kScale = <span class="number">1.0</span> / kMaxSize;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">double</span> kLimit = <span class="number">1.0</span> + DBL_EPSILON;</span><br><span class="line">  <span class="built_in">S2_DCHECK_EQ</span>(<span class="number">0</span>, kMaxSize % <span class="number">2</span>);</span><br><span class="line">  <span class="comment">// IJ -&gt; SiTi -&gt; ST -&gt; UV</span></span><br><span class="line">  <span class="keyword">double</span> u = <span class="built_in">max</span>(-kLimit, <span class="built_in">min</span>(kLimit, kScale * (<span class="number">2</span> * (i - kMaxSize / <span class="number">2</span>) + <span class="number">1</span>)));</span><br><span class="line">  <span class="keyword">double</span> v = <span class="built_in">max</span>(-kLimit, <span class="built_in">min</span>(kLimit, kScale * (<span class="number">2</span> * (j - kMaxSize / <span class="number">2</span>) + <span class="number">1</span>)));</span><br><span class="line"></span><br><span class="line">  face = S2::<span class="built_in">XYZtoFaceUV</span>(S2::<span class="built_in">FaceUVtoXYZ</span>(face, u, v), &amp;u, &amp;v);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">FromFaceIJ</span>(face, S2::<span class="built_in">STtoIJ</span>(<span class="number">0.5</span>*(u+<span class="number">1</span>)), S2::<span class="built_in">STtoIJ</span>(<span class="number">0.5</span>*(v+<span class="number">1</span>)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>　　这个算法主要用来计算超出范围（0~2^30-1）的 IJ 对应的 id，核心思想是先将 FaceIJ 转为 XYZ，再使用 XYZ 反算得到正常的 FaceIJ，进而得到正常的 id。中间 IJ -&gt; UV 中坐标实际经过了 3 步，对于 leaf cell，IJ -&gt; SiTi 的公式为 <span class="math inline">\(Si=2×I+1\)</span>，而对于 ST -&gt; UV，这里没有采用二次变换，就是线性变换 <span class="math inline">\(u=2*s-1\)</span>，官方注释上说明用哪个变换效果都一样，所以采用最简单的就行。</p><h4 id="边邻域">边邻域</h4><p>　　边邻域代码很简单，也很好理解：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">S2CellId::GetEdgeNeighbors</span><span class="params">(S2CellId neighbors[<span class="number">4</span>])</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i, j;</span><br><span class="line">  <span class="keyword">int</span> level = <span class="keyword">this</span>-&gt;<span class="built_in">level</span>();</span><br><span class="line">  <span class="comment">// 计算当前 level 一行或一列对应多少个 30 级的 cell（leaf cell） 2^(30-level)</span></span><br><span class="line">  <span class="keyword">int</span> size = <span class="built_in">GetSizeIJ</span>(level);</span><br><span class="line">  <span class="keyword">int</span> face = <span class="built_in">ToFaceIJOrientation</span>(&amp;i, &amp;j, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Edges 0, 1, 2, 3 are in the down, right, up, left directions.</span></span><br><span class="line">  neighbors[<span class="number">0</span>] = <span class="built_in">FromFaceIJSame</span>(face, i, j - size, j - size &gt;= <span class="number">0</span>)</span><br><span class="line">                 .<span class="built_in">parent</span>(level);</span><br><span class="line">  neighbors[<span class="number">1</span>] = <span class="built_in">FromFaceIJSame</span>(face, i + size, j, i + size &lt; kMaxSize)</span><br><span class="line">                 .<span class="built_in">parent</span>(level);</span><br><span class="line">  neighbors[<span class="number">2</span>] = <span class="built_in">FromFaceIJSame</span>(face, i, j + size, j + size &lt; kMaxSize)</span><br><span class="line">                 .<span class="built_in">parent</span>(level);</span><br><span class="line">  neighbors[<span class="number">3</span>] = <span class="built_in">FromFaceIJSame</span>(face, i - size, j, i - size &gt;= <span class="number">0</span>)</span><br><span class="line">                 .<span class="built_in">parent</span>(level);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>　　分别计算当前 IJ 坐标下右上左坐标对应 id，FromFaceIJSame 表示若邻域在相同面，则走 FromFaceIJ，否则走 FromFaceIJWrap，由于这两个函数得到都是 leaf cell，要上升到指定 level，需要用到 parent 方法，即将希尔伯特曲线位置去掉右 <span class="math inline">\(2*(30-level)\)</span> 位，再组合成新的 id，位运算也很有意思：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> uint64 <span class="title">lsb_for_level</span><span class="params">(<span class="keyword">int</span> level)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> uint64&#123;<span class="number">1</span>&#125; &lt;&lt; (<span class="number">2</span> * (kMaxLevel - level));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> S2CellId <span class="title">S2CellId::parent</span><span class="params">(<span class="keyword">int</span> level)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">  uint64 new_lsb = <span class="built_in">lsb_for_level</span>(level);</span><br><span class="line">  <span class="comment">// 取反加一实际是取负数</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">S2CellId</span>((id_ &amp; (~new_lsb + <span class="number">1</span>)) | new_lsb);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h4 id="点邻域">点邻域</h4><p>　　S2 的点邻域并不是指常规意义上 4 个顶点相邻左上右上右下左下的 id，而是一种比较特殊的相邻关系，以直角坐标系 (0,0),(0,1),(1,1),(1,0) 为例，(0,0) 的点邻域为 (0,0),(0,-1),(-1,-1),(-1,0)，(0,1) 的点邻域为 (0,1),(0,2),(-1,2),(-1,1)，(1,1) 的点邻域为 (1,1),(1,2),(2,2),(2,1)，(1,0) 的点邻域为 (1,0),(1,-1),(2,-1),(2,0)。具体代码如下：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">S2CellId::AppendVertexNeighbors</span><span class="params">(<span class="keyword">int</span> level,</span></span></span><br><span class="line"><span class="params"><span class="function">                                     vector&lt;S2CellId&gt;* output)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">  <span class="comment">// level &lt; this-&gt;level()</span></span><br><span class="line">  <span class="built_in">S2_DCHECK_LT</span>(level, <span class="keyword">this</span>-&gt;<span class="built_in">level</span>());</span><br><span class="line">  <span class="keyword">int</span> i, j;</span><br><span class="line">  <span class="keyword">int</span> face = <span class="built_in">ToFaceIJOrientation</span>(&amp;i, &amp;j, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断 IJ 落在 level 对应 cell 的哪个方位？（左下左上右上右下，对应上文的(0,0),(0,1),(1,1),(1,0)坐标）</span></span><br><span class="line">  <span class="keyword">int</span> halfsize = <span class="built_in">GetSizeIJ</span>(level + <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">int</span> size = halfsize &lt;&lt; <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">bool</span> isame, jsame;</span><br><span class="line">  <span class="keyword">int</span> ioffset, joffset;</span><br><span class="line">  <span class="keyword">if</span> (i &amp; halfsize) &#123;</span><br><span class="line">    ioffset = size;</span><br><span class="line">    isame = (i + size) &lt; kMaxSize;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ioffset = -size;</span><br><span class="line">    isame = (i - size) &gt;= <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (j &amp; halfsize) &#123;</span><br><span class="line">    joffset = size;</span><br><span class="line">    jsame = (j + size) &lt; kMaxSize;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    joffset = -size;</span><br><span class="line">    jsame = (j - size) &gt;= <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  output-&gt;<span class="built_in">push_back</span>(<span class="built_in">parent</span>(level));</span><br><span class="line">  output-&gt;<span class="built_in">push_back</span>(<span class="built_in">FromFaceIJSame</span>(face, i + ioffset, j, isame).<span class="built_in">parent</span>(level));</span><br><span class="line">  output-&gt;<span class="built_in">push_back</span>(<span class="built_in">FromFaceIJSame</span>(face, i, j + joffset, jsame).<span class="built_in">parent</span>(level));</span><br><span class="line">  <span class="comment">// 则邻域的 IJ 与当前 cell 都不在同一个面，则说明只有三个点邻域</span></span><br><span class="line">  <span class="keyword">if</span> (isame || jsame) &#123;</span><br><span class="line">    output-&gt;<span class="built_in">push_back</span>(<span class="built_in">FromFaceIJSame</span>(face, i + ioffset, j + joffset,</span><br><span class="line">                                     isame &amp;&amp; jsame).<span class="built_in">parent</span>(level));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>　　上面的代码算是比较清晰了，3 个点邻域的情况一般出现在当前 id 位于立方体 6 个面的角落，<em>该方法的参数 level 必须比当前 id 的 level 要小</em>。</p><h4 id="全邻域">全邻域</h4><p>　　所谓全邻域，即为当前 id 对应 cell 周围一圈 cell 对应的 id，若周围一圈 cell 的 level 与 当前 id 的 level 一样，则所求即为正常的 9 邻域。具体代码如下：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="C++"><div class="code-copy"></div><figure class="highlight hljs c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">S2CellId::AppendAllNeighbors</span><span class="params">(<span class="keyword">int</span> nbr_level,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  vector&lt;S2CellId&gt;* output)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">  <span class="comment">// nbr_level &gt;= level</span></span><br><span class="line">  <span class="built_in">S2_DCHECK_GE</span>(nbr_level, <span class="built_in">level</span>());</span><br><span class="line">  <span class="keyword">int</span> i, j;</span><br><span class="line">  <span class="keyword">int</span> face = <span class="built_in">ToFaceIJOrientation</span>(&amp;i, &amp;j, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 先归一 IJ 坐标，将 IJ 坐标调整为当前 cell 左下角 leaf cell 的坐标</span></span><br><span class="line">  <span class="keyword">int</span> size = <span class="built_in">GetSizeIJ</span>();</span><br><span class="line">  i &amp;= -size;</span><br><span class="line">  j &amp;= -size;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> nbr_size = <span class="built_in">GetSizeIJ</span>(nbr_level);</span><br><span class="line">  <span class="built_in">S2_DCHECK_LE</span>(nbr_size, size);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> k = -nbr_size; ; k += nbr_size) &#123;</span><br><span class="line">    <span class="keyword">bool</span> same_face;</span><br><span class="line">    <span class="keyword">if</span> (k &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      same_face = (j + k &gt;= <span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (k &gt;= size) &#123;</span><br><span class="line">      same_face = (j + k &lt; kMaxSize);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      same_face = <span class="literal">true</span>;</span><br><span class="line">      <span class="comment">// 生成外包围圈下上两边的 id, 顺序为从左往右</span></span><br><span class="line">      output-&gt;<span class="built_in">push_back</span>(<span class="built_in">FromFaceIJSame</span>(face, i + k, j - nbr_size,</span><br><span class="line">                                       j - size &gt;= <span class="number">0</span>).<span class="built_in">parent</span>(nbr_level));</span><br><span class="line">      output-&gt;<span class="built_in">push_back</span>(<span class="built_in">FromFaceIJSame</span>(face, i + k, j + size,</span><br><span class="line">                                       j + size &lt; kMaxSize).<span class="built_in">parent</span>(nbr_level));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 生成外包围圈左右两边以及四个边角的 id, 顺序为从下往上</span></span><br><span class="line">    output-&gt;<span class="built_in">push_back</span>(<span class="built_in">FromFaceIJSame</span>(face, i - nbr_size, j + k,</span><br><span class="line">                                     same_face &amp;&amp; i - size &gt;= <span class="number">0</span>)</span><br><span class="line">                      .<span class="built_in">parent</span>(nbr_level));</span><br><span class="line">    output-&gt;<span class="built_in">push_back</span>(<span class="built_in">FromFaceIJSame</span>(face, i + size, j + k,</span><br><span class="line">                                     same_face &amp;&amp; i + size &lt; kMaxSize)</span><br><span class="line">                      .<span class="built_in">parent</span>(nbr_level));</span><br><span class="line">    <span class="keyword">if</span> (k &gt;= size) <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>　　知道这个函数的作用，再看代码就很明了了，<em>这个方法的参数 nbr_level 必须大于或等于当前 id 的 level</em>，因为一旦外包围圈的 cell 面积比当前 cell 还大，就无法得到正确的外包围圈。</p><h3 id="覆盖算法">覆盖算法</h3><p>　　S2 的覆盖，是指给定一块区域，能用多少 id 对应的 cell 完全覆盖该区域（GetCovering），当然也有尽量覆盖的算法（GetInteriorCovering），下面主要解析 GetCovering，因为 GetInteriorCovering 也差不多，就是覆盖策略略有不同。</p><p>GetCovering 的区域入参是 S2Region，比较典型的 S2Region 有以下几种：</p><ul><li>S2Cell：S2 id 对应的网格，会保存左下右上两个 UV 坐标，也是覆盖算法使用的基本元素；</li><li>S2CellUnion：多个 S2Cell 集合体，GetCovering 的返回值；</li><li>S2LatLngRect：经纬度矩形区域；</li><li>S2Cap：球帽区域，类比于二维圆的圆弧，球帽的构造比较奇怪，球帽的中心 S2Point 是需要，但另一个变量不是球帽的圆弧角，而是半个圆弧角（S2 代码库对应的 S1Angle 弧度，90 度代表半球，180 度代表全球）所对应弦长的平方，最大值为 4，之所以采用弦长的平方作为默认构造，是因为这就是 3 维中距离，在进行距离比较的场景时会更方便，比如测试是否包含一个 S2Point，计算覆盖多边形时，就不用再比较角度，毕竟角度计算代价比较大；</li><li>S2Loop：多边形的基本组成元素，第一个点与最后一个点隐式连接，逆时针代表封闭，顺时针代表开孔取外围区域，不允许自相交；</li><li>S2Polygon：非常正常的复杂多边形，由多个 S2Loop 构成，S2Loop 之间不能相交；</li><li>S2Polyline：一条折线，同样不能自相交；</li><li>还有些其它不常用的：S2R2Rect（S2Point 矩形区域），S2RegionIntersection（集合相交区域），S2RegionUnion（集合合并区域），……等。</li></ul><p>　　S2 覆盖算法的本质是一种启发式算法，先取满足当前条件最基本的元素，再依照条件进行迭代优化，所以该算法得到的只是一个近似最优解。GetCovering 需要依次满足以下条件：</p><ol type="1"><li>生成的 S2Cell level 不能比指定的 minLevel 小；（必须满足）</li><li>生成的 S2Cell 的个数不能比指定的 maxCells 多；（可以满足，当满足 1 时，数目已经 maxCells 多，迭代停止）</li><li>生成的 S2Cell level 不能比指定的 maxLevel 大；（必须满足）</li></ol><p>　　以上 3 个条件对应 GetCovering 的其他三个参数，当然还有一个参数是 levelModel，表示从 minLevel 向下分到 maxLevel 时，是 1 分 4，还是 1 分 16，还是 1 分 64，对应一次升 1 阶曲线，还是一次升 2 阶，或是一次升 3 阶。下面就来具体看看 GetCovering 的算法流程（代码就不贴了，太多了）：</p><ol type="1"><li>首先获取候选种子 S2Cell。先构造一个临时覆盖器，设置 maxCells 为 4，minLevel 为 0，以快速得到初始覆盖结果，做法为：先得到覆盖输入区域的 S2Cap，再用 S2CellUnion 覆盖该 S2Cap，根据 S2Cap 圆弧度计算 S2Cell 的 level，若最终 level &lt; 0，则说明 S2Cap 非常大，需要取 6 个面对应的 S2Cell，否则只需要取 S2Cap 中心点对应 S2Cell 的 level 级的点邻域 4 个 S2Cell 作为初始候选 S2Cell。</li><li>然后标准化候选种子。第一步，如果候选 S2Cell level 比 maxLevel 大或者候选 S2Cell 的 level 不符合 levelModel，则调整候选 S2Cell 的 level，用指定父级 S2Cell 来代替；第二步，归一化候选 S2Cell，先对 S2Cell 按 id 排序，去除被包含的 id，以及对 id 剪枝（若连续 4 个 S2Cell 共有同一个 parent，则用 parent 代替这 4 个 S2Cell）；第三步，反归一化候选 S2Cell，若候选 S2Cell level 比 minLevel 小或不满足 levelModel，则需要将 S2Cell 分裂，用指定级别的孩子来取代该 S2Cell；第四步，检查是否满足全部条件，若满足，则标准化完成，若不满足，则看候选 S2Cell 的数目是否足够多，若足够多，则需要迭代进行 GetCovering，这样会极大降低算法性能，若不是很多，则迭代合并相同祖先的两个 S2Cell（当然祖先的 level 不能比 minLevel 小），最后再次检查所有候选 S2Cell 是否达到标准化要求，并调整 S2Cell level。</li><li>构造优先级队列。将符合条件（与入参区域相交）的候选 S2Cell 放进一个优先级队列中，优先级会依次根据三个参数进行判断，1、S2Cell 的大小（level 越大，S2Cell 越小），越大的优先级越高；2、入参区域与候选 S2Cell 孩子相交（这里的相交是指相交但不完全包含）的个数，越少优先级越高；3、入参区域完全包含候选 S2Cell 孩子和与无法再细分的孩子的个数，同样是越少优先级越高。在构造这个优先级队列的同时，会输出一些候选 S2Cell 作为覆盖算法的正式结果，这些 S2Cell 满足任意以下条件：1、被入参区域完全覆盖；2、与入参区域相交但不可再细分；3、入参区域包含或相交全部孩子。如此留在优先级队列中的，就都是些与入参区域边界相交的 S2Cell，这些就是真正的候选 S2Cell。</li><li>最后，处理优先级队列中的 S2Cell。处理方式也比较简单粗暴，继续细分并入队，满足上面3个出队条件的任意一个，即可出队作为正式结果，当然，若分到后面可能正式的 S2Cell 太多，甚至超过 maxCells，这时不再细分强行出队作为正式结果。最后，再对正式结果做一次标准化处理，即进行第 2 步，得到最终的覆盖结果。</li></ol><p>　　以上就是 S2 覆盖算法的大致流程，更加细节的东西，还是得看代码，文字有些不是很好描述，代码里面计算候选 S2Cell 的优先级就很有意思。</p><hr><p>　　当然 S2 中还有很多其他算法（凸包，相交，距离），这里就不做太多介绍了，Shaun 平常用的最多的就是覆盖算法，之前一直没有细看，就简单用用 api，同时为了对一块大的 S2Cell 做多线程处理，需要了解 S2Cell 一分四的方向，经过这次对 S2 的了解，发现之前的用法存在一些问题，可见调包侠同样需要对包有一定的了解才能调好包 ╮(╯▽╰)╭。</p><h2 id="后记">后记</h2><p>　　正如许多经典的算法一样，看完之后总有种我上我也行的感觉，但实际完全不行，S2 全程看下来有些地方确实比较晦涩，而且这一连串的想法也很精妙（单位球立方体投影，ST 空间面积优化，64 位 id 生成等），Shaun 或许能有部分想法，但这么多奇思妙想组合起来，就完全不行。</p><h2 id="附录">附录</h2><h3 id="hilbertcurve-绘制">HilbertCurve 绘制</h3><p>　　在网上随便找了三种实现方式，并用 threejs 简单绘制了一下：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="TYPESCRIPT"><div class="code-copy"></div><figure class="highlight hljs typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> THREE <span class="keyword">from</span> <span class="string">&quot;three&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">HilbertCurve</span> </span>&#123;</span><br><span class="line">    order = <span class="number">3</span>; <span class="comment">// 阶数</span></span><br><span class="line">    size = <span class="number">1</span> &lt;&lt; <span class="built_in">this</span>.order; <span class="comment">// 行列数</span></span><br><span class="line">    totalSize = <span class="built_in">this</span>.size * <span class="built_in">this</span>.size; <span class="comment">// 总网格数，希尔伯特长度</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// https://www.youtube.com/watch?v=dSK-MW-zuAc</span></span><br><span class="line">    <span class="function"><span class="title">getPath_V1</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> path = [];</span><br><span class="line">        <span class="keyword">let</span> origOrientation = [</span><br><span class="line">            [<span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">            [<span class="number">0</span>, <span class="number">1</span>],</span><br><span class="line">            [<span class="number">1</span>, <span class="number">1</span>],</span><br><span class="line">            [<span class="number">1</span>, <span class="number">0</span>],</span><br><span class="line">        ]; <span class="comment">// 倒 U 形</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="built_in">this</span>.totalSize; i++) &#123;</span><br><span class="line">            path.push(hilbertToXY(i, <span class="built_in">this</span>.order));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">hilbertToXY</span>(<span class="params">i: <span class="built_in">number</span>, order: <span class="built_in">number</span></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">let</span> index = i &amp; <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">let</span> curCoord = origOrientation[index].slice();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> ord = <span class="number">1</span>; ord &lt; order; ord++) &#123;</span><br><span class="line">                i = i &gt;&gt;&gt; <span class="number">2</span>;</span><br><span class="line">                index = i &amp; <span class="number">3</span>;</span><br><span class="line">                <span class="keyword">let</span> delta = <span class="number">1</span> &lt;&lt; ord;</span><br><span class="line">                <span class="keyword">if</span> (index === <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// 顺时针旋转 90°</span></span><br><span class="line">                    <span class="keyword">let</span> tmp = curCoord[<span class="number">0</span>];</span><br><span class="line">                    curCoord[<span class="number">0</span>] = curCoord[<span class="number">1</span>];</span><br><span class="line">                    curCoord[<span class="number">1</span>] = tmp;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (index === <span class="number">1</span>) &#123;</span><br><span class="line">                    curCoord[<span class="number">1</span>] += delta;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (index === <span class="number">2</span>) &#123;</span><br><span class="line">                    curCoord[<span class="number">0</span>] += delta;</span><br><span class="line">                    curCoord[<span class="number">1</span>] += delta;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (index === <span class="number">3</span>) &#123;</span><br><span class="line">                    <span class="comment">// 逆时针旋转 90°</span></span><br><span class="line">                    <span class="keyword">let</span> tmp = delta - <span class="number">1</span> - curCoord[<span class="number">0</span>];</span><br><span class="line">                    curCoord[<span class="number">0</span>] = delta - <span class="number">1</span> - curCoord[<span class="number">1</span>];</span><br><span class="line">                    curCoord[<span class="number">1</span>] = tmp;</span><br><span class="line">                    curCoord[<span class="number">0</span>] += delta;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> curCoord;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Hacker&#x27;s Delight</span></span><br><span class="line">    <span class="function"><span class="title">getPath_V2</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> path: <span class="built_in">number</span>[][] = [];</span><br><span class="line">        <span class="keyword">let</span> x = -<span class="number">1</span>,</span><br><span class="line">            y = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">let</span> s = <span class="number">0</span>; <span class="comment">// along the curve</span></span><br><span class="line"></span><br><span class="line">        step(<span class="number">0</span>);</span><br><span class="line">        hilbert(<span class="number">0</span>, <span class="number">1</span>, <span class="built_in">this</span>.order);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">step</span>(<span class="params">dir: <span class="built_in">number</span></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">switch</span> (dir &amp; <span class="number">3</span>) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                    x += <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                    y += <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                    x -= <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                    y -= <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            path[s] = [x, y];</span><br><span class="line"></span><br><span class="line">            s += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">hilbert</span>(<span class="params">dir: <span class="built_in">number</span>, rot: <span class="built_in">number</span>, order: <span class="built_in">number</span></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (order === <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            dir += rot;</span><br><span class="line">            hilbert(dir, -rot, order - <span class="number">1</span>);</span><br><span class="line">            step(dir);</span><br><span class="line"></span><br><span class="line">            dir -= rot;</span><br><span class="line">            hilbert(dir, rot, order - <span class="number">1</span>);</span><br><span class="line">            step(dir);</span><br><span class="line"></span><br><span class="line">            hilbert(dir, rot, order - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            dir -= rot;</span><br><span class="line">            step(dir);</span><br><span class="line">            hilbert(dir, -rot, order - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// https://en.wikipedia.org/wiki/Hilbert_curve</span></span><br><span class="line">    <span class="function"><span class="title">getPath_V3</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> path: <span class="built_in">number</span>[][] = [];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// for (let i = 0; i &lt; this.totalSize; i++) &#123;</span></span><br><span class="line">        <span class="comment">//     path.push(hilbertToXY(this.size, i));</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> y = <span class="number">0</span>; y &lt; <span class="built_in">this</span>.size; y++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> x = <span class="number">0</span>; x &lt; <span class="built_in">this</span>.size; x++) &#123;</span><br><span class="line">                path[xyToHilbert(<span class="built_in">this</span>.size, x, y)] = [x, y];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">rot</span>(<span class="params">N: <span class="built_in">number</span>, rx: <span class="built_in">number</span>, ry: <span class="built_in">number</span>, xy: <span class="built_in">number</span>[]</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (ry === <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (rx === <span class="number">1</span>) &#123;</span><br><span class="line">                    xy[<span class="number">0</span>] = N - <span class="number">1</span> - xy[<span class="number">0</span>];</span><br><span class="line">                    xy[<span class="number">1</span>] = N - <span class="number">1</span> - xy[<span class="number">1</span>];</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> t = xy[<span class="number">0</span>];</span><br><span class="line">                xy[<span class="number">0</span>] = xy[<span class="number">1</span>];</span><br><span class="line">                xy[<span class="number">1</span>] = t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">hilbertToXY</span>(<span class="params">N: <span class="built_in">number</span>, h: <span class="built_in">number</span></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">let</span> t = h;</span><br><span class="line">            <span class="keyword">let</span> xy = [<span class="number">0</span>, <span class="number">0</span>];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> s = <span class="number">1</span>; s &lt; N; s *= <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="keyword">let</span> rx = <span class="number">1</span> &amp; (t / <span class="number">2</span>);</span><br><span class="line">                <span class="keyword">let</span> ry = <span class="number">1</span> &amp; (t ^ rx);</span><br><span class="line">                rot(s, rx, ry, xy);</span><br><span class="line">                xy[<span class="number">0</span>] += s * rx;</span><br><span class="line">                xy[<span class="number">1</span>] += s * ry;</span><br><span class="line">                t /= <span class="number">4</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> xy;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">xyToHilbert</span>(<span class="params">N: <span class="built_in">number</span>, x: <span class="built_in">number</span>, y: <span class="built_in">number</span></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">let</span> h = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">let</span> xy = [x, y];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> s = N / <span class="number">2</span>; s &gt; <span class="number">0</span>; s /= <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="keyword">let</span> rx = (xy[<span class="number">0</span>] &amp; s) &gt; <span class="number">0</span> ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">let</span> ry = (xy[<span class="number">1</span>] &amp; s) &gt; <span class="number">0</span> ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">                h += s * s * ((<span class="number">3</span> * rx) ^ ry);</span><br><span class="line">                rot(N, rx, ry, xy);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> h;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">draw</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> lineGeometry = <span class="keyword">new</span> THREE.Geometry();</span><br><span class="line">        <span class="built_in">this</span>.getPath_V3().forEach(<span class="function">(<span class="params">vertice</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> vecot = <span class="keyword">new</span> THREE.Vector3().fromArray(vertice);</span><br><span class="line">            vecot.setZ(<span class="number">0</span>);</span><br><span class="line">            lineGeometry.vertices.push(vecot);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">let</span> lineMaterial = <span class="keyword">new</span> THREE.LineBasicMaterial(&#123; <span class="attr">color</span>: <span class="number">0x00ffff</span>, <span class="attr">linewidth</span>: <span class="number">1</span> &#125;);</span><br><span class="line">        <span class="keyword">let</span> line = <span class="keyword">new</span> THREE.Line(lineGeometry, lineMaterial);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> line;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div></div><div class="article-content-more"><button type="button" class="article-more--link"><i class="fa fa-angle-double-down fa-3x" aria-hidden="true"></i></button></div></section></article><article id="post-K8S-应用开发指北" class="article div-border"><header class="article-header"><span class="article-date article-title--index"><i class="fa fa-calendar" aria-hidden="true"></i> <a href="/posts/55e674ff.html"><time datetime="2021-08-28T08:21:58.000Z">2021-08-28</time></a></span><section class="article-title article-title--index"><a href="/posts/55e674ff.html">K8S 应用开发指北</a></section><div class="article-label"><div class="article-category label"><i class="fa fa-book" aria-hidden="true"></i> <a class="color3 article-category-link" href="/categories/CloudNative/">CloudNative</a></div><div class="article-tag label"><i class="fa fa-bookmark" aria-hidden="true"></i> <a class="color3 article-tag-none-link" href="/tags/k8s/" rel="tag">k8s</a></div></div></header><section class="article-content"><div class="article-content--excerpt"><h2 id="前言">前言</h2><p>　　在周志明的『凤凰架构』中需要思考这样一个问题，如何用不可靠的部件来构造一个可靠的系统？对于程序员来说，写的代码从某种程度上来说都是不可靠的，但这些代码组成的一些系统却可以是可靠的。程序员对于错误的处理可以分为两派，一派是必须对错误进行处理，以保证系统的稳定行；另一派不对错误进行处理，任由程序 crash，只要有兜底方案，后面再不断完善。这两派并无孰优孰劣，只是两种不同的思维方式，甚至在同一个程序中，有些错误会处理，有些错误不会处理，这都是可能的。K8S 作为事实上的云原生操作系统，其目的就是为了将程序员写的各个程序组装成一个稳定的系统，并减少运维成本。</p></div><div class="article-content--all"><h2 id="前言">前言</h2><p>　　在周志明的『凤凰架构』中需要思考这样一个问题，如何用不可靠的部件来构造一个可靠的系统？对于程序员来说，写的代码从某种程度上来说都是不可靠的，但这些代码组成的一些系统却可以是可靠的。程序员对于错误的处理可以分为两派，一派是必须对错误进行处理，以保证系统的稳定行；另一派不对错误进行处理，任由程序 crash，只要有兜底方案，后面再不断完善。这两派并无孰优孰劣，只是两种不同的思维方式，甚至在同一个程序中，有些错误会处理，有些错误不会处理，这都是可能的。K8S 作为事实上的云原生操作系统，其目的就是为了将程序员写的各个程序组装成一个稳定的系统，并减少运维成本。</p><span id="more"></span><h2 id="基础篇">基础篇</h2><p>　　K8S 调度的基本单元是 Pod，Pod 也是 K8S 自带的一个资源对象，其可以简单理解为是一个容器集合体，程序员可控的容器有两类（Pause 容器除外），一类是 InitContainer，另一类是普通业务容器，InitContainer 按数组顺序创建，顺序执行，若一个失败，则整个 Pod 创建失败，普通业务容器同样按数组顺序创建，但异步执行，所以执行顺序不可控（可以通过 postStart Hook 简单控制一下）。由于 InitContainer 先于 Pod 其他容器执行，所以一般用来做普通业务容器执行前置条件的一些事情，比如：下载文件，初始化配置，状态消息通知等。</p><p>　　同一 Pod 中存储卷和网络可以共享。存储卷共享是指 Pod 内各容器可以挂载相同存储卷，从而数据共享。K8S 目前支持的存储卷共有三种：第一种是 emptyDir，这种存储是临时的，只能在 Pod 内使用，当 Pod 被销毁时，该存储的内容也会消失，只能在同一 Pod 内共享数据；第二种是 hostPath，这种存储会直接和集群中物理机存储相关联，是一种跨 Pod 持久化存储，但仅限该物理机，当 pod 被调度到其他物理机时就无法实现跨 Pod 共享数据；最后一种是外部存储（NFS，Ceph，GlusterFS，AWS EBS 等），这种方式可以真正实现数据持久化并共享，而且可以支持存储与计算分离，对系统会更友好一些，当然运维的成本也会更大。当然除了 K8S 自身提供的存储卷挂载可以实现数据共享，从程序的角度上，使用传统的方式一样也能数据共享，如数据库，DFS，OSS 等。</p><p>　　而网络共享是指 Pod 内各容器直接可以使用 localhost 以及容器暴露的端口进行相互通信，K8S 的端口有三种，分别为：容器端口（containerPort，容器中对外暴露的端口），集群内端口（port，集群内 pod 相互通信的端口），集群外端口（nodePort，集群外请求集群内的端口），其中容器端口和集群内是正常的动态端口，取值范围为 [1024, 65535]，集群外端口只能设置为 [30000, 32767]，若集群中服务不与集群外通信，则只需要设置集群内端口就行。K8S 中 IP 也同样有三种，分别为：Pod IP（两不同 Pod 资源对象相互通信的地址，集群外不可访问），Cluster IP（Service 资源对象的通信地址，集群外不可访问），Node IP（K8S 物理节点的 IP 地址，是真实的物理网络，集群外配合 nodePort 即可访问）。集群内端口和集群外端口由 K8S 的 Service 资源提供设置。<em>在创建 Service 时需要注意，一个 Pod 资源对应一个 Service 资源，不要想着一个 Service 管理两个 Pod 暴露的端口，这样做会使 Service 提供服务的能力异常，经常会接口超时</em>。</p><p>　　K8S 编程可以简单称之为面向 config 编程，一切需要动态变化的程序初始化变量，都应该以 config 的形式提供，然后交给运维就行，这样可以避免程序员频繁的修改程序，减少运维负担，K8S 的 config 有三种形式，第一种是程序启动参数，通过创建容器时的 args 参数配置；第二种是系统环境变量，通过创建容器时的 env 参数配置；最后一种是 K8S 提供的 ConfigMap 资源，该资源可以从文件，目录或 key-value 字符串创建，创建后的 ConfinMap 被全集群同命名空间所共享，可以通过 volumes 参数挂载到 pod 中，进而 mount 进容器中，被程序读取。前两种 config 方式对于配置变量少的可以使用，当配置变量很多或配置参数很长时，还是使用 ConfigMap 比较合适。</p><h2 id="调度篇">调度篇</h2><p>　　调度，广义上的调度可指一切管理安排，CPU 的指令执行就涉及到三级缓存的调度，程序运行时的 GC 可认为是运行时对内存资源的调度，操作系统的进程轮转可认为是系统对进程的调度，而 K8S 中的调度可简单理解为是对操作系统的调度。</p><p>　　K8S 的调度可简单分为两个层面上的调度，最底层的调度自然是 K8S 自身的调度策略，根据不同的资源用度和调度策略将 Pod 分配到不同的物理节点之上执行，根据指定的重启或恢复策略启动相应的 Pod，这个层面上的调度，K8S 有一套默认的调度器，对于特殊的调度需求，K8S 也支持自定义调度器，使用外部调度器代替默认调度器，这个层面的调度器 Shaun 没做太多研究，所以在这篇里对这层面的调度器不做过多描述。Shaun 接触过的是更上层的调度器，业务层面的调度服务，业务调度服务一般与业务紧密相关，但最核心的一点就是能够从业务入手，负责 Pod 的创建和销毁，并能掌握其运行状态，就算是完成了一个基础的业务调度服务器。</p><p>　　在设计业务调度服务时，有一种通用的模式，可以称之为 master-worker 模式，与同名的并发模式细节上有所不同，这里的 master 是指调度服务本体，只负责对外服务，资源监控，以及任务分发，任务状态感知等，不负责做具体的任务，一般也不关心任务的输入输出。在部署 master 时，一般会创建一个 Service 资源对象，毕竟其主要功能就是对外服务，master 一般由运维进行部署创建销毁。而 worker 是指真正做任务的 Pod，该 Pod 中可能会有多个容器，主容器负责真正执行任务，其他一些容器可能会负责保障任务的前置条件（输入，配置等），以及向 master 汇报任务执行状态信息（执行任务的主容器可能并不知道 master 的存在）等。worker 对应的 Pod 一般由 master 进行创建销毁，worker 的一些配置信息则可能会由运维管理。</p><p>　　由于 K8S 并没有在整个集群物理资源之上抽象出一层集群资源，所以 K8S 分配的节点实际还是在物理机上，若所有物理机剩余资源（是单个剩余资源，而不是所有剩余资源之和）都不满足 Pod 所需资源，则该 Pod 无法调度，类比内存碎片化，可以称之为资源碎片化。所以在创建 Pod 时，所需资源最好不要太多，以免调度失败。</p><h2 id="实践篇">实践篇</h2><p>　　Shaun 目前在 K8S 上开发的主要就是重计算（单机计算时间以小时计）调度服务。这类调度服务其实也分两种，一种是并发调度，一种是流水线（pipeline）式的串行调度，当然也可以将这两种混合起来，串行中有并行。在设计这类调度服务时，需要考虑集群上的资源（内存，CPU）是否足够，若不足，则可以考虑加入一个简单的等待机制，将任务放进一个队列中，当然加入这样一个等待机制，又会增加系统复杂性，需要考虑队列容量，队列优先级等。所以可执行的最小任务消耗的资源越少约好，否则集群中可能完全无法执行相关任务。</p><p>　　由于 Shaun 是独立开发，能完全控制 master 和 worker 的编写，所以 worker 设计的比较简单，一个主容器即完成了前置数据处理，主任务执行，执行状态汇报等全部事情，这是从时间和性能上以及系统复杂度上等多方面权衡的结果，当然在时间足够人手够的情况，是应该把现有的 worker 进一步分离的，而 master 就是比较通用的设计，资源监控，任务队列，任务 Pod 创建与销毁，任务状态信息保存，服务接口等，其中常规的服务接口应该有添加任务，开始任务，停止任务，恢复任务，删除任务，任务状态查询，任务日志查询，任务状态汇报等接口，如果任务是并行且无依赖的，还应该支持开始指定子任务等接口。</p><p>　　在工作中，Shaun 也接触到一个 pipeline 式的任务调度服务，pipeline 式的工作流有个特点就是下一个子任务的输入必定依赖上一个子任务的输出，在这个任务调度服务中，其子任务的输入输出都是文件态，并且 master 不关心子任务的输入输出，子任务的执行程序也不知道 master 的存在，尽量低耦合。在云上，文件态的存储载体比较好的自然是 OSS，但原本的子任务执行程序只支持本地读取文件，而且在原来的程序中引入 OSS 的读写逻辑并不十分合适，所以在 K8S 中引入了 NFS，由 master 负责将 NFS 挂载到各子任务的 Pod 中，并在挂载到主容器时使用 SubPath 完成 pipeline 之间的资源隔离，使用 emptyDir 完成各子任务之间的资源隔离，每条 pipeline 开始的子任务是从 OSS 中拉取文件到 NFS 中对应的 SubPath 目录中，结束的子任务是将 NFS 中对应的 SubPath 目录中约定好的生成物上传到 OSS 中，并清空该 SubPath 目录，从而使原来的程序在 IO 这块完全不用改动。在监听任务运行状态方面，有两种方案：一种是利用 K8S 的 InitContainer，另一种是借助 K8S 的 shareProcessNamespace。InitContainer 的方案比较简单，InitContainer 第一个容器只做汇报子任务开始这一件事， 第二个容器则是真正执行子任务的容器，而业务容器只做汇报子任务结束这一件事，该方案利用 InitContainer 顺序且先于业务容器执行这两特点，并且若执行子任务的容器失败，则 Pod 也会创建失败，查询 Pod 状态即可知道子任务是否正常运行。而 shareProcessNamespace 的方案稍微复杂一些，同样使用一个 InitContainer 做汇报子任务开始这件事，而业务容器中放两个容器：一个主容器和一个 sidecar 容器（希望 K8S 原生支持的 SideCar 早日做好 ╯△╰），sidecar 容器中以轮询的方式监听主容器的运行状态（查询是否存在主进程）以及是否正常退出（获取容器退出码），并向 master 推送状态信息，该方案借助进程空间共享，使 sidecar 容器能直接查询主容器中的进程，从而达到监听主容器运行状态的目的，该方案的执行还需要一个小 trick，就是要让主容器先执行，由两种方案：一种是借助 postStart Hook，另一种是直接让 sidecar 容器先休眠个 10s 钟。关于 sidecar 容器的另外一种应用方案可参考 <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/143845408">Nginx容器配置文件如何热更新？</a> 。</p><p>　　虽然分布式任务调度框架有很多，eg：<a target="_blank" rel="noopener" href="https://airflow.apache.org/">Airflow</a>、<a target="_blank" rel="noopener" href="https://github.com/spotify/luigi">Luigi</a> 以及 <a target="_blank" rel="noopener" href="https://dolphinscheduler.apache.org">DolphinScheduler</a> 等，但目前与 K8S 联系最紧密的应该就是 <a target="_blank" rel="noopener" href="https://argoproj.github.io/">Argo</a> 了，其利用 K8S 的自定义资源对 K8S 已有功能进行扩展，仅使用 YAML 即可完成整个 pipeline 的任务调度和部署，虽然在并发任务调度时有一定的缺陷，但仅使用 YAML 表示其对 K8S 运维的足够友好性，对于常规 pipeline 式任务，Argo 已足以应付，除特殊需求外，程序员可少写很多代码。</p><h3 id="附录">附录</h3><p>　　对于 Spring 编写的程序，在 K8S 中运行，在导出日志时可参考 <a target="_blank" rel="noopener" href="https://www.cnblogs.com/varyuan/p/14243472.html">k8s:获取pod的ip</a>，通过 valueFrom 使用 Pod 的 metadata 作为环境变量，以区分日志的来源，不过挂载存储时最好还是用外部存储，用 hostPath 的话就需要保证每个物理节点都有相同的日志存储目录。</p><h2 id="后记">后记</h2><p>　　K8S 作为云原生时代的操作系统，不要求人人都完全掌握，但至少需要了解，知道什么该开发干，什么该运维干，这样才能充分发挥各个角色（包括 K8S）的价值。</p></div><div class="article-content-more"><button type="button" class="article-more--link"><i class="fa fa-angle-double-down fa-3x" aria-hidden="true"></i></button></div></section></article><article id="post-OpenGL坐标系统与渲染管线" class="article div-border"><header class="article-header"><span class="article-date article-title--index"><i class="fa fa-calendar" aria-hidden="true"></i> <a href="/posts/81321445.html"><time datetime="2021-05-28T10:22:41.000Z">2021-05-28</time></a></span><section class="article-title article-title--index"><a href="/posts/81321445.html">OpenGL坐标系统与渲染管线</a></section><div class="article-label"><div class="article-category label"><i class="fa fa-book" aria-hidden="true"></i> <a class="color5 article-category-link" href="/categories/Image-Graphic/">Image&Graphic</a></div><div class="article-tag label"><i class="fa fa-bookmark" aria-hidden="true"></i> <a class="color1 article-tag-none-link" href="/tags/algorithm/" rel="tag">algorithm</a></div></div></header><section class="article-content"><div class="article-content--excerpt"><h2 id="前言">前言</h2><p>　　图形学中最基础的东西就是坐标系统，三维的东西如何在二维中显示，这中间经历了数次坐标变换，同时坐标变换也贯穿了整个计算机图形渲染管线。</p></div><div class="article-content--all"><h2 id="前言">前言</h2><p>　　图形学中最基础的东西就是坐标系统，三维的东西如何在二维中显示，这中间经历了数次坐标变换，同时坐标变换也贯穿了整个计算机图形渲染管线。</p><span id="more"></span><h2 id="坐标篇">坐标篇</h2><figure><img src="https://learnopengl-cn.github.io/img/01/08/coordinate_systems.png" alt="coordinate_systems"><figcaption aria-hidden="true">coordinate_systems</figcaption></figure><p>　　在计算机图形世界中，为更灵活的控制三维物体显示在二维中，将变换的过程大致分为 5 个空间：1、局部空间（Local Space，或者称为物体空间（Object Space））；2、世界空间（World Space）；3、观察空间（View Space，或者称为视觉空间（Eye Space））；4、裁剪空间（Clip Space）；5、屏幕空间（Screen Space）。局部空间中是物体相对于坐标原点的坐标，也是物体的固有坐标，在依次经历过缩放旋转平移，也即模型矩阵（Model Matrix）变换后，物体局部坐标变换为世界坐标，世界坐标中即定义了物体所在的位置，以及产生的旋转和缩放。在世界空间中加入相机，以相机的视角看世界中的物体，即通过观察矩阵（View Matrix，也称视图矩阵）变换后，将世界坐标转换为观察坐标，由于一张屏幕能显示的东西是有限的，而三维世界中的物体是无限，所以需要通过投影矩阵（Projection Matrix）对三维空间进行裁剪，以决定哪些物体能显示在屏幕上，为方便的计算机判断，处于裁剪空间内的坐标会被转换为 [-1, 1]，为顺利在屏幕上显示，又需要通过视窗变换（Viewport Transform）将 [-1, 1] 映射为 viewport 中的图元坐标，再通过渲染管线的其他流程输出为屏幕上的像素点。</p><h2 id="变换篇">变换篇</h2><p>　　矩阵相乘一般有左乘和右乘之分，左乘和右乘的区别在于坐标是按列还是按行排列（OpenGL 中是按列，所以是左乘，DX 中按行，所以是右乘，同一种变换，传入 DX 中的矩阵与传入 OpenGL 中的矩阵互为转置），坐标与矩阵相乘越靠近坐标的矩阵表示该坐标越先做相应矩阵变换。</p><p>　　模型矩阵，视图矩阵，投影矩阵，在简单的顶点着色器编程中，这三个矩阵一般会合并成一个 MVP 矩阵传入 GPU 中。</p><h3 id="模型矩阵">模型矩阵</h3><p>　　模型矩阵一般定义了物体的缩放旋转平移状态，缩放矩阵的构造很简单，若物体在 <span class="math inline">\((x,y,z)\)</span> 方向上缩放尺度分别为 <span class="math inline">\((S_x, S_y, S_z)\)</span>，则缩放矩阵为： <span class="math display">\[ M_{scaling} = \begin{bmatrix} S_x &amp; 0 &amp; 0 &amp; 0 \\ 0 &amp; S_y &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; S_z &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; 1 \end{bmatrix} \]</span> 　　旋转矩阵就非常麻烦了，这里暂且不讨论其如何计算，只给出矩阵，物体绕任意轴 <span class="math inline">\((R_X, R_y, R_z)\)</span> 旋转 θ 角的矩阵为： <span class="math display">\[ M_{rotation} = \begin{bmatrix} cos\theta+R_x^2(1-cos\theta) &amp; R_xR_y(1-cos\theta)-R_zsin\theta &amp; R_xR_z(1-cos\theta)+R_ysin\theta &amp; 0 \\ R_yR_x(1-cos\theta)+R_zsin\theta &amp; cos\theta+R_y^2(1-cos\theta) &amp; R_yR_z(1-cos\theta)-R_xsin\theta &amp; 0 \\ R_zR_x(1-cos\theta)-R_ysin\theta &amp; R_zR_y(1-cos\theta)+R_xsin\theta &amp; cos\theta+R_z^2(1-cos\theta) &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; 1 \end{bmatrix} \]</span> 　　当然，由于万向节锁的存在，一般不会直接使用欧拉角和旋转轴计算旋转矩阵，而是会通过四元数得到旋转矩阵，这样既高效又能避免万向节锁，详情可看「LearnOpenGL」译者的<a target="_blank" rel="noopener" href="https://krasjet.github.io/quaternion/">教程</a>。</p><p>　　至于平移矩阵也非常简单，若物体在 <span class="math inline">\((x,y,z)\)</span> 方向上平移量分别为 <span class="math inline">\((T_x, T_y, T_z)\)</span>，则平移矩阵为： <span class="math display">\[ M_{translation} = \begin{bmatrix} 1 &amp; 0 &amp; 0 &amp; T_x \\ 0 &amp; 1 &amp; 0 &amp; T_y \\ 0 &amp; 0 &amp; 1 &amp; T_z \\ 0 &amp; 0 &amp; 0 &amp; 1 \end{bmatrix} \]</span> 　　前面的缩放和旋转矩阵其实只需要用到 3×3 的矩阵，而之所以用 4×4 的表示也是因为平移矩阵，普通的 3 维坐标必须增加一维 <span class="math inline">\(w\)</span> 构成齐次坐标才能进行平移操作，<span class="math inline">\(w\)</span> 一般都是 1.0，而从齐次坐标<span class="math inline">\((x,y,z,w)\)</span> 变为普通的 3 维坐标需要每个分量除以 <span class="math inline">\(w\)</span>，即 <span class="math inline">\((x/w, y/w, z/w)\)</span> 。</p><p>则模型矩阵 <span class="math inline">\(M_{model} = M_{translation} \cdot M_{rotation} \cdot M_{scaling}\)</span>。</p><h3 id="视图矩阵">视图矩阵</h3><p>　　视图矩阵描述的是三维场景中模拟相机的状态，根据模拟相机的状态确定一套以相机为原点的相机坐标系，从而使用视图矩阵进行坐标变换，至于为啥是模拟相机，是因为 OpenGL 本身并没有相机的概念，通过模拟相机来实现在三维场景中的漫游。</p><figure><img src="https://learnopengl-cn.github.io/img/01/09/camera_axes.png" alt="camera_axes"><figcaption aria-hidden="true">camera_axes</figcaption></figure><p>　　模拟相机有三个关键点，分别为相机位置（cameraPos），相机朝向点（cameraTarget），相机上向量（top），根据相机位置和相机朝向点可确定相机坐标系的 z 轴正向向量 <span class="math inline">\(cameraDirection = (cameraPos - cameraTarget).normalize\)</span>，叉乘相机上向量和相机 z 轴正向向量可得到相机坐标系 x 轴正向向量 <span class="math inline">\(cameraRight = top.cross(cameraDirection).normalize\)</span>，最后将相机 z 轴正向向量与 x 轴正向向量叉乘得到 y 轴正向向量 <span class="math inline">\(cameraUp = cameraDirection.cross(cameraRight)\)</span>，如此即可建立完整的相机坐标系，从而得到变换矩阵，即视图矩阵： <span class="math display">\[ M_{view} = \begin{bmatrix} R_x &amp; R_y &amp; R_z &amp; 0 \\ U_x &amp; U_y &amp; U_z &amp; 0 \\ D_x &amp; D_y &amp; D_z &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; 1 \end{bmatrix} \begin{bmatrix} 1 &amp; 0 &amp; 0 &amp; -P_x \\ 0 &amp; 1 &amp; 0 &amp; -P_y \\ 0 &amp; 0 &amp; 1 &amp; -P_z \\ 0 &amp; 0 &amp; 0 &amp; 1 \end{bmatrix} \]</span> 其中 <span class="math inline">\(R\)</span> 是相机 x 轴正向向量，<span class="math inline">\(U\)</span> 是相机 y 轴正向向量，<span class="math inline">\(D\)</span> 是相机 z 轴正向向量， <span class="math inline">\(P\)</span> 是相机位置向量。</p><h3 id="投影矩阵">投影矩阵</h3><p>　　投影矩阵描述的是摄像机前的可视区域（Frustum），根据可视区域的形状可分为正射投影（Orthographic Projection）和透视投影（Perspective Projection）。</p><p><img src="https://learnopengl-cn.github.io/img/01/08/orthographic_frustum.png" alt="orthographic projection frustum"> <img src="https://learnopengl-cn.github.io/img/01/08/perspective_frustum.png" alt="perspective_frustum"></p><p>　　对于这两种投影，都有远（far）近（near）参数，不同的是，正射投影是个立方体，所以有左（left）右（right）上（top）下（bottom）四个参数，而透视投影是个类梯形台，所以还有垂直方向视野（Field of View，fov），以及一个宽高比（aspect）两个参数。远近两个参数决定摄像机能看到多近和多远的物体，太近和太远都会看不见，一般可设 near = 0.1，far = 1000；若渲染视窗（viewport）宽为 W，高为 H，则一般 <span class="math inline">\(left=-W/2, right=W/2, top=H/2, bottom=-H/2\)</span> ；透视投影的 fov 是角度，一般设为 45.0，而 <span class="math inline">\(aspect = W/H\)</span> 。这两种投影的矩阵分别为： <span class="math display">\[ M_{orth} = \begin{bmatrix} \frac{2}{right-left} &amp; 0 &amp; 0 &amp; -\frac{right+left}{right-left} \\ 0 &amp; \frac{2}{top-bottom} &amp; 0 &amp; -\frac{top+bottom}{top-bottom} \\ 0 &amp; 0 &amp; \frac{-2}{far-near} &amp; -\frac{far+near}{far-near} \\ 0 &amp; 0 &amp; 0 &amp; 1 \end{bmatrix} \\ M_{pers} = \begin{bmatrix} \frac{2near}{right-left} &amp; 0 &amp; \frac{right+left}{right-left} &amp; 0 \\ 0 &amp; \frac{2near}{top-bottom} &amp; \frac{top+bottom}{top-bottom} &amp; 0 \\ 0 &amp; 0 &amp; \frac{-(far+near)}{far-near} &amp; \frac{-2far*near}{far-near} \\ 0 &amp; 0 &amp; -1 &amp; 0 \end{bmatrix} \]</span></p><p>　　在 three.js 中，对于透视投影矩阵中 left, right, top, bottom 计算方式为：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="JAVASCRIPT"><div class="code-copy"></div><figure class="highlight hljs javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> top = near * <span class="built_in">Math</span>.tan( _Math.DEG2RAD * <span class="number">0.5</span> * <span class="built_in">this</span>.fov ) / <span class="built_in">this</span>.zoom;</span><br><span class="line"><span class="keyword">let</span> height = <span class="number">2</span> * top;</span><br><span class="line"><span class="keyword">let</span> width = <span class="built_in">this</span>.aspect * height;</span><br><span class="line"><span class="keyword">let</span> left = - <span class="number">0.5</span> * width;</span><br><span class="line"><span class="keyword">let</span> right = left + width;</span><br><span class="line"><span class="keyword">let</span> bottom = top - height;</span><br></pre></td></tr></table></figure></div><p>　　对于透视投影，由于计算出的齐次坐标 w 分量显然不为 1.0，所以必须进行透视除法（x,y,z 各分量分别除以 w），得到真正的 3 维坐标。</p><p>　　正射投影一般用来模拟 2D 空间，透视投影用来模拟 3D 空间，当透视投影 near 和 far 设置的相差太大时，很容易引发 z-fighting 现象，原因是离近平面越远时，计算出的深度精度越低，three.js 中为解决这一问题，引入了一个 logarithmicDepthBuffer 参数来决定是否开启使用对数函数优化深度计算，具体可看源码中的 logdepthbuf_vertex.glsl.js 和 logdepthbuf_fragment.glsl.js 文件，开启该参数会造成渲染性能下降。</p><h3 id="小结">小结</h3><p>　　<span class="math inline">\(M_{mvp} = M_{projection}M_{view}M_{model}\)</span>，一个局部坐标 <span class="math inline">\(V_{local}\)</span> 在经过 MVP 矩阵变换之后可得到裁剪坐标 <span class="math inline">\(V_{clip} = M_{mvp}V_{local}\)</span> ，在 OpenGL 中，<span class="math inline">\(V_{clip}\)</span> 会被赋值到顶点着色器中的 <code>gl_Position</code>，并且 OpenGL 会自动进行透视除法和裁剪。</p><p>　　3 维中的相机一般可分为两种，第一人称相机（常规 FPS 游戏）和第三人称相机（常规 ARPG 游戏），第一人称相机的特点是灵活，相机往往可以任意改变位置和朝向，所以会对某些人造成一种 “晕 3D” 的现象，而第三人称相机虽然可以改变相机朝向点和位置，但当朝向点和到朝向点的距离一旦固定，则相机只能沿着以朝向点为球心，以到朝向点的距离为半径的球面上运动，这两种相机一般看具体业务需求进行选择。</p><p>　　缩放操作是很常规的一种操作，镜头拉近代表放大，拉远代表缩小。在使用透视投影的 3 维场景中，只需要改变相机到朝向点的距离即可简单实现缩放操作，而在使用正射投影的场景中，改变距离并不能实现缩放，而是需要改变 左右上下 四个参数，所以在相机中往往会在引入一个 zoom 的参数，用 左右上下 四个参数分别除以 zoom 得到真正的 左右上下，从而改变 zoom，就可以改变相机参数，进而实现正射投影的缩放。</p><h2 id="管线篇">管线篇</h2><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="processonSvg1000" viewBox="-14.0 -19.5 759.0 557.625" width="600" height="500"><defs id="ProcessOnDefs1001"><marker id="ProcessOnMarker1009" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1010" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1017" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1018" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1025" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1026" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1038" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1039" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1047" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1048" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1055" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1056" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1063" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1064" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1071" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1072" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1083" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1084" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1089" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1090" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1105" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1106" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1116" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1117" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1122" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1123" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker><marker id="ProcessOnMarker1138" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1139" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"></path></marker></defs><g id="ProcessOnG1002"><path id="ProcessOnPath1003" d="M-14.0 -19.5H745.0V538.125H-14.0V-19.5Z" fill="none"></path><g id="ProcessOnG1004"><g id="ProcessOnG1005" transform="matrix(1.0,0.0,0.0,1.0,6.0,122.0)" opacity="1.0"><path id="ProcessOnPath1006" d="M0.0 39.5C0.0 -13.166666666666666 84.0 -13.166666666666666 84.0 39.5C84.0 92.16666666666667 0.0 92.16666666666667 0.0 39.5Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path></g><g id="ProcessOnG1007"><path id="ProcessOnPath1008" d="M90.0 161.5L137.3829796415478 161.5" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1009)"></path></g><g id="ProcessOnG1011" transform="matrix(1.0,0.0,0.0,1.0,152.6190476190476,126.5)" opacity="1.0"><path id="ProcessOnPath1012" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1013" transform="matrix(1.0,0.0,0.0,1.0,10.0,25.0)"><text id="ProcessOnText1014" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="16" x="39.0" y="16.4">顶点着色器</text></g></g><g id="ProcessOnG1015"><path id="ProcessOnPath1016" d="M252.6190476190476 161.5L263.7639320225002 161.5" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1017)"></path></g><g id="ProcessOnG1019" transform="matrix(1.0,0.0,0.0,1.0,279.0,126.5)" opacity="1.0"><path id="ProcessOnPath1020" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1021" transform="matrix(1.0,0.0,0.0,1.0,10.0,25.0)"><text id="ProcessOnText1022" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="16" x="39.0" y="16.4">图元装配</text></g></g><g id="ProcessOnG1023"><path id="ProcessOnPath1024" d="M379.0 161.5L413.7639320225002 161.5" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1025)"></path></g><g id="ProcessOnG1027" transform="matrix(1.0,0.0,0.0,1.0,429.0,126.5)" opacity="1.0"><path id="ProcessOnPath1028" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1029" transform="matrix(1.0,0.0,0.0,1.0,10.0,25.0)"><text id="ProcessOnText1030" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="16" x="39.0" y="16.4">光栅器</text></g></g><g id="ProcessOnG1031" transform="matrix(1.0,0.0,0.0,1.0,24.5,150.0)" opacity="1.0"><path id="ProcessOnPath1032" d="M0.0 0.0L47.0 0.0L47.0 23.0L0.0 23.0Z" stroke="#999" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1033" transform="matrix(1.0,0.0,0.0,1.0,0.0,-7.25)"><text id="ProcessOnText1034" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="22.5" y="15.375">顶点</text><text id="ProcessOnText1035" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="22.5" y="34.125">缓冲区</text></g></g><g id="ProcessOnG1036"><path id="ProcessOnPath1037" d="M529.0 161.5L548.5 161.5L548.5 161.5L552.7639320225002 161.5" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1038)"></path></g><g id="ProcessOnG1040" transform="matrix(1.0,0.0,0.0,1.0,568.0,126.5)" opacity="1.0"><path id="ProcessOnPath1041" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1042" transform="matrix(1.0,0.0,0.0,1.0,10.0,15.0)"><text id="ProcessOnText1043" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="微软雅黑" text-anchor="middle" font-size="16" x="39.0" y="16.4">片元着色</text><text id="ProcessOnText1044" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="微软雅黑" text-anchor="middle" font-size="16" x="39.0" y="36.4">器</text></g></g><g id="ProcessOnG1045"><path id="ProcessOnPath1046" d="M668.0 161.5L725.0 161.5L725.0 271.8354430379747L710.2360679774998 271.8354430379747" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1047)"></path></g><g id="ProcessOnG1049" transform="matrix(1.0,0.0,0.0,1.0,595.0,236.8354430379747)" opacity="1.0"><path id="ProcessOnPath1050" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1051" transform="matrix(1.0,0.0,0.0,1.0,10.0,25.0)"><text id="ProcessOnText1052" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="微软雅黑" text-anchor="middle" font-size="16" x="39.0" y="16.4">归属测试</text></g></g><g id="ProcessOnG1053"><path id="ProcessOnPath1054" d="M595.0 271.8354430379747L556.0 271.8354430379747L556.0 271.8354430379747L532.2360679774998 271.8354430379747" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1055)"></path></g><g id="ProcessOnG1057" transform="matrix(1.0,0.0,0.0,1.0,417.0,236.8354430379747)" opacity="1.0"><path id="ProcessOnPath1058" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1059" transform="matrix(1.0,0.0,0.0,1.0,10.0,25.0)"><text id="ProcessOnText1060" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="微软雅黑" text-anchor="middle" font-size="16" x="39.0" y="16.4">模板测试</text></g></g><g id="ProcessOnG1061"><path id="ProcessOnPath1062" d="M417.0 271.8354430379747L378.5 271.8354430379747L378.5 271.8354430379747L355.2360679774998 271.8354430379747" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1063)"></path></g><g id="ProcessOnG1065" transform="matrix(1.0,0.0,0.0,1.0,240.0,236.8354430379747)" opacity="1.0"><path id="ProcessOnPath1066" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1067" transform="matrix(1.0,0.0,0.0,1.0,10.0,25.0)"><text id="ProcessOnText1068" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="微软雅黑" text-anchor="middle" font-size="16" x="39.0" y="16.4">深度测试</text></g></g><g id="ProcessOnG1069"><path id="ProcessOnPath1070" d="M240.0 271.8354430379747L207.0 271.8354430379747L207.0 271.8354430379747L189.2360679774998 271.8354430379747" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1071)"></path></g><g id="ProcessOnG1073" transform="matrix(1.0,0.0,0.0,1.0,74.0,236.8354430379747)" opacity="1.0"><path id="ProcessOnPath1074" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1075" transform="matrix(1.0,0.0,0.0,1.0,10.0,25.0)"><text id="ProcessOnText1076" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="微软雅黑" text-anchor="middle" font-size="16" x="39.0" y="16.4">融合</text></g></g><g id="ProcessOnG1077" transform="matrix(1.0,0.0,0.0,1.0,74.0,444.25)" opacity="1.0"><path id="ProcessOnPath1078" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1079" transform="matrix(1.0,0.0,0.0,1.0,10.0,25.0)"><text id="ProcessOnText1080" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="微软雅黑" text-anchor="middle" font-size="16" x="39.0" y="16.4">抖动</text></g></g><g id="ProcessOnG1081"><path id="ProcessOnPath1082" d="M74.0 271.8354430379747L20.0 271.8354430379747L20.0 479.25L58.763932022500214 479.25" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1083)"></path></g><g id="ProcessOnG1085" transform="matrix(1.0,0.0,0.0,1.0,250.05952380952385,440.375)" opacity="1.0"><path id="ProcessOnPath1086" d="M0.0 38.875C0.0 -12.958333333333334 79.88095238095235 -12.958333333333334 79.88095238095235 38.875C79.88095238095235 90.70833333333333 0.0 90.70833333333333 0.0 38.875Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path></g><g id="ProcessOnG1087"><path id="ProcessOnPath1088" d="M174.0 479.25L212.02976190476193 479.25L212.02976190476193 479.25L234.82345583202405 479.25" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1089)"></path></g><g id="ProcessOnG1091" transform="matrix(1.0,0.0,0.0,1.0,268.73809523809524,467.75)" opacity="1.0"><path id="ProcessOnPath1092" d="M0.0 0.0L47.0 0.0L47.0 23.0L0.0 23.0Z" stroke="#999" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1093" transform="matrix(1.0,0.0,0.0,1.0,0.0,-7.25)"><text id="ProcessOnText1094" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="22.5" y="15.375">颜色</text><text id="ProcessOnText1095" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="22.5" y="34.125">缓冲区</text></g></g><g id="ProcessOnG1096" transform="matrix(1.0,0.0,0.0,1.0,624.0,3.500000000000014)" opacity="1.0"><path id="ProcessOnPath1097" d="M0.0 38.49999999999999C0.0 -12.83333333333333 82.0 -12.83333333333333 82.0 38.49999999999999C82.0 89.83333333333331 0.0 89.83333333333331 0.0 38.49999999999999Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path></g><g id="ProcessOnG1098" transform="matrix(1.0,0.0,0.0,1.0,639.2619047619048,30.16455696202533)" opacity="1.0"><path id="ProcessOnPath1099" d="M0.0 0.0L51.476190476190474 0.0L51.476190476190474 25.32911392405063L0.0 25.32911392405063Z" stroke="#999" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1100" transform="matrix(1.0,0.0,0.0,1.0,0.0,-6.085443037974684)"><text id="ProcessOnText1101" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="24.738095238095237" y="15.375">纹理</text><text id="ProcessOnText1102" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="24.738095238095237" y="34.125">缓冲区</text></g></g><g id="ProcessOnG1103"><path id="ProcessOnPath1104" d="M665.0 80.5L665.0 103.5L618.0 103.5L618.0 111.26393202250021" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1105)"></path></g><g id="ProcessOnG1107" transform="matrix(1.0,0.0,0.0,1.0,252.6190476190476,346.0)" opacity="1.0"><path id="ProcessOnPath1108" d="M0.0 37.0C0.0 -12.333333333333334 74.76190476190476 -12.333333333333334 74.76190476190476 37.0C74.76190476190476 86.33333333333333 0.0 86.33333333333333 0.0 37.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path></g><g id="ProcessOnG1109" transform="matrix(1.0,0.0,0.0,1.0,264.26190476190476,370.33544303797464)" opacity="1.0"><path id="ProcessOnPath1110" d="M0.0 0.0L51.476190476190474 0.0L51.476190476190474 25.32911392405063L0.0 25.32911392405063Z" stroke="#999" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1111" transform="matrix(1.0,0.0,0.0,1.0,0.0,-6.085443037974684)"><text id="ProcessOnText1112" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="24.738095238095237" y="15.375">深度</text><text id="ProcessOnText1113" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="24.738095238095237" y="34.125">缓冲区</text></g></g><g id="ProcessOnG1114"><path id="ProcessOnPath1115" d="M290.0 306.8354430379747L290.0 326.4177215189874L289.99999999999994 326.4177215189874L289.99999999999994 330.7639320225002" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1116)"></path></g><g id="ProcessOnG1118" transform="matrix(1.0,0.0,0.0,1.0,78.0,25.0)" opacity="1.0"><path id="ProcessOnPath1119" d="M0.0 39.5C0.0 -13.166666666666666 84.0 -13.166666666666666 84.0 39.5C84.0 92.16666666666667 0.0 92.16666666666667 0.0 39.5Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path></g><g id="ProcessOnG1120"><path id="ProcessOnPath1121" d="M120.0 104.0L120.0 161.5L137.3829796415478 161.5" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1122)"></path></g><g id="ProcessOnG1124" transform="matrix(1.0,0.0,0.0,1.0,78.75,48.5)" opacity="1.0"><path id="ProcessOnPath1125" d="M0.0 0.0L82.5 0.0L82.5 32.0L0.0 32.0Z" stroke="#999" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1126" transform="matrix(1.0,0.0,0.0,1.0,0.0,-2.75)"><text id="ProcessOnText1127" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="40.25" y="15.375">uniform</text><text id="ProcessOnText1128" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="40.25" y="34.125">数据</text></g></g><g id="ProcessOnG1129" transform="matrix(1.0,0.0,0.0,1.0,529.0,0.5)" opacity="1.0"><path id="ProcessOnPath1130" d="M0.0 40.0C0.0 -13.333333333333334 82.0 -13.333333333333334 82.0 40.0C82.0 93.33333333333333 0.0 93.33333333333333 0.0 40.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"></path></g><g id="ProcessOnG1131" transform="matrix(1.0,0.0,0.0,1.0,529.75,26.829113924050645)" opacity="1.0"><path id="ProcessOnPath1132" d="M0.0 0.0L82.5 0.0L82.5 32.0L0.0 32.0Z" stroke="#999" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"></path><g id="ProcessOnG1133" transform="matrix(1.0,0.0,0.0,1.0,0.0,-2.75)"><text id="ProcessOnText1134" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="40.25" y="15.375">uniform</text><text id="ProcessOnText1135" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="40.25" y="34.125">数据</text></g></g><g id="ProcessOnG1136"><path id="ProcessOnPath1137" d="M570.0 80.5L570.0 103.5L618.0 103.5L618.0 111.26393202250021" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1138)"></path></g></g></g></svg><p>　　渲染管线，图形学中最重要的概念之一，既然称之为管线，自然有像流水线一样的步骤，各个步骤具体做的事情如下：</p><ol type="1"><li>顶点着色器：负责将顶点数据进行坐标变换，该着色器中一般存在 MVP 矩阵，负责将三维坐标变换为二维坐标，该阶段也可以优化每个点的深度值，以便管线后续进行深度测试，也可以利用光照简单优化每个顶点的颜色；</li><li>图元装配：将输入的顶点数据进行组装，形成图元，常见的图元包括：点(GL_POINTS)、线(GL_LINES)、线条(GL_LINE_STRIP)、三角面(GL_TRIANGLES)，在该过程中，一般 GPU 会做一些裁剪和背面剔除等操作，以减少图元的数量，同时完成透视除法以进行屏幕映射；</li><li>光栅化：负责计算每个图元到屏幕像素点的映射。光栅化会计算每个图元所覆盖的片元，同时利用顶点属性插值计算每个片元的属性，片元可认为是候选像素，经过后续管线阶段即可变为真正的像素。</li><li>片元着色器：将光栅化得到的片元进行颜色计算。图形学中几乎所有的高级特效都会在这一步完成，光照计算，阴影处理，纹理，材质，统统在这一步进行处理；</li><li>归属测试：即测试片元所在位置是否位于当前上下文视窗内，若一个显示帧缓冲区视窗被另一个视窗所遮蔽，则剔除该部分片元。</li><li>模板测试：即测试片元是否满足一定条件（可大于或小于某个值等），若测试不满足，则剔除该该片元， OpenGL 可自行选择开启或关闭模板测试。</li><li>深度测试：用来测试片元的远近，远的片元被遮挡。在深度测试，若两片元深度值接近，则可能会引起 Z-fighting 现象，即像素闪烁，这是因为此时 GPU 无法确定该剔除哪个片元，导致这一帧可能绘制这个片元，下一帧绘制另一个片元。若开启 Alpha 测试，即启用透明度，则会在下一阶段进行 Alpha 混合，从而达到透明效果。</li><li>混合：将新生成的片元颜色和帧缓冲区中对应位置的颜色进行混合，得到像素颜色。</li><li>抖动：一种以牺牲分辨率为代价来增加颜色表示范围技术，从视觉效果上来看就是颜色过度更平滑。</li></ol><p>　　以上这些阶段中，能完全被编程控制的也就顶点着色器和片元着色器两个阶段，其余阶段要么完全无法控制，要么只能通过已有的参数进行设置，当然也可以通过顶点着色器和片元着色器影响余下阶段，顶点着色器和片元着色器也统称 Shader 编程。</p><p>　　有时候为了做更好看的特效，需要进行多次渲染，将上一次渲染的结果作为下一次渲染的输入，此时可以将颜色缓冲区作为一张纹理，并构造新的帧缓冲区，将该纹理作为输入，重新放进渲染管线中，这种操作方式也叫后期处理（Post Processing），虽然好看，但对 GPU 的负载很大，需要合理使用。</p><p>　　对于渲染管线，Shaun 的理解也就到此为止了，非常粗浅，Shader 也只是刚入门的水平，Shaun 在图形学方面做的更多是降低 Draw-Call 和 CPU 层面的 Tessellation，以及 Geometry 上的事，对纹理材质颜色光照阴影等方面涉及的较少。</p><h2 id="后记">后记</h2><p>　　虽然目前 OpenGL 已停止更新，但学习图形学编程，OpenGL 总是绕不过去（至少暂时以及未来很长一段时间都会是这样），而且图形学基础知识本质都是相同的，不管是 DirectX 还是 Vulkan，变的只是写法形式而已，数学知识总是在那里，两种 shader 也同样需要，所以了解这些东西还是有必要的。</p><h2 id="附录">附录</h2><h3 id="二维图像的图像透视投影变换">二维图像的图像透视投影变换</h3><p>　　图像的透视投影变换常用于图像的矫正，OpenCV 中就有现成的 api（getPerspectiveTransform 和 warpPerspective），用于将不规整的四边形区域变换为规整的矩形区域。其基本的数学原理为，先构造一个投影变换等式： <span class="math display">\[ \begin{bmatrix} XW \\ YW \\ W \end{bmatrix} = \begin{bmatrix} a &amp; b &amp; c \\ d &amp; e &amp; f \\ g &amp; h &amp; 1 \end{bmatrix} \begin{bmatrix} x \\ y \\ 1 \end{bmatrix} \]</span> 设四边形中四个点分别为 <span class="math inline">\((X_1, Y_1),(X_2, Y_2),(X_3, Y_3),(X_4, Y_4)\)</span> ，对应矩形中四个点为 <span class="math inline">\((x_1, y_1),(x_2, y_2),(x_3, y_3),(x_4, y_4)\)</span>。则可构造齐次线性方程组： <span class="math display">\[ \begin{bmatrix} x_1 &amp; y_1 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; -X_1x_1 &amp; -X_1y_1 \\ 0 &amp; 0 &amp; 0 &amp; x_1 &amp; y_1 &amp; 1 &amp; -Y_1x_1 &amp; -Y_1y_1 \\ x_2 &amp; y_2 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; -X_2x_2 &amp; -X_2y_2 \\ 0 &amp; 0 &amp; 0 &amp; x_2 &amp; y_2 &amp; 1 &amp; -Y_2x_2 &amp; -Y_2y_2 \\ \vdots &amp; \vdots &amp; \vdots &amp; \vdots &amp; \vdots &amp; \vdots &amp; \vdots &amp; \vdots \\ x_n &amp; y_n &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; -X_nx_n &amp; -X_ny_n \\ 0 &amp; 0 &amp; 0 &amp; x_n &amp; y_n &amp; 1 &amp; -Y_nx_n &amp; -Y_ny_n \end{bmatrix} \begin{bmatrix} a \\ b \\ c \\ d \\ e \\ f \\ g \\ h \end{bmatrix} = \begin{bmatrix} X_1 \\ Y_1 \\ X_2 \\ Y_2 \\ \vdots \\ X_n \\ Y_n \end{bmatrix} \]</span> 解这个方程组得到 abcdefg ，使用上面的投影变换等式可计算 <span class="math inline">\(X = XW / W, Y = YW / W\)</span> ，从而使用插值得到规整矩形图形的各个像素值。</p><h3 id="shader-学习资料">Shader 学习资料</h3><p>shader 入门书：https://thebookofshaders.com，在线编写 shader ：https://thebookofshaders.com/edit.php</p><p>glslsandbox 网站：http://glslsandbox.com/</p><p>shadertoy 网站：https://www.shadertoy.com/</p><h2 id="参考资料">参考资料</h2><p>[1] <a target="_blank" rel="noopener" href="https://learnopengl-cn.github.io/01%20Getting%20started/08%20Coordinate%20Systems/">坐标系统</a>（https://learnopengl-cn.github.io）</p><p>[2] <a target="_blank" rel="noopener" href="http://www.yanhuangxueyuan.com/webgl_course/hardware.html">WebGL图形系统、渲染管线_郭隆邦技术博客</a></p><p>[3] <a target="_blank" rel="noopener" href="http://www.songho.ca/opengl/gl_projectionmatrix.html">OpenGL Projection Matrix</a></p><p>[4] <a target="_blank" rel="noopener" href="https://www.cnblogs.com/dojo-lzz/p/11250327.html">WebGL着色器32位浮点数精度损失问题</a></p><p>[5] <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/3190483/transform-quadrilateral-into-a-rectangle">Transform quadrilateral into a rectangle?</a></p></div><div class="article-content-more"><button type="button" class="article-more--link"><i class="fa fa-angle-double-down fa-3x" aria-hidden="true"></i></button></div></section></article><nav id="pagination--nav" class="text-center"><span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/2/">Next &gt;&gt;</a></nav></main><div id="site-tool"><div class="scroll"><a href="#header"><i class="fa fa-arrow-up"></i></a> <a href="#footer"><i class="fa fa-arrow-down"></i></a></div><div></div></div><aside id="right-col" class="col-lg-3 col-sm-12"><div id="sidebar-sticky--bottom"></div><div id="sidebar"><header class="author-info div-border"><a href="/"><img class="header-avatar" src="/img/avatar.jpg"></a><h1 class="header-author"><a href="/" title="Hi Mate" data-toggle="tooltip">Shaun</a></h1><p class="header-slogan">求知！ 视界！ 未来！ ↖(^ω^)↗</p><div class="social-info"><a class="social-icon" target="_blank" href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=qNvAyd3G0d3JxujOx9DFycHEhsvHxQ" title="envelope" data-toggle="tooltip"><i class="fa fa-envelope" aria-hidden="true"></i> </a><a class="social-icon" target="_blank" href="https://github.com/cniter" title="github" data-toggle="tooltip"><i class="fa fa-github" aria-hidden="true"></i> </a><a class="social-icon" target="_blank" href="/atom.xml" title="rss" data-toggle="tooltip"><i class="fa fa-rss" aria-hidden="true"></i> </a><a class="social-icon" target="_blank" href="http://sighttp.qq.com/authd?IDKEY=4faf682653b3b7f5f47b9cb6d2bb8b81de8fa7a8fb8cee12" title="qq" data-toggle="tooltip"><i class="fa fa-qq" aria-hidden="true"></i></a></div></header><div class="search div-border" title="搜索" data-toggle="tooltip"><form id="search-form"><input type="text" id="local-search--input" name="q" results="0" placeholder=" Search..." autocomplete="off" autocorrect="off"> <i class="fa fa-times" onclick="resetSearch()"></i></form><div id="local-search--result"></div><p class="no-result">No results found</p></div><div id="tagcloud" class="tagcanvas div-border" title="标签" data-toggle="tooltip"><canvas width="200" height="200" id="tagcloud-canvas"><p>Anything in here will be replaced on browsers that support the canvas element</p><ul><li><a href="/tags/algorithm/" data-weight="7">algorithm</a></li><li><a href="/tags/android/" data-weight="2">android</a></li><li><a href="/tags/bigdata/" data-weight="2">bigdata</a></li><li><a href="/tags/c-cpp/" data-weight="6">c/cpp</a></li><li><a href="/tags/clustering/" data-weight="1">clustering</a></li><li><a href="/tags/container/" data-weight="1">container</a></li><li><a href="/tags/css/" data-weight="1">css</a></li><li><a href="/tags/cv/" data-weight="5">cv</a></li><li><a href="/tags/devtool/" data-weight="1">devtool</a></li><li><a href="/tags/ffmpeg/" data-weight="1">ffmpeg</a></li><li><a href="/tags/geomesa/" data-weight="1">geomesa</a></li><li><a href="/tags/geometry/" data-weight="4">geometry</a></li><li><a href="/tags/gfw/" data-weight="1">gfw</a></li><li><a href="/tags/github/" data-weight="1">github</a></li><li><a href="/tags/gl/" data-weight="1">gl</a></li><li><a href="/tags/golang/" data-weight="2">golang</a></li><li><a href="/tags/hexo/" data-weight="8">hexo</a></li><li><a href="/tags/http/" data-weight="1">http</a></li><li><a href="/tags/integration/" data-weight="1">integration</a></li><li><a href="/tags/java/" data-weight="2">java</a></li><li><a href="/tags/k8s/" data-weight="1">k8s</a></li><li><a href="/tags/language/" data-weight="3">language</a></li><li><a href="/tags/latex/" data-weight="1">latex</a></li><li><a href="/tags/mapbox/" data-weight="1">mapbox</a></li><li><a href="/tags/markdown/" data-weight="1">markdown</a></li><li><a href="/tags/matlab/" data-weight="2">matlab</a></li><li><a href="/tags/network/" data-weight="1">network</a></li><li><a href="/tags/note/" data-weight="7">note</a></li><li><a href="/tags/numerical/" data-weight="1">numerical</a></li><li><a href="/tags/opencv/" data-weight="11">opencv</a></li><li><a href="/tags/opendrive/" data-weight="1">opendrive</a></li><li><a href="/tags/opengl/" data-weight="1">opengl</a></li><li><a href="/tags/python/" data-weight="1">python</a></li><li><a href="/tags/qt/" data-weight="2">qt</a></li><li><a href="/tags/record/" data-weight="14">record</a></li><li><a href="/tags/search/" data-weight="1">search</a></li><li><a href="/tags/segmentation/" data-weight="2">segmentation</a></li><li><a href="/tags/tensorflow/" data-weight="1">tensorflow</a></li><li><a href="/tags/thought/" data-weight="3">thought</a></li><li><a href="/tags/unix-like/" data-weight="3">unix-like</a></li><li><a href="/tags/vscode/" data-weight="1">vscode</a></li></ul></canvas><script src="/plugins/TagCanvas/jquery.tagcanvas.min.js" type="text/javascript"></script><script type="text/javascript">$(document).ready((function(){$("#tagcloud-canvas").tagcanvas({initial:[.1,-.1],activeCursor:'url("/img/cursor/link.cur"), auto',reverse:!0,depth:.75,weight:!0,weightFrom:"data-weight",weightMode:"both",weightSizeMin:15,weightSizeMax:50})||$("#tagcloud").hide()}))</script></div><div class="friends div-border" title="友链" data-toggle="tooltip"><a target="_blank" class="friends-link" href="https://cniter.github.io">Shaun&#39;s Space</a></div><div class="revolvermaps div-border" title="访客" data-toggle="tooltip"><script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=50om5cdoa3h&amp;m=7&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=49" defer></script></div></div><div class="toc-card"><div class="toc-card--head"><i class="fa fa-angle-up" aria-hidden="true"></i></div><div id="toc" class="toc-card--content"><strong class="toc-title">文章列表</strong><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/posts/36b343ff.html">HTTP 超时浅见</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/6be57d7f.html">关于中学的学习方法</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/2eb69b33.html">记一次资源不释放的问题</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/dbbe01e5.html">社畜三年，风雨兼程</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/8e1d1e1d.html">2021 年小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/4b1f50ff.html">M1 个人配置</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/9c9b4035.html">Scala 多线程编程小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/720275bd.html">Google S2 Geometry 浅解</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/55e674ff.html">K8S 应用开发指北</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/81321445.html">OpenGL坐标系统与渲染管线</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/8d3d87a2.html">Scala 学习小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/28416d7c.html">2020年小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/b59e3e7b.html">Linux服务器运维文档</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/489fa7b3.html">时空查询之ECQL</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/9978824c.html">GeoMesa踩坑指北</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/3692cd6.html">IDEA使用Docker环境开发调试</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/af5e9ace.html">大数据环境搭建笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/ae780057.html">设计模式浅谈</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/eee1c041.html">积分计算</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/a5661762.html">Geometry增量更新</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/e225d8fd.html">Mapbox显示GeoServer地图</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/3d8ab974.html">Docker使用小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/6694a214.html">空间中三角形与三角形相交</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/5315fcfd.html">计算几何基础</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/b7d79231.html">OpenDrive解析小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/39a3c99e.html">一张纹理做天空盒</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/a250bb21.html">Windows Terminal 尝鲜小记</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/ae5f9dce.html">读大学</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/cf97ba7c.html">2019，既是结束又是开始</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/ff29de94.html">快速判断三角形与长方体相交</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/70a807da.html">网页菜单纯 css 实现</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/abe58f8c.html">个人游记</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/26d437be.html">hexo-theme-chi主题更新小记</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/3578e309.html">［译］为什么深度学习没有取代传统的计算机视觉</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/37b89a23.html">再也不见，18年</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/ac4679b5.html">hexo-theme-chi主题开发小记</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/64889158.html">Matlab和OpenCV混合编程小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/be7949e4.html">Android实践小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/fc1165b7.html">C++数组中的坑</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/cafdd60d.html">Android开发环境配置</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/27a4c8b6.html">Windows实用技巧</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/6315717b.html">FFmpeg提取与合并命令使用小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/fd823bf9.html">解决VSCode使用Cmder作为默认终端问题</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/fddd1e17.html">图割算法之NCuts浅见</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/c42ff8d4.html">图割算法之Graph Cuts浅见</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/b93d943b.html">C++中static用法小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/8fb9f004.html">斐波那契数列的三种写法</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/bcdf334e.html">LaTex语法指北</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/982ff584.html">搜索技巧</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/7cebf0ee.html">17年走了，18年来了</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/e124baa1.html">矩阵的应用之图像仿射变换</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/aef52be2.html">本人常用小工具安利</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/376168c6.html">解决无法打开某个网页问题</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/5f54aa2c.html">PyQt5使用小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/82d3b275.html">TensorFlow Object Detection API使用小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/2a3d46b0.html">C语言中整型提升问题</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/dece8eba.html">TXT数据转OpenCV中的Mat数据</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/e8b35736.html">OpenCV中滑动条和鼠标事件响应操作的使用小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/b6fb6109.html">利用回调函数计算函数运行时间</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/df943c4f.html">论如何科学的上网</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/b1e9411b.html">Hexo的SPFK主题修改小记</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/22c3daf1.html">解决Qt中Qlabel显示OpenCV的Mat数据图像产生扭曲现象问题</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/509ee93b.html">解决OpenCV-2.4.11调用摄像头显示拍摄视频出错问题</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/3bc0decc.html">Hexo添加各种小部件</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/fd0f8195.html">OpenCV中显著性检测算法的使用</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/35132cb7.html">OpenCV中Selective Search算法的使用</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/170c76cc.html">别了，漆黑的象牙塔</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/c3f26b1.html">Win10以树形结构显示文件目录结构</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/68065b99.html">ACGN作品个人印象简评</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/4f6225b7.html">Hexo添加站内本地搜索</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/302a6244.html">用OpenCV显示OpenGL图形</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/7df528b4.html">Win10＋VS2013＋CMake-gui编译和配置OpenCV-3.2.0</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/17017530.html">MyThoughts</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/7d5bc07b.html">解决写上篇文档“Hexo+GitHub搭建个人博客”遇到的问题</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/d7965b48.html">Hexo+GitHub搭建个人博客</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/4a17b156.html">Hello World</a></li></ul></div></div></aside></div></div><span id="cursor-trail"></span> <span class="click-halo"></span><footer id="footer" class="text-center"><div class="copyright-info">&copy; 2017 - 2024 <a href="/">Shaun</a></div><span class="site-visitor"><i class="fa fa-user-o" aria-hidden="true"></i> <span id="busuanzi_value_site_uv"><i class="fa fa-spinner fa-spin"></i></span> &nbsp;|&nbsp; <i class="fa fa-eye" aria-hidden="true"></i> <span id="busuanzi_value_site_pv"><i class="fa fa-spinner fa-spin"></i></span> &nbsp;|&nbsp; <i class="fa fa-hand-o-up" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span></span><div class="site-info"><a href="http://hexo.io/" target="_blank">Hexo </a>theme <a href="https://github.com/cniter/hexo-theme-chi" target="_blank">Chi </a>by <a href="https://github.com/cniter" target="_blank">Shaun</a></div></footer><script type="text/javascript" async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML" integrity="sha256-WUED7NFzpsmHtLO7bswSz4JSfkhE+cD4ncKeOznwFSY=" crossorigin="anonymous"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }

        , TeX: {
            extensions: ["extpfeil.js"]
        }
    });
    
    MathJax.Hub.Queue(function() {
        let all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';                 
        }       
    });</script><script type="text/javascript">const MutationObserver=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver,config={attributes:!0,childList:!0,characterData:!0};let target=document.querySelector("#local-search--result"),$local_search_result=$("#local-search--result"),$no_result=$(".no-result"),observer=new MutationObserver((function(e){e.forEach((function(e){$local_search_result.text()||""==$local_search_result.html()?$no_result.hide():$no_result.show(200)}))})),inputArea=document.querySelector("#local-search--input"),getSearchFile=function(){let e="search.xml";0==e.length&&(e="search.xml"),searchFunc("/"+e,"local-search--input","local-search--result"),observer.observe(target,config)};inputArea.onfocus=function(){getSearchFile()};let $resetButton=$("#search-form .fa-times"),$resultArea=$("#local-search--result");inputArea.oninput=function(){$resetButton.show()};let resetSearch=function(){$resultArea.html(""),document.querySelector("#search-form").reset(),$resetButton.hide(),$no_result.hide(),observer.disconnect()};inputArea.onkeydown=function(e){if(13==e.keyCode)return!1};let searchFunc=function(e,t,r){"use strict";$.ajax({url:e,dataType:"xml",success:function(e){let n=$("entry",e).map((function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}})).get(),l=document.getElementById(t),s=document.getElementById(r);l.addEventListener("input",(function(){let e='<ul class="search-result--list">',t=this.value.trim().toLowerCase().split(/[\s\-]+/);s.innerHTML="",this.value.trim().length<=0||(n.forEach((function(r){let n=!0,l=r.title.trim().toLowerCase(),s=r.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),c=r.url,o=-1,a=-1,u=-1;if(""!=l&&""!=s&&t.forEach((function(e,t){o=l.indexOf(e),a=s.indexOf(e),o<0&&a<0?n=!1:(a<0&&(a=0),0==t&&(u=a))})),n){e+="<li><a href='"+c+"' class='search-result--title' target='_blank'>> "+l+"</a>";let n=r.content.trim().replace(/<[^>]+>/g,"");if(u>=0){let r=u-6,l=u+6;r<0&&(r=0),0==r&&(l=10),l>n.length&&(l=n.length);let s=n.substr(r,l);t.forEach((function(e){let t=new RegExp(e,"gi");s=s.replace(t,'<em class="search-keyword">'+e+"</em>")})),e+='<p class="search-result">'+s+"...</p>"}}})),s.innerHTML=e)}))}})}</script><script>function loadScript(e,t){let a=document.createElement("script");a.type="text/javascript",a.async=!0,a.readyState?a.onreadystatechange=function(){"loaded"!=a.readyState&&"complete"!=a.readyState||(a.onreadystatechange=null,t())}:a.onload=function(){t()},a.src=e,document.getElementsByTagName("body")[0].appendChild(a)}</script><script type="module" src="/js/main.js"></script><script>$(document).ready((function(){$("del").attr("title","你知道的太多了ヾ(▼ﾍ▼；) (#｀皿´メ)"),$(".toc-card").width($("#right-col").width()),$("a.footnote-ref").each((function(t,e){let i=$(this).parents("article").attr("id"),o=$(this).attr("href");e.setAttribute("data-toggle","tooltip"),e.setAttribute("data-html","true"),e.setAttribute("title",$("#"+i+" "+o).html())})),setInterval(()=>{$("#site-bg").fadeTo(1e3,.1,()=>{$("#site-bg").css("background-image",'url("/img/site-bg/bg-'+Math.floor(8*Math.random())+'.jpg")')}),$("#site-bg").fadeTo(2e3,.2)},3e4),siteBgElem=document.getElementById("site-bg"),siteBgElem&&siteBgElem.clientWidth>0&&siteBgElem.clientHeight>0&&loadScript("/js/widget/canvas-nest.js",()=>{new CanvasNest(siteBgElem,{opacity:1,pointColor:"255,255,0",color:"255,255,0",count:30})})})),$(window).on("load",(function(){$("#sidebar-sticky--bottom").height($("#right-col").height()-$("#sidebar").height()-$("#footer").height())})),$((function(){$("[data-toggle='tooltip']").tooltip()}))</script></body></html>