<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><title>Shaun&#39;s Space</title><meta name="description" content="Shaun之所见所学所想所得"><link rel="icon" href="/img/favicon.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha256-eSi1q2PG6J7g7ib17yAaWMcrr5GrtohYChqibrV7PBE=" crossorigin="anonymous"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fork-awesome/1.1.5/css/fork-awesome.min.css" integrity="sha256-P64qV9gULPHiZTdrS1nM59toStkgjM0dsf5mK/UwBV4=" crossorigin="anonymous"><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><script src="//cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha256-ZvOgfh+ptkpoa2Y4HkRY28ir89u/+VRyDE7sB7hEEcI=" crossorigin="anonymous"></script><script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha256-VsEqElsCHSGmnmHXGQzvoWjWwoznFSZc6hs7ARLRacQ=" crossorigin="anonymous"></script><script src="//cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js" integrity="sha256-EPrkNjGEmCWyazb3A/Epj+W7Qm2pB9vnfXw+X6LImPM=" crossorigin="anonymous"></script><script src="//cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/gitalk/1.7.2/gitalk.min.css" integrity="sha512-0hsIlRjJbiUWaKMhXXNDmjWI2qPvUlhNBLHMhqeF5jIma+bedec27N5FoT2JEeHz5TUmOGCsm1Y89EsX/P0wOg==" crossorigin="anonymous" referrerpolicy="no-referrer"><script src="//cdnjs.cloudflare.com/ajax/libs/gitalk/1.7.2/gitalk.min.js" integrity="sha512-EcTCcXV46teiNwe0VcnM5A038tcY+BaQYO4nW6Gh2i7v4/HjBVg7xx3+JBLl9WofDds//INJAiEGAtdgr8PWyA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><link rel="stylesheet" href="/css/style.css"><style>body{cursor:url(/img/cursor/normal.cur),auto}#navbar-toggler--btn,.highlight-wrap[data-lang]::before,a,button{cursor:url(/img/cursor/link.cur),auto}</style><script>const bdshareURL = "/plugins/baidushare/";</script><script async type="text/javascript" src="/js/live2d/autoload.js"></script></head><body><!--[if lt IE 9]>
        <link rel="stylesheet" href="/css/ie9.css">
        <div class="alert alert-danger topframe" role="alert">
            嘿，朋友！您的浏览器已<strong>过期</strong>，不建议继续食用。
            <a target="_blank" class="alert-link" href="http://browsehappy.com">这里</a> 有些新玩意儿，何不试试？
        </div>
    <![endif]--><header id="header"><nav id="navbar" class="navbar navbar-expand-md"><div class="container"><h1 id="site-title"><a href="/" class="navbar-brand"><img src="/img/favicon.png"> <span>Shaun&#39;s Space</span></a></h1><button id="navbar-toggler--btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsibleNavbar"><span><i class="fa fa-list-ul" aria-hidden="true"></i></span></button><div class="collapse navbar-collapse" id="collapsibleNavbar"><ul class="navbar-nav"><li class="nav-item"><a class="nav-link" href="/" title="首页" data-toggle="tooltip" data-placement="bottom"><i class="nav-icon fa fa-home"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives" title="所有文章" data-toggle="tooltip" data-placement="bottom"><i class="nav-icon fa fa-archive"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories" title="全部分类" data-toggle="tooltip" data-placement="bottom"><i class="nav-icon fa fa-folder"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags" title="全部标签" data-toggle="tooltip" data-placement="bottom"><i class="nav-icon fa fa-tags"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/about" title="关于本站" data-toggle="tooltip" data-placement="bottom"><i class="nav-icon fa fa-user"></i> 关于</a></li></ul></div></div></nav></header><div class="container"><div class="row"><aside id="left-col" class="col-md-1"></aside><main class="col-lg-8 col-sm-12"><article id="post-Google-S2-Geometry-浅解" class="article div-border"><header class="article-header"><span class="article-date article-title--index"><i class="fa fa-calendar" aria-hidden="true"></i> <a href="/posts/720275bd.html"><time datetime="2021-09-19T08:21:58.000Z">2021-09-19</time></a></span><section class="article-title article-title--index"><a href="/posts/720275bd.html">Google S2 Geometry 浅解</a></section><div class="article-label"><div class="article-category label"><i class="fa fa-book" aria-hidden="true"></i> <a class="color3 article-category-link" href="/categories/Mathematics/">Mathematics</a></div><div class="article-tag label"><i class="fa fa-bookmark" aria-hidden="true"></i> <a class="color2 article-tag-link" href="/tags/geometry/">geometry</a></div></div></header><section class="article-content"><div class="article-content--excerpt"><h2 id="前言">前言</h2><p>　　Google S2 Geometry（以下简称 S2） 是 Google 发明的基于单位球的一种地图投影和空间索引算法，该算法可快速进行覆盖以及邻域计算。更多详见 <a href="https://s2geometry.io/" target="_blank" rel="external">S2Geometry</a>，<a href="https://blog.christianperone.com/2015/08/googles-s2-geometry-on-the-sphere-cells-and-hilbert-curve/" target="_blank" rel="external">Google’s S2, geometry on the sphere, cells and Hilbert curve</a>，<a href="https://halfrost.com/go_s2_regioncoverer/" target="_blank" rel="external">halfrost 的空间索引系列文章</a>。虽然使用 S2 已有一年的时间，但确实没有比较系统的看过其源码，这次借着这段空闲时间，将 Shaun 常用的功能系统的看看其具体实现，下文将结合 S2 的 C++，Java，Go 的版本一起看，由于 Java 和 Go 的都算是 C++ 的衍生版，所以以 C++ 为主，捎带写写这三种语言实现上的一些区别，Java 版本时隔 10 年更新了 2.0 版本，喜大普奔。</p></div><div class="article-content--all"><h2 id="前言">前言</h2><p>　　Google S2 Geometry（以下简称 S2） 是 Google 发明的基于单位球的一种地图投影和空间索引算法，该算法可快速进行覆盖以及邻域计算。更多详见 <a href="https://s2geometry.io/" target="_blank" rel="external">S2Geometry</a>，<a href="https://blog.christianperone.com/2015/08/googles-s2-geometry-on-the-sphere-cells-and-hilbert-curve/" target="_blank" rel="external">Google’s S2, geometry on the sphere, cells and Hilbert curve</a>，<a href="https://halfrost.com/go_s2_regioncoverer/" target="_blank" rel="external">halfrost 的空间索引系列文章</a>。虽然使用 S2 已有一年的时间，但确实没有比较系统的看过其源码，这次借着这段空闲时间，将 Shaun 常用的功能系统的看看其具体实现，下文将结合 S2 的 C++，Java，Go 的版本一起看，由于 Java 和 Go 的都算是 C++ 的衍生版，所以以 C++ 为主，捎带写写这三种语言实现上的一些区别，Java 版本时隔 10 年更新了 2.0 版本，喜大普奔。</p><a id="more"></a><h2 id="坐标篇">坐标篇</h2><figure><img src="https://s2geometry.io/devguide/img/s2cell_global.jpg" alt="s2 projection"><figcaption>s2 projection</figcaption></figure><p>　　S2 的投影方式可简单想象为一个单位球外接一个立方体，从球心发出一条射线得到球面上的点到立方体上 6 个面的投影，即将球面投影为立方体，当然中间为了使面积分布更为均匀，还做了些其他坐标变换。</p><h3 id="s2latlng-坐标">S2LatLng 坐标</h3><p>　　首先是经纬度坐标，默认用弧度（Radians）构造，取值范围为经度 [-π，+π]，纬度 [-π/2，+π/2]，当然也可使用 S1Angle 将角度（Degrees）转成弧度来构造。</p><h3 id="s2point-坐标">S2Point 坐标</h3><p>　　然后球面笛卡尔坐标，这是个三维坐标，由 S2LatLng 到 S2Point 相当于将单位球的极坐标表示法转换为笛卡尔坐标表示法，具体公式为 <span class="math inline">\(x=\cos(lat)cos(lng);　y=cos(lat)sin(lng);　z=sin(lat)\)</span>。</p><h3 id="faceuv-坐标">FaceUV 坐标</h3><p>　　这个坐标并没实际的类与其对应，face 指的是立方体的面，值域为 [0,5]，而 uv 坐标是指面上的点，值域为 [-1,1]。首先需要知道 S2Point 会投影到哪个面上，可以知道 S2 的笛卡尔坐标 X 轴正向指向 0 面，Y 轴正向指向 1 面，Z 轴正向指向 2 面，X 轴负向指向 3 面，Y 轴负向指向 4 面，Z 轴负向指向 5 面，所以 S2Point xyz 哪个分量的绝对值最大，就会投影到哪个轴指向的面，若该分量为正值，则取正向指的面，若该分量为负值，则取负向指的面。至于 uv 的计算方式就是直线与平面的交点了，之前的一篇「计算几何基础」中写过，但这里的平面和直线都比较特殊，所以有快速算法，就直接贴 Go 的代码吧：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="GO"><figure class="highlight hljs go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// validFaceXYZToUV given a valid face for the given point r (meaning that</span></div><div class="line"><span class="comment">// dot product of r with the face normal is positive), returns</span></div><div class="line"><span class="comment">// the corresponding u and v values, which may lie outside the range [-1,1].</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">validFaceXYZToUV</span><span class="params">(face <span class="keyword">int</span>, r r3.Vector)</span> <span class="params">(<span class="keyword">float64</span>, <span class="keyword">float64</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">switch</span> face &#123;</div><div class="line">	<span class="keyword">case</span> <span class="number">0</span>:</div><div class="line">		<span class="keyword">return</span> r.Y / r.X, r.Z / r.X</div><div class="line">	<span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">		<span class="keyword">return</span> -r.X / r.Y, r.Z / r.Y</div><div class="line">	<span class="keyword">case</span> <span class="number">2</span>:</div><div class="line">		<span class="keyword">return</span> -r.X / r.Z, -r.Y / r.Z</div><div class="line">	<span class="keyword">case</span> <span class="number">3</span>:</div><div class="line">		<span class="keyword">return</span> r.Z / r.X, r.Y / r.X</div><div class="line">	<span class="keyword">case</span> <span class="number">4</span>:</div><div class="line">		<span class="keyword">return</span> r.Z / r.Y, -r.X / r.Y</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> -r.Y / r.Z, -r.X / r.Z</div><div class="line">&#125;</div></pre></td></tr></table></figure></div><p>　　这里需要注意的是 S2Point xyz 三分量构成的向量与平面法向量的点积必须是正数时 uv 才算正确有效，Go 在计算时没做校验，C++ 和 Java 都有校验，使用时需要注意。</p><h3 id="facest-坐标">FaceST 坐标</h3><p>　　之所以引入 ST 坐标是因为同样的球面面积映射到 UV 坐标面积大小不一，大小差距比较大（离坐标轴越近越小，越远越大），所以再做一次 ST 变换，将面积大的变小，小的变大，使面积更均匀，利于后面在立方体面上取均匀格网（cell）时，每个 cell 对应球面面积差距不大。S2 的 ST 变换有三种：1、线性变换，基本没做任何变形，只是简单将 ST 坐标的值域变换为 [0, 1]，cell 对应面积最大与最小比大约为 5.2；2、二次变换，一种非线性变换，能起到使 ST 空间面积更均匀的作用，cell 对应面积最大与最小比大约为 2.1；3、正切变换，同样能使 ST 空间面积更均匀，且 cell 对应面积最大与最小比大约为 1.4，不过其计算速度相较于二次变换要慢 3 倍，所以 S2 权衡考虑，最终采用了二次变换作为默认的 UV 到 ST 之间的变换。二次变换公式为：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="JAVA"><figure class="highlight hljs java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">stToUV</span><span class="params">(<span class="keyword">double</span> s)</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (s &gt;= <span class="number">0.5</span>) &#123;</div><div class="line">    <span class="keyword">return</span> (<span class="number">1</span> / <span class="number">3</span>.) * (<span class="number">4</span> * s * s - <span class="number">1</span>);</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="keyword">return</span> (<span class="number">1</span> / <span class="number">3</span>.) * (<span class="number">1</span> - <span class="number">4</span> * (<span class="number">1</span> - s) * (<span class="number">1</span> - s));</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">uvToST</span><span class="params">(<span class="keyword">double</span> u)</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (u &gt;= <span class="number">0</span>) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">0.5</span> * Math.sqrt(<span class="number">1</span> + <span class="number">3</span> * u);</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">1</span> - <span class="number">0.5</span> * Math.sqrt(<span class="number">1</span> - <span class="number">3</span> * u);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></div><h3 id="faceij-坐标">FaceIJ 坐标</h3><p>　　IJ 坐标是离散化后的 ST 坐标，将 ST 空间的平面划分为 <span class="math inline">\(2^{30}×2^{30}\)</span> 个网格，取网格所在的横纵坐标得到 IJ 坐标，所以由 ST 到 IJ 坐标的变换就比较简单了：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="JAVA"><figure class="highlight hljs java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">stToIj</span><span class="params">(<span class="keyword">double</span> s)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> Math.max(</div><div class="line">    <span class="number">0</span>, Math.min(<span class="number">1073741824</span> - <span class="number">1</span>, (<span class="keyword">int</span>) Math.round(<span class="number">1073741824</span> * s - <span class="number">0.5</span>))</div><div class="line">  );</div><div class="line">&#125;</div></pre></td></tr></table></figure></div><h3 id="s2cellid">S2CellId</h3><p>　　这个 id 其实是个一维坐标，而是利用希尔伯特空间填充曲线将 IJ 坐标从二维变换为一维，该 id 用一个 64 位整型表示，高 3 位用来表示 face（0~5），后面 61 位来保存不同的 level（0~30） 对应的希尔伯特曲线位置，每增加一个 level 增加两位，后面紧跟一个 1，最后的位数都补 0。<em>注：Java 版本的 id 是有符号 64 位整型，而 C++ 和 Go 的是无符号 64 位整型，所以在跨语言传递 id 的时候，在南极洲所属的最后一个面（即 face = 5）需要小心处理。</em></p><h4 id="hilbertcurve">HilbertCurve</h4><figure><img src="https://upload.wikimedia.org/wikipedia/commons/a/a7/Hilbert_curve_production_rules%21.svg" alt="hilbert_curve_subdivision_rules"><figcaption>hilbert_curve_subdivision_rules</figcaption></figure><figure><img src="https://upload.wikimedia.org/wikipedia/commons/3/35/Hilbert_curve_3_Orient%21.svg" alt="hilbert_curve"><figcaption>hilbert_curve</figcaption></figure><p>　　上面两张图很明了的展示了希尔伯特曲线的构造过程，该曲线的构造基本元素由 ABCD 4 种“U”形构成，而 BCD 又可由 A 依次逆时针旋转 90 度得到，所以也可以认为只有一种“U”形，每个 U 占 4 个格子，以特定方式进行 1 分 4 得到下一阶曲线形状。</p><p>每个 U 坐标与希尔伯特位置（用二进制表示）对应关系如下：</p><ul><li>A：<code>00 -&gt; (0,0); 01 -&gt; (0,1); 10 -&gt; (1,1); 11 -&gt; (1,0);</code></li><li>B：<code>00 -&gt; (1,1); 01 -&gt; (0,1); 10 -&gt; (0,0); 11 -&gt; (1,0);</code></li><li>C：<code>00 -&gt; (1,1); 01 -&gt; (1,0); 10 -&gt; (0,0); 11 -&gt; (0,1);</code></li><li>D：<code>00 -&gt; (0,0); 01 -&gt; (1,0); 10 -&gt; (1,1); 11 -&gt; (0,1);</code></li></ul><p>每个 U 一分四对应关系如下：</p><ul><li>A：<code>D -&gt; A -&gt; A -&gt; B</code></li><li>B：<code>C -&gt; B -&gt; B -&gt; A</code></li><li>C：<code>B -&gt; C -&gt; C -&gt; D</code></li><li>D：<code>A -&gt; D -&gt; D -&gt; C</code></li></ul><p>　　根据以上两个对应关系就能找到右手坐标系任意阶数的希尔伯特位置及坐标对应关系。以初始 1 阶曲线 A 为例，占据四个格子，然后进行一分四操作，四个格子分成 16 个格子，A 分为 DAAB 四个“U”形，连接起来即为 2 阶曲线，位置与坐标对应关系为（都用二进制表示）：</p><p><code>0000 -&gt; (00, 00); 0001 -&gt; (01, 00); 0010 -&gt; (01, 01); 0011 -&gt; (00, 01)</code>；</p><p><code>0100 -&gt; (00, 10); 0101 -&gt; (00, 11); 0110 -&gt; (01, 11); 0111 -&gt; (01, 10)</code>；</p><p><code>1000 -&gt; (10, 10); 1001 -&gt; (10, 11); 1010 -&gt; (11, 11); 1011 -&gt; (11, 10)</code>；</p><p><code>1100 -&gt; (11, 01); 1101 -&gt; (10, 01); 1110 -&gt; (10, 00); 1111 -&gt; (11, 00)</code>；</p><p>　　从二进制中很容易看出随着阶数的增加，位置与坐标的对应关系：每增加一阶，位置往后增加两位，坐标分量各增加一位，位置增加的两位根据一分四对应关系拼接，坐标各分量增加的一位需先找到一分四对应关系，再找对应位置与坐标对应关系，将得到的坐标分量对应拼接。以一阶的 <code>01 -&gt; (0,1)</code> 到二阶的 <code>0110 -&gt; (01, 11)</code> 为例，首先根据 01 得到当前所属一阶第二块，查找一分四对应关系知道，下一阶这块还是 A，根据 0110 后两位 10 可知这块属于 A 的第三个位置，查找坐标得到是 <code>(1,1)</code>，结合一阶的 <code>(0,1)</code>，对应分量拼接得到坐标 <code>(01,11)</code>，即 <code>(1, 3)</code>，同理可根据第二阶的坐标反查第二阶的位置。有了这些关系，就能生成希尔伯特曲线了，下面就看看 S2 是怎么生成 id 的。</p><h4 id="s2id">S2Id</h4><p>　　首先 S2 中用了两个二维数组分别保存位置到坐标以及坐标到位置的对应的关系：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="C++"><figure class="highlight hljs c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// kIJtoPos[orientation][ij] -&gt; pos</span></div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> kIJtoPos[<span class="number">4</span>][<span class="number">4</span>] = &#123;</div><div class="line">  <span class="comment">// (0,0) (0,1) (1,0) (1,1)</span></div><div class="line">  &#123;     <span class="number">0</span>,    <span class="number">1</span>,    <span class="number">3</span>,    <span class="number">2</span>  &#125;,  <span class="comment">// canonical order</span></div><div class="line">  &#123;     <span class="number">0</span>,    <span class="number">3</span>,    <span class="number">1</span>,    <span class="number">2</span>  &#125;,  <span class="comment">// axes swapped</span></div><div class="line">  &#123;     <span class="number">2</span>,    <span class="number">3</span>,    <span class="number">1</span>,    <span class="number">0</span>  &#125;,  <span class="comment">// bits inverted</span></div><div class="line">  &#123;     <span class="number">2</span>,    <span class="number">1</span>,    <span class="number">3</span>,    <span class="number">0</span>  &#125;,  <span class="comment">// swapped &amp; inverted</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// kPosToIJ[orientation][pos] -&gt; ij</span></div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> kPosToIJ[<span class="number">4</span>][<span class="number">4</span>] = &#123;</div><div class="line">  <span class="comment">// 0  1  2  3</span></div><div class="line">  &#123;  <span class="number">0</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">2</span> &#125;,    <span class="comment">// canonical order:    (0,0), (0,1), (1,1), (1,0)</span></div><div class="line">  &#123;  <span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span> &#125;,    <span class="comment">// axes swapped:       (0,0), (1,0), (1,1), (0,1)</span></div><div class="line">  &#123;  <span class="number">3</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span> &#125;,    <span class="comment">// bits inverted:      (1,1), (1,0), (0,0), (0,1)</span></div><div class="line">  &#123;  <span class="number">3</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span> &#125;,    <span class="comment">// swapped &amp; inverted: (1,1), (0,1), (0,0), (1,0)</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// kPosToOrientation[pos] -&gt; orientation_modifier</span></div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> kPosToOrientation[<span class="number">4</span>] = &#123;<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">3</span>&#125;;</div></pre></td></tr></table></figure></div><p>　　方向 0（canonical order）相当于上文中 A，方向 1（axes swapped）相当于上文中 D，方向 2（bits inverted）相当于上文中 C，方向 3（swapped &amp; inverted）相当于上文中 B，kPosToOrientation 代表 S2 中方向 0 一分四的对应关系，而 方向 1，2，3 的对应关系可由该值推出，计算公式为 <code>orientation ^ kPosToOrientation</code>，eg：<code>1 -&gt; 1^kPosToOrientation=[0, 1, 1, 2]; 3 -&gt; 3^kPosToOrientation=[2, 3, 3, 0]</code>，与上文中一分四对应关系一致。</p><p>　　随后 S2 初始化了一个 4 阶希尔伯特曲线位置与坐标的对应关系查找表，见 C++ 版的 <code>MaybeInit()</code> 方法，</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="C++"><figure class="highlight hljs c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> ij = (i &lt;&lt; <span class="number">4</span>) + j;</div><div class="line">lookup_pos[(ij &lt;&lt; <span class="number">2</span>) + orig_orientation] = (pos &lt;&lt; <span class="number">2</span>) + orientation;</div><div class="line">lookup_ij[(pos &lt;&lt; <span class="number">2</span>) + orig_orientation] = (ij &lt;&lt; <span class="number">2</span>) + orientation;</div></pre></td></tr></table></figure></div><p>　　orig_orientation 代表 4 个初始方向，orientation 代表该位置或坐标下一阶一分四的方向，数组中每个元素是 16 位数，2 个字节，一个四阶希尔伯特曲线是 <span class="math inline">\(2^4×2^4=256\)</span> 个位置，一个初始方向对应一个四阶希尔伯特曲线，所以一个查找表共占内存 <span class="math inline">\(2×256×4=2048=2KB\)</span>，正好一级缓存能放下，再大的话，一级缓存可能放不下，反而会降低查找速度。这两个查找表就相当于 4 个超“U”形的位置与坐标对应关系，同时一分四对应关系保持不变，以超“U”作为基本元素做下一阶希尔伯特曲线，每增加一阶位置往后增加 8 位，IJ 坐标各往后增加 4 位，如此，以更快的速度迭代到 S2 想要的 30 阶希尔伯特曲线。C++ 的这份代码就很精妙了：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="C++"><figure class="highlight hljs c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">S2CellId S2CellId::FromFaceIJ(<span class="keyword">int</span> face, <span class="keyword">int</span> i, <span class="keyword">int</span> j) &#123;</div><div class="line">  <span class="comment">// 初始化超“U”形查找表</span></div><div class="line">  MaybeInit();</div><div class="line"></div><div class="line">  <span class="comment">// face 向左移 60 位</span></div><div class="line">  uint64 n = absl::implicit_cast&lt;uint64&gt;(face) &lt;&lt; (kPosBits - <span class="number">1</span>);</div><div class="line"></div><div class="line">  <span class="comment">// 确定每个面的初始“U”形方向，使每个面都保持相同的右手坐标系，6 个面生成的希尔伯特曲线可以依次相连</span></div><div class="line">  uint64 bits = (face &amp; kSwapMask);</div><div class="line"></div><div class="line">  <span class="comment">// 基于超“U”形得到 30 阶希尔伯特曲线 IJ 坐标对应位置</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> GET_BITS(k) do &#123; \</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">int</span> mask = (<span class="number">1</span> &lt;&lt; kLookupBits) - <span class="number">1</span>; \</div><div class="line">    bits += ((i &gt;&gt; (k * kLookupBits)) &amp; mask) &lt;&lt; (kLookupBits + <span class="number">2</span>); \</div><div class="line">    bits += ((j &gt;&gt; (k * kLookupBits)) &amp; mask) &lt;&lt; <span class="number">2</span>; \</div><div class="line">    bits = lookup_pos[bits]; \</div><div class="line">    n |= (bits &gt;&gt; <span class="number">2</span>) &lt;&lt; (k * <span class="number">2</span> * kLookupBits); \</div><div class="line">    bits &amp;= (kSwapMask | kInvertMask); \</div><div class="line">  &#125; <span class="keyword">while</span> (<span class="number">0</span>)</div><div class="line"></div><div class="line">  <span class="comment">// IJ 只有 30 位，7 这个调用只会导致位置移 4 位，后续调用都移 8 位，得到 4 + 8 * 7 = 60 位</span></div><div class="line">  GET_BITS(<span class="number">7</span>); </div><div class="line">  GET_BITS(<span class="number">6</span>);</div><div class="line">  GET_BITS(<span class="number">5</span>);</div><div class="line">  GET_BITS(<span class="number">4</span>);</div><div class="line">  GET_BITS(<span class="number">3</span>);</div><div class="line">  GET_BITS(<span class="number">2</span>);</div><div class="line">  GET_BITS(<span class="number">1</span>);</div><div class="line">  GET_BITS(<span class="number">0</span>);</div><div class="line"><span class="meta">#<span class="meta-keyword">undef</span> GET_BITS</span></div><div class="line"></div><div class="line">  <span class="comment">// 整个 n 向右移一位，再以 1 结尾</span></div><div class="line">  <span class="keyword">return</span> S2CellId(n * <span class="number">2</span> + <span class="number">1</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></div><p>再来看看根据 id 反算 IJ 坐标：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="C++"><figure class="highlight hljs c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> S2CellId::ToFaceIJOrientation(<span class="keyword">int</span>* pi, <span class="keyword">int</span>* pj, <span class="keyword">int</span>* orientation) <span class="keyword">const</span> &#123;</div><div class="line">  <span class="comment">// 与上面一样</span></div><div class="line">  MaybeInit();</div><div class="line"></div><div class="line">  <span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>;</div><div class="line">  <span class="keyword">int</span> face = <span class="keyword">this</span>-&gt;face();</div><div class="line">  <span class="keyword">int</span> bits = (face &amp; kSwapMask);</div><div class="line"></div><div class="line">  <span class="comment">// 反算 IJ 坐标，k == 7 时，取希尔伯特曲线位置高 4 位，IJ 各前 2 位，其余依次取位置 8 位， IJ 各 4 位</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> GET_BITS(k) do &#123; \</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">int</span> nbits = (k == <span class="number">7</span>) ? (kMaxLevel - <span class="number">7</span> * kLookupBits) : kLookupBits; \</div><div class="line">    bits += (<span class="keyword">static_cast</span>&lt;<span class="keyword">int</span>&gt;(id_ &gt;&gt; (k * <span class="number">2</span> * kLookupBits + <span class="number">1</span>)) \</div><div class="line">             &amp; ((<span class="number">1</span> &lt;&lt; (<span class="number">2</span> * nbits)) - <span class="number">1</span>)) &lt;&lt; <span class="number">2</span>; \</div><div class="line">    bits = lookup_ij[bits]; \</div><div class="line">    i += (bits &gt;&gt; (kLookupBits + <span class="number">2</span>)) &lt;&lt; (k * kLookupBits); \</div><div class="line">    j += ((bits &gt;&gt; <span class="number">2</span>) &amp; ((<span class="number">1</span> &lt;&lt; kLookupBits) - <span class="number">1</span>)) &lt;&lt; (k * kLookupBits); \</div><div class="line">    bits &amp;= (kSwapMask | kInvertMask); \</div><div class="line">  &#125; <span class="keyword">while</span> (<span class="number">0</span>)</div><div class="line"></div><div class="line">  GET_BITS(<span class="number">7</span>);</div><div class="line">  GET_BITS(<span class="number">6</span>);</div><div class="line">  GET_BITS(<span class="number">5</span>);</div><div class="line">  GET_BITS(<span class="number">4</span>);</div><div class="line">  GET_BITS(<span class="number">3</span>);</div><div class="line">  GET_BITS(<span class="number">2</span>);</div><div class="line">  GET_BITS(<span class="number">1</span>);</div><div class="line">  GET_BITS(<span class="number">0</span>);</div><div class="line"><span class="meta">#<span class="meta-keyword">undef</span> GET_BITS</span></div><div class="line"></div><div class="line">  *pi = i;</div><div class="line">  *pj = j;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (orientation != <span class="literal">nullptr</span>) &#123;</div><div class="line">    S2_DCHECK_EQ(<span class="number">0</span>, kPosToOrientation[<span class="number">2</span>]);</div><div class="line">    S2_DCHECK_EQ(kSwapMask, kPosToOrientation[<span class="number">0</span>]);</div><div class="line">    <span class="comment">// 0x1111111111111111ULL may be better?</span></div><div class="line">    <span class="keyword">if</span> (lsb() &amp; <span class="number">0x1111111111111110</span>ULL) &#123;</div><div class="line">      bits ^= kSwapMask;</div><div class="line">    &#125;</div><div class="line">    *orientation = bits;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> face;</div><div class="line">&#125;</div></pre></td></tr></table></figure></div><p>　　这里的 orientation 实际是指当前位置的方向，即其周围必有 3 个位置与其方向相同，最后一行注释 Shaun 之所以认为应该是 0x1111111111111111ULL，是因为第 30 阶希尔伯特曲线位置（leaf cell）按理说同样需要做异或操作得到方向，不过整个 S2 库都没有需要用到 leaf cell 的方向，所以这就倒无关紧要了。之所以需要做异或操作，是因为 bits 是该位置下一阶一分四的方向，而对于同一个希尔伯特曲线位置，奇数阶与奇数阶下一阶一分四方向相同，偶数阶与偶数阶下一阶一分四方向相同，lsb() 表示二进制 id 从右往左数第一个 1 所代表的数， 所以有 0x1111111111111110ULL 这一魔术数，而异或操作正好能将下一阶一分四方向调整为当前阶方向。</p><p>　　如此 S2 的坐标以及 id 的生成以及反算就很明了了，下面就是 S2 如何使用 id 做计算了。</p><hr><h3 id="facesiti-坐标">FaceSiTi 坐标</h3><p>　　这个是 S2 内部计算使用的坐标，一般用来计算 cell 的中心坐标，以及根据当前 s 和 t 坐标的精度（小数点后几位）判断对应的级别（level）。由于 S2 本身并不显式存储 ST 坐标（有存 UV 坐标），所以 ST 坐标只能计算出来，每个 cell 的中心点同样如此。计算公式为 <span class="math inline">\(Si=s*2^{31};Ti=t*2^{31}\)</span>。至于为啥是 <span class="math inline">\(2^{31}\)</span>，是因为该坐标是用来描述从 0~ 31 阶希尔伯特曲线网格的中心坐标，0 阶中心以 <span class="math inline">\(1/2^1\)</span> 递增，1 阶中心以 <span class="math inline">\(1/2^2\)</span> 递增，2 阶中心以 <span class="math inline">\(1/2^3\)</span> 递增，……，30 阶中心以 <span class="math inline">\(1/2^{31}\)</span> 递增。S2 计算 id 对应的格子中心坐标，首先就会计算 SiTi 坐标，再将 SiTi 转成 ST 坐标。</p><h2 id="算法篇">算法篇</h2><h3 id="邻域算法">邻域算法</h3><p>　　S2 计算邻域，最关键的是计算不同面相邻的 leaf cell id，即：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="C++"><figure class="highlight hljs c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">S2CellId S2CellId::FromFaceIJWrap(<span class="keyword">int</span> face, <span class="keyword">int</span> i, <span class="keyword">int</span> j) &#123;</div><div class="line">  <span class="comment">// 限制 IJ 最大最小取值为 -1~2^30, 刚好能超出 IJ 正常表示范围 0~2^30-1</span></div><div class="line">  i = max(<span class="number">-1</span>, min(kMaxSize, i));</div><div class="line">  j = max(<span class="number">-1</span>, min(kMaxSize, j));</div><div class="line"></div><div class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">double</span> kScale = <span class="number">1.0</span> / kMaxSize;</div><div class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">double</span> kLimit = <span class="number">1.0</span> + DBL_EPSILON;</div><div class="line">  S2_DCHECK_EQ(<span class="number">0</span>, kMaxSize % <span class="number">2</span>);</div><div class="line">  <span class="comment">// IJ -&gt; SiTi -&gt; ST -&gt; UV</span></div><div class="line">  <span class="keyword">double</span> u = max(-kLimit, min(kLimit, kScale * (<span class="number">2</span> * (i - kMaxSize / <span class="number">2</span>) + <span class="number">1</span>)));</div><div class="line">  <span class="keyword">double</span> v = max(-kLimit, min(kLimit, kScale * (<span class="number">2</span> * (j - kMaxSize / <span class="number">2</span>) + <span class="number">1</span>)));</div><div class="line"></div><div class="line">  face = S2::XYZtoFaceUV(S2::FaceUVtoXYZ(face, u, v), &amp;u, &amp;v);</div><div class="line">  <span class="keyword">return</span> FromFaceIJ(face, S2::STtoIJ(<span class="number">0.5</span>*(u+<span class="number">1</span>)), S2::STtoIJ(<span class="number">0.5</span>*(v+<span class="number">1</span>)));</div><div class="line">&#125;</div></pre></td></tr></table></figure></div><p>　　这个算法主要用来计算超出范围（0~2^30-1）的 IJ 对应的 id，核心思想是先将 FaceIJ 转为 XYZ，再使用 XYZ 反算得到正常的 FaceIJ，进而得到正常的 id。中间 IJ -&gt; UV 中坐标实际经过了 3 步，对于 leaf cell，IJ -&gt; SiTi 的公式为 <span class="math inline">\(Si=2×I+1\)</span>，而对于 ST -&gt; UV，这里没有采用二次变换，就是线性变换 <span class="math inline">\(u=2*s-1\)</span>，官方注释上说明用哪个变换效果都一样，所以采用最简单的就行。</p><h4 id="边邻域">边邻域</h4><p>　　边邻域代码很简单，也很好理解：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="C++"><figure class="highlight hljs c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> S2CellId::GetEdgeNeighbors(S2CellId neighbors[<span class="number">4</span>]) <span class="keyword">const</span> &#123;</div><div class="line">  <span class="keyword">int</span> i, j;</div><div class="line">  <span class="keyword">int</span> level = <span class="keyword">this</span>-&gt;level();</div><div class="line">  <span class="comment">// 计算当前 level 一行或一列对应多少个 30 级的 cell（leaf cell） 2^(30-level)</span></div><div class="line">  <span class="keyword">int</span> size = GetSizeIJ(level);</div><div class="line">  <span class="keyword">int</span> face = ToFaceIJOrientation(&amp;i, &amp;j, <span class="literal">nullptr</span>);</div><div class="line"></div><div class="line">  <span class="comment">// Edges 0, 1, 2, 3 are in the down, right, up, left directions.</span></div><div class="line">  neighbors[<span class="number">0</span>] = FromFaceIJSame(face, i, j - size, j - size &gt;= <span class="number">0</span>)</div><div class="line">                 .parent(level);</div><div class="line">  neighbors[<span class="number">1</span>] = FromFaceIJSame(face, i + size, j, i + size &lt; kMaxSize)</div><div class="line">                 .parent(level);</div><div class="line">  neighbors[<span class="number">2</span>] = FromFaceIJSame(face, i, j + size, j + size &lt; kMaxSize)</div><div class="line">                 .parent(level);</div><div class="line">  neighbors[<span class="number">3</span>] = FromFaceIJSame(face, i - size, j, i - size &gt;= <span class="number">0</span>)</div><div class="line">                 .parent(level);</div><div class="line">&#125;</div></pre></td></tr></table></figure></div><p>　　分别计算当前 IJ 坐标下右上左坐标对应 id，FromFaceIJSame 表示若邻域在相同面，则走 FromFaceIJ，否则走 FromFaceIJWrap，由于这两个函数得到都是 leaf cell，要上升到指定 level，需要用到 parent 方法，即将希尔伯特曲线位置去掉右 <span class="math inline">\(2*(30-level)\)</span> 位，再组合成新的 id，位运算也很有意思：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="C++"><figure class="highlight hljs c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> uint64 <span class="title">lsb_for_level</span><span class="params">(<span class="keyword">int</span> level)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> uint64&#123;<span class="number">1</span>&#125; &lt;&lt; (<span class="number">2</span> * (kMaxLevel - level));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">inline</span> S2CellId S2CellId::parent(<span class="keyword">int</span> level) <span class="keyword">const</span> &#123;</div><div class="line">  uint64 new_lsb = lsb_for_level(level);</div><div class="line">  <span class="comment">// 取反加一实际是取负数</span></div><div class="line">  <span class="keyword">return</span> S2CellId((id_ &amp; (~new_lsb + <span class="number">1</span>)) | new_lsb);</div><div class="line">&#125;</div></pre></td></tr></table></figure></div><h4 id="点邻域">点邻域</h4><p>　　S2 的点邻域并不是指常规意义上 4 个顶点相邻左上右上右下左下的 id，而是一种比较特殊的相邻关系，以直角坐标系 (0,0),(0,1),(1,1),(1,0) 为例，(0,0) 的点邻域为 (0,0),(0,-1),(-1,-1),(-1,0)，(0,1) 的点邻域为 (0,1),(0,2),(-1,2),(-1,1)，(1,1) 的点邻域为 (1,1),(1,2),(2,2),(2,1)，(1,0) 的点邻域为 (1,0),(1,-1),(2,-1),(2,0)。具体代码如下：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="C++"><figure class="highlight hljs c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> S2CellId::AppendVertexNeighbors(<span class="keyword">int</span> level,</div><div class="line">                                     <span class="built_in">vector</span>&lt;S2CellId&gt;* output) <span class="keyword">const</span> &#123;</div><div class="line">  <span class="comment">// level &lt; this-&gt;level()</span></div><div class="line">  S2_DCHECK_LT(level, <span class="keyword">this</span>-&gt;level());</div><div class="line">  <span class="keyword">int</span> i, j;</div><div class="line">  <span class="keyword">int</span> face = ToFaceIJOrientation(&amp;i, &amp;j, <span class="literal">nullptr</span>);</div><div class="line"></div><div class="line">  <span class="comment">// 判断 IJ 落在 level 对应 cell 的哪个方位？（左下左上右上右下，对应上文的(0,0),(0,1),(1,1),(1,0)坐标）</span></div><div class="line">  <span class="keyword">int</span> halfsize = GetSizeIJ(level + <span class="number">1</span>);</div><div class="line">  <span class="keyword">int</span> size = halfsize &lt;&lt; <span class="number">1</span>;</div><div class="line">  <span class="keyword">bool</span> isame, jsame;</div><div class="line">  <span class="keyword">int</span> ioffset, joffset;</div><div class="line">  <span class="keyword">if</span> (i &amp; halfsize) &#123;</div><div class="line">    ioffset = size;</div><div class="line">    isame = (i + size) &lt; kMaxSize;</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    ioffset = -size;</div><div class="line">    isame = (i - size) &gt;= <span class="number">0</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (j &amp; halfsize) &#123;</div><div class="line">    joffset = size;</div><div class="line">    jsame = (j + size) &lt; kMaxSize;</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    joffset = -size;</div><div class="line">    jsame = (j - size) &gt;= <span class="number">0</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  output-&gt;push_back(parent(level));</div><div class="line">  output-&gt;push_back(FromFaceIJSame(face, i + ioffset, j, isame).parent(level));</div><div class="line">  output-&gt;push_back(FromFaceIJSame(face, i, j + joffset, jsame).parent(level));</div><div class="line">  <span class="comment">// 则邻域的 IJ 与当前 cell 都不在同一个面，则说明只有三个点邻域</span></div><div class="line">  <span class="keyword">if</span> (isame || jsame) &#123;</div><div class="line">    output-&gt;push_back(FromFaceIJSame(face, i + ioffset, j + joffset,</div><div class="line">                                     isame &amp;&amp; jsame).parent(level));</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></div><p>　　上面的代码算是比较清晰了，3 个点邻域的情况一般出现在当前 id 位于立方体 6 个面的角落，<em>该方法的参数 level 必须比当前 id 的 level 要小</em>。</p><h4 id="全邻域">全邻域</h4><p>　　所谓全邻域，即为当前 id 对应 cell 周围一圈 cell 对应的 id，若周围一圈 cell 的 level 与 当前 id 的 level 一样，则所求即为正常的 9 邻域。具体代码如下：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="C++"><figure class="highlight hljs c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> S2CellId::AppendAllNeighbors(<span class="keyword">int</span> nbr_level,</div><div class="line">                                  <span class="built_in">vector</span>&lt;S2CellId&gt;* output) <span class="keyword">const</span> &#123;</div><div class="line">  <span class="comment">// nbr_level &gt;= level</span></div><div class="line">  S2_DCHECK_GE(nbr_level, level());</div><div class="line">  <span class="keyword">int</span> i, j;</div><div class="line">  <span class="keyword">int</span> face = ToFaceIJOrientation(&amp;i, &amp;j, <span class="literal">nullptr</span>);</div><div class="line"></div><div class="line">  <span class="comment">// 先归一 IJ 坐标，将 IJ 坐标调整为当前 cell 左下角的坐标</span></div><div class="line">  <span class="keyword">int</span> size = GetSizeIJ();</div><div class="line">  i &amp;= -size;</div><div class="line">  j &amp;= -size;</div><div class="line"></div><div class="line">  <span class="keyword">int</span> nbr_size = GetSizeIJ(nbr_level);</div><div class="line">  S2_DCHECK_LE(nbr_size, size);</div><div class="line"></div><div class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> k = -nbr_size; ; k += nbr_size) &#123;</div><div class="line">    <span class="keyword">bool</span> same_face;</div><div class="line">    <span class="keyword">if</span> (k &lt; <span class="number">0</span>) &#123;</div><div class="line">      same_face = (j + k &gt;= <span class="number">0</span>);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (k &gt;= size) &#123;</div><div class="line">      same_face = (j + k &lt; kMaxSize);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      same_face = <span class="literal">true</span>;</div><div class="line">      <span class="comment">// 生成外包围圈下上两边的 id, 顺序为从左往右</span></div><div class="line">      output-&gt;push_back(FromFaceIJSame(face, i + k, j - nbr_size,</div><div class="line">                                       j - size &gt;= <span class="number">0</span>).parent(nbr_level));</div><div class="line">      output-&gt;push_back(FromFaceIJSame(face, i + k, j + size,</div><div class="line">                                       j + size &lt; kMaxSize).parent(nbr_level));</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 生成外包围圈左右两边以及四个边角的 id, 顺序为从下往上</span></div><div class="line">    output-&gt;push_back(FromFaceIJSame(face, i - nbr_size, j + k,</div><div class="line">                                     same_face &amp;&amp; i - size &gt;= <span class="number">0</span>)</div><div class="line">                      .parent(nbr_level));</div><div class="line">    output-&gt;push_back(FromFaceIJSame(face, i + size, j + k,</div><div class="line">                                     same_face &amp;&amp; i + size &lt; kMaxSize)</div><div class="line">                      .parent(nbr_level));</div><div class="line">    <span class="keyword">if</span> (k &gt;= size) <span class="keyword">break</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></div><p>　　知道这个函数的作用，再看代码就很明了了，<em>这个方法的参数 nbr_level 必须大于或等于当前 id 的 level</em>，因为一旦外包围圈的 cell 面积比当前 cell 还大，就无法得到正确的外包围圈。</p><h3 id="覆盖算法">覆盖算法</h3><p>　　S2 的覆盖，是指给定一块区域，能用多少 id 对应的 cell 完全覆盖该区域（GetCovering），当然也有尽量覆盖的算法（GetInteriorCovering），下面主要解析 GetCovering，因为 GetInteriorCovering 也差不多，就是覆盖策略略有不同。</p><p>GetCovering 的区域入参是 S2Region，比较典型的 S2Region 有以下几种：</p><ul><li>S2Cell：S2 id 对应的网格，会保存左下右上两个 UV 坐标，也是覆盖算法使用的基本元素；</li><li>S2CellUnion：多个 S2Cell 集合体，GetCovering 的返回值；</li><li>S2LatLngRect：经纬度矩形区域；</li><li>S2Cap：球帽区域，类比于二维圆的圆弧，球帽的构造比较奇怪，球帽的中心 S2Point 是需要，但另一个变量不是球帽的圆弧角，而是半个圆弧角（S2 代码库对应的 S1Angle 弧度，90 度代表半球，180 度代表全球）所对应弦长的平方，最大值为 4，之所以采用弦长的平方作为默认构造，是因为这就是 3 维中距离，在进行距离比较的场景时会更方便，比如测试是否包含一个 S2Point，计算覆盖多边形时，就不用再比较角度，毕竟角度计算代价比较大；</li><li>S2Loop：多边形的基本组成元素，第一个点与最后一个点隐式连接，逆时针代表封闭，顺时针代表开孔取外围区域，不允许自相交；</li><li>S2Polygon：非常正常的复杂多边形，由多个 S2Loop 构成，S2Loop 之间不能相交；</li><li>S2Polyline：一条折线，同样不能自相交；</li><li>还有些其它不常用的：S2R2Rect（S2Point 矩形区域），S2RegionIntersection（集合相交区域），S2RegionUnion（集合合并区域），……等。</li></ul><p>　　S2 覆盖算法的本质是一种启发式算法，先取满足当前条件最基本的元素，再依照条件进行迭代优化，所以该算法得到的只是一个近似最优解。GetCovering 需要依次满足以下条件：</p><ol type="1"><li>生成的 S2Cell level 不能比指定的 minLevel 小；（必须满足）</li><li>生成的 S2Cell 的个数不能比指定的 maxCells 多；（可以满足，当满足 1 时，数目已经 maxCells 多，迭代停止）</li><li>生成的 S2Cell level 不能比指定的 maxLevel 大；（必须满足）</li></ol><p>　　以上 3 个条件对应 GetCovering 的其他三个参数，当然还有一个参数是 levelModel，表示从 minLevel 向下分到 maxLevel 时，是 1 分 4，还是 1 分 16，还是 1 分 64，对应一次升 1 阶曲线，还是一次升 2 阶，或是一次升 3 阶。下面就来具体看看 GetCovering 的算法流程（代码就不贴了，太多了）：</p><ol type="1"><li>首先获取候选种子 S2Cell。先构造一个临时覆盖器，设置 maxCells 为 4，minLevel 为 0，以快速得到初始覆盖结果，做法为：先得到覆盖输入区域的 S2Cap，再用 S2CellUnion 覆盖该 S2Cap，根据 S2Cap 圆弧度计算 S2Cell 的 level，若最终 level &lt; 0，则说明 S2Cap 非常大，需要取 6 个面对应的 S2Cell，否则只需要取 S2Cap 中心点对应 S2Cell 的 level 级的点邻域 4 个 S2Cell 作为初始候选 S2Cell。</li><li>然后标准化候选种子。第一步，如果候选 S2Cell level 比 maxLevel 大或者候选 S2Cell 的 level 不符合 levelModel，则调整候选 S2Cell 的 level，用指定父级 S2Cell 来代替；第二步，归一化候选 S2Cell，先对 S2Cell 按 id 排序，去除被包含的 id，以及对 id 剪枝（若连续 4 个 S2Cell 共有同一个 parent，则用 parent 代替这 4 个 S2Cell）；第三步，反归一化候选 S2Cell，若候选 S2Cell level 比 minLevel 小或不满足 levelModel，则需要将 S2Cell 分裂，用指定级别的孩子来取代该 S2Cell；第四步，检查是否满足全部条件，若满足，则标准化完成，若不满足，则看候选 S2Cell 的数目是否足够多，若足够多，则需要迭代进行 GetCovering，这样会极大降低算法性能，若不是很多，则迭代合并相同祖先的两个 S2Cell（当然祖先的 level 不能比 minLevel 小），最后再次检查所有候选 S2Cell 是否达到标准化要求，并调整 S2Cell level。</li><li>构造优先级队列。将符合条件（与入参区域相交）的候选 S2Cell 放进一个优先级队列中，优先级会依次根据三个参数进行判断，1、S2Cell 的大小（level 越大，S2Cell 越小），越大的优先级越高；2、入参区域与候选 S2Cell 孩子相交（这里的相交是指相交但不完全包含）的个数，越少优先级越高；3、入参区域完全包含候选 S2Cell 孩子和与无法再细分的孩子的个数，同样是越少优先级越高。在构造这个优先级队列的同时，会输出一些候选 S2Cell 作为覆盖算法的正式结果，这些 S2Cell 满足任意以下条件：1、被入参区域完全覆盖；2、与入参区域相交但不可再细分；3、入参区域包含或相交全部孩子。如此留在优先级队列中的，就都是些与入参区域边界相交的 S2Cell，这些就是真正的候选 S2Cell。</li><li>最后，处理优先级队列中的 S2Cell。处理方式也比较简单粗暴，继续细分并入队，满足上面3个出队条件的任意一个，即可出队作为正式结果，当然，若分到后面可能正式的 S2Cell 太多，甚至超过 maxCells，这时不再细分强行出队作为正式结果。最后，再对正式结果做一次标准化处理，即进行第 2 步，得到最终的覆盖结果。</li></ol><p>　　以上就是 S2 覆盖算法的大致流程，更加细节的东西，还是得看代码，文字有些不是很好描述，代码里面计算候选 S2Cell 的优先级就很有意思。</p><hr><p>　　当然 S2 中还有很多其他算法（凸包，相交，距离），这里就不做太多介绍了，Shaun 平常用的最多的就是覆盖算法，之前一直没有细看，就简单用用 api，同时为了对一块大的 S2Cell 做多线程处理，需要了解 S2Cell 一分四的方向，经过这次对 S2 的了解，发现之前的用法存在一些问题，可见调包侠同样需要对包有一定的了解才能调好包 ╮(╯▽╰)╭。</p><h2 id="后记">后记</h2><p>　　正如许多经典的算法一样，看完之后总有种我上我也行的感觉，但实际完全不行，S2 全程看下来有些地方确实比较晦涩，而且这一连串的想法也很精妙（单位球立方体投影，ST 空间面积优化，64 位 id 生成等），Shaun 或许能有部分想法，但这么多奇思妙想组合起来，就完全不行。</p><h2 id="附录">附录</h2><h3 id="hilbertcurve-绘制">HilbertCurve 绘制</h3><p>　　在网上随便找了三种实现方式，并用 threejs 简单绘制了一下：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="TYPESCRIPT"><figure class="highlight hljs typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> * <span class="keyword">as</span> THREE <span class="keyword">from</span> <span class="string">"three"</span>;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> HilbertCurve &#123;</div><div class="line">    order = <span class="number">3</span>; <span class="comment">// 阶数</span></div><div class="line">    size = <span class="number">1</span> &lt;&lt; <span class="keyword">this</span>.order; <span class="comment">// 行列数</span></div><div class="line">    totalSize = <span class="keyword">this</span>.size * <span class="keyword">this</span>.size; <span class="comment">// 总网格数，希尔伯特长度</span></div><div class="line"></div><div class="line">    <span class="comment">// https://www.youtube.com/watch?v=dSK-MW-zuAc</span></div><div class="line">    getPath_V1() &#123;</div><div class="line">        <span class="keyword">let</span> path = [];</div><div class="line">        <span class="keyword">let</span> origOrientation = [</div><div class="line">            [<span class="number">0</span>, <span class="number">0</span>],</div><div class="line">            [<span class="number">0</span>, <span class="number">1</span>],</div><div class="line">            [<span class="number">1</span>, <span class="number">1</span>],</div><div class="line">            [<span class="number">1</span>, <span class="number">0</span>],</div><div class="line">        ]; <span class="comment">// 倒 U 形</span></div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.totalSize; i++) &#123;</div><div class="line">            path.push(hilbertToXY(i, <span class="keyword">this</span>.order));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> path;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">function</span> <span class="title">hilbertToXY</span>(<span class="params">i: <span class="built_in">number</span>, order: <span class="built_in">number</span></span>) </span>&#123;</div><div class="line">            <span class="keyword">let</span> index = i &amp; <span class="number">3</span>;</div><div class="line">            <span class="keyword">let</span> curCoord = origOrientation[index].slice();</div><div class="line"></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> ord = <span class="number">1</span>; ord &lt; order; ord++) &#123;</div><div class="line">                i = i &gt;&gt;&gt; <span class="number">2</span>;</div><div class="line">                index = i &amp; <span class="number">3</span>;</div><div class="line">                <span class="keyword">let</span> delta = <span class="number">1</span> &lt;&lt; ord;</div><div class="line">                <span class="keyword">if</span> (index === <span class="number">0</span>) &#123;</div><div class="line">                    <span class="comment">// 顺时针旋转 90°</span></div><div class="line">                    <span class="keyword">let</span> tmp = curCoord[<span class="number">0</span>];</div><div class="line">                    curCoord[<span class="number">0</span>] = curCoord[<span class="number">1</span>];</div><div class="line">                    curCoord[<span class="number">1</span>] = tmp;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (index === <span class="number">1</span>) &#123;</div><div class="line">                    curCoord[<span class="number">1</span>] += delta;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (index === <span class="number">2</span>) &#123;</div><div class="line">                    curCoord[<span class="number">0</span>] += delta;</div><div class="line">                    curCoord[<span class="number">1</span>] += delta;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (index === <span class="number">3</span>) &#123;</div><div class="line">                    <span class="comment">// 逆时针旋转 90°</span></div><div class="line">                    <span class="keyword">let</span> tmp = delta - <span class="number">1</span> - curCoord[<span class="number">0</span>];</div><div class="line">                    curCoord[<span class="number">0</span>] = delta - <span class="number">1</span> - curCoord[<span class="number">1</span>];</div><div class="line">                    curCoord[<span class="number">1</span>] = tmp;</div><div class="line">                    curCoord[<span class="number">0</span>] += delta;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> curCoord;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Hacker's Delight</span></div><div class="line">    getPath_V2() &#123;</div><div class="line">        <span class="keyword">let</span> path: <span class="built_in">number</span>[][] = [];</div><div class="line">        <span class="keyword">let</span> x = <span class="number">-1</span>,</div><div class="line">            y = <span class="number">0</span>;</div><div class="line">        <span class="keyword">let</span> s = <span class="number">0</span>; <span class="comment">// along the curve</span></div><div class="line"></div><div class="line">        step(<span class="number">0</span>);</div><div class="line">        hilbert(<span class="number">0</span>, <span class="number">1</span>, <span class="keyword">this</span>.order);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> path;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">function</span> <span class="title">step</span>(<span class="params">dir: <span class="built_in">number</span></span>) </span>&#123;</div><div class="line">            <span class="keyword">switch</span> (dir &amp; <span class="number">3</span>) &#123;</div><div class="line">                <span class="keyword">case</span> <span class="number">0</span>:</div><div class="line">                    x += <span class="number">1</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">                    y += <span class="number">1</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> <span class="number">2</span>:</div><div class="line">                    x -= <span class="number">1</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> <span class="number">3</span>:</div><div class="line">                    y -= <span class="number">1</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            path[s] = [x, y];</div><div class="line"></div><div class="line">            s += <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">function</span> <span class="title">hilbert</span>(<span class="params">dir: <span class="built_in">number</span>, rot: <span class="built_in">number</span>, order: <span class="built_in">number</span></span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span> (order === <span class="number">0</span>) <span class="keyword">return</span>;</div><div class="line"></div><div class="line">            dir += rot;</div><div class="line">            hilbert(dir, -rot, order - <span class="number">1</span>);</div><div class="line">            step(dir);</div><div class="line"></div><div class="line">            dir -= rot;</div><div class="line">            hilbert(dir, rot, order - <span class="number">1</span>);</div><div class="line">            step(dir);</div><div class="line"></div><div class="line">            hilbert(dir, rot, order - <span class="number">1</span>);</div><div class="line"></div><div class="line">            dir -= rot;</div><div class="line">            step(dir);</div><div class="line">            hilbert(dir, -rot, order - <span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// https://en.wikipedia.org/wiki/Hilbert_curve</span></div><div class="line">    getPath_V3() &#123;</div><div class="line">        <span class="keyword">let</span> path: <span class="built_in">number</span>[][] = [];</div><div class="line"></div><div class="line">        <span class="comment">// for (let i = 0; i &lt; this.totalSize; i++) &#123;</span></div><div class="line">        <span class="comment">//     path.push(hilbertToXY(this.size, i));</span></div><div class="line">        <span class="comment">// &#125;</span></div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> y = <span class="number">0</span>; y &lt; <span class="keyword">this</span>.size; y++) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> x = <span class="number">0</span>; x &lt; <span class="keyword">this</span>.size; x++) &#123;</div><div class="line">                path[xyToHilbert(<span class="keyword">this</span>.size, x, y)] = [x, y];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> path;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">function</span> <span class="title">rot</span>(<span class="params">N: <span class="built_in">number</span>, rx: <span class="built_in">number</span>, ry: <span class="built_in">number</span>, xy: <span class="built_in">number</span>[]</span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span> (ry === <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (rx === <span class="number">1</span>) &#123;</div><div class="line">                    xy[<span class="number">0</span>] = N - <span class="number">1</span> - xy[<span class="number">0</span>];</div><div class="line">                    xy[<span class="number">1</span>] = N - <span class="number">1</span> - xy[<span class="number">1</span>];</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">let</span> t = xy[<span class="number">0</span>];</div><div class="line">                xy[<span class="number">0</span>] = xy[<span class="number">1</span>];</div><div class="line">                xy[<span class="number">1</span>] = t;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">function</span> <span class="title">hilbertToXY</span>(<span class="params">N: <span class="built_in">number</span>, h: <span class="built_in">number</span></span>) </span>&#123;</div><div class="line">            <span class="keyword">let</span> t = h;</div><div class="line">            <span class="keyword">let</span> xy = [<span class="number">0</span>, <span class="number">0</span>];</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> s = <span class="number">1</span>; s &lt; N; s *= <span class="number">2</span>) &#123;</div><div class="line">                <span class="keyword">let</span> rx = <span class="number">1</span> &amp; (t / <span class="number">2</span>);</div><div class="line">                <span class="keyword">let</span> ry = <span class="number">1</span> &amp; (t ^ rx);</div><div class="line">                rot(s, rx, ry, xy);</div><div class="line">                xy[<span class="number">0</span>] += s * rx;</div><div class="line">                xy[<span class="number">1</span>] += s * ry;</div><div class="line">                t /= <span class="number">4</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> xy;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">function</span> <span class="title">xyToHilbert</span>(<span class="params">N: <span class="built_in">number</span>, x: <span class="built_in">number</span>, y: <span class="built_in">number</span></span>) </span>&#123;</div><div class="line">            <span class="keyword">let</span> h = <span class="number">0</span>;</div><div class="line">            <span class="keyword">let</span> xy = [x, y];</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> s = N / <span class="number">2</span>; s &gt; <span class="number">0</span>; s /= <span class="number">2</span>) &#123;</div><div class="line">                <span class="keyword">let</span> rx = (xy[<span class="number">0</span>] &amp; s) &gt; <span class="number">0</span> ? <span class="number">1</span> : <span class="number">0</span>;</div><div class="line">                <span class="keyword">let</span> ry = (xy[<span class="number">1</span>] &amp; s) &gt; <span class="number">0</span> ? <span class="number">1</span> : <span class="number">0</span>;</div><div class="line">                h += s * s * ((<span class="number">3</span> * rx) ^ ry);</div><div class="line">                rot(N, rx, ry, xy);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> h;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    draw() &#123;</div><div class="line">        <span class="keyword">let</span> lineGeometry = <span class="keyword">new</span> THREE.Geometry();</div><div class="line">        <span class="keyword">this</span>.getPath_V3().forEach(<span class="function">(<span class="params">vertice</span>) =&gt;</span> &#123;</div><div class="line">            <span class="keyword">let</span> vecot = <span class="keyword">new</span> THREE.Vector3().fromArray(vertice);</div><div class="line">            vecot.setZ(<span class="number">0</span>);</div><div class="line">            lineGeometry.vertices.push(vecot);</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">let</span> lineMaterial = <span class="keyword">new</span> THREE.LineBasicMaterial(&#123; color: <span class="number">0x00ffff</span>, linewidth: <span class="number">1</span> &#125;);</div><div class="line">        <span class="keyword">let</span> line = <span class="keyword">new</span> THREE.Line(lineGeometry, lineMaterial);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> line;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></div></div><div class="article-content-more"><button type="button" class="article-more--link"><i class="fa fa-angle-double-down fa-3x" aria-hidden="true"></i></button></div></section></article><article id="post-K8S-应用开发指北" class="article div-border"><header class="article-header"><span class="article-date article-title--index"><i class="fa fa-calendar" aria-hidden="true"></i> <a href="/posts/55e674ff.html"><time datetime="2021-08-28T08:21:58.000Z">2021-08-28</time></a></span><section class="article-title article-title--index"><a href="/posts/55e674ff.html">K8S 应用开发指北</a></section><div class="article-label"><div class="article-category label"><i class="fa fa-book" aria-hidden="true"></i> <a class="color2 article-category-link" href="/categories/CloudNative/">CloudNative</a></div><div class="article-tag label"><i class="fa fa-bookmark" aria-hidden="true"></i> <a class="color1 article-tag-link" href="/tags/k8s/">k8s</a></div></div></header><section class="article-content"><div class="article-content--excerpt"><h2 id="前言">前言</h2><p>　　在周志明的『凤凰架构』中需要思考这样一个问题，如何用不可靠的部件来构造一个可靠的系统？对于程序员来说，写的代码从某种程度上来说都是不可靠的，但这些代码组成的一些系统却可以是可靠的。程序员对于错误的处理可以分为两派，一派是必须对错误进行处理，以保证系统的稳定行；另一派不对错误进行处理，任由程序 crash，只要有兜底方案，后面再不断完善。这两派并无孰优孰劣，只是两种不同的思维方式，甚至在同一个程序中，有些错误会处理，有些错误不会处理，这都是可能的。K8S 作为事实上的云原生操作系统，其目的就是为了将程序员写的各个程序组装成一个稳定的系统，并减少运维成本。</p></div><div class="article-content--all"><h2 id="前言">前言</h2><p>　　在周志明的『凤凰架构』中需要思考这样一个问题，如何用不可靠的部件来构造一个可靠的系统？对于程序员来说，写的代码从某种程度上来说都是不可靠的，但这些代码组成的一些系统却可以是可靠的。程序员对于错误的处理可以分为两派，一派是必须对错误进行处理，以保证系统的稳定行；另一派不对错误进行处理，任由程序 crash，只要有兜底方案，后面再不断完善。这两派并无孰优孰劣，只是两种不同的思维方式，甚至在同一个程序中，有些错误会处理，有些错误不会处理，这都是可能的。K8S 作为事实上的云原生操作系统，其目的就是为了将程序员写的各个程序组装成一个稳定的系统，并减少运维成本。</p><a id="more"></a><h2 id="基础篇">基础篇</h2><p>　　K8S 调度的基本单元是 Pod，Pod 也是 K8S 自带的一个资源对象，其可以简单理解为是一个容器集合体，程序员可控的容器有两类（Pause 容器除外），一类是 InitContainer，另一类是普通业务容器，InitContainer 按数组顺序创建，顺序执行，若一个失败，则整个 Pod 创建失败，普通业务容器同样按数组顺序创建，但异步执行，所以执行顺序不可控（可以通过 postStart Hook 简单控制一下）。由于 InitContainer 先于 Pod 其他容器执行，所以一般用来做普通业务容器执行前置条件的一些事情，比如：下载文件，初始化配置，状态消息通知等。</p><p>　　同一 Pod 中存储卷和网络可以共享。存储卷共享是指 Pod 内各容器可以挂载相同存储卷，从而数据共享。K8S 目前支持的存储卷共有三种：第一种是 emptyDir，这种存储是临时的，只能在 Pod 内使用，当 Pod 被销毁时，该存储的内容也会消失，只能在同一 Pod 内共享数据；第二种是 hostPath，这种存储会直接和集群中物理机存储相关联，是一种跨 Pod 持久化存储，但仅限该物理机，当 pod 被调度到其他物理机时就无法实现跨 Pod 共享数据；最后一种是外部存储（NFS，Ceph，GlusterFS，AWS EBS 等），这种方式可以真正实现数据持久化并共享，而且可以支持存储与计算分离，对系统会更友好一些，当然运维的成本也会更大。当然除了 K8S 自身提供的存储卷挂载可以实现数据共享，从程序的角度上，使用传统的方式一样也能数据共享，如数据库，DFS，OSS 等。</p><p>　　而网络共享是指 Pod 内各容器直接可以使用 localhost 以及容器暴露的端口进行相互通信，K8S 的端口有三种，分别为：容器端口（containerPort，容器中对外暴露的端口），集群内端口（port，集群内 pod 相互通信的端口），集群外端口（nodePort，集群外请求集群内的端口），其中容器端口和集群内是正常的动态端口，取值范围为 [1024, 65535]，集群外端口只能设置为 [30000, 32767]，若集群中服务不与集群外通信，则只需要设置集群内端口就行。K8S 中 IP 也同样有三种，分别为：Pod IP（两不同 Pod 资源对象相互通信的地址，集群外不可访问），Cluster IP（Service 资源对象的通信地址，集群外不可访问），Node IP（K8S 物理节点的 IP 地址，是真实的物理网络，集群外配合 nodePort 即可访问）。集群内端口和集群外端口由 K8S 的 Service 资源提供设置。<em>在创建 Service 时需要注意，一个 Pod 资源对应一个 Service 资源，不要想着一个 Service 管理两个 Pod 暴露的端口，这样做会使 Service 提供服务的能力异常，经常会接口超时</em>。</p><p>　　K8S 编程可以简单称之为面向 config 编程，一切需要动态变化的程序初始化变量，都应该以 config 的形式提供，然后交给运维就行，这样可以避免程序员频繁的修改程序，减少运维负担，K8S 的 config 有三种形式，第一种是程序启动参数，通过创建容器时的 args 参数配置；第二种是系统环境变量，通过创建容器时的 env 参数配置；最后一种是 K8S 提供的 ConfigMap 资源，该资源可以从文件，目录或 key-value 字符串创建，创建后的 ConfinMap 被全集群同命名空间所共享，可以通过 volumes 参数挂载到 pod 中，进而 mount 进容器中，被程序读取。前两种 config 方式对于配置变量少的可以使用，当配置变量很多或配置参数很长时，还是使用 ConfigMap 比较合适。</p><h2 id="调度篇">调度篇</h2><p>　　调度，广义上的调度可指一切管理安排，CPU 的指令执行就涉及到三级缓存的调度，程序运行时的 GC 可认为是运行时对内存资源的调度，操作系统的进程轮转可认为是系统对进程的调度，而 K8S 中的调度可简单理解为是对操作系统的调度。</p><p>　　K8S 的调度可简单分为两个层面上的调度，最底层的调度自然是 K8S 自身的调度策略，根据不同的资源用度和调度策略将 Pod 分配到不同的物理节点之上执行，根据指定的重启或恢复策略启动相应的 Pod，这个层面上的调度，K8S 有一套默认的调度器，对于特殊的调度需求，K8S 也支持自定义调度器，使用外部调度器代替默认调度器，这个层面的调度器 Shaun 没做太多研究，所以在这篇里对这层面的调度器不做过多描述。Shaun 接触过的是更上层的调度器，业务层面的调度服务，业务调度服务一般与业务紧密相关，但最核心的一点就是能够从业务入手，负责 Pod 的创建和销毁，并能掌握其运行状态，就算是完成了一个基础的业务调度服务器。</p><p>　　在设计业务调度服务时，有一种通用的模式，可以称之为 master-worker 模式，与同名的并发模式细节上有所不同，这里的 master 是指调度服务本体，只负责对外服务，资源监控，以及任务分发，任务状态感知等，不负责做具体的任务，一般也不关心任务的输入输出。在部署 master 时，一般会创建一个 Service 资源对象，毕竟其主要功能就是对外服务，master 一般由运维进行部署创建销毁。而 worker 是指真正做任务的 Pod，该 Pod 中可能会有多个容器，主容器负责真正执行任务，其他一些容器可能会负责保障任务的前置条件（输入，配置等），以及向 master 汇报任务执行状态信息（执行任务的主容器可能并不知道 master 的存在）等。worker 对应的 Pod 一般由 master 进行创建销毁，worker 的一些配置信息则可能会由运维管理。</p><p>　　由于 K8S 并没有在整个集群物理资源之上抽象出一层集群资源，所以 K8S 分配的节点实际还是在物理机上，若所有物理机剩余资源（是单个剩余资源，而不是所有剩余资源之和）都不满足 Pod 所需资源，则该 Pod 无法调度，类比内存碎片化，可以称之为资源碎片化。所以在创建 Pod 时，所需资源最好不要太多，以免调度失败。</p><h2 id="实践篇">实践篇</h2><p>　　Shaun 目前在 K8S 上开发的主要就是重计算（单机计算时间以小时计）调度服务。这类调度服务其实也分两种，一种是并发调度，一种是流水线（pipeline）式的串行调度，当然也可以将这两种混合起来，串行中有并行。在设计这类调度服务时，需要考虑集群上的资源（内存，CPU）是否足够，若不足，则可以考虑加入一个简单的等待机制，将任务放进一个队列中，当然加入这样一个等待机制，又会增加系统复杂性，需要考虑队列容量，队列优先级等。所以可执行的最小任务消耗的资源越少约好，否则集群中可能完全无法执行相关任务。</p><p>　　由于 Shaun 是独立开发，能完全控制 master 和 worker 的编写，所以 worker 设计的比较简单，一个主容器即完成了前置数据处理，主任务执行，执行状态汇报等全部事情，这是从时间和性能上以及系统复杂度上等多方面权衡的结果，当然在时间足够人手够的情况，是应该把现有的 worker 进一步分离的，而 master 就是比较通用的设计，资源监控，任务队列，任务 Pod 创建与销毁，任务状态信息保存，服务接口等，其中常规的服务接口应该有添加任务，开始任务，停止任务，恢复任务，删除任务，任务状态查询，任务日志查询，任务状态汇报等接口，如果任务是并行且无依赖的，还应该支持开始指定子任务等接口。</p><p>　　在工作中，Shaun 也接触到一个 pipeline 式的任务调度服务，pipeline 式的工作流有个特点就是下一个子任务的输入必定依赖上一个子任务的输出，在这个任务调度服务中，其子任务的输入输出都是文件态，并且 master 不关心子任务的输入输出，子任务的执行程序也不知道 master 的存在，尽量低耦合。在云上，文件态的存储载体比较好的自然是 OSS，但原本的子任务执行程序只支持本地读取文件，而且在原来的程序中引入 OSS 的读写逻辑并不十分合适，所以在 K8S 中引入了 NFS，由 master 负责将 NFS 挂载到各子任务的 Pod 中，并在挂载到主容器时使用 SubPath 完成 pipeline 之间的资源隔离，使用 emptyDir 完成各子任务之间的资源隔离，每条 pipeline 开始的子任务是从 OSS 中拉取文件到 NFS 中对应的 SubPath 目录中，结束的子任务是将 NFS 中对应的 SubPath 目录中约定好的生成物上传到 OSS 中，并清空该 SubPath 目录，从而使原来的程序在 IO 这块完全不用改动。在监听任务运行状态方面，有两种方案：一种是利用 K8S 的 InitContainer，另一种是借助 K8S 的 shareProcessNamespace。InitContainer 的方案比较简单，InitContainer 第一个容器只做汇报子任务开始这一件事， 第二个容器则是真正执行子任务的容器，而业务容器只做汇报子任务结束这一件事，该方案利用 InitContainer 顺序且先于业务容器执行这两特点，并且若执行子任务的容器失败，则 Pod 也会创建失败，查询 Pod 状态即可知道子任务是否正常运行。而 shareProcessNamespace 的方案稍微复杂一些，同样使用一个 InitContainer 做汇报子任务开始这件事，而业务容器中放两个容器：一个主容器和一个 sidecar 容器（希望 K8S 原生支持的 SideCar 早日做好 ╯△╰），sidecar 容器中以轮询的方式监听主容器的运行状态（查询是否存在主进程）以及是否正常退出（获取容器退出码），并向 master 推送状态信息，该方案借助进程空间共享，使 sidecar 容器能直接查询主容器中的进程，从而达到监听主容器运行状态的目的，该方案的执行还需要一个小 trick，就是要让主容器先执行，由两种方案：一种是借助 postStart Hook，另一种是直接让 sidecar 容器先休眠个 10s 钟。关于 sidecar 容器的另外一种应用方案可参考 <a href="https://zhuanlan.zhihu.com/p/143845408" target="_blank" rel="external">Nginx容器配置文件如何热更新？</a> 。</p><p>　　虽然分布式任务调度框架有很多，eg：<a href="https://airflow.apache.org/" target="_blank" rel="external">Airflow</a>、<a href="https://github.com/spotify/luigi" target="_blank" rel="external">Luigi</a> 以及 <a href="https://dolphinscheduler.apache.org" target="_blank" rel="external">DolphinScheduler</a> 等，但目前与 K8S 联系最紧密的应该就是 <a href="https://argoproj.github.io/" target="_blank" rel="external">Argo</a> 了，其利用 K8S 的自定义资源对 K8S 已有功能进行扩展，仅使用 YAML 即可完成整个 pipeline 的任务调度和部署，虽然在并发任务调度时有一定的缺陷，但仅使用 YAML 表示其对 K8S 运维的足够友好性，对于常规 pipeline 式任务，Argo 已足以应付，除特殊需求外，程序员可少写很多代码。</p><h3 id="附录">附录</h3><p>　　对于 Spring 编写的程序，在 K8S 中运行，在导出日志时可参考 <a href="https://www.cnblogs.com/varyuan/p/14243472.html" target="_blank" rel="external">k8s:获取pod的ip</a>，通过 valueFrom 使用 Pod 的 metadata 作为环境变量，以区分日志的来源，不过挂载存储时最好还是用外部存储，用 hostPath 的话就需要保证每个物理节点都有相同的日志存储目录。</p><h2 id="后记">后记</h2><p>　　K8S 作为云原生时代的操作系统，不要求人人都完全掌握，但至少需要了解，知道什么该开发干，什么该运维干，这样才能充分发挥各个角色（包括 K8S）的价值。</p></div><div class="article-content-more"><button type="button" class="article-more--link"><i class="fa fa-angle-double-down fa-3x" aria-hidden="true"></i></button></div></section></article><article id="post-OpenGL坐标系统与渲染管线" class="article div-border"><header class="article-header"><span class="article-date article-title--index"><i class="fa fa-calendar" aria-hidden="true"></i> <a href="/posts/81321445.html"><time datetime="2021-05-28T10:22:41.000Z">2021-05-28</time></a></span><section class="article-title article-title--index"><a href="/posts/81321445.html">OpenGL坐标系统与渲染管线</a></section><div class="article-label"><div class="article-category label"><i class="fa fa-book" aria-hidden="true"></i> <a class="color3 article-category-link" href="/categories/Image-Graphic/">Image&Graphic</a></div><div class="article-tag label"><i class="fa fa-bookmark" aria-hidden="true"></i> <a class="color3 article-tag-link" href="/tags/algorithm/">algorithm</a></div></div></header><section class="article-content"><div class="article-content--excerpt"><h2 id="前言">前言</h2><p>　　图形学中最基础的东西就是坐标系统，三维的东西如何在二维中显示，这中间经历了数次坐标变换，同时坐标变换也贯穿了整个计算机图形渲染管线。</p></div><div class="article-content--all"><h2 id="前言">前言</h2><p>　　图形学中最基础的东西就是坐标系统，三维的东西如何在二维中显示，这中间经历了数次坐标变换，同时坐标变换也贯穿了整个计算机图形渲染管线。</p><a id="more"></a><h2 id="坐标篇">坐标篇</h2><figure><img src="https://learnopengl-cn.github.io/img/01/08/coordinate_systems.png" alt="coordinate_systems"><figcaption>coordinate_systems</figcaption></figure><p>　　在计算机图形世界中，为更灵活的控制三维物体显示在二维中，将变换的过程大致分为 5 个空间：1、局部空间（Local Space，或者称为物体空间（Object Space））；2、世界空间（World Space）；3、观察空间（View Space，或者称为视觉空间（Eye Space））；4、裁剪空间（Clip Space）；5、屏幕空间（Screen Space）。局部空间中是物体相对于坐标原点的坐标，也是物体的固有坐标，在依次经历过缩放旋转平移，也即模型矩阵（Model Matrix）变换后，物体局部坐标变换为世界坐标，世界坐标中即定义了物体所在的位置，以及产生的旋转和缩放。在世界空间中加入相机，以相机的视角看世界中的物体，即通过观察矩阵（View Matrix，也称视图矩阵）变换后，将世界坐标转换为观察坐标，由于一张屏幕能显示的东西是有限的，而三维世界中的物体是无限，所以需要通过投影矩阵（Projection Matrix）对三维空间进行裁剪，以决定哪些物体能显示在屏幕上，为方便的计算机判断，处于裁剪空间内的坐标会被转换为 [-1, 1]，为顺利在屏幕上显示，又需要通过视窗变换（Viewport Transform）将 [-1, 1] 映射为 viewport 中的图元坐标，再通过渲染管线的其他流程输出为屏幕上的像素点。</p><h2 id="变换篇">变换篇</h2><p>　　矩阵相乘一般有左乘和右乘之分，左乘和右乘的区别在于坐标是按列还是按行排列（OpenGL 中是按列，所以是左乘，DX 中按行，所以是右乘，同一种变换，传入 DX 中的矩阵与传入 OpenGL 中的矩阵互为转置），坐标与矩阵相乘越靠近坐标的矩阵表示该坐标越先做相应矩阵变换。</p><p>　　模型矩阵，视图矩阵，投影矩阵，在简单的顶点着色器编程中，这三个矩阵一般会合并成一个 MVP 矩阵传入 GPU 中。</p><h3 id="模型矩阵">模型矩阵</h3><p>　　模型矩阵一般定义了物体的缩放旋转平移状态，缩放矩阵的构造很简单，若物体在 <span class="math inline">\((x,y,z)\)</span> 方向上缩放尺度分别为 <span class="math inline">\((S_x, S_y, S_z)\)</span>，则缩放矩阵为： <span class="math display">\[ M_{scaling} = \begin{bmatrix} S_x &amp; 0 &amp; 0 &amp; 0 \\ 0 &amp; S_y &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; S_z &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; 1 \end{bmatrix} \]</span> 　　旋转矩阵就非常麻烦了，这里暂且不讨论其如何计算，只给出矩阵，物体绕任意轴 <span class="math inline">\((R_X, R_y, R_z)\)</span> 旋转 θ 角的矩阵为： <span class="math display">\[ M_{rotation} = \begin{bmatrix} cos\theta+R_x^2(1-cos\theta) &amp; R_xR_y(1-cos\theta)-R_zsin\theta &amp; R_xR_z(1-cos\theta)+R_ysin\theta &amp; 0 \\ R_yR_x(1-cos\theta)+R_zsin\theta &amp; cos\theta+R_y^2(1-cos\theta) &amp; R_yR_z(1-cos\theta)-R_xsin\theta &amp; 0 \\ R_zR_x(1-cos\theta)-R_ysin\theta &amp; R_zR_y(1-cos\theta)+R_xsin\theta &amp; cos\theta+R_z^2(1-cos\theta) &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; 1 \end{bmatrix} \]</span> 　　当然，由于万向节锁的存在，一般不会直接使用欧拉角和旋转轴计算旋转矩阵，而是会通过四元数得到旋转矩阵，这样既高效又能避免万向节锁，详情可看「LearnOpenGL」译者的<a href="https://krasjet.github.io/quaternion/" target="_blank" rel="external">教程</a>。</p><p>　　至于平移矩阵也非常简单，若物体在 <span class="math inline">\((x,y,z)\)</span> 方向上平移量分别为 <span class="math inline">\((T_x, T_y, T_z)\)</span>，则平移矩阵为： <span class="math display">\[ M_{translation} = \begin{bmatrix} 1 &amp; 0 &amp; 0 &amp; T_x \\ 0 &amp; 1 &amp; 0 &amp; T_y \\ 0 &amp; 0 &amp; 1 &amp; T_z \\ 0 &amp; 0 &amp; 0 &amp; 1 \end{bmatrix} \]</span> 　　前面的缩放和旋转矩阵其实只需要用到 3×3 的矩阵，而之所以用 4×4 的表示也是因为平移矩阵，普通的 3 维坐标必须增加一维 <span class="math inline">\(w\)</span> 构成齐次坐标才能进行平移操作，<span class="math inline">\(w\)</span> 一般都是 1.0，而从齐次坐标<span class="math inline">\((x,y,z,w)\)</span> 变为普通的 3 维坐标需要每个分量除以 <span class="math inline">\(w\)</span>，即 <span class="math inline">\((x/w, y/w, z/w)\)</span> 。</p><p>则模型矩阵 <span class="math inline">\(M_{model} = M_{translation} \cdot M_{rotation} \cdot M_{scaling}\)</span>。</p><h3 id="视图矩阵">视图矩阵</h3><p>　　视图矩阵描述的是三维场景中模拟相机的状态，根据模拟相机的状态确定一套以相机为原点的相机坐标系，从而使用视图矩阵进行坐标变换，至于为啥是模拟相机，是因为 OpenGL 本身并没有相机的概念，通过模拟相机来实现在三维场景中的漫游。</p><figure><img src="https://learnopengl-cn.github.io/img/01/09/camera_axes.png" alt="camera_axes"><figcaption>camera_axes</figcaption></figure><p>　　模拟相机有三个关键点，分别为相机位置（cameraPos），相机朝向点（cameraTarget），相机上向量（top），根据相机位置和相机朝向点可确定相机坐标系的 z 轴正向向量 <span class="math inline">\(cameraDirection = (cameraPos - cameraTarget).normalize\)</span>，叉乘相机上向量和相机 z 轴正向向量可得到相机坐标系 x 轴正向向量 <span class="math inline">\(cameraRight = top.cross(cameraDirection).normalize\)</span>，最后将相机 z 轴正向向量与 x 轴正向向量叉乘得到 y 轴正向向量 <span class="math inline">\(cameraUp = cameraDirection.cross(cameraRight)\)</span>，如此即可建立完整的相机坐标系，从而得到变换矩阵，即视图矩阵： <span class="math display">\[ M_{view} = \begin{bmatrix} R_x &amp; R_y &amp; R_z &amp; 0 \\ U_x &amp; U_y &amp; U_z &amp; 0 \\ D_x &amp; D_y &amp; D_z &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; 1 \end{bmatrix} \begin{bmatrix} 1 &amp; 0 &amp; 0 &amp; -P_x \\ 0 &amp; 1 &amp; 0 &amp; -P_y \\ 0 &amp; 0 &amp; 1 &amp; -P_z \\ 0 &amp; 0 &amp; 0 &amp; 1 \end{bmatrix} \]</span> 其中 <span class="math inline">\(R\)</span> 是相机 x 轴正向向量，<span class="math inline">\(U\)</span> 是相机 y 轴正向向量，<span class="math inline">\(D\)</span> 是相机 z 轴正向向量， <span class="math inline">\(P\)</span> 是相机位置向量。</p><h3 id="投影矩阵">投影矩阵</h3><p>　　投影矩阵描述的是摄像机前的可视区域（Frustum），根据可视区域的形状可分为正射投影（Orthographic Projection）和透视投影（Perspective Projection）。</p><p><img src="https://learnopengl-cn.github.io/img/01/08/orthographic_frustum.png" alt="orthographic projection frustum"> <img src="https://learnopengl-cn.github.io/img/01/08/perspective_frustum.png" alt="perspective_frustum"></p><p>　　对于这两种投影，都有远（far）近（near）参数，不同的是，正射投影是个立方体，所以有左（left）右（right）上（top）下（bottom）四个参数，而透视投影是个类梯形台，所以还有垂直方向视野（Field of View，fov），以及一个宽高比（aspect）两个参数。远近两个参数决定摄像机能看到多近和多远的物体，太近和太远都会看不见，一般可设 near = 0.1，far = 1000；若渲染视窗（viewport）宽为 W，高为 H，则一般 <span class="math inline">\(left=-W/2, right=W/2, top=H/2, bottom=-H/2\)</span> ；透视投影的 fov 是角度，一般设为 45.0，而 <span class="math inline">\(aspect = W/H\)</span> 。这两种投影的矩阵分别为： <span class="math display">\[ M_{orth} = \begin{bmatrix} \frac{2}{right-left} &amp; 0 &amp; 0 &amp; -\frac{right+left}{right-left} \\ 0 &amp; \frac{2}{top-bottom} &amp; 0 &amp; -\frac{top+bottom}{top-bottom} \\ 0 &amp; 0 &amp; \frac{-2}{far-near} &amp; -\frac{far+near}{far-near} \\ 0 &amp; 0 &amp; 0 &amp; 1 \end{bmatrix} \\ M_{pers} = \begin{bmatrix} \frac{2near}{right-left} &amp; 0 &amp; \frac{right+left}{right-left} &amp; 0 \\ 0 &amp; \frac{2near}{top-bottom} &amp; \frac{top+bottom}{top-bottom} &amp; 0 \\ 0 &amp; 0 &amp; \frac{-(far+near)}{far-near} &amp; \frac{-2far*near}{far-near} \\ 0 &amp; 0 &amp; -1 &amp; 0 \end{bmatrix} \]</span></p><p>　　在 three.js 中，对于透视投影矩阵中 left, right, top, bottom 计算方式为：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="JAVASCRIPT"><figure class="highlight hljs javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> top = near * <span class="built_in">Math</span>.tan( _Math.DEG2RAD * <span class="number">0.5</span> * <span class="keyword">this</span>.fov ) / <span class="keyword">this</span>.zoom;</div><div class="line"><span class="keyword">let</span> height = <span class="number">2</span> * top;</div><div class="line"><span class="keyword">let</span> width = <span class="keyword">this</span>.aspect * height;</div><div class="line"><span class="keyword">let</span> left = - <span class="number">0.5</span> * width;</div><div class="line"><span class="keyword">let</span> right = left + width;</div><div class="line"><span class="keyword">let</span> bottom = top - height;</div></pre></td></tr></table></figure></div><p>　　对于透视投影，由于计算出的齐次坐标 w 分量显然不为 1.0，所以必须进行透视除法（x,y,z 各分量分别除以 w），得到真正的 3 维坐标。</p><p>　　正射投影一般用来模拟 2D 空间，透视投影用来模拟 3D 空间，当透视投影 near 和 far 设置的相差太大时，很容易引发 z-fighting 现象，原因是离近平面越远时，计算出的深度精度越低，three.js 中为解决这一问题，引入了一个 logarithmicDepthBuffer 参数来决定是否开启使用对数函数优化深度计算，具体可看源码中的 logdepthbuf_vertex.glsl.js 和 logdepthbuf_fragment.glsl.js 文件，开启该参数会造成渲染性能下降。</p><h3 id="小结">小结</h3><p>　　<span class="math inline">\(M_{mvp} = M_{projection}M_{view}M_{model}\)</span>，一个局部坐标 <span class="math inline">\(V_{local}\)</span> 在经过 MVP 矩阵变换之后可得到裁剪坐标 <span class="math inline">\(V_{clip} = M_{mvp}V_{local}\)</span> ，在 OpenGL 中，<span class="math inline">\(V_{clip}\)</span> 会被赋值到顶点着色器中的 <code>gl_Position</code>，并且 OpenGL 会自动进行透视除法和裁剪。</p><p>　　3 维中的相机一般可分为两种，第一人称相机（常规 FPS 游戏）和第三人称相机（常规 ARPG 游戏），第一人称相机的特点是灵活，相机往往可以任意改变位置和朝向，所以会对某些人造成一种 “晕 3D” 的现象，而第三人称相机虽然可以改变相机朝向点和位置，但当朝向点和到朝向点的距离一旦固定，则相机只能沿着以朝向点为球心，以到朝向点的距离为半径的球面上运动，这两种相机一般看具体业务需求进行选择。</p><p>　　缩放操作是很常规的一种操作，镜头拉近代表放大，拉远代表缩小。在使用透视投影的 3 维场景中，只需要改变相机到朝向点的距离即可简单实现缩放操作，而在使用正射投影的场景中，改变距离并不能实现缩放，而是需要改变 左右上下 四个参数，所以在相机中往往会在引入一个 zoom 的参数，用 左右上下 四个参数分别除以 zoom 得到真正的 左右上下，从而改变 zoom，就可以改变相机参数，进而实现正射投影的缩放。</p><h2 id="管线篇">管线篇</h2><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="processonSvg1000" viewbox="-14.0 -19.5 759.0 557.625" width="600" height="500"><defs id="ProcessOnDefs1001"><marker id="ProcessOnMarker1009" markerunits="userSpaceOnUse" orient="auto" markerwidth="16.23606797749979" markerheight="10.550836550532098" viewbox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refx="-1.0" refy="3.8990363547948754"><path id="ProcessOnPath1010" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1017" markerunits="userSpaceOnUse" orient="auto" markerwidth="16.23606797749979" markerheight="10.550836550532098" viewbox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refx="-1.0" refy="3.8990363547948754"><path id="ProcessOnPath1018" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1025" markerunits="userSpaceOnUse" orient="auto" markerwidth="16.23606797749979" markerheight="10.550836550532098" viewbox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refx="-1.0" refy="3.8990363547948754"><path id="ProcessOnPath1026" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1038" markerunits="userSpaceOnUse" orient="auto" markerwidth="16.23606797749979" markerheight="10.550836550532098" viewbox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refx="-1.0" refy="3.8990363547948754"><path id="ProcessOnPath1039" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1047" markerunits="userSpaceOnUse" orient="auto" markerwidth="16.23606797749979" markerheight="10.550836550532098" viewbox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refx="-1.0" refy="3.8990363547948754"><path id="ProcessOnPath1048" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1055" markerunits="userSpaceOnUse" orient="auto" markerwidth="16.23606797749979" markerheight="10.550836550532098" viewbox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refx="-1.0" refy="3.8990363547948754"><path id="ProcessOnPath1056" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1063" markerunits="userSpaceOnUse" orient="auto" markerwidth="16.23606797749979" markerheight="10.550836550532098" viewbox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refx="-1.0" refy="3.8990363547948754"><path id="ProcessOnPath1064" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1071" markerunits="userSpaceOnUse" orient="auto" markerwidth="16.23606797749979" markerheight="10.550836550532098" viewbox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refx="-1.0" refy="3.8990363547948754"><path id="ProcessOnPath1072" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1083" markerunits="userSpaceOnUse" orient="auto" markerwidth="16.23606797749979" markerheight="10.550836550532098" viewbox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refx="-1.0" refy="3.8990363547948754"><path id="ProcessOnPath1084" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1089" markerunits="userSpaceOnUse" orient="auto" markerwidth="16.23606797749979" markerheight="10.550836550532098" viewbox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refx="-1.0" refy="3.8990363547948754"><path id="ProcessOnPath1090" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1105" markerunits="userSpaceOnUse" orient="auto" markerwidth="16.23606797749979" markerheight="10.550836550532098" viewbox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refx="-1.0" refy="3.8990363547948754"><path id="ProcessOnPath1106" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1116" markerunits="userSpaceOnUse" orient="auto" markerwidth="16.23606797749979" markerheight="10.550836550532098" viewbox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refx="-1.0" refy="3.8990363547948754"><path id="ProcessOnPath1117" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1122" markerunits="userSpaceOnUse" orient="auto" markerwidth="16.23606797749979" markerheight="10.550836550532098" viewbox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refx="-1.0" refy="3.8990363547948754"><path id="ProcessOnPath1123" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1138" markerunits="userSpaceOnUse" orient="auto" markerwidth="16.23606797749979" markerheight="10.550836550532098" viewbox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refx="-1.0" refy="3.8990363547948754"><path id="ProcessOnPath1139" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#999" stroke-width="2.0" fill="#999" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker></defs><g id="ProcessOnG1002"><path id="ProcessOnPath1003" d="M-14.0 -19.5H745.0V538.125H-14.0V-19.5Z" fill="none"/><g id="ProcessOnG1004"><g id="ProcessOnG1005" transform="matrix(1.0,0.0,0.0,1.0,6.0,122.0)" opacity="1.0"><path id="ProcessOnPath1006" d="M0.0 39.5C0.0 -13.166666666666666 84.0 -13.166666666666666 84.0 39.5C84.0 92.16666666666667 0.0 92.16666666666667 0.0 39.5Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"/></g><g id="ProcessOnG1007"><path id="ProcessOnPath1008" d="M90.0 161.5L137.3829796415478 161.5" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1009)"/></g><g id="ProcessOnG1011" transform="matrix(1.0,0.0,0.0,1.0,152.6190476190476,126.5)" opacity="1.0"><path id="ProcessOnPath1012" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1013" transform="matrix(1.0,0.0,0.0,1.0,10.0,25.0)"><text id="ProcessOnText1014" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="16" x="39.0" y="16.4">顶点着色器</text></g></g><g id="ProcessOnG1015"><path id="ProcessOnPath1016" d="M252.6190476190476 161.5L263.7639320225002 161.5" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1017)"/></g><g id="ProcessOnG1019" transform="matrix(1.0,0.0,0.0,1.0,279.0,126.5)" opacity="1.0"><path id="ProcessOnPath1020" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1021" transform="matrix(1.0,0.0,0.0,1.0,10.0,25.0)"><text id="ProcessOnText1022" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="16" x="39.0" y="16.4">图元装配</text></g></g><g id="ProcessOnG1023"><path id="ProcessOnPath1024" d="M379.0 161.5L413.7639320225002 161.5" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1025)"/></g><g id="ProcessOnG1027" transform="matrix(1.0,0.0,0.0,1.0,429.0,126.5)" opacity="1.0"><path id="ProcessOnPath1028" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1029" transform="matrix(1.0,0.0,0.0,1.0,10.0,25.0)"><text id="ProcessOnText1030" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="16" x="39.0" y="16.4">光栅器</text></g></g><g id="ProcessOnG1031" transform="matrix(1.0,0.0,0.0,1.0,24.5,150.0)" opacity="1.0"><path id="ProcessOnPath1032" d="M0.0 0.0L47.0 0.0L47.0 23.0L0.0 23.0Z" stroke="#999" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1033" transform="matrix(1.0,0.0,0.0,1.0,0.0,-7.25)"><text id="ProcessOnText1034" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="22.5" y="15.375">顶点</text><text id="ProcessOnText1035" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="22.5" y="34.125">缓冲区</text></g></g><g id="ProcessOnG1036"><path id="ProcessOnPath1037" d="M529.0 161.5L548.5 161.5L548.5 161.5L552.7639320225002 161.5" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1038)"/></g><g id="ProcessOnG1040" transform="matrix(1.0,0.0,0.0,1.0,568.0,126.5)" opacity="1.0"><path id="ProcessOnPath1041" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1042" transform="matrix(1.0,0.0,0.0,1.0,10.0,15.0)"><text id="ProcessOnText1043" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="微软雅黑" text-anchor="middle" font-size="16" x="39.0" y="16.4">片元着色</text><text id="ProcessOnText1044" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="微软雅黑" text-anchor="middle" font-size="16" x="39.0" y="36.4">器</text></g></g><g id="ProcessOnG1045"><path id="ProcessOnPath1046" d="M668.0 161.5L725.0 161.5L725.0 271.8354430379747L710.2360679774998 271.8354430379747" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1047)"/></g><g id="ProcessOnG1049" transform="matrix(1.0,0.0,0.0,1.0,595.0,236.8354430379747)" opacity="1.0"><path id="ProcessOnPath1050" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1051" transform="matrix(1.0,0.0,0.0,1.0,10.0,25.0)"><text id="ProcessOnText1052" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="微软雅黑" text-anchor="middle" font-size="16" x="39.0" y="16.4">归属测试</text></g></g><g id="ProcessOnG1053"><path id="ProcessOnPath1054" d="M595.0 271.8354430379747L556.0 271.8354430379747L556.0 271.8354430379747L532.2360679774998 271.8354430379747" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1055)"/></g><g id="ProcessOnG1057" transform="matrix(1.0,0.0,0.0,1.0,417.0,236.8354430379747)" opacity="1.0"><path id="ProcessOnPath1058" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1059" transform="matrix(1.0,0.0,0.0,1.0,10.0,25.0)"><text id="ProcessOnText1060" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="微软雅黑" text-anchor="middle" font-size="16" x="39.0" y="16.4">模板测试</text></g></g><g id="ProcessOnG1061"><path id="ProcessOnPath1062" d="M417.0 271.8354430379747L378.5 271.8354430379747L378.5 271.8354430379747L355.2360679774998 271.8354430379747" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1063)"/></g><g id="ProcessOnG1065" transform="matrix(1.0,0.0,0.0,1.0,240.0,236.8354430379747)" opacity="1.0"><path id="ProcessOnPath1066" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1067" transform="matrix(1.0,0.0,0.0,1.0,10.0,25.0)"><text id="ProcessOnText1068" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="微软雅黑" text-anchor="middle" font-size="16" x="39.0" y="16.4">深度测试</text></g></g><g id="ProcessOnG1069"><path id="ProcessOnPath1070" d="M240.0 271.8354430379747L207.0 271.8354430379747L207.0 271.8354430379747L189.2360679774998 271.8354430379747" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1071)"/></g><g id="ProcessOnG1073" transform="matrix(1.0,0.0,0.0,1.0,74.0,236.8354430379747)" opacity="1.0"><path id="ProcessOnPath1074" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1075" transform="matrix(1.0,0.0,0.0,1.0,10.0,25.0)"><text id="ProcessOnText1076" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="微软雅黑" text-anchor="middle" font-size="16" x="39.0" y="16.4">融合</text></g></g><g id="ProcessOnG1077" transform="matrix(1.0,0.0,0.0,1.0,74.0,444.25)" opacity="1.0"><path id="ProcessOnPath1078" d="M0.0 4.0Q0.0 0.0 4.0 0.0L96.0 0.0Q100.0 0.0 100.0 4.0L100.0 66.0Q100.0 70.0 96.0 70.0L4.0 70.0Q0.0 70.0 0.0 66.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1079" transform="matrix(1.0,0.0,0.0,1.0,10.0,25.0)"><text id="ProcessOnText1080" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="微软雅黑" text-anchor="middle" font-size="16" x="39.0" y="16.4">抖动</text></g></g><g id="ProcessOnG1081"><path id="ProcessOnPath1082" d="M74.0 271.8354430379747L20.0 271.8354430379747L20.0 479.25L58.763932022500214 479.25" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1083)"/></g><g id="ProcessOnG1085" transform="matrix(1.0,0.0,0.0,1.0,250.05952380952385,440.375)" opacity="1.0"><path id="ProcessOnPath1086" d="M0.0 38.875C0.0 -12.958333333333334 79.88095238095235 -12.958333333333334 79.88095238095235 38.875C79.88095238095235 90.70833333333333 0.0 90.70833333333333 0.0 38.875Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"/></g><g id="ProcessOnG1087"><path id="ProcessOnPath1088" d="M174.0 479.25L212.02976190476193 479.25L212.02976190476193 479.25L234.82345583202405 479.25" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1089)"/></g><g id="ProcessOnG1091" transform="matrix(1.0,0.0,0.0,1.0,268.73809523809524,467.75)" opacity="1.0"><path id="ProcessOnPath1092" d="M0.0 0.0L47.0 0.0L47.0 23.0L0.0 23.0Z" stroke="#999" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1093" transform="matrix(1.0,0.0,0.0,1.0,0.0,-7.25)"><text id="ProcessOnText1094" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="22.5" y="15.375">颜色</text><text id="ProcessOnText1095" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="22.5" y="34.125">缓冲区</text></g></g><g id="ProcessOnG1096" transform="matrix(1.0,0.0,0.0,1.0,624.0,3.500000000000014)" opacity="1.0"><path id="ProcessOnPath1097" d="M0.0 38.49999999999999C0.0 -12.83333333333333 82.0 -12.83333333333333 82.0 38.49999999999999C82.0 89.83333333333331 0.0 89.83333333333331 0.0 38.49999999999999Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"/></g><g id="ProcessOnG1098" transform="matrix(1.0,0.0,0.0,1.0,639.2619047619048,30.16455696202533)" opacity="1.0"><path id="ProcessOnPath1099" d="M0.0 0.0L51.476190476190474 0.0L51.476190476190474 25.32911392405063L0.0 25.32911392405063Z" stroke="#999" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1100" transform="matrix(1.0,0.0,0.0,1.0,0.0,-6.085443037974684)"><text id="ProcessOnText1101" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="24.738095238095237" y="15.375">纹理</text><text id="ProcessOnText1102" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="24.738095238095237" y="34.125">缓冲区</text></g></g><g id="ProcessOnG1103"><path id="ProcessOnPath1104" d="M665.0 80.5L665.0 103.5L618.0 103.5L618.0 111.26393202250021" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1105)"/></g><g id="ProcessOnG1107" transform="matrix(1.0,0.0,0.0,1.0,252.6190476190476,346.0)" opacity="1.0"><path id="ProcessOnPath1108" d="M0.0 37.0C0.0 -12.333333333333334 74.76190476190476 -12.333333333333334 74.76190476190476 37.0C74.76190476190476 86.33333333333333 0.0 86.33333333333333 0.0 37.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"/></g><g id="ProcessOnG1109" transform="matrix(1.0,0.0,0.0,1.0,264.26190476190476,370.33544303797464)" opacity="1.0"><path id="ProcessOnPath1110" d="M0.0 0.0L51.476190476190474 0.0L51.476190476190474 25.32911392405063L0.0 25.32911392405063Z" stroke="#999" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1111" transform="matrix(1.0,0.0,0.0,1.0,0.0,-6.085443037974684)"><text id="ProcessOnText1112" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="24.738095238095237" y="15.375">深度</text><text id="ProcessOnText1113" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="24.738095238095237" y="34.125">缓冲区</text></g></g><g id="ProcessOnG1114"><path id="ProcessOnPath1115" d="M290.0 306.8354430379747L290.0 326.4177215189874L289.99999999999994 326.4177215189874L289.99999999999994 330.7639320225002" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1116)"/></g><g id="ProcessOnG1118" transform="matrix(1.0,0.0,0.0,1.0,78.0,25.0)" opacity="1.0"><path id="ProcessOnPath1119" d="M0.0 39.5C0.0 -13.166666666666666 84.0 -13.166666666666666 84.0 39.5C84.0 92.16666666666667 0.0 92.16666666666667 0.0 39.5Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"/></g><g id="ProcessOnG1120"><path id="ProcessOnPath1121" d="M120.0 104.0L120.0 161.5L137.3829796415478 161.5" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1122)"/></g><g id="ProcessOnG1124" transform="matrix(1.0,0.0,0.0,1.0,78.75,48.5)" opacity="1.0"><path id="ProcessOnPath1125" d="M0.0 0.0L82.5 0.0L82.5 32.0L0.0 32.0Z" stroke="#999" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1126" transform="matrix(1.0,0.0,0.0,1.0,0.0,-2.75)"><text id="ProcessOnText1127" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="40.25" y="15.375">uniform</text><text id="ProcessOnText1128" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="40.25" y="34.125">数据</text></g></g><g id="ProcessOnG1129" transform="matrix(1.0,0.0,0.0,1.0,529.0,0.5)" opacity="1.0"><path id="ProcessOnPath1130" d="M0.0 40.0C0.0 -13.333333333333334 82.0 -13.333333333333334 82.0 40.0C82.0 93.33333333333333 0.0 93.33333333333333 0.0 40.0Z" stroke="#999" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"/></g><g id="ProcessOnG1131" transform="matrix(1.0,0.0,0.0,1.0,529.75,26.829113924050645)" opacity="1.0"><path id="ProcessOnPath1132" d="M0.0 0.0L82.5 0.0L82.5 32.0L0.0 32.0Z" stroke="#999" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1133" transform="matrix(1.0,0.0,0.0,1.0,0.0,-2.75)"><text id="ProcessOnText1134" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="40.25" y="15.375">uniform</text><text id="ProcessOnText1135" fill="#999" font-weight="normal" font-style="normal" text-decoration="none" font-family="Arial,宋体" text-anchor="middle" font-size="15" x="40.25" y="34.125">数据</text></g></g><g id="ProcessOnG1136"><path id="ProcessOnPath1137" d="M570.0 80.5L570.0 103.5L618.0 103.5L618.0 111.26393202250021" stroke="#999" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1138)"/></g></g></g></svg><p>　　渲染管线，图形学中最重要的概念之一，既然称之为管线，自然有像流水线一样的步骤，各个步骤具体做的事情如下：</p><ol type="1"><li>顶点着色器：负责将顶点数据进行坐标变换，该着色器中一般存在 MVP 矩阵，负责将三维坐标变换为二维坐标，该阶段也可以优化每个点的深度值，以便管线后续进行深度测试，也可以利用光照简单优化每个顶点的颜色；</li><li>图元装配：将输入的顶点数据进行组装，形成图元，常见的图元包括：点(GL_POINTS)、线(GL_LINES)、线条(GL_LINE_STRIP)、三角面(GL_TRIANGLES)，在该过程中，一般 GPU 会做一些裁剪和背面剔除等操作，以减少图元的数量，同时完成透视除法以进行屏幕映射；</li><li>光栅化：负责计算每个图元到屏幕像素点的映射。光栅化会计算每个图元所覆盖的片元，同时利用顶点属性插值计算每个片元的属性，片元可认为是候选像素，经过后续管线阶段即可变为真正的像素。</li><li>片元着色器：将光栅化得到的片元进行颜色计算。图形学中几乎所有的高级特效都会在这一步完成，光照计算，阴影处理，纹理，材质，统统在这一步进行处理；</li><li>归属测试：即测试片元所在位置是否位于当前上下文视窗内，若一个显示帧缓冲区视窗被另一个视窗所遮蔽，则剔除该部分片元。</li><li>模板测试：即测试片元是否满足一定条件（可大于或小于某个值等），若测试不满足，则剔除该该片元， OpenGL 可自行选择开启或关闭模板测试。</li><li>深度测试：用来测试片元的远近，远的片元被遮挡。在深度测试，若两片元深度值接近，则可能会引起 Z-fighting 现象，即像素闪烁，这是因为此时 GPU 无法确定该剔除哪个片元，导致这一帧可能绘制这个片元，下一帧绘制另一个片元。若开启 Alpha 测试，即启用透明度，则会在下一阶段进行 Alpha 混合，从而达到透明效果。</li><li>混合：将新生成的片元颜色和帧缓冲区中对应位置的颜色进行混合，得到像素颜色。</li><li>抖动：一种以牺牲分辨率为代价来增加颜色表示范围技术，从视觉效果上来看就是颜色过度更平滑。</li></ol><p>　　以上这些阶段中，能完全被编程控制的也就顶点着色器和片元着色器两个阶段，其余阶段要么完全无法控制，要么只能通过已有的参数进行设置，当然也可以通过顶点着色器和片元着色器影响余下阶段，顶点着色器和片元着色器也统称 Shader 编程。</p><p>　　有时候为了做更好看的特效，需要进行多次渲染，将上一次渲染的结果作为下一次渲染的输入，此时可以将颜色缓冲区作为一张纹理，并构造新的帧缓冲区，将该纹理作为输入，重新放进渲染管线中，这种操作方式也叫后期处理（Post Processing），虽然好看，但对 GPU 的负载很大，需要合理使用。</p><p>　　对于渲染管线，Shaun 的理解也就到此为止了，非常粗浅，Shader 也只是刚入门的水平，Shaun 在图形学方面做的更多是降低 Draw-Call 和 CPU 层面的 Tessellation，以及 Geometry 上的事，对纹理材质颜色光照阴影等方面涉及的较少。</p><h2 id="后记">后记</h2><p>　　虽然目前 OpenGL 已停止更新，但学习图形学编程，OpenGL 总是绕不过去（至少暂时以及未来很长一段时间都会是这样），而且图形学基础知识本质都是相同的，不管是 DirectX 还是 Vulkan，变的只是写法形式而已，数学知识总是在那里，两种 shader 也同样需要，所以了解这些东西还是有必要的。</p><h2 id="附录">附录</h2><h3 id="二维图像的图像透视投影变换">二维图像的图像透视投影变换</h3><p>　　图像的透视投影变换常用于图像的矫正，OpenCV 中就有现成的 api（getPerspectiveTransform 和 warpPerspective），用于将不规整的四边形区域变换为规整的矩形区域。其基本的数学原理为，先构造一个投影变换等式： <span class="math display">\[ \begin{bmatrix} XW \\ YW \\ W \end{bmatrix} = \begin{bmatrix} a &amp; b &amp; c \\ d &amp; e &amp; f \\ g &amp; h &amp; 1 \end{bmatrix} \begin{bmatrix} x \\ y \\ 1 \end{bmatrix} \]</span> 设四边形中四个点分别为 <span class="math inline">\((X_1, Y_1),(X_2, Y_2),(X_3, Y_3),(X_4, Y_4)\)</span> ，对应矩形中四个点为 <span class="math inline">\((x_1, y_1),(x_2, y_2),(x_3, y_3),(x_4, y_4)\)</span>。则可构造齐次线性方程组： <span class="math display">\[ \begin{bmatrix} x_1 &amp; y_1 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; -X_1x_1 &amp; -X_1y_1 \\ 0 &amp; 0 &amp; 0 &amp; x_1 &amp; y_1 &amp; 1 &amp; -Y_1x_1 &amp; -Y_1y_1 \\ x_2 &amp; y_2 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; -X_2x_2 &amp; -X_2y_2 \\ 0 &amp; 0 &amp; 0 &amp; x_2 &amp; y_2 &amp; 1 &amp; -Y_2x_2 &amp; -Y_2y_2 \\ \vdots &amp; \vdots &amp; \vdots &amp; \vdots &amp; \vdots &amp; \vdots &amp; \vdots &amp; \vdots \\ x_n &amp; y_n &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; -X_nx_n &amp; -X_ny_n \\ 0 &amp; 0 &amp; 0 &amp; x_n &amp; y_n &amp; 1 &amp; -Y_nx_n &amp; -Y_ny_n \end{bmatrix} \begin{bmatrix} a \\ b \\ c \\ d \\ e \\ f \\ g \\ h \end{bmatrix} = \begin{bmatrix} X_1 \\ Y_1 \\ X_2 \\ Y_2 \\ \vdots \\ X_n \\ Y_n \end{bmatrix} \]</span> 解这个方程组得到 abcdefg ，使用上面的投影变换等式可计算 <span class="math inline">\(X = XW / W, Y = YW / W\)</span> ，从而使用插值得到规整矩形图形的各个像素值。</p><h3 id="shader-学习资料">Shader 学习资料</h3><p>shader 入门书：https://thebookofshaders.com，在线编写 shader ：https://thebookofshaders.com/edit.php</p><p>glslsandbox 网站：http://glslsandbox.com/</p><p>shadertoy 网站：https://www.shadertoy.com/</p><h2 id="参考资料">参考资料</h2><p>[1] <a href="https://learnopengl-cn.github.io/01%20Getting%20started/08%20Coordinate%20Systems/" target="_blank" rel="external">坐标系统</a>（https://learnopengl-cn.github.io）</p><p>[2] <a href="http://www.yanhuangxueyuan.com/webgl_course/hardware.html" target="_blank" rel="external">WebGL图形系统、渲染管线_郭隆邦技术博客</a></p><p>[3] <a href="http://www.songho.ca/opengl/gl_projectionmatrix.html" target="_blank" rel="external">OpenGL Projection Matrix</a></p><p>[4] <a href="https://www.cnblogs.com/dojo-lzz/p/11250327.html" target="_blank" rel="external">WebGL着色器32位浮点数精度损失问题</a></p><p>[5] <a href="https://stackoverflow.com/questions/3190483/transform-quadrilateral-into-a-rectangle" target="_blank" rel="external">Transform quadrilateral into a rectangle?</a></p></div><div class="article-content-more"><button type="button" class="article-more--link"><i class="fa fa-angle-double-down fa-3x" aria-hidden="true"></i></button></div></section></article><article id="post-Scala-学习小结" class="article div-border"><header class="article-header"><span class="article-date article-title--index"><i class="fa fa-calendar" aria-hidden="true"></i> <a href="/posts/8d3d87a2.html"><time datetime="2021-02-16T16:12:28.000Z">2021-02-17</time></a></span><section class="article-title article-title--index"><a href="/posts/8d3d87a2.html">Scala 学习小结</a></section><div class="article-label"><div class="article-category label"><i class="fa fa-book" aria-hidden="true"></i> <a class="color5 article-category-link" href="/categories/Study/">Study</a></div><div class="article-tag label"><i class="fa fa-bookmark" aria-hidden="true"></i> <a class="color2 article-tag-link" href="/tags/language/">language</a></div></div></header><section class="article-content"><div class="article-content--excerpt"><h2 id="前言">前言</h2><p>　　最近要改行做大数据相关的东西了，经调研大数据开发的语言还是用 Scala 好，当然 Java 也可以，毕竟都运行在 JVM 上，不过 Java 也有很长时间没用过了，所以对于 Shaun 来说用 Scala 和 Java 的代价是一样的，都需要学习一下，所以决定用对大数据更友好的 Scala。</p></div><div class="article-content--all"><h2 id="前言">前言</h2><p>　　最近要改行做大数据相关的东西了，经调研大数据开发的语言还是用 Scala 好，当然 Java 也可以，毕竟都运行在 JVM 上，不过 Java 也有很长时间没用过了，所以对于 Shaun 来说用 Scala 和 Java 的代价是一样的，都需要学习一下，所以决定用对大数据更友好的 Scala。</p><a id="more"></a><p>　　以 Martin Odersky 14 年写的「Scala By Example」为参考，虽然是 14 年的，但 Scala 的基本语法还是没变的，就学习本身而言没问题，毕竟不兼容的只是更上层的 API，Shaun 学习用的 Scala 版本为 2.12.12。Alvin Alexander 的「Scala Cookbook, 2nd Edition」预计今年 8 月会出版，到时可能这本书用来入门更好，但 Shaun 不需要系统的学，就简单的能上手写出比较理想的 Scala 代码就行了。</p><h2 id="学习篇">学习篇</h2><h3 id="第一章入门基础">第一章：入门基础</h3><h4 id="helloworld">HelloWorld</h4><p>　　由于「Scala By Example」第一章没啥内容，也为了在正式写 Scala 之前简单熟悉一下，这里先用「A Scala Tutorial for Java Programmers」简单上手一下，首先写个 HelloWorld，具体代码如下：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">HelloWorld</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</div><div class="line">        println(<span class="string">"Hello, world!"</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></div><p>　　和 C 语言类似，程序唯一入口函数都是 main 函数，但 Scala 的变量在前，声明的类型在后，相比常规的语言是有点奇怪了，但这种语法规则和 Typescript 一样，所以很容易接受，但其模板的表示就有点奇怪了，Array[String] 表示一个 String 类型的数组，即表示方法为 Array[T]，常规的模板方式为 <code>Array&lt;T&gt;</code> 或 <code>T[]</code>，def 关键字用来定义一个函数，object 用来表示一个单例类，即在定义类的同时，又创建了一个类的实例。Scala 中没有 static 关键字，需要用 static 修饰的都放在 object 中即可。</p><h4 id="调用-java">调用 Java</h4><p>Scala 中默认已导入 java.lang 中的全部类，但其它类需要显式导入，以格式化输出本地日期为例：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.&#123;<span class="type">Date</span>, <span class="type">Locale</span>&#125;</div><div class="line"><span class="keyword">import</span> java.text.<span class="type">DateFormat</span>._</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">LocalDate</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</div><div class="line">        <span class="keyword">val</span> now = <span class="keyword">new</span> <span class="type">Date</span></div><div class="line">        <span class="keyword">val</span> df = getDateInstance(<span class="type">LONG</span>, <span class="type">Locale</span>.<span class="type">CHINA</span>)</div><div class="line">        println(df format now) <span class="comment">// df format(now)</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></div><p>　　Scala 中的导入和 java 中 import 基本一样，但功能更强大，可以使用 <code>{}</code> 导入部分，也使用 <code>_</code> 导入全部（java 导入全部为 <code>*</code>，这不一样），当一个函数只有一个参数，可以通过 <em>空格+参数</em> 的形式调用，而不需要使用 <em>括号包裹</em> 的形式。这里采用 <code>val</code> 关键字声明的是常量，而要声明变量需要用 <code>var</code>。</p><h4 id="对象">对象</h4><p>Scala 中万物皆对象，一个数字也是一个对象，一个函数也是一个对象，具体如下图：</p><figure><img src="http://coredumper.cn/wordpress/wp-content/uploads/2017/06/MacHi-2017-06-03-17-18-18.png" alt="enter image description here"><figcaption>enter image description here</figcaption></figure><p>以简单计时器函数为例：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">Timer</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">oncePerSecond</span></span>(callback: () =&gt; <span class="type">Unit</span>) &#123;</div><div class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</div><div class="line">            callback();</div><div class="line">            <span class="type">Thread</span> sleep <span class="number">1000</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">timeFiles</span></span>() &#123;</div><div class="line">        println(<span class="string">"time files like an arrow..."</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</div><div class="line">        <span class="comment">// oncePerSecond(timeFiles);</span></div><div class="line">        oncePerSecond(() =&gt; &#123;</div><div class="line">            println(<span class="string">"time files like an arrow..."</span>);</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></div><p>　　这个和 Typescript 函数式编程的用法基本差不多，唯一不同这里声明的函数返回的是 <code>Unit</code> ，这个 Unit 可认为是无返回的函数，大部分情况等同于 void，在 Scala 中真正的没有值指的是 Nothing。</p><h4 id="类">类</h4><p>Scala 中同样有类，具体代码示例如下：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Complex</span>(<span class="params">real: <span class="type">Double</span>, imaginary: <span class="type">Double</span></span>) </span>&#123;</div><div class="line">    <span class="comment">// def re() = real;</span></div><div class="line">    <span class="comment">// def im() = imaginary;</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">re</span> </span>= real;</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">im</span> </span>= imaginary;</div><div class="line">    </div><div class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">toString</span></span>(): <span class="type">String</span> = <span class="string">""</span> + re + (<span class="keyword">if</span> (im &lt; <span class="number">0</span>) <span class="string">""</span> <span class="keyword">else</span> <span class="string">"+"</span>) + im + <span class="string">"i"</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">ComplexNumbers</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</div><div class="line">        <span class="keyword">val</span> c = <span class="keyword">new</span> <span class="type">Complex</span>(<span class="number">1.2</span>, <span class="number">-3.4</span>);</div><div class="line">        <span class="comment">// println("real part: " + c.re() + " imaginary part: " + c.im());</span></div><div class="line">        println(c.toString());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></div><p>　　在 Scala 中所有类都会继承某个父类，若没有显式声明父类，则默认继承 scala.AnyRef 类，如上面的 Complex 类，若需要覆盖父类的函数，则需要在函数声明前加上 override 关键字。当函数没有参数时，可以不用加括号，在调用时也不用加括号，如上面示例的注释和非注释的代码。</p><h4 id="模式匹配与条件类">模式匹配与条件类</h4><p>　　接下来用 Scala 来写一个树结构表示表达式的示例代码，树的非叶节点表示操作符，叶子节点表示数值（这里为常量或变量），具体代码如下：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Tree</span></span></div><div class="line"><span class="class"><span class="title">case</span> <span class="title">class</span> <span class="title">Sum</span>(<span class="params">l: <span class="type">Tree</span>, r: <span class="type">Tree</span></span>) <span class="keyword">extends</span> <span class="title">Tree</span></span></div><div class="line"><span class="class"><span class="title">case</span> <span class="title">class</span> <span class="title">Var</span>(<span class="params">n: <span class="type">String</span></span>) <span class="keyword">extends</span> <span class="title">Tree</span></span></div><div class="line"><span class="class"><span class="title">case</span> <span class="title">class</span> <span class="title">Const</span>(<span class="params">v: <span class="type">Int</span></span>) <span class="keyword">extends</span> <span class="title">Tree</span></span></div><div class="line"><span class="class"></span></div><div class="line"><span class="class"><span class="title">object</span> <span class="title">Expression</span> </span>&#123;</div><div class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Environment</span> </span>= <span class="type">String</span> =&gt; <span class="type">Int</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">eval</span></span>(t: <span class="type">Tree</span>, env: <span class="type">Environment</span>): <span class="type">Int</span> = t <span class="keyword">match</span> &#123;</div><div class="line">        <span class="keyword">case</span> <span class="type">Sum</span>(l, r) =&gt; eval(l, env) + eval(r, env)</div><div class="line">        <span class="keyword">case</span> <span class="type">Var</span>(n) =&gt; env(n)</div><div class="line">        <span class="keyword">case</span> <span class="type">Const</span>(v) =&gt; v</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">derive</span></span>(t: <span class="type">Tree</span>, v: <span class="type">String</span>): <span class="type">Tree</span> = t <span class="keyword">match</span> &#123;</div><div class="line">        <span class="keyword">case</span> <span class="type">Sum</span>(l, r) =&gt; <span class="type">Sum</span>(derive(l, v), derive(r, v))</div><div class="line">        <span class="keyword">case</span> <span class="type">Var</span>(n) <span class="keyword">if</span> (v == n) =&gt; <span class="type">Const</span>(<span class="number">1</span>)</div><div class="line">        <span class="keyword">case</span> _ =&gt; <span class="type">Const</span>(<span class="number">0</span>)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</div><div class="line">        <span class="keyword">val</span> exp: <span class="type">Tree</span> = <span class="type">Sum</span>(<span class="type">Sum</span>(<span class="type">Var</span>(<span class="string">"x"</span>), <span class="type">Var</span>(<span class="string">"x"</span>)), <span class="type">Sum</span>(<span class="type">Const</span>(<span class="number">7</span>), <span class="type">Var</span>(<span class="string">"y"</span>))) </div><div class="line">        <span class="keyword">val</span> env: <span class="type">Environment</span> = &#123;<span class="keyword">case</span> <span class="string">"x"</span> =&gt; <span class="number">5</span> <span class="keyword">case</span> <span class="string">"y"</span> =&gt; <span class="number">7</span>&#125;</div><div class="line">        println(<span class="string">"Expression: "</span> + exp)</div><div class="line">        println(<span class="string">"Evalution with x=5, y=7: "</span> + eval(exp, env))</div><div class="line">        println(<span class="string">"Derivative relative to x:\n"</span> + derive(exp, <span class="string">"x"</span>))</div><div class="line">        println(<span class="string">"Derivative relative to y:\n"</span> + derive(exp, <span class="string">"y"</span>))</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></div><p>　　该示例主要用来说明两种 case 关键字，分别为：case class 和 … match case …，前者可认为是一个结构体，实例化时可以省略 new 关键字，参数有默认的 getter 函数，整个 case class 有默认的 equals 和 hashCode 方法实现，通过这两个方式可实现根据值判断类的两个实例是否相等，而不是通过引用，条件类同样有默认的 toString 方法实现；后者可认为是一种特殊的 switch case ，只不过 case 的判定和执行是函数式的，case class 可直接参与 match case 的判定（判定是不是属于该类）。第 7 行中有个 type 关键字，可认为是定义了一种新的类型（不是数据类型），示例中是函数类型，通过这个 type ，可直接将字符串映射为整型，23 行中将这个 type 与 case 结合使用，定义多个字符串映射多个整型的变量。第 18 行中有个 <code>_</code> ，这是 scala 中的通配符，不同的语义下表示的含义不同，这里的含义是指，当上面的模式都不匹配时，将执行这个，相当于 switch case 中的 default。</p><h4 id="scala-中的-trait">Scala 中的 trait</h4><p>　　简单理解就是 Java 中的 Interface（接口），Scala 中没有 interface 关键字，但是 trait 比 Interface 的功能更多，其中可直接定义属性和方法的实现，Scala 中可通过 trait 来实现多重继承。下面的示例用 trait 简单实现了一个比较接口：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Ord</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">&lt;</span></span>(that: <span class="type">Any</span>): <span class="type">Boolean</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">&lt;=</span></span>(that: <span class="type">Any</span>): <span class="type">Boolean</span> = (<span class="keyword">this</span> &lt; that) || (<span class="keyword">this</span> == that)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">&gt;</span></span>(that: <span class="type">Any</span>): <span class="type">Boolean</span> = !(<span class="keyword">this</span> &lt;= that)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">&gt;=</span></span>(that: <span class="type">Any</span>): <span class="type">Boolean</span> = !(<span class="keyword">this</span> &lt; that)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Date</span>(<span class="params">y: <span class="type">Int</span>, m: <span class="type">Int</span>, d: <span class="type">Int</span></span>) <span class="keyword">extends</span> <span class="title">Ord</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">year</span> </span>= y</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">month</span> </span>= m</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">day</span> </span>= d</div><div class="line"></div><div class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">toString</span></span>(): <span class="type">String</span> = year + <span class="string">"-"</span> + month + <span class="string">"-"</span> + day</div><div class="line"></div><div class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">equals</span></span>(that: <span class="type">Any</span>): <span class="type">Boolean</span> = &#123;</div><div class="line">        that.isInstanceOf[<span class="type">Date</span>] &amp;&amp; &#123;</div><div class="line">            <span class="keyword">val</span> o = that.asInstanceOf[<span class="type">Date</span>]</div><div class="line">            o.day == day &amp;&amp; o.month == month &amp;&amp; o.year == year</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">&lt;</span></span>(that: <span class="type">Any</span>): <span class="type">Boolean</span> = &#123;</div><div class="line">        <span class="keyword">if</span> (!that.isInstanceOf[<span class="type">Date</span>]) &#123;</div><div class="line">            sys.error(<span class="string">"cannot compare "</span> + that + <span class="string">" and a Date"</span>)</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">val</span> o = that.asInstanceOf[<span class="type">Date</span>]</div><div class="line">        (year &lt; o.year) || (year == o.year &amp;&amp; (month &lt; o.month || (month == o.month &amp;&amp; day &lt; o.day)))</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">Comparable</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</div><div class="line">        <span class="keyword">val</span> d1 = <span class="keyword">new</span> <span class="type">Date</span>(<span class="number">2021</span>, <span class="number">1</span>, <span class="number">3</span>);</div><div class="line">        <span class="keyword">val</span> d2 = <span class="keyword">new</span> <span class="type">Date</span>(<span class="number">2021</span>, <span class="number">1</span>, <span class="number">3</span>);</div><div class="line"></div><div class="line">        println(d1 &lt; d2)</div><div class="line">        println(d1 &lt;= d2)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></div><p>　　比较关系一般只需要确定 小于 和 等于 关系即可，其它关系都可由这两关系推出来，由于等于方法默认存在于所有对象中，所以只需要重写小于即可， 其它的比较方法都可以在 trait 中定义好。在上面的示例中有两个函数 isInstanceOf 和 asInstanceOf，前者用来判断对象是否是指定类型，后者用来将对象转换为指定类型，一般用在将父类转为子类时，在使用 asInstanceOf 之前一般需要先使用 isInstanceOf。</p><h4 id="泛型">泛型</h4><p>　　这东西没啥好说的，基本有编程经验的或见过或用过，只是 Scala 的泛型语法确实有点奇怪就是了，可能也是为了函数式那些乱七八糟的操作符，具体示例代码如下：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Reference</span>[<span class="type">T</span>] </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">var</span> contents: <span class="type">T</span> = _</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set</span></span>(value: <span class="type">T</span>) &#123;</div><div class="line">        contents = value</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span></span>: <span class="type">T</span> = contents</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">IntegerReference</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</div><div class="line">        <span class="keyword">val</span> cell = <span class="keyword">new</span> <span class="type">Reference</span>[<span class="type">Int</span>]</div><div class="line">        cell.set(<span class="number">13</span>)</div><div class="line">        println(<span class="string">"Reference contains the half of "</span> + (cell.get * <span class="number">2</span>))</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></div><p>　　这里同样有个 <code>_</code>，这里表示的是默认值，对于数字类型来说是 0，对于 boolean 来说是 false，对于 Unit（函数签名）来说是()（无参数无返回），对于其他来说是 null。</p><p>简单的了解 Scala 就到这里了。</p><hr><h3 id="第二章快排">第二章：快排</h3><p>开场就是一个快排，示例代码如下：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">QuickSort</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">qSort</span></span>(xs: <span class="type">Array</span>[<span class="type">Int</span>]) &#123;</div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">swap</span></span>(i: <span class="type">Int</span>, j: <span class="type">Int</span>) &#123;</div><div class="line">            <span class="keyword">val</span> t = xs(i); xs(i) = xs(j); xs(j) = t;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">sort</span></span>(l: <span class="type">Int</span>, r: <span class="type">Int</span>) &#123;</div><div class="line">            <span class="keyword">val</span> pivot = xs(l);</div><div class="line">            <span class="keyword">var</span> i = l+<span class="number">1</span>; <span class="keyword">var</span> j = r;</div><div class="line">            <span class="keyword">while</span> (i &lt; j) &#123;</div><div class="line">                <span class="keyword">while</span> (i &lt;= r &amp;&amp; xs(i) &lt; pivot) i += <span class="number">1</span>;</div><div class="line">                <span class="keyword">while</span> (j &gt; l &amp;&amp; xs(j) &gt; pivot) j -= <span class="number">1</span>;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (i &lt; j) &#123;</div><div class="line">                    swap(i, j);</div><div class="line">                    i += <span class="number">1</span>;</div><div class="line">                    j -= <span class="number">1</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (i &gt; j) &#123;</div><div class="line">                    i = j;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">while</span> (i &gt; l &amp;&amp; xs(i) &gt; pivot) &#123;</div><div class="line">                i -= <span class="number">1</span>; j -= <span class="number">1</span>;</div><div class="line">            &#125;</div><div class="line">            swap(i, l);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (l &lt; j<span class="number">-1</span>) sort(l, j<span class="number">-1</span>);</div><div class="line">            <span class="keyword">if</span> (j+<span class="number">1</span> &lt; r) sort(j+<span class="number">1</span>, r);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        sort(<span class="number">0</span>, xs.length<span class="number">-1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</div><div class="line">        <span class="comment">// val xs = Array(4, 1, 2, 5, 6);</span></div><div class="line">        <span class="comment">// val xs = Array(1, 2, 4, 4, 55, 5, 6);</span></div><div class="line">        <span class="comment">// val xs = Array(55, 6, 6);</span></div><div class="line">        <span class="keyword">val</span> xs = <span class="type">Array</span>(<span class="number">4</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>, <span class="number">2</span>, <span class="number">6</span>);</div><div class="line">        qSort(xs);</div><div class="line">        println(xs.mkString(<span class="string">" "</span>))</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></div><p>　　从这段快排代码可看出，Scala 支持函数嵌套和闭包，即在函数内部定义子函数，子函数可直接使用父函数的变量，同时，这里也简单说明一下 Scala 中数组的一些使用方法，用下标取数组元素时使用的是小括号 <code>()</code>，而不是其它语言常见的中括号 <code>[]</code>。当然 Scala 作为一种函数式语言，提供了非常多的函数式操作符，这篇也只会简单介绍。</p><h3 id="第三章actor">第三章：Actor</h3><p>　　Actor，Scala 中的多线程编程模型，下方的示例代码在 Scala 2.11 及之后的版本无法运行，因为 Actor 已从 Scala 库独立出来，见 <a href="https://stackoverflow.com/questions/29343770/object-actors-is-not-a-member-of-package-scala" target="_blank" rel="external">object-actors-is-not-a-member-of-package-scala</a>。</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> scala.actors.<span class="type">Actor</span></div><div class="line"></div><div class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AuctionMessage</span></span></div><div class="line"><span class="class"><span class="title">case</span> <span class="title">class</span> <span class="title">Offer</span>(<span class="params">bin: <span class="type">Int</span>, client: <span class="type">Actor</span></span>) <span class="keyword">extends</span> <span class="title">AuctionMessage</span></span></div><div class="line"><span class="class"><span class="title">case</span> <span class="title">class</span> <span class="title">Inquire</span>(<span class="params">client: <span class="type">Actor</span></span>) <span class="keyword">extends</span> <span class="title">AuctionMessage</span></span></div><div class="line"><span class="class"></span></div><div class="line"><span class="class"><span class="title">abstract</span> <span class="title">class</span> <span class="title">AuctionReply</span></span></div><div class="line"><span class="class"><span class="title">case</span> <span class="title">class</span> <span class="title">Status</span>(<span class="params">asked: <span class="type">Int</span>, expire: <span class="type">Date</span></span>) <span class="keyword">extends</span> <span class="title">AuctionReply</span></span></div><div class="line"><span class="class"><span class="title">case</span> <span class="title">object</span> <span class="title">BestOffer</span> <span class="keyword">extends</span> <span class="title">AuctionReply</span></span></div><div class="line"><span class="class"><span class="title">case</span> <span class="title">class</span> <span class="title">BeatenOffer</span>(<span class="params">maxBid: <span class="type">Int</span></span>) <span class="keyword">extends</span> <span class="title">AuctionReply</span></span></div><div class="line"><span class="class"><span class="title">case</span> <span class="title">class</span> <span class="title">AuctionConCluded</span>(<span class="params">seller: <span class="type">Actor</span>, client: <span class="type">Actor</span></span>) <span class="keyword">extends</span> <span class="title">AuctionReply</span></span></div><div class="line"><span class="class"></span></div><div class="line"><span class="class"><span class="title">case</span> <span class="title">object</span> <span class="title">AuctionFailed</span> <span class="keyword">extends</span> <span class="title">AuctionReply</span></span></div><div class="line"><span class="class"><span class="title">case</span> <span class="title">object</span> <span class="title">AuctionOver</span> <span class="keyword">extends</span> <span class="title">AuctionReply</span></span></div><div class="line"><span class="class"></span></div><div class="line"><span class="class"></span></div><div class="line"><span class="class"><span class="title">class</span> <span class="title">Auction</span>(<span class="params">seller: <span class="type">Actor</span>, minBid: <span class="type">Int</span>, closing: <span class="type">Date</span></span>) <span class="keyword">extends</span> <span class="title">Actor</span> </span>&#123;</div><div class="line">    <span class="keyword">val</span> timeToShutdown = <span class="number">36000000</span> <span class="comment">// msec</span></div><div class="line">    <span class="keyword">val</span> bidIncrement = <span class="number">10</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">act</span></span>() &#123;</div><div class="line">        <span class="keyword">var</span> maxBid = minBid - bidIncrement</div><div class="line">        <span class="keyword">var</span> maxBidder: <span class="type">Actor</span> = <span class="literal">null</span></div><div class="line">        <span class="keyword">var</span> running = <span class="literal">true</span></div><div class="line"></div><div class="line">        <span class="keyword">while</span> (running) &#123;</div><div class="line">            receiveWithin ((closing.getTime() - <span class="keyword">new</span> <span class="type">Date</span>().getTime())) &#123;</div><div class="line">                <span class="keyword">case</span> <span class="type">Offer</span>(bid, client) =&gt; &#123;</div><div class="line">                    <span class="keyword">if</span> (bid &gt;= maxBid + bidIncrement) &#123;</div><div class="line">                        <span class="keyword">if</span> (maxBid &gt;= minBid)   maxBidder ! <span class="type">BeatenOffer</span>(bid)</div><div class="line">                        maxBid = bid; maxBidder = client; client ! <span class="type">BestOffer</span></div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        client ! <span class="type">BeatenOffer</span>(maxBid)</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">case</span> <span class="type">Inquire</span>(client) =&gt; &#123;</div><div class="line">                    client ! <span class="type">BeatenOffer</span>(maxBid)</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">case</span> <span class="type">TIMEOUT</span> =&gt; &#123;</div><div class="line">                    <span class="keyword">if</span> (maxBid &gt;= minBid) &#123;</div><div class="line">                        <span class="keyword">val</span> reply = <span class="type">AuctionConCluded</span>(seller, maxBidder)</div><div class="line">                        maxBidder ! reply; seller ! reply</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        seller ! <span class="type">AuctionFailed</span></div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    receiveWithin(timeToShutdown) &#123;</div><div class="line">                        <span class="keyword">case</span> <span class="type">Offer</span>(_, client) =&gt; client ! <span class="type">AuctionOver</span></div><div class="line">                        <span class="keyword">case</span> <span class="type">TIMEOUT</span> =&gt; running = <span class="literal">false</span></div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloActor</span> <span class="keyword">extends</span> <span class="title">Actor</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">act</span></span>() &#123;</div><div class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</div><div class="line">            receive &#123;</div><div class="line">                <span class="keyword">case</span> name: <span class="type">String</span> =&gt; println(<span class="string">"Hello, "</span> + name)</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">AuctionService</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</div><div class="line">        <span class="keyword">val</span> seller: <span class="type">Actor</span> = <span class="keyword">new</span> <span class="type">HelloActor</span></div><div class="line">        <span class="keyword">val</span> client: <span class="type">Actor</span> = <span class="keyword">new</span> <span class="type">HelloActor</span></div><div class="line">        <span class="keyword">val</span> minBid = <span class="number">10</span></div><div class="line">        <span class="keyword">val</span> closing = <span class="keyword">new</span> <span class="type">Date</span>()</div><div class="line"></div><div class="line">        <span class="keyword">val</span> helloActor = <span class="keyword">new</span> <span class="type">HelloActor</span></div><div class="line">        helloActor.start()</div><div class="line">        helloActor ! <span class="string">"leo"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></div><p>　　通过重写 Actor 中的 <code>act</code> 方法即可简单的实现多线程编程，Actor 中有个特殊的标识符 <code>!</code>，该符号其实是是一种缩写，即可将 <code>helloActor.!(&quot;leo&quot;)</code> 缩写为 <code>helloActor ! &quot;leo&quot;</code>，代表将数据传递给 Actor，由 Actor 内部的 <code>receive case</code> 接受数据并处理，当然也可通过 <code>receiveWithin</code> 控制数据传递时间，若超时，则默认触发 <code>TIMEOUT</code> 处理模式。</p><h3 id="第四章表达式与简单函数">第四章：表达式与简单函数</h3><p>该章主要有两个例子：1、牛顿法求平方根；2、尾递归，具体如下：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">Sqrt</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sqrt</span></span>(x: <span class="type">Double</span>): <span class="type">Double</span> = &#123;</div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">sqrtIter</span></span>(guess: <span class="type">Double</span>, x: <span class="type">Double</span>): <span class="type">Double</span> = &#123;</div><div class="line">            <span class="keyword">if</span> (isGoodEnough(guess, x)) guess</div><div class="line">            <span class="keyword">else</span> sqrtIter(improve(guess, x), x)</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">improve</span></span>(guess: <span class="type">Double</span>, x: <span class="type">Double</span>) = &#123;</div><div class="line">            (guess + x / guess) / <span class="number">2</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">isGoodEnough</span></span>(guess: <span class="type">Double</span>, x: <span class="type">Double</span>) = (guess * guess - x).abs &lt; <span class="number">0.001</span>    <span class="comment">// guess * guess == x</span></div><div class="line"></div><div class="line">        sqrtIter(<span class="number">1.0</span>, x)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">TailRecursion</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">gcd</span></span>(a: <span class="type">Int</span>, b: <span class="type">Int</span>): <span class="type">Int</span> = <span class="keyword">if</span> (b == <span class="number">0</span>) a <span class="keyword">else</span> gcd(b, a % b)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">facorial</span></span>(n: <span class="type">Int</span>): <span class="type">Int</span> = <span class="keyword">if</span> (n == <span class="number">0</span>) <span class="number">1</span> <span class="keyword">else</span> n * facorial(n<span class="number">-1</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">facorialTail</span></span>(n: <span class="type">Int</span>): <span class="type">Int</span> = &#123;</div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">facorialIter</span></span>(n: <span class="type">Int</span>, res: <span class="type">Int</span>): <span class="type">Int</span> = &#123;</div><div class="line">            <span class="keyword">if</span> (n == <span class="number">0</span>) res</div><div class="line">            <span class="keyword">else</span> facorialIter(n<span class="number">-1</span>, res * n)</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        facorialIter(n, <span class="number">1</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">SimpleFunc</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</div><div class="line">        <span class="keyword">val</span> sqrtValue = <span class="type">Sqrt</span>.sqrt(<span class="number">0.01</span>)</div><div class="line">        println(sqrtValue)</div><div class="line"></div><div class="line">        <span class="keyword">val</span> gcdValue = <span class="type">TailRecursion</span>.gcd(<span class="number">14</span>,<span class="number">21</span>)</div><div class="line">        println(gcdValue)</div><div class="line"></div><div class="line">        <span class="keyword">val</span> facorialValue = <span class="type">TailRecursion</span>.facorial(<span class="number">5</span>)</div><div class="line">        println(facorialValue)</div><div class="line"></div><div class="line">        <span class="keyword">val</span> facorialTailValue = <span class="type">TailRecursion</span>.facorialTail(<span class="number">5</span>)</div><div class="line">        println(facorialTailValue)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></div><p>　　由于并没有引入新的语法，就简单聊聊这两个例子吧。牛顿法求平方根主要在于构造一个特殊的二分函数 <span class="math inline">\(y_{i+1} = (y_i + x / y_i)/2, i=0,1,2,3,..., y_0=1\)</span> ，如此迭代，直到 <span class="math inline">\(|y_i^2-x| &lt; \epsilon\)</span> ，得到 <span class="math inline">\(y_i\)</span> 即为 x 的平方根，更朴素一点的求多次方根就是利用二分法，分 [0, 1] 和 [1, +∞] 两个区间即可，对应从 [x, 1] 和 [1, x] 开始二分取值。至于尾递归，以前简单的写过一点，即最后递归调用原函数时，原函数不会再参与任何计算表达式。尾递归的好处在于当编译器或解释器支持尾递归时，将不会产生普通递归时的压栈操作，即不用担心递归层次太深，尾递归将类似循环迭代处理。</p><h3 id="第五章高阶函数">第五章：高阶函数</h3><p>　　高阶函数（First-Class Functions），支持以函数作为参数或返回值，也可将函数赋值给其它变量，由此也可引出闭包和柯里化，闭包是指将内嵌函数作为返回值，而柯里化是指将多个参数分解为独立参数传递给函数，如：<span class="math inline">\(f(args_1,args_2,...,args_n)=f(args_1)(args_2)(...)(args_n)\)</span>。下面以求函数的不动点为例：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">FirstClassFunctions</span> </span>&#123;</div><div class="line">    <span class="keyword">val</span> tolerance = <span class="number">0.0001</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">isCloseEnough</span></span>(x: <span class="type">Double</span>, y: <span class="type">Double</span>) = ((x-y) / x).abs &lt; tolerance</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fixedPoint</span></span>(f: <span class="type">Double</span> =&gt; <span class="type">Double</span>)(firstGuess: <span class="type">Double</span>) = &#123;</div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">iterate</span></span>(guess: <span class="type">Double</span>): <span class="type">Double</span> = &#123;</div><div class="line">            <span class="keyword">val</span> next = f(guess)</div><div class="line">            <span class="keyword">if</span> (isCloseEnough(guess, next)) next</div><div class="line">            <span class="keyword">else</span> iterate(next)</div><div class="line">        &#125;</div><div class="line">        iterate(firstGuess)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">averageDamp</span></span>(f: <span class="type">Double</span> =&gt; <span class="type">Double</span>)(x: <span class="type">Double</span>) = (x + f(x)) / <span class="number">2</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sqrt</span></span>(x: <span class="type">Double</span>) = fixedPoint(averageDamp(y =&gt; x/y))(<span class="number">1.0</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</div><div class="line">        println(sqrt(<span class="number">0.01</span>));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></div><p>　　该示例简单明了的展示了 Scala 中匿名函数，函数柯里化以及闭包。</p><h3 id="第六章类和对象">第六章：类和对象</h3><p>直接看下面的有理数示例吧，</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 主构造函数</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rational</span>(<span class="params">n: <span class="type">Int</span>, d: <span class="type">Int</span></span>) <span class="keyword">extends</span> <span class="title">AnyRef</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">gcd</span></span>(x: <span class="type">Int</span>, y: <span class="type">Int</span>): <span class="type">Int</span> = &#123;</div><div class="line">        <span class="keyword">if</span> (x == <span class="number">0</span>) y</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (x &lt; <span class="number">0</span>) gcd(-x, y)</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (y &lt; <span class="number">0</span>) -gcd(x, -y)</div><div class="line">        <span class="keyword">else</span> gcd(y % x, x)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">val</span> g = gcd(n, d)</div><div class="line"></div><div class="line">    <span class="comment">// 构造函数重载（辅助构造函数）</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">this</span></span>() &#123;</div><div class="line">        <span class="keyword">this</span>(<span class="number">0</span>, <span class="number">0</span>)  <span class="comment">// 调用主构造函数</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">val</span> number: <span class="type">Int</span> = <span class="keyword">if</span> (g != <span class="number">0</span>) n / g <span class="keyword">else</span> <span class="number">0</span></div><div class="line">    <span class="keyword">val</span> denom: <span class="type">Int</span> = <span class="keyword">if</span> (g != <span class="number">0</span>) d / g <span class="keyword">else</span> <span class="number">0</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">+</span></span>(that: <span class="type">Rational</span>) = <span class="keyword">new</span> <span class="type">Rational</span>(number * that.denom + that.number * denom, denom * that.denom)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">-</span></span>(that: <span class="type">Rational</span>) = <span class="keyword">new</span> <span class="type">Rational</span>(number * that.denom - that.number * denom, denom * that.denom)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">*</span></span>(that: <span class="type">Rational</span>) = <span class="keyword">new</span> <span class="type">Rational</span>(number * that.number, denom * that.denom)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">/</span></span>(that: <span class="type">Rational</span>) = <span class="keyword">new</span> <span class="type">Rational</span>(number * that.denom, denom * that.number)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">toNumber</span></span>: <span class="type">Double</span> = <span class="keyword">if</span> (denom != <span class="number">0</span>) number.toDouble / denom <span class="keyword">else</span> <span class="number">0.0</span></div><div class="line"></div><div class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">toString</span> </span>= <span class="string">""</span> + number + <span class="string">"/"</span> + denom</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">Rational</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</div><div class="line">        <span class="keyword">val</span> rational = <span class="keyword">new</span> <span class="type">Rational</span>(<span class="number">2</span>,<span class="number">1</span>) / <span class="keyword">new</span> <span class="type">Rational</span>()</div><div class="line">        println(rational.toNumber);</div><div class="line">        println(rational.toString);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></div><p>　　从有理数这个示例可以看出，Scala 的类支持操作符重载，也支持构造函数重载，同样支持继承，多继承也是支持的，每个父类用 <code>with</code> 关键字分隔就行。</p><h3 id="第七章条件类和模式匹配">第七章：条件类和模式匹配</h3><p>大致和第一章内容差不多，就不重复写了。</p><h3 id="第八章泛型">第八章：泛型</h3><p>　　大致也和第一章内容差不多，<em>值得一提的书中实现的泛型栈本质是一个链表，实现方法挺有意思的</em>。通过 <code>&lt;:</code> 标识符可约束泛型的类型，如 <code>[T &lt;: P[T]]</code> 表明泛型 T 必须类型 P 的子类型。而标识符 <code>&lt;%</code> 比 <code>&lt;:</code> 约束性弱一点，只要 T 能够通过隐式类型变换为 P 即可。若想约束为父类型，则需使用 <code>&gt;:</code> 标识符。</p><p>　　Scala 中有一种特殊的泛型，就是变化型注解，<code>trait List[+T]</code> 代表协变，表示当 B 类型是 A 类型子类时，<code>List[B]</code> 也可认为是 <code>List[A]</code> 的子类；<code>trait List[-T]</code> 代表逆变，当 B 类型是 A 类型子类时，<code>List[B]</code> 可认为是 <code>List[A]</code> 的父类。</p><p>　　Scala 中同样有元组，使用时也很方便，简单使用直接用括号声明即可，如 <code>def divmod(x: Int, y: Int): (Int, Int) = (x / y, x % y)</code>，该函数即返回一个元组，也可声明一个元组 <code>case class Tuple2[A, B](_1: A, _2: B)</code>，若需要取元组的元素可通过 <code>_i</code> 的方式，如 <code>val xy = divmod(3, 4); xy._1; xy._2;</code>，也可通过 match-case 语句取，如 <code>xy match { case (n, d) =&gt; println(&quot;quotient: &quot; + n + &quot;, rest: &quot; + d) }</code>。</p><h3 id="第九章list">第九章：List</h3><p>　　Scala 中的 List 其实是数组结构，并且是不可变的，可认为是 C++ 里的静态数组，不能往其中添加或删除元素，下面用数组排序示例下 List 的用法：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">Sort</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">insertSort</span></span>(xsl: <span class="type">List</span>[<span class="type">Int</span>]): <span class="type">List</span>[<span class="type">Int</span>] = &#123;</div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">insert</span></span>(x: <span class="type">Int</span>, xs: <span class="type">List</span>[<span class="type">Int</span>]): <span class="type">List</span>[<span class="type">Int</span>] = &#123;</div><div class="line">            xs <span class="keyword">match</span> &#123;</div><div class="line">                <span class="comment">// case Nil =&gt; List(x)</span></div><div class="line">                <span class="keyword">case</span> <span class="type">List</span>() =&gt; <span class="type">List</span>(x)</div><div class="line">                <span class="keyword">case</span> y :: ys =&gt; <span class="keyword">if</span> (x &lt;= y) x :: xs <span class="keyword">else</span> y :: insert(x, ys)</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (xsl.isEmpty) <span class="type">Nil</span></div><div class="line">        <span class="keyword">else</span> insert(xsl.head, insertSort(xsl.tail))</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mergeSort</span></span>[<span class="type">A</span>](less: (<span class="type">A</span>, <span class="type">A</span>) =&gt; <span class="type">Boolean</span>)(xs: <span class="type">List</span>[<span class="type">A</span>]): <span class="type">List</span>[<span class="type">A</span>] = &#123;</div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">merge</span></span>(xs1: <span class="type">List</span>[<span class="type">A</span>], xs2: <span class="type">List</span>[<span class="type">A</span>]): <span class="type">List</span>[<span class="type">A</span>] = &#123;</div><div class="line">            <span class="keyword">if</span> (xs1.isEmpty) xs2</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (xs2.isEmpty) xs1</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (less(xs1.head, xs2.head)) xs1.head :: merge(xs1.tail, xs2)</div><div class="line">            <span class="keyword">else</span>  xs2.head :: merge(xs1, xs2.tail)</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">val</span> n = xs.length / <span class="number">2</span></div><div class="line">        <span class="keyword">if</span> (n == <span class="number">0</span>) xs</div><div class="line">        <span class="keyword">else</span> merge(mergeSort(less)(xs take n), mergeSort(less)(xs drop n))</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</div><div class="line">        <span class="keyword">val</span> xs = <span class="type">List</span>(<span class="number">4</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>, <span class="number">2</span>, <span class="number">6</span>);</div><div class="line">        <span class="comment">// val xs = 3::2::1::1::Nil;</span></div><div class="line">        println(xs(<span class="number">0</span>), xs(<span class="number">1</span>), xs(xs.length<span class="number">-1</span>)) <span class="comment">// (4,1,6)</span></div><div class="line">        <span class="comment">// val ys = insertSort(xs);</span></div><div class="line">        <span class="keyword">val</span> ys = mergeSort((x: <span class="type">Int</span>, y: <span class="type">Int</span>) =&gt; x &gt; y)(xs);</div><div class="line">        println(ys.mkString(<span class="string">" "</span>))</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></div><p>　　List 中有两个操作符非常类似，即 <code>::</code> 和 <code>:::</code>， 前者用于 List 中的元素和 List 连接，即创建一个新 List，新 List 为原 List 头插入元素后的 List，后者用于连接两个 List，即创建一个新 List ，新 List 为将第二个 List 的元素全部放入第一个 List 尾部的 List。字符 <code>Nil</code> 代表空 List 和 <code>List()</code> 等效，<code>head</code> 方法返回 List 的第一个元素，<code>tail</code> 方法返回除第一个元素之外的其它所有元素，还是一个 List，<code>isEmpty</code> 方法当 List 为空时返回 <code>true</code>。List 的 case-match 方法中，<code>case y :: ys</code> 其中 y 代表 xs.head，ys 代表 xs.tail。<code>(xs take n)</code> 表示取 List 前 n 个元素，<code>(xs drop n)</code> 表示取 List 前 n 个元素之外的元素，即与 (xs take n) 取得元素正好互补，而 <code>(xs split n)</code> 返回一个元组，元组中第一个元素为 (xs take n)，第二个元素为 (xs drop n)。关于 List 还有些更高阶得方法：filter，map, flatMap, reduceRight, foldRight 等方法就不继续写了。至于动态 List 可用 <code>ListBuffer</code> 结构，当然 Scala 中直接用 <code>Seq</code> 作为返回值和参数一般会更好些。</p><h3 id="第十章序列理解">第十章：序列理解</h3><p>　　Scala 中用来做序列理解的表达式是 <code>For-Comprehensions</code>，具体示例如下：<code>for (p &lt;persons if p.age &gt; 20) yield p.name</code> 相当于 <code>persons filter (p =&gt; p.age &gt; 20) map (p =&gt; p.name)</code>，可以简单认为 for-yield 方法是 filter 和 map 的集合体。下面具体用个 N-皇后（特例是 8 皇后）的示例来具体说明：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">NQueen</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">queens</span></span>(n: <span class="type">Int</span>): <span class="type">List</span>[<span class="type">List</span>[<span class="type">Int</span>]] = &#123;</div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">isSafe</span></span>(col: <span class="type">Int</span>, queenList: <span class="type">List</span>[<span class="type">Int</span>], delta: <span class="type">Int</span>): <span class="type">Boolean</span> = &#123;</div><div class="line">            <span class="keyword">val</span> curRow = queenList.length<span class="number">-1</span> + delta</div><div class="line">            <span class="keyword">for</span> (row &lt;- <span class="type">List</span>.range(<span class="number">0</span>, queenList.length)) &#123;</div><div class="line">                <span class="keyword">val</span> queenCol = queenList(row)</div><div class="line">                <span class="keyword">val</span> queenRow = queenList.length<span class="number">-1</span> - row</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (queenCol == col) <span class="keyword">return</span> <span class="literal">false</span></div><div class="line">                <span class="keyword">if</span> (queenRow == curRow) <span class="keyword">return</span> <span class="literal">false</span></div><div class="line">                <span class="keyword">if</span> ((queenCol - col).abs == (queenRow - curRow).abs) <span class="keyword">return</span> <span class="literal">false</span></div><div class="line">            &#125;</div><div class="line">            <span class="literal">true</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">placeQueens</span></span>(k: <span class="type">Int</span>): <span class="type">List</span>[<span class="type">List</span>[<span class="type">Int</span>]] = &#123;</div><div class="line">            <span class="keyword">if</span> (k == <span class="number">0</span>) <span class="type">List</span>(<span class="type">List</span>())</div><div class="line">            <span class="keyword">else</span> <span class="keyword">for</span> &#123; </div><div class="line">                queens &lt;- placeQueens(k<span class="number">-1</span>);</div><div class="line">                column &lt;- <span class="type">List</span>.range(<span class="number">0</span>, n);</div><div class="line">                <span class="keyword">if</span> isSafe(column, queens, <span class="number">1</span>) </div><div class="line">            &#125; <span class="keyword">yield</span> column :: queens</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        placeQueens(n)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</div><div class="line">        <span class="keyword">val</span> queenList = queens(<span class="number">8</span>);</div><div class="line">        println(<span class="string">"queenCount: "</span> + queenList.length)  <span class="comment">// 92</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></div><p>for-yield 表达式中 for 中可以写多条语句，代表多重循环，第 5 行的 for 代表 for 循环，<code>&lt;-</code> 表示取 List 中的元素。</p><hr><p>　　剩下的几章就没啥特别要写的，重点就两个特性，一个是 Stream ，一个 Lazy，Stream 和 List 有点类似，主要区别在于 Stream 是即时返回的，算一个返回一个，而 List 一般是全部计算完再返回一个 List；Lazy 一般用作常量的修饰符，主要作用是只用该常量被用到时才赋值，否则一直为空，有点类似常见的先判空再取值的封装。</p><h2 id="后记">后记</h2><p>　　曾看到过通过刷题去学习新语言的方式，一直都以为很粗暴，但这次照着「Scala By Example」敲下来，感觉还挺有效的，同时也巩固了一下基本的算法知识，后续再把 twitter 的 「Effective Scala」再看一下应该就差不多了。</p></div><div class="article-content-more"><button type="button" class="article-more--link"><i class="fa fa-angle-double-down fa-3x" aria-hidden="true"></i></button></div></section></article><article id="post-时空查询之ECQL" class="article div-border"><header class="article-header"><span class="article-date article-title--index"><i class="fa fa-calendar" aria-hidden="true"></i> <a href="/posts/489fa7b3.html"><time datetime="2021-01-23T12:59:21.000Z">2021-01-23</time></a></span><section class="article-title article-title--index"><a href="/posts/489fa7b3.html">时空查询之ECQL</a></section><div class="article-label"><div class="article-category label"><i class="fa fa-book" aria-hidden="true"></i> <a class="color1 article-category-link" href="/categories/Study/">Study</a></div><div class="article-tag label"><i class="fa fa-bookmark" aria-hidden="true"></i> <a class="color4 article-tag-link" href="/tags/language/">language</a></div></div></header><section class="article-content"><div class="article-content--excerpt"><h2 id="前言">前言</h2><p>　　ECQL 是 CQL 的扩展，CQL 是 OGC 标准查询语言，而 ECQL 是 GeoTools 为更好的方便查询，在编程实现时扩展了 CQL，主要扩展在于其移除了 CQL 的一些限制（属性必须在比较运算符的左边，不能创建 Id Filter 进行查询等限制），也和 SQL 更相似。所以可简单认为 CQL 是书面上的标准，而 ECQL 是事实上的标准。</p></div><div class="article-content--all"><h2 id="前言">前言</h2><p>　　ECQL 是 CQL 的扩展，CQL 是 OGC 标准查询语言，而 ECQL 是 GeoTools 为更好的方便查询，在编程实现时扩展了 CQL，主要扩展在于其移除了 CQL 的一些限制（属性必须在比较运算符的左边，不能创建 Id Filter 进行查询等限制），也和 SQL 更相似。所以可简单认为 CQL 是书面上的标准，而 ECQL 是事实上的标准。</p><a id="more"></a><h2 id="谓词篇">谓词篇</h2><p>时间查询主要有以下几个查询谓词：</p><table><colgroup><col style="width:36%"><col style="width:63%"></colgroup><thead><tr class="header"><th>谓词</th><th>作用</th></tr></thead><tbody><tr class="odd"><td>T <strong>TEQUALS</strong> Time</td><td>测试 T 和给定时间相等，相当于 T == Time。</td></tr><tr class="even"><td>T <strong>BEFORE</strong> Time</td><td>测试 T 在给定时间之前，相当于 T &lt; Time。</td></tr><tr class="odd"><td>T <strong>BEFORE OR DURING</strong> Time Period</td><td>测试 T 在给定时间段之前或其中，相当于 T &lt;= TimePeriod[1]。</td></tr><tr class="even"><td>T <strong>DURING</strong> Time Period</td><td>测试 T 在给定时间段其中，相当于 TimePeriod[0] &lt;= T &lt;= TimePeriod[1]。</td></tr><tr class="odd"><td>T <strong>DURING OR AFTER</strong> Time Period</td><td>测试 T 在给定时间段其中或之后，相当于 TimePeriod[0] &lt;= T。</td></tr><tr class="even"><td>T <strong>AFTER</strong> Time</td><td>测试 T 在给定时间之后，相当于 T &gt; Time。</td></tr></tbody></table><p>时间段以 <code>/</code> 分隔符区分前后两个时间，时间格式一般为 yyyy-MM-dd’T’HH:mm:ss.SSS’Z’。</p><p>空间查询主要有以下几个查询谓词：</p><table><colgroup><col style="width:50%"><col style="width:50%"></colgroup><thead><tr class="header"><th>谓词</th><th>作用</th></tr></thead><tbody><tr class="odd"><td><strong>INTERSECTS</strong>(A: Geometry, B: Geometry)</td><td>测试 A 与 B 相交，与 DISJOINT 相反。</td></tr><tr class="even"><td><strong>DISJOINT</strong>(A: Geometry, B: Geometry)</td><td>测试 A 与 B 不相交，与 INTERSECTS 相反。</td></tr><tr class="odd"><td><strong>CONTAINS</strong>(A: Geometry, B: Geometry)</td><td>测试 A 包含 B，与 WITHIN 相反。</td></tr><tr class="even"><td><strong>WITHIN</strong>(A: Geometry, B: Geometry)</td><td>测试 B 包含 A，即 A 在 B 中，与 CONTAINS 相反。</td></tr><tr class="odd"><td><strong>TOUCHES</strong>(A: Geometry, B: Geometry)</td><td>测试 A 的边界是否与 B 的边界接触，但内部不相交。</td></tr><tr class="even"><td><strong>CROSSES</strong>(A: Geometry, B: Geometry)</td><td>测试 A 与 B 是否相交，但不存在包含关系。</td></tr><tr class="odd"><td><strong>OVERLAPS</strong>(A: Geometry, B: Geometry)</td><td>测试 A 与 B 是否重叠，需满足 A 与 B 是同一类型（如都是 POLYGON），并且相交区域同样是 A 和 B 的类型（只能是 POLYGON，不能是 POINT）。</td></tr><tr class="even"><td><strong>EQUALS</strong>(A: Geometry, B: Geometry)</td><td>测试 A 与 B 完全相等。</td></tr><tr class="odd"><td><strong>RELATE</strong>(A: Geometry, B: Geometry, nineIntersectionModel: String)</td><td>测试 A 与 B 是否满足 <strong>DE-9IM</strong> 模型，该模型可模拟上述所有情况。</td></tr><tr class="even"><td><strong>DWITHIN</strong>(A: Geometry, B: Geometry, distance: double, units: String)</td><td>测试 A 与 B 的最短距离是否不超过多少距离，单位有（<code>feet</code>, <code>meters</code>, <code>statute miles</code>, <code>nautical miles</code>, <code>kilometers</code>）。</td></tr><tr class="odd"><td><strong>BEYOND</strong>(A: Geometry, B: Geometry, distance: Double, units: String)</td><td>测试 A 与 B 的最短距离是否超过多少距离。</td></tr><tr class="even"><td><strong>BBOX</strong>(A: Geometry, leftBottomLng: Double, leftBottomLat: Double, rightTopLng: Double, rightTopLat: Double, crs=“EPSG:4326”)</td><td>测试 A 是否与给定 box 相交。</td></tr></tbody></table><p>Geometry 是指 WKT 格式的数据，主要有以下几种：</p><table><colgroup><col style="width:26%"><col style="width:73%"></colgroup><thead><tr class="header"><th>类型</th><th>示例</th></tr></thead><tbody><tr class="odd"><td><strong>POINT</strong></td><td>POINT(6 10)</td></tr><tr class="even"><td><strong>LINESTRING</strong></td><td>LINESTRING(3 4,10 50,20 25)</td></tr><tr class="odd"><td><strong>POLYGON</strong></td><td>POLYGON((1 1,5 1,5 5,1 5,1 1),(2 2,2 3,3 3,3 2,2 2))</td></tr><tr class="even"><td><strong>MULTIPOINT</strong></td><td>MULTIPOINT(3.5 5.6, 4.8 10.5)</td></tr><tr class="odd"><td><strong>MULTILINESTRING</strong></td><td>MULTILINESTRING((3 4,10 50,20 25),(-5 -8,-10 -8,-15 -4))</td></tr><tr class="even"><td><strong>MULTIPOLYGON</strong></td><td>MULTIPOLYGON(((1 1,5 1,5 5,1 5,1 1),(2 2,2 3,3 3,3 2,2 2)),((6 3,9 2,9 4,6 3)))</td></tr><tr class="odd"><td><strong>GEOMETRYCOLLECTION</strong></td><td>GEOMETRYCOLLECTION(POINT(4 6),LINESTRING(4 6,7 10))</td></tr></tbody></table><p><strong><em>※注：</em></strong> POLYGON 中的边界点必须闭合，即首尾点相同，若存在多个边界，则需要遵循 逆时针,顺时针,逆时针,顺时针… 的点排列顺序，逆时针封闭，顺时针开孔，以形成具有岛和洞的复杂多边形。</p><p>　　由于 WKT 标准只支持二维的坐标，为支持三维坐标以及齐次线性计算，所以在 PostGIS 中又有 EWKT 标准实现，EWKT 扩展了 WKT，带 <code>Z</code> 结尾用来支持三维坐标，带 <code>M</code> 结尾用来支持齐次线性计算，如 <code>POINTZ(6 10 3)</code>，<code>POINTM(6 10 1)</code>，<code>POINTZM(6 10 3 1)</code>，同时还支持坐标内嵌空间参考系，如 <code>SRID=4326;LINESTRING(-134.921387 58.687767, -135.303391 59.092838)</code>。GeoTools 19.0 之后也默认以 EWKT 进行解析和编码。</p><h2 id="查询篇">查询篇</h2><h3 id="属性字段查询">属性字段查询</h3><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="PLAIN"><figure class="highlight hljs plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">// 查询属性 ATTR1 小于 7 的数据</div><div class="line">Filter filter = ECQL.toFilter(&quot;ATTR1 &lt; (1 + ((3 / 2) * 4))&quot; );</div><div class="line"></div><div class="line">// 查询属性 ATTR1 小于属性 ATTR2 绝对值的数据</div><div class="line">Filter filter = ECQL.toFilter(&quot;ATTR1 &lt; abs(ATTR2)&quot; );</div><div class="line"></div><div class="line">// 查询属性 ATTR1 为 test 字符串的数据</div><div class="line">Filter filter = ECQL.toFilter(&quot;ATTR1 == &apos;test&apos;&quot; );</div><div class="line"></div><div class="line">// 查询属性 ATTR1 在 10 和 20 之间的数据</div><div class="line">Filter filter = ECQL.toFilter( &quot;ATTR1 BETWEEN 10 AND 20&quot; );</div><div class="line">Filter filter = ECQL.toFilter( &quot;ATTR1 &gt;= 10 AND ATTR1 &lt;= 20&quot; );</div><div class="line"></div><div class="line">// 多条件查询</div><div class="line">Filter filter = ECQL.toFilter(&quot;ATTR1 &lt; 10 AND ATTR2 &lt; 2 OR ATTR3 &gt; 10&quot; );</div><div class="line"></div><div class="line">// 查询属性 ATTR1 为 silver 或 oil 或 gold 的数据</div><div class="line">Filter filter = ECQL.toFilter(&quot;ATTR1 IN (&apos;silver&apos;,&apos;oil&apos;, &apos;gold&apos; )&quot;);</div><div class="line"></div><div class="line">// 以 ID 主键进行查询</div><div class="line">Filter filter = ECQL.toFilter(&quot;IN (&apos;river.1&apos;, &apos;river.2&apos;)&quot;);</div><div class="line">Filter filter = ECQL.toFilter(&quot;IN (300, 301)&quot;);</div></pre></td></tr></table></figure></div><h3 id="模糊查询">模糊查询</h3><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="PLAIN"><figure class="highlight hljs plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">// 查询属性 ATTR1 包含 abc 字符串的数据</div><div class="line">Filter filter = ECQL.toFilter( &quot;ATTR1 LIKE &apos;%abc%&apos;&quot; );</div><div class="line"></div><div class="line">// 查询属性 ATTR1 开头不为 abc 字符串的数据</div><div class="line">Filter filter = ECQL.toFilter( &quot;ATTR1 NOT LIKE &apos;abc%&apos;&quot; );</div><div class="line"></div><div class="line">// 查询属性 cityName 开头为 new 的数据，忽略 new 的大小写</div><div class="line">Filter filter = ECQL.toFilter(&quot;cityName ILIKE &apos;new%&apos;&quot;);</div><div class="line"></div><div class="line">// 测试字符串是否包含</div><div class="line">Filter filter = ECQL.toFilter(&quot;&apos;aabbcc&apos; LIKE &apos;%bb%&apos;&quot;);</div></pre></td></tr></table></figure></div><h3 id="空属性查询">空属性查询</h3><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="PLAIN"><figure class="highlight hljs plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">// 查询有属性 ATTR1 存在的数据</div><div class="line">Filter filter = ECQL.toFilter( &quot;ATTR1 EXISTS&quot; );</div><div class="line"></div><div class="line">// 查询属性 ATTR1 不存在的数据</div><div class="line">Filter filter = ECQL.toFilter( &quot;ATTR1 DOES-NOT-EXIST&quot; );</div><div class="line"></div><div class="line">// 查询 Name 为 NULL 的数据</div><div class="line">Filter filter = ECQL.toFilter(&quot;Name IS NULL&quot;);</div></pre></td></tr></table></figure></div><h3 id="时间查询">时间查询</h3><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="PLAIN"><figure class="highlight hljs plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">// 查询时间属性 dtg 等于的数据</div><div class="line">Filter filter = ECQL.toFilter( &quot;dtg TEQUALS 2006-11-30T01:30:00Z&quot; );</div><div class="line"></div><div class="line">// 查询时间属性 dtg 在之后的数据</div><div class="line">Filter filter = ECQL.toFilter(&quot;dtg AFTER 2006-11-30T01:30:00Z&quot;);</div><div class="line"></div><div class="line">// 查询时间属性 dtg 在之前的数据</div><div class="line">Filter filter = ECQL.toFilter(&quot;dtg BEFORE 2006-11-30T01:30:00Z&quot;);</div><div class="line"></div><div class="line">// 查询时间属性 dtg 在之间的数据，+3:00 代表 GMT 时间 +3 小时，以 Z 结尾的时间就是 GMT 时间</div><div class="line">Filter filter = ECQL.toFilter( &quot;dtg DURING 2006-11-30T00:30:00+03:00/2006-11-30T01:30:00+03:00 &quot;);</div><div class="line"></div><div class="line">// 查询时间属性 dtg 等于的数据</div><div class="line">Filter filter = ECQL.toFilter(&quot;dtg = 1981-06-20&quot;);</div><div class="line"></div><div class="line">// 查询时间属性 dtg 小于等于的数据</div><div class="line">Filter filter = ECQL.toFilter(&quot;dtg &lt;= 1981-06-20T12:30:01Z&quot;);</div></pre></td></tr></table></figure></div><h3 id="空间查询">空间查询</h3><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="PLAIN"><figure class="highlight hljs plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">// 查询空间属性 geom 包含点的数据</div><div class="line">Filter filter = ECQL.toFilter( &quot;CONTAINS(geom, POINT(1 2))&quot; );</div><div class="line"></div><div class="line">// 查询空间属性 geom 与 box 相交的数据</div><div class="line">Filter filter = ECQL.toFilter( &quot;BBOX(geom, 10,20,30,40)&quot; );</div><div class="line"></div><div class="line">// 查询空间属性 geom 与点最短距离不超过 10 千米的数据</div><div class="line">Filter filter = ECQL.toFilter( &quot;DWITHIN(geom, POINT(1 2), 10, kilometers)&quot; );</div><div class="line"></div><div class="line">// 查询空间属性 geom 与线相交的数据（geom 也必须是线）</div><div class="line">Filter filter = ECQL.toFilter( &quot;CROSS(geom, LINESTRING(1 2, 10 15))&quot; );</div><div class="line"></div><div class="line">// 查询空间属性 geom 与 GEOMETRYCOLLECTION 相交的数据（geom 也必须是 GEOMETRYCOLLECTION）</div><div class="line">Filter filter = ECQL.toFilter( &quot;INTERSECT(geom, GEOMETRYCOLLECTION (POINT (10 10),POINT (30 30),LINESTRING (15 15, 20 20)) )&quot; );</div><div class="line"></div><div class="line">// 查询空间属性 geom 与线相交的数据</div><div class="line">Filter filter = ECQL.toFilter( &quot;CROSSES(geom, LINESTRING(1 2, 10 15))&quot; );</div><div class="line"></div><div class="line">// 查询空间属性 geom 与 GEOMETRYCOLLECTION 相交的数据</div><div class="line">Filter filter = ECQL.toFilter( &quot;INTERSECTS(geom, GEOMETRYCOLLECTION (POINT (10 10),POINT (30 30),LINESTRING (15 15, 20 20)) )&quot; );</div><div class="line"></div><div class="line">// 查询空间属性 geom 与包含线的数据</div><div class="line">Filter filter = ECQL.toFilter(&quot;RELATE(geom, LINESTRING (-134.921387 58.687767, -135.303391 59.092838), T*****FF*)&quot;);</div></pre></td></tr></table></figure></div><hr><p>　　在 GeoTools 中，可通过 FilterFactory 来构造 Filter，而不是直接写字符串，具体示例如下：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="JAVA"><figure class="highlight hljs java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">FilterFactory2 ff = CommonFactoryFinder.getFilterFactory2();</div><div class="line"></div><div class="line"><span class="comment">// 相当于 Filter filter1 = ECQL.toFilter("ATTR1 = 1 AND ATTR2 &lt; 4" );</span></div><div class="line">List&lt;Filter&gt; filterList = ECQL.toFilterList(<span class="string">"ATTR1=1; ATTR2&lt;4"</span>);</div><div class="line">Filter filter1 = ff.and(filterList);</div><div class="line"></div><div class="line"><span class="comment">// 相当于 Filter filter2 = ECQL.toFilter( "BBOX(geom, 10,20,30,40)" );</span></div><div class="line">Filter filter2 = ff.bbox(<span class="string">"geom"</span>, <span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>, <span class="string">"EPSG:4326"</span>);</div><div class="line"></div><div class="line"><span class="comment">// 相当于 Filter filter3 = ECQL.toFilter( "dtg DURING 2006-11-29T00:30:00Z/2006-11-30T00:30:00Z");</span></div><div class="line">Date startTime = ZonedDateTime.of(<span class="number">2006</span>, <span class="number">11</span>, <span class="number">29</span>, <span class="number">0</span>, <span class="number">30</span>, <span class="number">0</span>, <span class="number">0</span>, ZoneOffset.UTC);</div><div class="line">Date endTime = Date.from(startTime.plusDays(<span class="number">1</span>).toInstant());</div><div class="line">Filter filter3 = ff.between(ff.property(<span class="string">"dtg"</span>), ff.literal(startTime), ff.literal(endTime));</div></pre></td></tr></table></figure></div><h2 id="后记">后记</h2><p>　　基本可认为 CQL 和 SQL 中查询条件差不多，虽然不支持分组查询等复杂 SQL 特性，但对于一般的时空查询基本够用，CQL 中还有些空间操作函数就不继续写了，如取面积，取缓冲区，取交集，取长度等等，有需要的可自行查询 <a href="http://udig.github.io/docs/user/concepts/Constraint%20Query%20Language.html" target="_blank" rel="external">uDig Common Query Language</a>。</p><h2 id="参考资料">参考资料</h2><p><a href="http://docs.geotools.org/latest/userguide/library/cql/cql.html" target="_blank" rel="external">GeoTools CQL</a></p><p><a href="http://docs.geotools.org/stable/userguide/library/cql/ecql.html" target="_blank" rel="external">GeoTools ECQL</a></p><p><a href="https://docs.geoserver.org/latest/en/user/filter/ecql_reference.html#ecql-reference" target="_blank" rel="external">GeoServer ECQL Reference</a> / <a href="https://blog.csdn.net/neimeng0/article/details/79914880" target="_blank" rel="external">GeoServer 属性查询和空间查询支持 CQL / ECQL过滤器语言</a></p><p><a href="https://blog.csdn.net/ucs426/article/details/99780891" target="_blank" rel="external">WKT解读</a></p><p><a href="https://www.cnblogs.com/denny402/p/4968201.html" target="_blank" rel="external">GEOS库学习之三：空间关系、DE-9IM和谓词</a></p></div><div class="article-content-more"><button type="button" class="article-more--link"><i class="fa fa-angle-double-down fa-3x" aria-hidden="true"></i></button></div></section></article><article id="post-GeoMesa踩坑指北" class="article div-border"><header class="article-header"><span class="article-date article-title--index"><i class="fa fa-calendar" aria-hidden="true"></i> <a href="/posts/9978824c.html"><time datetime="2021-01-16T09:52:09.000Z">2021-01-16</time></a></span><section class="article-title article-title--index"><a href="/posts/9978824c.html">GeoMesa踩坑指北</a></section><div class="article-label"><div class="article-category label"><i class="fa fa-book" aria-hidden="true"></i> <a class="color3 article-category-link" href="/categories/Study/">Study</a></div><div class="article-tag label"><i class="fa fa-bookmark" aria-hidden="true"></i> <a class="color2 article-tag-link" href="/tags/bigdata/">bigdata</a><a class="color2 article-tag-link" href="/tags/geomesa/">geomesa</a></div></div></header><section class="article-content"><div class="article-content--excerpt"><h2 id="前言">前言</h2><p>　　需要做个 GeoMesa 的微服务，简单熟悉一下 GeoMesa。</p></div><div class="article-content--all"><h2 id="前言">前言</h2><p>　　需要做个 GeoMesa 的微服务，简单熟悉一下 GeoMesa。</p><a id="more"></a><h2 id="基础篇">基础篇</h2><p>　　GeoMesa 可以说是大数据中的 PostGIS，主要用来在存储和处理 GIS 数据时提供相应的索引，从而加快处理速度。GeoMesa 基于 GeoTools，其中最重要的两个概念就是 SimpleFeatureType 和 SimpleFeature，SimpleFeatureType 对应的是关系型数据库中表的描述（表明，表的列字段属性信息等），而 SimpleFeature 对应的是表中每行数据。下面重点谈谈 GeoMesa 中的 SimpleFeatureType 以及其创建索引方式。</p><p>　　在 GeoMesa 中通常使用 SimpleFeatureTypes.createType 方法进行创建，该方法有两个重载，以没有 namespace 参数的方法为例：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">createType</span></span>(typeName: <span class="type">String</span>, spec: <span class="type">String</span>): <span class="type">SimpleFeatureType</span> = &#123;</div><div class="line">    <span class="keyword">val</span> (namespace, name) = parseTypeName(typeName)</div><div class="line">    createType(namespace, name, spec)</div><div class="line">&#125;</div></pre></td></tr></table></figure></div><p>先通过 parseTypeName 解析 typeName，以 <code>:</code> 作为分隔符，取最后一个有效（不为空）字符串作为表名（name），其余部分如有效则作为 namespace，否则 namespace 则为 null。spec 参数的通用形式有以下几种：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">val</span> spec = <span class="string">"name:String,dtg:Date,*geom:Point:srid=4326"</span></div><div class="line"></div><div class="line"><span class="keyword">val</span> spec = <span class="string">"name:String,dtg:Date,*geom:Point:srid=4326;geomesa.indices.enabled='z2,id,z3'"</span></div><div class="line"></div><div class="line"><span class="keyword">val</span> spec = <span class="string">"name:String:index=true,tags:String:json=true,dtg:Date:default=true,*geom:Point:srid=4326;geomesa.indices.enabled='z2,id,z3'"</span></div><div class="line"></div><div class="line"><span class="keyword">val</span> spec = <span class="string">"userId:String,trackId:String,altitude:Double,dtg:Date,*geom:Point:srid=4326;geomesa.index.dtg='dtg',geomesa.table.sharing='true',geomesa.indices='z3:4:3,z2:3:3,id:2:3',geomesa.table.sharing.prefix='\\u0001'"</span></div></pre></td></tr></table></figure></div><p>先使用 <code>;</code> 分隔符，再使用 <code>,</code> 分隔符，最后使用 <code>:</code> 分隔符。<code>;</code> 分隔符将 spec 分割为两个字符串：前者表示表中的全部列属性信息，列属性经过 <code>,</code> 分隔符分割为多列，列又经过 <code>:</code> 分隔符分割为 列名，列数据类型，列的一些属性（是否是索引，json 数据，默认索引等），而列名首字母 <code>*</code> 代表该字段是用于索引的 geometry 类型，一般采用 WKT 格式进行描述，当然存在数据库时会以字节码进行压缩；后者表示创建表时的 userData，同样经过 <code>,</code> 分隔符分割为多个 userData，userData 的一些默认属性可在 SimpleFeatureTypes.Configs 中看到，其它的可以用户自定义，这里重点说一下 <code>geomesa.indices.enabled</code> 属性，目前 GeoMesa 支持 8 种索引，分别为：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="PLAIN"><figure class="highlight hljs plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&quot;attr&quot;, // 属性索引</div><div class="line">&quot;id&quot;, // 主键索引</div><div class="line">&quot;s2&quot;, // Hilbert 曲线点空间索引</div><div class="line">&quot;s3&quot;, // Hilbert 曲线点时空索引</div><div class="line">&quot;z2&quot;, // Z 型曲线点空间索引</div><div class="line">&quot;xz2&quot;, // Z 型曲线线面空间索引</div><div class="line">&quot;z3&quot;,  // Z 型曲线点时空索引</div><div class="line">&quot;xz3&quot; // Z 型曲线线面时空索引</div></pre></td></tr></table></figure></div><p>　　由于 GeoMesa 中的索引一般存在多个版本，而 <code>geomesa.indices.enabled</code> 默认使用最新的版本，若需要指定版本，需要使用 <code>geomesa.indices</code>，<strong><em>该属性是 geomesa 内部属性，不对外开放</em></strong>，通用格式为：</p><p></p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">s"<span class="subst">$name</span>:<span class="subst">$version</span>:<span class="subst">$&#123;mode.flag&#125;</span>:<span class="subst">$&#123;attributes.mkString(":")&#125;</span>"</span></div></pre></td></tr></table></figure></div><p></p><p>name 代表索引类别，version 代表索引版本，mode.flag 代表索引模式（是否支持读写，一般为3，支持读也支持写），attributes 代表是哪些字段需要建立该索引。spec 参数可以只有描述列属性的字段，即不带任何 useData 信息，GeoMesa 会默认添加索引信息，若存在空间和时间字段，则会默认建立 z3（空间字段为点 Point 类型） 或 xz3（空间字段为线面 非Point 类型） 索引，若有多个空间和时间字段，建立索引的字段为第一个空间和第一个时间字段；若只存在空间字段，则会建立 z2 或 xz2 索引；若只有时间字段，则默认建立时间属性索引。当然如没有在 spec 指明索引信息，可以在后续继续添加信息，如下：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="JAVA"><figure class="highlight hljs java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.locationtech.geomesa.utils.interop.SimpleFeatureTypes;</div><div class="line"></div><div class="line">String spec = <span class="string">"name:String,dtg:Date,*geom:Point:srid=4326"</span>;</div><div class="line">SimpleFeatureType sft = SimpleFeatureTypes.createType(<span class="string">"mySft"</span>, spec);</div><div class="line"><span class="comment">// enable a default z3 and a default attribute index</span></div><div class="line">sft.getUserData().put(<span class="string">"geomesa.indices.enabled"</span>, <span class="string">"z3,attr:name"</span>);</div><div class="line"><span class="comment">// or, enable a default z3 and an attribute index with a Z2 secondary index</span></div><div class="line">sft.getUserData().put(<span class="string">"geomesa.indices.enabled"</span>, <span class="string">"z3,attr:name:geom"</span>);</div><div class="line"><span class="comment">// or, enable a default z3 and an attribute index with a temporal secondary index</span></div><div class="line">sft.getUserData().put(<span class="string">"geomesa.indices.enabled"</span>, <span class="string">"z3,attr:name:dtg"</span>);</div></pre></td></tr></table></figure></div><h2 id="坑篇">坑篇</h2><h3 id="导入-osm-数据问题">导入 OSM 数据问题</h3><p>　　在<a href="https://www.geomesa.org/documentation/stable/user/convert/premade/osm.html" target="_blank" rel="external">导入 osm 数据</a>时，若使用 osm-ways 作为 SimpleFeatureType，则 geomesa 会使用数据库存储 node 临时使用，这时其默认使用 H2 Database，若想使用其它数据库，则需要在 lib 导入相应 jdbc 包，若使用 postgresql 数据库，则 geomesa 会触发一个 bug，因为 postgresql 没有 double 类型，只有 double precision 类型，这将导致建表出错。详情见 geomesa/geomesa-convert/geomesa-convert-osm/src/main/scala/org/locationtech/geomesa/convert/osm/OsmWaysConverter.scala 中</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SCALA"><figure class="highlight hljs scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">createNodesTable</span></span>(): <span class="type">Unit</span> = &#123;</div><div class="line">    <span class="keyword">val</span> sql = <span class="string">"create table nodes(id BIGINT NOT NULL PRIMARY KEY, lon DOUBLE, lat DOUBLE);"</span></div><div class="line">    <span class="type">WithClose</span>(connection.prepareStatement(sql))(_.execute())</div><div class="line">&#125;</div></pre></td></tr></table></figure></div><p>所以若需要使用 geomesa-convert-osm 导入 osm 数据时，需要进入 geomesa/geomesa-convert/geomesa-convert-osm 文件夹中输入命令</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SH"><figure class="highlight hljs sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mvn dependency:copy-dependencies -DoutputDirectory=./depLib</div></pre></td></tr></table></figure></div><p>导出 geomesa-convert-osm 依赖包，将其中的 h2，osm4j，dynsax，trove4j 等一系列库放入 $GEOMESA_HBASE_HOME/lib 中。</p><h3 id="s2-索引问题">s2 索引问题</h3><p>　　s2 索引即 Google S2 Geometry 算法基于 Hilbert 曲线生成一种索引，GeoMesa 的 s2 索引是一个国人提交的，目前 3.2 版本只支持点的时空索引，不支持线面的时空索引，当然官方也在实现自己的 Hilbert 曲线，希望后续 GeoMesa 中会有 h2 索引。Shaun 在导入 osm 数据并启用 s2 索引时，报错，被提示不支持，对比 geomesa-index-api22Index.scala 和 geomesa-index-api22Index.scala 两文件的 defaults 函数可发现 S2Index 直接返回空，而在 geomesa-index-api.scala 中 fromName 函数需要调用 defaults 函数，从而导致 s2 索引不支持，修改 S2Index 的 defaults 函数即可（别忘了在 S2Index 类中首行加上 <code>import org.locationtech.geomesa.utils.geotools.RichSimpleFeatureType.RichSimpleFeatureType</code>）。</p><h2 id="后记">后记</h2><p>　　暂时就了解了这么多，等后续熟悉的更多再继续更吧 (ง •_•)ง。</p><h2 id="附录">附录</h2><h3 id="geomesa-命令行工具部分参数">GeoMesa 命令行工具部分参数</h3><p>Geomesa 命令行参数：</p><table><colgroup><col style="width:25%"><col style="width:74%"></colgroup><thead><tr class="header"><th>参数</th><th>描述</th></tr></thead><tbody><tr class="odd"><td>-c, –catalog *</td><td>存放 schema 元数据的catalog 表（相当于数据库）</td></tr><tr class="even"><td>-f, –feature-name</td><td>schema 名（相当于数据库中的表）</td></tr><tr class="odd"><td>-s, –spec</td><td>要创建 SimpleFeatureType 的说明（即表中列的描述信息，表的 schema，如 &quot;name:String,age:Int,dtg:Date,*geom:Point:srid=4326&quot;）</td></tr><tr class="even"><td>-C, –converter</td><td>指定转换器，必须为一下之一：1、已经在classpath中的converter 名；2、converter 的配置（一个字符串）；3、包括converter的配置的名</td></tr><tr class="odd"><td>–converter-error-mode</td><td>自定义的转换器的error mode</td></tr><tr class="even"><td>-t, –threads</td><td>指定并行度</td></tr><tr class="odd"><td>–input-format</td><td>指定输入源格式（如csv, tsv, avro, shp, json,）</td></tr><tr class="even"><td>–no-tracking</td><td>指定提交的 ingest job何时终止（在脚本中常用）</td></tr><tr class="odd"><td>–run-mode</td><td>指定运行模式，必须为：local（本地）、distributed （分布式）、distributedcombine（分布式组合）之一</td></tr><tr class="even"><td>–split-max-size</td><td>在分布式中，指定切片最大大小（字节）</td></tr><tr class="odd"><td>–src-list</td><td>输入文件为文本文件，按行输入</td></tr><tr class="even"><td>–force</td><td>禁用任何的提示</td></tr><tr class="odd"><td>[files]…</td><td>指定输入的文件</td></tr></tbody></table><p>参考资料：<a href="https://blog.csdn.net/qq_21705851/article/details/93392202" target="_blank" rel="external">GeoMesa命令行工具—摄取命令</a></p></div><div class="article-content-more"><button type="button" class="article-more--link"><i class="fa fa-angle-double-down fa-3x" aria-hidden="true"></i></button></div></section></article><article id="post-IDEA使用Docker环境开发调试" class="article div-border"><header class="article-header"><span class="article-date article-title--index"><i class="fa fa-calendar" aria-hidden="true"></i> <a href="/posts/3692cd6.html"><time datetime="2021-01-10T08:50:12.000Z">2021-01-10</time></a></span><section class="article-title article-title--index"><a href="/posts/3692cd6.html">IDEA使用Docker环境开发调试</a></section><div class="article-label"><div class="article-category label"><i class="fa fa-book" aria-hidden="true"></i> <a class="color3 article-category-link" href="/categories/Study/">Study</a></div><div class="article-tag label"><i class="fa fa-bookmark" aria-hidden="true"></i> <a class="color3 article-tag-link" href="/tags/devtool/">devtool</a></div></div></header><section class="article-content"><div class="article-content--excerpt"><h2 id="前言">前言</h2><p>　　IDEA 以前基本没用过，只是简单用过 Android Studio，还基本都忘记了 ( ╯□╰ )，以后应该会用 Scala 做一些大数据方面的东西，而大数据的环境都是 Linux 下的，而 Shaun 日常都是在 Windows 下开发，所以需要用日前做的容器环境来测试调试运行程序，简单记录一下 IDEA 在这方面的使用方法。</p></div><div class="article-content--all"><h2 id="前言">前言</h2><p>　　IDEA 以前基本没用过，只是简单用过 Android Studio，还基本都忘记了 ( ╯□╰ )，以后应该会用 Scala 做一些大数据方面的东西，而大数据的环境都是 Linux 下的，而 Shaun 日常都是在 Windows 下开发，所以需要用日前做的容器环境来测试调试运行程序，简单记录一下 IDEA 在这方面的使用方法。</p><a id="more"></a><h2 id="运行篇">运行篇</h2><p>　　右键项目名（HelloWorld），新建文件（New =》File），指定文件名为 <code>Dockerfile</code> 。写入内容示例如下：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="DOCKERFILE"><figure class="highlight hljs dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> stc:<span class="number">2.0</span></div><div class="line"><span class="keyword">COPY</span><span class="bash"> ./target/classes/ /tmp</span></div><div class="line"><span class="bash">WORKDIR /tmp</span></div><div class="line"><span class="bash">ENTRYPOINT [<span class="string">"scala"</span>,<span class="string">"HelloWorld"</span>]</span></div></pre></td></tr></table></figure></div><p>点击左上角绿色双箭头，可编辑 Dockerfile（Edit ‘Dockerfile’） ，指定当前上下文目录（Context folder），Contaier name 等容器启动选项。直接运行 Dockerfile（Run ‘Dockerfile’），IDEA 即可自动创建容器，并在容器中运行程序，程序运行完则容器自动停止，若需要运行存在外部依赖的程序，则只能以 jar 包的方式运行。</p><p>　　设置 IDEA 生成 jar 包如下：在最上面的菜单栏中 File =》Project Structure =》Artifacts =》+ =》JAR =》From modules with dependencies，选择 Main Class，点击右边的文件夹图标即可选择相应类，由于存在外部依赖，所以不能直接用默认的 extract to the target JAR，而是应该选择下面的 <strong>copy to the output directory and link via manifest</strong>，点击 OK 后，自动或手动选择导出的依赖 jar 包，点击 OK。在最上面的菜单栏中 Build =》Build Artifacts…，可在 out/artifacts/HelloWorld_jar 文件夹中生成所有 jar 包。之后编辑 Dockerfile， <strong>更改 Dockerfile 上下文目录</strong>为 out/artifacts/HelloWorld_jar ，指定容器名，在 Command 中输入 <code>java -jar HelloWorld.jar</code> 修改 Dockerfile 中第 2 行命令为 <code>COPY . /tmp</code>，修改第 4 行命令为 <code>CMD [&quot;java&quot;, &quot;-jar&quot;, &quot;HelloWorld.jar&quot;]</code>。之后运行 Dockerfile 即可在下面 Services 栏对应 Docker 容器 Attached Console 中看到程序运行结果。</p><h2 id="调试篇">调试篇</h2><p>　　除了使用 IDEA 生成 jar 包外，还需要使用 IDEA 的远程调试功能，设置 IDEA 远程调试功能如下：在最上面的菜单栏中 Run =》Edit Configurations… =》+ =》Remote JVM Debug，上方的 Debugger mode 中使用默认的 Attach to remote JVM， 在下面的 Before launch 添加 Launch Docker before debug。在弹窗中选择相应 Dockerfile，在下方的 Custom command 中输入 <code>java -agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=5005 -jar HelloWorld.jar</code>， 完成后即可使用该配置在 IDEA 调试容器中运行的程序。</p><h2 id="后记">后记</h2><p>　　用这种方式使用 IDEA 确实达到了 Shaun 理想的结果，Windows 下开发，Docker 中调试和运行，应付简单的代码调试和运行确实是没问题，但是在复杂的分布式环境下总会碰到一些莫名奇妙的问题，这些问题就是纯粹的经验了。</p><h2 id="参考资料">参考资料</h2><p><a href="https://www.jetbrains.com/help/idea/supported-languages.html/running-a-java-app-in-a-container.html" target="_blank" rel="external">Run a Java application in a Docker container</a></p><p><a href="https://www.jetbrains.com/help/idea/supported-languages.html/debug-a-java-application-using-a-dockerfile.html#create-dockerfile-run-config" target="_blank" rel="external">Debug a Java application using a Dockerfile</a></p></div><div class="article-content-more"><button type="button" class="article-more--link"><i class="fa fa-angle-double-down fa-3x" aria-hidden="true"></i></button></div></section></article><article id="post-大数据环境搭建笔记" class="article div-border"><header class="article-header"><span class="article-date article-title--index"><i class="fa fa-calendar" aria-hidden="true"></i> <a href="/posts/af5e9ace.html"><time datetime="2021-01-03T01:50:26.000Z">2021-01-03</time></a></span><section class="article-title article-title--index"><a href="/posts/af5e9ace.html">大数据环境搭建笔记</a></section><div class="article-label"><div class="article-category label"><i class="fa fa-book" aria-hidden="true"></i> <a class="color1 article-category-link" href="/categories/Study/">Study</a></div><div class="article-tag label"><i class="fa fa-bookmark" aria-hidden="true"></i> <a class="color1 article-tag-link" href="/tags/bigdata/">bigdata</a><a class="color1 article-tag-link" href="/tags/note/">note</a></div></div></header><section class="article-content"><div class="article-content--excerpt"><h2 id="前言">前言</h2><p>　　准备开始搞时空数据了，先简单搭一下环境。</p></div><div class="article-content--all"><h2 id="前言">前言</h2><p>　　准备开始搞时空数据了，先简单搭一下环境。</p><a id="more"></a><p>准备搭的环境为：jdk-1.8.0，hadoop-3.2.1，hbase-2.2.6，geomesa-hbase_2.11-3.1.0，spark-3.0.1-bin-hadoop3.2，geoserver-2.16.5-bin，geomesa-hbase_2.11-3.2.0-SNAPSHOT，所用的包都已下好并解压到 /home 目录下。</p><p><strong><em>※注</em></strong>： <em>hbase-2.2.6 暂不支持最新的 hadoop-3.3.0</em>，Hadoop 也最好使用 jdk-1.8.0，java-11 会有问题。</p><h2 id="hadoop-环境">Hadoop 环境</h2><p>　　首先修改 /etc/hosts 文件中本机 ip 对应的名称为 master，若在容器中安装则需要在 run 开启容器就指定 <code>--hostname master</code>，否则改了也没用，下次启动容器时 hostname 又会回到初始状态，下面开启正式的配置。</p><p>修改 /home/hadoop-3.2.1/etc/hadoop/hadoop-env.sh 文件，添加</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SH"><figure class="highlight hljs sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> JAVA_HOME=<span class="variable">$JAVA_HOME</span></div></pre></td></tr></table></figure></div><p>修改 /home/hadoop-3.2.1/etc/hadoop/core-site.xml 文件，添加</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="XML"><figure class="highlight hljs xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="comment">&lt;!-- master 前面配置的主机名称 --&gt;</span></div><div class="line">  <span class="comment">&lt;!-- &lt;property&gt;</span></div><div class="line"><span class="comment">    &lt;name&gt;fs.default.name&lt;/name&gt;</span></div><div class="line"><span class="comment">    &lt;value&gt;hdfs://master:9000&lt;/value&gt;</span></div><div class="line"><span class="comment">  &lt;/property&gt; --&gt;</span></div><div class="line">  </div><div class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>fs.defaultFS<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://master:9000<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hadoop.tmp.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>/home/hadoop/data/tmp<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure></div><p>修改 /home/hadoop-3.2.1/etc/hadoop/hdfs-site.xml 文件，添加</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="XML"><figure class="highlight hljs xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!--指定SecondaryNameNode位置--&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.secondary.http-address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>master:9001<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.replication<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure></div><p>修改 /home/hadoop-3.2.1/etc/hadoop/yarn-site.xml 文件，添加</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="XML"><figure class="highlight hljs xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- Site specific YARN configuration properties --&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.aux-services<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>mapreduce_shuffle<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure></div><p>修改 /home/hadoop-3.2.1/etc/hadoop/mapred-site.xml 文件，添加</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="XML"><figure class="highlight hljs xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.framework.name<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>yarn<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure></div><p>在 /home/hadoop-3.2.1/sbin/start-dfs.sh 和 /home/hadoop-3.2.1/sbin/stop-dfs.sh 文件头添加</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SH"><figure class="highlight hljs sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/usr/bin/env bash</span></div><div class="line">HDFS_DATANODE_USER=root</div><div class="line">HDFS_DATANODE_SECURE_USER=hdfs</div><div class="line">HDFS_NAMENODE_USER=root</div><div class="line">HDFS_SECONDARYNAMENODE_USER=root</div></pre></td></tr></table></figure></div><p>在 /home/hadoop-3.2.1/sbin/start-yarn.sh 和 /home/hadoop-3.2.1/sbin/stop-yarn.sh 文件头添加</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SH"><figure class="highlight hljs sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/usr/bin/env bash</span></div><div class="line">YARN_RESOURCEMANAGER_USER=root</div><div class="line">HADOOP_SECURE_DN_USER=yarn</div><div class="line">YARN_NODEMANAGER_USER=root</div></pre></td></tr></table></figure></div><p>设置环境变量，在 /etc/profile 中添加</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SHELL"><figure class="highlight hljs shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash">Hadoop Environment Setting</span></div><div class="line">export HADOOP_HOME=/home/hadoop-3.2.1</div><div class="line">export JAVA_LIBRARY_PATH=$HADOOP_HOME/lib/native</div><div class="line">export LD_LIBRARY_PATH=$JAVA_LIBRARY_PATH</div><div class="line">export PATH=$PATH:$HADOOP_HOME/bin:$HADOOP_HOME/sbin</div></pre></td></tr></table></figure></div><p>由于容器中默认为 root 用户，所以在 /root/.bashrc 文件末尾添加 <code>source /etc/profile</code>，以开机启用设置的环境变量。</p><p>在启动 Hadoop 之前需要执行 <code>hdfs namenode -format</code> 进行格式化，启动命令为 <code>/home/hadoop-3.2.1/sbin/start-all.sh</code>。<em>后续若需要清空并重新设置 Hadoop 时，必须先删除 /home/hadoop/ 目录，再重新进行格式化。</em></p><h2 id="hbase-环境">HBase 环境</h2><p>修改 /home/hbase-2.2.6/conf/hbase-env.sh 文件，添加</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SH"><figure class="highlight hljs sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> JAVA_HOME=<span class="variable">$JAVA_HOME</span></div><div class="line"><span class="comment"># 使用自带的ZooKeeper管理</span></div><div class="line"><span class="built_in">export</span> HBASE_MANAGES_ZK=<span class="literal">true</span></div></pre></td></tr></table></figure></div><p>修改 /home/hbase-2.2.6/conf/hbase-site.xml 文件，添加</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="XML"><figure class="highlight hljs xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.rootdir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://master:9000/hbase<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.dynamic.jars.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://master:9000/hbase/lib<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.cluster.distributed<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.replication<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.master.maxclockskew<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>180000<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>Time difference of regionserver from master<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.zookeeper.quorum<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>localhost<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 修改默认8080 端口--&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.rest.port<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>8088<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- 2181 默认端口，尽量不要修改，geomesa-hbase 导入数据时默认连接端口为 2181--&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.zookeeper.property.clientPort<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>2181<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.zookeeper.property.dataDir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>/home/hbase/data<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.unsafe.stream.capability.enforce<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- geomesa-hbase --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.coprocessor.user.region.classes<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>org.locationtech.geomesa.hbase.server.coprocessor.GeoMesaCoprocessor<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure></div><p>修改 /home/hbase-2.2.6/conf/regionservers 文件，修改为（原来为 localhost）</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="PLAIN"><figure class="highlight hljs plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">master</div></pre></td></tr></table></figure></div><p>设置环境变量，在 /etc/profile 中添加</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SHELL"><figure class="highlight hljs shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash">HBase Environment Setting</span></div><div class="line">export HBASE_HOME=/home/hbase-2.2.6</div><div class="line">export PATH=$PATH:$HBASE_HOME/bin</div></pre></td></tr></table></figure></div><p>配置好之后，执行 <code>start-hbase.sh</code> 启动 HBase。</p><h2 id="spark-环境">Spark 环境</h2><p>修改 /home/spark-3.0.1-bin-hadoop3.2/conf/spark-env.sh 文件，在文件末尾添加</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SH"><figure class="highlight hljs sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 配置JAVA_HOME，一般来说，不配置也可以，但是可能会出现问题，还是配上吧</span></div><div class="line"><span class="built_in">export</span> JAVA_HOME=<span class="variable">$JAVA_HOME</span></div><div class="line"><span class="comment"># 一般来说，spark任务有很大可能性需要去HDFS上读取文件，所以配置上</span></div><div class="line"><span class="comment"># 如果说你的spark就读取本地文件，也不需要yarn管理，不用配</span></div><div class="line"><span class="built_in">export</span> HADOOP_CONF_DIR=<span class="variable">$HADOOP_HOME</span>/etc/hadoop</div><div class="line"></div><div class="line"><span class="comment"># 设置Master的主机名</span></div><div class="line"><span class="built_in">export</span> SPARK_MASTER_HOST=master</div><div class="line"><span class="comment"># 提交Application的端口，默认就是这个，万一要改呢，改这里</span></div><div class="line"><span class="built_in">export</span> SPARK_MASTER_PORT=7077</div><div class="line"><span class="comment"># 每一个Worker最多可以使用的cpu core的个数，我虚拟机就一个...</span></div><div class="line"><span class="comment"># 真实服务器如果有32个，你可以设置为32个</span></div><div class="line"><span class="built_in">export</span> SPARK_WORKER_CORES=1</div><div class="line"><span class="comment"># 每一个Worker最多可以使用的内存，我的虚拟机就2g</span></div><div class="line"><span class="comment"># 真实服务器如果有128G，你可以设置为100G</span></div><div class="line"><span class="built_in">export</span> SPARK_WORKER_MEMORY=2g</div><div class="line"><span class="comment"># master web UI端口默认8080</span></div><div class="line"><span class="built_in">export</span> SPARK_MASTER_WEBUI_PORT=8090</div><div class="line"><span class="comment"># worker web UI端口默认8081</span></div><div class="line"><span class="built_in">export</span> SPARK_WORKER_WEBUI_PORT=8089</div></pre></td></tr></table></figure></div><p>复制 /home/spark-3.0.1-bin-hadoop3.2/conf/slaves.template 文件，并重命名为 slaves，将该文件尾修改为</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SH"><figure class="highlight hljs sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 里面的内容原来为localhost，改为master </span></div><div class="line">master</div></pre></td></tr></table></figure></div><p>设置环境变量，在 /etc/profile 中添加</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SHELL"><figure class="highlight hljs shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">export SPARK_HOME=/home/spark-3.0.1-bin-hadoop3.2</div><div class="line">export PATH=$PATH:$SPARK_HOME/bin:$SPARK_HOME/sbin</div></pre></td></tr></table></figure></div><p>将 /home/spark-3.0.1-bin-hadoop3.2/sbin/start-all.sh 重命名为 start-spark-all.sh，将 /home/spark-3.0.1-bin-hadoop3.2/sbin/stop-all.sh 重命名为 stop-spark-all.sh，执行 <code>start-spark-all.sh</code> 启动 Spark。</p><h2 id="geomesa-hbase-环境">geomesa-hbase 环境</h2><h3 id="编译-geomesa">编译 geomesa</h3><p>克隆 <a href="https://gitee.com/mirrors/geomesa" target="_blank" rel="external">LocationTech GeoMesa</a> ，<strong>修改 pom.xml</strong>，即修改对应依赖的 hadoop 和 hbase 以及 spark 版本（spark 最新的3.0.1版本由 Scala-2.12 编译，而 Geomesa 编译目前采用 Scala-2.11， 所以 Spark 不能使用最新的版本，只能用 2.4.7）。进入 geomesa 根目录，使用命令</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SH"><figure class="highlight hljs sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">mvn clean install -DskipTests</div><div class="line"></div><div class="line"><span class="comment"># 或仅编译 geomesa-hbase</span></div><div class="line">mvn clean install -pl geomesa-hbase -am -DskipTests</div></pre></td></tr></table></figure></div><p>编译 geomesa，中间可能会失败很多次，包下不来，可能需要挂代理或换源，重复使用命令多次即可。</p><h3 id="配置-geomesa-hbase">配置 geomesa-hbase</h3><p>将 /home/geomesa/geomesa-hbase/geomesa-hbase-dist/target/geomesa-hbase_2.11-3.2.0-SNAPSHOT-bin.tar.gz 解压为 /home/geomesa-hbase_2.11-3.2.0-SNAPSHOT，<strong>将 /home/geomesa-hbase_2.11-3.2.0-SNAPSHOT/dist/hbase/geomesa-hbase-distributed-runtime-hbase2_2.11-3.2.0-SNAPSHOT.jar 复制到 /home/hbase-2.2.6/lib/ 文件夹中</strong>，修改 /home/geomesa-hbase_2.11-3.2.0-SNAPSHOT/conf/dependencies.sh 文件，设置正确的Hadoop 和 hbase 版本，依次执行 /home/geomesa-hbase_2.11-3.2.0-SNAPSHOT/bin/install-dependencies.sh 和 /home/geomesa-hbase_2.11-3.2.0-SNAPSHOT/bin/install-shapefile-support.sh。设置环境变量，在 /etc/profile 中添加</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SH"><figure class="highlight hljs sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> GEOMESA_HBASE_HOME=/home/geomesa-hbase_2.11-3.2.0-SNAPSHOT</div><div class="line"><span class="built_in">export</span> GEOMESA_LIB=<span class="variable">$GEOMESA_HBASE_HOME</span>/lib</div><div class="line"><span class="built_in">export</span> GEOMESA_CONF_DIR=<span class="variable">$&#123;GEOMESA_HBASE_HOME&#125;</span>/conf</div><div class="line"><span class="built_in">export</span> CLASSPATH=<span class="variable">$CLASSPATH</span>:<span class="variable">$GEOMESA_LIB</span>:<span class="variable">$GEOMESA_CONF_DIR</span></div><div class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$GEOMESA_HBASE_HOME</span>/bin</div></pre></td></tr></table></figure></div><h3 id="测试-geomesa-hbase">测试 geomesa-hbase</h3><p>启动 Hadoop 和 HBase 之后，可直接使用命令</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SH"><figure class="highlight hljs sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">geomesa-hbase ingest --catalog TestGeomesa --feature-name road --input-format shp <span class="string">"/home/shpdata/road.shp"</span></div></pre></td></tr></table></figure></div><p>导入 shp 数据，<strong>shp 不能有 id 字段</strong>，因为 Geomesa 在创建表时会默认生成一个 id 字段。</p><p>也可克隆 <a href="https://gitee.com/xfilove/geomesa-tutorials" target="_blank" rel="external">geomesa-tutorials</a> ，同样修改其中的 pom.xml 文件，进入 geomesa-tutorials 根目录，使用命令</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SH"><figure class="highlight hljs sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mvn clean install -pl geomesa-tutorials-hbase/geomesa-tutorials-hbase-quickstart -am</div></pre></td></tr></table></figure></div><p>编译 geomesa-tutorials，编译完成后，使用命令</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SH"><figure class="highlight hljs sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java -cp geomesa-tutorials-hbase/geomesa-tutorials-hbase-quickstart/target/geomesa-tutorials-hbase-quickstart-3.2.0-SNAPSHOT.jar org.geomesa.example.hbase.HBaseQuickStart --hbase.zookeepers localhost --hbase.catalog geomesaTest</div></pre></td></tr></table></figure></div><p>导入数据进 Hbase，导入成功后可通过 <code>hbase shell</code> 进入 hbase，在 hbase shell 中通过 <code>list</code> 查看 hbase 现有的表。</p><h3 id="整合-geoserver">整合 geoserver</h3><p>导入依赖插件</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SH"><figure class="highlight hljs sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">manage-geoserver-plugins.sh -l <span class="variable">$&#123;GEOSERVER_HOME&#125;</span>/webapps/geoserver/WEB-INF/lib/ -i</div></pre></td></tr></table></figure></div><p>修改 /home/geomesa-hbase_2.11-3.2.0-SNAPSHOT/bin/install-dependencies.sh 中第33行：</p><div class="highlight-wrap" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="false" data-lang="SH"><figure class="highlight hljs sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># install_dir="$&#123;GEOMESA_HBASE_HOME&#125;/lib"</span></div><div class="line">install_dir=<span class="string">"<span class="variable">$&#123;GEOSERVER_HOME&#125;</span>/webapps/geoserver/WEB-INF/classes"</span></div></pre></td></tr></table></figure></div><p>执行 install-dependencies.sh 安装插件，安装完后将 classes 中的 lib 都移到 ${GEOSERVER_HOME}/webapps/geoserver/WEB-INF/lib中。</p><h2 id="后记">后记</h2><p>　　环境搞起来真麻烦，在编译和运行 Geomesa 时总能遇到一些莫名奇妙的问题，Java 系的这一套确实很麻烦，尤其是各种依赖关系，不过最后总算是搞好了，能直接在 geoserver 中看到 geomesa 存在 hbase 里的地图。</p><h2 id="参考资料">参考资料</h2><p><a href="https://www.cnblogs.com/Mr-lin66/p/13378248.html" target="_blank" rel="external">Centos7系统 Hadoop+HBase+Spark环境搭建</a></p><p><a href="https://blog.csdn.net/weixin_41834634/article/details/89176473" target="_blank" rel="external">GeoMesa-HBase操作篇——安装</a></p><p><a href="https://blog.csdn.net/hsg77/article/details/82221531" target="_blank" rel="external">centos7安装geomesa2.0.2_hbase_geoserver2.13.2的方法</a></p><p><a href="https://www.cnblogs.com/heidsoft/p/8558419.html" target="_blank" rel="external">hadoop fs 命令使用</a></p><p><a href="https://www.geomesa.org/documentation/stable/tutorials/geomesa-quickstart-hbase.html" target="_blank" rel="external">GeoMesa HBase Quick Start</a></p><p><a href="https://www.geomesa.org/documentation/stable/user/hbase/install.html" target="_blank" rel="external">Installing GeoMesa HBase</a></p><p><a href="https://www.cnblogs.com/yszd/p/10039249.html" target="_blank" rel="external">Spark完全分布式集群搭建【Spark2.4.4+Hadoop3.2.1】</a></p><h2 id="附录">附录</h2><p>最后附上一些常用的端口及说明：</p><h3 id="hbase">Hbase</h3><table><thead><tr class="header"><th>配置</th><th>端口</th><th>说明</th><th></th></tr></thead><tbody><tr class="odd"><td>hbase.master.port</td><td>16000</td><td>HMaster绑定端口</td><td></td></tr><tr class="even"><td><strong>hbase.master.info.port</strong></td><td><strong>16010</strong></td><td><strong>HBase Master的Web UI端口</strong></td><td></td></tr><tr class="odd"><td>hbase.regionserver.port</td><td>16020</td><td>HBase RegionServer绑定的端口</td><td></td></tr><tr class="even"><td><strong>hbase.regionserver.info.port</strong></td><td><strong>16030</strong></td><td><strong>HBase RegionServer的Web UI端口</strong></td><td></td></tr><tr class="odd"><td>hbase.zookeeper.property.clientPort</td><td>2181</td><td>Zookeeper客户端连接端口</td><td></td></tr><tr class="even"><td>hbase.zookeeper.peerport</td><td>2888</td><td>Zookeeper节点内部之间通信的端口</td><td></td></tr><tr class="odd"><td>hbase.zookeeper.leaderport</td><td>3888</td><td>Zookeeper用来选举主节点的端口</td><td></td></tr><tr class="even"><td>hbase.rest.port</td><td>8080</td><td>HBase REST server的端口</td><td></td></tr><tr class="odd"><td>hbase.master.port</td><td>60000</td><td>HMaster的RPC端口</td><td></td></tr><tr class="even"><td>hbase.master.info.port</td><td>60010</td><td>HMaster的http端口</td><td></td></tr><tr class="odd"><td>hbase.regionserver.port</td><td>60020</td><td>HRegionServer的RPC端口</td><td></td></tr><tr class="even"><td>hbase.regionserver.info.port</td><td>60030</td><td>HRegionServer的http端口</td><td></td></tr><tr class="odd"><td></td><td></td><td></td><td></td></tr></tbody></table><h3 id="hadoop">Hadoop</h3><table><thead><tr class="header"><th>配置</th><th>端口</th><th>说明</th><th></th></tr></thead><tbody><tr class="odd"><td>fs.defaultFS</td><td>9000</td><td>hdfs访问端口</td><td></td></tr><tr class="even"><td>dfs.namenode.rpc-address</td><td>9001</td><td>DataNode会连接这个端口</td><td></td></tr><tr class="odd"><td>dfs.datanode.address</td><td>9866</td><td>DataNode的数据传输端口</td><td></td></tr><tr class="even"><td><strong>dfs.namenode.http-address</strong></td><td><strong>9870</strong></td><td><strong>namenode的web UI 端口</strong></td><td></td></tr><tr class="odd"><td><strong>yarn.resourcemanager.webapp.address</strong></td><td><strong>8088</strong></td><td><strong>YARN的http端口</strong></td><td></td></tr></tbody></table><h3 id="spark">Spark</h3><table><thead><tr class="header"><th></th><th>端口</th><th>说明</th><th></th></tr></thead><tbody><tr class="odd"><td></td><td>8080</td><td>master的webUI，Tomcat的端口号（已修改为8090）</td><td></td></tr><tr class="even"><td></td><td>8081</td><td>worker的webUI的端口号（已修改为8089）</td><td></td></tr><tr class="odd"><td></td><td>18080</td><td>historyServer的webUI的端口号</td><td></td></tr></tbody></table><p>需开放端口 22，2181，5432，8080，8088，8089，8090，9870，16010，16030。</p><p><code>docker run -dit --privileged=true --name STC2 --hostname master -v E:/Docker/ShareFile:/mnt/sharefile -p 22:22 -p 80:80 -p 2181:2181 -p 5432:5432 -p 8080-8090:8080-8090 -p 9870:9870 -p 16010:16010 -p 16030:16030 stc:2.0 init</code></p></div><div class="article-content-more"><button type="button" class="article-more--link"><i class="fa fa-angle-double-down fa-3x" aria-hidden="true"></i></button></div></section></article><article id="post-设计模式浅谈" class="article div-border"><header class="article-header"><span class="article-date article-title--index"><i class="fa fa-calendar" aria-hidden="true"></i> <a href="/posts/ae780057.html"><time datetime="2020-12-27T10:28:56.000Z">2020-12-27</time></a></span><section class="article-title article-title--index"><a href="/posts/ae780057.html">设计模式浅谈</a></section><div class="article-label"><div class="article-category label"><i class="fa fa-book" aria-hidden="true"></i> <a class="color2 article-category-link" href="/categories/Study/">Study</a></div><div class="article-tag label"><i class="fa fa-bookmark" aria-hidden="true"></i> <a class="color1 article-tag-link" href="/tags/thought/">thought</a></div></div></header><section class="article-content"><div class="article-content--excerpt"><h2 id="前言">前言</h2><p>　　进入职场一年半以来，Shaun 完全独立从 0 到 1 开发了 1.5 个项目（当然也有参与其它项目，但不是 Shaun 独立从 0 到 1 开发的，没多少控制权，就不谈了），一个网页版的高精地图编辑器，半个地图可视化系统，这里面 Shaun 用了不少设计模式，这篇就谈谈 Shaun 用过的和没用过的一些设计模式。</p></div><div class="article-content--all"><h2 id="前言">前言</h2><p>　　进入职场一年半以来，Shaun 完全独立从 0 到 1 开发了 1.5 个项目（当然也有参与其它项目，但不是 Shaun 独立从 0 到 1 开发的，没多少控制权，就不谈了），一个网页版的高精地图编辑器，半个地图可视化系统，这里面 Shaun 用了不少设计模式，这篇就谈谈 Shaun 用过的和没用过的一些设计模式。</p><a id="more"></a><p>　　以「Head First 设计模式」为参考，Shaun 用 C++ 实现了一遍书中的例子（代理模式及其后面的模式除外），下面进入正文。</p><h2 id="模式篇">模式篇</h2><h3 id="策略模式">策略模式</h3><p>　　Shaun 个人认为最能体现面向对象编程思想（抽象封装继承多态）的一种模式，换句话说，只要真正理解和运用面向对象编程，一定会自然而然的用到策略模式。Shaun 在做高精地图编辑器时，需要设计一个渲染模块，渲染模块会包含高亮行为，高亮有两种，一种是直接改变颜色，一种是使用后期处理（OutlinePass 或 UnrealBloomPass 等）进行高亮，这时就需要在渲染类中组合高亮行为。</p><p>　　策略模式中涉及到的原则有：1、封装变化；2、多用组合，少用继承；3、针对接口编程，不针对实现编程。封装变化这点很考验程序员的经验水平，在写代码之初，往往预料不到变化，所以这一点一般是在编码过程中逐渐完善的，不断进行抽象，从而生成比较合理的基类；第二点一般也是对的，但有时在编码过程中难免会碰到到底是用继承还是组合的问题，这时候可以多想想，组合并不是万能的，有时继承更合适，这时可以请教身边更有经验的程序员，组合的优势在于当子类不想要这个对象时，可以随时丢弃，而继承的优势在于，当子类不想实现这个行为时，可以有默认的行为，而且有些时候只能用继承；针对接口编程没啥好说的，就是抽象。</p><h3 id="观察者模式">观察者模式</h3><p>　　这个模式如果在分布式系统中又叫发布订阅模式，该模式常用于消息通知。前端有个 RxJS 的库将这一模式玩出花来了，Shaun 在高精地图编辑器的事件流管理中就使用了该库。在 threejs 中所有渲染对象的都有一个统一的基类 EventDispatcher，该类中就实现了一个简单的观察者模式，用来处理事件监听触发和通知，和真正的观察者相比，区别在于观察者只是一个函数，而不是一个类，其实浏览器的事件监听机制实现方式也和这个类差不多。</p><p>　　观察者模式中涉及到原则有：松耦合。这里的松耦合是指主题和观察者之间是隔离的，观察者可自行实现自己的更新行为，而主题同样可实现自己的通知机制，两者虽有关联但互不影响。松耦合原则说起来人人会说，但真正能实现松耦合的却不多，实现松耦合的关键在于怎样分离两个系统，两个系统的连接点在哪，这有时很难理清，从而造成逻辑混乱，bug 丛生。</p><h3 id="装饰者模式">装饰者模式</h3><p>　　利用该模式可以很方便的扩展一些方法和属性，尤其是遇到主体和配件这样的关系时，可以很轻松的添加配件到主体上。Shaun 没用过这个模式，本来在扩展 threejs 一个类时想用，但确实没找到非常明确的主体和配件这样的关系，最后还是简单的使用继承了。</p><p>　　装饰者模式涉及到的原则有：开放——封闭原则。设计一个类需要考虑对扩展开放，对修改关闭。修改和扩展看似矛盾，但实则可以独立存在，装饰者的配件可以无限加，这是扩展，是开放，而在加配件时无需修改现有代码，这是封闭。当然这一原则并不独属于装饰者模式，应该说是只要用到面向对象的思想开发程序，就一定会用到该原则，否则也就失去了面向对象的意义。但有时这个原则又没必要贯彻彻底，因为对于有些需求可能很难弄清修改和扩展的界限，这时就达到能尽量重用父类的方法就好。</p><h3 id="工厂模式">工厂模式</h3><p>　　该模式在稍微大一点的系统中应该都会用到，根据不同的输入，生成不同的对象，这就是工厂模式的本质。至于工厂模式的实现方式一般会根据需求的复杂度来决定：1、只有一个工厂，一类产品，只是为了集中一层 if-else，可用简单工厂模式，甚至一个 builder 函数即可；2、有多个工厂，还是只有一类产品，用工厂模式，多个工厂继承一个工厂父类即可，相当于多个简单工厂组合；3、有多个工厂，多类产品，哪个工厂生产什么产品可能有变化，这时需要用到抽象工厂模式，除正常的继承之外，还需使用组合，组合组成产品的父类，相当于再组合一个工厂。Shaun 在高精地图编辑器中当然是大量使用的工厂模式和简单工厂模式，主要是为了集中 if-else 的处理，比如根据不同的数据类型创建不同的属性栏界面（枚举用下拉框，字符串用文本框，数字用数字栏等），根据不同的路网元素创建对应的渲染器对象以及对应的属性界面等。</p><p>　　工厂模式涉及到的原则有：依赖倒置原则。尽量依赖抽象，而不是具体类。这其实也是抽象一种作用或好处，即在使用过程中尽量使用最上层的父类，具体类只在创建实例时使用。</p><h3 id="单例模式">单例模式</h3><p>　　写程序的基本都会用到该模式，主要用来创建全局唯一对象，可用来存储和处理系统中常用的各个模块都会用到的一些数据。Shaun 在编辑器中单例模式用了好几个，比如全局唯一的 viewport，用力绘制 3d 图形；全局唯一的路网数据；当然系统中存在太多的单例模式也不好，最好是只有一个，如 Shaun 的编辑器中最好的模式就是创建一个单例的 Editor 类，需要做单例的对象都可以放在该类中，如此保证系统中只有一个单例类，以进行统一管理。</p><p>　　该模式与面向对象倒是没多大关系了，可以认为是全局变量的优化版，毕竟大的系统中全局变量基本不可避免，这时就可以使用单例模式。</p><h3 id="命令模式">命令模式</h3><p>　　该模式主要用来将函数方法封装成类，这样做的好处就是可以更灵活的执行该方法（将方法放进队列中依次执行，将方法持久化以便系统启动执行），同时也可以保存该方法的一些中间状态，以便撤销操作，回到系统执行该方法前的状态。Shaun 在编辑器中主要用命令模式做撤销重做功能，这基本也是编辑器的必备功能了，可以说没有撤销重做功能的编辑器是不完整的，要实现撤销重做功能除了基本的命令模式之外，还要提供撤销和重做两个栈以保存操作命令。</p><p>　　该模式与面向对象也没很大关系，只是提供了一个实现一些特殊功能的标准或通用方案。</p><h3 id="适配器模式">适配器模式</h3><p>　　该模式正如其名，主要用来转换接口，将一个类的方法用其它类封装一下，以达到兼容其它类接口的目的，同时对外可接口保持不变，该模式通过对象组合实现。Shaun 没使用过该模式，就 Shaun 感觉这个模式应该可以用在维护了好几年的系统上，当新作的东西需要兼容老接口时，可以用适配器模式将新街口封装一下。</p><p>　　该模式同样只是提供了一种新接口兼容老接口的一种优良方案，当然实际使用过程中可能很难这么完美，但算是一种思路。</p><h3 id="外观模式">外观模式</h3><p>　　该模式算是封装的一种体现。当一个功能需要经过多次函数调用才能完成时，这时可以用另一个方法将这些函数都封装起来，从而简化调用方式。Shaun 用该模式处理整个渲染模块的初始化和资源释放，因为初始化时需要分配好很多东西（光照，viewport，固定图层，地面，天空盒等），而释放时同样需要释放这些东西。该模式同样只能算是提供了一种好的编程实践，实际使用过程可能每个函数都有很多参数，调用顺序可能有变，这时简化调用反而没有必要，让用户自己决定怎样调用更好。</p><p>　　外观模式涉及到的原则有：最少知识原则。该原则主要用来减少对象依赖，即尽量不将类中组合的对象直接暴露出去，而应该将组合对象的方法再简单封装一下，再将封装后的方法暴露出去，以减少另外的类又依赖类中组合对象的现象。该原则可以适当遵守，因为有时直接使用更方便一点，多次封装之后反而显得逻辑混乱，增加系统的复杂度。</p><h3 id="模板方法模式">模板方法模式</h3><p>　　该模式是抽象的一种体现。首先抽象出一套固定化的流程，流程中每个步骤的具体行为并一致，有些默认，有些可以重写，父类固定流程，子类负责重写流程中每个步骤，这就时模板方法模式。Shaun 没写过完全符合该模式的代码，只是写了个类似该模式的模块，该模块有三个功能（编辑道路节点，编辑车道节点，编辑车道线），做完前两个功能后，发现这里有一套逻辑是通用的，那就是滑过节点高亮，选择节点，出现 gizmo，拖动 gizmo，完成编辑（当然还有选择节点后不拖动 gizmo 等一套 if-else 中间处理状态），于是 Shaun 把这一套流程抽象出来，固化方法，这三个功能都继承该类，方法该重写的重写，不仅减少了代码量，同时整个流程也更清晰了，很快完成了第三个功能。</p><p>　　模板方法涉及到的原则有：好莱坞原则。即由父类负责函数调用，而子类负责重写被调用的函数，不用管父类的调用逻辑，也最好不要调用父类的函数。该原则用来理清流程很方便，只需要看父类即可，但实际编程过程中可能也会遇到子类不可避免的会调用父类的一些公共函数的情况，Shaun 觉得只要流程没问题的话，调用父类函数也能接受，并不需要严格遵守模式。</p><h3 id="迭代器模式">迭代器模式</h3><p>　　迭代器，即对遍历进行封装，一般只能顺序执行，提供 next() 方法获取下一个元素，集合容器的遍历方式一般都会用迭代器进行封装。Shaun 在这一个半项目里没写过迭代器，毕竟这是非常底层的一个模式，语言库本身有的数据结构大多自己实现了迭代器，除非需要设计一个新的集合或容器数据结构，才需要提供相应的迭代器。因为 js 没有 SortedMap 数据结构，为了高效分配路网元素 id，Shaun 利用 object 简单实现了一个，提供了相应的 forEach 方法。</p><p>　　迭代器模式涉及到的原则有：单一责任原则。即一类只做一件事，这个原则对于涉及最最底层的接口很实用，而大多具体类很难只做一件事。迭代器模式对于顺序访问来说还是非常有用的，毕竟使用迭代器的人不需要管底层到底用的什么数据结构，反正可以顺序遍历即可。</p><h3 id="组合模式">组合模式</h3><p>　　组合模式与其说是一种模式，更不如说就是一颗树，只是树的节点都是可供继承的类。在标准的组合模式中，父类中一定会有全部子类的全部函数，即所有子类的函数要么是继承自父类，要么是重写父类函数的，这其实是违背上面单一责任原则的，因为这必然会造成有些子类不需要这么多函数。而从组合模式会存储孩子节点这点来看，和装饰者模式有点类似，只不过装饰者只会存一个孩子，而组合模式可能会存多个，当然两者做的事是不一样，只是实现手法类似而已。Shaun 没写过标准的组合模式，如果只要符合树形模式都可认为是组合模式，那在高精地图编辑器中，所有路网元素都会继承一个父类，而道路中又包含车道簇，车道簇中包含车道，这也算组合模式。在 threejs 中有个 Object3D 的基类，所有渲染对象都会继承该类，该类中又包含若干孩子，threejs 计算 Model 矩阵时就是一层层孩子的 Model 矩阵乘下去，直到最后的孩子，结果就是最后 Shader 中的 Model 矩阵。</p><h3 id="状态模式">状态模式</h3><p>　　状态机的状态转移可以说是程序设计中最麻烦的部分之一了，这部分如果写不好的话，根本没法修改维护，同时会造成 bug 频发。在高精地图编辑器中鼠标操作有两类模式，一种是选择模式，另一种是编辑模式，选择模式又分为点选和框选，而编辑模式就非常多了，针对路网的不同元素，编辑模式的具体实现都不会一样，Shaun 首先使用 RxJS 封装了一个鼠标操作类（左键右键中键移动等），后续的鼠标操作都继承自该类，可以算是状态模式的父类，后续的鼠标操作就针对相应的需求实现相应的方法即可，当然其中鼠标操作自身也存在状态转移（左键到右键，左键到鼠标移动等），这些一般都是针对特定需求来的，所以这些小的状态转移一般在鼠标操作内部实现，但需要支持随时从编辑模式到选择模式，这意味着编辑模式编辑到一半的东西都需要支持随时释放，恢复编辑前的样子，这算是一个麻烦的地方，有时忘了释放就会出现问题。</p><p>　　状态模式算是为解决状态转移问题提供一种理想的方案，但其具体实现并不一定要和书上一样，Shaun 在用 C++ 实现时就采用另一套方案，状态类是独立的，控制状态转移的代码都在状态机内，而不是书中这种直接在状态类中控制状态机。好处坏处都有，看具体需求，Shaun 的方式就是状态类和状态机是分离的，状态类不需要管状态机怎么实现的，只需要管当前状态的情况，但需要在状态机中管理状态转移，而书中实现方式状态机的状态转移放到状态类中了，也因此状态类需要依赖状态机。</p><hr><p><em>剩下的模式，Shaun 就没直接写代码实践了，因为大多都需要跨模块实现，有的甚至就是个小项目了，所以就简要谈谈 Shaun 的个人理解</em>。</p><h3 id="代理模式">代理模式</h3><p>　　主要可以用来做权限控制，在模块与模块之间的调用过程中，有时不想要一个模块可以访问另一个模块的全部内容，这时可以使用代理模式，创建一个中间模块，避免两个模块直接调用，同时进行访问控制。代理模式在如今的互联网时代不可避免的会用到，或直接或间接，往最小的说，对象组合也可用来实现代理模式。</p><h3 id="复合模式">复合模式</h3><p>　　将多种模式组合在一起使用，比如 MVC 模式，这种模式与其说是模式，更不如说就是一种架构，一种开发包含客户端系统的通用架构，当然每一层都会有很多模式进行组合，从而造成具体实现差异非常大。</p><h3 id="反模式">反模式</h3><p>　　反模式指的是用“不好的解决方案”去解决一个问题，Shaun 主要想谈谈开发反模式，因为这非常常见。有时候一个解决方案好不好要从多个角度进行衡量，比如现有技术，长期短期，上手难度，开发效率，维护难度等角度，当出现一个新问题时，往往意味着就有解决方案有缺陷，这种缺陷可能很容易弥补，更可能很难，当很难解决时，往往要采用全新的解决方案，这时团队对新解决方案可能都不熟，也没有魄力去采用新解决方案，只能去老解决方案继续强行打补丁，直到最后没法维护，白白浪费了大量的人力和时间，这是非常典型的一种反模式。</p><h3 id="桥接模式">桥接模式</h3><p>　　将抽象接口和实现分开，并独立派生，以支持抽象和实现的同时改变，并相互独立，可适用在需要跨平台跨不同设备的系统上。</p><h3 id="生成器模式">生成器模式</h3><p>　　有点像是模板方法模式和工厂模式的结合版，使用多个步骤创建一个对象，但步骤没有固定顺序，可适用于流程复杂的规划系统中。</p><h3 id="责任链模式">责任链模式</h3><p>　　可以认为是模板方法模式的进阶版，只是模板的步骤方法变成了一个个对象，并且支持步骤的增加和删除，以及更换顺序，一旦某个步骤成功执行，则整个链条终止，可适用于消除显式的 if-else，处理键盘或鼠标事件时，需要针对不同按键触发不同操作，这时可以采用该模式，缺点是链条很长时，要写很多类，导致执行啥很不直观。</p><h3 id="蝇量模式">蝇量模式</h3><p>　　这个模式算是一种优化内存占用的方案，通过牺牲类的独立性来减少内存，更彻底一点就是不创建类，直接用函数调用来处理就行。</p><h3 id="解释器模式">解释器模式</h3><p>　　可用来实现简单语法规则语言的解释器或编译器，每个语法规则都由一个类进行解析，然后组合。</p><h3 id="中介者模式">中介者模式</h3><p>　　可认为是状态模式和代理模式的结合版，不过各个状态可以是不同类，由中介者控制系统流转，集中控制逻辑，使被控制对象解耦，但可能会造成中介者本身非常复杂。</p><h3 id="备忘录模式">备忘录模式</h3><p>　　可用于系统（游戏）存档，存储系统中关键对象的运行状态，通常实现的方案一般是序列化/持久化，为了效率考虑，难的是有时需要增量存档。</p><h3 id="原型模式">原型模式</h3><p>　　js 的原型链应该是原型模式的典型，不仅实现了动态扩展实例，更实现了动态扩展对象，即继承。在高精地图编辑器中，由于需要做自动保存，所以在做序列化和反序列化的同时也简单实现了对象的 clone()，即从当前实例中创建一个完全一样的实例，可认为是 C++ 中的深拷贝。</p><h3 id="访问者模式">访问者模式</h3><p>　　相当于加个中间层，从而以最小的代价修改现有系统（一般是增加一个方法），达到外部可以取得系统内部信息的目的。</p><h2 id="后记">后记</h2><p>　　曾看过这样一句话：抽象能力决定编程能力，Shaun 个人认为，所谓抽象即提炼事物的共同点，这也是设计模式中反复使用接口的原因，接口即一组具体类的共同点，接口中的函数和变量即为这些具体类共有的，虽然具体行为可以不一样，但行为本身总是存在的。而又有这样一句话：程序等于数据结构加算法，Shaun 的理解是，狭义上的程序确实是这样，一段代码解决一个问题，这是程序，多段代码解决一个问题，这也是程序，多段代码解决多个问题，这亦是程序，一个软件，一个系统，一个平台，都是程序，但显然这些程序不是简单的数据结构和算法就能概括的，其内部必然有一套合理的逻辑进行组织，这套逻辑可以称之为“设计模式”，但这个“设计模式”不仅仅是上面谈的这些模式概念。Shaun 认为好的数据结构和算法确实能使程序达到当前最优，但对于一个大型系统或平台来说，这种最优只能是一种局部最优，这对整个系统的全局最优来说可能是微不足道的，而“设计模式”要解决的是怎样使一个系统达到全局最优，怎么合理组织局部最优。面对现代的超大型系统或平台，传统意义上的设计模式也只能达到局部最优，全局最优基本很少有人能驾驭，都是针对特定的业务需要，不断的试错改进优化，逐渐趋于稳定，但这种稳定可能很难抽象，放进其它的业务中，又得花费大量的人力物力去修改。</p><p>　　Shaun 个人对现代大型系统架构的理解就是分层分模块，功能太多分模块，模块太多就分层，一层不够分两层，两层不够分三层，三层不够继续分，根据数据流的处理分层，根据功能的不同分模块，模块内部依靠设计模式进行组织，设计模式调度的就是数据结构与算法。Shaun 目前的设计原则就是：每层一个独立的服务控制模块，每个模块一个对外服务功能（或事件或 socket ），同层的各模块之间尽量保持独立，不相互依赖，若各模块存在共同点，则将共同点抽出来，将其作为公共模块或独立为小层，层与层之间通过服务控制模块进行数据流的传输，除服务控制模块之外，模块之间尽量避免相互通信，即每个模块的对外服务功能一般只对本层服务控制模块提供服务，最好是只负责接收数据。如果系统实在太大，就只能保持纵向分层，横向保证各模块间数据流依次传输，并在特定模块节点上进行上下层的数据传输。</p><p>　　数据结构与算法重不重要？当然重要，数据结构与算法不过关，面试都过不去 ( ╯□╰ )，工作都没有，还何谈什么设计模式，什么架构。设计模式重不重要？当然也重要，不会合理使用设计模式，写出一堆别人没法维护的垃圾代码（当然，这或许是好事 :p ），改个需求要半天，加个功能要半个月，效率太低，这样即使有好的数据结构与算法作用也不大。但是设计模式也不是万能的，针对不同的需求，同一种设计模式有不同的实现方式，所以书中的设计模式也仅供参考而已，与其说设计模式重要，还不如说书中那几个设计原则更重要些。同时一味的追求设计模式也不见得是件好事，设计模式可以参考，但不能生搬硬套，毕竟人是活的，需求也是活的，固定的模式也需要有所改变，总而言之，能以最小的代价解决问题完成需求的模式就是好模式。</p></div><div class="article-content-more"><button type="button" class="article-more--link"><i class="fa fa-angle-double-down fa-3x" aria-hidden="true"></i></button></div></section></article><nav id="pagination--nav" class="text-center"><span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a></nav></main><div id="site-tool"><div class="scroll"><a href="#header"><i class="fa fa-arrow-up"></i></a> <a href="#footer"><i class="fa fa-arrow-down"></i></a></div><div></div></div><aside id="right-col" class="col-lg-3 col-sm-12"><div id="sidebar-sticky--bottom"></div><div id="sidebar"><header class="author-info div-border"><a href="/"><img class="header-avatar" src="/img/avatar.jpg"></a><h1 class="header-author"><a href="/" title="Hi Mate" data-toggle="tooltip">Shaun</a></h1><p class="header-slogan">求知！ 视界！ 未来！ ↖(^ω^)↗</p><div class="social-info"><a class="social-icon" target="_blank" href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=qNvAyd3G0d3JxujOx9DFycHEhsvHxQ" title="envelope" data-toggle="tooltip"><i class="fa fa-envelope" aria-hidden="true"></i> </a><a class="social-icon" target="_blank" href="https://github.com/cniter" title="github" data-toggle="tooltip"><i class="fa fa-github" aria-hidden="true"></i> </a><a class="social-icon" target="_blank" href="/atom.xml" title="rss" data-toggle="tooltip"><i class="fa fa-rss" aria-hidden="true"></i> </a><a class="social-icon" target="_blank" href="http://sighttp.qq.com/authd?IDKEY=4faf682653b3b7f5f47b9cb6d2bb8b81de8fa7a8fb8cee12" title="qq" data-toggle="tooltip"><i class="fa fa-qq" aria-hidden="true"></i></a></div></header><div class="search div-border" title="搜索" data-toggle="tooltip"><form id="search-form"><input type="text" id="local-search--input" name="q" results="0" placeholder=" Search..." autocomplete="off" autocorrect="off"> <i class="fa fa-times" onclick="resetSearch()"></i></form><div id="local-search--result"></div><p class="no-result">No results found</p></div><div id="tagcloud" class="tagcanvas div-border" title="标签" data-toggle="tooltip"><canvas width="200" height="200" id="tagcloud-canvas"><p>Anything in here will be replaced on browsers that support the canvas element</p><ul><li><a href="/tags/algorithm/" data-weight="7">algorithm</a></li><li><a href="/tags/android/" data-weight="2">android</a></li><li><a href="/tags/bigdata/" data-weight="2">bigdata</a></li><li><a href="/tags/c-cpp/" data-weight="6">c/cpp</a></li><li><a href="/tags/clustering/" data-weight="1">clustering</a></li><li><a href="/tags/container/" data-weight="1">container</a></li><li><a href="/tags/css/" data-weight="1">css</a></li><li><a href="/tags/cv/" data-weight="5">cv</a></li><li><a href="/tags/devtool/" data-weight="1">devtool</a></li><li><a href="/tags/ffmpeg/" data-weight="1">ffmpeg</a></li><li><a href="/tags/geomesa/" data-weight="1">geomesa</a></li><li><a href="/tags/geometry/" data-weight="4">geometry</a></li><li><a href="/tags/gfw/" data-weight="1">gfw</a></li><li><a href="/tags/git/" data-weight="0">git</a></li><li><a href="/tags/github/" data-weight="1">github</a></li><li><a href="/tags/gl/" data-weight="1">gl</a></li><li><a href="/tags/hexo/" data-weight="8">hexo</a></li><li><a href="/tags/integration/" data-weight="1">integration</a></li><li><a href="/tags/java/" data-weight="2">java</a></li><li><a href="/tags/k8s/" data-weight="1">k8s</a></li><li><a href="/tags/language/" data-weight="2">language</a></li><li><a href="/tags/latex/" data-weight="0">latex</a></li><li><a href="/tags/mapbox/" data-weight="1">mapbox</a></li><li><a href="/tags/markdown/" data-weight="1">markdown</a></li><li><a href="/tags/matlab/" data-weight="2">matlab</a></li><li><a href="/tags/network/" data-weight="1">network</a></li><li><a href="/tags/note/" data-weight="5">note</a></li><li><a href="/tags/numerical/" data-weight="1">numerical</a></li><li><a href="/tags/opencv/" data-weight="11">opencv</a></li><li><a href="/tags/opendrive/" data-weight="1">opendrive</a></li><li><a href="/tags/opengl/" data-weight="1">opengl</a></li><li><a href="/tags/python/" data-weight="1">python</a></li><li><a href="/tags/qt/" data-weight="2">qt</a></li><li><a href="/tags/record/" data-weight="10">record</a></li><li><a href="/tags/search/" data-weight="1">search</a></li><li><a href="/tags/segmentation/" data-weight="2">segmentation</a></li><li><a href="/tags/tensorflow/" data-weight="1">tensorflow</a></li><li><a href="/tags/thought/" data-weight="3">thought</a></li><li><a href="/tags/unix-like/" data-weight="2">unix-like</a></li><li><a href="/tags/vscode/" data-weight="1">vscode</a></li></ul></canvas><script src="/plugins/TagCanvas/jquery.tagcanvas.min.js" type="text/javascript"></script><script type="text/javascript">$(document).ready(function(){$("#tagcloud-canvas").tagcanvas({initial:[.1,-.1],activeCursor:'url("/img/cursor/link.cur"), auto',reverse:!0,depth:.75,weight:!0,weightFrom:"data-weight",weightMode:"both",weightSizeMin:15,weightSizeMax:50})||$("#tagcloud").hide()})</script></div><div class="friends div-border" title="友链" data-toggle="tooltip"><a target="_blank" class="friends-link" href="https://cniter.github.io">Shaun&#39;s Space</a></div><div class="revolvermaps div-border" title="访客" data-toggle="tooltip"><script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=50om5cdoa3h&amp;m=7&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=49" defer></script></div></div><div class="toc-card"><div class="toc-card--head"><i class="fa fa-angle-up" aria-hidden="true"></i></div><div id="toc" class="toc-card--content"><strong class="toc-title">文章列表</strong><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/posts/720275bd.html">Google S2 Geometry 浅解</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/55e674ff.html">K8S 应用开发指北</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/81321445.html">OpenGL坐标系统与渲染管线</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/8d3d87a2.html">Scala 学习小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/28416d7c.html">2020年小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/489fa7b3.html">时空查询之ECQL</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/9978824c.html">GeoMesa踩坑指北</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/3692cd6.html">IDEA使用Docker环境开发调试</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/af5e9ace.html">大数据环境搭建笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/ae780057.html">设计模式浅谈</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/eee1c041.html">积分计算</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/a5661762.html">Geometry增量更新</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/e225d8fd.html">Mapbox显示GeoServer地图</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/3d8ab974.html">Docker使用小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/6694a214.html">空间中三角形与三角形相交</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/5315fcfd.html">计算几何基础</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/b7d79231.html">OpenDrive解析小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/39a3c99e.html">一张纹理做天空盒</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/a250bb21.html">Windows Terminal 尝鲜小记</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/ae5f9dce.html">读大学</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/cf97ba7c.html">2019，既是结束又是开始</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/ff29de94.html">快速判断三角形与长方体相交</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/70a807da.html">网页菜单纯 css 实现</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/abe58f8c.html">个人游记</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/26d437be.html">hexo-theme-chi主题更新小记</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/3578e309.html">［译］为什么深度学习没有取代传统的计算机视觉</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/37b89a23.html">再也不见，18年</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/ac4679b5.html">hexo-theme-chi主题开发小记</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/64889158.html">Matlab和OpenCV混合编程小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/be7949e4.html">Android实践小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/fc1165b7.html">C++数组中的坑</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/cafdd60d.html">Android开发环境配置</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/27a4c8b6.html">Windows实用技巧</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/6315717b.html">FFmpeg提取与合并命令使用小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/fd823bf9.html">解决VSCode使用Cmder作为默认终端问题</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/fddd1e17.html">图割算法之NCuts浅见</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/c42ff8d4.html">图割算法之Graph Cuts浅见</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/b93d943b.html">C++中static用法小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/8fb9f004.html">斐波那契数列的三种写法</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/982ff584.html">搜索技巧</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/7cebf0ee.html">17年走了，18年来了</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/e124baa1.html">矩阵的应用之图像仿射变换</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/aef52be2.html">本人常用小工具安利</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/376168c6.html">解决无法打开某个网页问题</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/5f54aa2c.html">PyQt5使用小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/82d3b275.html">TensorFlow Object Detection API使用小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/2a3d46b0.html">C语言中整型提升问题</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/dece8eba.html">TXT数据转OpenCV中的Mat数据</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/e8b35736.html">OpenCV中滑动条和鼠标事件响应操作的使用小结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/b6fb6109.html">利用回调函数计算函数运行时间</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/df943c4f.html">论如何科学的上网</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/b1e9411b.html">Hexo的SPFK主题修改小记</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/22c3daf1.html">解决Qt中Qlabel显示OpenCV的Mat数据图像产生扭曲现象问题</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/509ee93b.html">解决OpenCV-2.4.11调用摄像头显示拍摄视频出错问题</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/3bc0decc.html">Hexo添加各种小部件</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/fd0f8195.html">OpenCV中显著性检测算法的使用</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/35132cb7.html">OpenCV中Selective Search算法的使用</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/170c76cc.html">别了，漆黑的象牙塔</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/c3f26b1.html">Win10以树形结构显示文件目录结构</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/68065b99.html">ACGN作品个人印象简评</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/4f6225b7.html">Hexo添加站内本地搜索</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/302a6244.html">用OpenCV显示OpenGL图形</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/7df528b4.html">Win10＋VS2013＋CMake-gui编译和配置OpenCV-3.2.0</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/17017530.html">MyThoughts</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/7d5bc07b.html">解决写上篇文档“Hexo+GitHub搭建个人博客”遇到的问题</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/d7965b48.html">Hexo+GitHub搭建个人博客</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/4a17b156.html">Hello World</a></li></ul></div></div></aside></div></div><span id="cursor-trail"></span> <span class="click-halo"></span><footer id="footer" class="text-center"><div class="copyright-info">&copy; 2017 - 2021 <a href="/">Shaun</a></div><span class="site-visitor"><i class="fa fa-user-o" aria-hidden="true"></i> <span id="busuanzi_value_site_uv"><i class="fa fa-spinner fa-spin"></i></span> &nbsp;|&nbsp; <i class="fa fa-eye" aria-hidden="true"></i> <span id="busuanzi_value_site_pv"><i class="fa fa-spinner fa-spin"></i></span> &nbsp;|&nbsp; <i class="fa fa-hand-o-up" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span></span><div class="site-info"><a href="http://hexo.io/" target="_blank">Hexo </a>theme <a href="https://github.com/cniter/hexo-theme-chi" target="_blank">Chi </a>by <a href="https://github.com/cniter" target="_blank">Shaun</a></div></footer><script type="text/javascript" async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML" integrity="sha256-WUED7NFzpsmHtLO7bswSz4JSfkhE+cD4ncKeOznwFSY=" crossorigin="anonymous"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }

        , TeX: {
            extensions: ["extpfeil.js"]
        }
    });
    
    MathJax.Hub.Queue(function() {
        let all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';                 
        }       
    });</script><script type="text/javascript">// 监听搜索结果是否发生变化
    const MutationObserver = window.MutationObserver || window.WebKitMutationObserver || window.MozMutationObserver;  // Firefox和Chrome早期版本中带有前缀
    const config = { attributes: true, childList: true, characterData: true }; // 配置观察选项
    let target = document.querySelector('#local-search--result');
    let $local_search_result = $("#local-search--result");
    let $no_result = $(".no-result");
    let observer = new MutationObserver(function (mutations) {  // 创建观察者对象
        mutations.forEach(function (mutation) {
            // console.log(mutation.type);
            if (!$local_search_result.text() && $local_search_result.html() != '') {    // 无搜索结果
                $no_result.show(200);
            } else {
                $no_result.hide();
            }
        });
    });
    

    // 激活搜索框时才搜索
    let inputArea = document.querySelector("#local-search--input");
    let getSearchFile = function () {
        // 调用搜索函数
        let search_path = "search.xml";
        if (search_path.length == 0) {
            search_path = "search.xml";
        }
        let path = "/" + search_path;
        searchFunc(path, 'local-search--input', 'local-search--result');
        observer.observe(target, config);   // 传入目标节点和观察选项
    }
    inputArea.onfocus = function () { getSearchFile() }

    // 搜索重置
    let $resetButton = $("#search-form .fa-times");
    let $resultArea = $("#local-search--result");
    inputArea.oninput = function () { $resetButton.show(); }
    let resetSearch = function () {
        $resultArea.html("");
        document.querySelector("#search-form").reset();
        $resetButton.hide();
        $no_result.hide();
        observer.disconnect();  // 停止观察
    }

    // 屏蔽回车
    inputArea.onkeydown = function (event) { if (event.keyCode == 13) return false }

    // 搜索函数
    let searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                let datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                let $input = document.getElementById(search_id);
                let $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    let str = '<ul class=\"search-result--list\">';
                    let keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        let isMatch = true;
                        let content_index = [];
                        let data_title = data.title.trim().toLowerCase();
                        let data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        let data_url = data.url;
                        let index_title = -1;
                        let index_content = -1;
                        let first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title != '' && data_content != '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i == 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='/" + data_url + "' class='search-result--title' target='_blank'>" + "> " + data_title + "</a>";
                            let content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out characters
                                let start = first_occur - 6;
                                let end = first_occur + 6;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start == 0) {
                                    end = 10;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                let match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    let regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                })
                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                        }
                    })
                    $resultContent.innerHTML = str;
                })
            }
        })
    }</script><script type="module" src="/js/main.js"></script><script>$(document).ready(function() {
            $("del").attr("title","你知道的太多了ヾ(▼ﾍ▼；) (#｀皿´メ)");
            $('.toc-card').width($('#right-col').width());  // 使目录栏与右侧栏宽度一致            
            
            // 添加脚注提示
            $('a.footnote-ref').each(function (index, elem) {
                let post_id = $(this).parents('article').attr('id');
                let fn_href = $(this).attr('href');
                elem.setAttribute('data-toggle', 'tooltip');
                elem.setAttribute('data-html', 'true');
                elem.setAttribute('title', $("#" + post_id + " " + fn_href).html());
            });
        });
        $(window).on('load', function () {
            $('#sidebar-sticky--bottom').height($('#right-col').height() - $('#sidebar').height() - $('#footer').height());  // 完全填充#right-col高度
        });
        $(function () { $("[data-toggle='tooltip']").tooltip(); });</script></body></html>