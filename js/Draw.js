function createScene(){width=$("#scene").width(),height=$("#scene").height(),ratio=width/height,w2=width/2,h2=height/2,fov=60,near=1,far=2e4,scene=new THREE.Scene,camera=new THREE.PerspectiveCamera(fov,ratio,near,far),camera.position.z=Math.max($("#scene").height()+60,$("#scene").width()+60),camera.lookAt(new THREE.Vector3(0,0,0)),renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0}),renderer.setSize(width,height),renderer.shadowMap.enabled=!0,container=document.getElementById("scene"),container.appendChild(renderer.domElement),addListeners(),controls=new THREE.OrbitControls(camera,renderer.domElement)}function addListeners(){window.addEventListener("resize",function(){width=$("#scene").width(),height=$("#scene").height(),w2=width/2,h2=height/2,renderer.setSize(width,height),camera.aspect=width/height,camera.updateProjectionMatrix()},!1),document.addEventListener("mousemove",function(e){mouse={x:e.clientX,y:e.clientY}},!1),document.addEventListener("mousedown",function(e){},!1),document.addEventListener("mouseup",function(e){},!1),document.addEventListener("touchstart",function(e){e.touches.length>1&&(e.preventDefault(),mousePos={x:e.touches[0].pageX,y:e.touches[0].pageY})},!1),document.addEventListener("touchend",function(e){mousePos={x:windowHalfX,y:windowHalfY}},!1),document.addEventListener("touchmove",function(e){1==e.touches.length&&(e.preventDefault(),mousePos={x:e.touches[0].pageX,y:e.touches[0].pageY})},!1)}function createObjects(){var e=new THREE.CanvasTexture(sprite()),t=new THREE.Geometry,r=new THREE.PointsMaterial({size:8,map:e,vertexColors:THREE.VertexColors,blending:THREE.AdditiveBlending,depthTest:!1,transparent:!0});particles=new THREE.Points(t,r),scene.add(particles)}function sprite(){var e=document.createElement("canvas");e.width=128,e.height=128;var t=e.getContext("2d"),r=t.createRadialGradient(e.width/2,e.height/2,0,e.width/2,e.height/2,e.width/2);return r.addColorStop(0,"rgba(255,255,255,1)"),r.addColorStop(.2,"rgba(240,255,240,1)"),r.addColorStop(.22,"rgba(0,150,255,.2)"),r.addColorStop(1,"rgba(0,50,255,0)"),t.fillStyle=r,t.fillRect(0,0,e.width,e.height),e}function loop(e){vortex(),particles.rotation.z-=.0025,render(),requestAnimationFrame(loop)}function vortex(){if(tick%2==0&&params&&0!==params.vortex){for(var e=0;e<particles.geometry.vertices.length;e++){var t=particles.geometry.vertices[e],r=-Math.PI/180;params.vortex>0?r*=(1-t.length()/params.radius)*params.vortex:r*=t.length()/params.radius*Math.abs(params.vortex),t.applyAxisAngle(axis,r)}particles.geometry.verticesNeedUpdate=!0}tick++}function onChange(e){for(var t=10-10*e.dispersion*(1-e.bulge),r=10-10*e.dispersion*(1-e.bulge),n=40-40*e.dispersion*(1-e.bulge),a=new THREE.Geometry,o=spiral(e).toArray(),i=0;i<o.length;i++){var s=o[i],h=Math.pow(Math.pow(s.x,2)+Math.pow(s.y,2),.5),d=Math.max(0,(.8*e.radius-h)/(.8*e.radius));d=(1-Math.cos(d*Math.PI))*e.bulge;var c=new THREE.Vector3;c.x=s.x,c.y=s.y,c.z=(-n+2*n*Math.random())*d,a.vertices.push(c),a.colors.push(new THREE.Color(d,d,1));for(var u=Math.round(5*d),l=0;l<u;){var p=new THREE.Vector3;p.x=s.x-t+Math.random()*(2*t),p.y=s.y-r+Math.random()*(2*r),p.z=(-n+2*n*Math.random())*d,a.vertices.push(p),a.colors.push(new THREE.Color(d,d,1)),l++}}a.mergeVertices(),a.verticesNeedUpdate=!0,particles.geometry=a}function spiral(e){function t(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Math.pow(2,31);return(e*(arguments.length>2&&void 0!==arguments[2]?arguments[2]:1103515245)+(arguments.length>3&&void 0!==arguments[3]?arguments[3]:12345))%t}return{toArray:function(){for(var r=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:0)/-6e4,n=e.modulus(),a=e.armTheta(),o=[],i=0,s=0;s<e.arms;s++)for(var h=0;h<e.stops;h++){i=t(i,n);var d=h/e.stops,c=1-d+1-e.dispersion,u=i/n,l=2*(u-.5),p=r+(d*Math.PI*2*e.revolutions+a*s)+Math.PI*c*l*e.sparse,m=Math.sqrt(d)*e.radius,v=Math.cos(p)*m,g=Math.sin(p)*m,w=2*(u-.5)+Math.pow(1.125,8*(1-d)),E=.5*(Math.sin((u+r+d)*Math.PI*2)+1);o.push({x:v,y:g,z:0,size:w,alpha:E})}return o}}}function render(){controls&&controls.update(),renderer.render(scene,camera)}createScene(),createObjects(),loop();var tick=0,axis=new THREE.Vector3(0,0,1),params=function(){function e(){this.arms=6,this.stops=5e3,this.revolutions=1.7,this.radius=Math.min($("#scene").height(),$("#scene").width()),this.sparse=.1,this.dispersion=1,this.bulge=.6,this.vortex=.8,this.armTheta=function(){return 2*Math.PI/this.arms},this.modulus=function(){return Math.pow(2,31)}}return new e}();onChange(params);